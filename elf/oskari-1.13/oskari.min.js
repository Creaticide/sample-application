Proj4js = {};

function phi4z(e,t,i,a,n,s,r,o,l){var u,c,h,d,p,f,m,g,y;for(l=s,y=1;15>=y;y++)if(u=Math.sin(l),tanphi=Math.tan(l),o=tanphi*Math.sqrt(1-e*u*u),c=Math.sin(2*l),h=t*l-i*c+a*Math.sin(4*l)-n*Math.sin(6*l),d=t-2*i*Math.cos(2*l)+4*a*Math.cos(4*l)-6*n*Math.cos(6*l),p=2*h+o*(h*h+r)-2*s*(o*h+1),f=e*c*(h*h+r-2*s*h)/(2*o),m=2*(s-h)*(o*d-2/c)-2*d,g=p/(f+m),l+=g,Math.abs(g)<=1e-10)return l;return Proj4js.reportError("phi4z: No convergence"),null}function e4fn(e){var t,i;return t=1+e,i=1-e,Math.sqrt(Math.pow(t,t)*Math.pow(i,i))}function min(e){var t=e[0];for(i=1;i<e.length;i++)e[i]<t&&(t=e[i]);return t}function mean(e){for(var t=0,i=0;i<e.length;i++)t+=e[i];return t/e.length}function array_search(e,t,i){var a=!!i,n="";for(n in t)if(a&&t[n]===e||!a&&t[n]==e)return n;return!1}function determineClass(e,t,a){var n,s=0,r=a[0]-1;for(i=0;t>i;i++)e>=s&&r>=e&&(n=i),s+=a[i],r=s+a[i+1]-1;return n}function extractBounds(e,t){var i=e.length,a=t.length;e.sort(function(e,t){return e-t});var n=[],s=0;for(indClass=0;a>indClass;indClass++)n[indClass]=e[s],s+=t[indClass];return n[a]=e[i-1],n}if(Oskari.clazz.define("Oskari.mapframework.openlayers.theme.default.Bundle",function(){},{create:function(){return this},update:function(){},start:function(){var e=this.mediator.manager.stateForBundleDefinitions["openlayers-default-theme"].bundlePath;OpenLayers.ImgPath=e+"/img/"},stop:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance"],source:{scripts:[{type:"text/css",src:"../../../../resources/openlayers/theme/default/style.css"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"openlayers-default-theme","Bundle-Name":"mapframework.openlayers-default-theme.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:[{Part:"OpenLayers","License-Name":"BSD","License-Online-Resource":"http://svn.openlayers.org/trunk/openlayers/license.txt"},{Part:"Proj4JS","License-Name":"LGPL/BSD","License-Online-Resource":""}]}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.core.Bundle",Title:" mapframework.core.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("openlayers-default-theme","Oskari.mapframework.openlayers.theme.default.Bundle"),function(){Oskari.clazz.define("Oskari.openlayers.bundle.openlayers-full-map.OpenLayersBundle",function(){},{create:function(){return this},update:function(){},start:function(){},stop:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance"],source:{scripts:[{type:"text/javascript",src:"../../../../libraries/proj4js-1.0.1/proj4js-compressed.js"},{type:"text/javascript",src:"../../../../libraries/OpenLayers/OpenLayers.full-map.js"}]},bundle:{manifest:{"Bundle-Identifier":"openlayers-map-full","Bundle-Name":"mapframework.openlayers.mapfull.Bundle","Bundle-Author":[{Name:"ah",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:[{Part:"OpenLayers","License-Name":"BSD","License-Online-Resource":"http://svn.openlayers.org/trunk/openlayers/license.txt"},{Part:"Proj4JS","License-Name":"LGPL/BSD","License-Online-Resource":""}]}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("openlayers-full-map","Oskari.openlayers.bundle.openlayers-full-map.OpenLayersBundle")}(),Proj4js={defaultDatum:"WGS84",transform:function(e,t,i){if(!e.readyToUse||!t.readyToUse)return this.reportError("Proj4js initialization for "+e.srsCode+" not yet complete"),i;if("900913"==e.srsProjNumber&&"WGS84"!=t.datumCode||"900913"==t.srsProjNumber&&"WGS84"!=e.datumCode){var a=Proj4js.WGS84;this.transform(e,a,i),e=a}return"longlat"==e.projName?(i.x*=Proj4js.common.D2R,i.y*=Proj4js.common.D2R):(e.to_meter&&(i.x*=e.to_meter,i.y*=e.to_meter),e.inverse(i)),e.from_greenwich&&(i.x+=e.from_greenwich),i=this.datum_transform(e.datum,t.datum,i),t.from_greenwich&&(i.x-=t.from_greenwich),"longlat"==t.projName?(i.x*=Proj4js.common.R2D,i.y*=Proj4js.common.R2D):(t.forward(i),t.to_meter&&(i.x/=t.to_meter,i.y/=t.to_meter)),i},datum_transform:function(e,t,i){return e.compare_datums(t)?i:e.datum_type==Proj4js.common.PJD_NODATUM||t.datum_type==Proj4js.common.PJD_NODATUM?i:(e.datum_type==Proj4js.common.PJD_GRIDSHIFT&&alert("ERROR: Grid shift transformations are not implemented yet."),t.datum_type==Proj4js.common.PJD_GRIDSHIFT&&alert("ERROR: Grid shift transformations are not implemented yet."),(e.es!=t.es||e.a!=t.a||e.datum_type==Proj4js.common.PJD_3PARAM||e.datum_type==Proj4js.common.PJD_7PARAM||t.datum_type==Proj4js.common.PJD_3PARAM||t.datum_type==Proj4js.common.PJD_7PARAM)&&(e.geodetic_to_geocentric(i),(e.datum_type==Proj4js.common.PJD_3PARAM||e.datum_type==Proj4js.common.PJD_7PARAM)&&e.geocentric_to_wgs84(i),(t.datum_type==Proj4js.common.PJD_3PARAM||t.datum_type==Proj4js.common.PJD_7PARAM)&&t.geocentric_from_wgs84(i),t.geocentric_to_geodetic(i)),t.datum_type==Proj4js.common.PJD_GRIDSHIFT&&alert("ERROR: Grid shift transformations are not implemented yet."),i)},reportError:function(){},extend:function(e,t){if(e=e||{},t)for(var i in t){var a=t[i];void 0!==a&&(e[i]=a)}return e},Class:function(){for(var e,t=function(){this.initialize.apply(this,arguments)},i={},a=0;a<arguments.length;++a)e="function"==typeof arguments[a]?arguments[a].prototype:arguments[a],Proj4js.extend(i,e);return t.prototype=i,t},bind:function(e,t){var i=Array.prototype.slice.apply(arguments,[2]);return function(){var a=i.concat(Array.prototype.slice.apply(arguments,[0]));return e.apply(t,a)}},scriptName:"proj4js-compressed.js",defsLookupService:"http://spatialreference.org/ref",libPath:null,getScriptLocation:function(){if(this.libPath)return this.libPath;for(var e=this.scriptName,t=e.length,i=document.getElementsByTagName("script"),a=0;a<i.length;a++){var n=i[a].getAttribute("src");if(n){var s=n.lastIndexOf(e);if(s>-1&&s+t==n.length){this.libPath=n.slice(0,-t);break}}}return this.libPath||""},loadScript:function(e,t,i,a){var n=document.createElement("script");n.defer=!1,n.type="text/javascript",n.id=e,n.src=e,n.onload=t,n.onerror=i,n.loadCheck=a,/MSIE/.test(navigator.userAgent)&&(n.onreadystatechange=this.checkReadyState),document.getElementsByTagName("head")[0].appendChild(n)},checkReadyState:function(){"loaded"==this.readyState&&(this.loadCheck()?this.onload():this.onerror())}},Proj4js.Proj=Proj4js.Class({readyToUse:!1,title:null,projName:null,units:null,datum:null,x0:0,y0:0,initialize:function(e){if(this.srsCodeInput=e,0==e.indexOf("urn:")){var t=e.split(":");"ogc"!=t[1]&&"x-ogc"!=t[1]||"def"!=t[2]||"crs"!=t[3]||(e=t[4]+":"+t[t.length-1])}else if(0==e.indexOf("http://")){var i=e.split("#");i[0].match(/epsg.org/)?e="EPSG:"+i[1]:i[0].match(/RIG.xml/)&&(e="IGNF:"+i[1])}this.srsCode=e.toUpperCase(),0==this.srsCode.indexOf("EPSG")?(this.srsCode=this.srsCode,this.srsAuth="epsg",this.srsProjNumber=this.srsCode.substring(5)):0==this.srsCode.indexOf("IGNF")?(this.srsCode=this.srsCode,this.srsAuth="IGNF",this.srsProjNumber=this.srsCode.substring(5)):0==this.srsCode.indexOf("CRS")?(this.srsCode=this.srsCode,this.srsAuth="CRS",this.srsProjNumber=this.srsCode.substring(4)):(this.srsAuth="",this.srsProjNumber=this.srsCode),this.loadProjDefinition()},loadProjDefinition:function(){if(Proj4js.defs[this.srsCode])return this.defsLoaded(),void 0;var e=Proj4js.getScriptLocation()+"defs/"+this.srsAuth.toUpperCase()+this.srsProjNumber+".js";Proj4js.loadScript(e,Proj4js.bind(this.defsLoaded,this),Proj4js.bind(this.loadFromService,this),Proj4js.bind(this.checkDefsLoaded,this))},loadFromService:function(){var e=Proj4js.defsLookupService+"/"+this.srsAuth+"/"+this.srsProjNumber+"/proj4js/";Proj4js.loadScript(e,Proj4js.bind(this.defsLoaded,this),Proj4js.bind(this.defsFailed,this),Proj4js.bind(this.checkDefsLoaded,this))},defsLoaded:function(){this.parseDefs(),this.loadProjCode(this.projName)},checkDefsLoaded:function(){return Proj4js.defs[this.srsCode]?!0:!1},defsFailed:function(){Proj4js.reportError("failed to load projection definition for: "+this.srsCode),Proj4js.defs[this.srsCode]=Proj4js.defs.WGS84,this.defsLoaded()},loadProjCode:function(e){if(Proj4js.Proj[e])return this.initTransforms(),void 0;var t=Proj4js.getScriptLocation()+"projCode/"+e+".js";Proj4js.loadScript(t,Proj4js.bind(this.loadProjCodeSuccess,this,e),Proj4js.bind(this.loadProjCodeFailure,this,e),Proj4js.bind(this.checkCodeLoaded,this,e))},loadProjCodeSuccess:function(e){Proj4js.Proj[e].dependsOn?this.loadProjCode(Proj4js.Proj[e].dependsOn):this.initTransforms()},loadProjCodeFailure:function(e){Proj4js.reportError("failed to find projection file for: "+e)},checkCodeLoaded:function(e){return Proj4js.Proj[e]?!0:!1},initTransforms:function(){Proj4js.extend(this,Proj4js.Proj[this.projName]),this.init(),this.readyToUse=!0},parseDefs:function(){this.defData=Proj4js.defs[this.srsCode];var e,t;if(this.defData){for(var i=this.defData.split("+"),a=0;a<i.length;a++){var n=i[a].split("=");switch(e=n[0].toLowerCase(),t=n[1],e.replace(/\s/gi,"")){case"":break;case"title":this.title=t;break;case"proj":this.projName=t.replace(/\s/gi,"");break;case"units":this.units=t.replace(/\s/gi,"");break;case"datum":this.datumCode=t.replace(/\s/gi,"");break;case"nadgrids":this.nagrids=t.replace(/\s/gi,"");break;case"ellps":this.ellps=t.replace(/\s/gi,"");break;case"a":this.a=parseFloat(t);break;case"b":this.b=parseFloat(t);break;case"rf":this.rf=parseFloat(t);break;case"lat_0":this.lat0=t*Proj4js.common.D2R;break;case"lat_1":this.lat1=t*Proj4js.common.D2R;break;case"lat_2":this.lat2=t*Proj4js.common.D2R;break;case"lat_ts":this.lat_ts=t*Proj4js.common.D2R;break;case"lon_0":this.long0=t*Proj4js.common.D2R;break;case"alpha":this.alpha=parseFloat(t)*Proj4js.common.D2R;break;case"lonc":this.longc=t*Proj4js.common.D2R;break;case"x_0":this.x0=parseFloat(t);break;case"y_0":this.y0=parseFloat(t);break;case"k_0":this.k0=parseFloat(t);break;case"k":this.k0=parseFloat(t);break;case"r_a":this.R_A=!0;break;case"zone":this.zone=parseInt(t);break;case"south":this.utmSouth=!0;break;case"towgs84":this.datum_params=t.split(",");break;case"to_meter":this.to_meter=parseFloat(t);break;case"from_greenwich":this.from_greenwich=t*Proj4js.common.D2R;break;case"pm":t=t.replace(/\s/gi,""),this.from_greenwich=Proj4js.PrimeMeridian[t]?Proj4js.PrimeMeridian[t]:parseFloat(t),this.from_greenwich*=Proj4js.common.D2R;break;case"no_defs":}}this.deriveConstants()}},deriveConstants:function(){if("@null"==this.nagrids&&(this.datumCode="none"),this.datumCode&&"none"!=this.datumCode){var e=Proj4js.Datum[this.datumCode];e&&(this.datum_params=e.towgs84?e.towgs84.split(","):null,this.ellps=e.ellipse,this.datumName=e.datumName?e.datumName:this.datumCode)}if(!this.a){var t=Proj4js.Ellipsoid[this.ellps]?Proj4js.Ellipsoid[this.ellps]:Proj4js.Ellipsoid.WGS84;Proj4js.extend(this,t)}this.rf&&!this.b&&(this.b=(1-1/this.rf)*this.a),Math.abs(this.a-this.b)<Proj4js.common.EPSLN&&(this.sphere=!0,this.b=this.a),this.a2=this.a*this.a,this.b2=this.b*this.b,this.es=(this.a2-this.b2)/this.a2,this.e=Math.sqrt(this.es),this.R_A&&(this.a*=1-this.es*(Proj4js.common.SIXTH+this.es*(Proj4js.common.RA4+this.es*Proj4js.common.RA6)),this.a2=this.a*this.a,this.b2=this.b*this.b,this.es=0),this.ep2=(this.a2-this.b2)/this.b2,this.k0||(this.k0=1),this.datum=new Proj4js.datum(this)}}),Proj4js.Proj.longlat={init:function(){},forward:function(e){return e},inverse:function(e){return e}},Proj4js.defs={WGS84:"+title=long/lat:WGS84 +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees","EPSG:4326":"+title=long/lat:WGS84 +proj=longlat +a=6378137.0 +b=6356752.31424518 +ellps=WGS84 +datum=WGS84 +units=degrees","EPSG:4269":"+title=long/lat:NAD83 +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees","EPSG:3785":"+title= Google Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"},Proj4js.defs.GOOGLE=Proj4js.defs["EPSG:3785"],Proj4js.defs["EPSG:900913"]=Proj4js.defs["EPSG:3785"],Proj4js.defs["EPSG:102113"]=Proj4js.defs["EPSG:3785"],Proj4js.common={PI:3.141592653589793,HALF_PI:1.5707963267948966,TWO_PI:6.283185307179586,FORTPI:.7853981633974483,R2D:57.29577951308232,D2R:.017453292519943295,SEC_TO_RAD:484813681109536e-20,EPSLN:1e-10,MAX_ITER:20,COS_67P5:.3826834323650898,AD_C:1.0026,PJD_UNKNOWN:0,PJD_3PARAM:1,PJD_7PARAM:2,PJD_GRIDSHIFT:3,PJD_WGS84:4,PJD_NODATUM:5,SRS_WGS84_SEMIMAJOR:6378137,SIXTH:.16666666666666666,RA4:.04722222222222222,RA6:.022156084656084655,RV4:.06944444444444445,RV6:.04243827160493827,msfnz:function(e,t,i){var a=e*t;return i/Math.sqrt(1-a*a)},tsfnz:function(e,t,i){var a=e*i,n=.5*e;return a=Math.pow((1-a)/(1+a),n),Math.tan(.5*(this.HALF_PI-t))/a},phi2z:function(e,t){var a,n,s=.5*e,r=this.HALF_PI-2*Math.atan(t);for(i=0;15>=i;i++)if(a=e*Math.sin(r),n=this.HALF_PI-2*Math.atan(t*Math.pow((1-a)/(1+a),s))-r,r+=n,Math.abs(n)<=1e-10)return r;return alert("phi2z has NoConvergence"),-9999},qsfnz:function(e,t){var i;return e>1e-7?(i=e*t,(1-e*e)*(t/(1-i*i)-.5/e*Math.log((1-i)/(1+i)))):2*t},asinz:function(e){return Math.abs(e)>1&&(e=e>1?1:-1),Math.asin(e)},e0fn:function(e){return 1-.25*e*(1+e/16*(3+1.25*e))},e1fn:function(e){return.375*e*(1+.25*e*(1+.46875*e))},e2fn:function(e){return.05859375*e*e*(1+.75*e)},e3fn:function(e){return e*e*e*(35/3072)},mlfn:function(e,t,i,a,n){return e*n-t*Math.sin(2*n)+i*Math.sin(4*n)-a*Math.sin(6*n)},srat:function(e,t){return Math.pow((1-e)/(1+e),t)},sign:function(e){return 0>e?-1:1},adjust_lon:function(e){return e=Math.abs(e)<this.PI?e:e-this.sign(e)*this.TWO_PI},adjust_lat:function(e){return e=Math.abs(e)<this.HALF_PI?e:e-this.sign(e)*this.PI},latiso:function(e,t,i){if(Math.abs(t)>this.HALF_PI)return+Number.NaN;if(t==this.HALF_PI)return Number.POSITIVE_INFINITY;if(t==-1*this.HALF_PI)return-1*Number.POSITIVE_INFINITY;var a=e*i;return Math.log(Math.tan((this.HALF_PI+t)/2))+e*Math.log((1-a)/(1+a))/2},fL:function(e,t){return 2*Math.atan(e*Math.exp(t))-this.HALF_PI},invlatiso:function(e,t){var i=this.fL(1,t),a=0,n=0;do a=i,n=e*Math.sin(a),i=this.fL(Math.exp(e*Math.log((1+n)/(1-n))/2),t);while(Math.abs(i-a)>1e-12);return i},sinh:function(e){var t=Math.exp(e);return t=(t-1/t)/2},cosh:function(e){var t=Math.exp(e);return t=(t+1/t)/2},tanh:function(e){var t=Math.exp(e);return t=(t-1/t)/(t+1/t)},asinh:function(e){var t=e>=0?1:-1;return t*Math.log(Math.abs(e)+Math.sqrt(e*e+1))},acosh:function(e){return 2*Math.log(Math.sqrt((e+1)/2)+Math.sqrt((e-1)/2))},atanh:function(e){return Math.log((e-1)/(e+1))/2},gN:function(e,t,i){var a=t*i;return e/Math.sqrt(1-a*a)}},Proj4js.datum=Proj4js.Class({initialize:function(e){if(this.datum_type=Proj4js.common.PJD_WGS84,e.datumCode&&"none"==e.datumCode&&(this.datum_type=Proj4js.common.PJD_NODATUM),e&&e.datum_params){for(var t=0;t<e.datum_params.length;t++)e.datum_params[t]=parseFloat(e.datum_params[t]);(0!=e.datum_params[0]||0!=e.datum_params[1]||0!=e.datum_params[2])&&(this.datum_type=Proj4js.common.PJD_3PARAM),e.datum_params.length>3&&(0!=e.datum_params[3]||0!=e.datum_params[4]||0!=e.datum_params[5]||0!=e.datum_params[6])&&(this.datum_type=Proj4js.common.PJD_7PARAM,e.datum_params[3]*=Proj4js.common.SEC_TO_RAD,e.datum_params[4]*=Proj4js.common.SEC_TO_RAD,e.datum_params[5]*=Proj4js.common.SEC_TO_RAD,e.datum_params[6]=e.datum_params[6]/1e6+1)}e&&(this.a=e.a,this.b=e.b,this.es=e.es,this.ep2=e.ep2,this.datum_params=e.datum_params)},compare_datums:function(e){return this.datum_type!=e.datum_type?!1:this.a!=e.a||Math.abs(this.es-e.es)>5e-11?!1:this.datum_type==Proj4js.common.PJD_3PARAM?this.datum_params[0]==e.datum_params[0]&&this.datum_params[1]==e.datum_params[1]&&this.datum_params[2]==e.datum_params[2]:this.datum_type==Proj4js.common.PJD_7PARAM?this.datum_params[0]==e.datum_params[0]&&this.datum_params[1]==e.datum_params[1]&&this.datum_params[2]==e.datum_params[2]&&this.datum_params[3]==e.datum_params[3]&&this.datum_params[4]==e.datum_params[4]&&this.datum_params[5]==e.datum_params[5]&&this.datum_params[6]==e.datum_params[6]:this.datum_type==Proj4js.common.PJD_GRIDSHIFT?0==strcmp(pj_param(this.params,"snadgrids").s,pj_param(e.params,"snadgrids").s):!0},geodetic_to_geocentric:function(e){var t,i,a,n,s,r,o,l=e.x,u=e.y,c=e.z?e.z:0,h=0;if(u<-Proj4js.common.HALF_PI&&u>-1.001*Proj4js.common.HALF_PI)u=-Proj4js.common.HALF_PI;else if(u>Proj4js.common.HALF_PI&&u<1.001*Proj4js.common.HALF_PI)u=Proj4js.common.HALF_PI;else if(u<-Proj4js.common.HALF_PI||u>Proj4js.common.HALF_PI)return Proj4js.reportError("geocent:lat out of range:"+u),null;return l>Proj4js.common.PI&&(l-=2*Proj4js.common.PI),s=Math.sin(u),o=Math.cos(u),r=s*s,n=this.a/Math.sqrt(1-this.es*r),t=(n+c)*o*Math.cos(l),i=(n+c)*o*Math.sin(l),a=(n*(1-this.es)+c)*s,e.x=t,e.y=i,e.z=a,h},geocentric_to_geodetic:function(e){var t,i,a,n,s,r,o,l,u,c,h,d,p,f,m,g,y,v=1e-12,b=v*v,_=30,k=e.x,L=e.y,w=e.z?e.z:0;if(p=!1,t=Math.sqrt(k*k+L*L),i=Math.sqrt(k*k+L*L+w*w),t/this.a<v){if(p=!0,m=0,i/this.a<v)return g=Proj4js.common.HALF_PI,y=-this.b,void 0}else m=Math.atan2(L,k);a=w/i,n=t/i,s=1/Math.sqrt(1-this.es*(2-this.es)*n*n),l=n*(1-this.es)*s,u=a*s,f=0;do f++,o=this.a/Math.sqrt(1-this.es*u*u),y=t*l+w*u-o*(1-this.es*u*u),r=this.es*o/(o+y),s=1/Math.sqrt(1-r*(2-r)*n*n),c=n*(1-r)*s,h=a*s,d=h*l-c*u,l=c,u=h;while(d*d>b&&_>f);return g=Math.atan(h/Math.abs(c)),e.x=m,e.y=g,e.z=y,e},geocentric_to_geodetic_noniter:function(e){var t,i,a,n,s,r,o,l,u,c,h,d,p,f,m,g,y,v=e.x,b=e.y,_=e.z?e.z:0;if(v=parseFloat(v),b=parseFloat(b),_=parseFloat(_),y=!1,0!=v)t=Math.atan2(b,v);else if(b>0)t=Proj4js.common.HALF_PI;else if(0>b)t=-Proj4js.common.HALF_PI;else if(y=!0,t=0,_>0)i=Proj4js.common.HALF_PI;else{if(!(0>_))return i=Proj4js.common.HALF_PI,a=-this.b,void 0;i=-Proj4js.common.HALF_PI}return s=v*v+b*b,n=Math.sqrt(s),r=_*Proj4js.common.AD_C,l=Math.sqrt(r*r+s),c=r/l,d=n/l,h=c*c*c,o=_+this.b*this.ep2*h,g=n-this.a*this.es*d*d*d,u=Math.sqrt(o*o+g*g),p=o/u,f=g/u,m=this.a/Math.sqrt(1-this.es*p*p),a=f>=Proj4js.common.COS_67P5?n/f-m:f<=-Proj4js.common.COS_67P5?n/-f-m:_/p+m*(this.es-1),0==y&&(i=Math.atan(p/f)),e.x=t,e.y=i,e.z=a,e},geocentric_to_wgs84:function(e){if(this.datum_type==Proj4js.common.PJD_3PARAM)e.x+=this.datum_params[0],e.y+=this.datum_params[1],e.z+=this.datum_params[2];else if(this.datum_type==Proj4js.common.PJD_7PARAM){var t=this.datum_params[0],i=this.datum_params[1],a=this.datum_params[2],n=this.datum_params[3],s=this.datum_params[4],r=this.datum_params[5],o=this.datum_params[6],l=o*(e.x-r*e.y+s*e.z)+t,u=o*(r*e.x+e.y-n*e.z)+i,c=o*(-s*e.x+n*e.y+e.z)+a;e.x=l,e.y=u,e.z=c}},geocentric_from_wgs84:function(e){if(this.datum_type==Proj4js.common.PJD_3PARAM)e.x-=this.datum_params[0],e.y-=this.datum_params[1],e.z-=this.datum_params[2];else if(this.datum_type==Proj4js.common.PJD_7PARAM){var t=this.datum_params[0],i=this.datum_params[1],a=this.datum_params[2],n=this.datum_params[3],s=this.datum_params[4],r=this.datum_params[5],o=this.datum_params[6],l=(e.x-t)/o,u=(e.y-i)/o,c=(e.z-a)/o;e.x=l+r*u-s*c,e.y=-r*l+u+n*c,e.z=s*l-n*u+c}}}),Proj4js.Point=Proj4js.Class({initialize:function(e,t,i){if("object"==typeof e)this.x=e[0],this.y=e[1],this.z=e[2]||0;else if("string"==typeof e){var a=e.split(",");this.x=parseFloat(a[0]),this.y=parseFloat(a[1]),this.z=parseFloat(a[2])||0}else this.x=e,this.y=t,this.z=i||0},clone:function(){return new Proj4js.Point(this.x,this.y,this.z)},toString:function(){return"x="+this.x+",y="+this.y},toShortString:function(){return this.x+", "+this.y}}),Proj4js.PrimeMeridian={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},Proj4js.Ellipsoid={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},"APL4.":{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS72:{a:6378135,rf:298.26,ellipseName:"WGS 72"},WGS84:{a:6378137,rf:298.257223563,ellipseName:"WGS 84"},sphere:{a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"}},Proj4js.Datum={WGS84:{towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},GGRS87:{towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},NAD83:{towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},NAD27:{nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},potsdam:{towgs84:"606.0,23.0,413.0",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},carthage:{towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},hermannskogel:{towgs84:"653.0,-212.0,449.0",ellipse:"bessel",datumName:"Hermannskogel"},ire65:{towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},nzgd49:{towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},OSGB36:{towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"}},Proj4js.WGS84=new Proj4js.Proj("WGS84"),Proj4js.Datum.OSB36=Proj4js.Datum.OSGB36,Proj4js.Proj.aea={init:function(){return Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN?(Proj4js.reportError("aeaInitEqualLatitudes"),void 0):(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=Proj4js.common.msfnz(this.e3,this.sin_po,this.cos_po),this.qs1=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=Proj4js.common.msfnz(this.e3,this.sin_po,this.cos_po),this.qs2=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.ns0=Math.abs(this.lat1-this.lat2)>Proj4js.common.EPSLN?(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0,void 0)},forward:function(e){var t=e.x,i=e.y;this.sin_phi=Math.sin(i),this.cos_phi=Math.cos(i);var a=Proj4js.common.qsfnz(this.e3,this.sin_phi,this.cos_phi),n=this.a*Math.sqrt(this.c-this.ns0*a)/this.ns0,s=this.ns0*Proj4js.common.adjust_lon(t-this.long0),r=n*Math.sin(s)+this.x0,o=this.rh-n*Math.cos(s)+this.y0;return e.x=r,e.y=o,e},inverse:function(e){var t,i,a,n,s,r;return e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns0>=0?(t=Math.sqrt(e.x*e.x+e.y*e.y),a=1):(t=-Math.sqrt(e.x*e.x+e.y*e.y),a=-1),n=0,0!=t&&(n=Math.atan2(a*e.x,a*e.y)),a=t*this.ns0/this.a,i=(this.c-a*a)/this.ns0,this.e3>=1e-10?(a=1-.5*(1-this.es)*Math.log((1-this.e3)/(1+this.e3))/this.e3,r=Math.abs(Math.abs(a)-Math.abs(i))>1e-10?this.phi1z(this.e3,i):i>=0?.5*PI:-.5*PI):r=this.phi1z(e3,i),s=Proj4js.common.adjust_lon(n/this.ns0+this.long0),e.x=s,e.y=r,e},phi1z:function(e,t){var i,a,n,s=Proj4js.common.asinz(.5*t);if(e<Proj4js.common.EPSLN)return s;for(var r=e*e,o=1;25>=o;o++)if(sinphi=Math.sin(s),cosphi=Math.cos(s),i=e*sinphi,a=1-i*i,n=.5*a*a/cosphi*(t/(1-r)-sinphi/a+.5/e*Math.log((1-i)/(1+i))),s+=n,Math.abs(n)<=1e-7)return s;return Proj4js.reportError("aea:phi1z:Convergence error"),null}},Proj4js.Proj.sterea={dependsOn:"gauss",init:function(){return Proj4js.Proj.gauss.init.apply(this),this.rc?(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"),void 0):(Proj4js.reportError("sterea:init:E_ERROR_0"),void 0)},forward:function(e){return e.x=Proj4js.common.adjust_lon(e.x-this.long0),Proj4js.Proj.gauss.forward.apply(this,[e]),sinc=Math.sin(e.y),cosc=Math.cos(e.y),cosl=Math.cos(e.x),k=this.k0*this.R2/(1+this.sinc0*sinc+this.cosc0*cosc*cosl),e.x=k*cosc*Math.sin(e.x),e.y=k*(this.cosc0*sinc-this.sinc0*cosc*cosl),e.x=this.a*e.x+this.x0,e.y=this.a*e.y+this.y0,e},inverse:function(e){var t,i;return e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,(rho=Math.sqrt(e.x*e.x+e.y*e.y))?(c=2*Math.atan2(rho,this.R2),sinc=Math.sin(c),cosc=Math.cos(c),i=Math.asin(cosc*this.sinc0+e.y*sinc*this.cosc0/rho),t=Math.atan2(e.x*sinc,rho*this.cosc0*cosc-e.y*this.sinc0*sinc)):(i=this.phic0,t=0),e.x=t,e.y=i,Proj4js.Proj.gauss.inverse.apply(this,[e]),e.x=Proj4js.common.adjust_lon(e.x+this.long0),e}},Proj4js.Proj.poly={init:function(){(this.lat0=0)&&(this.lat0=90),this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.ml0=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,i,a,n,s,r,o,l=e.x,u=e.y;return a=Proj4js.common.adjust_lon(l-this.long0),Math.abs(u)<=1e-7?(r=this.x0+this.a*a,o=this.y0-this.a*this.ml0):(t=Math.sin(u),i=Math.cos(u),n=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,u),s=Proj4js.common.msfnz(this.e,t,i),a=t,r=this.x0+this.a*s*Math.sin(a)/t,o=this.y0+this.a*(n-this.ml0+s*(1-Math.cos(a))/t)),e.x=r,e.y=o,e},inverse:function(e){var t,i,a,n,s,r;if(e.x-=this.x0,e.y-=this.y0,t=this.ml0+e.y/this.a,n=0,Math.abs(t)<=1e-7)s=e.x/this.a+this.long0,r=0;else{if(i=t*t+e.x/this.a*(e.x/this.a),n=phi4z(this.es,this.e0,this.e1,this.e2,this.e3,this.al,i,a,r),1!=n)return n;s=Proj4js.common.adjust_lon(Proj4js.common.asinz(e.x*a/this.a)/Math.sin(r)+this.long0)}return e.x=s,e.y=r,e}},Proj4js.Proj.equi={init:function(){this.x0||(this.x0=0),this.y0||(this.y0=0),this.lat0||(this.lat0=0),this.long0||(this.long0=0)},forward:function(e){var t=e.x,i=e.y,a=Proj4js.common.adjust_lon(t-this.long0),n=this.x0+this.a*a*Math.cos(this.lat0),s=this.y0+this.a*i;return this.t1=n,this.t2=Math.cos(this.lat0),e.x=n,e.y=s,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=e.y/this.a;Math.abs(t)>Proj4js.common.HALF_PI&&Proj4js.reportError("equi:Inv:DataError");var i=Proj4js.common.adjust_lon(this.long0+e.x/(this.a*Math.cos(this.lat0)));e.x=i,e.y=t}},Proj4js.Proj.merc={init:function(){this.lat_ts&&(this.k0=this.sphere?Math.cos(this.lat_ts):Proj4js.common.msfnz(this.es,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(e){var t=e.x,i=e.y;if(i*Proj4js.common.R2D>90&&i*Proj4js.common.R2D<-90&&t*Proj4js.common.R2D>180&&t*Proj4js.common.R2D<-180)return Proj4js.reportError("merc:forward: llInputOutOfRange: "+t+" : "+i),null;var a,n;if(Math.abs(Math.abs(i)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN)return Proj4js.reportError("merc:forward: ll2mAtPoles"),null;if(this.sphere)a=this.x0+this.a*this.k0*Proj4js.common.adjust_lon(t-this.long0),n=this.y0+this.a*this.k0*Math.log(Math.tan(Proj4js.common.FORTPI+.5*i));else{var s=Math.sin(i),r=Proj4js.common.tsfnz(this.e,i,s);a=this.x0+this.a*this.k0*Proj4js.common.adjust_lon(t-this.long0),n=this.y0-this.a*this.k0*Math.log(r)}return e.x=a,e.y=n,e},inverse:function(e){var t,i,a=e.x-this.x0,n=e.y-this.y0;if(this.sphere)i=Proj4js.common.HALF_PI-2*Math.atan(Math.exp(-n/this.a*this.k0));else{var s=Math.exp(-n/(this.a*this.k0));if(i=Proj4js.common.phi2z(this.e,s),-9999==i)return Proj4js.reportError("merc:inverse: lat = -9999"),null}return t=Proj4js.common.adjust_lon(this.long0+a/(this.a*this.k0)),e.x=t,e.y=i,e}},Proj4js.Proj.utm={dependsOn:"tmerc",init:function(){return this.zone?(this.lat0=0,this.long0=(6*Math.abs(this.zone)-183)*Proj4js.common.D2R,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,Proj4js.Proj.tmerc.init.apply(this),this.forward=Proj4js.Proj.tmerc.forward,this.inverse=Proj4js.Proj.tmerc.inverse,void 0):(Proj4js.reportError("utm:init: zone must be specified for UTM"),void 0)}},Proj4js.Proj.eqdc={init:function(){this.mode||(this.mode=0),this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=Proj4js.common.msfnz(this.e,this.sinphi,this.cosphi),this.ml1=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat1),0!=this.mode?(Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN&&Proj4js.reportError("eqdc:Init:EqualLatitudes"),this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=Proj4js.common.msfnz(this.e,this.sinphi,this.cosphi),this.ml2=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=Math.abs(this.lat1-this.lat2)>=Proj4js.common.EPSLN?(this.ms1-this.ms2)/(this.ml2-this.ml1):this.sinphi):this.ns=this.sinphi,this.g=this.ml1+this.ms1/this.ns,this.ml0=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0)},forward:function(e){var t=e.x,i=e.y,a=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,i),n=this.a*(this.g-a),s=this.ns*Proj4js.common.adjust_lon(t-this.long0),r=this.x0+n*Math.sin(s),o=this.y0+this.rh-n*Math.cos(s);return e.x=r,e.y=o,e},inverse:function(e){e.x-=this.x0,e.y=this.rh-e.y+this.y0;var t,i;if(this.ns>=0)var i=Math.sqrt(e.x*e.x+e.y*e.y),t=1;else i=-Math.sqrt(e.x*e.x+e.y*e.y),t=-1;var a=0;0!=i&&(a=Math.atan2(t*e.x,t*e.y)),this.g-i/this.a;var n=this.phi3z(this.ml,this.e0,this.e1,this.e2,this.e3),s=Proj4js.common.adjust_lon(this.long0+a/this.ns);return e.x=s,e.y=n,e},phi3z:function(e,t,i,a,n){var s,r;s=e;for(var o=0;15>o;o++)if(r=(e+i*Math.sin(2*s)-a*Math.sin(4*s)+n*Math.sin(6*s))/t-s,s+=r,Math.abs(r)<=1e-10)return s;return Proj4js.reportError("PHI3Z-CONV:Latitude failed to converge after 15 iterations"),null
}},Proj4js.Proj.tmerc={init:function(){this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.ml0=this.a*Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,i,a,n=e.x,s=e.y,r=Proj4js.common.adjust_lon(n-this.long0),o=Math.sin(s),l=Math.cos(s);if(this.sphere){var u=l*Math.sin(r);if(Math.abs(Math.abs(u)-1)<1e-10)return Proj4js.reportError("tmerc:forward: Point projects into infinity"),93;i=.5*this.a*this.k0*Math.log((1+u)/(1-u)),t=Math.acos(l*Math.cos(r)/Math.sqrt(1-u*u)),0>s&&(t=-t),a=this.a*this.k0*(t-this.lat0)}else{var c=l*r,h=Math.pow(c,2),d=this.ep2*Math.pow(l,2),p=Math.tan(s),f=Math.pow(p,2);t=1-this.es*Math.pow(o,2);var m=this.a/Math.sqrt(t),g=this.a*Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,s);i=this.k0*m*c*(1+h/6*(1-f+d+h/20*(5-18*f+Math.pow(f,2)+72*d-58*this.ep2)))+this.x0,a=this.k0*(g-this.ml0+m*p*h*(.5+h/24*(5-f+9*d+4*Math.pow(d,2)+h/30*(61-58*f+Math.pow(f,2)+600*d-330*this.ep2))))+this.y0}return e.x=i,e.y=a,e},inverse:function(e){var t,i,a,n,s,r,o=6;if(this.sphere){var l=Math.exp(e.x/(this.a*this.k0)),u=.5*(l-1/l),c=this.lat0+e.y/(this.a*this.k0),h=Math.cos(c);t=Math.sqrt((1-h*h)/(1+u*u)),s=Proj4js.common.asinz(t),0>c&&(s=-s),r=0==u&&0==h?this.long0:Proj4js.common.adjust_lon(Math.atan2(u,h)+this.long0)}else{var d=e.x-this.x0,p=e.y-this.y0;for(t=(this.ml0+p/this.k0)/this.a,i=t,n=0;!0&&(a=(t+this.e1*Math.sin(2*i)-this.e2*Math.sin(4*i)+this.e3*Math.sin(6*i))/this.e0-i,i+=a,!(Math.abs(a)<=Proj4js.common.EPSLN));n++)if(n>=o)return Proj4js.reportError("tmerc:inverse: Latitude failed to converge"),95;if(Math.abs(i)<Proj4js.common.HALF_PI){var f=Math.sin(i),m=Math.cos(i),g=Math.tan(i),y=this.ep2*Math.pow(m,2),v=Math.pow(y,2),b=Math.pow(g,2),_=Math.pow(b,2);t=1-this.es*Math.pow(f,2);var k=this.a/Math.sqrt(t),L=k*(1-this.es)/t,w=d/(k*this.k0),O=Math.pow(w,2);s=i-k*g*O/L*(.5-O/24*(5+3*b+10*y-4*v-9*this.ep2-O/30*(61+90*b+298*y+45*_-252*this.ep2-3*v))),r=Proj4js.common.adjust_lon(this.long0+w*(1-O/6*(1+2*b+y-O/20*(5-2*y+28*b-3*v+8*this.ep2+24*_)))/m)}else s=Proj4js.common.HALF_PI*Proj4js.common.sign(p),r=this.long0}return e.x=r,e.y=s,e}},Proj4js.defs.GOOGLE="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",Proj4js.defs["EPSG:900913"]=Proj4js.defs.GOOGLE,Proj4js.Proj.gstmerc={init:function(){var e=this.b/this.a;this.e=Math.sqrt(1-e*e),this.lc=this.long0,this.rs=Math.sqrt(1+this.e*this.e*Math.pow(Math.cos(this.lat0),4)/(1-this.e*this.e));var t=Math.sin(this.lat0),i=Math.asin(t/this.rs),a=Math.sin(i);this.cp=Proj4js.common.latiso(0,i,a)-this.rs*Proj4js.common.latiso(this.e,this.lat0,t),this.n2=this.k0*this.a*Math.sqrt(1-this.e*this.e)/(1-this.e*this.e*t*t),this.xs=this.x0,this.ys=this.y0-this.n2*i,this.title||(this.title="Gauss Schreiber transverse mercator")},forward:function(e){var t=e.x,i=e.y,a=this.rs*(t-this.lc),n=this.cp+this.rs*Proj4js.common.latiso(this.e,i,Math.sin(i)),s=Math.asin(Math.sin(a)/Proj4js.common.cosh(n)),r=Proj4js.common.latiso(0,s,Math.sin(s));return e.x=this.xs+this.n2*r,e.y=this.ys+this.n2*Math.atan(Proj4js.common.sinh(n)/Math.cos(a)),e},inverse:function(e){var t=e.x,i=e.y,a=Math.atan(Proj4js.common.sinh((t-this.xs)/this.n2)/Math.cos((i-this.ys)/this.n2)),n=Math.asin(Math.sin((i-this.ys)/this.n2)/Proj4js.common.cosh((t-this.xs)/this.n2)),s=Proj4js.common.latiso(0,n,Math.sin(n));return e.x=this.lc+a/this.rs,e.y=Proj4js.common.invlatiso(this.e,(s-this.cp)/this.rs),e}},Proj4js.Proj.ortho={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(e){var t,i,a,n,s,r,o=e.x,l=e.y;if(a=Proj4js.common.adjust_lon(o-this.long0),t=Math.sin(l),i=Math.cos(l),n=Math.cos(a),r=this.sin_p14*t+this.cos_p14*i*n,s=1,r>0||Math.abs(r)<=Proj4js.common.EPSLN)var u=this.a*s*i*Math.sin(a),c=this.y0+this.a*s*(this.cos_p14*t-this.sin_p14*i*n);else Proj4js.reportError("orthoFwdPointError");return e.x=u,e.y=c,e},inverse:function(e){var t,i,a,n,s,r,o;return e.x-=this.x0,e.y-=this.y0,t=Math.sqrt(e.x*e.x+e.y*e.y),t>this.a+1e-7&&Proj4js.reportError("orthoInvDataError"),i=Proj4js.common.asinz(t/this.a),a=Math.sin(i),n=Math.cos(i),r=this.long0,Math.abs(t)<=Proj4js.common.EPSLN&&(o=this.lat0),o=Proj4js.common.asinz(n*this.sin_p14+e.y*a*this.cos_p14/t),s=Math.abs(lat0)-Proj4js.common.HALF_PI,Math.abs(s)<=Proj4js.common.EPSLN&&(r=this.lat0>=0?Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x,-e.y)):Proj4js.common.adjust_lon(this.long0-Math.atan2(-e.x,e.y))),s=n-this.sin_p14*Math.sin(o),(Math.abs(s)>=Proj4js.common.EPSLN||Math.abs(x)>=Proj4js.common.EPSLN)&&(r=Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x*a*this.cos_p14,s*t))),e.x=r,e.y=o,e}},Proj4js.Proj.somerc={init:function(){var e=this.lat0;this.lambda0=this.long0;var t=Math.sin(e),i=this.a,a=this.rf,n=1/a,s=2*n-Math.pow(n,2),r=this.e=Math.sqrt(s);this.R=i*Math.sqrt(1-s)/(1-s*Math.pow(t,2)),this.alpha=Math.sqrt(1+s/(1-s)*Math.pow(Math.cos(e),4)),this.b0=Math.asin(t/this.alpha),this.K=Math.log(Math.tan(Math.PI/4+this.b0/2))-this.alpha*Math.log(Math.tan(Math.PI/4+e/2))+this.alpha*r/2*Math.log((1+r*t)/(1-r*t))},forward:function(e){var t=Math.log(Math.tan(Math.PI/4-e.y/2)),i=this.e/2*Math.log((1+this.e*Math.sin(e.y))/(1-this.e*Math.sin(e.y))),a=-this.alpha*(t+i)+this.K,n=2*(Math.atan(Math.exp(a))-Math.PI/4),s=this.alpha*(e.x-this.lambda0),r=Math.atan(Math.sin(s)/(Math.sin(this.b0)*Math.tan(n)+Math.cos(this.b0)*Math.cos(s))),o=Math.asin(Math.cos(this.b0)*Math.sin(n)-Math.sin(this.b0)*Math.cos(n)*Math.cos(s));return e.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0,e.x=this.R*r+this.x0,e},inverse:function(e){for(var t=e.x-this.x0,i=e.y-this.y0,a=t/this.R,n=2*(Math.atan(Math.exp(i/this.R))-Math.PI/4),s=Math.asin(Math.cos(this.b0)*Math.sin(n)+Math.sin(this.b0)*Math.cos(n)*Math.cos(a)),r=Math.atan(Math.sin(a)/(Math.cos(this.b0)*Math.cos(a)-Math.sin(this.b0)*Math.tan(n))),o=this.lambda0+r/this.alpha,l=0,u=s,c=-1e3,h=0;Math.abs(u-c)>1e-7;){if(++h>20)return Proj4js.reportError("omercFwdInfinity"),void 0;l=1/this.alpha*(Math.log(Math.tan(Math.PI/4+s/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(u))/2)),c=u,u=2*Math.atan(Math.exp(l))-Math.PI/2}return e.x=o,e.y=u,e}},Proj4js.Proj.stere={ssfn_:function(e,t,i){return t*=i,Math.tan(.5*(Proj4js.common.HALF_PI+e))*Math.pow((1-t)/(1+t),.5*i)},TOL:1e-8,NITER:8,CONV:1e-10,S_POLE:0,N_POLE:1,OBLIQ:2,EQUIT:3,init:function(){this.phits=this.lat_ts?this.lat_ts:Proj4js.common.HALF_PI;var e=Math.abs(this.lat0);if(this.mode=Math.abs(e)-Proj4js.common.HALF_PI<Proj4js.common.EPSLN?this.lat0<0?this.S_POLE:this.N_POLE:e>Proj4js.common.EPSLN?this.OBLIQ:this.EQUIT,this.phits=Math.abs(this.phits),this.es){var t;switch(this.mode){case this.N_POLE:case this.S_POLE:Math.abs(this.phits-Proj4js.common.HALF_PI)<Proj4js.common.EPSLN?this.akm1=2*this.k0/Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)):(e=Math.sin(this.phits),this.akm1=Math.cos(this.phits)/Proj4js.common.tsfnz(this.e,this.phits,e),e*=this.e,this.akm1/=Math.sqrt(1-e*e));break;case this.EQUIT:this.akm1=2*this.k0;break;case this.OBLIQ:e=Math.sin(this.lat0),t=2*Math.atan(this.ssfn_(this.lat0,e,this.e))-Proj4js.common.HALF_PI,e*=this.e,this.akm1=2*this.k0*Math.cos(this.lat0)/Math.sqrt(1-e*e),this.sinX1=Math.sin(t),this.cosX1=Math.cos(t)}}else switch(this.mode){case this.OBLIQ:this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0);case this.EQUIT:this.akm1=2*this.k0;break;case this.S_POLE:case this.N_POLE:this.akm1=Math.abs(this.phits-Proj4js.common.HALF_PI)>=Proj4js.common.EPSLN?Math.cos(this.phits)/Math.tan(Proj4js.common.FORTPI-.5*this.phits):2*this.k0}},forward:function(e){var t=e.x;t=Proj4js.common.adjust_lon(t-this.long0);var i,a,n=e.y;if(this.sphere){var s,r,o,l;switch(s=Math.sin(n),r=Math.cos(n),o=Math.cos(t),l=Math.sin(t),this.mode){case this.EQUIT:a=1+r*o,a<=Proj4js.common.EPSLN,a=this.akm1/a,i=a*r*l,a*=s;break;case this.OBLIQ:a=1+this.sinph0*s+this.cosph0*r*o,a<=Proj4js.common.EPSLN,a=this.akm1/a,i=a*r*l,a*=this.cosph0*s-this.sinph0*r*o;break;case this.N_POLE:o=-o,n=-n;case this.S_POLE:Math.abs(n-Proj4js.common.HALF_PI)<this.TOL,a=this.akm1*Math.tan(Proj4js.common.FORTPI+.5*n),i=l*a,a*=o}}else{switch(o=Math.cos(t),l=Math.sin(t),s=Math.sin(n),(this.mode==this.OBLIQ||this.mode==this.EQUIT)&&(X=2*Math.atan(this.ssfn_(n,s,this.e)),sinX=Math.sin(X-Proj4js.common.HALF_PI),cosX=Math.cos(X)),this.mode){case this.OBLIQ:A=this.akm1/(this.cosX1*(1+this.sinX1*sinX+this.cosX1*cosX*o)),a=A*(this.cosX1*sinX-this.sinX1*cosX*o),i=A*cosX;break;case this.EQUIT:A=2*this.akm1/(1+cosX*o),a=A*sinX,i=A*cosX;break;case this.S_POLE:n=-n,o=-o,s=-s;case this.N_POLE:i=this.akm1*Proj4js.common.tsfnz(this.e,n,s),a=-i*o}i*=l}return e.x=i*this.a+this.x0,e.y=a*this.a+this.y0,e},inverse:function(e){var t,i,a,n,s,r,o=(e.x-this.x0)/this.a,l=(e.y-this.y0)/this.a,u=0,c=0,h=0,d=0;if(this.sphere){var p,f,m,g;switch(f=Math.sqrt(o*o+l*l),p=2*Math.atan(f/this.akm1),m=Math.sin(p),g=Math.cos(p),t=0,this.mode){case this.EQUIT:i=Math.abs(f)<=Proj4js.common.EPSLN?0:Math.asin(l*m/f),(0!=g||0!=o)&&(t=Math.atan2(o*m,g*f));break;case this.OBLIQ:i=Math.abs(f)<=Proj4js.common.EPSLN?this.phi0:Math.asin(g*sinph0+l*m*cosph0/f),p=g-sinph0*Math.sin(i),(0!=p||0!=o)&&(t=Math.atan2(o*m*cosph0,p*f));break;case this.N_POLE:l=-l;case this.S_POLE:i=Math.abs(f)<=Proj4js.common.EPSLN?this.phi0:Math.asin(this.mode==this.S_POLE?-g:g),t=0==o&&0==l?0:Math.atan2(o,l)}}else{switch(s=Math.sqrt(o*o+l*l),this.mode){case this.OBLIQ:case this.EQUIT:u=2*Math.atan2(s*this.cosX1,this.akm1),a=Math.cos(u),n=Math.sin(u),c=0==s?Math.asin(a*this.sinX1):Math.asin(a*this.sinX1+l*n*this.cosX1/s),u=Math.tan(.5*(Proj4js.common.HALF_PI+c)),o*=n,l=s*this.cosX1*a-l*this.sinX1*n,d=Proj4js.common.HALF_PI,h=.5*this.e;break;case this.N_POLE:l=-l;case this.S_POLE:u=-s/this.akm1,c=Proj4js.common.HALF_PI-2*Math.atan(u),d=-Proj4js.common.HALF_PI,h=-.5*this.e}for(r=this.NITER;r--;c=i)if(n=this.e*Math.sin(c),i=2*Math.atan(u*Math.pow((1+n)/(1-n),h))-d,Math.abs(c-i)<this.CONV)return this.mode==this.S_POLE&&(i=-i),t=0==o&&0==l?0:Math.atan2(o,l),e.x=Proj4js.common.adjust_lon(t+this.long0),e.y=i,e}}},Proj4js.Proj.nzmg={iterations:1,init:function(){this.A=new Array,this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=new Array,this.B_im=new Array,this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=new Array,this.C_im=new Array,this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=new Array,this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(e){var t=e.x,i=e.y,a=i-this.lat0,s=t-this.long0,r=1e-5*(a/Proj4js.common.SEC_TO_RAD),o=s,l=1,u=0;for(n=1;10>=n;n++)l*=r,u+=this.A[n]*l;var c,h,d=u,p=o,f=1,m=0,g=0,v=0;for(n=1;6>=n;n++)c=f*d-m*p,h=m*d+f*p,f=c,m=h,g=g+this.B_re[n]*f-this.B_im[n]*m,v=v+this.B_im[n]*f+this.B_re[n]*m;return x=v*this.a+this.x0,y=g*this.a+this.y0,e.x=x,e.y=y,e},inverse:function(e){var t,a,s=e.x,r=e.y,o=s-this.x0,l=r-this.y0,u=l/this.a,c=o/this.a,h=1,d=0,p=0,f=0;for(n=1;6>=n;n++)t=h*u-d*c,a=d*u+h*c,h=t,d=a,p=p+this.C_re[n]*h-this.C_im[n]*d,f=f+this.C_im[n]*h+this.C_re[n]*d;for(i=0;i<this.iterations;i++){var m,g,y=p,v=f,b=u,_=c;for(n=2;6>=n;n++)m=y*p-v*f,g=v*p+y*f,y=m,v=g,b+=(n-1)*(this.B_re[n]*y-this.B_im[n]*v),_+=(n-1)*(this.B_im[n]*y+this.B_re[n]*v);y=1,v=0;var k=this.B_re[1],L=this.B_im[1];for(n=2;6>=n;n++)m=y*p-v*f,g=v*p+y*f,y=m,v=g,k+=n*(this.B_re[n]*y-this.B_im[n]*v),L+=n*(this.B_im[n]*y+this.B_re[n]*v);var w=k*k+L*L;p=(b*k+_*L)/w,f=(_*k-b*L)/w}var O=p,x=f,S=1,C=0;for(n=1;9>=n;n++)S*=O,C+=this.D[n]*S;var M=this.lat0+1e5*C*Proj4js.common.SEC_TO_RAD,P=this.long0+x;return e.x=P,e.y=M,e}},Proj4js.Proj.mill={init:function(){},forward:function(e){var t=e.x,i=e.y,a=Proj4js.common.adjust_lon(t-this.long0),n=this.x0+this.a*a,s=this.y0+1.25*this.a*Math.log(Math.tan(Proj4js.common.PI/4+i/2.5));return e.x=n,e.y=s,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=Proj4js.common.adjust_lon(this.long0+e.x/this.a),i=2.5*(Math.atan(Math.exp(.8*e.y/this.a))-Proj4js.common.PI/4);return e.x=t,e.y=i,e}},Proj4js.Proj.gnom={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a},forward:function(e){var t,i,a,n,s,r,o=e.x,l=e.y;return a=Proj4js.common.adjust_lon(o-this.long0),t=Math.sin(l),i=Math.cos(l),n=Math.cos(a),r=this.sin_p14*t+this.cos_p14*i*n,s=1,r>0||Math.abs(r)<=Proj4js.common.EPSLN?(x=this.x0+this.a*s*i*Math.sin(a)/r,y=this.y0+this.a*s*(this.cos_p14*t-this.sin_p14*i*n)/r):(Proj4js.reportError("orthoFwdPointError"),x=this.x0+this.infinity_dist*i*Math.sin(a),y=this.y0+this.infinity_dist*(this.cos_p14*t-this.sin_p14*i*n)),e.x=x,e.y=y,e},inverse:function(e){var t,i,a,n,s,r;return e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,(t=Math.sqrt(e.x*e.x+e.y*e.y))?(n=Math.atan2(t,this.rc),i=Math.sin(n),a=Math.cos(n),r=Proj4js.common.asinz(a*this.sin_p14+e.y*i*this.cos_p14/t),s=Math.atan2(e.x*i,t*this.cos_p14*a-e.y*this.sin_p14*i),s=Proj4js.common.adjust_lon(this.long0+s)):(r=this.phic0,s=0),e.x=s,e.y=r,e}},Proj4js.Proj.sinu={init:function(){this.R=6370997},forward:function(e){var t,i,a,n=e.x,s=e.y;return a=Proj4js.common.adjust_lon(n-this.long0),t=this.R*a*Math.cos(s)+this.x0,i=this.R*s+this.y0,e.x=t,e.y=i,e},inverse:function(e){var t,i,a;return e.x-=this.x0,e.y-=this.y0,t=e.y/this.R,Math.abs(t)>Proj4js.common.HALF_PI&&Proj4js.reportError("sinu:Inv:DataError"),i=Math.abs(t)-Proj4js.common.HALF_PI,Math.abs(i)>Proj4js.common.EPSLN?(i=this.long0+e.x/(this.R*Math.cos(t)),a=Proj4js.common.adjust_lon(i)):a=this.long0,e.x=a,e.y=t,e}},Proj4js.Proj.vandg={init:function(){this.R=6370997},forward:function(e){var t,i,a=e.x,n=e.y,s=Proj4js.common.adjust_lon(a-this.long0);Math.abs(n)<=Proj4js.common.EPSLN&&(t=this.x0+this.R*s,i=this.y0);var r=Proj4js.common.asinz(2*Math.abs(n/Proj4js.common.PI));(Math.abs(s)<=Proj4js.common.EPSLN||Math.abs(Math.abs(n)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN)&&(t=this.x0,i=n>=0?this.y0+Proj4js.common.PI*this.R*Math.tan(.5*r):this.y0+Proj4js.common.PI*this.R*-Math.tan(.5*r));var o=.5*Math.abs(Proj4js.common.PI/s-s/Proj4js.common.PI),l=o*o,u=Math.sin(r),c=Math.cos(r),h=c/(u+c-1),d=h*h,p=h*(2/u-1),f=p*p,m=Proj4js.common.PI*this.R*(o*(h-f)+Math.sqrt(l*(h-f)*(h-f)-(f+l)*(d-f)))/(f+l);return 0>s&&(m=-m),t=this.x0+m,m=Math.abs(m/(Proj4js.common.PI*this.R)),i=n>=0?this.y0+Proj4js.common.PI*this.R*Math.sqrt(1-m*m-2*o*m):this.y0-Proj4js.common.PI*this.R*Math.sqrt(1-m*m-2*o*m),e.x=t,e.y=i,e},inverse:function(e){var t,i,a,n,s,r,o,l,u,c,h;return e.x-=this.x0,e.y-=this.y0,u=Proj4js.common.PI*this.R,t=e.x/u,i=e.y/u,a=t*t+i*i,n=-Math.abs(i)*(1+a),s=n-2*i*i+t*t,r=-2*n+1+2*i*i+a*a,h=i*i/r+(2*s*s*s/r/r/r-9*n*s/r/r)/27,o=(n-s*s/3/r)/r,l=2*Math.sqrt(-o/3),u=3*h/o/l,Math.abs(u)>1&&(u=u>=0?1:-1),c=Math.acos(u)/3,lat=e.y>=0?(-l*Math.cos(c+Proj4js.common.PI/3)-s/3/r)*Proj4js.common.PI:-(-l*Math.cos(c+PI/3)-s/3/r)*Proj4js.common.PI,Math.abs(t)<Proj4js.common.EPSLN&&(lon=this.long0),lon=Proj4js.common.adjust_lon(this.long0+Proj4js.common.PI*(a-1+Math.sqrt(1+2*(t*t-i*i)+a*a))/2/t),e.x=lon,e.y=lat,e}},Proj4js.Proj.cea={init:function(){},forward:function(e){var t=e.x,i=e.y;dlon=Proj4js.common.adjust_lon(t-this.long0);var a=this.x0+this.a*dlon*Math.cos(this.lat_ts),n=this.y0+this.a*Math.sin(i)/Math.cos(this.lat_ts);return e.x=a,e.y=n,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=Proj4js.common.adjust_lon(this.long0+e.x/this.a/Math.cos(this.lat_ts)),i=Math.asin(e.y/this.a*Math.cos(this.lat_ts));return e.x=t,e.y=i,e}},Proj4js.Proj.eqc={init:function(){this.x0||(this.x0=0),this.y0||(this.y0=0),this.lat0||(this.lat0=0),this.long0||(this.long0=0),this.lat_ts||(this.lat_ts=0),this.title||(this.title="Equidistant Cylindrical (Plate Carre)"),this.rc=Math.cos(this.lat_ts)},forward:function(e){var t=e.x,i=e.y,a=Proj4js.common.adjust_lon(t-this.long0),n=Proj4js.common.adjust_lat(i-this.lat0);return e.x=this.x0+this.a*a*this.rc,e.y=this.y0+this.a*n,e},inverse:function(e){var t=e.x,i=e.y;return e.x=Proj4js.common.adjust_lon(this.long0+(t-this.x0)/(this.a*this.rc)),e.y=Proj4js.common.adjust_lat(this.lat0+(i-this.y0)/this.a),e}},Proj4js.Proj.cass={init:function(){this.sphere||(this.en=this.pj_enfn(this.es),this.m0=this.pj_mlfn(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},C1:.16666666666666666,C2:.008333333333333333,C3:.041666666666666664,C4:.3333333333333333,C5:.06666666666666667,forward:function(e){var t,i,a=e.x,n=e.y;return a=Proj4js.common.adjust_lon(a-this.long0),this.sphere?(t=Math.asin(Math.cos(n)*Math.sin(a)),i=Math.atan2(Math.tan(n),Math.cos(a))-this.phi0):(this.n=Math.sin(n),this.c=Math.cos(n),i=this.pj_mlfn(n,this.n,this.c,this.en),this.n=1/Math.sqrt(1-this.es*this.n*this.n),this.tn=Math.tan(n),this.t=this.tn*this.tn,this.a1=a*this.c,this.c*=this.es*this.c/(1-this.es),this.a2=this.a1*this.a1,t=this.n*this.a1*(1-this.a2*this.t*(this.C1-(8-this.t+8*this.c)*this.a2*this.C2)),i-=this.m0-this.n*this.tn*this.a2*(.5+(5-this.t+6*this.c)*this.a2*this.C3)),e.x=this.a*t+this.x0,e.y=this.a*i+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=e.x/this.a,i=e.y/this.a;return this.sphere?(this.dd=i+this.lat0,phi=Math.asin(Math.sin(this.dd)*Math.cos(t)),lam=Math.atan2(Math.tan(t),Math.cos(this.dd))):(ph1=this.pj_inv_mlfn(this.m0+i,this.es,this.en),this.tn=Math.tan(ph1),this.t=this.tn*this.tn,this.n=Math.sin(ph1),this.r=1/(1-this.es*this.n*this.n),this.n=Math.sqrt(this.r),this.r*=(1-this.es)*this.n,this.dd=t/this.n,this.d2=this.dd*this.dd,phi=ph1-this.n*this.tn/this.r*this.d2*(.5-(1+3*this.t)*this.d2*this.C3),lam=this.dd*(1+this.t*this.d2*(-this.C4+(1+3*this.t)*this.d2*this.C5))/Math.cos(ph1)),e.x=Proj4js.common.adjust_lon(this.long0+lam),e.y=phi,e},pj_enfn:function(e){en=new Array,en[0]=this.C00-e*(this.C02+e*(this.C04+e*(this.C06+e*this.C08))),en[1]=e*(this.C22-e*(this.C04+e*(this.C06+e*this.C08)));var t=e*e;return en[2]=t*(this.C44-e*(this.C46+e*this.C48)),t*=e,en[3]=t*(this.C66-e*this.C68),en[4]=t*e*this.C88,en},pj_mlfn:function(e,t,i,a){return i*=t,t*=t,a[0]*e-i*(a[1]+t*(a[2]+t*(a[3]+t*a[4])))},pj_inv_mlfn:function(e,a,n){for(k=1/(1-a),phi=e,i=Proj4js.common.MAX_ITER;i;--i)if(s=Math.sin(phi),t=1-a*s*s,t=(this.pj_mlfn(phi,s,Math.cos(phi),n)-e)*t*Math.sqrt(t)*k,phi-=t,Math.abs(t)<Proj4js.common.EPSLN)return phi;return Proj4js.reportError("cass:pj_inv_mlfn: Convergence error"),phi},C00:1,C02:.25,C04:.046875,C06:.01953125,C08:.01068115234375,C22:.75,C44:.46875,C46:.013020833333333334,C48:.007120768229166667,C66:.3645833333333333,C68:.005696614583333333,C88:.3076171875},Proj4js.Proj.gauss={init:function(){sphi=Math.sin(this.lat0),cphi=Math.cos(this.lat0),cphi*=cphi,this.rc=Math.sqrt(1-this.es)/(1-this.es*sphi*sphi),this.C=Math.sqrt(1+this.es*cphi*cphi/(1-this.es)),this.phic0=Math.asin(sphi/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+Proj4js.common.FORTPI)/(Math.pow(Math.tan(.5*this.lat0+Proj4js.common.FORTPI),this.C)*Proj4js.common.srat(this.e*sphi,this.ratexp))},forward:function(e){var t=e.x,i=e.y;return e.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*i+Proj4js.common.FORTPI),this.C)*Proj4js.common.srat(this.e*Math.sin(i),this.ratexp))-Proj4js.common.HALF_PI,e.x=this.C*t,e},inverse:function(e){var t=1e-14,i=e.x/this.C,a=e.y;num=Math.pow(Math.tan(.5*a+Proj4js.common.FORTPI)/this.K,1/this.C);for(var n=Proj4js.common.MAX_ITER;n>0&&(a=2*Math.atan(num*Proj4js.common.srat(this.e*Math.sin(e.y),-.5*this.e))-Proj4js.common.HALF_PI,!(Math.abs(a-e.y)<t));--n)e.y=a;return n?(e.x=i,e.y=a,e):(Proj4js.reportError("gauss:inverse:convergence failed"),null)}},Proj4js.Proj.omerc={init:function(){this.mode||(this.mode=0),this.lon1||(this.lon1=0,this.mode=1),this.lon2||(this.lon2=0),this.lat2||(this.lat2=0);var e=this.b/this.a,t=1-Math.pow(e,2);Math.sqrt(t),this.sin_p20=Math.sin(this.lat0),this.cos_p20=Math.cos(this.lat0),this.con=1-this.es*this.sin_p20*this.sin_p20,this.com=Math.sqrt(1-t),this.bl=Math.sqrt(1+this.es*Math.pow(this.cos_p20,4)/(1-t)),this.al=this.a*this.bl*this.k0*this.com/this.con,Math.abs(this.lat0)<Proj4js.common.EPSLN?(this.ts=1,this.d=1,this.el=1):(this.ts=Proj4js.common.tsfnz(this.e,this.lat0,this.sin_p20),this.con=Math.sqrt(this.con),this.d=this.bl*this.com/(this.cos_p20*this.con),this.f=this.d*this.d-1>0?this.lat0>=0?this.d+Math.sqrt(this.d*this.d-1):this.d-Math.sqrt(this.d*this.d-1):this.d,this.el=this.f*Math.pow(this.ts,this.bl)),0!=this.mode?(this.g=.5*(this.f-1/this.f),this.gama=Proj4js.common.asinz(Math.sin(this.alpha)/this.d),this.longc=this.longc-Proj4js.common.asinz(this.g*Math.tan(this.gama))/this.bl,this.con=Math.abs(this.lat0),this.con>Proj4js.common.EPSLN&&Math.abs(this.con-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN?(this.singam=Math.sin(this.gama),this.cosgam=Math.cos(this.gama),this.sinaz=Math.sin(this.alpha),this.cosaz=Math.cos(this.alpha),this.u=this.lat0>=0?this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz):-(this.al/this.bl)*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz)):Proj4js.reportError("omerc:Init:DataError")):(this.sinphi=Math.sin(this.at1),this.ts1=Proj4js.common.tsfnz(this.e,this.lat1,this.sinphi),this.sinphi=Math.sin(this.lat2),this.ts2=Proj4js.common.tsfnz(this.e,this.lat2,this.sinphi),this.h=Math.pow(this.ts1,this.bl),this.l=Math.pow(this.ts2,this.bl),this.f=this.el/this.h,this.g=.5*(this.f-1/this.f),this.j=(this.el*this.el-this.l*this.h)/(this.el*this.el+this.l*this.h),this.p=(this.l-this.h)/(this.l+this.h),this.dlon=this.lon1-this.lon2,this.dlon<-Proj4js.common.PI&&(this.lon2=this.lon2-2*Proj4js.common.PI),this.dlon>Proj4js.common.PI&&(this.lon2=this.lon2+2*Proj4js.common.PI),this.dlon=this.lon1-this.lon2,this.longc=.5*(this.lon1+this.lon2)-Math.atan(this.j*Math.tan(.5*this.bl*this.dlon)/this.p)/this.bl,this.dlon=Proj4js.common.adjust_lon(this.lon1-this.longc),this.gama=Math.atan(Math.sin(this.bl*this.dlon)/this.g),this.alpha=Proj4js.common.asinz(this.d*Math.sin(this.gama)),Math.abs(this.lat1-this.lat2)<=Proj4js.common.EPSLN?Proj4js.reportError("omercInitDataError"):this.con=Math.abs(this.lat1),this.con<=Proj4js.common.EPSLN||Math.abs(this.con-HALF_PI)<=Proj4js.common.EPSLN?Proj4js.reportError("omercInitDataError"):Math.abs(Math.abs(this.lat0)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN&&Proj4js.reportError("omercInitDataError"),this.singam=Math.sin(this.gam),this.cosgam=Math.cos(this.gam),this.sinaz=Math.sin(this.alpha),this.cosaz=Math.cos(this.alpha),this.u=this.lat0>=0?this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz):-(this.al/this.bl)*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz))},forward:function(e){var t,i,a,n,s,r,o,l,u,c,h,d=e.x,p=e.y;t=Math.sin(p),c=Proj4js.common.adjust_lon(d-this.longc),r=Math.sin(this.bl*c),Math.abs(Math.abs(p)-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN?(h=Proj4js.common.tsfnz(this.e,p,t),n=this.el/Math.pow(h,this.bl),u=.5*(n-1/n),i=.5*(n+1/n),o=(u*this.singam-r*this.cosgam)/i,a=Math.cos(this.bl*c),Math.abs(a)<1e-7?s=this.al*this.bl*c:(s=this.al*Math.atan((u*this.cosgam+r*this.singam)/a)/this.bl,0>a&&(s+=Proj4js.common.PI*this.al/this.bl))):(o=p>=0?this.singam:-this.singam,s=this.al*p/this.bl),Math.abs(Math.abs(o)-1)<=Proj4js.common.EPSLN&&Proj4js.reportError("omercFwdInfinity"),l=.5*this.al*Math.log((1-o)/(1+o))/this.bl,s-=this.u;var f=this.x0+l*this.cosaz+s*this.sinaz,m=this.y0+s*this.cosaz-l*this.sinaz;return e.x=f,e.y=m,e},inverse:function(e){var t,i,a,n,s,r,o,l,u,c,h;return e.x-=this.x0,e.y-=this.y0,h=0,n=e.x*this.cosaz-e.y*this.sinaz,s=e.y*this.cosaz+e.x*this.sinaz,s+=this.u,r=Math.exp(-this.bl*n/this.al),o=.5*(r-1/r),i=.5*(r+1/r),u=Math.sin(this.bl*s/this.al),c=(u*this.cosgam+o*this.singam)/i,Math.abs(Math.abs(c)-1)<=Proj4js.common.EPSLN?(lon=this.longc,lat=c>=0?Proj4js.common.HALF_PI:-Proj4js.common.HALF_PI):(a=1/this.bl,l=Math.pow(this.el/Math.sqrt((1+c)/(1-c)),a),lat=Proj4js.common.phi2z(this.e,l),t=this.longc-Math.atan2(o*this.cosgam-u*this.singam,a)/this.bl,lon=Proj4js.common.adjust_lon(t)),e.x=lon,e.y=lat,e}},Proj4js.Proj.lcc={init:function(){if(this.lat2||(this.lat2=this.lat0),this.k0||(this.k0=1),Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN)return Proj4js.reportError("lcc:init: Equal Latitudes"),void 0;var e=this.b/this.a;this.e=Math.sqrt(1-e*e);var t=Math.sin(this.lat1),i=Math.cos(this.lat1),a=Proj4js.common.msfnz(this.e,t,i),n=Proj4js.common.tsfnz(this.e,this.lat1,t),s=Math.sin(this.lat2),r=Math.cos(this.lat2),o=Proj4js.common.msfnz(this.e,s,r),l=Proj4js.common.tsfnz(this.e,this.lat2,s),u=Proj4js.common.tsfnz(this.e,this.lat0,Math.sin(this.lat0));this.ns=Math.abs(this.lat1-this.lat2)>Proj4js.common.EPSLN?Math.log(a/o)/Math.log(n/l):t,this.f0=a/(this.ns*Math.pow(n,this.ns)),this.rh=this.a*this.f0*Math.pow(u,this.ns),this.title||(this.title="Lambert Conformal Conic")},forward:function(e){var t=e.x,i=e.y;if(!(90>=i&&i>=-90&&180>=t&&t>=-180))return Proj4js.reportError("lcc:forward: llInputOutOfRange: "+t+" : "+i),null;var a,n,s=Math.abs(Math.abs(i)-Proj4js.common.HALF_PI);if(s>Proj4js.common.EPSLN)a=Proj4js.common.tsfnz(this.e,i,Math.sin(i)),n=this.a*this.f0*Math.pow(a,this.ns);else{if(s=i*this.ns,0>=s)return Proj4js.reportError("lcc:forward: No Projection"),null;n=0}var r=this.ns*Proj4js.common.adjust_lon(t-this.long0);return e.x=this.k0*n*Math.sin(r)+this.x0,e.y=this.k0*(this.rh-n*Math.cos(r))+this.y0,e},inverse:function(e){var t,i,a,n,s;x=(e.x-this.x0)/this.k0,y=this.rh-(e.y-this.y0)/this.k0,this.ns>0?(t=Math.sqrt(x*x+y*y),i=1):(t=-Math.sqrt(x*x+y*y),i=-1);var r=0;if(0!=t&&(r=Math.atan2(i*x,i*y)),0!=t||this.ns>0){if(i=1/this.ns,a=Math.pow(t/(this.a*this.f0),i),n=Proj4js.common.phi2z(this.e,a),-9999==n)return null}else n=-Proj4js.common.HALF_PI;return s=Proj4js.common.adjust_lon(r/this.ns+this.long0),e.x=s,e.y=n,e}},Proj4js.Proj.laea={S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4,init:function(){var e=Math.abs(this.lat0);if(this.mode=Math.abs(e-Proj4js.common.HALF_PI)<Proj4js.common.EPSLN?this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(e)<Proj4js.common.EPSLN?this.EQUIT:this.OBLIQ,this.es>0){var t;switch(this.qp=Proj4js.common.qsfnz(this.e,1),this.mmf=.5/(1-this.es),this.apa=this.authset(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),t=Math.sin(this.lat0),this.sinb1=Proj4js.common.qsfnz(this.e,t)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*t*t)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}}else this.mode==this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(e){var t,i,a=e.x,n=e.y;if(a=Proj4js.common.adjust_lon(a-this.long0),this.sphere){var s,r,o;switch(o=Math.sin(n),r=Math.cos(n),s=Math.cos(a),this.mode){case this.EQUIT:if(i=this.mode==this.EQUIT?1+r*s:1+this.sinph0*o+this.cosph0*r*s,i<=Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:y less than eps"),null;i=Math.sqrt(2/i),t=i*r*Math.sin(a),i*=this.mode==this.EQUIT?o:this.cosph0*o-this.sinph0*r*s;break;case this.N_POLE:s=-s;case this.S_POLE:if(Math.abs(n+this.phi0)<Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:phi < eps"),null;i=Proj4js.common.FORTPI-.5*n,i=2*(this.mode==this.S_POLE?Math.cos(i):Math.sin(i)),t=i*Math.sin(a),i*=s}}else{var s,l,o,u,c=0,h=0,d=0;switch(s=Math.cos(a),l=Math.sin(a),o=Math.sin(n),u=Proj4js.common.qsfnz(this.e,o),(this.mode==this.OBLIQ||this.mode==this.EQUIT)&&(c=u/this.qp,h=Math.sqrt(1-c*c)),this.mode){case this.OBLIQ:d=1+this.sinb1*c+this.cosb1*h*s;break;case this.EQUIT:d=1+h*s;break;case this.N_POLE:d=Proj4js.common.HALF_PI+n,u=this.qp-u;break;case this.S_POLE:d=n-Proj4js.common.HALF_PI,u=this.qp+u}if(Math.abs(d)<Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:b < eps"),null;switch(this.mode){case this.OBLIQ:case this.EQUIT:d=Math.sqrt(2/d),i=this.mode==this.OBLIQ?this.ymf*d*(this.cosb1*c-this.sinb1*h*s):(d=Math.sqrt(2/(1+h*s)))*c*this.ymf,t=this.xmf*d*h*l;break;case this.N_POLE:case this.S_POLE:u>=0?(t=(d=Math.sqrt(u))*l,i=s*(this.mode==this.S_POLE?d:-d)):t=i=0}}return e.x=this.a*t+this.x0,e.y=this.a*i+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=e.x/this.a,i=e.y/this.a;if(this.sphere){var a,n=0,s=0;a=Math.sqrt(t*t+i*i);var r=.5*a;if(r>1)return Proj4js.reportError("laea:Inv:DataError"),null;switch(r=2*Math.asin(r),(this.mode==this.OBLIQ||this.mode==this.EQUIT)&&(s=Math.sin(r),n=Math.cos(r)),this.mode){case this.EQUIT:r=Math.abs(a)<=Proj4js.common.EPSLN?0:Math.asin(i*s/a),t*=s,i=n*a;break;case this.OBLIQ:r=Math.abs(a)<=Proj4js.common.EPSLN?this.phi0:Math.asin(n*sinph0+i*s*cosph0/a),t*=s*cosph0,i=(n-Math.sin(r)*sinph0)*a;break;case this.N_POLE:i=-i,r=Proj4js.common.HALF_PI-r;break;case this.S_POLE:r-=Proj4js.common.HALF_PI}lam=0!=i||this.mode!=this.EQUIT&&this.mode!=this.OBLIQ?Math.atan2(t,i):0}else{var o,l,u,c,h=0;switch(this.mode){case this.EQUIT:case this.OBLIQ:if(t/=this.dd,i*=this.dd,c=Math.sqrt(t*t+i*i),c<Proj4js.common.EPSLN)return e.x=0,e.y=this.phi0,e;l=2*Math.asin(.5*c/this.rq),o=Math.cos(l),t*=l=Math.sin(l),this.mode==this.OBLIQ?(h=o*this.sinb1+i*l*this.cosb1/c,u=this.qp*h,i=c*this.cosb1*o-i*this.sinb1*l):(h=i*l/c,u=this.qp*h,i=c*o);break;case this.N_POLE:i=-i;case this.S_POLE:if(u=t*t+i*i,!u)return e.x=0,e.y=this.phi0,e;h=1-u/this.qp,this.mode==this.S_POLE&&(h=-h)}lam=Math.atan2(t,i),r=this.authlat(Math.asin(h),this.apa)}return e.x=Proj4js.common.adjust_lon(this.long0+lam),e.y=r,e},P00:.3333333333333333,P01:.17222222222222222,P02:.10257936507936508,P10:.06388888888888888,P11:.0664021164021164,P20:.016415012942191543,authset:function(e){var t,i=new Array;return i[0]=e*this.P00,t=e*e,i[0]+=t*this.P01,i[1]=t*this.P10,t*=e,i[0]+=t*this.P02,i[1]+=t*this.P11,i[2]=t*this.P20,i},authlat:function(e,t){var i=e+e;return e+t[0]*Math.sin(i)+t[1]*Math.sin(i+i)+t[2]*Math.sin(i+i+i)}},Proj4js.Proj.aeqd={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(e){var t=e.x;e.y;var i,a=Math.sin(e.y),n=Math.cos(e.y),s=Proj4js.common.adjust_lon(t-this.long0),r=Math.cos(s),o=this.sin_p12*a+this.cos_p12*n*r;if(Math.abs(Math.abs(o)-1)<Proj4js.common.EPSLN){if(i=1,0>o)return Proj4js.reportError("aeqd:Fwd:PointError"),void 0}else{var l=Math.acos(o);i=l/Math.sin(l)}return e.x=this.x0+this.a*i*n*Math.sin(s),e.y=this.y0+this.a*i*(this.cos_p12*a-this.sin_p12*n*r),e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=Math.sqrt(e.x*e.x+e.y*e.y);if(t>2*Proj4js.common.HALF_PI*this.a)return Proj4js.reportError("aeqdInvDataError"),void 0;var i,a=t/this.a,n=Math.sin(a),s=Math.cos(a),r=this.long0;if(Math.abs(t)<=Proj4js.common.EPSLN)i=this.lat0;else{i=Proj4js.common.asinz(s*this.sin_p12+e.y*n*this.cos_p12/t);var o=Math.abs(this.lat0)-Proj4js.common.HALF_PI;Math.abs(o)<=Proj4js.common.EPSLN?r=lat0>=0?Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x,-e.y)):Proj4js.common.adjust_lon(this.long0-Math.atan2(-e.x,e.y)):(o=s-this.sin_p12*Math.sin(i),Math.abs(o)<Proj4js.common.EPSLN&&Math.abs(e.x)<Proj4js.common.EPSLN||(Math.atan2(e.x*n*this.cos_p12,o*t),r=Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x*n*this.cos_p12,o*t))))}return e.x=r,e.y=i,e}},Proj4js.Proj.moll={init:function(){},forward:function(e){for(var t=e.x,i=e.y,a=Proj4js.common.adjust_lon(t-this.long0),n=i,s=Proj4js.common.PI*Math.sin(i),r=0;!0;r++){var o=-(n+Math.sin(n)-s)/(1+Math.cos(n));
if(n+=o,Math.abs(o)<Proj4js.common.EPSLN)break;r>=50&&Proj4js.reportError("moll:Fwd:IterationError")}n/=2,Proj4js.common.PI/2-Math.abs(i)<Proj4js.common.EPSLN&&(a=0);var l=.900316316158*this.a*a*Math.cos(n)+this.x0,u=1.4142135623731*this.a*Math.sin(n)+this.y0;return e.x=l,e.y=u,e},inverse:function(e){var t,i;e.x-=this.x0;var i=e.y/(1.4142135623731*this.a);Math.abs(i)>.999999999999&&(i=.999999999999);var t=Math.asin(i),a=Proj4js.common.adjust_lon(this.long0+e.x/(.900316316158*this.a*Math.cos(t)));a<-Proj4js.common.PI&&(a=-Proj4js.common.PI),a>Proj4js.common.PI&&(a=Proj4js.common.PI),i=(2*t+Math.sin(2*t))/Proj4js.common.PI,Math.abs(i)>1&&(i=1);var n=Math.asin(i);return e.x=a,e.y=n,e}},OpenLayers.Class=function(){var e=arguments.length,t=arguments[0],i=arguments[e-1],a="function"==typeof i.initialize?i.initialize:function(){t.prototype.initialize.apply(this,arguments)};if(e>1){var n=[a,t].concat(Array.prototype.slice.call(arguments).slice(1,e-1),i);OpenLayers.inherit.apply(null,n)}else a.prototype=i;return a},OpenLayers.inherit=function(e,t){var i=function(){};i.prototype=t.prototype,e.prototype=new i;var a,n,s;for(a=2,n=arguments.length;n>a;a++)s=arguments[a],"function"==typeof s&&(s=s.prototype),OpenLayers.Util.extend(e.prototype,s)},OpenLayers.Util=OpenLayers.Util||{},OpenLayers.Util.extend=function(e,t){if(e=e||{},t){for(var i in t){var a=t[i];void 0!==a&&(e[i]=a)}var n="function"==typeof window.Event&&t instanceof window.Event;!n&&t.hasOwnProperty&&t.hasOwnProperty("toString")&&(e.toString=t.toString)}return e},OpenLayers.Util=OpenLayers.Util||{},OpenLayers.Util.getElement=function(){for(var e=[],t=0,i=arguments.length;i>t;t++){var a=arguments[t];if("string"==typeof a&&(a=document.getElementById(a)),1==arguments.length)return a;e.push(a)}return e},OpenLayers.Util.isElement=function(e){return!(!e||1!==e.nodeType)},OpenLayers.Util.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},"undefined"==typeof window.$&&(window.$=OpenLayers.Util.getElement),OpenLayers.Util.removeItem=function(e,t){for(var i=e.length-1;i>=0;i--)e[i]==t&&e.splice(i,1);return e},OpenLayers.Util.indexOf=function(e,t){if("function"==typeof e.indexOf)return e.indexOf(t);for(var i=0,a=e.length;a>i;i++)if(e[i]==t)return i;return-1},OpenLayers.Util.modifyDOMElement=function(e,t,i,a,n,s,r,o){t&&(e.id=t),i&&(e.style.left=i.x+"px",e.style.top=i.y+"px"),a&&(e.style.width=a.w+"px",e.style.height=a.h+"px"),n&&(e.style.position=n),s&&(e.style.border=s),r&&(e.style.overflow=r),parseFloat(o)>=0&&parseFloat(o)<1?(e.style.filter="alpha(opacity="+100*o+")",e.style.opacity=o):1==parseFloat(o)&&(e.style.filter="",e.style.opacity="")},OpenLayers.Util.createDiv=function(e,t,i,a,n,s,r,o){var l=document.createElement("div");return a&&(l.style.backgroundImage="url("+a+")"),e||(e=OpenLayers.Util.createUniqueID("OpenLayersDiv")),n||(n="absolute"),OpenLayers.Util.modifyDOMElement(l,e,t,i,n,s,r,o),l},OpenLayers.Util.createImage=function(e,t,i,a,n,s,r,o){function l(){u.style.display="",OpenLayers.Event.stopObservingElement(u)}var u=document.createElement("img");return e||(e=OpenLayers.Util.createUniqueID("OpenLayersDiv")),n||(n="relative"),OpenLayers.Util.modifyDOMElement(u,e,t,i,n,s,null,r),o&&(u.style.display="none",OpenLayers.Event.observe(u,"load",l),OpenLayers.Event.observe(u,"error",l)),u.style.alt=e,u.galleryImg="no",a&&(u.src=a),u},OpenLayers.IMAGE_RELOAD_ATTEMPTS=0,OpenLayers.Util.alphaHackNeeded=null,OpenLayers.Util.alphaHack=function(){if(null==OpenLayers.Util.alphaHackNeeded){var e=navigator.appVersion.split("MSIE"),t=parseFloat(e[1]),i=!1;try{i=!!document.body.filters}catch(a){}OpenLayers.Util.alphaHackNeeded=i&&t>=5.5&&7>t}return OpenLayers.Util.alphaHackNeeded},OpenLayers.Util.modifyAlphaImageDiv=function(e,t,i,a,n,s,r,o,l){OpenLayers.Util.modifyDOMElement(e,t,i,a,s,null,null,l);var u=e.childNodes[0];n&&(u.src=n),OpenLayers.Util.modifyDOMElement(u,e.id+"_innerImage",null,a,"relative",r),OpenLayers.Util.alphaHack()&&("none"!=e.style.display&&(e.style.display="inline-block"),null==o&&(o="scale"),e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+u.src+"', "+"sizingMethod='"+o+"')",parseFloat(e.style.opacity)>=0&&parseFloat(e.style.opacity)<1&&(e.style.filter+=" alpha(opacity="+100*e.style.opacity+")"),u.style.filter="alpha(opacity=0)")},OpenLayers.Util.createAlphaImageDiv=function(e,t,i,a,n,s,r,o,l){var u=OpenLayers.Util.createDiv(),c=OpenLayers.Util.createImage(null,null,null,null,null,null,null,l);return c.className="olAlphaImg",u.appendChild(c),OpenLayers.Util.modifyAlphaImageDiv(u,e,t,i,a,n,s,r,o),u},OpenLayers.Util.upperCaseObject=function(e){var t={};for(var i in e)t[i.toUpperCase()]=e[i];return t},OpenLayers.Util.applyDefaults=function(e,t){e=e||{};var i="function"==typeof window.Event&&t instanceof window.Event;for(var a in t)(void 0===e[a]||!i&&t.hasOwnProperty&&t.hasOwnProperty(a)&&!e.hasOwnProperty(a))&&(e[a]=t[a]);return!i&&t&&t.hasOwnProperty&&t.hasOwnProperty("toString")&&!e.hasOwnProperty("toString")&&(e.toString=t.toString),e},OpenLayers.Util.getParameterString=function(e){var t=[];for(var i in e){var a=e[i];if(null!=a&&"function"!=typeof a){var n;if("object"==typeof a&&a.constructor==Array){for(var s,r=[],o=0,l=a.length;l>o;o++)s=a[o],r.push(encodeURIComponent(null===s||void 0===s?"":s));n=r.join(",")}else n=encodeURIComponent(a);t.push(encodeURIComponent(i)+"="+n)}}return t.join("&")},OpenLayers.Util.urlAppend=function(e,t){var i=e;if(t){var a=(e+" ").split(/[?&]/);i+=" "===a.pop()?t:a.length?"&"+t:"?"+t}return i},OpenLayers.Util.getImagesLocation=function(){return OpenLayers.ImgPath||OpenLayers._getScriptLocation()+"img/"},OpenLayers.Util.getImageLocation=function(e){return OpenLayers.Util.getImagesLocation()+e},OpenLayers.Util.Try=function(){for(var e=null,t=0,i=arguments.length;i>t;t++){var a=arguments[t];try{e=a();break}catch(n){}}return e},OpenLayers.Util.getXmlNodeValue=function(e){var t=null;return OpenLayers.Util.Try(function(){t=e.text,t||(t=e.textContent),t||(t=e.firstChild.nodeValue)},function(){t=e.textContent}),t},OpenLayers.Util.mouseLeft=function(e,t){for(var i=e.relatedTarget?e.relatedTarget:e.toElement;i!=t&&null!=i;)i=i.parentNode;return i!=t},OpenLayers.Util.DEFAULT_PRECISION=14,OpenLayers.Util.toFloat=function(e,t){return null==t&&(t=OpenLayers.Util.DEFAULT_PRECISION),"number"!=typeof e&&(e=parseFloat(e)),0===t?e:parseFloat(e.toPrecision(t))},OpenLayers.Util.rad=function(e){return e*Math.PI/180},OpenLayers.Util.deg=function(e){return 180*e/Math.PI},OpenLayers.Util.VincentyConstants={a:6378137,b:6356752.3142,f:1/298.257223563},OpenLayers.Util.distVincenty=function(e,t){for(var i=OpenLayers.Util.VincentyConstants,a=i.a,n=i.b,s=i.f,r=OpenLayers.Util.rad(t.lon-e.lon),o=Math.atan((1-s)*Math.tan(OpenLayers.Util.rad(e.lat))),l=Math.atan((1-s)*Math.tan(OpenLayers.Util.rad(t.lat))),u=Math.sin(o),c=Math.cos(o),h=Math.sin(l),d=Math.cos(l),p=r,f=2*Math.PI,m=20;Math.abs(p-f)>1e-12&&--m>0;){var g=Math.sin(p),y=Math.cos(p),v=Math.sqrt(d*g*d*g+(c*h-u*d*y)*(c*h-u*d*y));if(0==v)return 0;var b=u*h+c*d*y,_=Math.atan2(v,b),k=Math.asin(c*d*g/v),L=Math.cos(k)*Math.cos(k),w=b-2*u*h/L,O=s/16*L*(4+s*(4-3*L));f=p,p=r+(1-O)*s*Math.sin(k)*(_+O*v*(w+O*b*(-1+2*w*w)))}if(0==m)return 0/0;var x=L*(a*a-n*n)/(n*n),S=1+x/16384*(4096+x*(-768+x*(320-175*x))),C=x/1024*(256+x*(-128+x*(74-47*x))),M=C*v*(w+C/4*(b*(-1+2*w*w)-C/6*w*(-3+4*v*v)*(-3+4*w*w))),P=n*S*(_-M),E=P.toFixed(3)/1e3;return E},OpenLayers.Util.destinationVincenty=function(e,t,i){for(var a=OpenLayers.Util,n=a.VincentyConstants,s=n.a,r=n.b,o=n.f,l=e.lon,u=e.lat,c=i,h=a.rad(t),d=Math.sin(h),p=Math.cos(h),f=(1-o)*Math.tan(a.rad(u)),m=1/Math.sqrt(1+f*f),g=f*m,y=Math.atan2(f,p),v=m*d,b=1-v*v,_=b*(s*s-r*r)/(r*r),k=1+_/16384*(4096+_*(-768+_*(320-175*_))),L=_/1024*(256+_*(-128+_*(74-47*_))),w=c/(r*k),O=2*Math.PI;Math.abs(w-O)>1e-12;){var x=Math.cos(2*y+w),S=Math.sin(w),C=Math.cos(w),M=L*S*(x+L/4*(C*(-1+2*x*x)-L/6*x*(-3+4*S*S)*(-3+4*x*x)));O=w,w=c/(r*k)+M}var P=g*S-m*C*p,E=Math.atan2(g*C+m*S*p,(1-o)*Math.sqrt(v*v+P*P)),j=Math.atan2(S*d,m*C-g*S*p),N=o/16*b*(4+o*(4-3*b)),T=j-(1-N)*o*v*(w+N*S*(x+N*C*(-1+2*x*x)));return Math.atan2(v,-P),new OpenLayers.LonLat(l+a.deg(T),a.deg(E))},OpenLayers.Util.getParameters=function(e){e=null===e||void 0===e?window.location.href:e;var t="";if(OpenLayers.String.contains(e,"?")){var i=e.indexOf("?")+1,a=OpenLayers.String.contains(e,"#")?e.indexOf("#"):e.length;t=e.substring(i,a)}for(var n={},s=t.split(/[&;]/),r=0,o=s.length;o>r;++r){var l=s[r].split("=");if(l[0]){var u=l[0];try{u=decodeURIComponent(u)}catch(c){u=unescape(u)}var h=(l[1]||"").replace(/\+/g," ");try{h=decodeURIComponent(h)}catch(c){h=unescape(h)}h=h.split(","),1==h.length&&(h=h[0]),n[u]=h}}return n},OpenLayers.Util.lastSeqID=0,OpenLayers.Util.createUniqueID=function(e){return null==e&&(e="id_"),OpenLayers.Util.lastSeqID+=1,e+OpenLayers.Util.lastSeqID},OpenLayers.INCHES_PER_UNIT={inches:1,ft:12,mi:63360,m:39.3701,km:39370.1,dd:4374754,yd:36},OpenLayers.INCHES_PER_UNIT["in"]=OpenLayers.INCHES_PER_UNIT.inches,OpenLayers.INCHES_PER_UNIT.degrees=OpenLayers.INCHES_PER_UNIT.dd,OpenLayers.INCHES_PER_UNIT.nmi=1852*OpenLayers.INCHES_PER_UNIT.m,OpenLayers.METERS_PER_INCH=.0254000508001016,OpenLayers.Util.extend(OpenLayers.INCHES_PER_UNIT,{Inch:OpenLayers.INCHES_PER_UNIT.inches,Meter:1/OpenLayers.METERS_PER_INCH,Foot:.3048006096012192/OpenLayers.METERS_PER_INCH,IFoot:.3048/OpenLayers.METERS_PER_INCH,ClarkeFoot:.3047972651151/OpenLayers.METERS_PER_INCH,SearsFoot:.30479947153867626/OpenLayers.METERS_PER_INCH,GoldCoastFoot:.3047997101815088/OpenLayers.METERS_PER_INCH,IInch:.0254/OpenLayers.METERS_PER_INCH,MicroInch:254e-7/OpenLayers.METERS_PER_INCH,Mil:2.54e-8/OpenLayers.METERS_PER_INCH,Centimeter:.01/OpenLayers.METERS_PER_INCH,Kilometer:1e3/OpenLayers.METERS_PER_INCH,Yard:.9144018288036576/OpenLayers.METERS_PER_INCH,SearsYard:.914398414616029/OpenLayers.METERS_PER_INCH,IndianYard:.9143985307444408/OpenLayers.METERS_PER_INCH,IndianYd37:.91439523/OpenLayers.METERS_PER_INCH,IndianYd62:.9143988/OpenLayers.METERS_PER_INCH,IndianYd75:.9143985/OpenLayers.METERS_PER_INCH,IndianFoot:.30479951/OpenLayers.METERS_PER_INCH,IndianFt37:.30479841/OpenLayers.METERS_PER_INCH,IndianFt62:.3047996/OpenLayers.METERS_PER_INCH,IndianFt75:.3047995/OpenLayers.METERS_PER_INCH,Mile:1609.3472186944373/OpenLayers.METERS_PER_INCH,IYard:.9144/OpenLayers.METERS_PER_INCH,IMile:1609.344/OpenLayers.METERS_PER_INCH,NautM:1852/OpenLayers.METERS_PER_INCH,"Lat-66":110943.31648893273/OpenLayers.METERS_PER_INCH,"Lat-83":110946.25736872235/OpenLayers.METERS_PER_INCH,Decimeter:.1/OpenLayers.METERS_PER_INCH,Millimeter:.001/OpenLayers.METERS_PER_INCH,Dekameter:10/OpenLayers.METERS_PER_INCH,Decameter:10/OpenLayers.METERS_PER_INCH,Hectometer:100/OpenLayers.METERS_PER_INCH,GermanMeter:1.0000135965/OpenLayers.METERS_PER_INCH,CaGrid:.999738/OpenLayers.METERS_PER_INCH,ClarkeChain:20.1166194976/OpenLayers.METERS_PER_INCH,GunterChain:20.11684023368047/OpenLayers.METERS_PER_INCH,BenoitChain:20.116782494375872/OpenLayers.METERS_PER_INCH,SearsChain:20.11676512155/OpenLayers.METERS_PER_INCH,ClarkeLink:.201166194976/OpenLayers.METERS_PER_INCH,GunterLink:.2011684023368047/OpenLayers.METERS_PER_INCH,BenoitLink:.20116782494375873/OpenLayers.METERS_PER_INCH,SearsLink:.2011676512155/OpenLayers.METERS_PER_INCH,Rod:5.02921005842012/OpenLayers.METERS_PER_INCH,IntnlChain:20.1168/OpenLayers.METERS_PER_INCH,IntnlLink:.201168/OpenLayers.METERS_PER_INCH,Perch:5.02921005842012/OpenLayers.METERS_PER_INCH,Pole:5.02921005842012/OpenLayers.METERS_PER_INCH,Furlong:201.1684023368046/OpenLayers.METERS_PER_INCH,Rood:3.778266898/OpenLayers.METERS_PER_INCH,CapeFoot:.3047972615/OpenLayers.METERS_PER_INCH,Brealey:375/OpenLayers.METERS_PER_INCH,ModAmFt:.304812252984506/OpenLayers.METERS_PER_INCH,Fathom:1.8288/OpenLayers.METERS_PER_INCH,"NautM-UK":1853.184/OpenLayers.METERS_PER_INCH,"50kilometers":5e4/OpenLayers.METERS_PER_INCH,"150kilometers":15e4/OpenLayers.METERS_PER_INCH}),OpenLayers.Util.extend(OpenLayers.INCHES_PER_UNIT,{mm:OpenLayers.INCHES_PER_UNIT.Meter/1e3,cm:OpenLayers.INCHES_PER_UNIT.Meter/100,dm:100*OpenLayers.INCHES_PER_UNIT.Meter,km:1e3*OpenLayers.INCHES_PER_UNIT.Meter,kmi:OpenLayers.INCHES_PER_UNIT.nmi,fath:OpenLayers.INCHES_PER_UNIT.Fathom,ch:OpenLayers.INCHES_PER_UNIT.IntnlChain,link:OpenLayers.INCHES_PER_UNIT.IntnlLink,"us-in":OpenLayers.INCHES_PER_UNIT.inches,"us-ft":OpenLayers.INCHES_PER_UNIT.Foot,"us-yd":OpenLayers.INCHES_PER_UNIT.Yard,"us-ch":OpenLayers.INCHES_PER_UNIT.GunterChain,"us-mi":OpenLayers.INCHES_PER_UNIT.Mile,"ind-yd":OpenLayers.INCHES_PER_UNIT.IndianYd37,"ind-ft":OpenLayers.INCHES_PER_UNIT.IndianFt37,"ind-ch":20.11669506/OpenLayers.METERS_PER_INCH}),OpenLayers.DOTS_PER_INCH=72,OpenLayers.Util.normalizeScale=function(e){var t=e>1?1/e:e;return t},OpenLayers.Util.getResolutionFromScale=function(e,t){var i;if(e){null==t&&(t="degrees");var a=OpenLayers.Util.normalizeScale(e);i=1/(a*OpenLayers.INCHES_PER_UNIT[t]*OpenLayers.DOTS_PER_INCH)}return i},OpenLayers.Util.getScaleFromResolution=function(e,t){null==t&&(t="degrees");var i=e*OpenLayers.INCHES_PER_UNIT[t]*OpenLayers.DOTS_PER_INCH;return i},OpenLayers.Util.pagePosition=function(e){var t=[0,0],i=OpenLayers.Util.getViewportElement();if(!e||e==window||e==i)return t;var a,n=OpenLayers.IS_GECKO&&document.getBoxObjectFor&&"absolute"==OpenLayers.Element.getStyle(e,"position")&&(""==e.style.top||""==e.style.left),s=null;if(e.getBoundingClientRect){a=e.getBoundingClientRect();var r=i.scrollTop,o=i.scrollLeft;t[0]=a.left+o,t[1]=a.top+r}else if(document.getBoxObjectFor&&!n){a=document.getBoxObjectFor(e);var l=document.getBoxObjectFor(i);t[0]=a.screenX-l.screenX,t[1]=a.screenY-l.screenY}else{if(t[0]=e.offsetLeft,t[1]=e.offsetTop,s=e.offsetParent,s!=e)for(;s;)t[0]+=s.offsetLeft,t[1]+=s.offsetTop,s=s.offsetParent;var u=OpenLayers.BROWSER_NAME;for(("opera"==u||"safari"==u&&"absolute"==OpenLayers.Element.getStyle(e,"position"))&&(t[1]-=document.body.offsetTop),s=e.offsetParent;s&&s!=document.body;)t[0]-=s.scrollLeft,("opera"!=u||"TR"!=s.tagName)&&(t[1]-=s.scrollTop),s=s.offsetParent}return t},OpenLayers.Util.getViewportElement=function(){var e=arguments.callee.viewportElement;return void 0==e&&(e="msie"==OpenLayers.BROWSER_NAME&&"CSS1Compat"!=document.compatMode?document.body:document.documentElement,arguments.callee.viewportElement=e),e},OpenLayers.Util.isEquivalentUrl=function(e,t,i){i=i||{},OpenLayers.Util.applyDefaults(i,{ignoreCase:!0,ignorePort80:!0,ignoreHash:!0});var a=OpenLayers.Util.createUrlObject(e,i),n=OpenLayers.Util.createUrlObject(t,i);for(var s in a)if("args"!==s&&a[s]!=n[s])return!1;for(var s in a.args){if(a.args[s]!=n.args[s])return!1;delete n.args[s]}for(var s in n.args)return!1;return!0},OpenLayers.Util.createUrlObject=function(e,t){if(t=t||{},!/^\w+:\/\//.test(e)){var i=window.location,a=i.port?":"+i.port:"",n=i.protocol+"//"+i.host.split(":").shift()+a;if(0===e.indexOf("/"))e=n+e;else{var s=i.pathname.split("/");s.pop(),e=n+s.join("/")+"/"+e}}t.ignoreCase&&(e=e.toLowerCase());var r=document.createElement("a");r.href=e;var o={};o.host=r.host.split(":").shift(),o.protocol=r.protocol,o.port=t.ignorePort80?"80"==r.port||"0"==r.port?"":r.port:""==r.port||"0"==r.port?"80":r.port,o.hash=t.ignoreHash||"#"===r.hash?"":r.hash;var l=r.search;if(!l){var u=e.indexOf("?");l=-1!=u?e.substr(u):""}return o.args=OpenLayers.Util.getParameters(l),o.pathname="/"==r.pathname.charAt(0)?r.pathname:"/"+r.pathname,o},OpenLayers.Util.removeTail=function(e){var t=null,i=e.indexOf("?"),a=e.indexOf("#");return t=-1==i?-1!=a?e.substr(0,a):e:-1!=a?e.substr(0,Math.min(i,a)):e.substr(0,i)},OpenLayers.IS_GECKO=function(){var e=navigator.userAgent.toLowerCase();return-1==e.indexOf("webkit")&&-1!=e.indexOf("gecko")}(),OpenLayers.CANVAS_SUPPORTED=function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}(),OpenLayers.BROWSER_NAME=function(){var e="",t=navigator.userAgent.toLowerCase();return-1!=t.indexOf("opera")?e="opera":-1!=t.indexOf("msie")?e="msie":-1!=t.indexOf("safari")?e="safari":-1!=t.indexOf("mozilla")&&(e=-1!=t.indexOf("firefox")?"firefox":"mozilla"),e}(),OpenLayers.Util.getBrowserName=function(){return OpenLayers.BROWSER_NAME},OpenLayers.Util.getRenderedDimensions=function(e,t,i){var a,n,s=document.createElement("div");s.style.visibility="hidden";for(var r=i&&i.containerElement?i.containerElement:document.body,o=!1,l=null,u=r;u&&"body"!=u.tagName.toLowerCase();){var c=OpenLayers.Element.getStyle(u,"position");if("absolute"==c){o=!0;break}if(c&&"static"!=c)break;u=u.parentNode}!o||0!==r.clientHeight&&0!==r.clientWidth||(l=document.createElement("div"),l.style.visibility="hidden",l.style.position="absolute",l.style.overflow="visible",l.style.width=document.body.clientWidth+"px",l.style.height=document.body.clientHeight+"px",l.appendChild(s)),s.style.position="absolute",t&&(t.w?(a=t.w,s.style.width=a+"px"):t.h&&(n=t.h,s.style.height=n+"px")),i&&i.displayClass&&(s.className=i.displayClass);var h=document.createElement("div");if(h.innerHTML=e,h.style.overflow="visible",h.childNodes)for(var d=0,p=h.childNodes.length;p>d;d++)h.childNodes[d].style&&(h.childNodes[d].style.overflow="visible");return s.appendChild(h),l?r.appendChild(l):r.appendChild(s),a||(a=parseInt(h.scrollWidth),s.style.width=a+"px"),n||(n=parseInt(h.scrollHeight)),s.removeChild(h),l?(l.removeChild(s),r.removeChild(l)):r.removeChild(s),new OpenLayers.Size(a,n)},OpenLayers.Util.getScrollbarWidth=function(){var e=OpenLayers.Util._scrollbarWidth;if(null==e){var t=null,i=null,a=0,n=0;t=document.createElement("div"),t.style.position="absolute",t.style.top="-1000px",t.style.left="-1000px",t.style.width="100px",t.style.height="50px",t.style.overflow="hidden",i=document.createElement("div"),i.style.width="100%",i.style.height="200px",t.appendChild(i),document.body.appendChild(t),a=i.offsetWidth,t.style.overflow="scroll",n=i.offsetWidth,document.body.removeChild(document.body.lastChild),OpenLayers.Util._scrollbarWidth=a-n,e=OpenLayers.Util._scrollbarWidth}return e},OpenLayers.Util.getFormattedLonLat=function(e,t,i){i||(i="dms"),e=(e+540)%360-180;var a=Math.abs(e),n=Math.floor(a),s=(a-n)/(1/60),r=s;s=Math.floor(s);var o=(r-s)/(1/60);o=Math.round(10*o),o/=10,o>=60&&(o-=60,s+=1,s>=60&&(s-=60,n+=1)),10>n&&(n="0"+n);var l=n+"°";return i.indexOf("dm")>=0&&(10>s&&(s="0"+s),l+=s+"'",i.indexOf("dms")>=0&&(10>o&&(o="0"+o),l+=o+'"')),l+="lon"==t?0>e?OpenLayers.i18n("W"):OpenLayers.i18n("E"):0>e?OpenLayers.i18n("S"):OpenLayers.i18n("N")},OpenLayers.Animation=function(e){function t(e,t,i){t=t>0?t:Number.POSITIVE_INFINITY;var a=++s,o=+new Date;return r[a]=function(){r[a]&&+new Date-o<=t?(e(),r[a]&&n(r[a],i)):delete r[a]},n(r[a],i),a}function i(e){delete r[e]}var a=!!(e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame),n=function(){var t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(t){e.setTimeout(t,16)};return function(i,a){t.apply(e,[i,a])}}(),s=0,r={};return{isNative:a,requestFrame:n,start:t,stop:i}}(window),OpenLayers.String={startsWith:function(e,t){return 0==e.indexOf(t)},contains:function(e,t){return-1!=e.indexOf(t)},trim:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},camelize:function(e){for(var t=e.split("-"),i=t[0],a=1,n=t.length;n>a;a++){var s=t[a];i+=s.charAt(0).toUpperCase()+s.substring(1)}return i},format:function(e,t,i){t||(t=window);var a=function(e,a){for(var n,s=a.split(/\.+/),r=0;r<s.length;r++)0==r&&(n=t),n=n[s[r]];return"function"==typeof n&&(n=i?n.apply(null,i):n()),"undefined"==typeof n?"undefined":n};return e.replace(OpenLayers.String.tokenRegEx,a)},tokenRegEx:/\$\{([\w.]+?)\}/g,numberRegEx:/^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/,isNumeric:function(e){return OpenLayers.String.numberRegEx.test(e)},numericIf:function(e){return OpenLayers.String.isNumeric(e)?parseFloat(e):e}},OpenLayers.Number={decimalSeparator:".",thousandsSeparator:",",limitSigDigs:function(e,t){var i=0;return t>0&&(i=parseFloat(e.toPrecision(t))),i},format:function(e,t,i,a){t="undefined"!=typeof t?t:0,i="undefined"!=typeof i?i:OpenLayers.Number.thousandsSeparator,a="undefined"!=typeof a?a:OpenLayers.Number.decimalSeparator,null!=t&&(e=parseFloat(e.toFixed(t)));var n=e.toString().split(".");1==n.length&&null==t&&(t=0);var s=n[0];if(i)for(var r=/(-?[0-9]+)([0-9]{3})/;r.test(s);)s=s.replace(r,"$1"+i+"$2");var o;if(0==t)o=s;else{var l=n.length>1?n[1]:"0";null!=t&&(l+=new Array(t-l.length+1).join("0")),o=s+a+l}return o}},OpenLayers.Function={bind:function(e,t){var i=Array.prototype.slice.apply(arguments,[2]);return function(){var a=i.concat(Array.prototype.slice.apply(arguments,[0]));return e.apply(t,a)}},bindAsEventListener:function(e,t){return function(i){return e.call(t,i||window.event)}},False:function(){return!1},True:function(){return!0},Void:function(){}},OpenLayers.Array={filter:function(e,t,i){var a=[];if(Array.prototype.filter)a=e.filter(t,i);else{var n=e.length;if("function"!=typeof t)throw new TypeError;for(var s=0;n>s;s++)if(s in e){var r=e[s];t.call(i,r,s,e)&&a.push(r)}}return a}},OpenLayers.Bounds=OpenLayers.Class({left:null,bottom:null,right:null,top:null,centerLonLat:null,initialize:function(e,t,i,a){OpenLayers.Util.isArray(e)&&(a=e[3],i=e[2],t=e[1],e=e[0]),null!=e&&(this.left=OpenLayers.Util.toFloat(e)),null!=t&&(this.bottom=OpenLayers.Util.toFloat(t)),null!=i&&(this.right=OpenLayers.Util.toFloat(i)),null!=a&&(this.top=OpenLayers.Util.toFloat(a))},clone:function(){return new OpenLayers.Bounds(this.left,this.bottom,this.right,this.top)},equals:function(e){var t=!1;return null!=e&&(t=this.left==e.left&&this.right==e.right&&this.top==e.top&&this.bottom==e.bottom),t},toString:function(){return[this.left,this.bottom,this.right,this.top].join(",")},toArray:function(e){return e===!0?[this.bottom,this.left,this.top,this.right]:[this.left,this.bottom,this.right,this.top]},toBBOX:function(e,t){null==e&&(e=6);var i=Math.pow(10,e),a=Math.round(this.left*i)/i,n=Math.round(this.bottom*i)/i,s=Math.round(this.right*i)/i,r=Math.round(this.top*i)/i;return t===!0?n+","+a+","+r+","+s:a+","+n+","+s+","+r},toGeometry:function(){return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(this.left,this.bottom),new OpenLayers.Geometry.Point(this.right,this.bottom),new OpenLayers.Geometry.Point(this.right,this.top),new OpenLayers.Geometry.Point(this.left,this.top)])])},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},getSize:function(){return new OpenLayers.Size(this.getWidth(),this.getHeight())},getCenterPixel:function(){return new OpenLayers.Pixel((this.left+this.right)/2,(this.bottom+this.top)/2)},getCenterLonLat:function(){return this.centerLonLat||(this.centerLonLat=new OpenLayers.LonLat((this.left+this.right)/2,(this.bottom+this.top)/2)),this.centerLonLat},scale:function(e,t){null==t&&(t=this.getCenterLonLat());var i,a;"OpenLayers.LonLat"==t.CLASS_NAME?(i=t.lon,a=t.lat):(i=t.x,a=t.y);var n=(this.left-i)*e+i,s=(this.bottom-a)*e+a,r=(this.right-i)*e+i,o=(this.top-a)*e+a;return new OpenLayers.Bounds(n,s,r,o)},add:function(e,t){if(null==e||null==t)throw new TypeError("Bounds.add cannot receive null values");return new OpenLayers.Bounds(this.left+e,this.bottom+t,this.right+e,this.top+t)},extend:function(e){var t=null;if(e){switch(e.CLASS_NAME){case"OpenLayers.LonLat":t=new OpenLayers.Bounds(e.lon,e.lat,e.lon,e.lat);break;case"OpenLayers.Geometry.Point":t=new OpenLayers.Bounds(e.x,e.y,e.x,e.y);break;case"OpenLayers.Bounds":t=e}t&&(this.centerLonLat=null,(null==this.left||t.left<this.left)&&(this.left=t.left),(null==this.bottom||t.bottom<this.bottom)&&(this.bottom=t.bottom),(null==this.right||t.right>this.right)&&(this.right=t.right),(null==this.top||t.top>this.top)&&(this.top=t.top))}},containsLonLat:function(e,t){"boolean"==typeof t&&(t={inclusive:t}),t=t||{};var i=this.contains(e.lon,e.lat,t.inclusive),a=t.worldBounds;if(a&&!i){var n=a.getWidth(),s=(a.left+a.right)/2,r=Math.round((e.lon-s)/n);i=this.containsLonLat({lon:e.lon-r*n,lat:e.lat},{inclusive:t.inclusive})}return i},containsPixel:function(e,t){return this.contains(e.x,e.y,t)},contains:function(e,t,i){if(null==i&&(i=!0),null==e||null==t)return!1;e=OpenLayers.Util.toFloat(e),t=OpenLayers.Util.toFloat(t);var a=!1;return a=i?e>=this.left&&e<=this.right&&t>=this.bottom&&t<=this.top:e>this.left&&e<this.right&&t>this.bottom&&t<this.top},intersectsBounds:function(e,t){if("boolean"==typeof t&&(t={inclusive:t}),t=t||{},t.worldBounds){var i=this.wrapDateLine(t.worldBounds);e=e.wrapDateLine(t.worldBounds)}else i=this;null==t.inclusive&&(t.inclusive=!0);var a=!1,n=i.left==e.right||i.right==e.left||i.top==e.bottom||i.bottom==e.top;if(t.inclusive||!n){var s=e.bottom>=i.bottom&&e.bottom<=i.top||i.bottom>=e.bottom&&i.bottom<=e.top,r=e.top>=i.bottom&&e.top<=i.top||i.top>e.bottom&&i.top<e.top,o=e.left>=i.left&&e.left<=i.right||i.left>=e.left&&i.left<=e.right,l=e.right>=i.left&&e.right<=i.right||i.right>=e.left&&i.right<=e.right;a=(s||r)&&(o||l)}if(t.worldBounds&&!a){var u=t.worldBounds,c=u.getWidth(),h=!u.containsBounds(i),d=!u.containsBounds(e);h&&!d?(e=e.add(-c,0),a=i.intersectsBounds(e,{inclusive:t.inclusive})):d&&!h&&(i=i.add(-c,0),a=e.intersectsBounds(i,{inclusive:t.inclusive}))}return a},containsBounds:function(e,t,i){null==t&&(t=!1),null==i&&(i=!0);var a=this.contains(e.left,e.bottom,i),n=this.contains(e.right,e.bottom,i),s=this.contains(e.left,e.top,i),r=this.contains(e.right,e.top,i);return t?a||n||s||r:a&&n&&s&&r},determineQuadrant:function(e){var t="",i=this.getCenterLonLat();return t+=e.lat<i.lat?"b":"t",t+=e.lon<i.lon?"l":"r"},transform:function(e,t){this.centerLonLat=null;var i=OpenLayers.Projection.transform({x:this.left,y:this.bottom},e,t),a=OpenLayers.Projection.transform({x:this.right,y:this.bottom},e,t),n=OpenLayers.Projection.transform({x:this.left,y:this.top},e,t),s=OpenLayers.Projection.transform({x:this.right,y:this.top},e,t);return this.left=Math.min(i.x,n.x),this.bottom=Math.min(i.y,a.y),this.right=Math.max(a.x,s.x),this.top=Math.max(n.y,s.y),this},wrapDateLine:function(e,t){t=t||{};var i=t.leftTolerance||0,a=t.rightTolerance||0,n=this.clone();if(e){for(var s=e.getWidth();n.left<e.left&&n.right-a<=e.left;)n=n.add(s,0);for(;n.left+i>=e.right&&n.right>e.right;)n=n.add(-s,0);var r=n.left+i;r<e.right&&r>e.left&&n.right-a>e.right&&(n=n.add(-s,0))}return n},CLASS_NAME:"OpenLayers.Bounds"}),OpenLayers.Bounds.fromString=function(e,t){var i=e.split(",");return OpenLayers.Bounds.fromArray(i,t)},OpenLayers.Bounds.fromArray=function(e,t){return t===!0?new OpenLayers.Bounds(e[1],e[0],e[3],e[2]):new OpenLayers.Bounds(e[0],e[1],e[2],e[3])},OpenLayers.Bounds.fromSize=function(e){return new OpenLayers.Bounds(0,e.h,e.w,0)},OpenLayers.Bounds.oppositeQuadrant=function(e){var t="";return t+="t"==e.charAt(0)?"b":"t",t+="l"==e.charAt(1)?"r":"l"},OpenLayers.Element={visible:function(e){return"none"!=OpenLayers.Util.getElement(e).style.display},toggle:function(){for(var e=0,t=arguments.length;t>e;e++){var i=OpenLayers.Util.getElement(arguments[e]),a=OpenLayers.Element.visible(i)?"none":"";i.style.display=a}},remove:function(e){e=OpenLayers.Util.getElement(e),e.parentNode.removeChild(e)},getHeight:function(e){return e=OpenLayers.Util.getElement(e),e.offsetHeight},hasClass:function(e,t){var i=e.className;return!!i&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(i)},addClass:function(e,t){return OpenLayers.Element.hasClass(e,t)||(e.className+=(e.className?" ":"")+t),e},removeClass:function(e,t){var i=e.className;return i&&(e.className=OpenLayers.String.trim(i.replace(new RegExp("(^|\\s+)"+t+"(\\s+|$)")," "))),e},toggleClass:function(e,t){return OpenLayers.Element.hasClass(e,t)?OpenLayers.Element.removeClass(e,t):OpenLayers.Element.addClass(e,t),e},getStyle:function(e,t){e=OpenLayers.Util.getElement(e);var i=null;if(e&&e.style){if(i=e.style[OpenLayers.String.camelize(t)],!i)if(document.defaultView&&document.defaultView.getComputedStyle){var a=document.defaultView.getComputedStyle(e,null);i=a?a.getPropertyValue(t):null}else e.currentStyle&&(i=e.currentStyle[OpenLayers.String.camelize(t)]);var n=["left","top","right","bottom"];window.opera&&-1!=OpenLayers.Util.indexOf(n,t)&&"static"==OpenLayers.Element.getStyle(e,"position")&&(i="auto")}return"auto"==i?null:i}},OpenLayers.LonLat=OpenLayers.Class({lon:0,lat:0,initialize:function(e,t){OpenLayers.Util.isArray(e)&&(t=e[1],e=e[0]),this.lon=OpenLayers.Util.toFloat(e),this.lat=OpenLayers.Util.toFloat(t)},toString:function(){return"lon="+this.lon+",lat="+this.lat},toShortString:function(){return this.lon+", "+this.lat},clone:function(){return new OpenLayers.LonLat(this.lon,this.lat)},add:function(e,t){if(null==e||null==t)throw new TypeError("LonLat.add cannot receive null values");return new OpenLayers.LonLat(this.lon+OpenLayers.Util.toFloat(e),this.lat+OpenLayers.Util.toFloat(t))},equals:function(e){var t=!1;return null!=e&&(t=this.lon==e.lon&&this.lat==e.lat||isNaN(this.lon)&&isNaN(this.lat)&&isNaN(e.lon)&&isNaN(e.lat)),t},transform:function(e,t){var i=OpenLayers.Projection.transform({x:this.lon,y:this.lat},e,t);return this.lon=i.x,this.lat=i.y,this},wrapDateLine:function(e){var t=this.clone();if(e){for(;t.lon<e.left;)t.lon+=e.getWidth();for(;t.lon>e.right;)t.lon-=e.getWidth()}return t},CLASS_NAME:"OpenLayers.LonLat"}),OpenLayers.LonLat.fromString=function(e){var t=e.split(",");return new OpenLayers.LonLat(t[0],t[1])},OpenLayers.LonLat.fromArray=function(e){var t=OpenLayers.Util.isArray(e),i=t&&e[0],a=t&&e[1];return new OpenLayers.LonLat(i,a)},OpenLayers.Pixel=OpenLayers.Class({x:0,y:0,initialize:function(e,t){this.x=parseFloat(e),this.y=parseFloat(t)},toString:function(){return"x="+this.x+",y="+this.y},clone:function(){return new OpenLayers.Pixel(this.x,this.y)},equals:function(e){var t=!1;return null!=e&&(t=this.x==e.x&&this.y==e.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(e.x)&&isNaN(e.y)),t},distanceTo:function(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))},add:function(e,t){if(null==e||null==t)throw new TypeError("Pixel.add cannot receive null values");return new OpenLayers.Pixel(this.x+e,this.y+t)},offset:function(e){var t=this.clone();return e&&(t=this.add(e.x,e.y)),t},CLASS_NAME:"OpenLayers.Pixel"}),OpenLayers.Size=OpenLayers.Class({w:0,h:0,initialize:function(e,t){this.w=parseFloat(e),this.h=parseFloat(t)},toString:function(){return"w="+this.w+",h="+this.h},clone:function(){return new OpenLayers.Size(this.w,this.h)},equals:function(e){var t=!1;return null!=e&&(t=this.w==e.w&&this.h==e.h||isNaN(this.w)&&isNaN(this.h)&&isNaN(e.w)&&isNaN(e.h)),t},CLASS_NAME:"OpenLayers.Size"}),OpenLayers.Console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},userError:function(e){alert(e)},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){},CLASS_NAME:"OpenLayers.Console"},function(){for(var e=document.getElementsByTagName("script"),t=0,i=e.length;i>t;++t)if(-1!=e[t].src.indexOf("firebug.js")&&console){OpenLayers.Util.extend(OpenLayers.Console,console);break}}(),OpenLayers.Tween=OpenLayers.Class({easing:null,begin:null,finish:null,duration:null,callbacks:null,time:null,animationId:null,playing:!1,initialize:function(e){this.easing=e?e:OpenLayers.Easing.Expo.easeOut},start:function(e,t,i,a){this.playing=!0,this.begin=e,this.finish=t,this.duration=i,this.callbacks=a.callbacks,this.time=0,OpenLayers.Animation.stop(this.animationId),this.animationId=null,this.callbacks&&this.callbacks.start&&this.callbacks.start.call(this,this.begin),this.animationId=OpenLayers.Animation.start(OpenLayers.Function.bind(this.play,this))},stop:function(){this.playing&&(this.callbacks&&this.callbacks.done&&this.callbacks.done.call(this,this.finish),OpenLayers.Animation.stop(this.animationId),this.animationId=null,this.playing=!1)
},play:function(){var e={};for(var t in this.begin){var i=this.begin[t],a=this.finish[t];if(null==i||null==a||isNaN(i)||isNaN(a))throw new TypeError("invalid value for Tween");var n=a-i;e[t]=this.easing.apply(this,[this.time,i,n,this.duration])}this.time++,this.callbacks&&this.callbacks.eachStep&&this.callbacks.eachStep.call(this,e),this.time>this.duration&&this.stop()},CLASS_NAME:"OpenLayers.Tween"}),OpenLayers.Easing={CLASS_NAME:"OpenLayers.Easing"},OpenLayers.Easing.Linear={easeIn:function(e,t,i,a){return i*e/a+t},easeOut:function(e,t,i,a){return i*e/a+t},easeInOut:function(e,t,i,a){return i*e/a+t},CLASS_NAME:"OpenLayers.Easing.Linear"},OpenLayers.Easing.Expo={easeIn:function(e,t,i,a){return 0==e?t:i*Math.pow(2,10*(e/a-1))+t},easeOut:function(e,t,i,a){return e==a?t+i:i*(-Math.pow(2,-10*e/a)+1)+t},easeInOut:function(e,t,i,a){return 0==e?t:e==a?t+i:(e/=a/2)<1?i/2*Math.pow(2,10*(e-1))+t:i/2*(-Math.pow(2,-10*--e)+2)+t},CLASS_NAME:"OpenLayers.Easing.Expo"},OpenLayers.Easing.Quad={easeIn:function(e,t,i,a){return i*(e/=a)*e+t},easeOut:function(e,t,i,a){return-i*(e/=a)*(e-2)+t},easeInOut:function(e,t,i,a){return(e/=a/2)<1?i/2*e*e+t:-i/2*(--e*(e-2)-1)+t},CLASS_NAME:"OpenLayers.Easing.Quad"},OpenLayers.Kinetic=OpenLayers.Class({threshold:0,deceleration:.0035,nbPoints:100,delay:200,points:void 0,timerId:void 0,initialize:function(e){OpenLayers.Util.extend(this,e)},begin:function(){OpenLayers.Animation.stop(this.timerId),this.timerId=void 0,this.points=[]},update:function(e){this.points.unshift({xy:e,tick:(new Date).getTime()}),this.points.length>this.nbPoints&&this.points.pop()},end:function(e){for(var t,i,a=(new Date).getTime(),n=0,s=this.points.length;s>n&&(i=this.points[n],!(a-i.tick>this.delay));n++)t=i;if(t){var r=(new Date).getTime()-t.tick,o=Math.sqrt(Math.pow(e.x-t.xy.x,2)+Math.pow(e.y-t.xy.y,2)),l=o/r;if(!(0==l||l<this.threshold)){var u=Math.asin((e.y-t.xy.y)/o);return t.xy.x<=e.x&&(u=Math.PI-u),{speed:l,theta:u}}}},move:function(e,t){var i=e.speed,a=Math.cos(e.theta),n=-Math.sin(e.theta),s=(new Date).getTime(),r=0,o=0,l=function(){if(null!=this.timerId){var e=(new Date).getTime()-s,l=-this.deceleration*Math.pow(e,2)/2+i*e,u=l*a,c=l*n,h={};h.end=!1;var d=-this.deceleration*e+i;0>=d&&(OpenLayers.Animation.stop(this.timerId),this.timerId=null,h.end=!0),h.x=u-r,h.y=c-o,r=u,o=c,t(h.x,h.y,h.end)}};this.timerId=OpenLayers.Animation.start(OpenLayers.Function.bind(l,this))},CLASS_NAME:"OpenLayers.Kinetic"}),OpenLayers.Event={observers:!1,KEY_SPACE:32,KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,element:function(e){return e.target||e.srcElement},isSingleTouch:function(e){return e.touches&&1==e.touches.length},isMultiTouch:function(e){return e.touches&&e.touches.length>1},isLeftClick:function(e){return e.which&&1==e.which||e.button&&1==e.button},isRightClick:function(e){return e.which&&3==e.which||e.button&&2==e.button},stop:function(e,t){t||(e.preventDefault?e.preventDefault():e.returnValue=!1),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},findElement:function(e,t){for(var i=OpenLayers.Event.element(e);i.parentNode&&(!i.tagName||i.tagName.toUpperCase()!=t.toUpperCase());)i=i.parentNode;return i},observe:function(e,t,i,a){var n=OpenLayers.Util.getElement(e);if(a=a||!1,"keypress"==t&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||n.attachEvent)&&(t="keydown"),this.observers||(this.observers={}),!n._eventCacheID){var s="eventCacheID_";n.id&&(s=n.id+"_"+s),n._eventCacheID=OpenLayers.Util.createUniqueID(s)}var r=n._eventCacheID;this.observers[r]||(this.observers[r]=[]),this.observers[r].push({element:n,name:t,observer:i,useCapture:a}),n.addEventListener?n.addEventListener(t,i,a):n.attachEvent&&n.attachEvent("on"+t,i)},stopObservingElement:function(e){var t=OpenLayers.Util.getElement(e),i=t._eventCacheID;this._removeElementObservers(OpenLayers.Event.observers[i])},_removeElementObservers:function(e){if(e)for(var t=e.length-1;t>=0;t--){var i=e[t],a=new Array(i.element,i.name,i.observer,i.useCapture);OpenLayers.Event.stopObserving.apply(this,a)}},stopObserving:function(e,t,i,a){a=a||!1;var n=OpenLayers.Util.getElement(e),s=n._eventCacheID;"keypress"==t&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||n.detachEvent)&&(t="keydown");var r=!1,o=OpenLayers.Event.observers[s];if(o)for(var l=0;!r&&l<o.length;){var u=o[l];if(u.name==t&&u.observer==i&&u.useCapture==a){o.splice(l,1),0==o.length&&delete OpenLayers.Event.observers[s],r=!0;break}l++}return r&&(n.removeEventListener?n.removeEventListener(t,i,a):n&&n.detachEvent&&n.detachEvent("on"+t,i)),r},unloadCache:function(){if(OpenLayers.Event&&OpenLayers.Event.observers){for(var e in OpenLayers.Event.observers){var t=OpenLayers.Event.observers[e];OpenLayers.Event._removeElementObservers.apply(this,[t])}OpenLayers.Event.observers=!1}},CLASS_NAME:"OpenLayers.Event"},OpenLayers.Event.observe(window,"unload",OpenLayers.Event.unloadCache,!1),OpenLayers.Events=OpenLayers.Class({BROWSER_EVENTS:["mouseover","mouseout","mousedown","mouseup","mousemove","click","dblclick","rightclick","dblrightclick","resize","focus","blur","touchstart","touchmove","touchend","keydown"],listeners:null,object:null,element:null,eventHandler:null,fallThrough:null,includeXY:!1,extensions:null,extensionCount:null,clearMouseListener:null,initialize:function(e,t,i,a,n){OpenLayers.Util.extend(this,n),this.object=e,this.fallThrough=a,this.listeners={},this.extensions={},this.extensionCount={},null!=t&&this.attachToElement(t)},destroy:function(){for(var e in this.extensions)"boolean"!=typeof this.extensions[e]&&this.extensions[e].destroy();this.extensions=null,this.element&&(OpenLayers.Event.stopObservingElement(this.element),this.element.hasScrollEvent&&OpenLayers.Event.stopObserving(window,"scroll",this.clearMouseListener)),this.element=null,this.listeners=null,this.object=null,this.fallThrough=null,this.eventHandler=null},addEventType:function(){},attachToElement:function(e){this.element?OpenLayers.Event.stopObservingElement(this.element):(this.eventHandler=OpenLayers.Function.bindAsEventListener(this.handleBrowserEvent,this),this.clearMouseListener=OpenLayers.Function.bind(this.clearMouseCache,this)),this.element=e;for(var t=0,i=this.BROWSER_EVENTS.length;i>t;t++)OpenLayers.Event.observe(e,this.BROWSER_EVENTS[t],this.eventHandler);OpenLayers.Event.observe(e,"dragstart",OpenLayers.Event.stop)},on:function(e){for(var t in e)"scope"!=t&&e.hasOwnProperty(t)&&this.register(t,e.scope,e[t])},register:function(e,t,i,a){if(e in OpenLayers.Events&&!this.extensions[e]&&(this.extensions[e]=new OpenLayers.Events[e](this)),null!=i){null==t&&(t=this.object);var n=this.listeners[e];n||(n=[],this.listeners[e]=n,this.extensionCount[e]=0);var s={obj:t,func:i};a?(n.splice(this.extensionCount[e],0,s),"object"==typeof a&&a.extension&&this.extensionCount[e]++):n.push(s)}},registerPriority:function(e,t,i){this.register(e,t,i,!0)},un:function(e){for(var t in e)"scope"!=t&&e.hasOwnProperty(t)&&this.unregister(t,e.scope,e[t])},unregister:function(e,t,i){null==t&&(t=this.object);var a=this.listeners[e];if(null!=a)for(var n=0,s=a.length;s>n;n++)if(a[n].obj==t&&a[n].func==i){a.splice(n,1);break}},remove:function(e){null!=this.listeners[e]&&(this.listeners[e]=[])},triggerEvent:function(e,t){var i=this.listeners[e];if(!i||0==i.length)return void 0;null==t&&(t={}),t.object=this.object,t.element=this.element,t.type||(t.type=e),i=i.slice();for(var a,n=0,s=i.length;s>n;n++){var r=i[n];if(a=r.func.apply(r.obj,[t]),void 0!=a&&0==a)break}return this.fallThrough||OpenLayers.Event.stop(t,!0),a},handleBrowserEvent:function(e){var t=e.type,i=this.listeners[t];if(i&&0!=i.length){var a=e.touches;if(a&&a[0]){for(var n,s=0,r=0,o=a.length,l=0;o>l;++l)n=a[l],s+=n.clientX,r+=n.clientY;e.clientX=s/o,e.clientY=r/o}this.includeXY&&(e.xy=this.getMousePosition(e)),this.triggerEvent(t,e)}},clearMouseCache:function(){this.element.scrolls=null,this.element.lefttop=null;var e=document.body;e&&(0==e.scrollTop&&0==e.scrollLeft||!navigator.userAgent.match(/iPhone/i))&&(this.element.offsets=null)},getMousePosition:function(e){if(this.includeXY?this.element.hasScrollEvent||(OpenLayers.Event.observe(window,"scroll",this.clearMouseListener),this.element.hasScrollEvent=!0):this.clearMouseCache(),!this.element.scrolls){var t=OpenLayers.Util.getViewportElement();this.element.scrolls=[t.scrollLeft,t.scrollTop]}return this.element.lefttop||(this.element.lefttop=[document.documentElement.clientLeft||0,document.documentElement.clientTop||0]),this.element.offsets||(this.element.offsets=OpenLayers.Util.pagePosition(this.element)),new OpenLayers.Pixel(e.clientX+this.element.scrolls[0]-this.element.offsets[0]-this.element.lefttop[0],e.clientY+this.element.scrolls[1]-this.element.offsets[1]-this.element.lefttop[1])},CLASS_NAME:"OpenLayers.Events"}),OpenLayers.Events.buttonclick=OpenLayers.Class({target:null,events:["mousedown","mouseup","click","dblclick","touchstart","touchmove","touchend","keydown"],startRegEx:/^mousedown|touchstart$/,cancelRegEx:/^touchmove$/,completeRegEx:/^mouseup|touchend$/,initialize:function(e){this.target=e;for(var t=this.events.length-1;t>=0;--t)this.target.register(this.events[t],this,this.buttonClick,{extension:!0})},destroy:function(){for(var e=this.events.length-1;e>=0;--e)this.target.unregister(this.events[e],this,this.buttonClick);delete this.target},getPressedButton:function(e){var t,i=3;do{if(OpenLayers.Element.hasClass(e,"olButton")){t=e;break}e=e.parentNode}while(--i>0&&e);return t},buttonClick:function(e){var t=!0,i=OpenLayers.Event.element(e);if(i&&(OpenLayers.Event.isLeftClick(e)||!~e.type.indexOf("mouse"))){var a=this.getPressedButton(i);if(a){if("keydown"===e.type)switch(e.keyCode){case OpenLayers.Event.KEY_RETURN:case OpenLayers.Event.KEY_SPACE:this.target.triggerEvent("buttonclick",{buttonElement:a}),OpenLayers.Event.stop(e),t=!1}else if(this.startEvt){if(this.completeRegEx.test(e.type)){var n=OpenLayers.Util.pagePosition(a);this.target.triggerEvent("buttonclick",{buttonElement:a,buttonXY:{x:this.startEvt.clientX-n[0],y:this.startEvt.clientY-n[1]}})}this.cancelRegEx.test(e.type)&&delete this.startEvt,OpenLayers.Event.stop(e),t=!1}this.startRegEx.test(e.type)&&(this.startEvt=e,OpenLayers.Event.stop(e),t=!1)}else delete this.startEvt}return t}}),OpenLayers.ProxyHost="",OpenLayers.Request={DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:void 0,password:void 0,params:null,proxy:OpenLayers.ProxyHost,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},URL_SPLIT_REGEX:/([^:]*:)\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,events:new OpenLayers.Events(this),makeSameOrigin:function(e,t){var i=0!==e.indexOf("http"),a=!i&&e.match(this.URL_SPLIT_REGEX);if(a){var n=window.location;i=a[1]==n.protocol&&a[3]==n.hostname;var s=a[4],r=n.port;(80!=s&&""!=s||"80"!=r&&""!=r)&&(i=i&&s==r)}return i||(t?e="function"==typeof t?t(e):t+encodeURIComponent(e):OpenLayers.Console.warn(OpenLayers.i18n("proxyNeeded"),{url:e})),e},issue:function(e){var t=OpenLayers.Util.extend(this.DEFAULT_CONFIG,{proxy:OpenLayers.ProxyHost});e=OpenLayers.Util.applyDefaults(e,t);var i,a=!1;for(i in e.headers)e.headers.hasOwnProperty(i)&&"x-requested-with"===i.toLowerCase()&&(a=!0);a===!1&&(e.headers["X-Requested-With"]="XMLHttpRequest");var n=new OpenLayers.Request.XMLHttpRequest,s=OpenLayers.Util.urlAppend(e.url,OpenLayers.Util.getParameterString(e.params||{}));s=OpenLayers.Request.makeSameOrigin(s,e.proxy),n.open(e.method,s,e.async,e.user,e.password);for(var r in e.headers)n.setRequestHeader(r,e.headers[r]);var o=this.events,l=this;return n.onreadystatechange=function(){if(n.readyState==OpenLayers.Request.XMLHttpRequest.DONE){var t=o.triggerEvent("complete",{request:n,config:e,requestUrl:s});t!==!1&&l.runCallbacks({request:n,config:e,requestUrl:s})}},e.async===!1?n.send(e.data):window.setTimeout(function(){0!==n.readyState&&n.send(e.data)},0),n},runCallbacks:function(e){var t,i=e.request,a=e.config,n=a.scope?OpenLayers.Function.bind(a.callback,a.scope):a.callback;a.success&&(t=a.scope?OpenLayers.Function.bind(a.success,a.scope):a.success);var s;a.failure&&(s=a.scope?OpenLayers.Function.bind(a.failure,a.scope):a.failure),"file:"==OpenLayers.Util.createUrlObject(a.url).protocol&&i.responseText&&(i.status=200),n(i),(!i.status||i.status>=200&&i.status<300)&&(this.events.triggerEvent("success",e),t&&t(i)),i.status&&(i.status<200||i.status>=300)&&(this.events.triggerEvent("failure",e),s&&s(i))},GET:function(e){return e=OpenLayers.Util.extend(e,{method:"GET"}),OpenLayers.Request.issue(e)},POST:function(e){return e=OpenLayers.Util.extend(e,{method:"POST"}),e.headers=e.headers?e.headers:{},"CONTENT-TYPE"in OpenLayers.Util.upperCaseObject(e.headers)||(e.headers["Content-Type"]="application/xml"),OpenLayers.Request.issue(e)},PUT:function(e){return e=OpenLayers.Util.extend(e,{method:"PUT"}),e.headers=e.headers?e.headers:{},"CONTENT-TYPE"in OpenLayers.Util.upperCaseObject(e.headers)||(e.headers["Content-Type"]="application/xml"),OpenLayers.Request.issue(e)},DELETE:function(e){return e=OpenLayers.Util.extend(e,{method:"DELETE"}),OpenLayers.Request.issue(e)},HEAD:function(e){return e=OpenLayers.Util.extend(e,{method:"HEAD"}),OpenLayers.Request.issue(e)},OPTIONS:function(e){return e=OpenLayers.Util.extend(e,{method:"OPTIONS"}),OpenLayers.Request.issue(e)}},function(){function e(){this._object=o&&!c?new o:new window.ActiveXObject("Microsoft.XMLHTTP"),this._listeners=[]}function t(){return new e}function i(e){if(e._object.send(e._data),l&&!e._async)for(e.readyState=t.OPENED,s(e);e.readyState<t.DONE;)if(e.readyState++,a(e),e._aborted)return}function a(e){t.onreadystatechange&&t.onreadystatechange.apply(e),e.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function n(e){var t=e.responseXML,i=e.responseText;return u&&i&&t&&!t.documentElement&&e.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)&&(t=new window.ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.validateOnParse=!1,t.loadXML(i)),t&&(u&&0!=t.parseError||!t.documentElement||t.documentElement&&"parsererror"==t.documentElement.tagName)?null:t}function s(e){try{e.responseText=e._object.responseText}catch(t){}try{e.responseXML=n(e._object)}catch(t){}try{e.status=e._object.status}catch(t){}try{e.statusText=e._object.statusText}catch(t){}}function r(e){e._object.onreadystatechange=new window.Function}var o=window.XMLHttpRequest,l=!!window.controllers,u=window.document.all&&!window.opera,c=u&&window.navigator.userAgent.match(/MSIE 7.0/);t.prototype=e.prototype,l&&o.wrapped&&(t.wrapped=o.wrapped),t.UNSENT=0,t.OPENED=1,t.HEADERS_RECEIVED=2,t.LOADING=3,t.DONE=4,t.prototype.readyState=t.UNSENT,t.prototype.responseText="",t.prototype.responseXML=null,t.prototype.status=0,t.prototype.statusText="",t.prototype.priority="NORMAL",t.prototype.onreadystatechange=null,t.onreadystatechange=null,t.onopen=null,t.onsend=null,t.onabort=null,t.prototype.open=function(e,i,n,o,c){delete this._headers,arguments.length<3&&(n=!0),this._async=n;var h,d=this,p=this.readyState;u&&n&&(h=function(){p!=t.DONE&&(r(d),d.abort())},window.attachEvent("onunload",h)),t.onopen&&t.onopen.apply(this,arguments),arguments.length>4?this._object.open(e,i,n,o,c):arguments.length>3?this._object.open(e,i,n,o):this._object.open(e,i,n),this.readyState=t.OPENED,a(this),this._object.onreadystatechange=function(){if(!l||n){if(d.readyState=d._object.readyState,s(d),d._aborted)return d.readyState=t.UNSENT,void 0;d.readyState==t.DONE&&(delete d._data,r(d),u&&n&&window.detachEvent("onunload",h)),p!=d.readyState&&a(d),p=d.readyState}}},t.prototype.send=function(e){t.onsend&&t.onsend.apply(this,arguments),arguments.length||(e=null),e&&e.nodeType&&(e=window.XMLSerializer?(new window.XMLSerializer).serializeToString(e):e.xml,this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml")),this._data=e,i(this)},t.prototype.abort=function(){t.onabort&&t.onabort.apply(this,arguments),this.readyState>t.UNSENT&&(this._aborted=!0),this._object.abort(),r(this),this.readyState=t.UNSENT,delete this._data},t.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()},t.prototype.getResponseHeader=function(e){return this._object.getResponseHeader(e)},t.prototype.setRequestHeader=function(e,t){return this._headers||(this._headers={}),this._headers[e]=t,this._object.setRequestHeader(e,t)},t.prototype.addEventListener=function(e,t,i){for(var a,n=0;a=this._listeners[n];n++)if(a[0]==e&&a[1]==t&&a[2]==i)return;this._listeners.push([e,t,i])},t.prototype.removeEventListener=function(e,t,i){for(var a,n=0;(a=this._listeners[n])&&(a[0]!=e||a[1]!=t||a[2]!=i);n++);a&&this._listeners.splice(n,1)},t.prototype.dispatchEvent=function(e){var t={type:e.type,target:this,currentTarget:this,eventPhase:2,bubbles:e.bubbles,cancelable:e.cancelable,timeStamp:e.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};"readystatechange"==t.type&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[t]);for(var i,a=0;i=this._listeners[a];a++)i[0]!=t.type||i[2]||(i[1].handleEvent||i[1]).apply(this,[t])},t.prototype.toString=function(){return"[object XMLHttpRequest]"},t.toString=function(){return"[XMLHttpRequest]"},window.Function.prototype.apply||(window.Function.prototype.apply=function(e,t){t||(t=[]),e.__func=this,e.__func(t[0],t[1],t[2],t[3],t[4]),delete e.__func}),OpenLayers.Request.XMLHttpRequest=t}(),OpenLayers.Projection=OpenLayers.Class({proj:null,projCode:null,titleRegEx:/\+title=[^\+]*/,initialize:function(e,t){OpenLayers.Util.extend(this,t),this.projCode=e,window.Proj4js&&(this.proj=new Proj4js.Proj(e))},getCode:function(){return this.proj?this.proj.srsCode:this.projCode},getUnits:function(){return this.proj?this.proj.units:null},toString:function(){return this.getCode()},equals:function(e){var t=e,i=!1;if(t)if(t instanceof OpenLayers.Projection||(t=new OpenLayers.Projection(t)),window.Proj4js&&this.proj.defData&&t.proj.defData)i=this.proj.defData.replace(this.titleRegEx,"")==t.proj.defData.replace(this.titleRegEx,"");else if(t.getCode){var a=this.getCode(),n=t.getCode();i=a==n||!!OpenLayers.Projection.transforms[a]&&OpenLayers.Projection.transforms[a][n]===OpenLayers.Projection.nullTransform}return i},destroy:function(){delete this.proj,delete this.projCode},CLASS_NAME:"OpenLayers.Projection"}),OpenLayers.Projection.transforms={},OpenLayers.Projection.defaults={"EPSG:4326":{units:"degrees",maxExtent:[-180,-90,180,90],yx:!0},"CRS:84":{units:"degrees",maxExtent:[-180,-90,180,90]},"EPSG:900913":{units:"m",maxExtent:[-20037508.34,-20037508.34,20037508.34,20037508.34]}},OpenLayers.Projection.addTransform=function(e,t,i){if(i===OpenLayers.Projection.nullTransform){var a=OpenLayers.Projection.defaults[e];a&&!OpenLayers.Projection.defaults[t]&&(OpenLayers.Projection.defaults[t]=a)}OpenLayers.Projection.transforms[e]||(OpenLayers.Projection.transforms[e]={}),OpenLayers.Projection.transforms[e][t]=i},OpenLayers.Projection.transform=function(e,t,i){if(t&&i)if(t instanceof OpenLayers.Projection||(t=new OpenLayers.Projection(t)),i instanceof OpenLayers.Projection||(i=new OpenLayers.Projection(i)),t.proj&&i.proj)e=Proj4js.transform(t.proj,i.proj,e);else{var a=t.getCode(),n=i.getCode(),s=OpenLayers.Projection.transforms;s[a]&&s[a][n]&&s[a][n](e)}return e},OpenLayers.Projection.nullTransform=function(e){return e},function(){function e(e){return e.x=180*e.x/n,e.y=180/Math.PI*(2*Math.atan(Math.exp(e.y/n*Math.PI))-Math.PI/2),e}function t(e){return e.x=e.x*n/180,e.y=Math.log(Math.tan((90+e.y)*Math.PI/360))/Math.PI*n,e}function i(i,a){var n,s,r,o,l,u=OpenLayers.Projection.addTransform,c=OpenLayers.Projection.nullTransform;for(n=0,s=a.length;s>n;++n)for(r=a[n],u(i,r,t),u(r,i,e),l=n+1;s>l;++l)o=a[l],u(r,o,c),u(o,r,c)}var a,n=20037508.34,s=["EPSG:900913","EPSG:3857","EPSG:102113","EPSG:102100"],r=["CRS:84","urn:ogc:def:crs:EPSG:6.6:4326","EPSG:4326"];for(a=s.length-1;a>=0;--a)i(s[a],r);for(a=r.length-1;a>=0;--a)i(r[a],s)}(),OpenLayers.Map=OpenLayers.Class({Z_INDEX_BASE:{BaseLayer:100,Overlay:325,Feature:725,Popup:750,Control:1e3},id:null,fractionalZoom:!1,events:null,allOverlays:!1,div:null,dragging:!1,size:null,viewPortDiv:null,layerContainerOrigin:null,layerContainerDiv:null,layers:null,controls:null,popups:null,baseLayer:null,center:null,resolution:null,zoom:0,panRatio:1.5,options:null,tileSize:null,projection:"EPSG:4326",units:null,resolutions:null,maxResolution:null,minResolution:null,maxScale:null,minScale:null,maxExtent:null,minExtent:null,restrictedExtent:null,numZoomLevels:16,theme:null,displayProjection:null,fallThrough:!0,panTween:null,eventListeners:null,panMethod:OpenLayers.Easing.Expo.easeOut,panDuration:50,paddingForPopups:null,minPx:null,maxPx:null,initialize:function(e,t){1===arguments.length&&"object"==typeof e&&(t=e,e=t&&t.div),this.tileSize=new OpenLayers.Size(OpenLayers.Map.TILE_WIDTH,OpenLayers.Map.TILE_HEIGHT),this.paddingForPopups=new OpenLayers.Bounds(15,15,15,15),this.theme=OpenLayers._getScriptLocation()+"theme/default/style.css",this.options=OpenLayers.Util.extend({},t),OpenLayers.Util.extend(this,t);var i=this.projection instanceof OpenLayers.Projection?this.projection.projCode:this.projection;OpenLayers.Util.applyDefaults(this,OpenLayers.Projection.defaults[i]),!this.maxExtent||this.maxExtent instanceof OpenLayers.Bounds||(this.maxExtent=new OpenLayers.Bounds(this.maxExtent)),!this.minExtent||this.minExtent instanceof OpenLayers.Bounds||(this.minExtent=new OpenLayers.Bounds(this.minExtent)),!this.restrictedExtent||this.restrictedExtent instanceof OpenLayers.Bounds||(this.restrictedExtent=new OpenLayers.Bounds(this.restrictedExtent)),!this.center||this.center instanceof OpenLayers.LonLat||(this.center=new OpenLayers.LonLat(this.center)),this.layers=[],this.id=OpenLayers.Util.createUniqueID("OpenLayers.Map_"),this.div=OpenLayers.Util.getElement(e),this.div||(this.div=document.createElement("div"),this.div.style.height="1px",this.div.style.width="1px"),OpenLayers.Element.addClass(this.div,"olMap");var a=this.id+"_OpenLayers_ViewPort";if(this.viewPortDiv=OpenLayers.Util.createDiv(a,null,null,null,"relative",null,"hidden"),this.viewPortDiv.style.width="100%",this.viewPortDiv.style.height="100%",this.viewPortDiv.className="olMapViewport",this.div.appendChild(this.viewPortDiv),this.events=new OpenLayers.Events(this,this.viewPortDiv,null,this.fallThrough,{includeXY:!0}),a=this.id+"_OpenLayers_Container",this.layerContainerDiv=OpenLayers.Util.createDiv(a),this.layerContainerDiv.style.width="100px",this.layerContainerDiv.style.height="100px",this.layerContainerDiv.style.zIndex=this.Z_INDEX_BASE.Popup-1,this.viewPortDiv.appendChild(this.layerContainerDiv),this.updateSize(),this.eventListeners instanceof Object&&this.events.on(this.eventListeners),parseFloat(navigator.appVersion.split("MSIE")[1])<9?this.events.register("resize",this,this.updateSize):(this.updateSizeDestroy=OpenLayers.Function.bind(this.updateSize,this),OpenLayers.Event.observe(window,"resize",this.updateSizeDestroy)),this.theme){for(var n=!0,s=document.getElementsByTagName("link"),r=0,o=s.length;o>r;++r)if(OpenLayers.Util.isEquivalentUrl(s.item(r).href,this.theme)){n=!1;break}if(n){var l=document.createElement("link");l.setAttribute("rel","stylesheet"),l.setAttribute("type","text/css"),l.setAttribute("href",this.theme),document.getElementsByTagName("head")[0].appendChild(l)}}null==this.controls&&(this.controls=[],null!=OpenLayers.Control&&(OpenLayers.Control.Navigation?this.controls.push(new OpenLayers.Control.Navigation):OpenLayers.Control.TouchNavigation&&this.controls.push(new OpenLayers.Control.TouchNavigation),OpenLayers.Control.Zoom?this.controls.push(new OpenLayers.Control.Zoom):OpenLayers.Control.PanZoom&&this.controls.push(new OpenLayers.Control.PanZoom),OpenLayers.Control.ArgParser&&this.controls.push(new OpenLayers.Control.ArgParser),OpenLayers.Control.Attribution&&this.controls.push(new OpenLayers.Control.Attribution)));for(var r=0,o=this.controls.length;o>r;r++)this.addControlToMap(this.controls[r]);this.popups=[],this.unloadDestroy=OpenLayers.Function.bind(this.destroy,this),OpenLayers.Event.observe(window,"unload",this.unloadDestroy),t&&t.layers&&(delete this.center,this.addLayers(t.layers),t.center&&!this.getCenter()&&this.setCenter(t.center,t.zoom))},getViewport:function(){return this.viewPortDiv},render:function(e){this.div=OpenLayers.Util.getElement(e),OpenLayers.Element.addClass(this.div,"olMap"),this.viewPortDiv.parentNode.removeChild(this.viewPortDiv),this.div.appendChild(this.viewPortDiv),this.updateSize()},unloadDestroy:null,updateSizeDestroy:null,destroy:function(){if(!this.unloadDestroy)return!1;if(this.panTween&&(this.panTween.stop(),this.panTween=null),OpenLayers.Event.stopObserving(window,"unload",this.unloadDestroy),this.unloadDestroy=null,this.updateSizeDestroy?OpenLayers.Event.stopObserving(window,"resize",this.updateSizeDestroy):this.events.unregister("resize",this,this.updateSize),this.paddingForPopups=null,null!=this.controls){for(var e=this.controls.length-1;e>=0;--e)this.controls[e].destroy();this.controls=null}if(null!=this.layers){for(var e=this.layers.length-1;e>=0;--e)this.layers[e].destroy(!1);this.layers=null}this.viewPortDiv&&this.div.removeChild(this.viewPortDiv),this.viewPortDiv=null,this.eventListeners&&(this.events.un(this.eventListeners),this.eventListeners=null),this.events.destroy(),this.events=null,this.options=null},setOptions:function(e){var t=this.minPx&&e.restrictedExtent!=this.restrictedExtent;OpenLayers.Util.extend(this,e),t&&this.moveTo(this.getCachedCenter(),this.zoom,{forceZoomChange:!0})},getTileSize:function(){return this.tileSize},getBy:function(e,t,i){var a="function"==typeof i.test,n=OpenLayers.Array.filter(this[e],function(e){return e[t]==i||a&&i.test(e[t])});return n},getLayersBy:function(e,t){return this.getBy("layers",e,t)},getLayersByName:function(e){return this.getLayersBy("name",e)},getLayersByClass:function(e){return this.getLayersBy("CLASS_NAME",e)},getControlsBy:function(e,t){return this.getBy("controls",e,t)},getControlsByClass:function(e){return this.getControlsBy("CLASS_NAME",e)},getLayer:function(e){for(var t=null,i=0,a=this.layers.length;a>i;i++){var n=this.layers[i];if(n.id==e){t=n;break}}return t},setLayerZIndex:function(e,t){e.setZIndex(this.Z_INDEX_BASE[e.isBaseLayer?"BaseLayer":"Overlay"]+5*t)},resetLayersZIndex:function(){for(var e=0,t=this.layers.length;t>e;e++){var i=this.layers[e];this.setLayerZIndex(i,e)}},addLayer:function(e){for(var t=0,i=this.layers.length;i>t;t++)if(this.layers[t]==e)return!1;return this.events.triggerEvent("preaddlayer",{layer:e})===!1?!1:(this.allOverlays&&(e.isBaseLayer=!1),e.div.className="olLayerDiv",e.div.style.overflow="",this.setLayerZIndex(e,this.layers.length),e.isFixed?this.viewPortDiv.appendChild(e.div):this.layerContainerDiv.appendChild(e.div),this.layers.push(e),e.setMap(this),e.isBaseLayer||this.allOverlays&&!this.baseLayer?null==this.baseLayer?this.setBaseLayer(e):e.setVisibility(!1):e.redraw(),this.events.triggerEvent("addlayer",{layer:e}),e.events.triggerEvent("added",{map:this,layer:e}),e.afterAdd(),!0)},addLayers:function(e){for(var t=0,i=e.length;i>t;t++)this.addLayer(e[t])},removeLayer:function(e,t){if(this.events.triggerEvent("preremovelayer",{layer:e})!==!1){if(null==t&&(t=!0),e.isFixed?this.viewPortDiv.removeChild(e.div):this.layerContainerDiv.removeChild(e.div),OpenLayers.Util.removeItem(this.layers,e),e.removeMap(this),e.map=null,this.baseLayer==e&&(this.baseLayer=null,t))for(var i=0,a=this.layers.length;a>i;i++){var n=this.layers[i];if(n.isBaseLayer||this.allOverlays){this.setBaseLayer(n);break}}this.resetLayersZIndex(),this.events.triggerEvent("removelayer",{layer:e}),e.events.triggerEvent("removed",{map:this,layer:e})}},getNumLayers:function(){return this.layers.length},getLayerIndex:function(e){return OpenLayers.Util.indexOf(this.layers,e)},setLayerIndex:function(e,t){var i=this.getLayerIndex(e);if(0>t?t=0:t>this.layers.length&&(t=this.layers.length),i!=t){this.layers.splice(i,1),this.layers.splice(t,0,e);for(var a=0,n=this.layers.length;n>a;a++)this.setLayerZIndex(this.layers[a],a);this.events.triggerEvent("changelayer",{layer:e,property:"order"}),this.allOverlays&&(0===t?this.setBaseLayer(e):this.baseLayer!==this.layers[0]&&this.setBaseLayer(this.layers[0]))}},raiseLayer:function(e,t){var i=this.getLayerIndex(e)+t;this.setLayerIndex(e,i)},setBaseLayer:function(e){if(e!=this.baseLayer&&-1!=OpenLayers.Util.indexOf(this.layers,e)){var t=this.getCachedCenter(),i=OpenLayers.Util.getResolutionFromScale(this.getScale(),e.units);if(null==this.baseLayer||this.allOverlays||this.baseLayer.setVisibility(!1),this.baseLayer=e,(!this.allOverlays||this.baseLayer.visibility)&&(this.baseLayer.setVisibility(!0),this.baseLayer.inRange===!1&&this.baseLayer.redraw()),null!=t){var a=this.getZoomForResolution(i||this.resolution,!0);this.setCenter(t,a,!1,!0)}this.events.triggerEvent("changebaselayer",{layer:this.baseLayer})}},addControl:function(e,t){this.controls.push(e),this.addControlToMap(e,t)},addControls:function(e,t){for(var i=1===arguments.length?[]:t,a=0,n=e.length;n>a;a++){var s=e[a],r=i[a]?i[a]:null;this.addControl(s,r)}},addControlToMap:function(e,t){e.outsideViewport=null!=e.div,this.displayProjection&&!e.displayProjection&&(e.displayProjection=this.displayProjection),e.setMap(this);var i=e.draw(t);i&&(e.outsideViewport||(i.style.zIndex=this.Z_INDEX_BASE.Control+this.controls.length,this.viewPortDiv.appendChild(i))),e.autoActivate&&e.activate()},getControl:function(e){for(var t=null,i=0,a=this.controls.length;a>i;i++){var n=this.controls[i];if(n.id==e){t=n;break}}return t},removeControl:function(e){e&&e==this.getControl(e.id)&&(e.div&&e.div.parentNode==this.viewPortDiv&&this.viewPortDiv.removeChild(e.div),OpenLayers.Util.removeItem(this.controls,e))},addPopup:function(e,t){if(t)for(var i=this.popups.length-1;i>=0;--i)this.removePopup(this.popups[i]);e.map=this,this.popups.push(e);var a=e.draw();a&&(a.style.zIndex=this.Z_INDEX_BASE.Popup+this.popups.length,this.layerContainerDiv.appendChild(a))},removePopup:function(e){if(OpenLayers.Util.removeItem(this.popups,e),e.div)try{this.layerContainerDiv.removeChild(e.div)}catch(t){}e.map=null},getSize:function(){var e=null;return null!=this.size&&(e=this.size.clone()),e},updateSize:function(){var e=this.getCurrentSize();if(e&&!isNaN(e.h)&&!isNaN(e.w)){this.events.clearMouseCache();var t=this.getSize();if(null==t&&(this.size=t=e),!e.equals(t)){this.size=e;for(var i=0,a=this.layers.length;a>i;i++)this.layers[i].onMapResize();var n=this.getCachedCenter();if(null!=this.baseLayer&&null!=n){var s=this.getZoom();this.zoom=null,this.setCenter(n,s)}}}},getCurrentSize:function(){var e=new OpenLayers.Size(this.div.clientWidth,this.div.clientHeight);return(0==e.w&&0==e.h||isNaN(e.w)&&isNaN(e.h))&&(e.w=this.div.offsetWidth,e.h=this.div.offsetHeight),(0==e.w&&0==e.h||isNaN(e.w)&&isNaN(e.h))&&(e.w=parseInt(this.div.style.width),e.h=parseInt(this.div.style.height)),e},calculateBounds:function(e,t){var i=null;if(null==e&&(e=this.getCachedCenter()),null==t&&(t=this.getResolution()),null!=e&&null!=t){var a=this.size.w*t/2,n=this.size.h*t/2;i=new OpenLayers.Bounds(e.lon-a,e.lat-n,e.lon+a,e.lat+n)}return i},getCenter:function(){var e=null,t=this.getCachedCenter();return t&&(e=t.clone()),e},getCachedCenter:function(){return!this.center&&this.size&&(this.center=this.getLonLatFromViewPortPx({x:this.size.w/2,y:this.size.h/2})),this.center},getZoom:function(){return this.zoom},pan:function(e,t,i){if(i=OpenLayers.Util.applyDefaults(i,{animate:!0,dragging:!1}),i.dragging)(0!=e||0!=t)&&this.moveByPx(e,t);else{var a=this.getViewPortPxFromLonLat(this.getCachedCenter()),n=a.add(e,t);if(this.dragging||!n.equals(a)){var s=this.getLonLatFromViewPortPx(n);i.animate?this.panTo(s):(this.moveTo(s),this.dragging&&(this.dragging=!1,this.events.triggerEvent("moveend")))}}},panTo:function(e){if(this.panMethod&&this.getExtent().scale(this.panRatio).containsLonLat(e)){this.panTween||(this.panTween=new OpenLayers.Tween(this.panMethod));
var t=this.getCachedCenter();if(e.equals(t))return;var i=this.getPixelFromLonLat(t),a=this.getPixelFromLonLat(e),n={x:a.x-i.x,y:a.y-i.y},s={x:0,y:0};this.panTween.start({x:0,y:0},n,this.panDuration,{callbacks:{eachStep:OpenLayers.Function.bind(function(e){var t=e.x-s.x,i=e.y-s.y;this.moveByPx(t,i),s.x=Math.round(e.x),s.y=Math.round(e.y)},this),done:OpenLayers.Function.bind(function(){this.moveTo(e),this.dragging=!1,this.events.triggerEvent("moveend")},this)}})}else this.setCenter(e)},setCenter:function(e,t,i,a){this.panTween&&this.panTween.stop(),this.moveTo(e,t,{dragging:i,forceZoomChange:a})},moveByPx:function(e,t){var i=this.size.w/2,a=this.size.h/2,n=i+e,s=a+t,r=this.baseLayer.wrapDateLine,o=0,l=0;if(this.restrictedExtent&&(o=i,l=a,r=!1),e=r||n<=this.maxPx.x-o&&n>=this.minPx.x+o?Math.round(e):0,t=s<=this.maxPx.y-l&&s>=this.minPx.y+l?Math.round(t):0,e||t){this.dragging||(this.dragging=!0,this.events.triggerEvent("movestart")),this.center=null,e&&(this.layerContainerDiv.style.left=parseInt(this.layerContainerDiv.style.left)-e+"px",this.minPx.x-=e,this.maxPx.x-=e),t&&(this.layerContainerDiv.style.top=parseInt(this.layerContainerDiv.style.top)-t+"px",this.minPx.y-=t,this.maxPx.y-=t);var u,c,h;for(c=0,h=this.layers.length;h>c;++c)u=this.layers[c],u.visibility&&(u===this.baseLayer||u.inRange)&&(u.moveByPx(e,t),u.events.triggerEvent("move"));this.events.triggerEvent("move")}},adjustZoom:function(e){var t=this.baseLayer.resolutions,i=this.getMaxExtent().getWidth()/this.size.w;if(this.getResolutionForZoom(e)>i)for(var a=0|e,n=t.length;n>a;++a)if(t[a]<=i){e=a;break}return e},moveTo:function(e,t,i){if(null==e||e instanceof OpenLayers.LonLat||(e=new OpenLayers.LonLat(e)),i||(i={}),null!=t&&(t=parseFloat(t),this.fractionalZoom||(t=Math.round(t))),this.baseLayer.wrapDateLine){var a=t;t=this.adjustZoom(t),t!==a&&(e=this.getCenter())}var n=i.dragging||this.dragging,s=i.forceZoomChange;if(this.getCachedCenter()||this.isValidLonLat(e)||(e=this.maxExtent.getCenterLonLat(),this.center=e.clone()),null!=this.restrictedExtent){null==e&&(e=this.center),null==t&&(t=this.getZoom());var r=this.getResolutionForZoom(t),o=this.calculateBounds(e,r);if(!this.restrictedExtent.containsBounds(o)){var l=this.restrictedExtent.getCenterLonLat();o.getWidth()>this.restrictedExtent.getWidth()?e=new OpenLayers.LonLat(l.lon,e.lat):o.left<this.restrictedExtent.left?e=e.add(this.restrictedExtent.left-o.left,0):o.right>this.restrictedExtent.right&&(e=e.add(this.restrictedExtent.right-o.right,0)),o.getHeight()>this.restrictedExtent.getHeight()?e=new OpenLayers.LonLat(e.lon,l.lat):o.bottom<this.restrictedExtent.bottom?e=e.add(0,this.restrictedExtent.bottom-o.bottom):o.top>this.restrictedExtent.top&&(e=e.add(0,this.restrictedExtent.top-o.top))}}var u=s||this.isValidZoomLevel(t)&&t!=this.getZoom(),c=this.isValidLonLat(e)&&!e.equals(this.center);if(u||c||n){n||this.events.triggerEvent("movestart"),c&&(!u&&this.center&&this.centerLayerContainer(e),this.center=e.clone());var h=u?this.getResolutionForZoom(t):this.getResolution();if(u||null==this.layerContainerOrigin){this.layerContainerOrigin=this.getCachedCenter(),this.layerContainerDiv.style.left="0px",this.layerContainerDiv.style.top="0px";var d=this.getMaxExtent({restricted:!0}),p=d.getCenterLonLat(),f=this.center.lon-p.lon,m=p.lat-this.center.lat,g=Math.round(d.getWidth()/h),y=Math.round(d.getHeight()/h);this.minPx={x:(this.size.w-g)/2-f/h,y:(this.size.h-y)/2-m/h},this.maxPx={x:this.minPx.x+Math.round(d.getWidth()/h),y:this.minPx.y+Math.round(d.getHeight()/h)}}u&&(this.zoom=t,this.resolution=h);var v=this.getExtent();this.baseLayer.visibility&&(this.baseLayer.moveTo(v,u,i.dragging),i.dragging||this.baseLayer.events.triggerEvent("moveend",{zoomChanged:u})),v=this.baseLayer.getExtent();for(var b=this.layers.length-1;b>=0;--b){var _=this.layers[b];if(_!==this.baseLayer&&!_.isBaseLayer){var k=_.calculateInRange();_.inRange!=k&&(_.inRange=k,k||_.display(!1),this.events.triggerEvent("changelayer",{layer:_,property:"visibility"})),k&&_.visibility&&(_.moveTo(v,u,i.dragging),i.dragging||_.events.triggerEvent("moveend",{zoomChanged:u}))}}if(this.events.triggerEvent("move"),n||this.events.triggerEvent("moveend"),u){for(var b=0,L=this.popups.length;L>b;b++)this.popups[b].updatePosition();this.events.triggerEvent("zoomend")}}},centerLayerContainer:function(e){var t=this.getViewPortPxFromLonLat(this.layerContainerOrigin),i=this.getViewPortPxFromLonLat(e);if(null!=t&&null!=i){var a=parseInt(this.layerContainerDiv.style.left),n=parseInt(this.layerContainerDiv.style.top),s=Math.round(t.x-i.x),r=Math.round(t.y-i.y);this.layerContainerDiv.style.left=s+"px",this.layerContainerDiv.style.top=r+"px";var o=a-s,l=n-r;this.minPx.x-=o,this.maxPx.x-=o,this.minPx.y-=l,this.maxPx.y-=l}},isValidZoomLevel:function(e){return null!=e&&e>=0&&e<this.getNumZoomLevels()},isValidLonLat:function(e){var t=!1;if(null!=e){var i=this.getMaxExtent(),a=this.baseLayer.wrapDateLine&&i;t=i.containsLonLat(e,{worldBounds:a})}return t},getProjection:function(){var e=this.getProjectionObject();return e?e.getCode():null},getProjectionObject:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.projection),e},getMaxResolution:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.maxResolution),e},getMaxExtent:function(e){var t=null;return e&&e.restricted&&this.restrictedExtent?t=this.restrictedExtent:null!=this.baseLayer&&(t=this.baseLayer.maxExtent),t},getNumZoomLevels:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.numZoomLevels),e},getExtent:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.getExtent()),e},getResolution:function(){var e=null;return null!=this.baseLayer?e=this.baseLayer.getResolution():this.allOverlays===!0&&this.layers.length>0&&(e=this.layers[0].getResolution()),e},getUnits:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.units),e},getScale:function(){var e=null;if(null!=this.baseLayer){var t=this.getResolution(),i=this.baseLayer.units;e=OpenLayers.Util.getScaleFromResolution(t,i)}return e},getZoomForExtent:function(e,t){var i=null;return null!=this.baseLayer&&(i=this.baseLayer.getZoomForExtent(e,t)),i},getResolutionForZoom:function(e){var t=null;return this.baseLayer&&(t=this.baseLayer.getResolutionForZoom(e)),t},getZoomForResolution:function(e,t){var i=null;return null!=this.baseLayer&&(i=this.baseLayer.getZoomForResolution(e,t)),i},zoomTo:function(e){this.isValidZoomLevel(e)&&this.setCenter(null,e)},zoomIn:function(){this.zoomTo(this.getZoom()+1)},zoomOut:function(){this.zoomTo(this.getZoom()-1)},zoomToExtent:function(e,t){e instanceof OpenLayers.Bounds||(e=new OpenLayers.Bounds(e));var i=e.getCenterLonLat();if(this.baseLayer.wrapDateLine){var a=this.getMaxExtent();for(e=e.clone();e.right<e.left;)e.right+=a.getWidth();i=e.getCenterLonLat().wrapDateLine(a)}this.setCenter(i,this.getZoomForExtent(e,t))},zoomToMaxExtent:function(e){var t=e?e.restricted:!0,i=this.getMaxExtent({restricted:t});this.zoomToExtent(i)},zoomToScale:function(e,t){var i=OpenLayers.Util.getResolutionFromScale(e,this.baseLayer.units),a=this.size.w*i/2,n=this.size.h*i/2,s=this.getCachedCenter(),r=new OpenLayers.Bounds(s.lon-a,s.lat-n,s.lon+a,s.lat+n);this.zoomToExtent(r,t)},getLonLatFromViewPortPx:function(e){var t=null;return null!=this.baseLayer&&(t=this.baseLayer.getLonLatFromViewPortPx(e)),t},getViewPortPxFromLonLat:function(e){var t=null;return null!=this.baseLayer&&(t=this.baseLayer.getViewPortPxFromLonLat(e)),t},getLonLatFromPixel:function(e){return this.getLonLatFromViewPortPx(e)},getPixelFromLonLat:function(e){var t=this.getViewPortPxFromLonLat(e);return t.x=Math.round(t.x),t.y=Math.round(t.y),t},getGeodesicPixelSize:function(e){var t=e?this.getLonLatFromPixel(e):this.getCachedCenter()||new OpenLayers.LonLat(0,0),i=this.getResolution(),a=t.add(-i/2,0),n=t.add(i/2,0),s=t.add(0,-i/2),r=t.add(0,i/2),o=new OpenLayers.Projection("EPSG:4326"),l=this.getProjectionObject()||o;return l.equals(o)||(a.transform(l,o),n.transform(l,o),s.transform(l,o),r.transform(l,o)),new OpenLayers.Size(OpenLayers.Util.distVincenty(a,n),OpenLayers.Util.distVincenty(s,r))},getViewPortPxFromLayerPx:function(e){var t=null;if(null!=e){var i=parseInt(this.layerContainerDiv.style.left),a=parseInt(this.layerContainerDiv.style.top);t=e.add(i,a)}return t},getLayerPxFromViewPortPx:function(e){var t=null;if(null!=e){var i=-parseInt(this.layerContainerDiv.style.left),a=-parseInt(this.layerContainerDiv.style.top);t=e.add(i,a),(isNaN(t.x)||isNaN(t.y))&&(t=null)}return t},getLonLatFromLayerPx:function(e){return e=this.getViewPortPxFromLayerPx(e),this.getLonLatFromViewPortPx(e)},getLayerPxFromLonLat:function(e){var t=this.getPixelFromLonLat(e);return this.getLayerPxFromViewPortPx(t)},CLASS_NAME:"OpenLayers.Map"}),OpenLayers.Map.TILE_WIDTH=256,OpenLayers.Map.TILE_HEIGHT=256,OpenLayers.Layer=OpenLayers.Class({id:null,name:null,div:null,opacity:1,alwaysInRange:null,RESOLUTION_PROPERTIES:["scales","resolutions","maxScale","minScale","maxResolution","minResolution","numZoomLevels","maxZoomLevel"],events:null,map:null,isBaseLayer:!1,alpha:!1,displayInLayerSwitcher:!0,visibility:!0,attribution:null,inRange:!1,imageSize:null,options:null,eventListeners:null,gutter:0,projection:null,units:null,scales:null,resolutions:null,maxExtent:null,minExtent:null,maxResolution:null,minResolution:null,numZoomLevels:null,minScale:null,maxScale:null,displayOutsideMaxExtent:!1,wrapDateLine:!1,metadata:null,initialize:function(e,t){this.metadata={},this.addOptions(t),this.name=e,null==this.id&&(this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"),this.div=OpenLayers.Util.createDiv(this.id),this.div.style.width="100%",this.div.style.height="100%",this.div.dir="ltr",this.events=new OpenLayers.Events(this,this.div),this.eventListeners instanceof Object&&this.events.on(this.eventListeners))},destroy:function(e){null==e&&(e=!0),null!=this.map&&this.map.removeLayer(this,e),this.projection=null,this.map=null,this.name=null,this.div=null,this.options=null,this.events&&(this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy()),this.eventListeners=null,this.events=null},clone:function(e){return null==e&&(e=new OpenLayers.Layer(this.name,this.getOptions())),OpenLayers.Util.applyDefaults(e,this),e.map=null,e},getOptions:function(){var e={};for(var t in this.options)e[t]=this[t];return e},setName:function(e){e!=this.name&&(this.name=e,null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"name"}))},addOptions:function(e,t){if(null==this.options&&(this.options={}),e&&("string"==typeof e.projection&&(e.projection=new OpenLayers.Projection(e.projection)),e.projection&&OpenLayers.Util.applyDefaults(e,OpenLayers.Projection.defaults[e.projection.getCode()]),!e.maxExtent||e.maxExtent instanceof OpenLayers.Bounds||(e.maxExtent=new OpenLayers.Bounds(e.maxExtent)),!e.minExtent||e.minExtent instanceof OpenLayers.Bounds||(e.minExtent=new OpenLayers.Bounds(e.minExtent))),OpenLayers.Util.extend(this.options,e),OpenLayers.Util.extend(this,e),this.projection&&this.projection.getUnits()&&(this.units=this.projection.getUnits()),this.map){var i=this.map.getResolution(),a=this.RESOLUTION_PROPERTIES.concat(["projection","units","minExtent","maxExtent"]);for(var n in e)if(e.hasOwnProperty(n)&&OpenLayers.Util.indexOf(a,n)>=0){this.initResolutions(),t&&this.map.baseLayer===this&&(this.map.setCenter(this.map.getCenter(),this.map.getZoomForResolution(i),!1,!0),this.map.events.triggerEvent("changebaselayer",{layer:this}));break}}},onMapResize:function(){},redraw:function(){var e=!1;if(this.map){this.inRange=this.calculateInRange();var t=this.getExtent();if(t&&this.inRange&&this.visibility){var i=!0;this.moveTo(t,i,!1),this.events.triggerEvent("moveend",{zoomChanged:i}),e=!0}}return e},moveTo:function(){var e=this.visibility;this.isBaseLayer||(e=e&&this.inRange),this.display(e)},moveByPx:function(){},setMap:function(e){if(null==this.map){if(this.map=e,this.maxExtent=this.maxExtent||this.map.maxExtent,this.minExtent=this.minExtent||this.map.minExtent,this.projection=this.projection||this.map.projection,"string"==typeof this.projection&&(this.projection=new OpenLayers.Projection(this.projection)),this.units=this.projection.getUnits()||this.units||this.map.units,this.initResolutions(),!this.isBaseLayer){this.inRange=this.calculateInRange();var t=this.visibility&&this.inRange;this.div.style.display=t?"":"none"}this.setTileSize()}},afterAdd:function(){},removeMap:function(){},getImageSize:function(){return this.imageSize||this.tileSize},setTileSize:function(e){var t=e?e:this.tileSize?this.tileSize:this.map.getTileSize();this.tileSize=t,this.gutter&&(this.imageSize=new OpenLayers.Size(t.w+2*this.gutter,t.h+2*this.gutter))},getVisibility:function(){return this.visibility},setVisibility:function(e){e!=this.visibility&&(this.visibility=e,this.display(e),this.redraw(),null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"visibility"}),this.events.triggerEvent("visibilitychanged"))},display:function(e){e!=("none"!=this.div.style.display)&&(this.div.style.display=e&&this.calculateInRange()?"block":"none")},calculateInRange:function(){var e=!1;if(this.alwaysInRange)e=!0;else if(this.map){var t=this.map.getResolution();e=t>=this.minResolution&&t<=this.maxResolution}return e},setIsBaseLayer:function(e){e!=this.isBaseLayer&&(this.isBaseLayer=e,null!=this.map&&this.map.events.triggerEvent("changebaselayer",{layer:this}))},initResolutions:function(){var e,t,i,a={},n=!0;for(e=0,t=this.RESOLUTION_PROPERTIES.length;t>e;e++)i=this.RESOLUTION_PROPERTIES[e],a[i]=this.options[i],n&&this.options[i]&&(n=!1);if(null==this.alwaysInRange&&(this.alwaysInRange=n),null==a.resolutions&&(a.resolutions=this.resolutionsFromScales(a.scales)),null==a.resolutions&&(a.resolutions=this.calculateResolutions(a)),null==a.resolutions){for(e=0,t=this.RESOLUTION_PROPERTIES.length;t>e;e++)i=this.RESOLUTION_PROPERTIES[e],a[i]=null!=this.options[i]?this.options[i]:this.map[i];null==a.resolutions&&(a.resolutions=this.resolutionsFromScales(a.scales)),null==a.resolutions&&(a.resolutions=this.calculateResolutions(a))}var s;this.options.maxResolution&&"auto"!==this.options.maxResolution&&(s=this.options.maxResolution),this.options.minScale&&(s=OpenLayers.Util.getResolutionFromScale(this.options.minScale,this.units));var r;if(this.options.minResolution&&"auto"!==this.options.minResolution&&(r=this.options.minResolution),this.options.maxScale&&(r=OpenLayers.Util.getResolutionFromScale(this.options.maxScale,this.units)),a.resolutions&&(a.resolutions.sort(function(e,t){return t-e}),s||(s=a.resolutions[0]),!r)){var o=a.resolutions.length-1;r=a.resolutions[o]}if(this.resolutions=a.resolutions,this.resolutions){for(t=this.resolutions.length,this.scales=new Array(t),e=0;t>e;e++)this.scales[e]=OpenLayers.Util.getScaleFromResolution(this.resolutions[e],this.units);this.numZoomLevels=t}this.minResolution=r,r&&(this.maxScale=OpenLayers.Util.getScaleFromResolution(r,this.units)),this.maxResolution=s,s&&(this.minScale=OpenLayers.Util.getScaleFromResolution(s,this.units))},resolutionsFromScales:function(e){if(null!=e){var t,i,a;for(a=e.length,t=new Array(a),i=0;a>i;i++)t[i]=OpenLayers.Util.getResolutionFromScale(e[i],this.units);return t}},calculateResolutions:function(e){var t,i,a,n=e.maxResolution;null!=e.minScale?n=OpenLayers.Util.getResolutionFromScale(e.minScale,this.units):"auto"==n&&null!=this.maxExtent&&(t=this.map.getSize(),i=this.maxExtent.getWidth()/t.w,a=this.maxExtent.getHeight()/t.h,n=Math.max(i,a));var s=e.minResolution;if(null!=e.maxScale?s=OpenLayers.Util.getResolutionFromScale(e.maxScale,this.units):"auto"==e.minResolution&&null!=this.minExtent&&(t=this.map.getSize(),i=this.minExtent.getWidth()/t.w,a=this.minExtent.getHeight()/t.h,s=Math.max(i,a)),"number"!=typeof n&&"number"!=typeof s&&null!=this.maxExtent){var r=this.map.getTileSize();n=Math.max(this.maxExtent.getWidth()/r.w,this.maxExtent.getHeight()/r.h)}var o=e.maxZoomLevel,l=e.numZoomLevels;if("number"==typeof s&&"number"==typeof n&&void 0===l){var u=n/s;l=Math.floor(Math.log(u)/Math.log(2))+1}else void 0===l&&null!=o&&(l=o+1);if(!("number"!=typeof l||0>=l||"number"!=typeof n&&"number"!=typeof s)){var c=new Array(l),h=2;"number"==typeof s&&"number"==typeof n&&(h=Math.pow(n/s,1/(l-1)));var d;if("number"==typeof n)for(d=0;l>d;d++)c[d]=n/Math.pow(h,d);else for(d=0;l>d;d++)c[l-1-d]=s*Math.pow(h,d);return c}},getResolution:function(){var e=this.map.getZoom();return this.getResolutionForZoom(e)},getExtent:function(){return this.map.calculateBounds()},getZoomForExtent:function(e,t){var i=this.map.getSize(),a=Math.max(e.getWidth()/i.w,e.getHeight()/i.h);return this.getZoomForResolution(a,t)},getDataExtent:function(){},getResolutionForZoom:function(e){e=Math.max(0,Math.min(e,this.resolutions.length-1));var t;if(this.map.fractionalZoom){var i=Math.floor(e),a=Math.ceil(e);t=this.resolutions[i]-(e-i)*(this.resolutions[i]-this.resolutions[a])}else t=this.resolutions[Math.round(e)];return t},getZoomForResolution:function(e,t){var i,a,n;if(this.map.fractionalZoom){var s,r=0,o=this.resolutions.length-1,l=this.resolutions[r],u=this.resolutions[o];for(a=0,n=this.resolutions.length;n>a;++a)if(s=this.resolutions[a],s>=e&&(l=s,r=a),e>=s){u=s,o=a;break}var c=l-u;i=c>0?r+(l-e)/c:r}else{var h,d=Number.POSITIVE_INFINITY;for(a=0,n=this.resolutions.length;n>a;a++)if(t){if(h=Math.abs(this.resolutions[a]-e),h>d)break;d=h}else if(this.resolutions[a]<e)break;i=Math.max(0,a-1)}return i},getLonLatFromViewPortPx:function(e){var t=null,i=this.map;if(null!=e&&i.minPx){var a=i.getResolution(),n=i.getMaxExtent({restricted:!0}),s=(e.x-i.minPx.x)*a+n.left,r=(i.minPx.y-e.y)*a+n.top;t=new OpenLayers.LonLat(s,r),this.wrapDateLine&&(t=t.wrapDateLine(this.maxExtent))}return t},getViewPortPxFromLonLat:function(e,t){var i=null;if(null!=e){t=t||this.map.getResolution();var a=this.map.calculateBounds(null,t);i=new OpenLayers.Pixel(1/t*(e.lon-a.left),1/t*(a.top-e.lat))}return i},setOpacity:function(e){if(e!=this.opacity){this.opacity=e;for(var t=this.div.childNodes,i=0,a=t.length;a>i;++i){var n=t[i].firstChild||t[i],s=t[i].lastChild;s&&"iframe"===s.nodeName.toLowerCase()&&(n=s.parentNode),OpenLayers.Util.modifyDOMElement(n,null,null,null,null,null,null,e)}null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"opacity"})}},getZIndex:function(){return this.div.style.zIndex},setZIndex:function(e){this.div.style.zIndex=e},adjustBounds:function(e){if(this.gutter){var t=this.gutter*this.map.getResolution();e=new OpenLayers.Bounds(e.left-t,e.bottom-t,e.right+t,e.top+t)}if(this.wrapDateLine){var i={rightTolerance:this.getResolution(),leftTolerance:this.getResolution()};e=e.wrapDateLine(this.maxExtent,i)}return e},CLASS_NAME:"OpenLayers.Layer"}),OpenLayers.Icon=OpenLayers.Class({url:null,size:null,offset:null,calculateOffset:null,imageDiv:null,px:null,initialize:function(e,t,i,a){this.url=e,this.size=t||{w:20,h:20},this.offset=i||{x:-(this.size.w/2),y:-(this.size.h/2)},this.calculateOffset=a;var n=OpenLayers.Util.createUniqueID("OL_Icon_");this.imageDiv=OpenLayers.Util.createAlphaImageDiv(n)},destroy:function(){this.erase(),OpenLayers.Event.stopObservingElement(this.imageDiv.firstChild),this.imageDiv.innerHTML="",this.imageDiv=null},clone:function(){return new OpenLayers.Icon(this.url,this.size,this.offset,this.calculateOffset)},setSize:function(e){null!=e&&(this.size=e),this.draw()},setUrl:function(e){null!=e&&(this.url=e),this.draw()},draw:function(e){return OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,null,this.size,this.url,"absolute"),this.moveTo(e),this.imageDiv},erase:function(){null!=this.imageDiv&&null!=this.imageDiv.parentNode&&OpenLayers.Element.remove(this.imageDiv)},setOpacity:function(e){OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,null,null,null,null,null,null,e)},moveTo:function(e){null!=e&&(this.px=e),null!=this.imageDiv&&(null==this.px?this.display(!1):(this.calculateOffset&&(this.offset=this.calculateOffset(this.size)),OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,{x:this.px.x+this.offset.x,y:this.px.y+this.offset.y})))},display:function(e){this.imageDiv.style.display=e?"":"none"},isDrawn:function(){var e=this.imageDiv&&this.imageDiv.parentNode&&11!=this.imageDiv.parentNode.nodeType;return e},CLASS_NAME:"OpenLayers.Icon"}),OpenLayers.Marker=OpenLayers.Class({icon:null,lonlat:null,events:null,map:null,initialize:function(e,t){this.lonlat=e;var i=t?t:OpenLayers.Marker.defaultIcon();null==this.icon?this.icon=i:(this.icon.url=i.url,this.icon.size=i.size,this.icon.offset=i.offset,this.icon.calculateOffset=i.calculateOffset),this.events=new OpenLayers.Events(this,this.icon.imageDiv)},destroy:function(){this.erase(),this.map=null,this.events.destroy(),this.events=null,null!=this.icon&&(this.icon.destroy(),this.icon=null)},draw:function(e){return this.icon.draw(e)},erase:function(){null!=this.icon&&this.icon.erase()},moveTo:function(e){null!=e&&null!=this.icon&&this.icon.moveTo(e),this.lonlat=this.map.getLonLatFromLayerPx(e)},isDrawn:function(){var e=this.icon&&this.icon.isDrawn();return e},onScreen:function(){var e=!1;if(this.map){var t=this.map.getExtent();e=t.containsLonLat(this.lonlat)}return e},inflate:function(e){this.icon&&this.icon.setSize({w:this.icon.size.w*e,h:this.icon.size.h*e})},setOpacity:function(e){this.icon.setOpacity(e)},setUrl:function(e){this.icon.setUrl(e)},display:function(e){this.icon.display(e)},CLASS_NAME:"OpenLayers.Marker"}),OpenLayers.Marker.defaultIcon=function(){return new OpenLayers.Icon(OpenLayers.Util.getImageLocation("marker.png"),{w:21,h:25},{x:-10.5,y:-25})},OpenLayers.Popup=OpenLayers.Class({events:null,id:"",lonlat:null,div:null,contentSize:null,size:null,contentHTML:null,backgroundColor:"",opacity:"",border:"",contentDiv:null,groupDiv:null,closeDiv:null,autoSize:!1,minSize:null,maxSize:null,displayClass:"olPopup",contentDisplayClass:"olPopupContent",padding:0,disableFirefoxOverflowHack:!1,fixPadding:function(){"number"==typeof this.padding&&(this.padding=new OpenLayers.Bounds(this.padding,this.padding,this.padding,this.padding))},panMapIfOutOfView:!1,keepInMap:!1,closeOnMove:!1,map:null,initialize:function(e,t,i,a,n,s){null==e&&(e=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")),this.id=e,this.lonlat=t,this.contentSize=null!=i?i:new OpenLayers.Size(OpenLayers.Popup.WIDTH,OpenLayers.Popup.HEIGHT),null!=a&&(this.contentHTML=a),this.backgroundColor=OpenLayers.Popup.COLOR,this.opacity=OpenLayers.Popup.OPACITY,this.border=OpenLayers.Popup.BORDER,this.div=OpenLayers.Util.createDiv(this.id,null,null,null,null,null,"hidden"),this.div.className=this.displayClass;var r=this.id+"_GroupDiv";this.groupDiv=OpenLayers.Util.createDiv(r,null,null,null,"relative",null,"hidden");var e=this.div.id+"_contentDiv";this.contentDiv=OpenLayers.Util.createDiv(e,null,this.contentSize.clone(),null,"relative"),this.contentDiv.className=this.contentDisplayClass,this.groupDiv.appendChild(this.contentDiv),this.div.appendChild(this.groupDiv),n&&this.addCloseBox(s),this.registerEvents()},destroy:function(){this.id=null,this.lonlat=null,this.size=null,this.contentHTML=null,this.backgroundColor=null,this.opacity=null,this.border=null,this.closeOnMove&&this.map&&this.map.events.unregister("movestart",this,this.hide),this.events.destroy(),this.events=null,this.closeDiv&&(OpenLayers.Event.stopObservingElement(this.closeDiv),this.groupDiv.removeChild(this.closeDiv)),this.closeDiv=null,this.div.removeChild(this.groupDiv),this.groupDiv=null,null!=this.map&&this.map.removePopup(this),this.map=null,this.div=null,this.autoSize=null,this.minSize=null,this.maxSize=null,this.padding=null,this.panMapIfOutOfView=null},draw:function(e){return null==e&&null!=this.lonlat&&null!=this.map&&(e=this.map.getLayerPxFromLonLat(this.lonlat)),this.closeOnMove&&this.map.events.register("movestart",this,this.hide),this.disableFirefoxOverflowHack||"firefox"!=OpenLayers.BROWSER_NAME||(this.map.events.register("movestart",this,function(){var e=document.defaultView.getComputedStyle(this.contentDiv,null),t=e.getPropertyValue("overflow");"hidden"!=t&&(this.contentDiv._oldOverflow=t,this.contentDiv.style.overflow="hidden")}),this.map.events.register("moveend",this,function(){var e=this.contentDiv._oldOverflow;e&&(this.contentDiv.style.overflow=e,this.contentDiv._oldOverflow=null)})),this.moveTo(e),this.autoSize||this.size||this.setSize(this.contentSize),this.setBackgroundColor(),this.setOpacity(),this.setBorder(),this.setContentHTML(),this.panMapIfOutOfView&&this.panIntoView(),this.div},updatePosition:function(){if(this.lonlat&&this.map){var e=this.map.getLayerPxFromLonLat(this.lonlat);e&&this.moveTo(e)}},moveTo:function(e){null!=e&&null!=this.div&&(this.div.style.left=e.x+"px",this.div.style.top=e.y+"px")},visible:function(){return OpenLayers.Element.visible(this.div)},toggle:function(){this.visible()?this.hide():this.show()},show:function(){this.div.style.display="",this.panMapIfOutOfView&&this.panIntoView()},hide:function(){this.div.style.display="none"},setSize:function(e){this.size=e.clone();var t=this.getContentDivPadding(),i=t.left+t.right,a=t.top+t.bottom;if(this.fixPadding(),i+=this.padding.left+this.padding.right,a+=this.padding.top+this.padding.bottom,this.closeDiv){var n=parseInt(this.closeDiv.style.width);i+=n+t.right}this.size.w+=i,this.size.h+=a,"msie"==OpenLayers.BROWSER_NAME&&(this.contentSize.w+=t.left+t.right,this.contentSize.h+=t.bottom+t.top),null!=this.div&&(this.div.style.width=this.size.w+"px",this.div.style.height=this.size.h+"px"),null!=this.contentDiv&&(this.contentDiv.style.width=e.w+"px",this.contentDiv.style.height=e.h+"px")},updateSize:function(){var e="<div class='"+this.contentDisplayClass+"'>"+this.contentDiv.innerHTML+"</div>",t=this.map?this.map.div:document.body,i=OpenLayers.Util.getRenderedDimensions(e,null,{displayClass:this.displayClass,containerElement:t}),a=this.getSafeContentSize(i),n=null;if(a.equals(i))n=i;else{var s={w:a.w<i.w?a.w:null,h:a.h<i.h?a.h:null};if(s.w&&s.h)n=a;else{var r=OpenLayers.Util.getRenderedDimensions(e,s,{displayClass:this.contentDisplayClass,containerElement:t}),o=OpenLayers.Element.getStyle(this.contentDiv,"overflow");if("hidden"!=o&&r.equals(a)){var l=OpenLayers.Util.getScrollbarWidth();s.w?r.h+=l:r.w+=l}n=this.getSafeContentSize(r)}}this.setSize(n)},setBackgroundColor:function(e){void 0!=e&&(this.backgroundColor=e),null!=this.div&&(this.div.style.backgroundColor=this.backgroundColor)},setOpacity:function(e){void 0!=e&&(this.opacity=e),null!=this.div&&(this.div.style.opacity=this.opacity,this.div.style.filter="alpha(opacity="+100*this.opacity+")")},setBorder:function(e){void 0!=e&&(this.border=e),null!=this.div&&(this.div.style.border=this.border)},setContentHTML:function(e){null!=e&&(this.contentHTML=e),null!=this.contentDiv&&null!=this.contentHTML&&this.contentHTML!=this.contentDiv.innerHTML&&(this.contentDiv.innerHTML=this.contentHTML,this.autoSize&&(this.registerImageListeners(),this.updateSize()))},registerImageListeners:function(){for(var e=function(){null!==this.popup.id&&(this.popup.updateSize(),this.popup.visible()&&this.popup.panMapIfOutOfView&&this.popup.panIntoView(),OpenLayers.Event.stopObserving(this.img,"load",this.img._onImageLoad))},t=this.contentDiv.getElementsByTagName("img"),i=0,a=t.length;a>i;i++){var n=t[i];if(0==n.width||0==n.height){var s={popup:this,img:n};n._onImgLoad=OpenLayers.Function.bind(e,s),OpenLayers.Event.observe(n,"load",n._onImgLoad)}}},getSafeContentSize:function(e){var t=e.clone(),i=this.getContentDivPadding(),a=i.left+i.right,n=i.top+i.bottom;if(this.fixPadding(),a+=this.padding.left+this.padding.right,n+=this.padding.top+this.padding.bottom,this.closeDiv){var s=parseInt(this.closeDiv.style.width);a+=s+i.right}if(this.minSize&&(t.w=Math.max(t.w,this.minSize.w-a),t.h=Math.max(t.h,this.minSize.h-n)),this.maxSize&&(t.w=Math.min(t.w,this.maxSize.w-a),t.h=Math.min(t.h,this.maxSize.h-n)),this.map&&this.map.size){var r=0,o=0;if(this.keepInMap&&!this.panMapIfOutOfView){var l=this.map.getPixelFromLonLat(this.lonlat);switch(this.relativePosition){case"tr":r=l.x,o=this.map.size.h-l.y;break;case"tl":r=this.map.size.w-l.x,o=this.map.size.h-l.y;break;case"bl":r=this.map.size.w-l.x,o=l.y;break;case"br":r=l.x,o=l.y;break;default:r=l.x,o=this.map.size.h-l.y}}var u=this.map.size.h-this.map.paddingForPopups.top-this.map.paddingForPopups.bottom-n-o,c=this.map.size.w-this.map.paddingForPopups.left-this.map.paddingForPopups.right-a-r;t.w=Math.min(t.w,c),t.h=Math.min(t.h,u)}return t},getContentDivPadding:function(){var e=this._contentDivPadding;return e||(null==this.div.parentNode&&(this.div.style.display="none",document.body.appendChild(this.div)),e=new OpenLayers.Bounds(OpenLayers.Element.getStyle(this.contentDiv,"padding-left"),OpenLayers.Element.getStyle(this.contentDiv,"padding-bottom"),OpenLayers.Element.getStyle(this.contentDiv,"padding-right"),OpenLayers.Element.getStyle(this.contentDiv,"padding-top")),this._contentDivPadding=e,this.div.parentNode==document.body&&(document.body.removeChild(this.div),this.div.style.display="")),e},addCloseBox:function(e){this.closeDiv=OpenLayers.Util.createDiv(this.id+"_close",null,{w:17,h:17}),this.closeDiv.className="olPopupCloseBox";var t=this.getContentDivPadding();this.closeDiv.style.right=t.right+"px",this.closeDiv.style.top=t.top+"px",this.groupDiv.appendChild(this.closeDiv);var i=e||function(e){this.hide(),OpenLayers.Event.stop(e)};OpenLayers.Event.observe(this.closeDiv,"touchend",OpenLayers.Function.bindAsEventListener(i,this)),OpenLayers.Event.observe(this.closeDiv,"click",OpenLayers.Function.bindAsEventListener(i,this))},panIntoView:function(){var e=this.map.getSize(),t=this.map.getViewPortPxFromLayerPx(new OpenLayers.Pixel(parseInt(this.div.style.left),parseInt(this.div.style.top))),i=t.clone();t.x<this.map.paddingForPopups.left?i.x=this.map.paddingForPopups.left:t.x+this.size.w>e.w-this.map.paddingForPopups.right&&(i.x=e.w-this.map.paddingForPopups.right-this.size.w),t.y<this.map.paddingForPopups.top?i.y=this.map.paddingForPopups.top:t.y+this.size.h>e.h-this.map.paddingForPopups.bottom&&(i.y=e.h-this.map.paddingForPopups.bottom-this.size.h);var a=t.x-i.x,n=t.y-i.y;this.map.pan(a,n)},registerEvents:function(){function e(e){OpenLayers.Event.stop(e,!0)}this.events=new OpenLayers.Events(this,this.div,null,!0),this.events.on({mousedown:this.onmousedown,mousemove:this.onmousemove,mouseup:this.onmouseup,click:this.onclick,mouseout:this.onmouseout,dblclick:this.ondblclick,touchstart:e,scope:this})},onmousedown:function(e){this.mousedown=!0,OpenLayers.Event.stop(e,!0)},onmousemove:function(e){this.mousedown&&OpenLayers.Event.stop(e,!0)},onmouseup:function(e){this.mousedown&&(this.mousedown=!1,OpenLayers.Event.stop(e,!0))},onclick:function(e){OpenLayers.Event.stop(e,!0)},onmouseout:function(){this.mousedown=!1},ondblclick:function(e){OpenLayers.Event.stop(e,!0)},CLASS_NAME:"OpenLayers.Popup"}),OpenLayers.Popup.WIDTH=200,OpenLayers.Popup.HEIGHT=200,OpenLayers.Popup.COLOR="white",OpenLayers.Popup.OPACITY=1,OpenLayers.Popup.BORDER="0px",OpenLayers.Tile=OpenLayers.Class({events:null,eventListeners:null,id:null,layer:null,url:null,bounds:null,size:null,position:null,isLoading:!1,initialize:function(e,t,i,a,n,s){this.layer=e,this.position=t.clone(),this.setBounds(i),this.url=a,n&&(this.size=n.clone()),this.id=OpenLayers.Util.createUniqueID("Tile_"),OpenLayers.Util.extend(this,s),this.events=new OpenLayers.Events(this),this.eventListeners instanceof Object&&this.events.on(this.eventListeners)},unload:function(){this.isLoading&&(this.isLoading=!1,this.events.triggerEvent("unload"))},destroy:function(){this.layer=null,this.bounds=null,this.size=null,this.position=null,this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy(),this.eventListeners=null,this.events=null},draw:function(e){e||this.clear();var t=this.shouldDraw();return t&&!e&&(t=this.events.triggerEvent("beforedraw")!==!1),t},shouldDraw:function(){var e=!1,t=this.layer.maxExtent;if(t){var i=this.layer.map,a=i.baseLayer.wrapDateLine&&i.getMaxExtent();
this.bounds.intersectsBounds(t,{inclusive:!1,worldBounds:a})&&(e=!0)}return e||this.layer.displayOutsideMaxExtent},setBounds:function(e){if(e=e.clone(),this.layer.map.baseLayer.wrapDateLine){var t=this.layer.map.getMaxExtent(),i=this.layer.map.getResolution();e=e.wrapDateLine(t,{leftTolerance:i,rightTolerance:i})}this.bounds=e},moveTo:function(e,t,i){null==i&&(i=!0),this.setBounds(e),this.position=t.clone(),i&&this.draw()},clear:function(){},CLASS_NAME:"OpenLayers.Tile"}),OpenLayers.Tile.Image=OpenLayers.Class(OpenLayers.Tile,{url:null,imgDiv:null,frame:null,imageReloadAttempts:null,layerAlphaHack:null,asyncRequestId:null,blankImageUrl:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7",maxGetUrlLength:null,canvasContext:null,crossOriginKeyword:null,initialize:function(e,t,i,a){OpenLayers.Tile.prototype.initialize.apply(this,arguments),this.url=a,this.layerAlphaHack=this.layer.alpha&&OpenLayers.Util.alphaHack(),(null!=this.maxGetUrlLength||this.layer.gutter||this.layerAlphaHack)&&(this.frame=document.createElement("div"),this.frame.style.position="absolute",this.frame.style.overflow="hidden"),null!=this.maxGetUrlLength&&OpenLayers.Util.extend(this,OpenLayers.Tile.Image.IFrame)},destroy:function(){this.imgDiv&&(this.clear(),this.imgDiv=null,this.frame=null),this.asyncRequestId=null,OpenLayers.Tile.prototype.destroy.apply(this,arguments)},draw:function(){var e=OpenLayers.Tile.prototype.draw.apply(this,arguments);return e?(this.layer!=this.layer.map.baseLayer&&this.layer.reproject&&(this.bounds=this.getBoundsFromBaseLayer(this.position)),this.isLoading?this._loadEvent="reload":(this.isLoading=!0,this._loadEvent="loadstart"),this.positionTile(),this.renderTile()):this.unload(),e},renderTile:function(){if(this.layer.div.appendChild(this.getTile()),this.layer.async){var e=this.asyncRequestId=(this.asyncRequestId||0)+1;this.layer.getURLasync(this.bounds,function(t){e==this.asyncRequestId&&(this.url=t,this.initImage())},this)}else this.url=this.layer.getURL(this.bounds),this.initImage()},positionTile:function(){var e=this.getTile().style,t=this.frame?this.size:this.layer.getImageSize(this.bounds);e.left=this.position.x+"%",e.top=this.position.y+"%",e.width=t.w+"%",e.height=t.h+"%"},clear:function(){OpenLayers.Tile.prototype.clear.apply(this,arguments);var e=this.imgDiv;if(e){OpenLayers.Event.stopObservingElement(e);var t=this.getTile();t.parentNode===this.layer.div&&this.layer.div.removeChild(t),this.setImgSrc(),this.layerAlphaHack===!0&&(e.style.filter=""),OpenLayers.Element.removeClass(e,"olImageLoadError")}this.canvasContext=null},getImage:function(){if(!this.imgDiv){this.imgDiv=document.createElement("img"),this.imgDiv.className="olTileImage",this.imgDiv.galleryImg="no";var e=this.imgDiv.style;if(this.frame){var t=0,i=0;this.layer.gutter&&(t=100*(this.layer.gutter/this.layer.tileSize.w),i=100*(this.layer.gutter/this.layer.tileSize.h)),e.left=-t+"%",e.top=-i+"%",e.width=2*t+100+"%",e.height=2*i+100+"%"}e.visibility="hidden",e.opacity=0,this.layer.opacity<1&&(e.filter="alpha(opacity="+100*this.layer.opacity+")"),e.position="absolute",this.layerAlphaHack&&(e.paddingTop=e.height,e.height="0",e.width="100%"),this.frame&&this.frame.appendChild(this.imgDiv)}return this.imgDiv},initImage:function(){this.events.triggerEvent(this._loadEvent);var e=this.getImage();if(this.url&&e.getAttribute("src")==this.url)this.onImageLoad();else{var t=OpenLayers.Function.bind(function(){OpenLayers.Event.stopObservingElement(e),OpenLayers.Event.observe(e,"load",OpenLayers.Function.bind(this.onImageLoad,this)),OpenLayers.Event.observe(e,"error",OpenLayers.Function.bind(this.onImageError,this)),this.imageReloadAttempts=0,this.setImgSrc(this.url)},this);e.getAttribute("src")==this.blankImageUrl?t():(OpenLayers.Event.observe(e,"load",t),OpenLayers.Event.observe(e,"error",t),this.crossOriginKeyword&&e.removeAttribute("crossorigin"),e.src=this.blankImageUrl)}},setImgSrc:function(e){var t=this.imgDiv;t.style.visibility="hidden",t.style.opacity=0,e&&(this.crossOriginKeyword&&("data:"!==e.substr(0,5)?t.setAttribute("crossorigin",this.crossOriginKeyword):t.removeAttribute("crossorigin")),t.src=e)},getTile:function(){return this.frame?this.frame:this.getImage()},createBackBuffer:function(){if(this.imgDiv&&!this.isLoading){var e;return this.frame?(e=this.frame.cloneNode(!1),e.appendChild(this.imgDiv)):e=this.imgDiv,this.imgDiv=null,e}},onImageLoad:function(){var e=this.imgDiv;if(OpenLayers.Event.stopObservingElement(e),e.style.visibility="inherit",e.style.opacity=this.layer.opacity,this.isLoading=!1,this.canvasContext=null,this.events.triggerEvent("loadend"),parseFloat(navigator.appVersion.split("MSIE")[1])<7&&this.layer&&this.layer.div){var t=document.createElement("span");t.style.display="none";var i=this.layer.div;i.appendChild(t),window.setTimeout(function(){t.parentNode===i&&t.parentNode.removeChild(t)},0)}this.layerAlphaHack===!0&&(e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+e.src+"', sizingMethod='scale')")},onImageError:function(){var e=this.imgDiv;null!=e.src&&(this.imageReloadAttempts++,this.imageReloadAttempts<=OpenLayers.IMAGE_RELOAD_ATTEMPTS?this.setImgSrc(this.layer.getURL(this.bounds)):(OpenLayers.Element.addClass(e,"olImageLoadError"),this.events.triggerEvent("loaderror"),this.onImageLoad()))},getCanvasContext:function(){if(OpenLayers.CANVAS_SUPPORTED&&this.imgDiv&&!this.isLoading){if(!this.canvasContext){var e=document.createElement("canvas");e.width=this.size.w,e.height=this.size.h,this.canvasContext=e.getContext("2d"),this.canvasContext.drawImage(this.imgDiv,0,0)}return this.canvasContext}},CLASS_NAME:"OpenLayers.Tile.Image"}),OpenLayers.Layer.Image=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!0,url:null,extent:null,size:null,tile:null,aspectRatio:null,initialize:function(e,t,i,a,n){this.url=t,this.extent=i,this.maxExtent=i,this.size=a,OpenLayers.Layer.prototype.initialize.apply(this,[e,n]),this.aspectRatio=this.extent.getHeight()/this.size.h/(this.extent.getWidth()/this.size.w)},destroy:function(){this.tile&&(this.removeTileMonitoringHooks(this.tile),this.tile.destroy(),this.tile=null),OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.Image(this.name,this.url,this.extent,this.size,this.getOptions())),e=OpenLayers.Layer.prototype.clone.apply(this,[e])},setMap:function(){null==this.options.maxResolution&&(this.options.maxResolution=this.aspectRatio*this.extent.getWidth()/this.size.w),OpenLayers.Layer.prototype.setMap.apply(this,arguments)},moveTo:function(e,t){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var i=null==this.tile;if(t||i){this.setTileSize();var a=this.map.getLayerPxFromLonLat({lon:this.extent.left,lat:this.extent.top});i?(this.tile=new OpenLayers.Tile.Image(this,a,this.extent,null,this.tileSize),this.addTileMonitoringHooks(this.tile)):(this.tile.size=this.tileSize.clone(),this.tile.position=a.clone()),this.tile.draw()}},setTileSize:function(){var e=this.extent.getWidth()/this.map.getResolution(),t=this.extent.getHeight()/this.map.getResolution();this.tileSize=new OpenLayers.Size(e,t)},addTileMonitoringHooks:function(e){e.onLoadStart=function(){this.events.triggerEvent("loadstart")},e.events.register("loadstart",this,e.onLoadStart),e.onLoadEnd=function(){this.events.triggerEvent("loadend")},e.events.register("loadend",this,e.onLoadEnd),e.events.register("unload",this,e.onLoadEnd)},removeTileMonitoringHooks:function(e){e.unload(),e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,scope:this})},setUrl:function(e){this.url=e,this.tile.draw()},getURL:function(){return this.url},CLASS_NAME:"OpenLayers.Layer.Image"}),OpenLayers.Layer.HTTPRequest=OpenLayers.Class(OpenLayers.Layer,{URL_HASH_FACTOR:(Math.sqrt(5)-1)/2,url:null,params:null,reproject:!1,initialize:function(e,t,i,a){OpenLayers.Layer.prototype.initialize.apply(this,[e,a]),this.url=t,this.params||(this.params=OpenLayers.Util.extend({},i))},destroy:function(){this.url=null,this.params=null,OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.HTTPRequest(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.prototype.clone.apply(this,[e])},setUrl:function(e){this.url=e},mergeNewParams:function(e){this.params=OpenLayers.Util.extend(this.params,e);var t=this.redraw();return null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"params"}),t},redraw:function(e){return e?this.mergeNewParams({_olSalt:Math.random()}):OpenLayers.Layer.prototype.redraw.apply(this,[])},selectUrl:function(e,t){for(var i=1,a=0,n=e.length;n>a;a++)i*=e.charCodeAt(a)*this.URL_HASH_FACTOR,i-=Math.floor(i);return t[Math.floor(i*t.length)]},getFullRequestString:function(e,t){var i=t||this.url,a=OpenLayers.Util.extend({},this.params);a=OpenLayers.Util.extend(a,e);var n=OpenLayers.Util.getParameterString(a);OpenLayers.Util.isArray(i)&&(i=this.selectUrl(n,i));var s=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(i));for(var r in a)r.toUpperCase()in s&&delete a[r];return n=OpenLayers.Util.getParameterString(a),OpenLayers.Util.urlAppend(i,n)},CLASS_NAME:"OpenLayers.Layer.HTTPRequest"}),OpenLayers.Layer.Grid=OpenLayers.Class(OpenLayers.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,tileClass:OpenLayers.Tile.Image,grid:null,singleTile:!1,ratio:1.5,buffer:0,transitionEffect:null,numLoadingTiles:0,tileLoadingDelay:85,serverResolutions:null,moveTimerId:null,deferMoveGriddedTiles:null,tileQueueId:null,tileQueue:null,loading:!1,backBuffer:null,gridResolution:null,backBufferResolution:null,backBufferLonLat:null,backBufferTimerId:null,removeBackBufferDelay:null,className:null,initialize:function(){OpenLayers.Layer.HTTPRequest.prototype.initialize.apply(this,arguments),this.grid=[],this.tileQueue=[],null===this.removeBackBufferDelay&&(this.removeBackBufferDelay=this.singleTile?0:2500),null===this.className&&(this.className=this.singleTile?"olLayerGridSingleTile":"olLayerGrid"),OpenLayers.Animation.isNative||(this.deferMoveGriddedTiles=OpenLayers.Function.bind(function(){this.moveGriddedTiles(!0),this.moveTimerId=null},this))},setMap:function(e){OpenLayers.Layer.HTTPRequest.prototype.setMap.call(this,e),OpenLayers.Element.addClass(this.div,this.className)},removeMap:function(){null!==this.moveTimerId&&(window.clearTimeout(this.moveTimerId),this.moveTimerId=null),this.clearTileQueue(),null!==this.backBufferTimerId&&(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null)},destroy:function(){this.removeBackBuffer(),this.clearGrid(),this.grid=null,this.tileSize=null,OpenLayers.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.clearTileQueue(),this.grid){for(var e=0,t=this.grid.length;t>e;e++)for(var i=this.grid[e],a=0,n=i.length;n>a;a++){var s=i[a];this.destroyTile(s)}this.grid=[],this.gridResolution=null}},clone:function(e){return null==e&&(e=new OpenLayers.Layer.Grid(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[e]),null!=this.tileSize&&(e.tileSize=this.tileSize.clone()),e.grid=[],e.gridResolution=null,e.backBuffer=null,e.backBufferTimerId=null,e.tileQueue=[],e.tileQueueId=null,e.loading=!1,e.moveTimerId=null,e},moveTo:function(e,t,i){if(OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments),e=e||this.map.getExtent(),null!=e){var a=!this.grid.length||t,n=this.getTilesBounds(),s=this.map.getResolution(),r=this.getServerResolution(s);if(this.singleTile)(a||!i&&!n.containsBounds(e))&&(t&&"resize"!==this.transitionEffect&&this.removeBackBuffer(),t&&"resize"!==this.transitionEffect||this.applyBackBuffer(r),this.initSingleTile(e));else{if(a=a||!n.intersectsBounds(e,{worldBounds:this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent()}),s!==r){if(e=this.map.calculateBounds(null,r),a){var o=r/s;this.transformDiv(o)}}else this.div.style.width="100%",this.div.style.height="100%",this.div.style.left="0%",this.div.style.top="0%";a?(t&&"resize"===this.transitionEffect&&this.applyBackBuffer(r),this.initGriddedTiles(e)):this.moveGriddedTiles()}}},getTileData:function(e){var t=null,i=e.lon,a=e.lat,n=this.grid.length;if(this.map&&n){var s=this.map.getResolution(),r=this.tileSize.w,o=this.tileSize.h,l=this.grid[0][0].bounds,u=l.left,c=l.top;if(u>i&&this.map.baseLayer.wrapDateLine){var h=this.map.getMaxExtent().getWidth(),d=Math.ceil((u-i)/h);i+=h*d}var p=(i-u)/(s*r),f=(c-a)/(s*o),m=Math.floor(p),g=Math.floor(f);if(g>=0&&n>g){var y=this.grid[g][m];y&&(t={tile:y,i:Math.floor((p-m)*r),j:Math.floor((f-g)*o)})}}return t},queueTileDraw:function(e){var t=e.object;return~OpenLayers.Util.indexOf(this.tileQueue,t)||this.tileQueue.push(t),this.tileQueueId||(this.tileQueueId=OpenLayers.Animation.start(OpenLayers.Function.bind(this.drawTileFromQueue,this),null,this.div)),!1},drawTileFromQueue:function(){0===this.tileQueue.length?this.clearTileQueue():this.tileQueue.shift().draw(!0)},clearTileQueue:function(){OpenLayers.Animation.stop(this.tileQueueId),this.tileQueueId=null,this.tileQueue=[]},destroyTile:function(e){this.removeTileMonitoringHooks(e),e.destroy()},getServerResolution:function(e){if(e=e||this.map.getResolution(),this.serverResolutions&&-1===OpenLayers.Util.indexOf(this.serverResolutions,e)){var t,i;for(t=this.serverResolutions.length-1;t>=0;t--)if(i=this.serverResolutions[t],i>e){e=i;break}if(-1===t)throw"no appropriate resolution in serverResolutions"}return e},getServerZoom:function(){var e=this.getServerResolution();return this.serverResolutions?OpenLayers.Util.indexOf(this.serverResolutions,e):this.map.getZoomForResolution(e)+(this.zoomOffset||0)},transformDiv:function(e){this.div.style.width=100*e+"%",this.div.style.height=100*e+"%";var t=this.map.getSize(),i=parseInt(this.map.layerContainerDiv.style.left,10),a=parseInt(this.map.layerContainerDiv.style.top,10),n=(i-t.w/2)*(e-1),s=(a-t.h/2)*(e-1);this.div.style.left=n+"%",this.div.style.top=s+"%"},getResolutionScale:function(){return parseInt(this.div.style.width,10)/100},applyBackBuffer:function(e){null!==this.backBufferTimerId&&this.removeBackBuffer();var t=this.backBuffer;if(!t){if(t=this.createBackBuffer(),!t)return;this.div.insertBefore(t,this.div.firstChild),this.backBuffer=t;var i=this.grid[0][0].bounds;this.backBufferLonLat={lon:i.left,lat:i.top},this.backBufferResolution=this.gridResolution}var a=t.style,n=this.backBufferResolution/e;a.width=100*n+"%",a.height=100*n+"%";var s=this.getViewPortPxFromLonLat(this.backBufferLonLat,e),r=parseInt(this.map.layerContainerDiv.style.left,10),o=parseInt(this.map.layerContainerDiv.style.top,10);t.style.left=Math.round(s.x-r)+"%",t.style.top=Math.round(s.y-o)+"%"},createBackBuffer:function(){var e;if(this.grid.length>0){e=document.createElement("div"),e.id=this.div.id+"_bb",e.className="olBackBuffer",e.style.position="absolute",e.style.width="100%",e.style.height="100%";for(var t=0,i=this.grid.length;i>t;t++)for(var a=0,n=this.grid[t].length;n>a;a++){var s=this.grid[t][a].createBackBuffer();s&&(s.style.top=t*this.tileSize.h+"%",s.style.left=a*this.tileSize.w+"%",e.appendChild(s))}}return e},removeBackBuffer:function(){this.backBuffer&&(this.div.removeChild(this.backBuffer),this.backBuffer=null,this.backBufferResolution=null,null!==this.backBufferTimerId&&(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null))},moveByPx:function(){this.singleTile||this.moveGriddedTiles()},setTileSize:function(e){this.singleTile&&(e=this.map.getSize(),e.h=parseInt(e.h*this.ratio),e.w=parseInt(e.w*this.ratio)),OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this,[e])},getTilesBounds:function(){var e=null,t=this.grid.length;if(t){var i=this.grid[t-1][0].bounds,a=this.grid[0].length*i.getWidth(),n=this.grid.length*i.getHeight();e=new OpenLayers.Bounds(i.left,i.bottom,i.left+a,i.bottom+n)}return e},initSingleTile:function(e){this.clearTileQueue();var t=e.getCenterLonLat(),i=e.getWidth()*this.ratio,a=e.getHeight()*this.ratio,n=new OpenLayers.Bounds(t.lon-i/2,t.lat-a/2,t.lon+i/2,t.lat+a/2),s=this.map.getLayerPxFromLonLat({lon:n.left,lat:n.top});this.grid.length||(this.grid[0]=[]);var r=this.grid[0][0];r?r.moveTo(n,s):(r=this.addTile(n,s),this.addTileMonitoringHooks(r),r.draw(),this.grid[0][0]=r),this.removeExcessTiles(1,1),this.gridResolution=this.getServerResolution()},calculateGridLayout:function(e,t,i){var a=i*this.tileSize.w,n=i*this.tileSize.h,s=e.left-t.lon,r=Math.floor(s/a)-this.buffer,o=s/a-r,l=-o*this.tileSize.w,u=t.lon+r*a,c=e.top-(t.lat+n),h=Math.ceil(c/n)+this.buffer,d=h-c/n,p=-d*this.tileSize.h,f=t.lat+h*n;return{tilelon:a,tilelat:n,tileoffsetlon:u,tileoffsetlat:f,tileoffsetx:l,tileoffsety:p}},getTileOrigin:function(){var e=this.tileOrigin;if(!e){var t=this.getMaxExtent(),i={tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]}[this.tileOriginCorner];e=new OpenLayers.LonLat(t[i[0]],t[i[1]])}return e},initGriddedTiles:function(e){this.clearTileQueue();var t=this.map.getSize(),i=Math.ceil(t.h/this.tileSize.h)+Math.max(1,2*this.buffer),a=Math.ceil(t.w/this.tileSize.w)+Math.max(1,2*this.buffer),n=this.getTileOrigin(),s=this.getServerResolution(),r=this.calculateGridLayout(e,n,s),o=Math.round(r.tileoffsetx),l=Math.round(r.tileoffsety),u=r.tileoffsetlon,c=r.tileoffsetlat,h=r.tilelon,d=r.tilelat,p=o,f=u,m=0,g=parseInt(this.map.layerContainerDiv.style.left),y=parseInt(this.map.layerContainerDiv.style.top),v=[],b=this.map.getCenter();do{var _=this.grid[m++];_||(_=[],this.grid.push(_)),u=f,o=p;var k=0;do{var L=new OpenLayers.Bounds(u,c,u+h,c+d),w=o;w-=g;var O=l;O-=y;var x=new OpenLayers.Pixel(w,O),S=_[k++];S?S.moveTo(L,x,!1):(S=this.addTile(L,x),this.addTileMonitoringHooks(S),_.push(S));var C=L.getCenterLonLat();v.push({tile:S,distance:Math.pow(C.lon-b.lon,2)+Math.pow(C.lat-b.lat,2)}),u+=h,o+=this.tileSize.w}while(u<=e.right+h*this.buffer||a>k);c-=d,l+=this.tileSize.h}while(c>=e.bottom-d*this.buffer||i>m);this.removeExcessTiles(m,k),this.gridResolution=this.getServerResolution(),v.sort(function(e,t){return e.distance-t.distance});for(var M=0,P=v.length;P>M;++M)v[M].tile.draw()},getMaxExtent:function(){return this.maxExtent},addTile:function(e,t){var i=new this.tileClass(this,t,e,null,this.tileSize,this.tileOptions);return i.events.register("beforedraw",this,this.queueTileDraw),i},addTileMonitoringHooks:function(e){e.onLoadStart=function(){this.loading===!1&&(this.loading=!0,this.events.triggerEvent("loadstart")),this.events.triggerEvent("tileloadstart",{tile:e}),this.numLoadingTiles++},e.onLoadEnd=function(){this.numLoadingTiles--,this.events.triggerEvent("tileloaded",{tile:e}),0===this.tileQueue.length&&0===this.numLoadingTiles&&(this.loading=!1,this.events.triggerEvent("loadend"),this.backBuffer&&(this.backBufferTimerId=window.setTimeout(OpenLayers.Function.bind(this.removeBackBuffer,this),this.removeBackBufferDelay)))},e.onLoadError=function(){this.events.triggerEvent("tileerror",{tile:e})},e.events.on({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},removeTileMonitoringHooks:function(e){e.unload(),e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},moveGriddedTiles:function(e){if(!e&&!OpenLayers.Animation.isNative)return null!=this.moveTimerId&&window.clearTimeout(this.moveTimerId),this.moveTimerId=window.setTimeout(this.deferMoveGriddedTiles,this.tileLoadingDelay),void 0;for(var t=this.buffer||1,i=this.getResolutionScale();;){var a={x:this.grid[0][0].position.x*i+parseInt(this.div.style.left,10)+parseInt(this.map.layerContainerDiv.style.left),y:this.grid[0][0].position.y*i+parseInt(this.div.style.top,10)+parseInt(this.map.layerContainerDiv.style.top)},n={w:this.tileSize.w*i,h:this.tileSize.h*i};if(a.x>-n.w*(t-1))this.shiftColumn(!0);else if(a.x<-n.w*t)this.shiftColumn(!1);else if(a.y>-n.h*(t-1))this.shiftRow(!0);else{if(!(a.y<-n.h*t))break;this.shiftRow(!1)}}},shiftRow:function(e){for(var t=e?0:this.grid.length-1,i=this.grid,a=i[t],n=this.getServerResolution(),s=e?-this.tileSize.h:this.tileSize.h,r=n*-s,o=e?i.pop():i.shift(),l=0,u=a.length;u>l;l++){var c=a[l],h=c.bounds.clone(),d=c.position.clone();h.bottom=h.bottom+r,h.top=h.top+r,d.y=d.y+s,o[l].moveTo(h,d)}e?i.unshift(o):i.push(o)},shiftColumn:function(e){for(var t=e?-this.tileSize.w:this.tileSize.w,i=this.getServerResolution(),a=i*t,n=0,s=this.grid.length;s>n;n++){var r=this.grid[n],o=e?0:r.length-1,l=r[o],u=l.bounds.clone(),c=l.position.clone();u.left=u.left+a,u.right=u.right+a,c.x=c.x+t;var h=e?this.grid[n].pop():this.grid[n].shift();h.moveTo(u,c),e?r.unshift(h):r.push(h)}},removeExcessTiles:function(e,t){for(var i,a;this.grid.length>e;){var n=this.grid.pop();for(i=0,a=n.length;a>i;i++){var s=n[i];this.destroyTile(s)}}for(i=0,a=this.grid.length;a>i;i++)for(;this.grid[i].length>t;){var n=this.grid[i],s=n.pop();this.destroyTile(s)}},onMapResize:function(){this.singleTile&&(this.clearGrid(),this.setTileSize())},getTileBounds:function(e){var t=this.maxExtent,i=this.getResolution(),a=i*this.tileSize.w,n=i*this.tileSize.h,s=this.getLonLatFromViewPortPx(e),r=t.left+a*Math.floor((s.lon-t.left)/a),o=t.bottom+n*Math.floor((s.lat-t.bottom)/n);return new OpenLayers.Bounds(r,o,r+a,o+n)},CLASS_NAME:"OpenLayers.Layer.Grid"}),OpenLayers.Layer.Markers=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,markers:null,drawn:!1,initialize:function(){OpenLayers.Layer.prototype.initialize.apply(this,arguments),this.markers=[]},destroy:function(){this.clearMarkers(),this.markers=null,OpenLayers.Layer.prototype.destroy.apply(this,arguments)},setOpacity:function(e){if(e!=this.opacity){this.opacity=e;for(var t=0,i=this.markers.length;i>t;t++)this.markers[t].setOpacity(this.opacity)}},moveTo:function(e,t){if(OpenLayers.Layer.prototype.moveTo.apply(this,arguments),t||!this.drawn){for(var i=0,a=this.markers.length;a>i;i++)this.drawMarker(this.markers[i]);this.drawn=!0}},addMarker:function(e){this.markers.push(e),this.opacity<1&&e.setOpacity(this.opacity),this.map&&this.map.getExtent()&&(e.map=this.map,this.drawMarker(e))},removeMarker:function(e){this.markers&&this.markers.length&&(OpenLayers.Util.removeItem(this.markers,e),e.erase())},clearMarkers:function(){if(null!=this.markers)for(;this.markers.length>0;)this.removeMarker(this.markers[0])},drawMarker:function(e){var t=this.map.getLayerPxFromLonLat(e.lonlat);if(null==t)e.display(!1);else if(e.isDrawn())e.icon&&e.icon.moveTo(t);else{var i=e.draw(t);this.div.appendChild(i)}},getDataExtent:function(){var e=null;if(this.markers&&this.markers.length>0)for(var e=new OpenLayers.Bounds,t=0,i=this.markers.length;i>t;t++){var a=this.markers[t];e.extend(a.lonlat)}return e},CLASS_NAME:"OpenLayers.Layer.Markers"}),OpenLayers.Layer.WMS=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{service:"WMS",version:"1.1.1",request:"GetMap",styles:"",format:"image/jpeg"},isBaseLayer:!0,encodeBBOX:!1,noMagic:!1,yx:{},initialize:function(e,t,i,a){var n=[];i=OpenLayers.Util.upperCaseObject(i),parseFloat(i.VERSION)>=1.3&&!i.EXCEPTIONS&&(i.EXCEPTIONS="INIMAGE"),n.push(e,t,i,a),OpenLayers.Layer.Grid.prototype.initialize.apply(this,n),OpenLayers.Util.applyDefaults(this.params,OpenLayers.Util.upperCaseObject(this.DEFAULT_PARAMS)),!this.noMagic&&this.params.TRANSPARENT&&"true"==this.params.TRANSPARENT.toString().toLowerCase()&&(null!=a&&a.isBaseLayer||(this.isBaseLayer=!1),"image/jpeg"==this.params.FORMAT&&(this.params.FORMAT=OpenLayers.Util.alphaHack()?"image/gif":"image/png"))},clone:function(e){return null==e&&(e=new OpenLayers.Layer.WMS(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},reverseAxisOrder:function(){var e=this.projection.getCode();return parseFloat(this.params.VERSION)>=1.3&&!(!this.yx[e]&&!OpenLayers.Projection.defaults[e].yx)},getURL:function(e){e=this.adjustBounds(e);var t=this.getImageSize(),i={},a=this.reverseAxisOrder();i.BBOX=this.encodeBBOX?e.toBBOX(null,a):e.toArray(a),i.WIDTH=t.w,i.HEIGHT=t.h;var n=this.getFullRequestString(i);return n},mergeNewParams:function(e){var t=OpenLayers.Util.upperCaseObject(e),i=[t];return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,i)},getFullRequestString:function(e){var t=this.map.getProjectionObject(),i=this.projection&&this.projection.equals(t)?this.projection.getCode():t.getCode(),a="none"==i?null:i;return parseFloat(this.params.VERSION)>=1.3?this.params.CRS=a:this.params.SRS=a,"boolean"==typeof this.params.TRANSPARENT&&(e.TRANSPARENT=this.params.TRANSPARENT?"TRUE":"FALSE"),OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,arguments)},CLASS_NAME:"OpenLayers.Layer.WMS"}),OpenLayers.Layer.WMTS=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,serverResolutions:null,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(e){var t={url:!0,layer:!0,style:!0,matrixSet:!0};for(var i in t)if(!(i in e))throw new Error("Missing property '"+i+"' in layer configuration.");e.params=OpenLayers.Util.upperCaseObject(e.params);var a=[e.name,e.url,e.params,e];if(OpenLayers.Layer.Grid.prototype.initialize.apply(this,a),this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop()),this.matrixIds){var n=this.matrixIds.length;if(n&&"string"==typeof this.matrixIds[0]){var s=this.matrixIds;this.matrixIds=new Array(n);for(var r=0;n>r;++r)this.matrixIds[r]={identifier:s[r]}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.updateMatrixProperties()},updateMatrixProperties:function(){this.matrix=this.getMatrix(),this.matrix&&(this.matrix.topLeftCorner&&(this.tileOrigin=this.matrix.topLeftCorner),this.matrix.tileWidth&&this.matrix.tileHeight&&(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)),this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)),this.tileFullExtent||(this.tileFullExtent=this.maxExtent))},moveTo:function(e,t){return(t||!this.matrix)&&this.updateMatrixProperties(),OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.WMTS(this.options)),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},getIdentifier:function(){return this.getServerZoom()},getMatrix:function(){var e;if(this.matrixIds&&0!==this.matrixIds.length)if("scaleDenominator"in this.matrixIds[0])for(var t,i=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.getServerResolution()/28e-5,a=Number.POSITIVE_INFINITY,n=0,s=this.matrixIds.length;s>n;++n)t=Math.abs(1-this.matrixIds[n].scaleDenominator/i),a>t&&(a=t,e=this.matrixIds[n]);else e=this.matrixIds[this.getIdentifier()];else e={identifier:this.getIdentifier()};return e},getTileInfo:function(e){var t=this.getServerResolution(),i=(e.lon-this.tileOrigin.lon)/(t*this.tileSize.w),a=(this.tileOrigin.lat-e.lat)/(t*this.tileSize.h),n=Math.floor(i),s=Math.floor(a);return{col:n,row:s,i:Math.floor((i-n)*this.tileSize.w),j:Math.floor((a-s)*this.tileSize.h)}},getURL:function(e){e=this.adjustBounds(e);var t="";if(!this.tileFullExtent||this.tileFullExtent.intersectsBounds(e)){var i=e.getCenterLonLat(),a=this.getTileInfo(i);this.matrix.identifier;var n,s=this.dimensions;if("REST"===this.requestEncoding.toUpperCase())if(n=this.params,"string"==typeof this.url&&-1!==this.url.indexOf("{")){var r=this.url.replace(/\{/g,"${"),o={style:this.style,Style:this.style,TileMatrixSet:this.matrixSet,TileMatrix:this.matrix.identifier,TileRow:a.row,TileCol:a.col};if(s){var l,u;for(u=s.length-1;u>=0;--u)l=s[u],o[l]=n[l.toUpperCase()]}t=OpenLayers.String.format(r,o)}else{var c=this.version+"/"+this.layer+"/"+this.style+"/";if(s)for(var u=0;u<s.length;u++)n[s[u]]&&(c=c+n[s[u]]+"/");c=c+this.matrixSet+"/"+this.matrix.identifier+"/"+a.row+"/"+a.col+"."+this.formatSuffix,t=OpenLayers.Util.isArray(this.url)?this.selectUrl(c,this.url):this.url,t.match(/\/$/)||(t+="/"),t+=c}else"KVP"===this.requestEncoding.toUpperCase()&&(n={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:a.row,TILECOL:a.col,FORMAT:this.format},t=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[n]))}return t},mergeNewParams:function(e){return"KVP"===this.requestEncoding.toUpperCase()?OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(e)]):void 0},CLASS_NAME:"OpenLayers.Layer.WMTS"}),OpenLayers.Feature=OpenLayers.Class({layer:null,id:null,lonlat:null,data:null,marker:null,popupClass:null,popup:null,initialize:function(e,t,i){this.layer=e,this.lonlat=t,this.data=null!=i?i:{},this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){null!=this.layer&&null!=this.layer.map&&null!=this.popup&&this.layer.map.removePopup(this.popup),null!=this.layer&&null!=this.marker&&this.layer.removeMarker(this.marker),this.layer=null,this.id=null,this.lonlat=null,this.data=null,null!=this.marker&&(this.destroyMarker(this.marker),this.marker=null),null!=this.popup&&(this.destroyPopup(this.popup),this.popup=null)},onScreen:function(){var e=!1;if(null!=this.layer&&null!=this.layer.map){var t=this.layer.map.getExtent();e=t.containsLonLat(this.lonlat)}return e},createMarker:function(){return null!=this.lonlat&&(this.marker=new OpenLayers.Marker(this.lonlat,this.data.icon)),this.marker},destroyMarker:function(){this.marker.destroy()},createPopup:function(e){if(null!=this.lonlat){if(!this.popup){var t=this.marker?this.marker.icon:null,i=this.popupClass?this.popupClass:OpenLayers.Popup.Anchored;this.popup=new i(this.id+"_popup",this.lonlat,this.data.popupSize,this.data.popupContentHTML,t,e)}null!=this.data.overflow&&(this.popup.contentDiv.style.overflow=this.data.overflow),this.popup.feature=this}return this.popup},destroyPopup:function(){this.popup&&(this.popup.feature=null,this.popup.destroy(),this.popup=null)},CLASS_NAME:"OpenLayers.Feature"}),OpenLayers.State={UNKNOWN:"Unknown",INSERT:"Insert",UPDATE:"Update",DELETE:"Delete"},OpenLayers.Feature.Vector=OpenLayers.Class(OpenLayers.Feature,{fid:null,geometry:null,attributes:null,bounds:null,state:null,style:null,url:null,renderIntent:"default",modified:null,initialize:function(e,t,i){OpenLayers.Feature.prototype.initialize.apply(this,[null,null,t]),this.lonlat=null,this.geometry=e?e:null,this.state=null,this.attributes={},t&&(this.attributes=OpenLayers.Util.extend(this.attributes,t)),this.style=i?i:null},destroy:function(){this.layer&&(this.layer.removeFeatures(this),this.layer=null),this.geometry=null,this.modified=null,OpenLayers.Feature.prototype.destroy.apply(this,arguments)},clone:function(){return new OpenLayers.Feature.Vector(this.geometry?this.geometry.clone():null,this.attributes,this.style)},onScreen:function(e){var t=!1;if(this.layer&&this.layer.map){var i=this.layer.map.getExtent();if(e){var a=this.geometry.getBounds();t=i.intersectsBounds(a)}else{var n=i.toGeometry();t=n.intersects(this.geometry)}}return t},getVisibility:function(){return!(this.style&&"none"==this.style.display||!this.layer||this.layer&&this.layer.styleMap&&"none"==this.layer.styleMap.createSymbolizer(this,this.renderIntent).display||this.layer&&!this.layer.getVisibility())},createMarker:function(){return null},destroyMarker:function(){},createPopup:function(){return null},atPoint:function(e,t,i){var a=!1;return this.geometry&&(a=this.geometry.atPoint(e,t,i)),a},destroyPopup:function(){},move:function(e){if(!this.layer||!this.geometry.move)return void 0;var t;t="OpenLayers.LonLat"==e.CLASS_NAME?this.layer.getViewPortPxFromLonLat(e):e;
var i=this.layer.getViewPortPxFromLonLat(this.geometry.getBounds().getCenterLonLat()),a=this.layer.map.getResolution();return this.geometry.move(a*(t.x-i.x),a*(i.y-t.y)),this.layer.drawFeature(this),i},toState:function(e){if(e==OpenLayers.State.UPDATE)switch(this.state){case OpenLayers.State.UNKNOWN:case OpenLayers.State.DELETE:this.state=e;break;case OpenLayers.State.UPDATE:case OpenLayers.State.INSERT:}else if(e==OpenLayers.State.INSERT)switch(this.state){case OpenLayers.State.UNKNOWN:break;default:this.state=e}else if(e==OpenLayers.State.DELETE)switch(this.state){case OpenLayers.State.INSERT:break;case OpenLayers.State.DELETE:break;case OpenLayers.State.UNKNOWN:case OpenLayers.State.UPDATE:this.state=e}else e==OpenLayers.State.UNKNOWN&&(this.state=e)},CLASS_NAME:"OpenLayers.Feature.Vector"}),OpenLayers.Feature.Vector.style={"default":{fillColor:"#ee9900",fillOpacity:.4,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},select:{fillColor:"blue",fillOpacity:.4,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"blue",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"pointer",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},temporary:{fillColor:"#66cccc",fillOpacity:.2,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#66cccc",strokeOpacity:1,strokeLinecap:"round",strokeWidth:2,strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},"delete":{display:"none"}},OpenLayers.Handler=OpenLayers.Class({id:null,control:null,map:null,keyMask:null,active:!1,evt:null,initialize:function(e,t,i){OpenLayers.Util.extend(this,i),this.control=e,this.callbacks=t;var a=this.map||e.map;a&&this.setMap(a),this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},setMap:function(e){this.map=e},checkModifiers:function(e){if(null==this.keyMask)return!0;var t=(e.shiftKey?OpenLayers.Handler.MOD_SHIFT:0)|(e.ctrlKey?OpenLayers.Handler.MOD_CTRL:0)|(e.altKey?OpenLayers.Handler.MOD_ALT:0);return t==this.keyMask},activate:function(){if(this.active)return!1;for(var e=OpenLayers.Events.prototype.BROWSER_EVENTS,t=0,i=e.length;i>t;t++)this[e[t]]&&this.register(e[t],this[e[t]]);return this.active=!0,!0},deactivate:function(){if(!this.active)return!1;for(var e=OpenLayers.Events.prototype.BROWSER_EVENTS,t=0,i=e.length;i>t;t++)this[e[t]]&&this.unregister(e[t],this[e[t]]);return this.active=!1,!0},callback:function(e,t){e&&this.callbacks[e]&&this.callbacks[e].apply(this.control,t)},register:function(e,t){this.map.events.registerPriority(e,this,t),this.map.events.registerPriority(e,this,this.setEvent)},unregister:function(e,t){this.map.events.unregister(e,this,t),this.map.events.unregister(e,this,this.setEvent)},setEvent:function(e){return this.evt=e,!0},destroy:function(){this.deactivate(),this.control=this.map=null},CLASS_NAME:"OpenLayers.Handler"}),OpenLayers.Handler.MOD_NONE=0,OpenLayers.Handler.MOD_SHIFT=1,OpenLayers.Handler.MOD_CTRL=2,OpenLayers.Handler.MOD_ALT=4,OpenLayers.Handler.Click=OpenLayers.Class(OpenLayers.Handler,{delay:300,single:!0,"double":!1,pixelTolerance:0,dblclickTolerance:13,stopSingle:!1,stopDouble:!1,timerId:null,touch:!1,down:null,last:null,first:null,rightclickTimerId:null,touchstart:function(e){return this.touch||(this.unregisterMouseListeners(),this.touch=!0),this.down=this.getEventInfo(e),this.last=this.getEventInfo(e),!0},touchmove:function(e){return this.last=this.getEventInfo(e),!0},touchend:function(e){return this.down&&(e.xy=this.last.xy,e.lastTouches=this.last.touches,this.handleSingle(e),this.down=null),!0},unregisterMouseListeners:function(){this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,click:this.click,dblclick:this.dblclick,scope:this})},mousedown:function(e){return this.down=this.getEventInfo(e),this.last=this.getEventInfo(e),!0},mouseup:function(e){var t=!0;return this.checkModifiers(e)&&this.control.handleRightClicks&&OpenLayers.Event.isRightClick(e)&&(t=this.rightclick(e)),t},rightclick:function(e){if(this.passesTolerance(e)){if(null!=this.rightclickTimerId)return this.clearTimer(),this.callback("dblrightclick",[e]),!this.stopDouble;var t=this["double"]?OpenLayers.Util.extend({},e):this.callback("rightclick",[e]),i=OpenLayers.Function.bind(this.delayedRightCall,this,t);this.rightclickTimerId=window.setTimeout(i,this.delay)}return!this.stopSingle},delayedRightCall:function(e){this.rightclickTimerId=null,e&&this.callback("rightclick",[e])},click:function(e){return this.last||(this.last=this.getEventInfo(e)),this.handleSingle(e),!this.stopSingle},dblclick:function(e){return this.handleDouble(e),!this.stopDouble},handleDouble:function(e){this.passesDblclickTolerance(e)&&(this["double"]&&this.callback("dblclick",[e]),this.clearTimer())},handleSingle:function(e){if(this.passesTolerance(e))if(null!=this.timerId)this.last.touches&&1===this.last.touches.length&&(this["double"]&&OpenLayers.Event.stop(e),this.handleDouble(e)),this.last.touches&&2===this.last.touches.length||this.clearTimer();else{this.first=this.getEventInfo(e);var t=this.single?OpenLayers.Util.extend({},e):null;this.queuePotentialClick(t)}},queuePotentialClick:function(e){this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall,this,e),this.delay)},passesTolerance:function(e){var t=!0;if(null!=this.pixelTolerance&&this.down&&this.down.xy&&(t=this.pixelTolerance>=this.down.xy.distanceTo(e.xy),t&&this.touch&&this.down.touches.length===this.last.touches.length))for(var i=0,a=this.down.touches.length;a>i;++i)if(this.getTouchDistance(this.down.touches[i],this.last.touches[i])>this.pixelTolerance){t=!1;break}return t},getTouchDistance:function(e,t){return Math.sqrt(Math.pow(e.clientX-t.clientX,2)+Math.pow(e.clientY-t.clientY,2))},passesDblclickTolerance:function(){var e=!0;return this.down&&this.first&&(e=this.down.xy.distanceTo(this.first.xy)<=this.dblclickTolerance),e},clearTimer:function(){null!=this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null),null!=this.rightclickTimerId&&(window.clearTimeout(this.rightclickTimerId),this.rightclickTimerId=null)},delayedCall:function(e){this.timerId=null,e&&this.callback("click",[e])},getEventInfo:function(e){var t;if(e.touches){var i=e.touches.length;t=new Array(i);for(var a,n=0;i>n;n++)a=e.touches[n],t[n]={clientX:a.clientX,clientY:a.clientY}}return{xy:e.xy,touches:t}},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.clearTimer(),this.down=null,this.first=null,this.last=null,this.touch=!1,e=!0),e},CLASS_NAME:"OpenLayers.Handler.Click"}),OpenLayers.Handler.Hover=OpenLayers.Class(OpenLayers.Handler,{delay:500,pixelTolerance:null,stopMove:!1,px:null,timerId:null,mousemove:function(e){return this.passesTolerance(e.xy)&&(this.clearTimer(),this.callback("move",[e]),this.px=e.xy,e=OpenLayers.Util.extend({},e),this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall,this,e),this.delay)),!this.stopMove},mouseout:function(e){return OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv)&&(this.clearTimer(),this.callback("move",[e])),!0},passesTolerance:function(e){var t=!0;if(this.pixelTolerance&&this.px){var i=Math.sqrt(Math.pow(this.px.x-e.x,2)+Math.pow(this.px.y-e.y,2));i<this.pixelTolerance&&(t=!1)}return t},clearTimer:function(){null!=this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null)},delayedCall:function(e){this.callback("pause",[e])},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.clearTimer(),e=!0),e},CLASS_NAME:"OpenLayers.Handler.Hover"}),OpenLayers.Handler.Point=OpenLayers.Class(OpenLayers.Handler,{point:null,layer:null,multi:!1,citeCompliant:!1,mouseDown:!1,stoppedDown:null,lastDown:null,lastUp:null,persist:!1,stopDown:!1,stopUp:!1,layerOptions:null,pixelTolerance:5,touch:!1,lastTouchPx:null,initialize:function(e,t,i){i&&i.layerOptions&&i.layerOptions.styleMap||(this.style=OpenLayers.Util.extend(OpenLayers.Feature.Vector.style["default"],{})),OpenLayers.Handler.prototype.initialize.apply(this,arguments)},activate:function(){if(!OpenLayers.Handler.prototype.activate.apply(this,arguments))return!1;var e=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions);return this.layer=new OpenLayers.Layer.Vector(this.CLASS_NAME,e),this.map.addLayer(this.layer),!0},createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i),this.callback("create",[this.point.geometry,this.point]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.point],{silent:!0})},deactivate:function(){return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)?(this.cancel(),null!=this.layer.map&&(this.destroyFeature(!0),this.layer.destroy(!1)),this.layer=null,this.touch=!1,!0):!1},destroyFeature:function(e){!this.layer||!e&&this.persist||this.layer.destroyFeatures(),this.point=null},destroyPersistedFeature:function(){var e=this.layer;e&&e.features.length>1&&this.layer.features[0].destroy()},finalize:function(e){var t=e?"cancel":"done";this.mouseDown=!1,this.lastDown=null,this.lastUp=null,this.lastTouchPx=null,this.callback(t,[this.geometryClone()]),this.destroyFeature(e)},cancel:function(){this.finalize(!0)},click:function(e){return OpenLayers.Event.stop(e),!1},dblclick:function(e){return OpenLayers.Event.stop(e),!1},modifyFeature:function(e){this.point||this.createFeature(e);var t=this.layer.getLonLatFromViewPortPx(e);this.point.geometry.x=t.lon,this.point.geometry.y=t.lat,this.callback("modify",[this.point.geometry,this.point,!1]),this.point.geometry.clearBounds(),this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.point,this.style)},getGeometry:function(){var e=this.point&&this.point.geometry;return e&&this.multi&&(e=new OpenLayers.Geometry.MultiPoint([e])),e},geometryClone:function(){var e=this.getGeometry();return e&&e.clone()},mousedown:function(e){return this.down(e)},touchstart:function(e){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,dblclick:this.dblclick,scope:this})),this.lastTouchPx=e.xy,this.down(e)},mousemove:function(e){return this.move(e)},touchmove:function(e){return this.lastTouchPx=e.xy,this.move(e)},mouseup:function(e){return this.up(e)},touchend:function(e){return e.xy=this.lastTouchPx,this.up(e)},down:function(e){return this.mouseDown=!0,this.lastDown=e.xy,this.touch||this.modifyFeature(e.xy),this.stoppedDown=this.stopDown,!this.stopDown},move:function(e){return this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(e.xy),!0},up:function(e){return this.mouseDown=!1,this.stoppedDown=this.stopDown,this.checkModifiers(e)?this.lastUp&&this.lastUp.equals(e.xy)?!0:this.lastDown&&this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)?(this.touch&&this.modifyFeature(e.xy),this.persist&&this.destroyPersistedFeature(),this.lastUp=e.xy,this.finalize(),!this.stopUp):!0:!0},mouseout:function(e){OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv)&&(this.stoppedDown=this.stopDown,this.mouseDown=!1)},passesTolerance:function(e,t,i){var a=!0;if(null!=i&&e&&t){var n=e.distanceTo(t);n>i&&(a=!1)}return a},CLASS_NAME:"OpenLayers.Handler.Point"}),OpenLayers.Handler.Path=OpenLayers.Class(OpenLayers.Handler.Point,{line:null,maxVertices:null,doubleTouchTolerance:20,freehand:!1,freehandToggle:"shiftKey",timerId:null,redoStack:null,createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i),this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([this.point.geometry])),this.callback("create",[this.point.geometry,this.getSketch()]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.line,this.point],{silent:!0})},destroyFeature:function(e){OpenLayers.Handler.Point.prototype.destroyFeature.call(this,e),this.line=null},destroyPersistedFeature:function(){var e=this.layer;e&&e.features.length>2&&this.layer.features[0].destroy()},removePoint:function(){this.point&&this.layer.removeFeatures([this.point])},addPoint:function(e){this.layer.removeFeatures([this.point]);var t=this.layer.getLonLatFromViewPortPx(e);this.point=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(t.lon,t.lat)),this.line.geometry.addComponent(this.point.geometry,this.line.geometry.components.length),this.layer.addFeatures([this.point]),this.callback("point",[this.point.geometry,this.getGeometry()]),this.callback("modify",[this.point.geometry,this.getSketch()]),this.drawFeature(),delete this.redoStack},insertXY:function(e,t){this.line.geometry.addComponent(new OpenLayers.Geometry.Point(e,t),this.getCurrentPointIndex()),this.drawFeature(),delete this.redoStack},insertDeltaXY:function(e,t){var i=this.getCurrentPointIndex()-1,a=this.line.geometry.components[i];!a||isNaN(a.x)||isNaN(a.y)||this.insertXY(a.x+e,a.y+t)},insertDirectionLength:function(e,t){e*=Math.PI/180;var i=t*Math.cos(e),a=t*Math.sin(e);this.insertDeltaXY(i,a)},insertDeflectionLength:function(e,t){var i=this.getCurrentPointIndex()-1;if(i>0){var a=this.line.geometry.components[i],n=this.line.geometry.components[i-1],s=Math.atan2(a.y-n.y,a.x-n.x);this.insertDirectionLength(180*s/Math.PI+e,t)}},getCurrentPointIndex:function(){return this.line.geometry.components.length-1},undo:function(){var e=this.line.geometry,t=e.components,i=this.getCurrentPointIndex()-1,a=t[i],n=e.removeComponent(a);return n&&(this.redoStack||(this.redoStack=[]),this.redoStack.push(a),this.drawFeature()),n},redo:function(){var e=this.redoStack&&this.redoStack.pop();return e&&(this.line.geometry.addComponent(e,this.getCurrentPointIndex()),this.drawFeature()),!!e},freehandMode:function(e){return this.freehandToggle&&e[this.freehandToggle]?!this.freehand:this.freehand},modifyFeature:function(e,t){this.line||this.createFeature(e);var i=this.layer.getLonLatFromViewPortPx(e);this.point.geometry.x=i.lon,this.point.geometry.y=i.lat,this.callback("modify",[this.point.geometry,this.getSketch(),t]),this.point.geometry.clearBounds(),this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.line,this.style),this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.line},getGeometry:function(){var e=this.line&&this.line.geometry;return e&&this.multi&&(e=new OpenLayers.Geometry.MultiLineString([e])),e},touchstart:function(e){return this.timerId&&this.passesTolerance(this.lastTouchPx,e.xy,this.doubleTouchTolerance)?(this.finishGeometry(),window.clearTimeout(this.timerId),this.timerId=null,!1):(this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null),this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){this.timerId=null},this),300),OpenLayers.Handler.Point.prototype.touchstart.call(this,e))},down:function(e){var t=this.stopDown;return this.freehandMode(e)&&(t=!0,this.touch&&(this.modifyFeature(e.xy,!!this.lastUp),OpenLayers.Event.stop(e))),this.touch||this.lastDown&&this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)||this.modifyFeature(e.xy,!!this.lastUp),this.mouseDown=!0,this.lastDown=e.xy,this.stoppedDown=t,!t},move:function(e){return this.stoppedDown&&this.freehandMode(e)?(this.persist&&this.destroyPersistedFeature(),this.maxVertices&&this.line&&this.line.geometry.components.length===this.maxVertices?(this.removePoint(),this.finalize()):this.addPoint(e.xy),!1):(this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(e.xy,!!this.lastUp),!0)},up:function(e){return!this.mouseDown||this.lastUp&&this.lastUp.equals(e.xy)||(this.stoppedDown&&this.freehandMode(e)?(this.persist&&this.destroyPersistedFeature(),this.removePoint(),this.finalize()):this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)&&(this.touch&&this.modifyFeature(e.xy),null==this.lastUp&&this.persist&&this.destroyPersistedFeature(),this.addPoint(e.xy),this.lastUp=e.xy,this.line.geometry.components.length===this.maxVertices+1&&this.finishGeometry())),this.stoppedDown=this.stopDown,this.mouseDown=!1,!this.stopUp},finishGeometry:function(){var e=this.line.geometry.components.length-1;this.line.geometry.removeComponent(this.line.geometry.components[e]),this.removePoint(),this.finalize()},dblclick:function(e){return this.freehandMode(e)||this.finishGeometry(),!1},CLASS_NAME:"OpenLayers.Handler.Path"}),OpenLayers.Handler.Polygon=OpenLayers.Class(OpenLayers.Handler.Path,{holeModifier:null,drawingHole:!1,polygon:null,createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i),this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LinearRing([this.point.geometry])),this.polygon=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([this.line.geometry])),this.callback("create",[this.point.geometry,this.getSketch()]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.polygon,this.point],{silent:!0})},addPoint:function(){if(!this.drawingHole&&this.holeModifier&&this.evt&&this.evt[this.holeModifier])for(var e,t,i=this.point.geometry,a=this.control.layer.features,n=a.length-1;n>=0;--n)if(e=a[n].geometry,(e instanceof OpenLayers.Geometry.Polygon||e instanceof OpenLayers.Geometry.MultiPolygon)&&e.intersects(i)){t=a[n],this.control.layer.removeFeatures([t],{silent:!0}),this.control.layer.events.registerPriority("sketchcomplete",this,this.finalizeInteriorRing),this.control.layer.events.registerPriority("sketchmodified",this,this.enforceTopology),t.geometry.addComponent(this.line.geometry),this.polygon=t,this.drawingHole=!0;break}OpenLayers.Handler.Path.prototype.addPoint.apply(this,arguments)},getCurrentPointIndex:function(){return this.line.geometry.components.length-2},enforceTopology:function(e){var t=e.vertex,i=this.line.geometry.components;if(!this.polygon.geometry.intersects(t)){var a=i[i.length-3];t.x=a.x,t.y=a.y}},finishGeometry:function(){var e=this.line.geometry.components.length-2;this.line.geometry.removeComponent(this.line.geometry.components[e]),this.removePoint(),this.finalize()},finalizeInteriorRing:function(){var e=this.line.geometry,t=0!==e.getArea();if(t){for(var i=this.polygon.geometry.components,a=i.length-2;a>=0;--a)if(e.intersects(i[a])){t=!1;break}if(t)e:for(var a=i.length-2;a>0;--a)for(var n=i[a].components,s=0,r=n.length;r>s;++s)if(e.containsPoint(n[s])){t=!1;break e}}return t?this.polygon.state!==OpenLayers.State.INSERT&&(this.polygon.state=OpenLayers.State.UPDATE):this.polygon.geometry.removeComponent(e),this.restoreFeature(),!1},cancel:function(){return this.drawingHole&&(this.polygon.geometry.removeComponent(this.line.geometry),this.restoreFeature(!0)),OpenLayers.Handler.Path.prototype.cancel.apply(this,arguments)},restoreFeature:function(e){this.control.layer.events.unregister("sketchcomplete",this,this.finalizeInteriorRing),this.control.layer.events.unregister("sketchmodified",this,this.enforceTopology),this.layer.removeFeatures([this.polygon],{silent:!0}),this.control.layer.addFeatures([this.polygon],{silent:!0}),this.drawingHole=!1,e||this.control.layer.events.triggerEvent("sketchcomplete",{feature:this.polygon})},destroyFeature:function(e){OpenLayers.Handler.Path.prototype.destroyFeature.call(this,e),this.polygon=null},drawFeature:function(){this.layer.drawFeature(this.polygon,this.style),this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.polygon},getGeometry:function(){var e=this.polygon&&this.polygon.geometry;return e&&this.multi&&(e=new OpenLayers.Geometry.MultiPolygon([e])),e},CLASS_NAME:"OpenLayers.Handler.Polygon"}),OpenLayers.Handler.Feature=OpenLayers.Class(OpenLayers.Handler,{EVENTMAP:{click:{"in":"click",out:"clickout"},mousemove:{"in":"over",out:"out"},dblclick:{"in":"dblclick",out:null},mousedown:{"in":null,out:null},mouseup:{"in":null,out:null},touchstart:{"in":"click",out:"clickout"}},feature:null,lastFeature:null,down:null,up:null,touch:!1,clickTolerance:4,geometryTypes:null,stopClick:!0,stopDown:!0,stopUp:!1,initialize:function(e,t,i,a){OpenLayers.Handler.prototype.initialize.apply(this,[e,i,a]),this.layer=t},touchstart:function(e){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,dblclick:this.dblclick,scope:this})),OpenLayers.Event.isMultiTouch(e)?!0:this.mousedown(e)},touchmove:function(e){OpenLayers.Event.stop(e)},mousedown:function(e){return(OpenLayers.Event.isLeftClick(e)||OpenLayers.Event.isSingleTouch(e))&&(this.down=e.xy),this.handle(e)?!this.stopDown:!0},mouseup:function(e){return this.up=e.xy,this.handle(e)?!this.stopUp:!0},click:function(e){return this.handle(e)?!this.stopClick:!0},mousemove:function(e){return this.callbacks.over||this.callbacks.out?(this.handle(e),!0):!0},dblclick:function(e){return!this.handle(e)},geometryTypeMatches:function(e){return null==this.geometryTypes||OpenLayers.Util.indexOf(this.geometryTypes,e.geometry.CLASS_NAME)>-1},handle:function(e){this.feature&&!this.feature.layer&&(this.feature=null);var t=e.type,i=!1,a=!!this.feature,n="click"==t||"dblclick"==t||"touchstart"==t;if(this.feature=this.layer.getFeatureFromEvent(e),this.feature&&!this.feature.layer&&(this.feature=null),this.lastFeature&&!this.lastFeature.layer&&(this.lastFeature=null),this.feature){"touchstart"===t&&OpenLayers.Event.stop(e);var s=this.feature!=this.lastFeature;this.geometryTypeMatches(this.feature)?(a&&s?(this.lastFeature&&this.triggerCallback(t,"out",[this.lastFeature]),this.triggerCallback(t,"in",[this.feature])):(!a||n)&&this.triggerCallback(t,"in",[this.feature]),this.lastFeature=this.feature,i=!0):(this.lastFeature&&(a&&s||n)&&this.triggerCallback(t,"out",[this.lastFeature]),this.feature=null)}else this.lastFeature&&(a||n)&&this.triggerCallback(t,"out",[this.lastFeature]);return i},triggerCallback:function(e,t,i){var a=this.EVENTMAP[e][t];if(a)if("click"==e&&this.up&&this.down){var n=Math.sqrt(Math.pow(this.up.x-this.down.x,2)+Math.pow(this.up.y-this.down.y,2));n<=this.clickTolerance&&this.callback(a,i)}else this.callback(a,i)},activate:function(){var e=!1;return OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.moveLayerToTop(),this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.moveLayerBack(),this.feature=null,this.lastFeature=null,this.down=null,this.up=null,this.touch=!1,this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),e=!0),e},handleMapEvents:function(e){("removelayer"==e.type||"order"==e.property)&&this.moveLayerToTop()},moveLayerToTop:function(){var e=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(e)},moveLayerBack:function(){var e=this.layer.getZIndex()-1;e>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(e):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Handler.Feature"}),OpenLayers.Handler.Drag=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!0,dragging:!1,touch:!1,last:null,start:null,lastMoveEvt:null,oldOnselectstart:null,interval:0,timeoutId:null,documentDrag:!1,documentEvents:null,initialize:function(){if(OpenLayers.Handler.prototype.initialize.apply(this,arguments),this.documentDrag===!0){var e=this;this._docMove=function(t){e.mousemove({xy:{x:t.clientX,y:t.clientY},element:document})},this._docUp=function(t){e.mouseup({xy:{x:t.clientX,y:t.clientY}})}}},dragstart:function(e){var t=!0;return this.dragging=!1,this.checkModifiers(e)&&(OpenLayers.Event.isLeftClick(e)||OpenLayers.Event.isSingleTouch(e))?(this.started=!0,this.start=e.xy,this.last=e.xy,OpenLayers.Element.addClass(this.map.viewPortDiv,"olDragDown"),this.down(e),this.callback("down",[e.xy]),OpenLayers.Event.stop(e),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart?document.onselectstart:OpenLayers.Function.True),document.onselectstart=OpenLayers.Function.False,t=!this.stopDown):(this.started=!1,this.start=null,this.last=null),t},dragmove:function(e){return this.lastMoveEvt=e,!this.started||this.timeoutId||e.xy.x==this.last.x&&e.xy.y==this.last.y||(this.documentDrag===!0&&this.documentEvents&&(e.element===document?(this.adjustXY(e),this.setEvent(e)):this.removeDocumentEvents()),this.interval>0&&(this.timeoutId=setTimeout(OpenLayers.Function.bind(this.removeTimeout,this),this.interval)),this.dragging=!0,this.move(e),this.callback("move",[e.xy]),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart,document.onselectstart=OpenLayers.Function.False),this.last=e.xy),!0},dragend:function(e){if(this.started){this.documentDrag===!0&&this.documentEvents&&(this.adjustXY(e),this.removeDocumentEvents());var t=this.start!=this.last;this.started=!1,this.dragging=!1,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown"),this.up(e),this.callback("up",[e.xy]),t&&this.callback("done",[e.xy]),document.onselectstart=this.oldOnselectstart}return!0},down:function(){},move:function(){},up:function(){},out:function(){},mousedown:function(e){return this.dragstart(e)},touchstart:function(e){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,scope:this})),this.dragstart(e)},mousemove:function(e){return this.dragmove(e)},touchmove:function(e){return this.dragmove(e)},removeTimeout:function(){this.timeoutId=null,this.dragging&&this.mousemove(this.lastMoveEvt)},mouseup:function(e){return this.dragend(e)},touchend:function(e){return e.xy=this.last,this.dragend(e)},mouseout:function(e){if(this.started&&OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv))if(this.documentDrag===!0)this.addDocumentEvents();else{var t=this.start!=this.last;this.started=!1,this.dragging=!1,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown"),this.out(e),this.callback("out",[]),t&&this.callback("done",[e.xy]),document.onselectstart&&(document.onselectstart=this.oldOnselectstart)}return!0},click:function(){return this.start==this.last},activate:function(){var e=!1;return OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.dragging=!1,e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.touch=!1,this.started=!1,this.dragging=!1,this.start=null,this.last=null,e=!0,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown")),e},adjustXY:function(e){var t=OpenLayers.Util.pagePosition(this.map.viewPortDiv);e.xy.x-=t[0],e.xy.y-=t[1]},addDocumentEvents:function(){OpenLayers.Element.addClass(document.body,"olDragDown"),this.documentEvents=!0,OpenLayers.Event.observe(document,"mousemove",this._docMove),OpenLayers.Event.observe(document,"mouseup",this._docUp)},removeDocumentEvents:function(){OpenLayers.Element.removeClass(document.body,"olDragDown"),this.documentEvents=!1,OpenLayers.Event.stopObserving(document,"mousemove",this._docMove),OpenLayers.Event.stopObserving(document,"mouseup",this._docUp)},CLASS_NAME:"OpenLayers.Handler.Drag"}),OpenLayers.Handler.Pinch=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!1,pinching:!1,last:null,start:null,touchstart:function(e){var t=!0;return this.pinching=!1,OpenLayers.Event.isMultiTouch(e)?(this.started=!0,this.last=this.start={distance:this.getDistance(e.touches),delta:0,scale:1},this.callback("start",[e,this.start]),t=!this.stopDown):(this.started=!1,this.start=null,this.last=null),OpenLayers.Event.stop(e),t},touchmove:function(e){if(this.started&&OpenLayers.Event.isMultiTouch(e)){this.pinching=!0;var t=this.getPinchData(e);this.callback("move",[e,t]),this.last=t,OpenLayers.Event.stop(e)}return!0},touchend:function(e){return this.started&&(this.started=!1,this.pinching=!1,this.callback("done",[e,this.start,this.last]),this.start=null,this.last=null),!0},activate:function(){var e=!1;return OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.pinching=!1,e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.started=!1,this.pinching=!1,this.start=null,this.last=null,e=!0),e},getDistance:function(e){var t=e[0],i=e[1];return Math.sqrt(Math.pow(t.clientX-i.clientX,2)+Math.pow(t.clientY-i.clientY,2))},getPinchData:function(e){var t=this.getDistance(e.touches),i=t/this.start.distance;return{distance:t,delta:this.last.distance-t,scale:i}},CLASS_NAME:"OpenLayers.Handler.Pinch"}),OpenLayers.Handler.RegularPolygon=OpenLayers.Class(OpenLayers.Handler.Drag,{sides:4,radius:null,snapAngle:null,snapToggle:"shiftKey",layerOptions:null,persist:!1,irregular:!1,citeCompliant:!1,angle:null,fixedRadius:!1,feature:null,layer:null,origin:null,initialize:function(e,t,i){i&&i.layerOptions&&i.layerOptions.styleMap||(this.style=OpenLayers.Util.extend(OpenLayers.Feature.Vector.style["default"],{})),OpenLayers.Handler.Drag.prototype.initialize.apply(this,[e,t,i]),this.options=i?i:{}},setOptions:function(e){OpenLayers.Util.extend(this.options,e),OpenLayers.Util.extend(this,e)},activate:function(){var e=!1;if(OpenLayers.Handler.Drag.prototype.activate.apply(this,arguments)){var t=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions);this.layer=new OpenLayers.Layer.Vector(this.CLASS_NAME,t),this.map.addLayer(this.layer),e=!0}return e},deactivate:function(){var e=!1;return OpenLayers.Handler.Drag.prototype.deactivate.apply(this,arguments)&&(this.dragging&&this.cancel(),null!=this.layer.map&&(this.layer.destroy(!1),this.feature&&this.feature.destroy()),this.layer=null,this.feature=null,e=!0),e},down:function(e){this.fixedRadius=!!this.radius;var t=this.layer.getLonLatFromViewPortPx(e.xy);this.origin=new OpenLayers.Geometry.Point(t.lon,t.lat),(!this.fixedRadius||this.irregular)&&(this.radius=this.map.getResolution()),this.persist&&this.clear(),this.feature=new OpenLayers.Feature.Vector,this.createGeometry(),this.callback("create",[this.origin,this.feature]),this.layer.addFeatures([this.feature],{silent:!0}),this.layer.drawFeature(this.feature,this.style)},move:function(e){var t=this.layer.getLonLatFromViewPortPx(e.xy),i=new OpenLayers.Geometry.Point(t.lon,t.lat);if(this.irregular){var a=Math.sqrt(2)*Math.abs(i.y-this.origin.y)/2;this.radius=Math.max(this.map.getResolution()/2,a)}else this.fixedRadius?this.origin=i:(this.calculateAngle(i,e),this.radius=Math.max(this.map.getResolution()/2,i.distanceTo(this.origin)));if(this.modifyGeometry(),this.irregular){var n,s=i.x-this.origin.x,r=i.y-this.origin.y;n=0==r?s/(this.radius*Math.sqrt(2)):s/r,this.feature.geometry.resize(1,this.origin,n),this.feature.geometry.move(s/2,r/2)}this.layer.drawFeature(this.feature,this.style)},up:function(e){this.finalize(),this.start==this.last&&this.callback("done",[e.xy])},out:function(){this.finalize()},createGeometry:function(){this.angle=Math.PI*(1/this.sides-.5),this.snapAngle&&(this.angle+=this.snapAngle*(Math.PI/180)),this.feature.geometry=OpenLayers.Geometry.Polygon.createRegularPolygon(this.origin,this.radius,this.sides,this.snapAngle)},modifyGeometry:function(){var e,t,i=this.feature.geometry.components[0];
i.components.length!=this.sides+1&&(this.createGeometry(),i=this.feature.geometry.components[0]);for(var a=0;a<this.sides;++a)t=i.components[a],e=this.angle+2*a*Math.PI/this.sides,t.x=this.origin.x+this.radius*Math.cos(e),t.y=this.origin.y+this.radius*Math.sin(e),t.clearBounds()},calculateAngle:function(e,t){var i=Math.atan2(e.y-this.origin.y,e.x-this.origin.x);if(this.snapAngle&&this.snapToggle&&!t[this.snapToggle]){var a=Math.PI/180*this.snapAngle;this.angle=Math.round(i/a)*a}else this.angle=i},cancel:function(){this.callback("cancel",null),this.finalize()},finalize:function(){this.origin=null,this.radius=this.options.radius},clear:function(){this.layer&&(this.layer.renderer.clear(),this.layer.destroyFeatures())},callback:function(e){this.callbacks[e]&&this.callbacks[e].apply(this.control,[this.feature.geometry.clone()]),this.persist||"done"!=e&&"cancel"!=e||this.clear()},CLASS_NAME:"OpenLayers.Handler.RegularPolygon"}),OpenLayers.Handler.Box=OpenLayers.Class(OpenLayers.Handler,{dragHandler:null,boxDivClassName:"olHandlerBoxZoomBox",boxOffsets:null,initialize:function(){OpenLayers.Handler.prototype.initialize.apply(this,arguments),this.dragHandler=new OpenLayers.Handler.Drag(this,{down:this.startBox,move:this.moveBox,out:this.removeBox,up:this.endBox},{keyMask:this.keyMask})},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments),this.dragHandler&&(this.dragHandler.destroy(),this.dragHandler=null)},setMap:function(e){OpenLayers.Handler.prototype.setMap.apply(this,arguments),this.dragHandler&&this.dragHandler.setMap(e)},startBox:function(){this.callback("start",[]),this.zoomBox=OpenLayers.Util.createDiv("zoomBox",{x:-9999,y:-9999}),this.zoomBox.className=this.boxDivClassName,this.zoomBox.style.zIndex=this.map.Z_INDEX_BASE.Popup-1,this.map.viewPortDiv.appendChild(this.zoomBox),OpenLayers.Element.addClass(this.map.viewPortDiv,"olDrawBox")},moveBox:function(e){var t=this.dragHandler.start.x,i=this.dragHandler.start.y,a=Math.abs(t-e.x),n=Math.abs(i-e.y),s=this.getBoxOffsets();this.zoomBox.style.width=a+s.width+1+"px",this.zoomBox.style.height=n+s.height+1+"px",this.zoomBox.style.left=(e.x<t?t-a-s.left:t-s.left)+"px",this.zoomBox.style.top=(e.y<i?i-n-s.top:i-s.top)+"px"},endBox:function(e){var t;if(Math.abs(this.dragHandler.start.x-e.x)>5||Math.abs(this.dragHandler.start.y-e.y)>5){var i=this.dragHandler.start,a=Math.min(i.y,e.y),n=Math.max(i.y,e.y),s=Math.min(i.x,e.x),r=Math.max(i.x,e.x);t=new OpenLayers.Bounds(s,n,r,a)}else t=this.dragHandler.start.clone();this.removeBox(),this.callback("done",[t])},removeBox:function(){this.map.viewPortDiv.removeChild(this.zoomBox),this.zoomBox=null,this.boxOffsets=null,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDrawBox")},activate:function(){return OpenLayers.Handler.prototype.activate.apply(this,arguments)?(this.dragHandler.activate(),!0):!1},deactivate:function(){return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)?(this.dragHandler.deactivate()&&this.zoomBox&&this.removeBox(),!0):!1},getBoxOffsets:function(){if(!this.boxOffsets){var e=document.createElement("div");e.style.position="absolute",e.style.border="1px solid black",e.style.width="3px",document.body.appendChild(e);var t=3==e.clientWidth;document.body.removeChild(e);var i=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-left-width")),a=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-right-width")),n=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-top-width")),s=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-bottom-width"));this.boxOffsets={left:i,right:a,top:n,bottom:s,width:t===!1?i+a:0,height:t===!1?n+s:0}}return this.boxOffsets},CLASS_NAME:"OpenLayers.Handler.Box"}),OpenLayers.Handler.MouseWheel=OpenLayers.Class(OpenLayers.Handler,{wheelListener:null,mousePosition:null,interval:0,delta:0,cumulative:!0,initialize:function(){OpenLayers.Handler.prototype.initialize.apply(this,arguments),this.wheelListener=OpenLayers.Function.bindAsEventListener(this.onWheelEvent,this)},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments),this.wheelListener=null},onWheelEvent:function(e){if(this.map&&this.checkModifiers(e)){for(var t=!1,i=!1,a=!1,n=OpenLayers.Event.element(e);null!=n&&!a&&!t;){if(!t)try{if(n.currentStyle)r=n.currentStyle.overflow;else var s=document.defaultView.getComputedStyle(n,null),r=s.getPropertyValue("overflow");t=r&&"auto"==r||"scroll"==r}catch(o){}if(!i)for(var l=0,u=this.map.layers.length;u>l;l++)if(n==this.map.layers[l].div||n==this.map.layers[l].pane){i=!0;break}a=n==this.map.div,n=n.parentNode}if(!t&&a){if(i){var c=0;e||(e=window.event),e.wheelDelta?(c=e.wheelDelta/120,window.opera&&window.opera.version()<9.2&&(c=-c)):e.detail&&(c=-e.detail/3),this.delta=this.delta+c,this.interval?(window.clearTimeout(this._timeoutId),this._timeoutId=window.setTimeout(OpenLayers.Function.bind(function(){this.wheelZoom(e)},this),this.interval)):this.wheelZoom(e)}OpenLayers.Event.stop(e)}}},wheelZoom:function(e){var t=this.delta;this.delta=0,t&&(this.mousePosition&&(e.xy=this.mousePosition),e.xy||(e.xy=this.map.getPixelFromLonLat(this.map.getCenter())),0>t?this.callback("down",[e,this.cumulative?t:-1]):this.callback("up",[e,this.cumulative?t:1]))},mousemove:function(e){this.mousePosition=e.xy},activate:function(){if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){var e=this.wheelListener;return OpenLayers.Event.observe(window,"DOMMouseScroll",e),OpenLayers.Event.observe(window,"mousewheel",e),OpenLayers.Event.observe(document,"mousewheel",e),!0}return!1},deactivate:function(){if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){var e=this.wheelListener;return OpenLayers.Event.stopObserving(window,"DOMMouseScroll",e),OpenLayers.Event.stopObserving(window,"mousewheel",e),OpenLayers.Event.stopObserving(document,"mousewheel",e),!0}return!1},CLASS_NAME:"OpenLayers.Handler.MouseWheel"}),OpenLayers.Handler.Keyboard=OpenLayers.Class(OpenLayers.Handler,{KEY_EVENTS:["keydown","keyup"],eventListener:null,observeElement:null,initialize:function(){OpenLayers.Handler.prototype.initialize.apply(this,arguments),this.eventListener=OpenLayers.Function.bindAsEventListener(this.handleKeyEvent,this)},destroy:function(){this.deactivate(),this.eventListener=null,OpenLayers.Handler.prototype.destroy.apply(this,arguments)},activate:function(){if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){this.observeElement=this.observeElement||document;for(var e=0,t=this.KEY_EVENTS.length;t>e;e++)OpenLayers.Event.observe(this.observeElement,this.KEY_EVENTS[e],this.eventListener);return!0}return!1},deactivate:function(){var e=!1;if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){for(var t=0,i=this.KEY_EVENTS.length;i>t;t++)OpenLayers.Event.stopObserving(this.observeElement,this.KEY_EVENTS[t],this.eventListener);e=!0}return e},handleKeyEvent:function(e){this.checkModifiers(e)&&this.callback(e.type,[e])},CLASS_NAME:"OpenLayers.Handler.Keyboard"}),OpenLayers.Control=OpenLayers.Class({id:null,map:null,div:null,type:null,allowSelection:!1,displayClass:"",title:"",autoActivate:!1,active:null,handler:null,eventListeners:null,events:null,initialize:function(e){this.displayClass=this.CLASS_NAME.replace("OpenLayers.","ol").replace(/\./g,""),OpenLayers.Util.extend(this,e),this.events=new OpenLayers.Events(this),this.eventListeners instanceof Object&&this.events.on(this.eventListeners),null==this.id&&(this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"))},destroy:function(){if(this.events&&(this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy(),this.events=null),this.eventListeners=null,this.handler&&(this.handler.destroy(),this.handler=null),this.handlers){for(var e in this.handlers)this.handlers.hasOwnProperty(e)&&"function"==typeof this.handlers[e].destroy&&this.handlers[e].destroy();this.handlers=null}this.map&&(this.map.removeControl(this),this.map=null),this.div=null},setMap:function(e){this.map=e,this.handler&&this.handler.setMap(e)},draw:function(e){return null==this.div&&(this.div=OpenLayers.Util.createDiv(this.id),this.div.className=this.displayClass,this.allowSelection||(this.div.className+=" olControlNoSelect",this.div.setAttribute("unselectable","on",0),this.div.onselectstart=OpenLayers.Function.False),""!=this.title&&(this.div.title=this.title)),null!=e&&(this.position=e.clone()),this.moveTo(this.position),this.div},moveTo:function(e){null!=e&&null!=this.div&&(this.div.style.left=e.x+"px",this.div.style.top=e.y+"px")},activate:function(){return this.active?!1:(this.handler&&this.handler.activate(),this.active=!0,this.map&&OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active"),this.events.triggerEvent("activate"),!0)},deactivate:function(){return this.active?(this.handler&&this.handler.deactivate(),this.active=!1,this.map&&OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active"),this.events.triggerEvent("deactivate"),!0):!1},CLASS_NAME:"OpenLayers.Control"}),OpenLayers.Control.TYPE_BUTTON=1,OpenLayers.Control.TYPE_TOGGLE=2,OpenLayers.Control.TYPE_TOOL=3,OpenLayers.Control.Button=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){},CLASS_NAME:"OpenLayers.Control.Button"}),OpenLayers.Control.ZoomBox=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,out:!1,keyMask:null,alwaysZoom:!1,draw:function(){this.handler=new OpenLayers.Handler.Box(this,{done:this.zoomBox},{keyMask:this.keyMask})},zoomBox:function(e){if(e instanceof OpenLayers.Bounds){var t;if(this.out){var i=Math.abs(e.right-e.left),a=Math.abs(e.top-e.bottom),n=Math.min(this.map.size.h/a,this.map.size.w/i),s=this.map.getExtent(),r=this.map.getLonLatFromPixel(e.getCenterPixel()),o=r.lon-s.getWidth()/2*n,l=r.lon+s.getWidth()/2*n,u=r.lat-s.getHeight()/2*n,c=r.lat+s.getHeight()/2*n;t=new OpenLayers.Bounds(o,u,l,c)}else{var h=this.map.getLonLatFromPixel({x:e.left,y:e.bottom}),d=this.map.getLonLatFromPixel({x:e.right,y:e.top});t=new OpenLayers.Bounds(h.lon,h.lat,d.lon,d.lat)}var p=this.map.getZoom();this.map.zoomToExtent(t),p==this.map.getZoom()&&1==this.alwaysZoom&&this.map.zoomTo(p+(this.out?-1:1))}else this.out?this.map.setCenter(this.map.getLonLatFromPixel(e),this.map.getZoom()-1):this.map.setCenter(this.map.getLonLatFromPixel(e),this.map.getZoom()+1)},CLASS_NAME:"OpenLayers.Control.ZoomBox"}),OpenLayers.Control.DragPan=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,panned:!1,interval:1,documentDrag:!1,kinetic:null,enableKinetic:!1,kineticInterval:10,draw:function(){if(this.enableKinetic){var e={interval:this.kineticInterval};"object"==typeof this.enableKinetic&&(e=OpenLayers.Util.extend(e,this.enableKinetic)),this.kinetic=new OpenLayers.Kinetic(e)}this.handler=new OpenLayers.Handler.Drag(this,{move:this.panMap,done:this.panMapDone,down:this.panMapStart},{interval:this.interval,documentDrag:this.documentDrag})},panMapStart:function(){this.kinetic&&this.kinetic.begin()},panMap:function(e){this.kinetic&&this.kinetic.update(e),this.panned=!0,this.map.pan(this.handler.last.x-e.x,this.handler.last.y-e.y,{dragging:!0,animate:!1})},panMapDone:function(e){if(this.panned){var t=null;if(this.kinetic&&(t=this.kinetic.end(e)),this.map.pan(this.handler.last.x-e.x,this.handler.last.y-e.y,{dragging:!!t,animate:!1}),t){var i=this;this.kinetic.move(t,function(e,t,a){i.map.pan(e,t,{dragging:!a,animate:!1})})}this.panned=!1}},CLASS_NAME:"OpenLayers.Control.DragPan"}),OpenLayers.Control.PinchZoom=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,containerCenter:null,pinchOrigin:null,currentCenter:null,autoActivate:!0,initialize:function(){OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Pinch(this,{start:this.pinchStart,move:this.pinchMove,done:this.pinchDone},this.handlerOptions)},activate:function(){var e=OpenLayers.Control.prototype.activate.apply(this,arguments);return e&&(this.map.events.on({moveend:this.updateContainerCenter,scope:this}),this.updateContainerCenter()),e},deactivate:function(){var e=OpenLayers.Control.prototype.deactivate.apply(this,arguments);return this.map&&this.map.events&&this.map.events.un({moveend:this.updateContainerCenter,scope:this}),e},updateContainerCenter:function(){var e=this.map.layerContainerDiv;this.containerCenter={x:parseInt(e.style.left,10)+50,y:parseInt(e.style.top,10)+50}},pinchStart:function(e){this.pinchOrigin=e.xy,this.currentCenter=e.xy},pinchMove:function(e,t){var i=t.scale,a=this.containerCenter,n=this.pinchOrigin,s=e.xy,r=Math.round(s.x-n.x+(i-1)*(a.x-n.x)),o=Math.round(s.y-n.y+(i-1)*(a.y-n.y));this.applyTransform("translate("+r+"px, "+o+"px) scale("+i+")"),this.currentCenter=s},applyTransform:function(e){var t=this.map.layerContainerDiv.style;t["-webkit-transform"]=e,t["-moz-transform"]=e},pinchDone:function(e,t,i){this.applyTransform("");var a=this.map.getZoomForResolution(this.map.getResolution()/i.scale,!0);if(a!==this.map.getZoom()||!this.currentCenter.equals(this.pinchOrigin)){var n=this.map.getResolutionForZoom(a),s=this.map.getLonLatFromPixel(this.pinchOrigin),r=this.currentCenter,o=this.map.getSize();s.lon+=n*(o.w/2-r.x),s.lat-=n*(o.h/2-r.y),this.map.div.clientWidth=this.map.div.clientWidth,this.map.setCenter(s,a)}},CLASS_NAME:"OpenLayers.Control.PinchZoom"}),OpenLayers.Control.OverviewMap=OpenLayers.Class(OpenLayers.Control,{element:null,ovmap:null,size:{w:180,h:90},layers:null,minRectSize:15,minRectDisplayClass:"RectReplacement",minRatio:8,maxRatio:32,mapOptions:null,autoPan:!1,handlers:null,resolutionFactor:1,maximized:!1,initialize:function(e){this.layers=[],this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,[e])},destroy:function(){this.mapDiv&&(this.handlers.click&&this.handlers.click.destroy(),this.handlers.drag&&this.handlers.drag.destroy(),this.ovmap&&this.ovmap.viewPortDiv.removeChild(this.extentRectangle),this.extentRectangle=null,this.rectEvents&&(this.rectEvents.destroy(),this.rectEvents=null),this.ovmap&&(this.ovmap.destroy(),this.ovmap=null),this.element.removeChild(this.mapDiv),this.mapDiv=null,this.div.removeChild(this.element),this.element=null,this.maximizeDiv&&(this.div.removeChild(this.maximizeDiv),this.maximizeDiv=null),this.minimizeDiv&&(this.div.removeChild(this.minimizeDiv),this.minimizeDiv=null),this.map.events.un({buttonclick:this.onButtonClick,moveend:this.update,changebaselayer:this.baseLayerDraw,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments))},draw:function(){if(OpenLayers.Control.prototype.draw.apply(this,arguments),0===this.layers.length){if(!this.map.baseLayer)return this.map.events.register("changebaselayer",this,this.baseLayerDraw),this.div;var e=this.map.baseLayer.clone();this.layers=[e]}if(this.element=document.createElement("div"),this.element.className=this.displayClass+"Element",this.element.style.display="none",this.mapDiv=document.createElement("div"),this.mapDiv.style.width=this.size.w+"px",this.mapDiv.style.height=this.size.h+"px",this.mapDiv.style.position="relative",this.mapDiv.style.overflow="hidden",this.mapDiv.id=OpenLayers.Util.createUniqueID("overviewMap"),this.extentRectangle=document.createElement("div"),this.extentRectangle.style.position="absolute",this.extentRectangle.style.zIndex=1e3,this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.element.appendChild(this.mapDiv),this.div.appendChild(this.element),this.outsideViewport)this.element.style.display="";else{this.div.className+=" "+this.displayClass+"Container";var t=OpenLayers.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv(this.displayClass+"MaximizeButton",null,null,t,"absolute"),this.maximizeDiv.style.display="none",this.maximizeDiv.className=this.displayClass+"MaximizeButton olButton",this.div.appendChild(this.maximizeDiv);var t=OpenLayers.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_minimizeDiv",null,null,t,"absolute"),this.minimizeDiv.style.display="none",this.minimizeDiv.className=this.displayClass+"MinimizeButton olButton",this.div.appendChild(this.minimizeDiv),this.minimizeControl()}return this.map.getExtent()&&this.update(),this.map.events.on({buttonclick:this.onButtonClick,moveend:this.update,scope:this}),this.maximized&&this.maximizeControl(),this.div},baseLayerDraw:function(){this.draw(),this.map.events.unregister("changebaselayer",this,this.baseLayerDraw)},rectDrag:function(e){var t=this.handlers.drag.last.x-e.x,i=this.handlers.drag.last.y-e.y;if(0!=t||0!=i){var a=this.rectPxBounds.top,n=this.rectPxBounds.left,s=Math.abs(this.rectPxBounds.getHeight()),r=this.rectPxBounds.getWidth(),o=Math.max(0,a-i);o=Math.min(o,this.ovmap.size.h-this.hComp-s);var l=Math.max(0,n-t);l=Math.min(l,this.ovmap.size.w-this.wComp-r),this.setRectPxBounds(new OpenLayers.Bounds(l,o+s,l+r,o))}},mapDivClick:function(e){var t=this.rectPxBounds.getCenterPixel(),i=e.xy.x-t.x,a=e.xy.y-t.y,n=this.rectPxBounds.top,s=this.rectPxBounds.left,r=Math.abs(this.rectPxBounds.getHeight()),o=this.rectPxBounds.getWidth(),l=Math.max(0,n+a);l=Math.min(l,this.ovmap.size.h-r);var u=Math.max(0,s+i);u=Math.min(u,this.ovmap.size.w-o),this.setRectPxBounds(new OpenLayers.Bounds(u,l+r,u+o,l)),this.updateMapToRect()},onButtonClick:function(e){e.buttonElement===this.minimizeDiv?this.minimizeControl():e.buttonElement===this.maximizeDiv&&this.maximizeControl()},maximizeControl:function(e){this.element.style.display="",this.showToggle(!1),null!=e&&OpenLayers.Event.stop(e)},minimizeControl:function(e){this.element.style.display="none",this.showToggle(!0),null!=e&&OpenLayers.Event.stop(e)},showToggle:function(e){this.maximizeDiv.style.display=e?"":"none",this.minimizeDiv.style.display=e?"none":""},update:function(){null==this.ovmap&&this.createMap(),(this.autoPan||!this.isSuitableOverview())&&this.updateOverview(),this.updateRectToMap()},isSuitableOverview:function(){var e=this.map.getExtent(),t=this.map.maxExtent,i=new OpenLayers.Bounds(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom),Math.min(e.right,t.right),Math.min(e.top,t.top));this.ovmap.getProjection()!=this.map.getProjection()&&(i=i.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()));var a=this.ovmap.getResolution()/this.map.getResolution();return a>this.minRatio&&a<=this.maxRatio&&this.ovmap.getExtent().containsBounds(i)},updateOverview:function(){var e=this.map.getResolution(),t=this.ovmap.getResolution(),i=t/e;i>this.maxRatio?t=this.minRatio*e:i<=this.minRatio&&(t=this.maxRatio*e);var a;this.ovmap.getProjection()!=this.map.getProjection()?(a=this.map.center.clone(),a.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject())):a=this.map.center,this.ovmap.setCenter(a,this.ovmap.getZoomForResolution(t*this.resolutionFactor)),this.updateRectToMap()},createMap:function(){var e=OpenLayers.Util.extend({controls:[],maxResolution:"auto",fallThrough:!1},this.mapOptions);if(this.ovmap=new OpenLayers.Map(this.mapDiv,e),this.ovmap.viewPortDiv.appendChild(this.extentRectangle),OpenLayers.Event.stopObserving(window,"unload",this.ovmap.unloadDestroy),this.ovmap.addLayers(this.layers),this.ovmap.zoomToMaxExtent(),this.wComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-left-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-right-width")),this.wComp=this.wComp?this.wComp:2,this.hComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-top-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-bottom-width")),this.hComp=this.hComp?this.hComp:2,this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.rectDrag,done:this.updateMapToRect},{map:this.ovmap}),this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.mapDivClick},{single:!0,"double":!1,stopSingle:!0,stopDouble:!0,pixelTolerance:1,map:this.ovmap}),this.handlers.click.activate(),this.rectEvents=new OpenLayers.Events(this,this.extentRectangle,null,!0),this.rectEvents.register("mouseover",this,function(){this.handlers.drag.active||this.map.dragging||this.handlers.drag.activate()}),this.rectEvents.register("mouseout",this,function(){this.handlers.drag.dragging||this.handlers.drag.deactivate()}),this.ovmap.getProjection()!=this.map.getProjection()){var t=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,i=this.ovmap.getProjectionObject().getUnits()||this.ovmap.units||this.ovmap.baseLayer.units;this.resolutionFactor=t&&i?OpenLayers.INCHES_PER_UNIT[t]/OpenLayers.INCHES_PER_UNIT[i]:1}},updateRectToMap:function(){var e;e=this.ovmap.getProjection()!=this.map.getProjection()?this.map.getExtent().transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):this.map.getExtent();var t=this.getRectBoundsFromMapBounds(e);t&&this.setRectPxBounds(t)},updateMapToRect:function(){var e=this.getMapBoundsFromRectBounds(this.rectPxBounds);this.ovmap.getProjection()!=this.map.getProjection()&&(e=e.transform(this.ovmap.getProjectionObject(),this.map.getProjectionObject())),this.map.panTo(e.getCenterLonLat())},setRectPxBounds:function(e){var t=Math.max(e.top,0),i=Math.max(e.left,0),a=Math.min(e.top+Math.abs(e.getHeight()),this.ovmap.size.h-this.hComp),n=Math.min(e.left+e.getWidth(),this.ovmap.size.w-this.wComp),s=Math.max(n-i,0),r=Math.max(a-t,0);if(s<this.minRectSize||r<this.minRectSize){this.extentRectangle.className=this.displayClass+this.minRectDisplayClass;var o=i+s/2-this.minRectSize/2,l=t+r/2-this.minRectSize/2;this.extentRectangle.style.top=Math.round(l)+"px",this.extentRectangle.style.left=Math.round(o)+"px",this.extentRectangle.style.height=this.minRectSize+"px",this.extentRectangle.style.width=this.minRectSize+"px"}else this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.extentRectangle.style.top=Math.round(t)+"px",this.extentRectangle.style.left=Math.round(i)+"px",this.extentRectangle.style.height=Math.round(r)+"px",this.extentRectangle.style.width=Math.round(s)+"px";this.rectPxBounds=new OpenLayers.Bounds(Math.round(i),Math.round(a),Math.round(n),Math.round(t))},getRectBoundsFromMapBounds:function(e){var t=this.getOverviewPxFromLonLat({lon:e.left,lat:e.bottom}),i=this.getOverviewPxFromLonLat({lon:e.right,lat:e.top}),a=null;return t&&i&&(a=new OpenLayers.Bounds(t.x,t.y,i.x,i.y)),a},getMapBoundsFromRectBounds:function(e){var t=this.getLonLatFromOverviewPx({x:e.left,y:e.bottom}),i=this.getLonLatFromOverviewPx({x:e.right,y:e.top});return new OpenLayers.Bounds(t.lon,t.lat,i.lon,i.lat)},getLonLatFromOverviewPx:function(e){var t=this.ovmap.size,i=this.ovmap.getResolution(),a=this.ovmap.getExtent().getCenterLonLat(),n=e.x-t.w/2,s=e.y-t.h/2;return{lon:a.lon+n*i,lat:a.lat-s*i}},getOverviewPxFromLonLat:function(e){var t=this.ovmap.getResolution(),i=this.ovmap.getExtent();return i?{x:Math.round(1/t*(e.lon-i.left)),y:Math.round(1/t*(i.top-e.lat))}:void 0},CLASS_NAME:"OpenLayers.Control.OverviewMap"}),OpenLayers.Control.DrawFeature=OpenLayers.Class(OpenLayers.Control,{layer:null,callbacks:null,multi:!1,featureAdded:function(){},handlerOptions:null,initialize:function(e,t,i){OpenLayers.Control.prototype.initialize.apply(this,[i]),this.callbacks=OpenLayers.Util.extend({done:this.drawFeature,modify:function(e,t){this.layer.events.triggerEvent("sketchmodified",{vertex:e,feature:t})},create:function(e,t){this.layer.events.triggerEvent("sketchstarted",{vertex:e,feature:t})}},this.callbacks),this.layer=e,this.handlerOptions=this.handlerOptions||{},this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{renderers:e.renderers,rendererOptions:e.rendererOptions}),"multi"in this.handlerOptions||(this.handlerOptions.multi=this.multi);var a=this.layer.styleMap&&this.layer.styleMap.styles.temporary;a&&(this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({"default":a})})),this.handler=new t(this,this.callbacks,this.handlerOptions)},drawFeature:function(e){var t=new OpenLayers.Feature.Vector(e),i=this.layer.events.triggerEvent("sketchcomplete",{feature:t});i!==!1&&(t.state=OpenLayers.State.INSERT,this.layer.addFeatures([t]),this.featureAdded(t),this.events.triggerEvent("featureadded",{feature:t}))},insertXY:function(e,t){this.handler&&this.handler.line&&this.handler.insertXY(e,t)},insertDeltaXY:function(e,t){this.handler&&this.handler.line&&this.handler.insertDeltaXY(e,t)},insertDirectionLength:function(e,t){this.handler&&this.handler.line&&this.handler.insertDirectionLength(e,t)},insertDeflectionLength:function(e,t){this.handler&&this.handler.line&&this.handler.insertDeflectionLength(e,t)},undo:function(){return this.handler.undo&&this.handler.undo()},redo:function(){return this.handler.redo&&this.handler.redo()},finishSketch:function(){this.handler.finishGeometry()},cancel:function(){this.handler.cancel()},CLASS_NAME:"OpenLayers.Control.DrawFeature"}),OpenLayers.Control.DragFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,onStart:function(){},onDrag:function(){},onComplete:function(){},onEnter:function(){},onLeave:function(){},documentDrag:!1,layer:null,feature:null,dragCallbacks:{},featureCallbacks:{},lastPixel:null,initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]),this.layer=e,this.handlers={drag:new OpenLayers.Handler.Drag(this,OpenLayers.Util.extend({down:this.downFeature,move:this.moveFeature,up:this.upFeature,out:this.cancel,done:this.doneDragging},this.dragCallbacks),{documentDrag:this.documentDrag}),feature:new OpenLayers.Handler.Feature(this,this.layer,OpenLayers.Util.extend({click:this.clickFeature,clickout:this.clickoutFeature,over:this.overFeature,out:this.outFeature},this.featureCallbacks),{geometryTypes:this.geometryTypes})}},clickFeature:function(e){this.handlers.feature.touch&&!this.over&&this.overFeature(e)&&(this.handlers.drag.dragstart(this.handlers.feature.evt),this.handlers.drag.stopDown=!1)},clickoutFeature:function(e){this.handlers.feature.touch&&this.over&&(this.outFeature(e),this.handlers.drag.stopDown=!0)},destroy:function(){this.layer=null,OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return this.handlers.feature.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.handlers.drag.deactivate(),this.handlers.feature.deactivate(),this.feature=null,this.dragging=!1,this.lastPixel=null,OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over"),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},overFeature:function(e){var t=!1;return this.handlers.drag.dragging?this.over=this.feature.id==e.id?!0:!1:(this.feature=e,this.handlers.drag.activate(),t=!0,this.over=!0,OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass+"Over"),this.onEnter(e)),t},downFeature:function(e){this.lastPixel=e,this.onStart(this.feature,e)},moveFeature:function(e){var t=this.map.getResolution();this.feature.geometry.move(t*(e.x-this.lastPixel.x),t*(this.lastPixel.y-e.y)),this.layer.drawFeature(this.feature),this.lastPixel=e,this.onDrag(this.feature,e)},upFeature:function(){this.over||this.handlers.drag.deactivate()},doneDragging:function(e){this.onComplete(this.feature,e)},outFeature:function(e){this.handlers.drag.dragging?this.feature.id==e.id&&(this.over=!1):(this.over=!1,this.handlers.drag.deactivate(),OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over"),this.onLeave(e),this.feature=null)},cancel:function(){this.handlers.drag.deactivate(),this.over=!1},setMap:function(e){this.handlers.drag.setMap(e),this.handlers.feature.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.DragFeature"}),OpenLayers.Control.ModifyFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,clickout:!0,toggle:!0,standalone:!1,layer:null,feature:null,vertices:null,virtualVertices:null,selectControl:null,dragControl:null,handlers:null,deleteCodes:null,virtualStyle:null,vertexRenderIntent:null,mode:null,createVertices:!0,modified:!1,radiusHandle:null,dragHandle:null,onModificationStart:function(){},onModification:function(){},onModificationEnd:function(){},initialize:function(e,t){t=t||{},this.layer=e,this.vertices=[],this.virtualVertices=[],this.virtualStyle=OpenLayers.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer(null,t.vertexRenderIntent)),this.virtualStyle.fillOpacity=.3,this.virtualStyle.strokeOpacity=.3,this.deleteCodes=[46,68],this.mode=OpenLayers.Control.ModifyFeature.RESHAPE,OpenLayers.Control.prototype.initialize.apply(this,[t]),OpenLayers.Util.isArray(this.deleteCodes)||(this.deleteCodes=[this.deleteCodes]);var i=this,a={geometryTypes:this.geometryTypes,clickout:this.clickout,toggle:this.toggle,onBeforeSelect:this.beforeSelectFeature,onSelect:this.selectFeature,onUnselect:this.unselectFeature,scope:this};this.standalone===!1&&(this.selectControl=new OpenLayers.Control.SelectFeature(e,a));var n={geometryTypes:["OpenLayers.Geometry.Point"],onStart:function(e,t){i.dragStart.apply(i,[e,t])},onDrag:function(e,t){i.dragVertex.apply(i,[e,t])},onComplete:function(e){i.dragComplete.apply(i,[e])},featureCallbacks:{over:function(e){(i.standalone!==!0||e._sketch||i.feature===e)&&i.dragControl.overFeature.apply(i.dragControl,[e])}}};this.dragControl=new OpenLayers.Control.DragFeature(e,n);var s={keydown:this.handleKeypress};this.handlers={keyboard:new OpenLayers.Handler.Keyboard(this,s)}},destroy:function(){this.layer=null,this.standalone||this.selectControl.destroy(),this.dragControl.destroy(),OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return(this.standalone||this.selectControl.activate())&&this.handlers.keyboard.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){var e=!1;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){this.layer.removeFeatures(this.vertices,{silent:!0}),this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.vertices=[],this.dragControl.deactivate();var t=this.feature,i=t&&t.geometry&&t.layer;this.standalone===!1?(i&&this.selectControl.unselect.apply(this.selectControl,[t]),this.selectControl.deactivate()):i&&this.unselectFeature(t),this.handlers.keyboard.deactivate(),e=!0}return e},beforeSelectFeature:function(e){return this.layer.events.triggerEvent("beforefeaturemodified",{feature:e})},selectFeature:function(e){this.standalone&&this.beforeSelectFeature(e)===!1||(this.feature=e,this.modified=!1,this.resetVertices(),this.dragControl.activate(),this.onModificationStart(this.feature));var t=e.modified;!e.geometry||t&&t.geometry||(this._originalGeometry=e.geometry.clone())},unselectFeature:function(e){this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[],this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),delete this.dragHandle),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),delete this.radiusHandle),this.feature=null,this.dragControl.deactivate(),this.onModificationEnd(e),this.layer.events.triggerEvent("afterfeaturemodified",{feature:e,modified:this.modified}),this.modified=!1},dragStart:function(e,t){e==this.feature||e.geometry.parent||e==this.dragHandle||e==this.radiusHandle||(this.standalone===!1&&this.feature&&this.selectControl.clickFeature.apply(this.selectControl,[this.feature]),(null==this.geometryTypes||-1!=OpenLayers.Util.indexOf(this.geometryTypes,e.geometry.CLASS_NAME))&&(this.standalone||this.selectControl.clickFeature.apply(this.selectControl,[e]),this.dragControl.overFeature.apply(this.dragControl,[e]),this.dragControl.lastPixel=t,this.dragControl.handlers.drag.started=!0,this.dragControl.handlers.drag.start=t,this.dragControl.handlers.drag.last=t))},dragVertex:function(e,t){this.modified=!0,"OpenLayers.Geometry.Point"==this.feature.geometry.CLASS_NAME?(this.feature!=e&&(this.feature=e),this.layer.events.triggerEvent("vertexmodified",{vertex:e.geometry,feature:this.feature,pixel:t})):(e._index?(e.geometry.parent.addComponent(e.geometry,e._index),delete e._index,OpenLayers.Util.removeItem(this.virtualVertices,e),this.vertices.push(e)):e==this.dragHandle?(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null)):e!==this.radiusHandle&&this.layer.events.triggerEvent("vertexmodified",{vertex:e.geometry,feature:this.feature,pixel:t}),this.virtualVertices.length>0&&(this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.layer.drawFeature(this.feature,this.standalone?void 0:this.selectControl.renderIntent)),this.layer.drawFeature(e)
},dragComplete:function(){this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature})},setFeatureState:function(){if(this.feature.state!=OpenLayers.State.INSERT&&this.feature.state!=OpenLayers.State.DELETE&&(this.feature.state=OpenLayers.State.UPDATE,this.modified&&this._originalGeometry)){var e=this.feature;e.modified=OpenLayers.Util.extend(e.modified,{geometry:this._originalGeometry}),delete this._originalGeometry}},resetVertices:function(){this.dragControl.feature&&this.dragControl.outFeature(this.dragControl.feature),this.vertices.length>0&&(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[]),this.virtualVertices.length>0&&(this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),this.dragHandle=null),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null),this.feature&&"OpenLayers.Geometry.Point"!=this.feature.geometry.CLASS_NAME&&(this.mode&OpenLayers.Control.ModifyFeature.DRAG&&this.collectDragHandle(),this.mode&(OpenLayers.Control.ModifyFeature.ROTATE|OpenLayers.Control.ModifyFeature.RESIZE)&&this.collectRadiusHandle(),this.mode&OpenLayers.Control.ModifyFeature.RESHAPE&&(this.mode&OpenLayers.Control.ModifyFeature.RESIZE||this.collectVertices()))},handleKeypress:function(e){var t=e.keyCode;if(this.feature&&-1!=OpenLayers.Util.indexOf(this.deleteCodes,t)){var i=this.dragControl.feature;i&&-1!=OpenLayers.Util.indexOf(this.vertices,i)&&!this.dragControl.handlers.drag.dragging&&i.geometry.parent&&(i.geometry.parent.removeComponent(i.geometry),this.layer.events.triggerEvent("vertexremoved",{vertex:i.geometry,feature:this.feature,pixel:e.xy}),this.layer.drawFeature(this.feature,this.standalone?void 0:this.selectControl.renderIntent),this.modified=!0,this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature}))}},collectVertices:function(){function e(i){var a,n,s,r;if("OpenLayers.Geometry.Point"==i.CLASS_NAME)n=new OpenLayers.Feature.Vector(i),n._sketch=!0,n.renderIntent=t.vertexRenderIntent,t.vertices.push(n);else{var o=i.components.length;for("OpenLayers.Geometry.LinearRing"==i.CLASS_NAME&&(o-=1),a=0;o>a;++a)s=i.components[a],"OpenLayers.Geometry.Point"==s.CLASS_NAME?(n=new OpenLayers.Feature.Vector(s),n._sketch=!0,n.renderIntent=t.vertexRenderIntent,t.vertices.push(n)):e(s);if(t.createVertices&&"OpenLayers.Geometry.MultiPoint"!=i.CLASS_NAME)for(a=0,r=i.components.length;r-1>a;++a){var l=i.components[a],u=i.components[a+1];if("OpenLayers.Geometry.Point"==l.CLASS_NAME&&"OpenLayers.Geometry.Point"==u.CLASS_NAME){var c=(l.x+u.x)/2,h=(l.y+u.y)/2,d=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(c,h),null,t.virtualStyle);d.geometry.parent=i,d._index=a+1,d._sketch=!0,t.virtualVertices.push(d)}}}}this.vertices=[],this.virtualVertices=[];var t=this;e.call(this,this.feature.geometry),this.layer.addFeatures(this.virtualVertices,{silent:!0}),this.layer.addFeatures(this.vertices,{silent:!0})},collectDragHandle:function(){var e=this.feature.geometry,t=e.getBounds().getCenterLonLat(),i=new OpenLayers.Geometry.Point(t.lon,t.lat),a=new OpenLayers.Feature.Vector(i);i.move=function(t,i){OpenLayers.Geometry.Point.prototype.move.call(this,t,i),e.move(t,i)},a._sketch=!0,this.dragHandle=a,this.dragHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.dragHandle],{silent:!0})},collectRadiusHandle:function(){var e=this.feature.geometry,t=e.getBounds(),i=t.getCenterLonLat(),a=new OpenLayers.Geometry.Point(i.lon,i.lat),n=new OpenLayers.Geometry.Point(t.right,t.bottom),s=new OpenLayers.Feature.Vector(n),r=this.mode&OpenLayers.Control.ModifyFeature.RESIZE,o=this.mode&OpenLayers.Control.ModifyFeature.RESHAPE,l=this.mode&OpenLayers.Control.ModifyFeature.ROTATE;n.move=function(t,i){OpenLayers.Geometry.Point.prototype.move.call(this,t,i);var n=this.x-a.x,s=this.y-a.y,u=n-t,c=s-i;if(l){var h=Math.atan2(c,u),d=Math.atan2(s,n),p=d-h;p*=180/Math.PI,e.rotate(p,a)}if(r){var f,m;if(o)f=s/c,m=n/u/f;else{var g=Math.sqrt(u*u+c*c),y=Math.sqrt(n*n+s*s);f=y/g}e.resize(f,a,m)}},s._sketch=!0,this.radiusHandle=s,this.radiusHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.radiusHandle],{silent:!0})},setMap:function(e){this.standalone||this.selectControl.setMap(e),this.dragControl.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.ModifyFeature"}),OpenLayers.Control.ModifyFeature.RESHAPE=1,OpenLayers.Control.ModifyFeature.RESIZE=2,OpenLayers.Control.ModifyFeature.ROTATE=4,OpenLayers.Control.ModifyFeature.DRAG=8,OpenLayers.Control.SelectFeature=OpenLayers.Class(OpenLayers.Control,{multipleKey:null,toggleKey:null,multiple:!1,clickout:!0,toggle:!1,hover:!1,highlightOnly:!1,box:!1,onBeforeSelect:function(){},onSelect:function(){},onUnselect:function(){},scope:null,geometryTypes:null,layer:null,layers:null,callbacks:null,selectStyle:null,renderIntent:"select",handlers:null,initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]),null===this.scope&&(this.scope=this),this.initLayer(e);var i={click:this.clickFeature,clickout:this.clickoutFeature};this.hover&&(i.over=this.overFeature,i.out=this.outFeature),this.callbacks=OpenLayers.Util.extend(i,this.callbacks),this.handlers={feature:new OpenLayers.Handler.Feature(this,this.layer,this.callbacks,{geometryTypes:this.geometryTypes})},this.box&&(this.handlers.box=new OpenLayers.Handler.Box(this,{done:this.selectBox},{boxDivClassName:"olHandlerBoxSelectFeature"}))},initLayer:function(e){OpenLayers.Util.isArray(e)?(this.layers=e,this.layer=new OpenLayers.Layer.Vector.RootContainer(this.id+"_container",{layers:e})):this.layer=e},destroy:function(){this.active&&this.layers&&this.map.removeLayer(this.layer),OpenLayers.Control.prototype.destroy.apply(this,arguments),this.layers&&this.layer.destroy()},activate:function(){return this.active||(this.layers&&this.map.addLayer(this.layer),this.handlers.feature.activate(),this.box&&this.handlers.box&&this.handlers.box.activate()),OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.active&&(this.handlers.feature.deactivate(),this.handlers.box&&this.handlers.box.deactivate(),this.layers&&this.map.removeLayer(this.layer)),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},unselectAll:function(e){for(var t,i,a=this.layers||[this.layer],n=0;n<a.length;++n){t=a[n];for(var s=t.selectedFeatures.length-1;s>=0;--s)i=t.selectedFeatures[s],e&&e.except==i||this.unselect(i)}},clickFeature:function(e){if(!this.hover){var t=OpenLayers.Util.indexOf(e.layer.selectedFeatures,e)>-1;t?this.toggleSelect()?this.unselect(e):this.multipleSelect()||this.unselectAll({except:e}):(this.multipleSelect()||this.unselectAll({except:e}),this.select(e))}},multipleSelect:function(){return this.multiple||this.handlers.feature.evt&&this.handlers.feature.evt[this.multipleKey]},toggleSelect:function(){return this.toggle||this.handlers.feature.evt&&this.handlers.feature.evt[this.toggleKey]},clickoutFeature:function(){!this.hover&&this.clickout&&this.unselectAll()},overFeature:function(e){var t=e.layer;this.hover&&(this.highlightOnly?this.highlight(e):-1==OpenLayers.Util.indexOf(t.selectedFeatures,e)&&this.select(e))},outFeature:function(e){if(this.hover)if(this.highlightOnly){if(e._lastHighlighter==this.id)if(e._prevHighlighter&&e._prevHighlighter!=this.id){delete e._lastHighlighter;var t=this.map.getControl(e._prevHighlighter);t&&t.highlight(e)}else this.unhighlight(e)}else this.unselect(e)},highlight:function(e){var t=e.layer,i=this.events.triggerEvent("beforefeaturehighlighted",{feature:e});if(i!==!1){e._prevHighlighter=e._lastHighlighter,e._lastHighlighter=this.id;var a=this.selectStyle||this.renderIntent;t.drawFeature(e,a),this.events.triggerEvent("featurehighlighted",{feature:e})}},unhighlight:function(e){var t=e.layer;void 0==e._prevHighlighter?delete e._lastHighlighter:e._prevHighlighter==this.id?delete e._prevHighlighter:(e._lastHighlighter=e._prevHighlighter,delete e._prevHighlighter),t.drawFeature(e,e.style||e.layer.style||"default"),this.events.triggerEvent("featureunhighlighted",{feature:e})},select:function(e){var t=this.onBeforeSelect.call(this.scope,e),i=e.layer;t!==!1&&(t=i.events.triggerEvent("beforefeatureselected",{feature:e}),t!==!1&&(i.selectedFeatures.push(e),this.highlight(e),this.handlers.feature.lastFeature||(this.handlers.feature.lastFeature=i.selectedFeatures[0]),i.events.triggerEvent("featureselected",{feature:e}),this.onSelect.call(this.scope,e)))},unselect:function(e){var t=e.layer;this.unhighlight(e),OpenLayers.Util.removeItem(t.selectedFeatures,e),t.events.triggerEvent("featureunselected",{feature:e}),this.onUnselect.call(this.scope,e)},selectBox:function(e){if(e instanceof OpenLayers.Bounds){var t=this.map.getLonLatFromPixel({x:e.left,y:e.bottom}),i=this.map.getLonLatFromPixel({x:e.right,y:e.top}),a=new OpenLayers.Bounds(t.lon,t.lat,i.lon,i.lat);this.multipleSelect()||this.unselectAll();var n=this.multiple;this.multiple=!0;var s=this.layers||[this.layer];this.events.triggerEvent("boxselectionstart",{layers:s});for(var r,o=0;o<s.length;++o){r=s[o];for(var l=0,u=r.features.length;u>l;++l){var c=r.features[l];c.getVisibility()&&(null==this.geometryTypes||OpenLayers.Util.indexOf(this.geometryTypes,c.geometry.CLASS_NAME)>-1)&&a.toGeometry().intersects(c.geometry)&&-1==OpenLayers.Util.indexOf(r.selectedFeatures,c)&&this.select(c)}}this.multiple=n,this.events.triggerEvent("boxselectionend",{layers:s})}},setMap:function(e){this.handlers.feature.setMap(e),this.box&&this.handlers.box.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},setLayer:function(e){var t=this.active;this.unselectAll(),this.deactivate(),this.layers&&(this.layer.destroy(),this.layers=null),this.initLayer(e),this.handlers.feature.layer=this.layer,t&&this.activate()},CLASS_NAME:"OpenLayers.Control.SelectFeature"}),OpenLayers.Control.ScaleLine=OpenLayers.Class(OpenLayers.Control,{maxWidth:100,topOutUnits:"km",topInUnits:"m",bottomOutUnits:"mi",bottomInUnits:"ft",eTop:null,eBottom:null,geodesic:!1,draw:function(){return OpenLayers.Control.prototype.draw.apply(this,arguments),this.eTop||(this.eTop=document.createElement("div"),this.eTop.className=this.displayClass+"Top",this.topInUnits.length,this.div.appendChild(this.eTop),this.eTop.style.visibility=""==this.topOutUnits||""==this.topInUnits?"hidden":"visible",this.eBottom=document.createElement("div"),this.eBottom.className=this.displayClass+"Bottom",this.div.appendChild(this.eBottom),this.eBottom.style.visibility=""==this.bottomOutUnits||""==this.bottomInUnits?"hidden":"visible"),this.map.events.register("moveend",this,this.update),this.update(),this.div},getBarLen:function(e){var t,i=parseInt(Math.log(e)/Math.log(10)),a=Math.pow(10,i),n=parseInt(e/a);return t=n>5?5:n>2?2:1,t*a},update:function(){var e=this.map.getResolution();if(e){var t=this.map.getUnits(),i=OpenLayers.INCHES_PER_UNIT,a=this.maxWidth*e*i[t],n=1;if(this.geodesic===!0){var s=(this.map.getGeodesicPixelSize().w||1e-6)*this.maxWidth,r=a/i.km;n=s/r,a*=n}var o,l;a>1e5?(o=this.topOutUnits,l=this.bottomOutUnits):(o=this.topInUnits,l=this.bottomInUnits);var u=a/i[o],c=a/i[l],h=this.getBarLen(u),d=this.getBarLen(c);u=h/i[t]*i[o],c=d/i[t]*i[l];var p=u/e/n,f=c/e/n;"visible"==this.eBottom.style.visibility&&(this.eBottom.style.width=Math.round(f)+"px",this.eBottom.innerHTML=d+" "+l),"visible"==this.eTop.style.visibility&&(this.eTop.style.width=Math.round(p)+"px",this.eTop.innerHTML=h+" "+o)}},CLASS_NAME:"OpenLayers.Control.ScaleLine"}),OpenLayers.Control.Navigation=OpenLayers.Class(OpenLayers.Control,{dragPan:null,dragPanOptions:null,pinchZoom:null,pinchZoomOptions:null,documentDrag:!1,zoomBox:null,zoomBoxEnabled:!0,zoomWheelEnabled:!0,mouseWheelOptions:null,handleRightClicks:!1,zoomBoxKeyMask:OpenLayers.Handler.MOD_SHIFT,autoActivate:!0,initialize:function(){this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate(),this.dragPan&&this.dragPan.destroy(),this.dragPan=null,this.zoomBox&&this.zoomBox.destroy(),this.zoomBox=null,this.pinchZoom&&this.pinchZoom.destroy(),this.pinchZoom=null,OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){return this.dragPan.activate(),this.zoomWheelEnabled&&this.handlers.wheel.activate(),this.handlers.click.activate(),this.zoomBoxEnabled&&this.zoomBox.activate(),this.pinchZoom&&this.pinchZoom.activate(),OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.pinchZoom&&this.pinchZoom.deactivate(),this.zoomBox.deactivate(),this.dragPan.deactivate(),this.handlers.click.deactivate(),this.handlers.wheel.deactivate(),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},draw:function(){this.handleRightClicks&&(this.map.viewPortDiv.oncontextmenu=OpenLayers.Function.False);var e={click:this.defaultClick,dblclick:this.defaultDblClick,dblrightclick:this.defaultDblRightClick},t={"double":!0,stopDouble:!0};this.handlers.click=new OpenLayers.Handler.Click(this,e,t),this.dragPan=new OpenLayers.Control.DragPan(OpenLayers.Util.extend({map:this.map,documentDrag:this.documentDrag},this.dragPanOptions)),this.zoomBox=new OpenLayers.Control.ZoomBox({map:this.map,keyMask:this.zoomBoxKeyMask}),this.dragPan.draw(),this.zoomBox.draw(),this.handlers.wheel=new OpenLayers.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown},this.mouseWheelOptions),OpenLayers.Control.PinchZoom&&(this.pinchZoom=new OpenLayers.Control.PinchZoom(OpenLayers.Util.extend({map:this.map},this.pinchZoomOptions)))},defaultClick:function(e){e.lastTouches&&2==e.lastTouches.length&&this.map.zoomOut()},defaultDblClick:function(e){var t=this.map.getLonLatFromViewPortPx(e.xy);this.map.setCenter(t,this.map.zoom+1)},defaultDblRightClick:function(e){var t=this.map.getLonLatFromViewPortPx(e.xy);this.map.setCenter(t,this.map.zoom-1)},wheelChange:function(e,t){var i=this.map.getZoom(),a=this.map.getZoom()+Math.round(t);if(a=Math.max(a,0),a=Math.min(a,this.map.getNumZoomLevels()),a!==i){var n=this.map.getSize(),s=n.w/2-e.xy.x,r=e.xy.y-n.h/2,o=this.map.baseLayer.getResolutionForZoom(a),l=this.map.getLonLatFromPixel(e.xy),u=new OpenLayers.LonLat(l.lon+s*o,l.lat+r*o);this.map.setCenter(u,a)}},wheelUp:function(e,t){this.wheelChange(e,t||1)},wheelDown:function(e,t){this.wheelChange(e,t||-1)},disableZoomBox:function(){this.zoomBoxEnabled=!1,this.zoomBox.deactivate()},enableZoomBox:function(){this.zoomBoxEnabled=!0,this.active&&this.zoomBox.activate()},disableZoomWheel:function(){this.zoomWheelEnabled=!1,this.handlers.wheel.deactivate()},enableZoomWheel:function(){this.zoomWheelEnabled=!0,this.active&&this.handlers.wheel.activate()},CLASS_NAME:"OpenLayers.Control.Navigation"}),OpenLayers.Control.NavigationHistory=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOGGLE,previous:null,previousOptions:null,next:null,nextOptions:null,limit:50,autoActivate:!0,clearOnDeactivate:!1,registry:null,nextStack:null,previousStack:null,listeners:null,restoring:!1,initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,[e]),this.registry=OpenLayers.Util.extend({moveend:this.getState},this.registry);var t={trigger:OpenLayers.Function.bind(this.previousTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Previous"};OpenLayers.Util.extend(t,this.previousOptions),this.previous=new OpenLayers.Control.Button(t);var i={trigger:OpenLayers.Function.bind(this.nextTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Next"};OpenLayers.Util.extend(i,this.nextOptions),this.next=new OpenLayers.Control.Button(i),this.clear()},onPreviousChange:function(e){e&&!this.previous.active?this.previous.activate():!e&&this.previous.active&&this.previous.deactivate()},onNextChange:function(e){e&&!this.next.active?this.next.activate():!e&&this.next.active&&this.next.deactivate()},destroy:function(){OpenLayers.Control.prototype.destroy.apply(this),this.previous.destroy(),this.next.destroy(),this.deactivate();for(var e in this)this[e]=null},setMap:function(e){this.map=e,this.next.setMap(e),this.previous.setMap(e)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments),this.next.draw(),this.previous.draw()},previousTrigger:function(){var e=this.previousStack.shift(),t=this.previousStack.shift();return void 0!=t?(this.nextStack.unshift(e),this.previousStack.unshift(t),this.restoring=!0,this.restore(t),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)):this.previousStack.unshift(e),t},nextTrigger:function(){var e=this.nextStack.shift();return void 0!=e&&(this.previousStack.unshift(e),this.restoring=!0,this.restore(e),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)),e},clear:function(){this.previousStack=[],this.previous.deactivate(),this.nextStack=[],this.next.deactivate()},getState:function(){return{center:this.map.getCenter(),resolution:this.map.getResolution(),projection:this.map.getProjectionObject(),units:this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units}},restore:function(e){var t,i;if(this.map.getProjectionObject()==e.projection)i=this.map.getZoomForResolution(e.resolution),t=e.center;else{t=e.center.clone(),t.transform(e.projection,this.map.getProjectionObject());var a=e.units,n=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,s=a&&n?OpenLayers.INCHES_PER_UNIT[a]/OpenLayers.INCHES_PER_UNIT[n]:1;i=this.map.getZoomForResolution(s*e.resolution)}this.map.setCenter(t,i)},setListeners:function(){this.listeners={};for(var e in this.registry)this.listeners[e]=OpenLayers.Function.bind(function(){if(!this.restoring){var t=this.registry[e].apply(this,arguments);this.previousStack.unshift(t),this.previousStack.length>1&&this.onPreviousChange(this.previousStack[1],this.previousStack.length-1),this.previousStack.length>this.limit+1&&this.previousStack.pop(),this.nextStack.length>0&&(this.nextStack=[],this.onNextChange(null,0))}return!0},this)},activate:function(){var e=!1;if(this.map&&OpenLayers.Control.prototype.activate.apply(this)){null==this.listeners&&this.setListeners();for(var t in this.listeners)this.map.events.register(t,this,this.listeners[t]);e=!0,0==this.previousStack.length&&this.initStack()}return e},initStack:function(){this.map.getCenter()&&this.listeners.moveend()},deactivate:function(){var e=!1;if(this.map&&OpenLayers.Control.prototype.deactivate.apply(this)){for(var t in this.listeners)this.map.events.unregister(t,this,this.listeners[t]);this.clearOnDeactivate&&this.clear(),e=!0}return e},CLASS_NAME:"OpenLayers.Control.NavigationHistory"}),OpenLayers.Control.Measure=OpenLayers.Class(OpenLayers.Control,{handlerOptions:null,callbacks:null,displaySystem:"metric",geodesic:!1,displaySystemUnits:{geographic:["dd"],english:["mi","ft","in"],metric:["km","m"]},partialDelay:300,delayedTrigger:null,persist:!1,immediate:!1,initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]);var i={done:this.measureComplete,point:this.measurePartial};this.immediate&&(i.modify=this.measureImmediate),this.callbacks=OpenLayers.Util.extend(i,this.callbacks),this.handlerOptions=OpenLayers.Util.extend({persist:this.persist},this.handlerOptions),this.handler=new e(this,this.callbacks,this.handlerOptions)},deactivate:function(){return this.cancelDelay(),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},cancel:function(){this.cancelDelay(),this.handler.cancel()},setImmediate:function(e){this.immediate=e,this.immediate?this.callbacks.modify=this.measureImmediate:delete this.callbacks.modify},updateHandler:function(e,t){var i=this.active;i&&this.deactivate(),this.handler=new e(this,this.callbacks,t),i&&this.activate()},measureComplete:function(e){this.cancelDelay(),this.measure(e,"measure")},measurePartial:function(e,t){this.cancelDelay(),t=t.clone(),this.handler.freehandMode(this.handler.evt)?this.measure(t,"measurepartial"):this.delayedTrigger=window.setTimeout(OpenLayers.Function.bind(function(){this.delayedTrigger=null,this.measure(t,"measurepartial")},this),this.partialDelay)},measureImmediate:function(e,t,i){i&&!this.handler.freehandMode(this.handler.evt)&&(this.cancelDelay(),this.measure(t.geometry,"measurepartial"))},cancelDelay:function(){null!==this.delayedTrigger&&(window.clearTimeout(this.delayedTrigger),this.delayedTrigger=null)},measure:function(e,t){var i,a;e.CLASS_NAME.indexOf("LineString")>-1?(i=this.getBestLength(e),a=1):(i=this.getBestArea(e),a=2),this.events.triggerEvent(t,{measure:i[0],units:i[1],order:a,geometry:e})},getBestArea:function(e){for(var t,i,a=this.displaySystemUnits[this.displaySystem],n=0,s=a.length;s>n&&(t=a[n],i=this.getArea(e,t),!(i>1));++n);return[i,t]},getArea:function(e,t){var i,a;this.geodesic?(i=e.getGeodesicArea(this.map.getProjectionObject()),a="m"):(i=e.getArea(),a=this.map.getUnits());var n=OpenLayers.INCHES_PER_UNIT[t];if(n){var s=OpenLayers.INCHES_PER_UNIT[a];i*=Math.pow(s/n,2)}return i},getBestLength:function(e){for(var t,i,a=this.displaySystemUnits[this.displaySystem],n=0,s=a.length;s>n&&(t=a[n],i=this.getLength(e,t),!(i>1));++n);return[i,t]},getLength:function(e,t){var i,a;this.geodesic?(i=e.getGeodesicLength(this.map.getProjectionObject()),a="m"):(i=e.getLength(),a=this.map.getUnits());var n=OpenLayers.INCHES_PER_UNIT[t];if(n){var s=OpenLayers.INCHES_PER_UNIT[a];i*=s/n}return i},CLASS_NAME:"OpenLayers.Control.Measure"}),OpenLayers.Control.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,drillDown:!1,maxFeatures:10,clickCallback:"click",output:"features",layers:null,queryVisible:!1,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handlerOptions:null,handler:null,hoverRequest:null,initialize:function(e){if(e=e||{},e.handlerOptions=e.handlerOptions||{},OpenLayers.Control.prototype.initialize.apply(this,[e]),this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(e.formatOptions)),this.drillDown===!0&&(this.hover=!1),this.hover)this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var t={};t[this.clickCallback]=this.getInfoForClick,this.handler=new OpenLayers.Handler.Click(this,t,this.handlerOptions.click||{})}},getInfoForClick:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy}),OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait"),this.request(e.xy,{})},getInfoForHover:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy}),this.request(e.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&&(this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var e,t,i=this.layers||this.map.layers,a=[],n=i.length-1;n>=0;--n)e=i[n],e instanceof OpenLayers.Layer.WMS&&(!this.queryVisible||e.getVisibility())&&(t=OpenLayers.Util.isArray(e.url)?e.url[0]:e.url,this.drillDown!==!1||this.url||(this.url=t),(this.drillDown===!0||this.urlMatches(t))&&a.push(e));return a},urlMatches:function(e){var t=OpenLayers.Util.isEquivalentUrl(this.url,e);if(!t&&this.layerUrls)for(var i=0,a=this.layerUrls.length;a>i;++i)if(OpenLayers.Util.isEquivalentUrl(this.layerUrls[i],e)){t=!0;break}return t},buildWMSOptions:function(e,t,i,a){for(var n=[],s=[],r=0,o=t.length;o>r;r++)null!=t[r].params.LAYERS&&(n=n.concat(t[r].params.LAYERS),s=s.concat(this.getStyleNames(t[r])));var l=t[0],u=this.map.getProjection(),c=l.projection;c&&c.equals(this.map.getProjectionObject())&&(u=c.getCode());var h=OpenLayers.Util.extend({service:"WMS",version:l.params.VERSION,request:"GetFeatureInfo",exceptions:l.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,l.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:a,info_format:l.params.INFO_FORMAT||this.infoFormat},parseFloat(l.params.VERSION)>=1.3?{crs:u,i:parseInt(i.x),j:parseInt(i.y)}:{srs:u,x:parseInt(i.x),y:parseInt(i.y)});return 0!=n.length&&(h=OpenLayers.Util.extend({layers:n,query_layers:n,styles:s},h)),OpenLayers.Util.applyDefaults(h,this.vendorParams),{url:e,params:OpenLayers.Util.upperCaseObject(h),callback:function(t){this.handleResponse(i,t,e)},scope:this}},getStyleNames:function(e){var t;return t=e.params.STYLES?e.params.STYLES:OpenLayers.Util.isArray(e.params.LAYERS)?new Array(e.params.LAYERS.length):e.params.LAYERS.replace(/[^,]/g,"")},request:function(e,t){var i=this.findLayers();if(0==i.length)return this.events.triggerEvent("nogetfeatureinfo"),OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),void 0;if(t=t||{},this.drillDown===!1){var a=this.buildWMSOptions(this.url,i,e,i[0].params.FORMAT),n=OpenLayers.Request.GET(a);t.hover===!0&&(this.hoverRequest=n)}else{this._requestCount=0,this._numRequests=0,this.features=[];for(var s,r={},o=0,l=i.length;l>o;o++){var u=i[o];s=OpenLayers.Util.isArray(u.url)?u.url[0]:u.url,s in r?r[s].push(u):(this._numRequests++,r[s]=[u])}var i;for(var s in r){i=r[s];var a=this.buildWMSOptions(s,i,e,i[0].params.FORMAT);OpenLayers.Request.GET(a)}}},triggerGetFeatureInfo:function(e,t,i){this.events.triggerEvent("getfeatureinfo",{text:e.responseText,features:i,request:e,xy:t}),OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},handleResponse:function(e,t,i){var a=t.responseXML;a&&a.documentElement||(a=t.responseText);var n=this.format.read(a);this.drillDown===!1?this.triggerGetFeatureInfo(t,e,n):(this._requestCount++,this._features="object"===this.output?(this._features||[]).concat({url:i,features:n}):(this._features||[]).concat(n),this._requestCount===this._numRequests&&(this.triggerGetFeatureInfo(t,e,this._features.concat()),delete this._features,delete this._requestCount,delete this._numRequests))},CLASS_NAME:"OpenLayers.Control.WMSGetFeatureInfo"}),OpenLayers.Geometry=OpenLayers.Class({id:null,parent:null,bounds:null,initialize:function(){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){this.id=null,this.bounds=null},clone:function(){return new OpenLayers.Geometry},setBounds:function(e){e&&(this.bounds=e.clone())},clearBounds:function(){this.bounds=null,this.parent&&this.parent.clearBounds()},extendBounds:function(e){var t=this.getBounds();t?this.bounds.extend(e):this.setBounds(e)},getBounds:function(){return null==this.bounds&&this.calculateBounds(),this.bounds},calculateBounds:function(){},distanceTo:function(){},getVertices:function(){},atPoint:function(e,t,i){var a=!1,n=this.getBounds();if(null!=n&&null!=e){var s=null!=t?t:0,r=null!=i?i:0,o=new OpenLayers.Bounds(this.bounds.left-s,this.bounds.bottom-r,this.bounds.right+s,this.bounds.top+r);a=o.containsLonLat(e)}return a},getLength:function(){return 0},getArea:function(){return 0},getCentroid:function(){return null},toString:function(){var e;return e=OpenLayers.Format&&OpenLayers.Format.WKT?OpenLayers.Format.WKT.prototype.write(new OpenLayers.Feature.Vector(this)):Object.prototype.toString.call(this)},CLASS_NAME:"OpenLayers.Geometry"}),OpenLayers.Geometry.fromWKT=function(e){var t;if(OpenLayers.Format&&OpenLayers.Format.WKT){var i=OpenLayers.Geometry.fromWKT.format;i||(i=new OpenLayers.Format.WKT,OpenLayers.Geometry.fromWKT.format=i);var a=i.read(e);if(a instanceof OpenLayers.Feature.Vector)t=a.geometry;else if(OpenLayers.Util.isArray(a)){for(var n=a.length,s=new Array(n),r=0;n>r;++r)s[r]=a[r].geometry;t=new OpenLayers.Geometry.Collection(s)}}return t},OpenLayers.Geometry.segmentsIntersect=function(e,t,i){var a=i&&i.point,n=i&&i.tolerance,s=!1,r=e.x1-t.x1,o=e.y1-t.y1,l=e.x2-e.x1,u=e.y2-e.y1,c=t.y2-t.y1,h=t.x2-t.x1,d=c*l-h*u,p=h*o-c*r,f=l*o-u*r;if(0==d)0==p&&0==f&&(s=!0);else{var m=p/d,g=f/d;if(m>=0&&1>=m&&g>=0&&1>=g)if(a){var y=e.x1+m*l,v=e.y1+m*u;s=new OpenLayers.Geometry.Point(y,v)}else s=!0}if(n){var b;if(s){if(a){var _,y,v,k=[e,t];e:for(var L=0;2>L;++L){_=k[L];for(var w=1;3>w;++w)if(y=_["x"+w],v=_["y"+w],b=Math.sqrt(Math.pow(y-s.x,2)+Math.pow(v-s.y,2)),n>b){s.x=y,s.y=v;break e}}}}else{var O,x,y,v,S,C,k=[e,t];e:for(var L=0;2>L;++L){O=k[L],x=k[(L+1)%2];for(var w=1;3>w;++w)if(S={x:O["x"+w],y:O["y"+w]},C=OpenLayers.Geometry.distanceToSegment(S,x),C.distance<n){s=a?new OpenLayers.Geometry.Point(S.x,S.y):!0;break e}}}}return s},OpenLayers.Geometry.distanceToSegment=function(e,t){var i,a,n=e.x,s=e.y,r=t.x1,o=t.y1,l=t.x2,u=t.y2,c=l-r,h=u-o,d=(c*(n-r)+h*(s-o))/(Math.pow(c,2)+Math.pow(h,2));return 0>=d?(i=r,a=o):d>=1?(i=l,a=u):(i=r+d*c,a=o+d*h),{distance:Math.sqrt(Math.pow(i-n,2)+Math.pow(a-s,2)),x:i,y:a}},OpenLayers.Geometry.Collection=OpenLayers.Class(OpenLayers.Geometry,{components:null,componentTypes:null,initialize:function(e){OpenLayers.Geometry.prototype.initialize.apply(this,arguments),this.components=[],null!=e&&this.addComponents(e)},destroy:function(){this.components.length=0,this.components=null,OpenLayers.Geometry.prototype.destroy.apply(this,arguments)},clone:function(){for(var geometry=eval("new "+this.CLASS_NAME+"()"),i=0,len=this.components.length;len>i;i++)geometry.addComponent(this.components[i].clone());return OpenLayers.Util.applyDefaults(geometry,this),geometry},getComponentsString:function(){for(var e=[],t=0,i=this.components.length;i>t;t++)e.push(this.components[t].toShortString());return e.join(",")},calculateBounds:function(){this.bounds=null;var e=new OpenLayers.Bounds,t=this.components;if(t)for(var i=0,a=t.length;a>i;i++)e.extend(t[i].getBounds());null!=e.left&&null!=e.bottom&&null!=e.right&&null!=e.top&&this.setBounds(e)},addComponents:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0,i=e.length;i>t;t++)this.addComponent(e[t])},addComponent:function(e,t){var i=!1;if(e&&(null==this.componentTypes||OpenLayers.Util.indexOf(this.componentTypes,e.CLASS_NAME)>-1)){if(null!=t&&t<this.components.length){var a=this.components.slice(0,t),n=this.components.slice(t,this.components.length);a.push(e),this.components=a.concat(n)}else this.components.push(e);e.parent=this,this.clearBounds(),i=!0}return i},removeComponents:function(e){var t=!1;OpenLayers.Util.isArray(e)||(e=[e]);for(var i=e.length-1;i>=0;--i)t=this.removeComponent(e[i])||t;return t},removeComponent:function(e){return OpenLayers.Util.removeItem(this.components,e),this.clearBounds(),!0},getLength:function(){for(var e=0,t=0,i=this.components.length;i>t;t++)e+=this.components[t].getLength();return e},getArea:function(){for(var e=0,t=0,i=this.components.length;i>t;t++)e+=this.components[t].getArea();return e},getGeodesicArea:function(e){for(var t=0,i=0,a=this.components.length;a>i;i++)t+=this.components[i].getGeodesicArea(e);return t},getCentroid:function(e){if(!e)return this.components.length&&this.components[0].getCentroid();var t=this.components.length;if(!t)return!1;for(var i,a=[],n=[],s=0,r=Number.MAX_VALUE,o=0;t>o;++o){i=this.components[o];var l=i.getArea(),u=i.getCentroid(!0);isNaN(l)||isNaN(u.x)||isNaN(u.y)||(a.push(l),s+=l,r=r>l&&l>0?l:r,n.push(u))}if(t=a.length,0===s){for(var o=0;t>o;++o)a[o]=1;s=a.length}else{for(var o=0;t>o;++o)a[o]/=r;s/=r}for(var u,l,c=0,h=0,o=0;t>o;++o)u=n[o],l=a[o],c+=u.x*l,h+=u.y*l;return new OpenLayers.Geometry.Point(c/s,h/s)},getGeodesicLength:function(e){for(var t=0,i=0,a=this.components.length;a>i;i++)t+=this.components[i].getGeodesicLength(e);return t},move:function(e,t){for(var i=0,a=this.components.length;a>i;i++)this.components[i].move(e,t)},rotate:function(e,t){for(var i=0,a=this.components.length;a>i;++i)this.components[i].rotate(e,t)},resize:function(e,t,i){for(var a=0;a<this.components.length;++a)this.components[a].resize(e,t,i);return this},distanceTo:function(e,t){for(var i,a,n,s=!(t&&t.edge===!1),r=s&&t&&t.details,o=Number.POSITIVE_INFINITY,l=0,u=this.components.length;u>l&&(i=this.components[l].distanceTo(e,t),n=r?i.distance:i,!(o>n&&(o=n,a=i,0==o)));++l);return a
},equals:function(e){var t=!0;if(e&&e.CLASS_NAME&&this.CLASS_NAME==e.CLASS_NAME)if(OpenLayers.Util.isArray(e.components)&&e.components.length==this.components.length){for(var i=0,a=this.components.length;a>i;++i)if(!this.components[i].equals(e.components[i])){t=!1;break}}else t=!1;else t=!1;return t},transform:function(e,t){if(e&&t){for(var i=0,a=this.components.length;a>i;i++){var n=this.components[i];n.transform(e,t)}this.bounds=null}return this},intersects:function(e){for(var t=!1,i=0,a=this.components.length;a>i&&!(t=e.intersects(this.components[i]));++i);return t},getVertices:function(e){for(var t=[],i=0,a=this.components.length;a>i;++i)Array.prototype.push.apply(t,this.components[i].getVertices(e));return t},CLASS_NAME:"OpenLayers.Geometry.Collection"}),OpenLayers.Geometry.Point=OpenLayers.Class(OpenLayers.Geometry,{x:null,y:null,initialize:function(e,t){OpenLayers.Geometry.prototype.initialize.apply(this,arguments),this.x=parseFloat(e),this.y=parseFloat(t)},clone:function(e){return null==e&&(e=new OpenLayers.Geometry.Point(this.x,this.y)),OpenLayers.Util.applyDefaults(e,this),e},calculateBounds:function(){this.bounds=new OpenLayers.Bounds(this.x,this.y,this.x,this.y)},distanceTo:function(e,t){var i,a,n,s,r,o,l=!(t&&t.edge===!1),u=l&&t&&t.details;return e instanceof OpenLayers.Geometry.Point?(a=this.x,n=this.y,s=e.x,r=e.y,i=Math.sqrt(Math.pow(a-s,2)+Math.pow(n-r,2)),o=u?{x0:a,y0:n,x1:s,y1:r,distance:i}:i):(o=e.distanceTo(this,t),u&&(o={x0:o.x1,y0:o.y1,x1:o.x0,y1:o.y0,distance:o.distance})),o},equals:function(e){var t=!1;return null!=e&&(t=this.x==e.x&&this.y==e.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(e.x)&&isNaN(e.y)),t},toShortString:function(){return this.x+", "+this.y},move:function(e,t){this.x=this.x+e,this.y=this.y+t,this.clearBounds()},rotate:function(e,t){e*=Math.PI/180;var i=this.distanceTo(t),a=e+Math.atan2(this.y-t.y,this.x-t.x);this.x=t.x+i*Math.cos(a),this.y=t.y+i*Math.sin(a),this.clearBounds()},getCentroid:function(){return new OpenLayers.Geometry.Point(this.x,this.y)},resize:function(e,t,i){return i=void 0==i?1:i,this.x=t.x+e*i*(this.x-t.x),this.y=t.y+e*(this.y-t.y),this.clearBounds(),this},intersects:function(e){var t=!1;return t="OpenLayers.Geometry.Point"==e.CLASS_NAME?this.equals(e):e.intersects(this)},transform:function(e,t){return e&&t&&(OpenLayers.Projection.transform(this,e,t),this.bounds=null),this},getVertices:function(){return[this]},CLASS_NAME:"OpenLayers.Geometry.Point"}),OpenLayers.Geometry.MultiPoint=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.Point"],addPoint:function(e,t){this.addComponent(e,t)},removePoint:function(e){this.removeComponent(e)},CLASS_NAME:"OpenLayers.Geometry.MultiPoint"}),OpenLayers.Geometry.Curve=OpenLayers.Class(OpenLayers.Geometry.MultiPoint,{componentTypes:["OpenLayers.Geometry.Point"],getLength:function(){var e=0;if(this.components&&this.components.length>1)for(var t=1,i=this.components.length;i>t;t++)e+=this.components[t-1].distanceTo(this.components[t]);return e},getGeodesicLength:function(e){var t=this;if(e){var i=new OpenLayers.Projection("EPSG:4326");i.equals(e)||(t=this.clone().transform(e,i))}var a=0;if(t.components&&t.components.length>1)for(var n,s,r=1,o=t.components.length;o>r;r++)n=t.components[r-1],s=t.components[r],a+=OpenLayers.Util.distVincenty({lon:n.x,lat:n.y},{lon:s.x,lat:s.y});return 1e3*a},CLASS_NAME:"OpenLayers.Geometry.Curve"}),OpenLayers.Geometry.LineString=OpenLayers.Class(OpenLayers.Geometry.Curve,{removeComponent:function(){var e=this.components&&this.components.length>2;return e&&OpenLayers.Geometry.Collection.prototype.removeComponent.apply(this,arguments),e},intersects:function(e){var t=!1,i=e.CLASS_NAME;if("OpenLayers.Geometry.LineString"==i||"OpenLayers.Geometry.LinearRing"==i||"OpenLayers.Geometry.Point"==i){var a,n=this.getSortedSegments();a="OpenLayers.Geometry.Point"==i?[{x1:e.x,y1:e.y,x2:e.x,y2:e.y}]:e.getSortedSegments();var s,r,o,l,u,c,h,d;e:for(var p=0,f=n.length;f>p;++p){s=n[p],r=s.x1,o=s.x2,l=s.y1,u=s.y2;for(var m=0,g=a.length;g>m&&(c=a[m],!(c.x1>o));++m)if(!(c.x2<r||(h=c.y1,d=c.y2,Math.min(h,d)>Math.max(l,u)||Math.max(h,d)<Math.min(l,u)||!OpenLayers.Geometry.segmentsIntersect(s,c)))){t=!0;break e}}}else t=e.intersects(this);return t},getSortedSegments:function(){function e(e,t){return e.x1-t.x1}for(var t,i,a=this.components.length-1,n=new Array(a),s=0;a>s;++s)t=this.components[s],i=this.components[s+1],n[s]=t.x<i.x?{x1:t.x,y1:t.y,x2:i.x,y2:i.y}:{x1:i.x,y1:i.y,x2:t.x,y2:t.y};return n.sort(e)},splitWithSegment:function(e,t){for(var i,a,n,s,r,o=!(t&&t.edge===!1),l=t&&t.tolerance,u=[],c=this.getVertices(),h=[],d=[],p=!1,f={point:!0,tolerance:l},m=null,g=0,y=c.length-2;y>=g;++g)if(i=c[g],h.push(i.clone()),a=c[g+1],r={x1:i.x,y1:i.y,x2:a.x,y2:a.y},n=OpenLayers.Geometry.segmentsIntersect(e,r,f),n instanceof OpenLayers.Geometry.Point&&(s=n.x===e.x1&&n.y===e.y1||n.x===e.x2&&n.y===e.y2||n.equals(i)||n.equals(a)?!0:!1,s||o)){if(n.equals(d[d.length-1])||d.push(n.clone()),0===g&&n.equals(i))continue;if(n.equals(a))continue;p=!0,n.equals(i)||h.push(n),u.push(new OpenLayers.Geometry.LineString(h)),h=[n.clone()]}if(p&&(h.push(a.clone()),u.push(new OpenLayers.Geometry.LineString(h))),d.length>0){var v=e.x1<e.x2?1:-1,b=e.y1<e.y2?1:-1;m={lines:u,points:d.sort(function(e,t){return v*e.x-v*t.x||b*e.y-b*t.y})}}return m},split:function(e,t){var i,a,n,s,r=null,o=t&&t.mutual;if(e instanceof OpenLayers.Geometry.LineString){var l,u,c,h,d,p,f=this.getVertices(),m=[];n=[];for(var g=0,y=f.length-2;y>=g;++g){l=f[g],u=f[g+1],c={x1:l.x,y1:l.y,x2:u.x,y2:u.y},s=s||[e],o&&m.push(l.clone());for(var v=0;v<s.length;++v)if(h=s[v].splitWithSegment(c,t),h&&(d=h.lines,d.length>0&&(d.unshift(v,1),Array.prototype.splice.apply(s,d),v+=d.length-2),o))for(var b=0,_=h.points.length;_>b;++b)p=h.points[b],p.equals(l)||(m.push(p),n.push(new OpenLayers.Geometry.LineString(m)),m=p.equals(u)?[]:[p.clone()])}o&&n.length>0&&m.length>0&&(m.push(u.clone()),n.push(new OpenLayers.Geometry.LineString(m)))}else r=e.splitWith(this,t);return s&&s.length>1?a=!0:s=[],n&&n.length>1?i=!0:n=[],(a||i)&&(r=o?[n,s]:s),r},splitWith:function(e,t){return e.split(this,t)},getVertices:function(e){var t;return t=e===!0?[this.components[0],this.components[this.components.length-1]]:e===!1?this.components.slice(1,this.components.length-1):this.components.slice()},distanceTo:function(e,t){var i,a=!(t&&t.edge===!1),n=a&&t&&t.details,s={},r=Number.POSITIVE_INFINITY;if(e instanceof OpenLayers.Geometry.Point){for(var o,l=this.getSortedSegments(),u=e.x,c=e.y,h=0,d=l.length;d>h;++h)if(o=l[h],i=OpenLayers.Geometry.distanceToSegment(e,o),i.distance<r){if(r=i.distance,s=i,0===r)break}else if(o.x2>u&&(c>o.y1&&c<o.y2||c<o.y1&&c>o.y2))break;s=n?{distance:s.distance,x0:s.x,y0:s.y,x1:u,y1:c}:s.distance}else if(e instanceof OpenLayers.Geometry.LineString){var p,f,m,g,y,v=this.getSortedSegments(),b=e.getSortedSegments(),_=b.length,k={point:!0};e:for(var h=0,d=v.length;d>h;++h){p=v[h],g=p.x1,y=p.y1;for(var L=0;_>L;++L){if(f=b[L],m=OpenLayers.Geometry.segmentsIntersect(p,f,k)){r=0,s={distance:0,x0:m.x,y0:m.y,x1:m.x,y1:m.y};break e}i=OpenLayers.Geometry.distanceToSegment({x:g,y:y},f),i.distance<r&&(r=i.distance,s={distance:r,x0:g,y0:y,x1:i.x,y1:i.y})}}if(n||(s=s.distance),0!==r&&p){i=e.distanceTo(new OpenLayers.Geometry.Point(p.x2,p.y2),t);var w=n?i.distance:i;r>w&&(s=n?{distance:r,x0:i.x1,y0:i.y1,x1:i.x0,y1:i.y0}:w)}}else s=e.distanceTo(this,t),n&&(s={distance:s.distance,x0:s.x1,y0:s.y1,x1:s.x0,y1:s.y0});return s},simplify:function(e){if(this&&null!==this){var t=this.getVertices();if(t.length<3)return this;var i=function(e,t){return e-t},a=function(e,t,i,s){for(var r,l=0,u=0,c=t;i>c;c++)r=n(e[t],e[i],e[c]),r>l&&(l=r,u=c);l>s&&u!=t&&(o.push(u),a(e,t,u,s),a(e,u,i,s))},n=function(e,t,i){var a=Math.abs(.5*(e.x*t.y+t.x*i.y+i.x*e.y-t.x*e.y-i.x*t.y-e.x*i.y)),n=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),s=2*(a/n);return s},s=0,r=t.length-1,o=[];for(o.push(s),o.push(r);t[s].equals(t[r]);)r--,o.push(r);a(t,s,r,e);var l=[];o.sort(i);for(var u=0;u<o.length;u++)l.push(t[o[u]]);return new OpenLayers.Geometry.LineString(l)}return this},CLASS_NAME:"OpenLayers.Geometry.LineString"}),OpenLayers.Geometry.LinearRing=OpenLayers.Class(OpenLayers.Geometry.LineString,{componentTypes:["OpenLayers.Geometry.Point"],addComponent:function(e,t){var i=!1,a=this.components.pop();null==t&&e.equals(a)||(i=OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,arguments));var n=this.components[0];return OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,[n]),i},removeComponent:function(){var e=this.components&&this.components.length>3;if(e){this.components.pop(),OpenLayers.Geometry.Collection.prototype.removeComponent.apply(this,arguments);var t=this.components[0];OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,[t])}return e},move:function(e,t){for(var i=0,a=this.components.length;a-1>i;i++)this.components[i].move(e,t)},rotate:function(e,t){for(var i=0,a=this.components.length;a-1>i;++i)this.components[i].rotate(e,t)},resize:function(e,t,i){for(var a=0,n=this.components.length;n-1>a;++a)this.components[a].resize(e,t,i);return this},transform:function(e,t){if(e&&t){for(var i=0,a=this.components.length;a-1>i;i++){var n=this.components[i];n.transform(e,t)}this.bounds=null}return this},getCentroid:function(){if(this.components&&this.components.length>2){for(var e=0,t=0,i=0;i<this.components.length-1;i++){var a=this.components[i],n=this.components[i+1];e+=(a.x+n.x)*(a.x*n.y-n.x*a.y),t+=(a.y+n.y)*(a.x*n.y-n.x*a.y)}var s=-1*this.getArea(),r=e/(6*s),o=t/(6*s);return new OpenLayers.Geometry.Point(r,o)}return null},getArea:function(){var e=0;if(this.components&&this.components.length>2){for(var t=0,i=0,a=this.components.length;a-1>i;i++){var n=this.components[i],s=this.components[i+1];t+=(n.x+s.x)*(s.y-n.y)}e=-t/2}return e},getGeodesicArea:function(e){var t=this;if(e){var i=new OpenLayers.Projection("EPSG:4326");i.equals(e)||(t=this.clone().transform(e,i))}var a=0,n=t.components&&t.components.length;if(n>2){for(var s,r,o=0;n-1>o;o++)s=t.components[o],r=t.components[o+1],a+=OpenLayers.Util.rad(r.x-s.x)*(2+Math.sin(OpenLayers.Util.rad(s.y))+Math.sin(OpenLayers.Util.rad(r.y)));a=6378137*6378137*a/2}return a},containsPoint:function(e){function t(e,t,i,a,n){return(e-n)*((a-t)/(n-i))+a}for(var i,a,n,s,r,o,l,u=OpenLayers.Number.limitSigDigs,c=14,h=u(e.x,c),d=u(e.y,c),p=this.components.length-1,f=0,m=0;p>m;++m)if(i=this.components[m],n=u(i.x,c),s=u(i.y,c),a=this.components[m+1],r=u(a.x,c),o=u(a.y,c),s!=o){if(l=u(t(d,n,s,r,o),c),l==h&&(o>s&&d>=s&&o>=d||s>o&&s>=d&&d>=o)){f=-1;break}h>=l||n!=r&&(l<Math.min(n,r)||l>Math.max(n,r))||(o>s&&d>=s&&o>d||s>o&&s>d&&d>=o)&&++f}else if(d==s&&(r>=n&&h>=n&&r>=h||n>=r&&n>=h&&h>=r)){f=-1;break}var g=-1==f?1:!!(1&f);return g},intersects:function(e){var t=!1;if("OpenLayers.Geometry.Point"==e.CLASS_NAME)t=this.containsPoint(e);else if("OpenLayers.Geometry.LineString"==e.CLASS_NAME)t=e.intersects(this);else if("OpenLayers.Geometry.LinearRing"==e.CLASS_NAME)t=OpenLayers.Geometry.LineString.prototype.intersects.apply(this,[e]);else for(var i=0,a=e.components.length;a>i&&!(t=e.components[i].intersects(this));++i);return t},getVertices:function(e){return e===!0?[]:this.components.slice(0,this.components.length-1)},CLASS_NAME:"OpenLayers.Geometry.LinearRing"}),OpenLayers.Geometry.Polygon=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.LinearRing"],getArea:function(){var e=0;if(this.components&&this.components.length>0){e+=Math.abs(this.components[0].getArea());for(var t=1,i=this.components.length;i>t;t++)e-=Math.abs(this.components[t].getArea())}return e},getGeodesicArea:function(e){var t=0;if(this.components&&this.components.length>0){t+=Math.abs(this.components[0].getGeodesicArea(e));for(var i=1,a=this.components.length;a>i;i++)t-=Math.abs(this.components[i].getGeodesicArea(e))}return t},containsPoint:function(e){var t=this.components.length,i=!1;if(t>0&&(i=this.components[0].containsPoint(e),1!==i&&i&&t>1))for(var a,n=1;t>n;++n)if(a=this.components[n].containsPoint(e)){i=1===a?1:!1;break}return i},intersects:function(e){var t,i,a=!1;if("OpenLayers.Geometry.Point"==e.CLASS_NAME)a=this.containsPoint(e);else if("OpenLayers.Geometry.LineString"==e.CLASS_NAME||"OpenLayers.Geometry.LinearRing"==e.CLASS_NAME){for(t=0,i=this.components.length;i>t&&!(a=e.intersects(this.components[t]));++t);if(!a)for(t=0,i=e.components.length;i>t&&!(a=this.containsPoint(e.components[t]));++t);}else for(t=0,i=e.components.length;i>t&&!(a=this.intersects(e.components[t]));++t);if(!a&&"OpenLayers.Geometry.Polygon"==e.CLASS_NAME){var n=this.components[0];for(t=0,i=n.components.length;i>t&&!(a=e.containsPoint(n.components[t]));++t);}return a},distanceTo:function(e,t){var i,a=!(t&&t.edge===!1);return i=!a&&this.intersects(e)?0:OpenLayers.Geometry.Collection.prototype.distanceTo.apply(this,[e,t])},CLASS_NAME:"OpenLayers.Geometry.Polygon"}),OpenLayers.Geometry.Polygon.createRegularPolygon=function(e,t,i,a){var n=Math.PI*(1/i-.5);a&&(n+=a/180*Math.PI);for(var s,r,o,l=[],u=0;i>u;++u)s=n+2*u*Math.PI/i,r=e.x+t*Math.cos(s),o=e.y+t*Math.sin(s),l.push(new OpenLayers.Geometry.Point(r,o));var c=new OpenLayers.Geometry.LinearRing(l);return new OpenLayers.Geometry.Polygon([c])},OpenLayers.Geometry.MultiLineString=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.LineString"],split:function(e,t){for(var i,a,n,s,r,o=null,l=t&&t.mutual,u=[],c=[e],h=0,d=this.components.length;d>h;++h){a=this.components[h],s=!1;for(var p=0;p<c.length;++p)if(i=a.split(c[p],t)){if(l){n=i[0];for(var f=0,m=n.length;m>f;++f)0===f&&u.length?u[u.length-1].addComponent(n[f]):u.push(new OpenLayers.Geometry.MultiLineString([n[f]]));s=!0,i=i[1]}if(i.length){i.unshift(p,1),Array.prototype.splice.apply(c,i);break}}s||(u.length?u[u.length-1].addComponent(a.clone()):u=[new OpenLayers.Geometry.MultiLineString(a.clone())])}return u&&u.length>1?s=!0:u=[],c&&c.length>1?r=!0:c=[],(s||r)&&(o=l?[u,c]:c),o},splitWith:function(e,t){var i,a,n,s,r,o,l,u=null,c=t&&t.mutual;if(e instanceof OpenLayers.Geometry.LineString){l=[],o=[e];for(var h=0,d=this.components.length;d>h;++h){r=!1,a=this.components[h];for(var p=0;p<o.length;++p)if(i=o[p].split(a,t)){c&&(n=i[0],n.length&&(n.unshift(p,1),Array.prototype.splice.apply(o,n),p+=n.length-2),i=i[1],0===i.length&&(i=[a.clone()]));for(var f=0,m=i.length;m>f;++f)0===f&&l.length?l[l.length-1].addComponent(i[f]):l.push(new OpenLayers.Geometry.MultiLineString([i[f]]));r=!0}r||(l.length?l[l.length-1].addComponent(a.clone()):l=[new OpenLayers.Geometry.MultiLineString([a.clone()])])}}else u=e.split(this);return o&&o.length>1?s=!0:o=[],l&&l.length>1?r=!0:l=[],(s||r)&&(u=c?[o,l]:l),u},CLASS_NAME:"OpenLayers.Geometry.MultiLineString"}),OpenLayers.Geometry.MultiPolygon=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.Polygon"],CLASS_NAME:"OpenLayers.Geometry.MultiPolygon"}),OpenLayers.Renderer=OpenLayers.Class({container:null,root:null,extent:null,locked:!1,size:null,resolution:null,map:null,featureDx:0,initialize:function(e,t){this.container=OpenLayers.Util.getElement(e),OpenLayers.Util.extend(this,t)},destroy:function(){this.container=null,this.extent=null,this.size=null,this.resolution=null,this.map=null},supported:function(){return!1},setExtent:function(e,t){if(this.extent=e.clone(),this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var i=e.getWidth()/this.map.getExtent().getWidth(),e=e.scale(1/i);this.extent=e.wrapDateLine(this.map.getMaxExtent()).scale(i)}return t&&(this.resolution=null),!0},setSize:function(e){this.size=e.clone(),this.resolution=null},getResolution:function(){return this.resolution=this.resolution||this.map.getResolution(),this.resolution},drawFeature:function(e,t){if(null==t&&(t=e.style),e.geometry){var i=e.geometry.getBounds();if(i){var a;this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(a=this.map.getMaxExtent()),i.intersectsBounds(this.extent,{worldBounds:a})?this.calculateFeatureDx(i,a):t={display:"none"};var n=this.drawGeometry(e.geometry,t,e.id);if("none"!=t.display&&t.label&&n!==!1){var s=e.geometry.getCentroid();if(t.labelXOffset||t.labelYOffset){var r=isNaN(t.labelXOffset)?0:t.labelXOffset,o=isNaN(t.labelYOffset)?0:t.labelYOffset,l=this.getResolution();s.move(r*l,o*l)}this.drawText(e.id,t,s)}else this.removeText(e.id);return n}}},calculateFeatureDx:function(e,t){if(this.featureDx=0,t){var i=t.getWidth(),a=(this.extent.left+this.extent.right)/2,n=(e.left+e.right)/2,s=Math.round((n-a)/i);this.featureDx=s*i}},drawGeometry:function(){},drawText:function(){},removeText:function(){},clear:function(){},getFeatureIdFromEvent:function(){},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0,i=e.length;i>t;++t){var a=e[t];this.eraseGeometry(a.geometry,a.id),this.removeText(a.id)}},eraseGeometry:function(){},moveRoot:function(){},getRenderLayerId:function(){return this.container.id},applyDefaultSymbolizer:function(e){var t=OpenLayers.Util.extend({},OpenLayers.Renderer.defaultSymbolizer);return e.stroke===!1&&(delete t.strokeWidth,delete t.strokeColor),e.fill===!1&&delete t.fillColor,OpenLayers.Util.extend(t,e),t},CLASS_NAME:"OpenLayers.Renderer"}),OpenLayers.Renderer.defaultSymbolizer={fillColor:"#000000",strokeColor:"#000000",strokeWidth:2,fillOpacity:1,strokeOpacity:1,pointRadius:0,labelAlign:"cm"},OpenLayers.Renderer.symbol={star:[350,75,379,161,469,161,397,215,423,301,350,250,277,301,303,215,231,161,321,161,350,75],cross:[4,0,6,0,6,4,10,4,10,6,6,6,6,10,4,10,4,6,0,6,0,4,4,4,4,0],x:[0,0,25,0,50,35,75,0,100,0,65,50,100,100,75,100,50,65,25,100,0,100,35,50,0,0],square:[0,0,0,1,1,1,1,0,0,0],triangle:[0,10,10,10,5,0,0,10]},OpenLayers.ElementsIndexer=OpenLayers.Class({maxZIndex:null,order:null,indices:null,compare:null,initialize:function(e){this.compare=e?OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER_Y_ORDER:OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER_DRAWING_ORDER,this.clear()},insert:function(e){this.exists(e)&&this.remove(e);var t=e.id;this.determineZIndex(e);for(var i,a=-1,n=this.order.length;n-a>1;){i=parseInt((a+n)/2);var s=this.compare(this,e,OpenLayers.Util.getElement(this.order[i]));s>0?a=i:n=i}return this.order.splice(n,0,t),this.indices[t]=this.getZIndex(e),this.getNextElement(n)},remove:function(e){var t=e.id,i=OpenLayers.Util.indexOf(this.order,t);if(i>=0)if(this.order.splice(i,1),delete this.indices[t],this.order.length>0){var a=this.order[this.order.length-1];this.maxZIndex=this.indices[a]}else this.maxZIndex=0},clear:function(){this.order=[],this.indices={},this.maxZIndex=0},exists:function(e){return null!=this.indices[e.id]},getZIndex:function(e){return e._style.graphicZIndex},determineZIndex:function(e){var t=e._style.graphicZIndex;null==t?(t=this.maxZIndex,e._style.graphicZIndex=t):t>this.maxZIndex&&(this.maxZIndex=t)},getNextElement:function(e){var t=e+1;if(t<this.order.length){var i=OpenLayers.Util.getElement(this.order[t]);return void 0==i&&(i=this.getNextElement(t)),i}return null},CLASS_NAME:"OpenLayers.ElementsIndexer"}),OpenLayers.ElementsIndexer.IndexingMethods={Z_ORDER:function(e,t,i){var a=e.getZIndex(t),n=0;if(i){var s=e.getZIndex(i);n=a-s}return n},Z_ORDER_DRAWING_ORDER:function(e,t,i){var a=OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER(e,t,i);return i&&0==a&&(a=1),a},Z_ORDER_Y_ORDER:function(e,t,i){var a=OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER(e,t,i);if(i&&0===a){var n=i._boundsBottom-t._boundsBottom;a=0===n?1:n}return a}},OpenLayers.Renderer.Elements=OpenLayers.Class(OpenLayers.Renderer,{rendererRoot:null,root:null,vectorRoot:null,textRoot:null,xmlns:null,xOffset:0,indexer:null,BACKGROUND_ID_SUFFIX:"_background",LABEL_ID_SUFFIX:"_label",LABEL_OUTLINE_SUFFIX:"_outline",initialize:function(e,t){OpenLayers.Renderer.prototype.initialize.apply(this,arguments),this.rendererRoot=this.createRenderRoot(),this.root=this.createRoot("_root"),this.vectorRoot=this.createRoot("_vroot"),this.textRoot=this.createRoot("_troot"),this.root.appendChild(this.vectorRoot),this.root.appendChild(this.textRoot),this.rendererRoot.appendChild(this.root),this.container.appendChild(this.rendererRoot),t&&(t.zIndexing||t.yOrdering)&&(this.indexer=new OpenLayers.ElementsIndexer(t.yOrdering))},destroy:function(){this.clear(),this.rendererRoot=null,this.root=null,this.xmlns=null,OpenLayers.Renderer.prototype.destroy.apply(this,arguments)},clear:function(){var e,t=this.vectorRoot;if(t)for(;e=t.firstChild;)t.removeChild(e);if(t=this.textRoot)for(;e=t.firstChild;)t.removeChild(e);this.indexer&&this.indexer.clear()},setExtent:function(e,t){var i=OpenLayers.Renderer.prototype.setExtent.apply(this,arguments),a=this.getResolution();if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var n,s=e.getWidth()/this.map.getExtent().getWidth(),e=e.scale(1/s),r=this.map.getMaxExtent();r.right>e.left&&r.right<e.right?n=!0:r.left>e.left&&r.left<e.right&&(n=!1),(n!==this.rightOfDateLine||t)&&(i=!1,this.xOffset=n===!0?r.getWidth()/a:0),this.rightOfDateLine=n}return i},getNodeType:function(){},drawGeometry:function(e,t,i){var a=e.CLASS_NAME,n=!0;if("OpenLayers.Geometry.Collection"==a||"OpenLayers.Geometry.MultiPoint"==a||"OpenLayers.Geometry.MultiLineString"==a||"OpenLayers.Geometry.MultiPolygon"==a){for(var s=0,r=e.components.length;r>s;s++)n=this.drawGeometry(e.components[s],t,i)&&n;return n}n=!1;var o=!1;if("none"!=t.display&&(t.backgroundGraphic?this.redrawBackgroundNode(e.id,e,t,i):o=!0,n=this.redrawNode(e.id,e,t,i)),0==n){var l=document.getElementById(e.id);l&&(l._style.backgroundGraphic&&(o=!0),l.parentNode.removeChild(l))}if(o){var l=document.getElementById(e.id+this.BACKGROUND_ID_SUFFIX);l&&l.parentNode.removeChild(l)}return n},redrawNode:function(e,t,i,a){i=this.applyDefaultSymbolizer(i);var n=this.nodeFactory(e,this.getNodeType(t,i));n._featureId=a,n._boundsBottom=t.getBounds().bottom,n._geometryClass=t.CLASS_NAME,n._style=i;var s=this.drawGeometryNode(n,t,i);if(s===!1)return!1;if(n=s.node,this.indexer){var r=this.indexer.insert(n);r?this.vectorRoot.insertBefore(n,r):this.vectorRoot.appendChild(n)}else n.parentNode!==this.vectorRoot&&this.vectorRoot.appendChild(n);return this.postDraw(n),s.complete},redrawBackgroundNode:function(e,t,i){var a=OpenLayers.Util.extend({},i);return a.externalGraphic=a.backgroundGraphic,a.graphicXOffset=a.backgroundXOffset,a.graphicYOffset=a.backgroundYOffset,a.graphicZIndex=a.backgroundGraphicZIndex,a.graphicWidth=a.backgroundWidth||a.graphicWidth,a.graphicHeight=a.backgroundHeight||a.graphicHeight,a.backgroundGraphic=null,a.backgroundXOffset=null,a.backgroundYOffset=null,a.backgroundGraphicZIndex=null,this.redrawNode(e+this.BACKGROUND_ID_SUFFIX,t,a,null)},drawGeometryNode:function(e,t,i){i=i||e._style;var a,n={isFilled:void 0===i.fill?!0:i.fill,isStroked:void 0===i.stroke?!!i.strokeWidth:i.stroke};switch(t.CLASS_NAME){case"OpenLayers.Geometry.Point":i.graphic===!1&&(n.isFilled=!1,n.isStroked=!1),a=this.drawPoint(e,t);break;case"OpenLayers.Geometry.LineString":n.isFilled=!1,a=this.drawLineString(e,t);break;case"OpenLayers.Geometry.LinearRing":a=this.drawLinearRing(e,t);break;case"OpenLayers.Geometry.Polygon":a=this.drawPolygon(e,t);break;case"OpenLayers.Geometry.Rectangle":a=this.drawRectangle(e,t)}return e._options=n,0!=a?{node:this.setStyle(e,i,n,t),complete:a}:!1},postDraw:function(){},drawPoint:function(){},drawLineString:function(){},drawLinearRing:function(){},drawPolygon:function(){},drawRectangle:function(){},drawCircle:function(){},removeText:function(e){var t=document.getElementById(e+this.LABEL_ID_SUFFIX);t&&this.textRoot.removeChild(t);var i=document.getElementById(e+this.LABEL_OUTLINE_SUFFIX);i&&this.textRoot.removeChild(i)},getFeatureIdFromEvent:function(e){var t=e.target,i=t&&t.correspondingUseElement,a=i?i:t||e.srcElement;return a._featureId},eraseGeometry:function(e,t){if("OpenLayers.Geometry.MultiPoint"==e.CLASS_NAME||"OpenLayers.Geometry.MultiLineString"==e.CLASS_NAME||"OpenLayers.Geometry.MultiPolygon"==e.CLASS_NAME||"OpenLayers.Geometry.Collection"==e.CLASS_NAME)for(var i=0,a=e.components.length;a>i;i++)this.eraseGeometry(e.components[i],t);else{var n=OpenLayers.Util.getElement(e.id);if(n&&n.parentNode&&(n.geometry&&(n.geometry.destroy(),n.geometry=null),n.parentNode.removeChild(n),this.indexer&&this.indexer.remove(n),n._style.backgroundGraphic)){var s=e.id+this.BACKGROUND_ID_SUFFIX,r=OpenLayers.Util.getElement(s);r&&r.parentNode&&r.parentNode.removeChild(r)}}},nodeFactory:function(e,t){var i=OpenLayers.Util.getElement(e);return i?this.nodeTypeCompare(i,t)||(i.parentNode.removeChild(i),i=this.nodeFactory(e,t)):i=this.createNode(t,e),i},nodeTypeCompare:function(){},createNode:function(){},moveRoot:function(e){var t=this.root;e.root.parentNode==this.rendererRoot&&(t=e.root),t.parentNode.removeChild(t),e.rendererRoot.appendChild(t)},getRenderLayerId:function(){return this.root.parentNode.parentNode.id},isComplexSymbol:function(e){return"circle"!=e&&!!e},CLASS_NAME:"OpenLayers.Renderer.Elements"}),OpenLayers.Renderer.SVG=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15e3,translationParameters:null,symbolMetrics:null,initialize:function(){this.supported()&&(OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments),this.translationParameters={x:0,y:0},this.symbolMetrics={})},supported:function(){var e="http://www.w3.org/TR/SVG11/feature#";return document.implementation&&(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature(e+"SVG","1.1")||document.implementation.hasFeature(e+"BasicStructure","1.1"))},inValidRange:function(e,t,i){var a=e+(i?0:this.translationParameters.x),n=t+(i?0:this.translationParameters.y);return a>=-this.MAX_PIXEL&&a<=this.MAX_PIXEL&&n>=-this.MAX_PIXEL&&n<=this.MAX_PIXEL},setExtent:function(e,t){var i=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),a=this.getResolution(),n=-e.left/a,s=e.top/a;if(t){this.left=n,this.top=s;var r="0 0 "+this.size.w+" "+this.size.h;return this.rendererRoot.setAttributeNS(null,"viewBox",r),this.translate(this.xOffset,0),!0}var o=this.translate(n-this.left+this.xOffset,s-this.top);return o||this.setExtent(e,!0),i&&o},translate:function(e,t){if(this.inValidRange(e,t,!0)){var i="";return(e||t)&&(i="translate("+e+","+t+")"),this.root.setAttributeNS(null,"transform",i),this.translationParameters={x:e,y:t},!0}return!1},setSize:function(){OpenLayers.Renderer.prototype.setSize.apply(this,arguments),this.rendererRoot.setAttributeNS(null,"width",this.size.w),this.rendererRoot.setAttributeNS(null,"height",this.size.h)},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"image":this.isComplexSymbol(t.graphicName)?"svg":"circle";break;case"OpenLayers.Geometry.Rectangle":i="rect";break;case"OpenLayers.Geometry.LineString":i="polyline";break;case"OpenLayers.Geometry.LinearRing":i="polygon";break;case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":i="path"}return i},setStyle:function(e,t,i){t=t||e._style,i=i||e._options;var a,n=parseFloat(e.getAttributeNS(null,"r")),s=1;if("OpenLayers.Geometry.Point"==e._geometryClass&&n){if(e.style.visibility="",t.graphic===!1)e.style.visibility="hidden";else if(t.externalGraphic){if(a=this.getPosition(e),t.graphicTitle){e.setAttributeNS(null,"title",t.graphicTitle);var r=e.getElementsByTagName("title");if(r.length>0)r[0].firstChild.textContent=t.graphicTitle;else{var o=this.nodeFactory(null,"title");o.textContent=t.graphicTitle,e.appendChild(o)}}t.graphicWidth&&t.graphicHeight&&e.setAttributeNS(null,"preserveAspectRatio","none");var l=t.graphicWidth||t.graphicHeight,u=t.graphicHeight||t.graphicWidth;l=l?l:2*t.pointRadius,u=u?u:2*t.pointRadius;var c=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*l),h=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*u),d=t.graphicOpacity||t.fillOpacity;e.setAttributeNS(null,"x",(a.x+c).toFixed()),e.setAttributeNS(null,"y",(a.y+h).toFixed()),e.setAttributeNS(null,"width",l),e.setAttributeNS(null,"height",u),e.setAttributeNS(this.xlinkns,"href",t.externalGraphic),e.setAttributeNS(null,"style","opacity: "+d),e.onclick=OpenLayers.Renderer.SVG.preventDefault}else if(this.isComplexSymbol(t.graphicName)){var p=3*t.pointRadius,f=2*p,m=this.importSymbol(t.graphicName);a=this.getPosition(e),s=3*this.symbolMetrics[m.id][0]/f;var g=e.parentNode,y=e.nextSibling;g&&g.removeChild(e),e.firstChild&&e.removeChild(e.firstChild),e.appendChild(m.firstChild.cloneNode(!0)),e.setAttributeNS(null,"viewBox",m.getAttributeNS(null,"viewBox")),e.setAttributeNS(null,"width",f),e.setAttributeNS(null,"height",f),e.setAttributeNS(null,"x",a.x-p),e.setAttributeNS(null,"y",a.y-p),y?g.insertBefore(e,y):g&&g.appendChild(e)}else e.setAttributeNS(null,"r",t.pointRadius);var v=t.rotation;if((void 0!==v||void 0!==e._rotation)&&a)if(e._rotation=v,v|=0,"svg"!==e.nodeName)e.setAttributeNS(null,"transform","rotate("+v+" "+a.x+" "+a.y+")");else{var b=this.symbolMetrics[m.id];e.firstChild.setAttributeNS(null,"transform","rotate("+v+" "+b[1]+" "+b[2]+")")}}return i.isFilled?(e.setAttributeNS(null,"fill",t.fillColor),e.setAttributeNS(null,"fill-opacity",t.fillOpacity)):e.setAttributeNS(null,"fill","none"),i.isStroked?(e.setAttributeNS(null,"stroke",t.strokeColor),e.setAttributeNS(null,"stroke-opacity",t.strokeOpacity),e.setAttributeNS(null,"stroke-width",t.strokeWidth*s),e.setAttributeNS(null,"stroke-linecap",t.strokeLinecap||"round"),e.setAttributeNS(null,"stroke-linejoin","round"),t.strokeDashstyle&&e.setAttributeNS(null,"stroke-dasharray",this.dashStyle(t,s))):e.setAttributeNS(null,"stroke","none"),t.pointerEvents&&e.setAttributeNS(null,"pointer-events",t.pointerEvents),null!=t.cursor&&e.setAttributeNS(null,"cursor",t.cursor),e},dashStyle:function(e,t){var i=e.strokeWidth*t,a=e.strokeDashstyle;switch(a){case"solid":return"none";case"dot":return[1,4*i].join();case"dash":return[4*i,4*i].join();case"dashdot":return[4*i,4*i,1,4*i].join();case"longdash":return[8*i,4*i].join();case"longdashdot":return[8*i,4*i,1,4*i].join();default:return OpenLayers.String.trim(a).replace(/\s+/g,",")}},createNode:function(e,t){var i=document.createElementNS(this.xmlns,e);return t&&i.setAttributeNS(null,"id",t),i},nodeTypeCompare:function(e,t){return t==e.nodeName},createRenderRoot:function(){var e=this.nodeFactory(this.container.id+"_svgRoot","svg");return e.style.display="block",e},createRoot:function(e){return this.nodeFactory(this.container.id+e,"g")},createDefs:function(){var e=this.nodeFactory(this.container.id+"_defs","defs");return this.rendererRoot.appendChild(e),e},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){var a=this.getResolution(),n=(t.x-this.featureDx)/a+this.left,s=this.top-t.y/a;return this.inValidRange(n,s)?(e.setAttributeNS(null,"cx",n),e.setAttributeNS(null,"cy",s),e.setAttributeNS(null,"r",i),e):!1},drawLineString:function(e,t){var i=this.getComponentsString(t.components);return i.path?(e.setAttributeNS(null,"points",i.path),i.complete?e:null):!1},drawLinearRing:function(e,t){var i=this.getComponentsString(t.components);return i.path?(e.setAttributeNS(null,"points",i.path),i.complete?e:null):!1},drawPolygon:function(e,t){for(var i,a,n="",s=!0,r=!0,o=0,l=t.components.length;l>o;o++)n+=" M",i=this.getComponentsString(t.components[o].components," "),a=i.path,a?(n+=" "+a,r=i.complete&&r):s=!1;return n+=" z",s?(e.setAttributeNS(null,"d",n),e.setAttributeNS(null,"fill-rule","evenodd"),r?e:null):!1},drawRectangle:function(e,t){var i=this.getResolution(),a=(t.x-this.featureDx)/i+this.left,n=this.top-t.y/i;return this.inValidRange(a,n)?(e.setAttributeNS(null,"x",a),e.setAttributeNS(null,"y",n),e.setAttributeNS(null,"width",t.width/i),e.setAttributeNS(null,"height",t.height/i),e):!1},drawText:function(e,t,i){var a=!!t.labelOutlineWidth;if(a){var n=OpenLayers.Util.extend({},t);n.fontColor=n.labelOutlineColor,n.fontStrokeColor=n.labelOutlineColor,n.fontStrokeWidth=t.labelOutlineWidth,delete n.labelOutlineWidth,this.drawText(e,n,i)
}var s=this.getResolution(),r=(i.x-this.featureDx)/s+this.left,o=i.y/s-this.top,l=a?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,u=this.nodeFactory(e+l,"text");u.setAttributeNS(null,"x",r),u.setAttributeNS(null,"y",-o),t.fontColor&&u.setAttributeNS(null,"fill",t.fontColor),t.fontStrokeColor&&u.setAttributeNS(null,"stroke",t.fontStrokeColor),t.fontStrokeWidth&&u.setAttributeNS(null,"stroke-width",t.fontStrokeWidth),t.fontOpacity&&u.setAttributeNS(null,"opacity",t.fontOpacity),t.fontFamily&&u.setAttributeNS(null,"font-family",t.fontFamily),t.fontSize&&u.setAttributeNS(null,"font-size",t.fontSize),t.fontWeight&&u.setAttributeNS(null,"font-weight",t.fontWeight),t.fontStyle&&u.setAttributeNS(null,"font-style",t.fontStyle),t.labelSelect===!0?(u.setAttributeNS(null,"pointer-events","visible"),u._featureId=e):u.setAttributeNS(null,"pointer-events","none");var c=t.labelAlign||OpenLayers.Renderer.defaultSymbolizer.labelAlign;u.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[c[0]]||"middle"),OpenLayers.IS_GECKO===!0&&u.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG.LABEL_ALIGN[c[1]]||"central");for(var h=t.label.split("\n"),d=h.length;u.childNodes.length>d;)u.removeChild(u.lastChild);for(var p=0;d>p;p++){var f=this.nodeFactory(e+l+"_tspan_"+p,"tspan");if(t.labelSelect===!0&&(f._featureId=e,f._geometry=i,f._geometryClass=i.CLASS_NAME),OpenLayers.IS_GECKO===!1&&f.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[c[1]]||"-35%"),f.setAttribute("x",r),0==p){var m=OpenLayers.Renderer.SVG.LABEL_VFACTOR[c[1]];null==m&&(m=-.5),f.setAttribute("dy",m*(d-1)+"em")}else f.setAttribute("dy","1em");f.textContent=""===h[p]?" ":h[p],f.parentNode||u.appendChild(f)}u.parentNode||this.textRoot.appendChild(u)},getComponentsString:function(e,t){for(var i,a,n=[],s=!0,r=e.length,o=[],l=0;r>l;l++)a=e[l],n.push(a),i=this.getShortString(a),i?o.push(i):(l>0&&this.getShortString(e[l-1])&&o.push(this.clipLine(e[l],e[l-1])),r-1>l&&this.getShortString(e[l+1])&&o.push(this.clipLine(e[l],e[l+1])),s=!1);return{path:o.join(t||","),complete:s}},clipLine:function(e,t){if(t.equals(e))return"";var i,a=this.getResolution(),n=this.MAX_PIXEL-this.translationParameters.x,s=this.MAX_PIXEL-this.translationParameters.y,r=(t.x-this.featureDx)/a+this.left,o=this.top-t.y/a,l=(e.x-this.featureDx)/a+this.left,u=this.top-e.y/a;return(-n>l||l>n)&&(i=(u-o)/(l-r),l=0>l?-n:n,u=o+(l-r)*i),(-s>u||u>s)&&(i=(l-r)/(u-o),u=0>u?-s:s,l=r+(u-o)*i),l+","+u},getShortString:function(e){var t=this.getResolution(),i=(e.x-this.featureDx)/t+this.left,a=this.top-e.y/t;return this.inValidRange(i,a)?i+","+a:!1},getPosition:function(e){return{x:parseFloat(e.getAttributeNS(null,"cx")),y:parseFloat(e.getAttributeNS(null,"cy"))}},importSymbol:function(e){this.defs||(this.defs=this.createDefs());var t=this.container.id+"-"+e,i=document.getElementById(t);if(null!=i)return i;var a=OpenLayers.Renderer.symbol[e];if(!a)throw new Error(e+" is not a valid symbol name");var n=this.nodeFactory(t,"symbol"),s=this.nodeFactory(null,"polygon");n.appendChild(s);for(var r,o,l=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),u=[],c=0;c<a.length;c+=2)r=a[c],o=a[c+1],l.left=Math.min(l.left,r),l.bottom=Math.min(l.bottom,o),l.right=Math.max(l.right,r),l.top=Math.max(l.top,o),u.push(r,",",o);s.setAttributeNS(null,"points",u.join(" "));var h=l.getWidth(),d=l.getHeight(),p=[l.left-h,l.bottom-d,3*h,3*d];return n.setAttributeNS(null,"viewBox",p.join(" ")),this.symbolMetrics[t]=[Math.max(h,d),l.getCenterLonLat().lon,l.getCenterLonLat().lat],this.defs.appendChild(n),n},getFeatureIdFromEvent:function(e){var t=OpenLayers.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this,arguments);if(!t){var i=e.target;t=i.parentNode&&i!=this.rendererRoot?i.parentNode._featureId:void 0}return t},CLASS_NAME:"OpenLayers.Renderer.SVG"}),OpenLayers.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"},OpenLayers.Renderer.SVG.LABEL_VSHIFT={t:"-70%",b:"0"},OpenLayers.Renderer.SVG.LABEL_VFACTOR={t:0,b:-1},OpenLayers.Renderer.SVG.preventDefault=function(e){e.preventDefault&&e.preventDefault()},OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,cachedSymbolBounds:{},initialize:function(){OpenLayers.Renderer.prototype.initialize.apply(this,arguments),this.root=document.createElement("canvas"),this.container.appendChild(this.root),this.canvas=this.root.getContext("2d"),this.features={},this.hitDetection&&(this.hitCanvas=document.createElement("canvas"),this.hitContext=this.hitCanvas.getContext("2d"))},setExtent:function(){return OpenLayers.Renderer.prototype.setExtent.apply(this,arguments),!1},eraseGeometry:function(e,t){this.eraseFeatures(this.features[t][0])},supported:function(){return OpenLayers.CANVAS_SUPPORTED},setSize:function(e){this.size=e.clone();var t=this.root;if(t.style.width=e.w+"px",t.style.height=e.h+"px",t.width=e.w,t.height=e.h,this.resolution=null,this.hitDetection){var i=this.hitCanvas;i.style.width=e.w+"px",i.style.height=e.h+"px",i.width=e.w,i.height=e.h}},drawFeature:function(e,t){var i;if(e.geometry){t=this.applyDefaultSymbolizer(t||e.style);var a,n=e.geometry.getBounds();this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(a=this.map.getMaxExtent());var s=n&&n.intersectsBounds(this.extent,{worldBounds:a});i="none"!==t.display&&!!n&&s,i?this.features[e.id]=[e,t]:delete this.features[e.id],this.pendingRedraw=!0}return this.pendingRedraw&&!this.locked&&(this.redraw(),this.pendingRedraw=!1),i},drawGeometry:function(e,t,i){var a=e.CLASS_NAME;if("OpenLayers.Geometry.Collection"!=a&&"OpenLayers.Geometry.MultiPoint"!=a&&"OpenLayers.Geometry.MultiLineString"!=a&&"OpenLayers.Geometry.MultiPolygon"!=a)switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":this.drawPoint(e,t,i);break;case"OpenLayers.Geometry.LineString":this.drawLineString(e,t,i);break;case"OpenLayers.Geometry.LinearRing":this.drawLinearRing(e,t,i);break;case"OpenLayers.Geometry.Polygon":this.drawPolygon(e,t,i)}else for(var n=0;n<e.components.length;n++)this.drawGeometry(e.components[n],t,i)},drawExternalGraphic:function(e,t,i){var a=new Image;t.graphicTitle&&(a.title=t.graphicTitle);var n=t.graphicWidth||t.graphicHeight,s=t.graphicHeight||t.graphicWidth;n=n?n:2*t.pointRadius,s=s?s:2*t.pointRadius;var r=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*n),o=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*s),l=t.graphicOpacity||t.fillOpacity,u=function(){if(this.features[i]){var t=this.getLocalXY(e),u=t[0],c=t[1];if(!isNaN(u)&&!isNaN(c)){var h=0|u+r,d=0|c+o,p=this.canvas;p.globalAlpha=l;var f=OpenLayers.Renderer.Canvas.drawImageScaleFactor||(OpenLayers.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);p.drawImage(a,h*f,d*f,n*f,s*f),this.hitDetection&&(this.setHitContextStyle("fill",i),this.hitContext.fillRect(h,d,n,s))}}};a.onload=OpenLayers.Function.bind(u,this),a.src=t.externalGraphic},drawNamedSymbol:function(e,t,i){var a,n,s,r,o,l,u,c,h,d=Math.PI/180,p=OpenLayers.Renderer.symbol[t.graphicName];if(!p)throw new Error(t.graphicName+" is not a valid symbol name");if(p.length&&!(p.length<2)){var f=this.getLocalXY(e),m=f[0],g=f[1];if(!isNaN(m)&&!isNaN(g)){if(this.canvas.lineCap="round",this.canvas.lineJoin="round",this.hitDetection&&(this.hitContext.lineCap="round",this.hitContext.lineJoin="round"),t.graphicName in this.cachedSymbolBounds)l=this.cachedSymbolBounds[t.graphicName];else{for(l=new OpenLayers.Bounds,o=0;o<p.length;o+=2)l.extend(new OpenLayers.LonLat(p[o],p[o+1]));this.cachedSymbolBounds[t.graphicName]=l}if(this.canvas.save(),this.hitDetection&&this.hitContext.save(),this.canvas.translate(m,g),this.hitDetection&&this.hitContext.translate(m,g),c=d*t.rotation,isNaN(c)||(this.canvas.rotate(c),this.hitDetection&&this.hitContext.rotate(c)),u=2*t.pointRadius/Math.max(l.getWidth(),l.getHeight()),this.canvas.scale(u,u),this.hitDetection&&this.hitContext.scale(u,u),s=l.getCenterLonLat().lon,r=l.getCenterLonLat().lat,this.canvas.translate(-s,-r),this.hitDetection&&this.hitContext.translate(-s,-r),h=t.strokeWidth,t.strokeWidth=h/u,t.fill!==!1){for(this.setCanvasStyle("fill",t),this.canvas.beginPath(),o=0;o<p.length;o+=2)a=p[o],n=p[o+1],0==o&&this.canvas.moveTo(a,n),this.canvas.lineTo(a,n);if(this.canvas.closePath(),this.canvas.fill(),this.hitDetection){for(this.setHitContextStyle("fill",i,t),this.hitContext.beginPath(),o=0;o<p.length;o+=2)a=p[o],n=p[o+1],0==o&&this.canvas.moveTo(a,n),this.hitContext.lineTo(a,n);this.hitContext.closePath(),this.hitContext.fill()}}if(t.stroke!==!1){for(this.setCanvasStyle("stroke",t),this.canvas.beginPath(),o=0;o<p.length;o+=2)a=p[o],n=p[o+1],0==o&&this.canvas.moveTo(a,n),this.canvas.lineTo(a,n);if(this.canvas.closePath(),this.canvas.stroke(),this.hitDetection){for(this.setHitContextStyle("stroke",i,t,u),this.hitContext.beginPath(),o=0;o<p.length;o+=2)a=p[o],n=p[o+1],0==o&&this.hitContext.moveTo(a,n),this.hitContext.lineTo(a,n);this.hitContext.closePath(),this.hitContext.stroke()}}t.strokeWidth=h,this.canvas.restore(),this.hitDetection&&this.hitContext.restore(),this.setCanvasStyle("reset")}}},setCanvasStyle:function(e,t){"fill"===e?(this.canvas.globalAlpha=t.fillOpacity,this.canvas.fillStyle=t.fillColor):"stroke"===e?(this.canvas.globalAlpha=t.strokeOpacity,this.canvas.strokeStyle=t.strokeColor,this.canvas.lineWidth=t.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},featureIdToHex:function(e){var t=Number(e.split("_").pop())+1;t>=16777216&&(this.hitOverflow=t-16777215,t=t%16777216+1);var i="000000"+t.toString(16),a=i.length;return i="#"+i.substring(a-6,a)},setHitContextStyle:function(e,t,i,a){var n=this.featureIdToHex(t);"fill"==e?(this.hitContext.globalAlpha=1,this.hitContext.fillStyle=n):"stroke"==e?(this.hitContext.globalAlpha=1,this.hitContext.strokeStyle=n,"undefined"==typeof a?this.hitContext.lineWidth=i.strokeWidth+2:isNaN(a)||(this.hitContext.lineWidth=i.strokeWidth+2/a)):(this.hitContext.globalAlpha=0,this.hitContext.lineWidth=1)},drawPoint:function(e,t,i){if(t.graphic!==!1)if(t.externalGraphic)this.drawExternalGraphic(e,t,i);else if(t.graphicName&&"circle"!=t.graphicName)this.drawNamedSymbol(e,t,i);else{var a=this.getLocalXY(e),n=a[0],s=a[1];if(!isNaN(n)&&!isNaN(s)){var r=2*Math.PI,o=t.pointRadius;t.fill!==!1&&(this.setCanvasStyle("fill",t),this.canvas.beginPath(),this.canvas.arc(n,s,o,0,r,!0),this.canvas.fill(),this.hitDetection&&(this.setHitContextStyle("fill",i,t),this.hitContext.beginPath(),this.hitContext.arc(n,s,o,0,r,!0),this.hitContext.fill())),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.canvas.beginPath(),this.canvas.arc(n,s,o,0,r,!0),this.canvas.stroke(),this.hitDetection&&(this.setHitContextStyle("stroke",i,t),this.hitContext.beginPath(),this.hitContext.arc(n,s,o,0,r,!0),this.hitContext.stroke()),this.setCanvasStyle("reset"))}}},drawLineString:function(e,t,i){t=OpenLayers.Util.applyDefaults({fill:!1},t),this.drawLinearRing(e,t,i)},drawLinearRing:function(e,t,i){t.fill!==!1&&(this.setCanvasStyle("fill",t),this.renderPath(this.canvas,e,t,i,"fill"),this.hitDetection&&(this.setHitContextStyle("fill",i,t),this.renderPath(this.hitContext,e,t,i,"fill"))),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.renderPath(this.canvas,e,t,i,"stroke"),this.hitDetection&&(this.setHitContextStyle("stroke",i,t),this.renderPath(this.hitContext,e,t,i,"stroke"))),this.setCanvasStyle("reset")},renderPath:function(e,t,i,a,n){var s=t.components,r=s.length;e.beginPath();var o=this.getLocalXY(s[0]),l=o[0],u=o[1];if(!isNaN(l)&&!isNaN(u)){e.moveTo(o[0],o[1]);for(var c=1;r>c;++c){var h=this.getLocalXY(s[c]);e.lineTo(h[0],h[1])}"fill"===n?e.fill():e.stroke()}},drawPolygon:function(e,t,i){var a=e.components,n=a.length;this.drawLinearRing(a[0],t,i);for(var s=1;n>s;++s)this.canvas.globalCompositeOperation="destination-out",this.hitDetection&&(this.hitContext.globalCompositeOperation="destination-out"),this.drawLinearRing(a[s],OpenLayers.Util.applyDefaults({stroke:!1,fillOpacity:1},t),i),this.canvas.globalCompositeOperation="source-over",this.hitDetection&&(this.hitContext.globalCompositeOperation="source-over"),this.drawLinearRing(a[s],OpenLayers.Util.applyDefaults({fill:!1},t),i)},drawText:function(e,t){var i=this.getLocalXY(e);this.setCanvasStyle("reset"),this.canvas.fillStyle=t.fontColor,this.canvas.globalAlpha=t.fontOpacity||1;var a=[t.fontStyle?t.fontStyle:"normal","normal",t.fontWeight?t.fontWeight:"normal",t.fontSize?t.fontSize:"1em",t.fontFamily?t.fontFamily:"sans-serif"].join(" "),n=t.label.split("\n"),s=n.length;if(this.canvas.fillText){this.canvas.font=a,this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[0]]||"center",this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[1]]||"middle";var r=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];null==r&&(r=-.5);var o=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;i[1]+=o*r*(s-1);for(var l=0;s>l;l++)t.labelOutlineWidth&&(this.canvas.save(),this.canvas.strokeStyle=t.labelOutlineColor,this.canvas.lineWidth=t.labelOutlineWidth,this.canvas.strokeText(n[l],i[0],i[1]+o*l+1),this.canvas.restore()),this.canvas.fillText(n[l],i[0],i[1]+o*l)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=a;var u=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[0]];null==u&&(u=-.5);var r=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];null==r&&(r=-.5);var o=this.canvas.mozMeasureText("xx");i[1]+=o*(1+r*s);for(var l=0;s>l;l++){var c=i[0]+u*this.canvas.mozMeasureText(n[l]),h=i[1]+l*o;this.canvas.translate(c,h),this.canvas.mozDrawText(n[l]),this.canvas.translate(-c,-h)}}this.setCanvasStyle("reset")},getLocalXY:function(e){var t=this.getResolution(),i=this.extent,a=(e.x-this.featureDx)/t+-i.left/t,n=i.top/t-e.y/t;return[a,n]},clear:function(){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.features={},this.hitDetection&&this.hitContext.clearRect(0,0,t,e)},getFeatureIdFromEvent:function(e){var t,i;if(this.hitDetection&&"none"!==this.root.style.display&&!this.map.dragging){var a=e.xy,n=0|a.x,s=0|a.y,r=this.hitContext.getImageData(n,s,1,1).data;if(255===r[3]){var o=r[2]+256*(r[1]+256*r[0]);if(o){t="OpenLayers.Feature.Vector_"+(o-1+this.hitOverflow);try{i=this.features[t][0]}catch(l){}}}}return i},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0;t<e.length;++t)delete this.features[e[t].id];this.redraw()},redraw:function(){if(!this.locked){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.hitDetection&&this.hitContext.clearRect(0,0,t,e);var i,a,n,s=[],r=this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent();for(var o in this.features)this.features.hasOwnProperty(o)&&(i=this.features[o][0],a=i.geometry,this.calculateFeatureDx(a.getBounds(),r),n=this.features[o][1],this.drawGeometry(a,n,i.id),n.label&&s.push([i,n]));for(var l,u=0,c=s.length;c>u;++u)l=s[u],this.drawText(l[0].geometry.getCentroid(),l[1])}},CLASS_NAME:"OpenLayers.Renderer.Canvas"}),OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"},OpenLayers.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1},OpenLayers.Renderer.Canvas.drawImageScaleFactor=null,OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var e=document.createStyleSheet(),t=["shape","rect","oval","fill","stroke","imagedata","group","textbox"],i=0,a=t.length;a>i;i++)e.addRule("olv\\:"+t[i],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments)}},supported:function(){return!!document.namespaces},setExtent:function(e,t){var i=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),a=this.getResolution(),n=0|e.left/a,s=0|e.top/a-this.size.h;t||!this.offset?(this.offset={x:n,y:s},n=0,s=0):(n-=this.offset.x,s-=this.offset.y);var r=n-this.xOffset+" "+s;this.root.coordorigin=r;for(var o,l=[this.root,this.vectorRoot,this.textRoot],u=0,c=l.length;c>u;++u){o=l[u];var h=this.size.w+" "+this.size.h;o.coordsize=h}return this.root.style.flip="y",i},setSize:function(){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);for(var e,t=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],i=this.size.w+"px",a=this.size.h+"px",n=0,s=t.length;s>n;++n)e=t[n],e.style.width=i,e.style.height=a},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"olv:rect":this.isComplexSymbol(t.graphicName)?"olv:shape":"olv:oval";break;case"OpenLayers.Geometry.Rectangle":i="olv:rect";break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.LinearRing":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":i="olv:shape"}return i},setStyle:function(e,t,i,a){t=t||e._style,i=i||e._options;var n=t.fillColor;if("OpenLayers.Geometry.Point"===e._geometryClass)if(t.externalGraphic){i.isFilled=!0,t.graphicTitle&&(e.title=t.graphicTitle);var s=t.graphicWidth||t.graphicHeight,r=t.graphicHeight||t.graphicWidth;s=s?s:2*t.pointRadius,r=r?r:2*t.pointRadius;var o=this.getResolution(),l=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*s),u=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*r);e.style.left=(0|(a.x-this.featureDx)/o-this.offset.x+l)+"px",e.style.top=(0|a.y/o-this.offset.y-(u+r))+"px",e.style.width=s+"px",e.style.height=r+"px",e.style.flip="y",n="none",i.isStroked=!1}else if(this.isComplexSymbol(t.graphicName)){var c=this.importSymbol(t.graphicName);e.path=c.path,e.coordorigin=c.left+","+c.bottom;var h=c.size;e.coordsize=h+","+h,this.drawCircle(e,a,t.pointRadius),e.style.flip="y"}else this.drawCircle(e,a,t.pointRadius);i.isFilled?e.fillcolor=n:e.filled="false";var d=e.getElementsByTagName("fill"),p=0==d.length?null:d[0];i.isFilled?(p||(p=this.createNode("olv:fill",e.id+"_fill")),p.opacity=t.fillOpacity,"OpenLayers.Geometry.Point"===e._geometryClass&&t.externalGraphic&&(t.graphicOpacity&&(p.opacity=t.graphicOpacity),p.src=t.externalGraphic,p.type="frame",t.graphicWidth&&t.graphicHeight||(p.aspect="atmost")),p.parentNode!=e&&e.appendChild(p)):p&&e.removeChild(p);var f=t.rotation;(void 0!==f||void 0!==e._rotation)&&(e._rotation=f,t.externalGraphic?(this.graphicRotate(e,l,u,t),p.opacity=0):"OpenLayers.Geometry.Point"===e._geometryClass&&(e.style.rotation=f||0));var m=e.getElementsByTagName("stroke"),g=0==m.length?null:m[0];return i.isStroked?(g||(g=this.createNode("olv:stroke",e.id+"_stroke"),e.appendChild(g)),g.on=!0,g.color=t.strokeColor,g.weight=t.strokeWidth+"px",g.opacity=t.strokeOpacity,g.endcap="butt"==t.strokeLinecap?"flat":t.strokeLinecap||"round",t.strokeDashstyle&&(g.dashstyle=this.dashStyle(t))):(e.stroked=!1,g&&(g.on=!1)),"inherit"!=t.cursor&&null!=t.cursor&&(e.style.cursor=t.cursor),e},graphicRotate:function(e,t,i,a){var n,s,a=a||e._style,r=a.rotation||0;if(!a.graphicWidth||!a.graphicHeight){var o=new Image;return o.onreadystatechange=OpenLayers.Function.bind(function(){("complete"==o.readyState||"interactive"==o.readyState)&&(n=o.width/o.height,s=Math.max(2*a.pointRadius,a.graphicWidth||0,a.graphicHeight||0),t*=n,a.graphicWidth=s*n,a.graphicHeight=s,this.graphicRotate(e,t,i,a))},this),o.src=a.externalGraphic,void 0}s=Math.max(a.graphicWidth,a.graphicHeight),n=a.graphicWidth/a.graphicHeight;var l=Math.round(a.graphicWidth||s*n),u=Math.round(a.graphicHeight||s);e.style.width=l+"px",e.style.height=u+"px";var c=document.getElementById(e.id+"_image");c||(c=this.createNode("olv:imagedata",e.id+"_image"),e.appendChild(c)),c.style.width=l+"px",c.style.height=u+"px",c.src=a.externalGraphic,c.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var h=r*Math.PI/180,d=Math.sin(h),p=Math.cos(h),f="progid:DXImageTransform.Microsoft.Matrix(M11="+p+",M12="+-d+",M21="+d+",M22="+p+",SizingMethod='auto expand')\n",m=a.graphicOpacity||a.fillOpacity;m&&1!=m&&(f+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+m+")\n"),e.style.filter=f;var g=new OpenLayers.Geometry.Point(-t,-i),y=new OpenLayers.Bounds(0,0,l,u).toGeometry();y.rotate(a.rotation,g);var v=y.getBounds();e.style.left=Math.round(parseInt(e.style.left)+v.left)+"px",e.style.top=Math.round(parseInt(e.style.top)-v.bottom)+"px"},postDraw:function(e){e.style.visibility="visible";var t=e._style.fillColor,i=e._style.strokeColor;"none"==t&&e.fillcolor!=t&&(e.fillcolor=t),"none"==i&&e.strokecolor!=i&&(e.strokecolor=i)},setNodeDimension:function(e,t){var i=t.getBounds();if(i){var a=this.getResolution(),n=new OpenLayers.Bounds(0|(i.left-this.featureDx)/a-this.offset.x,0|i.bottom/a-this.offset.y,0|(i.right-this.featureDx)/a-this.offset.x,0|i.top/a-this.offset.y);e.style.left=n.left+"px",e.style.top=n.top+"px",e.style.width=n.getWidth()+"px",e.style.height=n.getHeight()+"px",e.coordorigin=n.left+" "+n.top,e.coordsize=n.getWidth()+" "+n.getHeight()}},dashStyle:function(e){var t=e.strokeDashstyle;switch(t){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return t;default:var i=t.split(/[ ,]/);return 2==i.length?1*i[0]>=2*i[1]?"longdash":1==i[0]||1==i[1]?"dot":"dash":4==i.length?1*i[0]>=2*i[1]?"longdashdot":"dashdot":"solid"}},createNode:function(e,t){var i=document.createElement(e);return t&&(i.id=t),i.unselectable="on",i.onselectstart=OpenLayers.Function.False,i},nodeTypeCompare:function(e,t){var i=t,a=i.indexOf(":");-1!=a&&(i=i.substr(a+1));var n=e.nodeName;return a=n.indexOf(":"),-1!=a&&(n=n.substr(a+1)),i==n},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(e){return this.nodeFactory(this.container.id+e,"olv:group")},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){if(!isNaN(t.x)&&!isNaN(t.y)){var a=this.getResolution();e.style.left=(0|(t.x-this.featureDx)/a-this.offset.x)-i+"px",e.style.top=(0|t.y/a-this.offset.y)-i+"px";var n=2*i;return e.style.width=n+"px",e.style.height=n+"px",e}return!1},drawLineString:function(e,t){return this.drawLine(e,t,!1)},drawLinearRing:function(e,t){return this.drawLine(e,t,!0)},drawLine:function(e,t,i){this.setNodeDimension(e,t);for(var a,n,s,r=this.getResolution(),o=t.components.length,l=new Array(o),u=0;o>u;u++)a=t.components[u],n=0|(a.x-this.featureDx)/r-this.offset.x,s=0|a.y/r-this.offset.y,l[u]=" "+n+","+s+" l ";var c=i?" x e":" e";return e.path="m"+l.join("")+c,e},drawPolygon:function(e,t){this.setNodeDimension(e,t);var i,a,n,s,r,o,l,u,c,h,d,p,f=this.getResolution(),m=[];for(i=0,a=t.components.length;a>i;i++){for(m.push("m"),n=t.components[i].components,s=0===i,r=null,o=null,l=0,u=n.length;u>l;l++)c=n[l],d=0|(c.x-this.featureDx)/f-this.offset.x,p=0|c.y/f-this.offset.y,h=" "+d+","+p,m.push(h),0==l&&m.push(" l"),s||(r?r!=h&&(o?o!=h&&(s=!0):o=h):r=h);m.push(s?" x ":" ")}return m.push("e"),e.path=m.join(""),e},drawRectangle:function(e,t){var i=this.getResolution();return e.style.left=(0|(t.x-this.featureDx)/i-this.offset.x)+"px",e.style.top=(0|t.y/i-this.offset.y)+"px",e.style.width=(0|t.width/i)+"px",e.style.height=(0|t.height/i)+"px",e},drawText:function(e,t,i){var a=this.nodeFactory(e+this.LABEL_ID_SUFFIX,"olv:rect"),n=this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),s=this.getResolution();a.style.left=(0|(i.x-this.featureDx)/s-this.offset.x)+"px",a.style.top=(0|i.y/s-this.offset.y)+"px",a.style.flip="y",n.innerText=t.label,"inherit"!=t.cursor&&null!=t.cursor&&(n.style.cursor=t.cursor),t.fontColor&&(n.style.color=t.fontColor),t.fontOpacity&&(n.style.filter="alpha(opacity="+100*t.fontOpacity+")"),t.fontFamily&&(n.style.fontFamily=t.fontFamily),t.fontSize&&(n.style.fontSize=t.fontSize),t.fontWeight&&(n.style.fontWeight=t.fontWeight),t.fontStyle&&(n.style.fontStyle=t.fontStyle),t.labelSelect===!0&&(a._featureId=e,n._featureId=e,n._geometry=i,n._geometryClass=i.CLASS_NAME),n.style.whiteSpace="nowrap",n.inset="1px,0px,0px,0px",a.parentNode||(a.appendChild(n),this.textRoot.appendChild(a));var r=t.labelAlign||"cm";1==r.length&&(r+="m");var o=n.clientWidth*OpenLayers.Renderer.VML.LABEL_SHIFT[r.substr(0,1)],l=n.clientHeight*OpenLayers.Renderer.VML.LABEL_SHIFT[r.substr(1,1)];a.style.left=parseInt(a.style.left)-o-1+"px",a.style.top=parseInt(a.style.top)+l+"px"},moveRoot:function(e){var t=this.map.getLayer(e.container.id);t instanceof OpenLayers.Layer.Vector.RootContainer&&(t=this.map.getLayer(this.container.id)),t&&t.renderer.clear(),OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments),t&&t.redraw()},importSymbol:function(e){var t=this.container.id+"-"+e,i=this.symbolCache[t];if(i)return i;var a=OpenLayers.Renderer.symbol[e];if(!a)throw new Error(e+" is not a valid symbol name");for(var n=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),s=["m"],r=0;r<a.length;r+=2){var o=a[r],l=a[r+1];n.left=Math.min(n.left,o),n.bottom=Math.min(n.bottom,l),n.right=Math.max(n.right,o),n.top=Math.max(n.top,l),s.push(o),s.push(l),0==r&&s.push("l")}s.push("x e");var u=s.join(" "),c=(n.getWidth()-n.getHeight())/2;return c>0?(n.bottom=n.bottom-c,n.top=n.top+c):(n.left=n.left+c,n.right=n.right-c),i={path:u,size:n.getWidth(),left:n.left,bottom:n.bottom},this.symbolCache[t]=i,i},CLASS_NAME:"OpenLayers.Renderer.VML"}),OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:.5,r:1,t:0,m:.5,b:1},OpenLayers.Layer.Vector=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,isFixed:!1,features:null,filter:null,selectedFeatures:null,unrenderedFeatures:null,reportError:!0,style:null,styleMap:null,strategies:null,protocol:null,renderers:["SVG","VML","Canvas"],renderer:null,rendererOptions:null,geometryType:null,drawn:!1,ratio:1,initialize:function(){if(OpenLayers.Layer.prototype.initialize.apply(this,arguments),this.renderer&&this.renderer.supported()||this.assignRenderer(),this.renderer&&this.renderer.supported()||(this.renderer=null,this.displayError()),this.styleMap||(this.styleMap=new OpenLayers.StyleMap),this.features=[],this.selectedFeatures=[],this.unrenderedFeatures={},this.strategies)for(var e=0,t=this.strategies.length;t>e;e++)this.strategies[e].setLayer(this)},destroy:function(){if(this.strategies){var e,t,i;for(t=0,i=this.strategies.length;i>t;t++)e=this.strategies[t],e.autoDestroy&&e.destroy();this.strategies=null}this.protocol&&(this.protocol.autoDestroy&&this.protocol.destroy(),this.protocol=null),this.destroyFeatures(),this.features=null,this.selectedFeatures=null,this.unrenderedFeatures=null,this.renderer&&this.renderer.destroy(),this.renderer=null,this.geometryType=null,this.drawn=null,OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(e){null==e&&(e=new OpenLayers.Layer.Vector(this.name,this.getOptions())),e=OpenLayers.Layer.prototype.clone.apply(this,[e]);for(var t=this.features,i=t.length,a=new Array(i),n=0;i>n;++n)a[n]=t[n].clone();return e.features=a,e},refresh:function(e){this.calculateInRange()&&this.visibility&&this.events.triggerEvent("refresh",e)},assignRenderer:function(){for(var e=0,t=this.renderers.length;t>e;e++){var i=this.renderers[e],a="function"==typeof i?i:OpenLayers.Renderer[i];if(a&&a.prototype.supported()){this.renderer=new a(this.div,this.rendererOptions);break}}},displayError:function(){this.reportError&&OpenLayers.Console.userError(OpenLayers.i18n("browserNotSupported",{renderers:this.renderers.join("\n")}))},setMap:function(){if(OpenLayers.Layer.prototype.setMap.apply(this,arguments),this.renderer){this.renderer.map=this.map;var e=this.map.getSize();e.w=e.w*this.ratio,e.h=e.h*this.ratio,this.renderer.setSize(e)}else this.map.removeLayer(this)},afterAdd:function(){if(this.strategies){var e,t,i;for(t=0,i=this.strategies.length;i>t;t++)e=this.strategies[t],e.autoActivate&&e.activate()}},removeMap:function(){if(this.drawn=!1,this.strategies){var e,t,i;for(t=0,i=this.strategies.length;i>t;t++)e=this.strategies[t],e.autoActivate&&e.deactivate()}},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.apply(this,arguments);var e=this.map.getSize();e.w=e.w*this.ratio,e.h=e.h*this.ratio,this.renderer.setSize(e)},moveTo:function(e,t,i){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var a=!0;if(!i){this.renderer.root.style.visibility="hidden";var n=this.map.getSize(),s=n.w,r=n.h,o=s/2*this.ratio-s/2,l=r/2*this.ratio-r/2;o+=parseInt(this.map.layerContainerDiv.style.left,10),o=-Math.round(o),l+=parseInt(this.map.layerContainerDiv.style.top,10),l=-Math.round(l),this.div.style.left=o+"px",this.div.style.top=l+"px";var u=this.map.getExtent().scale(this.ratio);if(a=this.renderer.setExtent(u,t),this.renderer.root.style.visibility="visible",OpenLayers.IS_GECKO===!0&&(this.div.scrollLeft=this.div.scrollLeft),!t&&a)for(var c in this.unrenderedFeatures){var h=this.unrenderedFeatures[c];this.drawFeature(h)}}if(!this.drawn||t||!a){this.drawn=!0;for(var h,c=0,d=this.features.length;d>c;c++)this.renderer.locked=c!==d-1,h=this.features[c],this.drawFeature(h)}},display:function(){OpenLayers.Layer.prototype.display.apply(this,arguments);var e=this.div.style.display;e!=this.renderer.root.style.display&&(this.renderer.root.style.display=e)},addFeatures:function(e,t){OpenLayers.Util.isArray(e)||(e=[e]);var i=!t||!t.silent;if(i){var a={features:e},n=this.events.triggerEvent("beforefeaturesadded",a);if(n===!1)return;e=a.features}for(var s=[],r=0,o=e.length;o>r;r++){this.renderer.locked=r!=e.length-1?!0:!1;var l=e[r];if(this.geometryType&&!(l.geometry instanceof this.geometryType))throw new TypeError("addFeatures: component should be an "+this.geometryType.prototype.CLASS_NAME);if(l.layer=this,!l.style&&this.style&&(l.style=OpenLayers.Util.extend({},this.style)),i){if(this.events.triggerEvent("beforefeatureadded",{feature:l})===!1)continue;this.preFeatureInsert(l)}s.push(l),this.features.push(l),this.drawFeature(l),i&&(this.events.triggerEvent("featureadded",{feature:l}),this.onFeatureInsert(l))}i&&this.events.triggerEvent("featuresadded",{features:s})},removeFeatures:function(e,t){if(e&&0!==e.length){if(e===this.features)return this.removeAllFeatures(t);OpenLayers.Util.isArray(e)||(e=[e]),e===this.selectedFeatures&&(e=e.slice());var i=!t||!t.silent;i&&this.events.triggerEvent("beforefeaturesremoved",{features:e});for(var a=e.length-1;a>=0;a--){this.renderer.locked=0!=a&&e[a-1].geometry?!0:!1;var n=e[a];delete this.unrenderedFeatures[n.id],i&&this.events.triggerEvent("beforefeatureremoved",{feature:n}),this.features=OpenLayers.Util.removeItem(this.features,n),n.layer=null,n.geometry&&this.renderer.eraseFeatures(n),-1!=OpenLayers.Util.indexOf(this.selectedFeatures,n)&&OpenLayers.Util.removeItem(this.selectedFeatures,n),i&&this.events.triggerEvent("featureremoved",{feature:n})}i&&this.events.triggerEvent("featuresremoved",{features:e})}},removeAllFeatures:function(e){var t=!e||!e.silent,i=this.features;t&&this.events.triggerEvent("beforefeaturesremoved",{features:i});for(var a,n=i.length-1;n>=0;n--)a=i[n],t&&this.events.triggerEvent("beforefeatureremoved",{feature:a}),a.layer=null,t&&this.events.triggerEvent("featureremoved",{feature:a});this.renderer.clear(),this.features=[],this.unrenderedFeatures={},this.selectedFeatures=[],t&&this.events.triggerEvent("featuresremoved",{features:i})},destroyFeatures:function(e,t){var i=void 0==e;if(i&&(e=this.features),e){this.removeFeatures(e,t);for(var a=e.length-1;a>=0;a--)e[a].destroy()}},drawFeature:function(e,t){if(this.drawn){if("object"!=typeof t){t||e.state!==OpenLayers.State.DELETE||(t="delete");var i=t||e.renderIntent;t=e.style||this.style,t||(t=this.styleMap.createSymbolizer(e,i))}var a=this.renderer.drawFeature(e,t);a===!1||null===a?this.unrenderedFeatures[e.id]=e:delete this.unrenderedFeatures[e.id]}},eraseFeatures:function(e){this.renderer.eraseFeatures(e)},getFeatureFromEvent:function(e){if(!this.renderer)throw new Error("getFeatureFromEvent called on layer with no renderer. This usually means you destroyed a layer, but not some handler which is associated with it.");
var t=null,i=this.renderer.getFeatureIdFromEvent(e);return i&&(t="string"==typeof i?this.getFeatureById(i):i),t},getFeatureBy:function(e,t){for(var i=null,a=0,n=this.features.length;n>a;++a)if(this.features[a][e]==t){i=this.features[a];break}return i},getFeatureById:function(e){return this.getFeatureBy("id",e)},getFeatureByFid:function(e){return this.getFeatureBy("fid",e)},getFeaturesByAttribute:function(e,t){var i,a,n=this.features.length,s=[];for(i=0;n>i;i++)a=this.features[i],a&&a.attributes&&a.attributes[e]===t&&s.push(a);return s},onFeatureInsert:function(){},preFeatureInsert:function(){},getDataExtent:function(){var e=null,t=this.features;if(t&&t.length>0)for(var i=null,a=0,n=t.length;n>a;a++)i=t[a].geometry,i&&(null===e&&(e=new OpenLayers.Bounds),e.extend(i.getBounds()));return e},CLASS_NAME:"OpenLayers.Layer.Vector"}),OpenLayers.Layer.Vector.RootContainer=OpenLayers.Class(OpenLayers.Layer.Vector,{displayInLayerSwitcher:!1,layers:null,display:function(){},getFeatureFromEvent:function(e){for(var t,i=this.layers,a=0;a<i.length;a++)if(t=i[a].getFeatureFromEvent(e))return t},setMap:function(e){OpenLayers.Layer.Vector.prototype.setMap.apply(this,arguments),this.collectRoots(),e.events.register("changelayer",this,this.handleChangeLayer)},removeMap:function(e){e.events.unregister("changelayer",this,this.handleChangeLayer),this.resetRoots(),OpenLayers.Layer.Vector.prototype.removeMap.apply(this,arguments)},collectRoots:function(){for(var e,t=0;t<this.map.layers.length;++t)e=this.map.layers[t],-1!=OpenLayers.Util.indexOf(this.layers,e)&&e.renderer.moveRoot(this.renderer)},resetRoots:function(){for(var e,t=0;t<this.layers.length;++t)e=this.layers[t],this.renderer&&e.renderer.getRenderLayerId()==this.id&&this.renderer.moveRoot(e.renderer)},handleChangeLayer:function(e){var t=e.layer;"order"==e.property&&-1!=OpenLayers.Util.indexOf(this.layers,t)&&(this.resetRoots(),this.collectRoots())},CLASS_NAME:"OpenLayers.Layer.Vector.RootContainer"}),OpenLayers.Strategy=OpenLayers.Class({layer:null,options:null,active:null,autoActivate:!0,autoDestroy:!0,initialize:function(e){OpenLayers.Util.extend(this,e),this.options=e,this.active=!1},destroy:function(){this.deactivate(),this.layer=null,this.options=null},setLayer:function(e){this.layer=e},activate:function(){return this.active?!1:(this.active=!0,!0)},deactivate:function(){return this.active?(this.active=!1,!0):!1},CLASS_NAME:"OpenLayers.Strategy"}),OpenLayers.Filter=OpenLayers.Class({initialize:function(e){OpenLayers.Util.extend(this,e)},destroy:function(){},evaluate:function(){return!0},clone:function(){return null},toString:function(){var e;return e=OpenLayers.Format&&OpenLayers.Format.CQL?OpenLayers.Format.CQL.prototype.write(this):Object.prototype.toString.call(this)},CLASS_NAME:"OpenLayers.Filter"}),OpenLayers.Filter.FeatureId=OpenLayers.Class(OpenLayers.Filter,{fids:null,type:"FID",initialize:function(e){this.fids=[],OpenLayers.Filter.prototype.initialize.apply(this,[e])},evaluate:function(e){for(var t=0,i=this.fids.length;i>t;t++){var a=e.fid||e.id;if(a==this.fids[t])return!0}return!1},clone:function(){var e=new OpenLayers.Filter.FeatureId;return OpenLayers.Util.extend(e,this),e.fids=this.fids.slice(),e},CLASS_NAME:"OpenLayers.Filter.FeatureId"}),OpenLayers.Filter.Logical=OpenLayers.Class(OpenLayers.Filter,{filters:null,type:null,initialize:function(e){this.filters=[],OpenLayers.Filter.prototype.initialize.apply(this,[e])},destroy:function(){this.filters=null,OpenLayers.Filter.prototype.destroy.apply(this)},evaluate:function(e){var t,i;switch(this.type){case OpenLayers.Filter.Logical.AND:for(t=0,i=this.filters.length;i>t;t++)if(0==this.filters[t].evaluate(e))return!1;return!0;case OpenLayers.Filter.Logical.OR:for(t=0,i=this.filters.length;i>t;t++)if(1==this.filters[t].evaluate(e))return!0;return!1;case OpenLayers.Filter.Logical.NOT:return!this.filters[0].evaluate(e)}return void 0},clone:function(){for(var e=[],t=0,i=this.filters.length;i>t;++t)e.push(this.filters[t].clone());return new OpenLayers.Filter.Logical({type:this.type,filters:e})},CLASS_NAME:"OpenLayers.Filter.Logical"}),OpenLayers.Filter.Logical.AND="&&",OpenLayers.Filter.Logical.OR="||",OpenLayers.Filter.Logical.NOT="!",OpenLayers.Filter.Comparison=OpenLayers.Class(OpenLayers.Filter,{type:null,property:null,value:null,matchCase:!0,lowerBoundary:null,upperBoundary:null,initialize:function(e){OpenLayers.Filter.prototype.initialize.apply(this,[e]),this.type===OpenLayers.Filter.Comparison.LIKE&&void 0===e.matchCase&&(this.matchCase=null)},evaluate:function(e){e instanceof OpenLayers.Feature.Vector&&(e=e.attributes);var t,i=!1,a=e[this.property];switch(this.type){case OpenLayers.Filter.Comparison.EQUAL_TO:t=this.value,i=this.matchCase||"string"!=typeof a||"string"!=typeof t?a==t:a.toUpperCase()==t.toUpperCase();break;case OpenLayers.Filter.Comparison.NOT_EQUAL_TO:t=this.value,i=this.matchCase||"string"!=typeof a||"string"!=typeof t?a!=t:a.toUpperCase()!=t.toUpperCase();break;case OpenLayers.Filter.Comparison.LESS_THAN:i=a<this.value;break;case OpenLayers.Filter.Comparison.GREATER_THAN:i=a>this.value;break;case OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO:i=a<=this.value;break;case OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO:i=a>=this.value;break;case OpenLayers.Filter.Comparison.BETWEEN:i=a>=this.lowerBoundary&&a<=this.upperBoundary;break;case OpenLayers.Filter.Comparison.LIKE:var n=new RegExp(this.value,"gi");i=n.test(a)}return i},value2regex:function(e,t,i){if("."==e)throw new Error("'.' is an unsupported wildCard character for OpenLayers.Filter.Comparison");return e=e?e:"*",t=t?t:".",i=i?i:"!",this.value=this.value.replace(new RegExp("\\"+i+"(.|$)","g"),"\\$1"),this.value=this.value.replace(new RegExp("\\"+t,"g"),"."),this.value=this.value.replace(new RegExp("\\"+e,"g"),".*"),this.value=this.value.replace(new RegExp("\\\\.\\*","g"),"\\"+e),this.value=this.value.replace(new RegExp("\\\\\\.","g"),"\\"+t),this.value},regex2value:function(){var e=this.value;return e=e.replace(/!/g,"!!"),e=e.replace(/(\\)?\\\./g,function(e,t){return t?e:"!."}),e=e.replace(/(\\)?\\\*/g,function(e,t){return t?e:"!*"}),e=e.replace(/\\\\/g,"\\"),e=e.replace(/\.\*/g,"*")},clone:function(){return OpenLayers.Util.extend(new OpenLayers.Filter.Comparison,this)},CLASS_NAME:"OpenLayers.Filter.Comparison"}),OpenLayers.Filter.Comparison.EQUAL_TO="==",OpenLayers.Filter.Comparison.NOT_EQUAL_TO="!=",OpenLayers.Filter.Comparison.LESS_THAN="<",OpenLayers.Filter.Comparison.GREATER_THAN=">",OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO="<=",OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO=">=",OpenLayers.Filter.Comparison.BETWEEN="..",OpenLayers.Filter.Comparison.LIKE="~",OpenLayers.Filter.Spatial=OpenLayers.Class(OpenLayers.Filter,{type:null,property:null,value:null,distance:null,distanceUnits:null,evaluate:function(e){var t=!1;switch(this.type){case OpenLayers.Filter.Spatial.BBOX:case OpenLayers.Filter.Spatial.INTERSECTS:if(e.geometry){var i=this.value;"OpenLayers.Bounds"==this.value.CLASS_NAME&&(i=this.value.toGeometry()),e.geometry.intersects(i)&&(t=!0)}break;default:throw new Error("evaluate is not implemented for this filter type.")}return t},clone:function(){var e=OpenLayers.Util.applyDefaults({value:this.value&&this.value.clone&&this.value.clone()},this);return new OpenLayers.Filter.Spatial(e)},CLASS_NAME:"OpenLayers.Filter.Spatial"}),OpenLayers.Filter.Spatial.BBOX="BBOX",OpenLayers.Filter.Spatial.INTERSECTS="INTERSECTS",OpenLayers.Filter.Spatial.DWITHIN="DWITHIN",OpenLayers.Filter.Spatial.WITHIN="WITHIN",OpenLayers.Filter.Spatial.CONTAINS="CONTAINS",OpenLayers.Filter.Function=OpenLayers.Class(OpenLayers.Filter,{name:null,params:null,CLASS_NAME:"OpenLayers.Filter.Function"}),OpenLayers.Protocol=OpenLayers.Class({format:null,options:null,autoDestroy:!0,defaultFilter:null,initialize:function(e){e=e||{},OpenLayers.Util.extend(this,e),this.options=e},mergeWithDefaultFilter:function(e){var t;return t=e&&this.defaultFilter?new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[this.defaultFilter,e]}):e||this.defaultFilter||void 0},destroy:function(){this.options=null,this.format=null},read:function(e){e=e||{},e.filter=this.mergeWithDefaultFilter(e.filter)},create:function(){},update:function(){},"delete":function(){},commit:function(){},abort:function(){},createCallback:function(e,t,i){return OpenLayers.Function.bind(function(){e.apply(this,[t,i])},this)},CLASS_NAME:"OpenLayers.Protocol"}),OpenLayers.Protocol.Response=OpenLayers.Class({code:null,requestType:null,last:!0,features:null,data:null,reqFeatures:null,priv:null,error:null,initialize:function(e){OpenLayers.Util.extend(this,e)},success:function(){return this.code>0},CLASS_NAME:"OpenLayers.Protocol.Response"}),OpenLayers.Protocol.Response.SUCCESS=1,OpenLayers.Protocol.Response.FAILURE=0,OpenLayers.Protocol.WFS=function(e){e=OpenLayers.Util.applyDefaults(e,OpenLayers.Protocol.WFS.DEFAULTS);var t=OpenLayers.Protocol.WFS["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported WFS version: "+e.version;return new t(e)},OpenLayers.Protocol.WFS.fromWMSLayer=function(e,t){var i,a,n=e.params.LAYERS,s=(OpenLayers.Util.isArray(n)?n[0]:n).split(":");s.length>1&&(a=s[0]),i=s.pop();var r={url:e.url,featureType:i,featurePrefix:a,srsName:e.projection&&e.projection.getCode()||e.map&&e.map.getProjectionObject().getCode(),version:"1.1.0"};return new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults(t,r))},OpenLayers.Protocol.WFS.DEFAULTS={version:"1.0.0"},OpenLayers.Protocol.WFS.v1=OpenLayers.Class(OpenLayers.Protocol,{version:null,srsName:"EPSG:4326",featureType:null,featureNS:null,geometryName:"the_geom",schema:null,featurePrefix:"feature",formatOptions:null,readFormat:null,readOptions:null,initialize:function(e){OpenLayers.Protocol.prototype.initialize.apply(this,[e]),e.format||(this.format=OpenLayers.Format.WFST(OpenLayers.Util.extend({version:this.version,featureType:this.featureType,featureNS:this.featureNS,featurePrefix:this.featurePrefix,geometryName:this.geometryName,srsName:this.srsName,schema:this.schema},this.formatOptions))),!e.geometryName&&parseFloat(this.format.version)>1&&this.setGeometryName(null)},destroy:function(){this.options&&!this.options.format&&this.format.destroy(),this.format=null,OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(e){OpenLayers.Protocol.prototype.read.apply(this,arguments),e=OpenLayers.Util.extend({},e),OpenLayers.Util.applyDefaults(e,this.options||{});var t=new OpenLayers.Protocol.Response({requestType:"read"}),i=OpenLayers.Format.XML.prototype.write.apply(this.format,[this.format.writeNode("wfs:GetFeature",e)]);return t.priv=OpenLayers.Request.POST({url:e.url,callback:this.createCallback(this.handleRead,t,e),params:e.params,headers:e.headers,data:i}),t},setFeatureType:function(e){this.featureType=e,this.format.featureType=e},setGeometryName:function(e){this.geometryName=e,this.format.geometryName=e},handleRead:function(e,t){if(t=OpenLayers.Util.extend({},t),OpenLayers.Util.applyDefaults(t,this.options),t.callback){var i=e.priv;if(i.status>=200&&i.status<300){var a=this.parseResponse(i,t.readOptions);a&&a.success!==!1?(t.readOptions&&"object"==t.readOptions.output?OpenLayers.Util.extend(e,a):e.features=a,e.code=OpenLayers.Protocol.Response.SUCCESS):(e.code=OpenLayers.Protocol.Response.FAILURE,e.error=a)}else e.code=OpenLayers.Protocol.Response.FAILURE;t.callback.call(t.scope,e)}},parseResponse:function(e,t){var i=e.responseXML;if(i&&i.documentElement||(i=e.responseText),!i||i.length<=0)return null;var a=null!==this.readFormat?this.readFormat.read(i):this.format.read(i,t);if(!this.featureNS){var n=this.readFormat||this.format;this.featureNS=n.featureNS,n.autoConfig=!1,this.geometryName||this.setGeometryName(n.geometryName)}return a},commit:function(e,t){t=OpenLayers.Util.extend({},t),OpenLayers.Util.applyDefaults(t,this.options);var i=new OpenLayers.Protocol.Response({requestType:"commit",reqFeatures:e});return i.priv=OpenLayers.Request.POST({url:t.url,headers:t.headers,data:this.format.write(e,t),callback:this.createCallback(this.handleCommit,i,t)}),i},handleCommit:function(e,t){if(t.callback){var i=e.priv,a=i.responseXML;a&&a.documentElement||(a=i.responseText);var n=this.format.read(a)||{};e.insertIds=n.insertIds||[],n.success?e.code=OpenLayers.Protocol.Response.SUCCESS:(e.code=OpenLayers.Protocol.Response.FAILURE,e.error=n),t.callback.call(t.scope,e)}},filterDelete:function(e,t){t=OpenLayers.Util.extend({},t),OpenLayers.Util.applyDefaults(t,this.options),new OpenLayers.Protocol.Response({requestType:"commit"});var i=this.format.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version}}),a=this.format.createElementNSPlus("wfs:Delete",{attributes:{typeName:(t.featureNS?this.featurePrefix+":":"")+t.featureType}});t.featureNS&&a.setAttribute("xmlns:"+this.featurePrefix,t.featureNS);var n=this.format.writeNode("ogc:Filter",e);a.appendChild(n),i.appendChild(a);var s=OpenLayers.Format.XML.prototype.write.apply(this.format,[i]);return OpenLayers.Request.POST({url:this.url,callback:t.callback||function(){},data:s})},abort:function(e){e&&e.priv.abort()},CLASS_NAME:"OpenLayers.Protocol.WFS.v1"}),OpenLayers.Protocol.WFS.v1_1_0=OpenLayers.Class(OpenLayers.Protocol.WFS.v1,{version:"1.1.0",initialize:function(){OpenLayers.Protocol.WFS.v1.prototype.initialize.apply(this,arguments),this.outputFormat&&!this.readFormat&&("gml2"==this.outputFormat.toLowerCase()?this.readFormat=new OpenLayers.Format.GML.v2({featureType:this.featureType,featureNS:this.featureNS,geometryName:this.geometryName}):"json"==this.outputFormat.toLowerCase()&&(this.readFormat=new OpenLayers.Format.GeoJSON))},CLASS_NAME:"OpenLayers.Protocol.WFS.v1_1_0"}),OpenLayers.Style=OpenLayers.Class({id:null,name:null,title:null,description:null,layerName:null,isDefault:!1,rules:null,context:null,defaultStyle:null,defaultsPerSymbolizer:!1,propertyStyles:null,initialize:function(e,t){OpenLayers.Util.extend(this,t),this.rules=[],t&&t.rules&&this.addRules(t.rules),this.setDefaultStyle(e||OpenLayers.Feature.Vector.style["default"]),this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var e=0,t=this.rules.length;t>e;e++)this.rules[e].destroy(),this.rules[e]=null;this.rules=null,this.defaultStyle=null},createSymbolizer:function(e){for(var t,i=this.defaultsPerSymbolizer?{}:this.createLiterals(OpenLayers.Util.extend({},this.defaultStyle),e),a=this.rules,n=[],s=!1,r=0,o=a.length;o>r;r++){t=a[r];var l=t.evaluate(e);l&&(t instanceof OpenLayers.Rule&&t.elseFilter?n.push(t):(s=!0,this.applySymbolizer(t,i,e)))}if(0==s&&n.length>0){s=!0;for(var r=0,o=n.length;o>r;r++)this.applySymbolizer(n[r],i,e)}return a.length>0&&0==s&&(i.display="none"),null!=i.label&&"string"!=typeof i.label&&(i.label=String(i.label)),i},applySymbolizer:function(e,t,i){var a=i.geometry?this.getSymbolizerPrefix(i.geometry):OpenLayers.Style.SYMBOLIZER_PREFIXES[0],n=e.symbolizer[a]||e.symbolizer;if(this.defaultsPerSymbolizer===!0){var s=this.defaultStyle;OpenLayers.Util.applyDefaults(n,{pointRadius:s.pointRadius}),(n.stroke===!0||n.graphic===!0)&&OpenLayers.Util.applyDefaults(n,{strokeWidth:s.strokeWidth,strokeColor:s.strokeColor,strokeOpacity:s.strokeOpacity,strokeDashstyle:s.strokeDashstyle,strokeLinecap:s.strokeLinecap}),(n.fill===!0||n.graphic===!0)&&OpenLayers.Util.applyDefaults(n,{fillColor:s.fillColor,fillOpacity:s.fillOpacity}),n.graphic===!0&&OpenLayers.Util.applyDefaults(n,{pointRadius:this.defaultStyle.pointRadius,externalGraphic:this.defaultStyle.externalGraphic,graphicName:this.defaultStyle.graphicName,graphicOpacity:this.defaultStyle.graphicOpacity,graphicWidth:this.defaultStyle.graphicWidth,graphicHeight:this.defaultStyle.graphicHeight,graphicXOffset:this.defaultStyle.graphicXOffset,graphicYOffset:this.defaultStyle.graphicYOffset})}return this.createLiterals(OpenLayers.Util.extend(t,n),i)},createLiterals:function(e,t){var i=OpenLayers.Util.extend({},t.attributes||t.data);OpenLayers.Util.extend(i,this.context);for(var a in this.propertyStyles)e[a]=OpenLayers.Style.createLiteral(e[a],i,t,a);return e},findPropertyStyles:function(){var e={},t=this.defaultStyle;this.addPropertyStyles(e,t);for(var i,a,n=this.rules,s=0,r=n.length;r>s;s++){i=n[s].symbolizer;for(var o in i){if(a=i[o],"object"!=typeof a){this.addPropertyStyles(e,i);break}this.addPropertyStyles(e,a)}}return e},addPropertyStyles:function(e,t){var i;for(var a in t)i=t[a],"string"==typeof i&&i.match(/\$\{\w+\}/)&&(e[a]=!0);return e},addRules:function(e){Array.prototype.push.apply(this.rules,e),this.propertyStyles=this.findPropertyStyles()},setDefaultStyle:function(e){this.defaultStyle=e,this.propertyStyles=this.findPropertyStyles()},getSymbolizerPrefix:function(e){for(var t=OpenLayers.Style.SYMBOLIZER_PREFIXES,i=0,a=t.length;a>i;i++)if(-1!=e.CLASS_NAME.indexOf(t[i]))return t[i]},clone:function(){var e=OpenLayers.Util.extend({},this);if(this.rules){e.rules=[];for(var t=0,i=this.rules.length;i>t;++t)e.rules.push(this.rules[t].clone())}e.context=this.context&&OpenLayers.Util.extend({},this.context);var a=OpenLayers.Util.extend({},this.defaultStyle);return new OpenLayers.Style(a,e)},CLASS_NAME:"OpenLayers.Style"}),OpenLayers.Style.createLiteral=function(e,t,i,a){return"string"==typeof e&&-1!=e.indexOf("${")&&(e=OpenLayers.String.format(e,t,[i,a]),e=isNaN(e)||!e?e:parseFloat(e)),e},OpenLayers.Style.SYMBOLIZER_PREFIXES=["Point","Line","Polygon","Text","Raster"],OpenLayers.StyleMap=OpenLayers.Class({styles:null,extendDefault:!0,initialize:function(e,t){if(this.styles={"default":new OpenLayers.Style(OpenLayers.Feature.Vector.style["default"]),select:new OpenLayers.Style(OpenLayers.Feature.Vector.style.select),temporary:new OpenLayers.Style(OpenLayers.Feature.Vector.style.temporary),"delete":new OpenLayers.Style(OpenLayers.Feature.Vector.style["delete"])},e instanceof OpenLayers.Style)this.styles["default"]=e,this.styles.select=e,this.styles.temporary=e,this.styles["delete"]=e;else if("object"==typeof e)for(var i in e)if(e[i]instanceof OpenLayers.Style)this.styles[i]=e[i];else{if("object"!=typeof e[i]){this.styles["default"]=new OpenLayers.Style(e),this.styles.select=new OpenLayers.Style(e),this.styles.temporary=new OpenLayers.Style(e),this.styles["delete"]=new OpenLayers.Style(e);break}this.styles[i]=new OpenLayers.Style(e[i])}OpenLayers.Util.extend(this,t)},destroy:function(){for(var e in this.styles)this.styles[e].destroy();this.styles=null},createSymbolizer:function(e,t){e||(e=new OpenLayers.Feature.Vector),this.styles[t]||(t="default"),e.renderIntent=t;var i={};return this.extendDefault&&"default"!=t&&(i=this.styles["default"].createSymbolizer(e)),OpenLayers.Util.extend(i,this.styles[t].createSymbolizer(e))},addUniqueValueRules:function(e,t,i,a){var n=[];for(var s in i)n.push(new OpenLayers.Rule({symbolizer:i[s],context:a,filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:t,value:s})}));this.styles[e].addRules(n)},CLASS_NAME:"OpenLayers.StyleMap"}),OpenLayers.Rule=OpenLayers.Class({id:null,name:null,title:null,description:null,context:null,filter:null,elseFilter:!1,symbolizer:null,symbolizers:null,minScaleDenominator:null,maxScaleDenominator:null,initialize:function(e){this.symbolizer={},OpenLayers.Util.extend(this,e),this.symbolizers&&delete this.symbolizer,this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var e in this.symbolizer)this.symbolizer[e]=null;this.symbolizer=null,delete this.symbolizers},evaluate:function(e){var t=this.getContext(e),i=!0;if(this.minScaleDenominator||this.maxScaleDenominator)var a=e.layer.map.getScale();return this.minScaleDenominator&&(i=a>=OpenLayers.Style.createLiteral(this.minScaleDenominator,t)),i&&this.maxScaleDenominator&&(i=a<OpenLayers.Style.createLiteral(this.maxScaleDenominator,t)),i&&this.filter&&(i="OpenLayers.Filter.FeatureId"==this.filter.CLASS_NAME?this.filter.evaluate(e):this.filter.evaluate(t)),i},getContext:function(e){var t=this.context;return t||(t=e.attributes||e.data),"function"==typeof this.context&&(t=this.context(e)),t},clone:function(){var e=OpenLayers.Util.extend({},this);if(this.symbolizers){var t=this.symbolizers.length;e.symbolizers=new Array(t);for(var i=0;t>i;++i)e.symbolizers[i]=this.symbolizers[i].clone()}else{e.symbolizer={};var a,n;for(var s in this.symbolizer)a=this.symbolizer[s],n=typeof a,"object"===n?e.symbolizer[s]=OpenLayers.Util.extend({},a):"string"===n&&(e.symbolizer[s]=a)}return e.filter=this.filter&&this.filter.clone(),e.context=this.context&&OpenLayers.Util.extend({},this.context),new OpenLayers.Rule(e)},CLASS_NAME:"OpenLayers.Rule"}),OpenLayers.Format=OpenLayers.Class({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(e){OpenLayers.Util.extend(this,e),this.options=e},destroy:function(){},read:function(){throw new Error("Read not implemented.")},write:function(){throw new Error("Write not implemented.")},CLASS_NAME:"OpenLayers.Format"}),OpenLayers.Format.XML=OpenLayers.Class(OpenLayers.Format,{namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(e){window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM")),OpenLayers.Format.prototype.initialize.apply(this,[e]),this.namespaces=OpenLayers.Util.extend({},this.namespaces),this.namespaceAlias={};for(var t in this.namespaces)this.namespaceAlias[this.namespaces[t]]=t},destroy:function(){this.xmldom=null,OpenLayers.Format.prototype.destroy.apply(this,arguments)},setNamespace:function(e,t){this.namespaces[e]=t,this.namespaceAlias[t]=e},read:function(e){var t=e.indexOf("<");t>0&&(e=e.substring(t));var i=OpenLayers.Util.Try(OpenLayers.Function.bind(function(){var t;return t=window.ActiveXObject&&!this.xmldom?new ActiveXObject("Microsoft.XMLDOM"):this.xmldom,t.loadXML(e),t},this),function(){return(new DOMParser).parseFromString(e,"text/xml")},function(){var t=new XMLHttpRequest;return t.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(e),!1),t.overrideMimeType&&t.overrideMimeType("text/xml"),t.send(null),t.responseXML});return this.keepData&&(this.data=i),i},write:function(e){var t;if(this.xmldom)t=e.xml;else{var i=new XMLSerializer;if(1==e.nodeType){var a=document.implementation.createDocument("","",null);a.importNode&&(e=a.importNode(e,!0)),a.appendChild(e),t=i.serializeToString(a)}else t=i.serializeToString(e)}return t},createElementNS:function(e,t){var i;return i=this.xmldom?"string"==typeof e?this.xmldom.createNode(1,t,e):this.xmldom.createNode(1,t,""):document.createElementNS(e,t)},createTextNode:function(e){var t;return"string"!=typeof e&&(e=String(e)),t=this.xmldom?this.xmldom.createTextNode(e):document.createTextNode(e)},getElementsByTagNameNS:function(e,t,i){var a=[];if(e.getElementsByTagNameNS)a=e.getElementsByTagNameNS(t,i);else for(var n,s,r=e.getElementsByTagName("*"),o=0,l=r.length;l>o;++o)n=r[o],s=n.prefix?n.prefix+":"+i:i,("*"==i||s==n.nodeName)&&("*"==t||t==n.namespaceURI)&&a.push(n);return a},getAttributeNodeNS:function(e,t,i){var a=null;if(e.getAttributeNodeNS)a=e.getAttributeNodeNS(t,i);else for(var n,s,r=e.attributes,o=0,l=r.length;l>o;++o)if(n=r[o],n.namespaceURI==t&&(s=n.prefix?n.prefix+":"+i:i,s==n.nodeName)){a=n;break}return a},getAttributeNS:function(e,t,i){var a="";if(e.getAttributeNS)a=e.getAttributeNS(t,i)||"";else{var n=this.getAttributeNodeNS(e,t,i);n&&(a=n.nodeValue)}return a},getChildValue:function(e,t){var i=t||"";if(e)for(var a=e.firstChild;a;a=a.nextSibling)switch(a.nodeType){case 3:case 4:i+=a.nodeValue}return i},isSimpleContent:function(e){for(var t=!0,i=e.firstChild;i;i=i.nextSibling)if(1===i.nodeType){t=!1;break}return t},contentType:function(e){for(var t=!1,i=!1,a=OpenLayers.Format.XML.CONTENT_TYPE.EMPTY,n=e.firstChild;n;n=n.nextSibling){switch(n.nodeType){case 1:i=!0;break;case 8:break;default:t=!0}if(i&&t)break}if(i&&t)a=OpenLayers.Format.XML.CONTENT_TYPE.MIXED;else{if(i)return OpenLayers.Format.XML.CONTENT_TYPE.COMPLEX;if(t)return OpenLayers.Format.XML.CONTENT_TYPE.SIMPLE}return a},hasAttributeNS:function(e,t,i){var a=!1;return a=e.hasAttributeNS?e.hasAttributeNS(t,i):!!this.getAttributeNodeNS(e,t,i)},setAttributeNS:function(e,t,i,a){if(e.setAttributeNS)e.setAttributeNS(t,i,a);else{if(!this.xmldom)throw"setAttributeNS not implemented";if(t){var n=e.ownerDocument.createNode(2,i,t);n.nodeValue=a,e.setAttributeNode(n)}else e.setAttribute(i,a)}},createElementNSPlus:function(e,t){t=t||{};var i=t.uri||this.namespaces[t.prefix];if(!i){var a=e.indexOf(":");i=this.namespaces[e.substring(0,a)]}i||(i=this.namespaces[this.defaultPrefix]);var n=this.createElementNS(i,e);t.attributes&&this.setAttributes(n,t.attributes);var s=t.value;return null!=s&&n.appendChild(this.createTextNode(s)),n},setAttributes:function(e,t){var i,a;for(var n in t)null!=t[n]&&t[n].toString&&(i=t[n].toString(),a=this.namespaces[n.substring(0,n.indexOf(":"))]||null,this.setAttributeNS(e,a,n,i))},readNode:function(e,t){t||(t={});var i=this.readers[e.namespaceURI?this.namespaceAlias[e.namespaceURI]:this.defaultPrefix];if(i){var a=e.localName||e.nodeName.split(":").pop(),n=i[a]||i["*"];n&&n.apply(this,[e,t])}return t},readChildNodes:function(e,t){t||(t={});for(var i,a=e.childNodes,n=0,s=a.length;s>n;++n)i=a[n],1==i.nodeType&&this.readNode(i,t);return t},writeNode:function(e,t,i){var a,n,s=e.indexOf(":");s>0?(a=e.substring(0,s),n=e.substring(s+1)):(a=i?this.namespaceAlias[i.namespaceURI]:this.defaultPrefix,n=e);var r=this.writers[a][n].apply(this,[t]);return i&&i.appendChild(r),r},getChildEl:function(e,t,i){return e&&this.getThisOrNextEl(e.firstChild,t,i)},getNextEl:function(e,t,i){return e&&this.getThisOrNextEl(e.nextSibling,t,i)},getThisOrNextEl:function(e,t,i){e:for(var a=e;a;a=a.nextSibling)switch(a.nodeType){case 1:if(!(t&&t!==(a.localName||a.nodeName.split(":").pop())||i&&i!==a.namespaceURI))break e;a=null;break e;case 3:if(/^\s*$/.test(a.nodeValue))break;case 4:case 6:case 12:case 10:case 11:a=null;break e}return a||null},lookupNamespaceURI:function(e,t){var i=null;if(e)if(e.lookupNamespaceURI)i=e.lookupNamespaceURI(t);else e:switch(e.nodeType){case 1:if(null!==e.namespaceURI&&e.prefix===t){i=e.namespaceURI;break e}var a=e.attributes.length;if(a)for(var n,s=0;a>s;++s){if(n=e.attributes[s],"xmlns"===n.prefix&&n.name==="xmlns:"+t){i=n.value||null;break e}if("xmlns"===n.name&&null===t){i=n.value||null;break e}}i=this.lookupNamespaceURI(e.parentNode,t);break e;case 2:i=this.lookupNamespaceURI(e.ownerElement,t);break e;case 9:i=this.lookupNamespaceURI(e.documentElement,t);break e;case 6:case 12:case 10:case 11:break e;default:i=this.lookupNamespaceURI(e.parentNode,t)}return i},getXMLDoc:function(){return OpenLayers.Format.XML.document||this.xmldom||(document.implementation&&document.implementation.createDocument?OpenLayers.Format.XML.document=document.implementation.createDocument("","",null):!this.xmldom&&window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM"))),OpenLayers.Format.XML.document||this.xmldom},CLASS_NAME:"OpenLayers.Format.XML"}),OpenLayers.Format.XML.CONTENT_TYPE={EMPTY:0,SIMPLE:1,COMPLEX:2,MIXED:3},OpenLayers.Format.XML.lookupNamespaceURI=OpenLayers.Function.bind(OpenLayers.Format.XML.prototype.lookupNamespaceURI,OpenLayers.Format.XML.prototype),OpenLayers.Format.XML.document=null,OpenLayers.Format.XML.VersionedOGC=OpenLayers.Class(OpenLayers.Format.XML,{defaultVersion:null,version:null,profile:null,errorProperty:null,name:null,stringifyOutput:!1,parser:null,initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]);var t=this.CLASS_NAME;this.name=t.substring(t.lastIndexOf(".")+1)},getVersion:function(e,t){var i;return e?(i=this.version,i||(i=e.getAttribute("version"),i||(i=this.defaultVersion))):i=t&&t.version||this.version||this.defaultVersion,i},getParser:function(e){e=e||this.defaultVersion;var t=this.profile?"_"+this.profile:"";if(!this.parser||this.parser.VERSION!=e){var i=OpenLayers.Format[this.name]["v"+e.replace(/\./g,"_")+t];if(!i)throw"Can't find a "+this.name+" parser for version "+e+t;this.parser=new i(this.options)}return this.parser},write:function(e,t){var i=this.getVersion(null,t);this.parser=this.getParser(i);var a=this.parser.write(e,t);return this.stringifyOutput===!1?a:OpenLayers.Format.XML.prototype.write.apply(this,[a])},read:function(e,t){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var i=e.documentElement,a=this.getVersion(i);this.parser=this.getParser(a);var n=this.parser.read(e,t);if(null!==this.errorProperty&&void 0===n[this.errorProperty]){var s=new OpenLayers.Format.OGCExceptionReport;n.error=s.read(e)}return n.version=a,n},CLASS_NAME:"OpenLayers.Format.XML.VersionedOGC"}),OpenLayers.Format.GML=OpenLayers.Class(OpenLayers.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var t=this.getElementsByTagNameNS(e.documentElement,this.gmlns,this.featureName),i=[],a=0;a<t.length;a++){var n=this.parseFeature(t[a]);n&&i.push(n)}return i},parseFeature:function(e){for(var t,i,a,n,s=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],r=0;r<s.length;++r)if(t=s[r],i=this.getElementsByTagNameNS(e,this.gmlns,t),i.length>0){if(n=this.parseGeometry[t.toLowerCase()],!n)throw new TypeError("Unsupported geometry type: "+t);a=n.apply(this,[i[0]]),this.internalProjection&&this.externalProjection&&a.transform(this.externalProjection,this.internalProjection);break}var o,l=this.getElementsByTagNameNS(e,this.gmlns,"Box");for(r=0;r<l.length;++r){var u=l[r],c=this.parseGeometry.box.apply(this,[u]),h=u.parentNode,d=h.localName||h.nodeName.split(":").pop();"boundedBy"===d?o=c:a=c.toGeometry()}var p;this.extractAttributes&&(p=this.parseAttributes(e));var f=new OpenLayers.Feature.Vector(a,p);f.bounds=o,f.gml={featureType:e.firstChild.nodeName.split(":")[1],featureNS:e.firstChild.namespaceURI,featureNSPrefix:e.firstChild.prefix};for(var m,g=e.firstChild;g&&(1!=g.nodeType||!(m=g.getAttribute("fid")||g.getAttribute("id")));)g=g.nextSibling;return f.fid=m,f},parseGeometry:{point:function(e){var t,i,a=[],t=this.getElementsByTagNameNS(e,this.gmlns,"pos");if(t.length>0&&(i=t[0].firstChild.nodeValue,i=i.replace(this.regExes.trimSpace,""),a=i.split(this.regExes.splitSpace)),0==a.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),t.length>0&&(i=t[0].firstChild.nodeValue,i=i.replace(this.regExes.removeSpace,""),a=i.split(","))),0==a.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coord"),t.length>0)){var n=this.getElementsByTagNameNS(t[0],this.gmlns,"X"),s=this.getElementsByTagNameNS(t[0],this.gmlns,"Y");n.length>0&&s.length>0&&(a=[n[0].firstChild.nodeValue,s[0].firstChild.nodeValue])}return 2==a.length&&(a[2]=null),this.xy?new OpenLayers.Geometry.Point(a[0],a[1],a[2]):new OpenLayers.Geometry.Point(a[1],a[0],a[2])},multipoint:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Point"),i=[];if(t.length>0)for(var a,n=0;n<t.length;++n)a=this.parseGeometry.point.apply(this,[t[n]]),a&&i.push(a);return new OpenLayers.Geometry.MultiPoint(i)},linestring:function(e,t){var i,a,n=[],s=[];if(i=this.getElementsByTagNameNS(e,this.gmlns,"posList"),i.length>0){a=this.getChildValue(i[0]),a=a.replace(this.regExes.trimSpace,""),n=a.split(this.regExes.splitSpace);for(var r,o,l,u,c=parseInt(i[0].getAttribute("dimension")),h=0;h<n.length/c;++h)r=h*c,o=n[r],l=n[r+1],u=2==c?null:n[r+2],this.xy?s.push(new OpenLayers.Geometry.Point(o,l,u)):s.push(new OpenLayers.Geometry.Point(l,o,u))}if(0==n.length&&(i=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),i.length>0)){a=this.getChildValue(i[0]),a=a.replace(this.regExes.trimSpace,""),a=a.replace(this.regExes.trimComma,",");
for(var d=a.split(this.regExes.splitSpace),h=0;h<d.length;++h)n=d[h].split(","),2==n.length&&(n[2]=null),this.xy?s.push(new OpenLayers.Geometry.Point(n[0],n[1],n[2])):s.push(new OpenLayers.Geometry.Point(n[1],n[0],n[2]))}var p=null;return 0!=s.length&&(p=t?new OpenLayers.Geometry.LinearRing(s):new OpenLayers.Geometry.LineString(s)),p},multilinestring:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LineString"),i=[];if(t.length>0)for(var a,n=0;n<t.length;++n)a=this.parseGeometry.linestring.apply(this,[t[n]]),a&&i.push(a);return new OpenLayers.Geometry.MultiLineString(i)},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LinearRing"),i=[];if(t.length>0)for(var a,n=0;n<t.length;++n)a=this.parseGeometry.linestring.apply(this,[t[n],!0]),a&&i.push(a);return new OpenLayers.Geometry.Polygon(i)},multipolygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Polygon"),i=[];if(t.length>0)for(var a,n=0;n<t.length;++n)a=this.parseGeometry.polygon.apply(this,[t[n]]),a&&i.push(a);return new OpenLayers.Geometry.MultiPolygon(i)},envelope:function(e){var t,i,a=[],n=this.getElementsByTagNameNS(e,this.gmlns,"lowerCorner");if(n.length>0){var s=[];if(n.length>0&&(t=n[0].firstChild.nodeValue,t=t.replace(this.regExes.trimSpace,""),s=t.split(this.regExes.splitSpace)),2==s.length&&(s[2]=null),this.xy)var r=new OpenLayers.Geometry.Point(s[0],s[1],s[2]);else var r=new OpenLayers.Geometry.Point(s[1],s[0],s[2])}var o=this.getElementsByTagNameNS(e,this.gmlns,"upperCorner");if(o.length>0){var s=[];if(o.length>0&&(t=o[0].firstChild.nodeValue,t=t.replace(this.regExes.trimSpace,""),s=t.split(this.regExes.splitSpace)),2==s.length&&(s[2]=null),this.xy)var l=new OpenLayers.Geometry.Point(s[0],s[1],s[2]);else var l=new OpenLayers.Geometry.Point(s[1],s[0],s[2])}if(r&&l){a.push(new OpenLayers.Geometry.Point(r.x,r.y)),a.push(new OpenLayers.Geometry.Point(l.x,r.y)),a.push(new OpenLayers.Geometry.Point(l.x,l.y)),a.push(new OpenLayers.Geometry.Point(r.x,l.y)),a.push(new OpenLayers.Geometry.Point(r.x,r.y));var u=new OpenLayers.Geometry.LinearRing(a);i=new OpenLayers.Geometry.Polygon([u])}return i},box:function(e){var t,i,a=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),n=null,s=null;return a.length>0&&(t=a[0].firstChild.nodeValue,i=t.split(" "),2==i.length&&(n=i[0].split(","),s=i[1].split(","))),null!==n&&null!==s?new OpenLayers.Bounds(parseFloat(n[0]),parseFloat(n[1]),parseFloat(s[0]),parseFloat(s[1])):void 0}},parseAttributes:function(e){for(var t,i,a,n,s,r,o,l={},u=e.firstChild;u;){if(1==u.nodeType){for(t=u.childNodes,i=0;i<t.length;++i)a=t[i],1==a.nodeType&&(n=a.childNodes,1==n.length?(s=n[0],(3==s.nodeType||4==s.nodeType)&&(r=a.prefix?a.nodeName.split(":")[1]:a.nodeName,o=s.nodeValue.replace(this.regExes.trimSpace,""),l[r]=o)):l[a.nodeName.split(":").pop()]=null);break}u=u.nextSibling}return l},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),i=0;i<e.length;i++)t.appendChild(this.createFeatureXML(e[i]));return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureXML:function(e){var t=e.geometry,i=this.buildGeometryNode(t),a=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);a.appendChild(i);var n=this.createElementNS(this.gmlns,"gml:"+this.featureName),s=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName),r=e.fid||e.id;s.setAttribute("fid",r),s.appendChild(a);for(var o in e.attributes){var l=this.createTextNode(e.attributes[o]),u=o.substring(o.lastIndexOf(":")+1),c=this.createElementNS(this.featureNS,this.featurePrefix+":"+u);c.appendChild(l),s.appendChild(c)}return n.appendChild(s),n},buildGeometryNode:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var t=e.CLASS_NAME,i=t.substring(t.lastIndexOf(".")+1),a=this.buildGeometry[i.toLowerCase()];return a.apply(this,[e])},buildGeometry:{point:function(e){var t=this.createElementNS(this.gmlns,"gml:Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){for(var t,i,a=this.createElementNS(this.gmlns,"gml:MultiPoint"),n=e.components,s=0;s<n.length;s++)t=this.createElementNS(this.gmlns,"gml:pointMember"),i=this.buildGeometry.point.apply(this,[n[s]]),t.appendChild(i),a.appendChild(t);return a},linestring:function(e){var t=this.createElementNS(this.gmlns,"gml:LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){for(var t,i,a=this.createElementNS(this.gmlns,"gml:MultiLineString"),n=e.components,s=0;s<n.length;++s)t=this.createElementNS(this.gmlns,"gml:lineStringMember"),i=this.buildGeometry.linestring.apply(this,[n[s]]),t.appendChild(i),a.appendChild(t);return a},linearring:function(e){var t=this.createElementNS(this.gmlns,"gml:LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){for(var t,i,a,n=this.createElementNS(this.gmlns,"gml:Polygon"),s=e.components,r=0;r<s.length;++r)a=0==r?"outerBoundaryIs":"innerBoundaryIs",t=this.createElementNS(this.gmlns,"gml:"+a),i=this.buildGeometry.linearring.apply(this,[s[r]]),t.appendChild(i),n.appendChild(t);return n},multipolygon:function(e){for(var t,i,a=this.createElementNS(this.gmlns,"gml:MultiPolygon"),n=e.components,s=0;s<n.length;++s)t=this.createElementNS(this.gmlns,"gml:polygonMember"),i=this.buildGeometry.polygon.apply(this,[n[s]]),t.appendChild(i),a.appendChild(t);return a},bounds:function(e){var t=this.createElementNS(this.gmlns,"gml:Box");return t.appendChild(this.buildCoordinatesNode(e)),t}},buildCoordinatesNode:function(e){var t=this.createElementNS(this.gmlns,"gml:coordinates");t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," ");var i=[];if(e instanceof OpenLayers.Bounds)i.push(e.left+","+e.bottom),i.push(e.right+","+e.top);else for(var a=e.components?e.components:[e],n=0;n<a.length;n++)i.push(a[n].x+","+a[n].y);var s=this.createTextNode(i.join(" "));return t.appendChild(s),t},CLASS_NAME:"OpenLayers.Format.GML"}),OpenLayers.Format.GML||(OpenLayers.Format.GML={}),OpenLayers.Format.GML.Base=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},defaultPrefix:"gml",schemaLocation:null,featureType:null,featureNS:null,geometryName:"geometry",extractAttributes:!0,srsName:null,xy:!0,geometryTypes:null,singleFeatureType:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,featureMember:/^(.*:)?featureMembers?$/},initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]),this.setGeometryTypes(),e&&e.featureNS&&this.setNamespace("feature",e.featureNS),this.singleFeatureType=!e||"string"==typeof e.featureType},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t=[];if(this.readNode(e,{features:t},!0),0==t.length){var i=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMember");if(i.length)for(var a=0,n=i.length;n>a;++a)this.readNode(i[a],{features:t},!0);else{var i=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMembers");i.length&&this.readNode(i[0],{features:t},!0)}}return t},readNode:function(e,t,i){return i===!0&&this.autoConfig===!0&&(this.featureType=null,delete this.namespaceAlias[this.featureNS],delete this.namespaces.feature,this.featureNS=null),this.featureNS||e.prefix in this.namespaces||e.parentNode.namespaceURI!=this.namespaces.gml||!this.regExes.featureMember.test(e.parentNode.nodeName)||(this.featureType=e.nodeName.split(":").pop(),this.setNamespace("feature",e.namespaceURI),this.featureNS=e.namespaceURI,this.autoConfig=!0),OpenLayers.Format.XML.prototype.readNode.apply(this,[e,t])},readers:{gml:{featureMember:function(e,t){this.readChildNodes(e,t)},featureMembers:function(e,t){this.readChildNodes(e,t)},name:function(e,t){t.name=this.getChildValue(e)},boundedBy:function(e,t){var i={};this.readChildNodes(e,i),i.components&&i.components.length>0&&(t.bounds=i.components[0])},Point:function(e,t){var i={points:[]};this.readChildNodes(e,i),t.components||(t.components=[]),t.components.push(i.points[0])},coordinates:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,"");i=i.replace(this.regExes.trimComma,",");for(var a,n=i.split(this.regExes.splitSpace),s=n.length,r=new Array(s),o=0;s>o;++o)a=n[o].split(","),r[o]=this.xy?new OpenLayers.Geometry.Point(a[0],a[1],a[2]):new OpenLayers.Geometry.Point(a[1],a[0],a[2]);t.points=r},coord:function(e,t){var i={};this.readChildNodes(e,i),t.points||(t.points=[]),t.points.push(new OpenLayers.Geometry.Point(i.x,i.y,i.z))},X:function(e,t){t.x=this.getChildValue(e)},Y:function(e,t){t.y=this.getChildValue(e)},Z:function(e,t){t.z=this.getChildValue(e)},MultiPoint:function(e,t){var i={components:[]};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.MultiPoint(i.components)]},pointMember:function(e,t){this.readChildNodes(e,t)},LineString:function(e,t){var i={};this.readChildNodes(e,i),t.components||(t.components=[]),t.components.push(new OpenLayers.Geometry.LineString(i.points))},MultiLineString:function(e,t){var i={components:[]};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.MultiLineString(i.components)]},lineStringMember:function(e,t){this.readChildNodes(e,t)},Polygon:function(e,t){var i={outer:null,inner:[]};this.readChildNodes(e,i),i.inner.unshift(i.outer),t.components||(t.components=[]),t.components.push(new OpenLayers.Geometry.Polygon(i.inner))},LinearRing:function(e,t){var i={};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.LinearRing(i.points)]},MultiPolygon:function(e,t){var i={components:[]};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.MultiPolygon(i.components)]},polygonMember:function(e,t){this.readChildNodes(e,t)},GeometryCollection:function(e,t){var i={components:[]};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.Collection(i.components)]},geometryMember:function(e,t){this.readChildNodes(e,t)}},feature:{"*":function(e,t){var i,a=e.localName||e.nodeName.split(":").pop();t.features?this.singleFeatureType||-1===OpenLayers.Util.indexOf(this.featureType,a)?a===this.featureType&&(i="_typeName"):i="_typeName":0==e.childNodes.length||1==e.childNodes.length&&3==e.firstChild.nodeType?this.extractAttributes&&(i="_attribute"):i="_geometry",i&&this.readers.feature[i].apply(this,[e,t])},_typeName:function(e,t){var i={components:[],attributes:{}};this.readChildNodes(e,i),i.name&&(i.attributes.name=i.name);var a=new OpenLayers.Feature.Vector(i.components[0],i.attributes);this.singleFeatureType||(a.type=e.nodeName.split(":").pop(),a.namespace=e.namespaceURI);var n=e.getAttribute("fid")||this.getAttributeNS(e,this.namespaces.gml,"id");n&&(a.fid=n),this.internalProjection&&this.externalProjection&&a.geometry&&a.geometry.transform(this.externalProjection,this.internalProjection),i.bounds&&(a.bounds=i.bounds),t.features.push(a)},_geometry:function(e,t){this.geometryName||(this.geometryName=e.nodeName.split(":").pop()),this.readChildNodes(e,t)},_attribute:function(e,t){var i=e.localName||e.nodeName.split(":").pop(),a=this.getChildValue(e);t.attributes[i]=a}},wfs:{FeatureCollection:function(e,t){this.readChildNodes(e,t)}}},write:function(e){var t;t=OpenLayers.Util.isArray(e)?"featureMembers":"featureMember";var i=this.writeNode("gml:"+t,e);return this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{gml:{featureMember:function(e){var t=this.createElementNSPlus("gml:featureMember");return this.writeNode("feature:_typeName",e,t),t},MultiPoint:function(e){for(var t=this.createElementNSPlus("gml:MultiPoint"),i=e.components||[e],a=0,n=i.length;n>a;++a)this.writeNode("pointMember",i[a],t);return t},pointMember:function(e){var t=this.createElementNSPlus("gml:pointMember");return this.writeNode("Point",e,t),t},MultiLineString:function(e){for(var t=this.createElementNSPlus("gml:MultiLineString"),i=e.components||[e],a=0,n=i.length;n>a;++a)this.writeNode("lineStringMember",i[a],t);return t},lineStringMember:function(e){var t=this.createElementNSPlus("gml:lineStringMember");return this.writeNode("LineString",e,t),t},MultiPolygon:function(e){for(var t=this.createElementNSPlus("gml:MultiPolygon"),i=e.components||[e],a=0,n=i.length;n>a;++a)this.writeNode("polygonMember",i[a],t);return t},polygonMember:function(e){var t=this.createElementNSPlus("gml:polygonMember");return this.writeNode("Polygon",e,t),t},GeometryCollection:function(e){for(var t=this.createElementNSPlus("gml:GeometryCollection"),i=0,a=e.components.length;a>i;++i)this.writeNode("geometryMember",e.components[i],t);return t},geometryMember:function(e){var t=this.createElementNSPlus("gml:geometryMember"),i=this.writeNode("feature:_geometry",e);return t.appendChild(i.firstChild),t}},feature:{_typeName:function(e){var t=this.createElementNSPlus("feature:"+this.featureType,{attributes:{fid:e.fid}});e.geometry&&this.writeNode("feature:_geometry",e.geometry,t);for(var i in e.attributes){var a=e.attributes[i];null!=a&&this.writeNode("feature:_attribute",{name:i,value:a},t)}return t},_geometry:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone().transform(this.internalProjection,this.externalProjection));var t=this.createElementNSPlus("feature:"+this.geometryName),i=this.geometryTypes[e.CLASS_NAME],a=this.writeNode("gml:"+i,e,t);return this.srsName&&a.setAttribute("srsName",this.srsName),t},_attribute:function(e){return this.createElementNSPlus("feature:"+e.name,{value:e.value})}},wfs:{FeatureCollection:function(e){for(var t=this.createElementNSPlus("wfs:FeatureCollection"),i=0,a=e.length;a>i;++i)this.writeNode("gml:featureMember",e[i],t);return t}}},setGeometryTypes:function(){this.geometryTypes={"OpenLayers.Geometry.Point":"Point","OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":"LineString","OpenLayers.Geometry.MultiLineString":"MultiLineString","OpenLayers.Geometry.Polygon":"Polygon","OpenLayers.Geometry.MultiPolygon":"MultiPolygon","OpenLayers.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"OpenLayers.Format.GML.Base"}),OpenLayers.Format.GML.v3=OpenLayers.Class(OpenLayers.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",curve:!1,multiCurve:!0,surface:!1,multiSurface:!0,initialize:function(e){OpenLayers.Format.GML.Base.prototype.initialize.apply(this,[e])},readers:{gml:OpenLayers.Util.applyDefaults({featureMembers:function(e,t){this.readChildNodes(e,t)},Curve:function(e,t){var i={points:[]};this.readChildNodes(e,i),t.components||(t.components=[]),t.components.push(new OpenLayers.Geometry.LineString(i.points))},segments:function(e,t){this.readChildNodes(e,t)},LineStringSegment:function(e,t){var i={};this.readChildNodes(e,i),i.points&&Array.prototype.push.apply(t.points,i.points)},pos:function(e,t){var i,a=this.getChildValue(e).replace(this.regExes.trimSpace,""),n=a.split(this.regExes.splitSpace);i=this.xy?new OpenLayers.Geometry.Point(n[0],n[1],n[2]):new OpenLayers.Geometry.Point(n[1],n[0],n[2]),t.points=[i]},posList:function(e,t){for(var i,a,n,s=this.getChildValue(e).replace(this.regExes.trimSpace,""),r=s.split(this.regExes.splitSpace),o=parseInt(e.getAttribute("dimension"))||2,l=r.length/o,u=new Array(l),c=0,h=r.length;h>c;c+=o)i=r[c],a=r[c+1],n=2==o?void 0:r[c+2],u[c/o]=this.xy?new OpenLayers.Geometry.Point(i,a,n):new OpenLayers.Geometry.Point(a,i,n);t.points=u},Surface:function(e,t){this.readChildNodes(e,t)},patches:function(e,t){this.readChildNodes(e,t)},PolygonPatch:function(e,t){this.readers.gml.Polygon.apply(this,[e,t])},exterior:function(e,t){var i={};this.readChildNodes(e,i),t.outer=i.components[0]},interior:function(e,t){var i={};this.readChildNodes(e,i),t.inner.push(i.components[0])},MultiCurve:function(e,t){var i={components:[]};this.readChildNodes(e,i),i.components.length>0&&(t.components=[new OpenLayers.Geometry.MultiLineString(i.components)])},curveMember:function(e,t){this.readChildNodes(e,t)},MultiSurface:function(e,t){var i={components:[]};this.readChildNodes(e,i),i.components.length>0&&(t.components=[new OpenLayers.Geometry.MultiPolygon(i.components)])},surfaceMember:function(e,t){this.readChildNodes(e,t)},surfaceMembers:function(e,t){this.readChildNodes(e,t)},pointMembers:function(e,t){this.readChildNodes(e,t)},lineStringMembers:function(e,t){this.readChildNodes(e,t)},polygonMembers:function(e,t){this.readChildNodes(e,t)},geometryMembers:function(e,t){this.readChildNodes(e,t)},Envelope:function(e,t){var i={points:new Array(2)};this.readChildNodes(e,i),t.components||(t.components=[]);var a=i.points[0],n=i.points[1];t.components.push(new OpenLayers.Bounds(a.x,a.y,n.x,n.y))},lowerCorner:function(e,t){var i={};this.readers.gml.pos.apply(this,[e,i]),t.points[0]=i.points[0]},upperCorner:function(e,t){var i={};this.readers.gml.pos.apply(this,[e,i]),t.points[1]=i.points[0]}},OpenLayers.Format.GML.Base.prototype.readers.gml),feature:OpenLayers.Format.GML.Base.prototype.readers.feature,wfs:OpenLayers.Format.GML.Base.prototype.readers.wfs},write:function(e){var t;t=OpenLayers.Util.isArray(e)?"featureMembers":"featureMember";var i=this.writeNode("gml:"+t,e);return this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{gml:OpenLayers.Util.applyDefaults({featureMembers:function(e){for(var t=this.createElementNSPlus("gml:featureMembers"),i=0,a=e.length;a>i;++i)this.writeNode("feature:_typeName",e[i],t);return t},Point:function(e){var t=this.createElementNSPlus("gml:Point");return this.writeNode("pos",e,t),t},pos:function(e){var t=this.xy?e.x+" "+e.y:e.y+" "+e.x;return this.createElementNSPlus("gml:pos",{value:t})},LineString:function(e){var t=this.createElementNSPlus("gml:LineString");return this.writeNode("posList",e.components,t),t},Curve:function(e){var t=this.createElementNSPlus("gml:Curve");return this.writeNode("segments",e,t),t},segments:function(e){var t=this.createElementNSPlus("gml:segments");return this.writeNode("LineStringSegment",e,t),t},LineStringSegment:function(e){var t=this.createElementNSPlus("gml:LineStringSegment");return this.writeNode("posList",e.components,t),t},posList:function(e){for(var t,i=e.length,a=new Array(i),n=0;i>n;++n)t=e[n],a[n]=this.xy?t.x+" "+t.y:t.y+" "+t.x;return this.createElementNSPlus("gml:posList",{value:a.join(" ")})},Surface:function(e){var t=this.createElementNSPlus("gml:Surface");return this.writeNode("patches",e,t),t},patches:function(e){var t=this.createElementNSPlus("gml:patches");return this.writeNode("PolygonPatch",e,t),t},PolygonPatch:function(e){var t=this.createElementNSPlus("gml:PolygonPatch",{attributes:{interpolation:"planar"}});this.writeNode("exterior",e.components[0],t);for(var i=1,a=e.components.length;a>i;++i)this.writeNode("interior",e.components[i],t);return t},Polygon:function(e){var t=this.createElementNSPlus("gml:Polygon");this.writeNode("exterior",e.components[0],t);for(var i=1,a=e.components.length;a>i;++i)this.writeNode("interior",e.components[i],t);return t},exterior:function(e){var t=this.createElementNSPlus("gml:exterior");return this.writeNode("LinearRing",e,t),t},interior:function(e){var t=this.createElementNSPlus("gml:interior");return this.writeNode("LinearRing",e,t),t},LinearRing:function(e){var t=this.createElementNSPlus("gml:LinearRing");return this.writeNode("posList",e.components,t),t},MultiCurve:function(e){for(var t=this.createElementNSPlus("gml:MultiCurve"),i=e.components||[e],a=0,n=i.length;n>a;++a)this.writeNode("curveMember",i[a],t);return t},curveMember:function(e){var t=this.createElementNSPlus("gml:curveMember");return this.curve?this.writeNode("Curve",e,t):this.writeNode("LineString",e,t),t},MultiSurface:function(e){for(var t=this.createElementNSPlus("gml:MultiSurface"),i=e.components||[e],a=0,n=i.length;n>a;++a)this.writeNode("surfaceMember",i[a],t);return t},surfaceMember:function(e){var t=this.createElementNSPlus("gml:surfaceMember");return this.surface?this.writeNode("Surface",e,t):this.writeNode("Polygon",e,t),t},Envelope:function(e){var t=this.createElementNSPlus("gml:Envelope");return this.writeNode("lowerCorner",e,t),this.writeNode("upperCorner",e,t),this.srsName&&t.setAttribute("srsName",this.srsName),t},lowerCorner:function(e){var t=this.xy?e.left+" "+e.bottom:e.bottom+" "+e.left;return this.createElementNSPlus("gml:lowerCorner",{value:t})},upperCorner:function(e){var t=this.xy?e.right+" "+e.top:e.top+" "+e.right;return this.createElementNSPlus("gml:upperCorner",{value:t})}},OpenLayers.Format.GML.Base.prototype.writers.gml),feature:OpenLayers.Format.GML.Base.prototype.writers.feature,wfs:OpenLayers.Format.GML.Base.prototype.writers.wfs},setGeometryTypes:function(){this.geometryTypes={"OpenLayers.Geometry.Point":"Point","OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":this.curve===!0?"Curve":"LineString","OpenLayers.Geometry.MultiLineString":this.multiCurve===!1?"MultiLineString":"MultiCurve","OpenLayers.Geometry.Polygon":this.surface===!0?"Surface":"Polygon","OpenLayers.Geometry.MultiPolygon":this.multiSurface===!1?"MultiPolygon":"MultiSurface","OpenLayers.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"OpenLayers.Format.GML.v3"}),OpenLayers.Format.SLD=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{profile:null,defaultVersion:"1.0.0",stringifyOutput:!0,namedLayersAsArray:!1,CLASS_NAME:"OpenLayers.Format.SLD"}),OpenLayers.Format.JSON=OpenLayers.Class(OpenLayers.Format,{indent:"    ",space:" ",newline:"\n",level:0,pretty:!1,nativeJSON:function(){return!(!window.JSON||"function"!=typeof JSON.parse||"function"!=typeof JSON.stringify)}(),read:function(json,filter){function walk(e,t){if(t&&"object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&(t[i]=walk(i,t[i]));return filter(e,t)}var object;if(this.nativeJSON)object=JSON.parse(json,filter);else try{/^[\],:{}\s]*$/.test(json.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))&&(object=eval("("+json+")"),"function"==typeof filter&&(object=walk("",object)))}catch(e){}return this.keepData&&(this.data=object),object},write:function(e,t){this.pretty=!!t;var i=null,a=typeof e;if(this.serialize[a])try{i=!this.pretty&&this.nativeJSON?JSON.stringify(e):this.serialize[a].apply(this,[e])}catch(n){OpenLayers.Console.error("Trouble serializing: "+n)}return i},writeIndent:function(){var e=[];if(this.pretty)for(var t=0;t<this.level;++t)e.push(this.indent);return e.join("")},writeNewline:function(){return this.pretty?this.newline:""},writeSpace:function(){return this.pretty?this.space:""},serialize:{object:function(e){if(null==e)return"null";if(e.constructor==Date)return this.serialize.date.apply(this,[e]);if(e.constructor==Array)return this.serialize.array.apply(this,[e]);var t=["{"];this.level+=1;var i,a,n,s=!1;for(i in e)e.hasOwnProperty(i)&&(a=OpenLayers.Format.JSON.prototype.write.apply(this,[i,this.pretty]),n=OpenLayers.Format.JSON.prototype.write.apply(this,[e[i],this.pretty]),null!=a&&null!=n&&(s&&t.push(","),t.push(this.writeNewline(),this.writeIndent(),a,":",this.writeSpace(),n),s=!0));return this.level-=1,t.push(this.writeNewline(),this.writeIndent(),"}"),t.join("")},array:function(e){var t,i=["["];this.level+=1;for(var a=0,n=e.length;n>a;++a)t=OpenLayers.Format.JSON.prototype.write.apply(this,[e[a],this.pretty]),null!=t&&(a>0&&i.push(","),i.push(this.writeNewline(),this.writeIndent(),t));return this.level-=1,i.push(this.writeNewline(),this.writeIndent(),"]"),i.join("")},string:function(e){var t={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return/["\\\x00-\x1f]/.test(e)?'"'+e.replace(/([\x00-\x1f\\"])/g,function(e,i){var a=t[i];return a?a:(a=i.charCodeAt(),"\\u00"+Math.floor(a/16).toString(16)+(a%16).toString(16))})+'"':'"'+e+'"'},number:function(e){return isFinite(e)?String(e):"null"},"boolean":function(e){return String(e)},date:function(e){function t(e){return 10>e?"0"+e:e}return'"'+e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+"T"+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+'"'}},CLASS_NAME:"OpenLayers.Format.JSON"}),OpenLayers.Format.GeoJSON=OpenLayers.Class(OpenLayers.Format.JSON,{ignoreExtraDims:!1,read:function(e,t,i){t=t?t:"FeatureCollection";var a=null,n=null;if(n="string"==typeof e?OpenLayers.Format.JSON.prototype.read.apply(this,[e,i]):e){if("string"!=typeof n.type)OpenLayers.Console.error("Bad GeoJSON - no type: "+e);else if(this.isValidType(n,t))switch(t){case"Geometry":try{a=this.parseGeometry(n)}catch(s){OpenLayers.Console.error(s)}break;case"Feature":try{a=this.parseFeature(n),a.type="Feature"}catch(s){OpenLayers.Console.error(s)}break;case"FeatureCollection":switch(a=[],n.type){case"Feature":try{a.push(this.parseFeature(n))}catch(s){a=null,OpenLayers.Console.error(s)}break;case"FeatureCollection":for(var r=0,o=n.features.length;o>r;++r)try{a.push(this.parseFeature(n.features[r]))}catch(s){a=null,OpenLayers.Console.error(s)}break;default:try{var l=this.parseGeometry(n);a.push(new OpenLayers.Feature.Vector(l))}catch(s){a=null,OpenLayers.Console.error(s)}}}}else OpenLayers.Console.error("Bad JSON: "+e);return a},isValidType:function(e,t){var i=!1;switch(t){case"Geometry":-1==OpenLayers.Util.indexOf(["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","Box","GeometryCollection"],e.type)?OpenLayers.Console.error("Unsupported geometry type: "+e.type):i=!0;break;case"FeatureCollection":i=!0;break;default:e.type==t?i=!0:OpenLayers.Console.error("Cannot convert types from "+e.type+" to "+t)}return i},parseFeature:function(e){var t,i,a,n;a=e.properties?e.properties:{},n=e.geometry&&e.geometry.bbox||e.bbox;try{i=this.parseGeometry(e.geometry)}catch(s){throw s}return t=new OpenLayers.Feature.Vector(i,a),n&&(t.bounds=OpenLayers.Bounds.fromArray(n)),e.id&&(t.fid=e.id),t},parseGeometry:function(e){if(null==e)return null;var t,i=!1;if("GeometryCollection"==e.type){if(!OpenLayers.Util.isArray(e.geometries))throw"GeometryCollection must have geometries array: "+e;for(var a=e.geometries.length,n=new Array(a),s=0;a>s;++s)n[s]=this.parseGeometry.apply(this,[e.geometries[s]]);t=new OpenLayers.Geometry.Collection(n),i=!0}else{if(!OpenLayers.Util.isArray(e.coordinates))throw"Geometry must have coordinates array: "+e;if(!this.parseCoords[e.type.toLowerCase()])throw"Unsupported geometry type: "+e.type;try{t=this.parseCoords[e.type.toLowerCase()].apply(this,[e.coordinates])}catch(r){throw r}}return this.internalProjection&&this.externalProjection&&!i&&t.transform(this.externalProjection,this.internalProjection),t},parseCoords:{point:function(e){if(0==this.ignoreExtraDims&&2!=e.length)throw"Only 2D points are supported: "+e;return new OpenLayers.Geometry.Point(e[0],e[1])},multipoint:function(e){for(var t=[],i=null,a=0,n=e.length;n>a;++a){try{i=this.parseCoords.point.apply(this,[e[a]])}catch(s){throw s}t.push(i)}return new OpenLayers.Geometry.MultiPoint(t)},linestring:function(e){for(var t=[],i=null,a=0,n=e.length;n>a;++a){try{i=this.parseCoords.point.apply(this,[e[a]])}catch(s){throw s}t.push(i)}return new OpenLayers.Geometry.LineString(t)},multilinestring:function(e){for(var t=[],i=null,a=0,n=e.length;n>a;++a){try{i=this.parseCoords.linestring.apply(this,[e[a]])}catch(s){throw s}t.push(i)}return new OpenLayers.Geometry.MultiLineString(t)},polygon:function(e){for(var t,i,a=[],n=0,s=e.length;s>n;++n){try{i=this.parseCoords.linestring.apply(this,[e[n]])}catch(r){throw r}t=new OpenLayers.Geometry.LinearRing(i.components),a.push(t)}return new OpenLayers.Geometry.Polygon(a)},multipolygon:function(e){for(var t=[],i=null,a=0,n=e.length;n>a;++a){try{i=this.parseCoords.polygon.apply(this,[e[a]])}catch(s){throw s}t.push(i)}return new OpenLayers.Geometry.MultiPolygon(t)},box:function(e){if(2!=e.length)throw"GeoJSON box coordinates must have 2 elements";return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(e[0][0],e[0][1]),new OpenLayers.Geometry.Point(e[1][0],e[0][1]),new OpenLayers.Geometry.Point(e[1][0],e[1][1]),new OpenLayers.Geometry.Point(e[0][0],e[1][1]),new OpenLayers.Geometry.Point(e[0][0],e[0][1])])])}},write:function(e,t){var i={type:null};if(OpenLayers.Util.isArray(e)){i.type="FeatureCollection";var a=e.length;i.features=new Array(a);for(var n=0;a>n;++n){var s=e[n];if(!s instanceof OpenLayers.Feature.Vector){var r="FeatureCollection only supports collections of features: "+s;throw r}i.features[n]=this.extract.feature.apply(this,[s])}}else 0==e.CLASS_NAME.indexOf("OpenLayers.Geometry")?i=this.extract.geometry.apply(this,[e]):e instanceof OpenLayers.Feature.Vector&&(i=this.extract.feature.apply(this,[e]),e.layer&&e.layer.projection&&(i.crs=this.createCRSObject(e)));return OpenLayers.Format.JSON.prototype.write.apply(this,[i,t])},createCRSObject:function(e){var t=e.layer.projection.toString(),i={};if(t.match(/epsg:/i)){var a=parseInt(t.substring(t.indexOf(":")+1));i=4326==a?{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}}:{type:"name",properties:{name:"EPSG:"+a}}}return i},extract:{feature:function(e){var t=this.extract.geometry.apply(this,[e.geometry]),i={type:"Feature",properties:e.attributes,geometry:t};return null!=e.fid&&(i.id=e.fid),i},geometry:function(e){if(null==e)return null;this.internalProjection&&this.externalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var t,i=e.CLASS_NAME.split(".")[2],a=this.extract[i.toLowerCase()].apply(this,[e]);return t="Collection"==i?{type:"GeometryCollection",geometries:a}:{type:i,coordinates:a}},point:function(e){return[e.x,e.y]},multipoint:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push(this.extract.point.apply(this,[e.components[i]]));return t},linestring:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push(this.extract.point.apply(this,[e.components[i]]));return t},multilinestring:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push(this.extract.linestring.apply(this,[e.components[i]]));return t},polygon:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push(this.extract.linestring.apply(this,[e.components[i]]));return t},multipolygon:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push(this.extract.polygon.apply(this,[e.components[i]]));return t},collection:function(e){for(var t=e.components.length,i=new Array(t),a=0;t>a;++a)i[a]=this.extract.geometry.apply(this,[e.components[a]]);return i}},CLASS_NAME:"OpenLayers.Format.GeoJSON"}),OpenLayers.Format.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Format.XML,{layerIdentifier:"_layer",featureIdentifier:"_feature",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},gmlFormat:null,read:function(e){var t;"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var i=e.documentElement;if(i){var a=this["read_"+i.nodeName];t=a?a.call(this,i):new OpenLayers.Format.GML(this.options?this.options:{}).read(e)}else t=e;return t},read_msGMLOutput:function(e){var t=[],i=this.getSiblingNodesByTagCriteria(e,this.layerIdentifier);if(i)for(var a=0,n=i.length;n>a;++a){var s=i[a],r=s.nodeName;s.prefix&&(r=r.split(":")[1]);var r=r.replace(this.layerIdentifier,""),o=this.getSiblingNodesByTagCriteria(s,this.featureIdentifier);if(o)for(var l=0;l<o.length;l++){var u=o[l],c=this.parseGeometry(u),h=this.parseAttributes(u),d=new OpenLayers.Feature.Vector(c.geometry,h,null);d.bounds=c.bounds,d.type=r,t.push(d)}}return t},read_FeatureInfoResponse:function(e){for(var t=[],i=this.getElementsByTagNameNS(e,"*","FIELDS"),a=0,n=i.length;n>a;a++){var s,r=i[a],o=null,l={},u=r.attributes.length;
if(u>0)for(s=0;u>s;s++){var c=r.attributes[s];l[c.nodeName]=c.nodeValue}else{var h=r.childNodes;for(s=0,u=h.length;u>s;++s){var d=h[s];3!=d.nodeType&&(l[d.getAttribute("name")]=d.getAttribute("value"))}}t.push(new OpenLayers.Feature.Vector(o,l,null))}return t},getSiblingNodesByTagCriteria:function(e,t){var i,a,n,s,r,o=[];if(e&&e.hasChildNodes()){i=e.childNodes,n=i.length;for(var l=0;n>l;l++){for(r=i[l];r&&1!=r.nodeType;)r=r.nextSibling,l++;a=r?r.nodeName:"",a.length>0&&a.indexOf(t)>-1?o.push(r):(s=this.getSiblingNodesByTagCriteria(r,t),s.length>0&&(0==o.length?o=s:o.push(s)))}}return o},parseAttributes:function(e){var t={};if(1==e.nodeType)for(var i=e.childNodes,a=i.length,n=0;a>n;++n){var s=i[n];if(1==s.nodeType){var r=s.childNodes,o=s.prefix?s.nodeName.split(":")[1]:s.nodeName;if(0==r.length)t[o]=null;else if(1==r.length){var l=r[0];if(3==l.nodeType||4==l.nodeType){var u=l.nodeValue.replace(this.regExes.trimSpace,"");t[o]=u}}}}return t},parseGeometry:function(e){this.gmlFormat||(this.gmlFormat=new OpenLayers.Format.GML);var t,i=this.gmlFormat.parseFeature(e),a=null;return i&&(t=i.geometry&&i.geometry.clone(),a=i.bounds&&i.bounds.clone(),i.destroy()),{geometry:t,bounds:a}},CLASS_NAME:"OpenLayers.Format.WMSGetFeatureInfo"}),OpenLayers.Format.OWSCommon=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",getVersion:function(e){var t=this.version;if(!t){var i=e.getAttribute("xmlns:ows");i&&"1.1"===i.substring(i.lastIndexOf("/")+1)&&(t="1.1.0"),t||(t=this.defaultVersion)}return t},CLASS_NAME:"OpenLayers.Format.OWSCommon"}),OpenLayers.Format.OWSCommon.v1=OpenLayers.Class(OpenLayers.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},read:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i={};return this.readChildNodes(e,i),i},readers:{ows:{Exception:function(e,t){var i={code:e.getAttribute("exceptionCode"),locator:e.getAttribute("locator"),texts:[]};t.exceptions.push(i),this.readChildNodes(e,i)},ExceptionText:function(e,t){var i=this.getChildValue(e);t.texts.push(i)},ServiceIdentification:function(e,t){t.serviceIdentification={},this.readChildNodes(e,t.serviceIdentification)},Title:function(e,t){t.title=this.getChildValue(e)},Abstract:function(e,t){t["abstract"]=this.getChildValue(e)},Keywords:function(e,t){t.keywords={},this.readChildNodes(e,t.keywords)},Keyword:function(e,t){t[this.getChildValue(e)]=!0},ServiceType:function(e,t){t.serviceType={codeSpace:e.getAttribute("codeSpace"),value:this.getChildValue(e)}},ServiceTypeVersion:function(e,t){t.serviceTypeVersion=this.getChildValue(e)},Fees:function(e,t){t.fees=this.getChildValue(e)},AccessConstraints:function(e,t){t.accessConstraints=this.getChildValue(e)},ServiceProvider:function(e,t){t.serviceProvider={},this.readChildNodes(e,t.serviceProvider)},ProviderName:function(e,t){t.providerName=this.getChildValue(e)},ProviderSite:function(e,t){t.providerSite=this.getAttributeNS(e,this.namespaces.xlink,"href")},ServiceContact:function(e,t){t.serviceContact={},this.readChildNodes(e,t.serviceContact)},IndividualName:function(e,t){t.individualName=this.getChildValue(e)},PositionName:function(e,t){t.positionName=this.getChildValue(e)},ContactInfo:function(e,t){t.contactInfo={},this.readChildNodes(e,t.contactInfo)},Phone:function(e,t){t.phone={},this.readChildNodes(e,t.phone)},Voice:function(e,t){t.voice=this.getChildValue(e)},Address:function(e,t){t.address={},this.readChildNodes(e,t.address)},DeliveryPoint:function(e,t){t.deliveryPoint=this.getChildValue(e)},City:function(e,t){t.city=this.getChildValue(e)},AdministrativeArea:function(e,t){t.administrativeArea=this.getChildValue(e)},PostalCode:function(e,t){t.postalCode=this.getChildValue(e)},Country:function(e,t){t.country=this.getChildValue(e)},ElectronicMailAddress:function(e,t){t.electronicMailAddress=this.getChildValue(e)},Role:function(e,t){t.role=this.getChildValue(e)},OperationsMetadata:function(e,t){t.operationsMetadata={},this.readChildNodes(e,t.operationsMetadata)},Operation:function(e,t){var i=e.getAttribute("name");t[i]={},this.readChildNodes(e,t[i])},DCP:function(e,t){t.dcp={},this.readChildNodes(e,t.dcp)},HTTP:function(e,t){t.http={},this.readChildNodes(e,t.http)},Get:function(e,t){t.get||(t.get=[]);var i={url:this.getAttributeNS(e,this.namespaces.xlink,"href")};this.readChildNodes(e,i),t.get.push(i)},Post:function(e,t){t.post||(t.post=[]);var i={url:this.getAttributeNS(e,this.namespaces.xlink,"href")};this.readChildNodes(e,i),t.post.push(i)},Parameter:function(e,t){t.parameters||(t.parameters={});var i=e.getAttribute("name");t.parameters[i]={},this.readChildNodes(e,t.parameters[i])},Constraint:function(e,t){t.constraints||(t.constraints={});var i=e.getAttribute("name");t.constraints[i]={},this.readChildNodes(e,t.constraints[i])},Value:function(e,t){t[this.getChildValue(e)]=!0},OutputFormat:function(e,t){t.formats.push({value:this.getChildValue(e)}),this.readChildNodes(e,t)},WGS84BoundingBox:function(e,t){var i={};i.crs=e.getAttribute("crs"),t.BoundingBox?t.BoundingBox.push(i):(t.projection=i.crs,i=t),this.readChildNodes(e,i)},BoundingBox:function(e,t){this.readers.ows.WGS84BoundingBox.apply(this,[e,t])},LowerCorner:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,"");i=i.replace(this.regExes.trimComma,",");var a=i.split(this.regExes.splitSpace);t.left=a[0],t.bottom=a[1]},UpperCorner:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,"");i=i.replace(this.regExes.trimComma,",");var a=i.split(this.regExes.splitSpace);t.right=a[0],t.top=a[1],t.bounds=new OpenLayers.Bounds(t.left,t.bottom,t.right,t.top),delete t.left,delete t.bottom,delete t.right,delete t.top},Language:function(e,t){t.language=this.getChildValue(e)}}},writers:{ows:{BoundingBox:function(e){var t=this.createElementNSPlus("ows:BoundingBox",{attributes:{crs:e.projection}});return this.writeNode("ows:LowerCorner",e,t),this.writeNode("ows:UpperCorner",e,t),t},LowerCorner:function(e){var t=this.createElementNSPlus("ows:LowerCorner",{value:e.bounds.left+" "+e.bounds.bottom});return t},UpperCorner:function(e){var t=this.createElementNSPlus("ows:UpperCorner",{value:e.bounds.right+" "+e.bounds.top});return t},Identifier:function(e){var t=this.createElementNSPlus("ows:Identifier",{value:e});return t},Title:function(e){var t=this.createElementNSPlus("ows:Title",{value:e});return t},Abstract:function(e){var t=this.createElementNSPlus("ows:Abstract",{value:e});return t},OutputFormat:function(e){var t=this.createElementNSPlus("ows:OutputFormat",{value:e});return t}}},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1"}),OpenLayers.Format.OWSCommon.v1_0_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:OpenLayers.Util.applyDefaults({ExceptionReport:function(e,t){t.success=!1,t.exceptionReport={version:e.getAttribute("version"),language:e.getAttribute("language"),exceptions:[]},this.readChildNodes(e,t.exceptionReport)}},OpenLayers.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:OpenLayers.Format.OWSCommon.v1.prototype.writers.ows},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1_0_0"}),OpenLayers.Format.OWSCommon.v1_1_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows/1.1",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:OpenLayers.Util.applyDefaults({ExceptionReport:function(e,t){t.exceptionReport={version:e.getAttribute("version"),language:e.getAttribute("xml:lang"),exceptions:[]},this.readChildNodes(e,t.exceptionReport)},AllowedValues:function(e,t){t.allowedValues={},this.readChildNodes(e,t.allowedValues)},AnyValue:function(e,t){t.anyValue=!0},DataType:function(e,t){t.dataType=this.getChildValue(e)},Range:function(e,t){t.range={},this.readChildNodes(e,t.range)},MinimumValue:function(e,t){t.minValue=this.getChildValue(e)},MaximumValue:function(e,t){t.maxValue=this.getChildValue(e)},Identifier:function(e,t){t.identifier=this.getChildValue(e)},SupportedCRS:function(e,t){t.supportedCRS=this.getChildValue(e)}},OpenLayers.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:OpenLayers.Util.applyDefaults({Range:function(e){var t=this.createElementNSPlus("ows:Range",{attributes:{"ows:rangeClosure":e.closure}});return this.writeNode("ows:MinimumValue",e.minValue,t),this.writeNode("ows:MaximumValue",e.maxValue,t),t},MinimumValue:function(e){var t=this.createElementNSPlus("ows:MinimumValue",{value:e});return t},MaximumValue:function(e){var t=this.createElementNSPlus("ows:MaximumValue",{value:e});return t},Value:function(e){var t=this.createElementNSPlus("ows:Value",{value:e});return t}},OpenLayers.Format.OWSCommon.v1.prototype.writers.ows)},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1_1_0"}),OpenLayers.Format.WMTSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(e,t){var i,a={layer:!0,matrixSet:!0};for(var n in a)if(!(n in t))throw new Error("Missing property '"+n+"' in layer configuration.");var s=e.contents,r=s.tileMatrixSets[t.matrixSet];s.layers;for(var o,l=0,u=s.layers.length;u>l;++l)if(s.layers[l].identifier===t.layer){o=s.layers[l];break}if(o&&r){for(var c,l=0,u=o.styles.length;u>l&&(c=o.styles[l],!c.isDefault);++l);i=new OpenLayers.Layer.WMTS(OpenLayers.Util.applyDefaults(t,{url:"REST"===t.requestEncoding&&o.resourceUrl?o.resourceUrl.tile.template:e.operationsMetadata.GetTile.dcp.http.get[0].url,name:o.title,style:c.identifier,matrixIds:r.matrixIds,tileFullExtent:r.bounds}))}return i},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities"}),OpenLayers.Format.WKT=OpenLayers.Class(OpenLayers.Format,{initialize:function(e){this.regExes={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/},OpenLayers.Format.prototype.initialize.apply(this,[e])},read:function(e){var t,i,a;e=e.replace(/[\n\r]/g," ");var n=this.regExes.typeStr.exec(e);if(n&&(i=n[1].toLowerCase(),a=n[2],this.parse[i]&&(t=this.parse[i].apply(this,[a])),this.internalProjection&&this.externalProjection))if(t&&"OpenLayers.Feature.Vector"==t.CLASS_NAME)t.geometry.transform(this.externalProjection,this.internalProjection);else if(t&&"geometrycollection"!=i&&"object"==typeof t)for(var s=0,r=t.length;r>s;s++){var o=t[s];o.geometry.transform(this.externalProjection,this.internalProjection)}return t},write:function(e){var t,i,a;e.constructor==Array?(t=e,a=!0):(t=[e],a=!1);var n=[];a&&n.push("GEOMETRYCOLLECTION(");for(var s=0,r=t.length;r>s;++s)a&&s>0&&n.push(","),i=t[s].geometry,n.push(this.extractGeometry(i));return a&&n.push(")"),n.join("")},extractGeometry:function(e){var t=e.CLASS_NAME.split(".")[2].toLowerCase();if(!this.extract[t])return null;this.internalProjection&&this.externalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var i="collection"==t?"GEOMETRYCOLLECTION":t.toUpperCase(),a=i+"("+this.extract[t].apply(this,[e])+")";return a},extract:{point:function(e){return e.x+" "+e.y},multipoint:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push("("+this.extract.point.apply(this,[e.components[i]])+")");return t.join(",")},linestring:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push(this.extract.point.apply(this,[e.components[i]]));return t.join(",")},multilinestring:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push("("+this.extract.linestring.apply(this,[e.components[i]])+")");return t.join(",")},polygon:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push("("+this.extract.linestring.apply(this,[e.components[i]])+")");return t.join(",")},multipolygon:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push("("+this.extract.polygon.apply(this,[e.components[i]])+")");return t.join(",")},collection:function(e){for(var t=[],i=0,a=e.components.length;a>i;++i)t.push(this.extractGeometry.apply(this,[e.components[i]]));return t.join(",")}},parse:{point:function(e){var t=OpenLayers.String.trim(e).split(this.regExes.spaces);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(t[0],t[1]))},multipoint:function(e){for(var t,i=OpenLayers.String.trim(e).split(","),a=[],n=0,s=i.length;s>n;++n)t=i[n].replace(this.regExes.trimParens,"$1"),a.push(this.parse.point.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPoint(a))},linestring:function(e){for(var t=OpenLayers.String.trim(e).split(","),i=[],a=0,n=t.length;n>a;++a)i.push(this.parse.point.apply(this,[t[a]]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(i))},multilinestring:function(e){for(var t,i=OpenLayers.String.trim(e).split(this.regExes.parenComma),a=[],n=0,s=i.length;s>n;++n)t=i[n].replace(this.regExes.trimParens,"$1"),a.push(this.parse.linestring.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiLineString(a))},polygon:function(e){for(var t,i,a,n=OpenLayers.String.trim(e).split(this.regExes.parenComma),s=[],r=0,o=n.length;o>r;++r)t=n[r].replace(this.regExes.trimParens,"$1"),i=this.parse.linestring.apply(this,[t]).geometry,a=new OpenLayers.Geometry.LinearRing(i.components),s.push(a);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon(s))},multipolygon:function(e){for(var t,i=OpenLayers.String.trim(e).split(this.regExes.doubleParenComma),a=[],n=0,s=i.length;s>n;++n)t=i[n].replace(this.regExes.trimParens,"$1"),a.push(this.parse.polygon.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon(a))},geometrycollection:function(e){e=e.replace(/,\s*([A-Za-z])/g,"|$1");for(var t=OpenLayers.String.trim(e).split("|"),i=[],a=0,n=t.length;n>a;++a)i.push(OpenLayers.Format.WKT.prototype.read.apply(this,[t[a]]));return i}},CLASS_NAME:"OpenLayers.Format.WKT"}),OpenLayers.Format.Filter=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"OpenLayers.Format.Filter"}),OpenLayers.Format.Filter.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"ogc",schemaLocation:null,initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){var t={};return this.readers.ogc.Filter.apply(this,[e,t]),t.filter},readers:{ogc:{_expression:function(e){for(var t,i="",a=e.firstChild;a;a=a.nextSibling)switch(a.nodeType){case 1:t=this.readNode(a),t.property?i+="${"+t.property+"}":void 0!==t.value&&(i+=t.value);break;case 3:case 4:i+=a.nodeValue}return i},Filter:function(e,t){var i={fids:[],filters:[]};this.readChildNodes(e,i),i.fids.length>0?t.filter=new OpenLayers.Filter.FeatureId({fids:i.fids}):i.filters.length>0&&(t.filter=i.filters[0])},FeatureId:function(e,t){var i=e.getAttribute("fid");i&&t.fids.push(i)},And:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND});this.readChildNodes(e,i),t.filters.push(i)},Or:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR});this.readChildNodes(e,i),t.filters.push(i)},Not:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.NOT});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsLessThan:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsGreaterThan:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsLessThanOrEqualTo:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsGreaterThanOrEqualTo:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsBetween:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN});this.readChildNodes(e,i),t.filters.push(i)},Literal:function(e,t){t.value=OpenLayers.String.numericIf(this.getChildValue(e))},PropertyName:function(e,t){t.property=this.getChildValue(e)},LowerBoundary:function(e,t){t.lowerBoundary=OpenLayers.String.numericIf(this.readers.ogc._expression.call(this,e))},UpperBoundary:function(e,t){t.upperBoundary=OpenLayers.String.numericIf(this.readers.ogc._expression.call(this,e))},Intersects:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.INTERSECTS)},Within:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.WITHIN)},Contains:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.CONTAINS)},DWithin:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.DWITHIN)},Distance:function(e,t){t.distance=parseInt(this.getChildValue(e)),t.distanceUnits=e.getAttribute("units")},Function:function(){}}},readSpatial:function(e,t,i){var a=new OpenLayers.Filter.Spatial({type:i});this.readChildNodes(e,a),a.value=a.components[0],delete a.components,t.filters.push(a)},writeOgcExpression:function(e,t){if(e instanceof OpenLayers.Filter.Function){var i=this.writeNode("Function",e,t);t.appendChild(i)}else this.writeNode("Literal",e,t);return t},write:function(e){return this.writers.ogc.Filter.apply(this,[e])},writeFeatureIdNodes:function(e,t){for(var i=0,a=e.fids.length;a>i;++i)this.writeNode("FeatureId",e.fids[i],t)},writers:{ogc:{Filter:function(e){var t=this.createElementNSPlus("ogc:Filter");return"FID"===e.type?OpenLayers.Format.Filter.v1.prototype.writeFeatureIdNodes.call(this,e,t):this.writeNode(this.getFilterType(e),e,t),t},FeatureId:function(e){return this.createElementNSPlus("ogc:FeatureId",{attributes:{fid:e}})},And:function(e){for(var t,i=this.createElementNSPlus("ogc:And"),a=0,n=e.filters.length;n>a;++a)t=e.filters[a],"FID"===t.type?OpenLayers.Format.Filter.v1.prototype.writeFeatureIdNodes.call(this,t,i):this.writeNode(this.getFilterType(t),t,i);return i},Or:function(e){for(var t,i=this.createElementNSPlus("ogc:Or"),a=0,n=e.filters.length;n>a;++a)t=e.filters[a],"FID"===t.type?OpenLayers.Format.Filter.v1.prototype.writeFeatureIdNodes.call(this,t,i):this.writeNode(this.getFilterType(t),t,i);return i},Not:function(e){var t=this.createElementNSPlus("ogc:Not"),i=e.filters[0];return"FID"===i.type?OpenLayers.Format.Filter.v1.prototype.writeFeatureIdNodes.call(this,i,t):this.writeNode(this.getFilterType(i),i,t),t},PropertyIsLessThan:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLessThan");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsGreaterThan:function(e){var t=this.createElementNSPlus("ogc:PropertyIsGreaterThan");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsLessThanOrEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLessThanOrEqualTo");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsGreaterThanOrEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsGreaterThanOrEqualTo");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsBetween:function(e){var t=this.createElementNSPlus("ogc:PropertyIsBetween");return this.writeNode("PropertyName",e,t),this.writeNode("LowerBoundary",e,t),this.writeNode("UpperBoundary",e,t),t},PropertyName:function(e){return this.createElementNSPlus("ogc:PropertyName",{value:e.property})},Literal:function(e){return this.createElementNSPlus("ogc:Literal",{value:e})},LowerBoundary:function(e){var t=this.createElementNSPlus("ogc:LowerBoundary");return this.writeOgcExpression(e.lowerBoundary,t),t},UpperBoundary:function(e){var t=this.createElementNSPlus("ogc:UpperBoundary");return this.writeNode("Literal",e.upperBoundary,t),t},INTERSECTS:function(e){return this.writeSpatial(e,"Intersects")},WITHIN:function(e){return this.writeSpatial(e,"Within")},CONTAINS:function(e){return this.writeSpatial(e,"Contains")},DWITHIN:function(e){var t=this.writeSpatial(e,"DWithin");return this.writeNode("Distance",e,t),t},Distance:function(e){return this.createElementNSPlus("ogc:Distance",{attributes:{units:e.distanceUnits},value:e.distance})},Function:function(e){for(var t=this.createElementNSPlus("ogc:Function",{attributes:{name:e.name}}),i=e.params,a=0,n=i.length;n>a;a++)this.writeOgcExpression(i[a],t);return t}}},getFilterType:function(e){var t=this.filterMap[e.type];if(!t)throw"Filter writing not supported for rule type: "+e.type;return t},filterMap:{"&&":"And","||":"Or","!":"Not","==":"PropertyIsEqualTo","!=":"PropertyIsNotEqualTo","<":"PropertyIsLessThan",">":"PropertyIsGreaterThan","<=":"PropertyIsLessThanOrEqualTo",">=":"PropertyIsGreaterThanOrEqualTo","..":"PropertyIsBetween","~":"PropertyIsLike",BBOX:"BBOX",DWITHIN:"DWITHIN",WITHIN:"WITHIN",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS",FID:"FeatureId"},CLASS_NAME:"OpenLayers.Format.Filter.v1"}),OpenLayers.Format.Filter.v1_1_0=OpenLayers.Class(OpenLayers.Format.GML.v3,OpenLayers.Format.Filter.v1,{VERSION:"1.1.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.1.0/filter.xsd",initialize:function(e){OpenLayers.Format.GML.v3.prototype.initialize.apply(this,[e])},readers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(e,t){var i=e.getAttribute("matchCase"),a=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,matchCase:!("false"===i||"0"===i)});this.readChildNodes(e,a),t.filters.push(a)},PropertyIsNotEqualTo:function(e,t){var i=e.getAttribute("matchCase"),a=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.NOT_EQUAL_TO,matchCase:!("false"===i||"0"===i)});this.readChildNodes(e,a),t.filters.push(a)},PropertyIsLike:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE});this.readChildNodes(e,i);var a=e.getAttribute("wildCard"),n=e.getAttribute("singleChar"),s=e.getAttribute("escapeChar");i.value2regex(a,n,s),t.filters.push(i)}},OpenLayers.Format.Filter.v1.prototype.readers.ogc),gml:OpenLayers.Format.GML.v3.prototype.readers.gml,feature:OpenLayers.Format.GML.v3.prototype.readers.feature},writers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsEqualTo",{attributes:{matchCase:e.matchCase}});return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsNotEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsNotEqualTo",{attributes:{matchCase:e.matchCase}});return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsLike:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{matchCase:e.matchCase,wildCard:"*",singleChar:".",escapeChar:"!"}});return this.writeNode("PropertyName",e,t),this.writeNode("Literal",e.regex2value(),t),t},BBOX:function(e){var t=this.createElementNSPlus("ogc:BBOX");e.property&&this.writeNode("PropertyName",e,t);var i=this.writeNode("gml:Envelope",e.value);return e.projection&&i.setAttribute("srsName",e.projection),t.appendChild(i),t},SortBy:function(e){for(var t=this.createElementNSPlus("ogc:SortBy"),i=0,a=e.length;a>i;i++)this.writeNode("ogc:SortProperty",e[i],t);return t},SortProperty:function(e){var t=this.createElementNSPlus("ogc:SortProperty");return this.writeNode("ogc:PropertyName",e,t),this.writeNode("ogc:SortOrder","DESC"==e.order?"DESC":"ASC",t),t},SortOrder:function(e){var t=this.createElementNSPlus("ogc:SortOrder",{value:e});return t}},OpenLayers.Format.Filter.v1.prototype.writers.ogc),gml:OpenLayers.Format.GML.v3.prototype.writers.gml,feature:OpenLayers.Format.GML.v3.prototype.writers.feature},writeSpatial:function(e,t){var i=this.createElementNSPlus("ogc:"+t);if(this.writeNode("PropertyName",e,i),e.value instanceof OpenLayers.Filter.Function)this.writeNode("Function",e.value,i);else{var a;a=e.value instanceof OpenLayers.Geometry?this.writeNode("feature:_geometry",e.value).firstChild:this.writeNode("gml:Envelope",e.value),e.projection&&a.setAttribute("srsName",e.projection),i.appendChild(a)}return i},CLASS_NAME:"OpenLayers.Format.Filter.v1_1_0"}),OpenLayers.Format.WFST=function(e){e=OpenLayers.Util.applyDefaults(e,OpenLayers.Format.WFST.DEFAULTS);var t=OpenLayers.Format.WFST["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported WFST version: "+e.version;return new t(e)},OpenLayers.Format.WFST.DEFAULTS={version:"1.0.0"},OpenLayers.Format.WFST.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},defaultPrefix:"wfs",version:null,schemaLocations:null,srsName:null,extractAttributes:!0,xy:!0,stateName:null,initialize:function(e){this.stateName={},this.stateName[OpenLayers.State.INSERT]="wfs:Insert",this.stateName[OpenLayers.State.UPDATE]="wfs:Update",this.stateName[OpenLayers.State.DELETE]="wfs:Delete",OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},getSrsName:function(e,t){var i=t&&t.srsName;return i||(i=e&&e.layer?e.layer.projection.getCode():this.srsName),i},read:function(e,t){t=t||{},OpenLayers.Util.applyDefaults(t,{output:"features"}),"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var i={};return e&&this.readNode(e,i,!0),i.features&&"features"===t.output&&(i=i.features),i},readers:{wfs:{FeatureCollection:function(e,t){t.features=[],this.readChildNodes(e,t)}}},write:function(e,t){var i=this.writeNode("wfs:Transaction",{features:e,options:t}),a=this.schemaLocationAttr();return a&&this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",a),OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{wfs:{GetFeature:function(e){var t=this.createElementNSPlus("wfs:GetFeature",{attributes:{service:"WFS",version:this.version,handle:e&&e.handle,outputFormat:e&&e.outputFormat,maxFeatures:e&&e.maxFeatures,"xsi:schemaLocation":this.schemaLocationAttr(e)}});if("string"==typeof this.featureType)this.writeNode("Query",e,t);else for(var i=0,a=this.featureType.length;a>i;i++)e.featureType=this.featureType[i],this.writeNode("Query",e,t);return t},Transaction:function(e){e=e||{};var t,i,a=e.options||{},n=this.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version,handle:a.handle}}),s=e.features;if(s){a.multi===!0&&OpenLayers.Util.extend(this.geometryTypes,{"OpenLayers.Geometry.Point":"MultiPoint","OpenLayers.Geometry.LineString":this.multiCurve===!0?"MultiCurve":"MultiLineString","OpenLayers.Geometry.Polygon":this.multiSurface===!0?"MultiSurface":"MultiPolygon"});var r,o;for(t=0,i=s.length;i>t;++t)o=s[t],r=this.stateName[o.state],r&&this.writeNode(r,{feature:o,options:a},n);a.multi===!0&&this.setGeometryTypes()}if(a.nativeElements)for(t=0,i=a.nativeElements.length;i>t;++t)this.writeNode("wfs:Native",a.nativeElements[t],n);return n},Native:function(e){var t=this.createElementNSPlus("wfs:Native",{attributes:{vendorId:e.vendorId,safeToIgnore:e.safeToIgnore},value:e.value});return t},Insert:function(e){var t=e.feature,i=e.options,a=this.createElementNSPlus("wfs:Insert",{attributes:{handle:i&&i.handle}});return this.srsName=this.getSrsName(t),this.writeNode("feature:_typeName",t,a),a},Update:function(e){var t=e.feature,i=e.options,a=this.createElementNSPlus("wfs:Update",{attributes:{handle:i&&i.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});this.featureNS&&a.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);var n=t.modified;null===this.geometryName||n&&void 0===n.geometry||(this.srsName=this.getSrsName(t),this.writeNode("Property",{name:this.geometryName,value:t.geometry},a));for(var s in t.attributes)void 0===t.attributes[s]||n&&n.attributes&&(!n.attributes||void 0===n.attributes[s])||this.writeNode("Property",{name:s,value:t.attributes[s]},a);return this.writeNode("ogc:Filter",new OpenLayers.Filter.FeatureId({fids:[t.fid]}),a),a},Property:function(e){var t=this.createElementNSPlus("wfs:Property");return this.writeNode("Name",e.name,t),null!==e.value&&this.writeNode("Value",e.value,t),t},Name:function(e){return this.createElementNSPlus("wfs:Name",{value:e})},Value:function(e){var t;if(e instanceof OpenLayers.Geometry){t=this.createElementNSPlus("wfs:Value");var i=this.writeNode("feature:_geometry",e).firstChild;t.appendChild(i)}else t=this.createElementNSPlus("wfs:Value",{value:e});return t},Delete:function(e){var t=e.feature,i=e.options,a=this.createElementNSPlus("wfs:Delete",{attributes:{handle:i&&i.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});return this.featureNS&&a.setAttribute("xmlns:"+this.featurePrefix,this.featureNS),this.writeNode("ogc:Filter",new OpenLayers.Filter.FeatureId({fids:[t.fid]}),a),a}}},schemaLocationAttr:function(e){e=OpenLayers.Util.extend({featurePrefix:this.featurePrefix,schema:this.schema},e);var t=OpenLayers.Util.extend({},this.schemaLocations);e.schema&&(t[e.featurePrefix]=e.schema);var i,a=[];for(var n in t)i=this.namespaces[n],i&&a.push(i+" "+t[n]);var s=a.join(" ")||void 0;return s},setFilterProperty:function(e){if(e.filters)for(var t=0,i=e.filters.length;i>t;++t)OpenLayers.Format.WFST.v1.prototype.setFilterProperty.call(this,e.filters[t]);else e instanceof OpenLayers.Filter.Spatial&&!e.property&&(e.property=this.geometryName)},CLASS_NAME:"OpenLayers.Format.WFST.v1"}),OpenLayers.Format.WFST.v1_1_0=OpenLayers.Class(OpenLayers.Format.Filter.v1_1_0,OpenLayers.Format.WFST.v1,{version:"1.1.0",schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"},initialize:function(e){OpenLayers.Format.Filter.v1_1_0.prototype.initialize.apply(this,[e]),OpenLayers.Format.WFST.v1.prototype.initialize.apply(this,[e])},readNode:function(e,t){return OpenLayers.Format.GML.v3.prototype.readNode.apply(this,[e,t])},readers:{wfs:OpenLayers.Util.applyDefaults({FeatureCollection:function(e,t){t.numberOfFeatures=parseInt(e.getAttribute("numberOfFeatures")),OpenLayers.Format.WFST.v1.prototype.readers.wfs.FeatureCollection.apply(this,arguments)},TransactionResponse:function(e,t){t.insertIds=[],t.success=!1,this.readChildNodes(e,t)},TransactionSummary:function(e,t){t.success=!0},InsertResults:function(e,t){this.readChildNodes(e,t)},Feature:function(e,t){var i={fids:[]};this.readChildNodes(e,i),t.insertIds.push(i.fids[0])}},OpenLayers.Format.WFST.v1.prototype.readers.wfs),gml:OpenLayers.Format.GML.v3.prototype.readers.gml,feature:OpenLayers.Format.GML.v3.prototype.readers.feature,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.readers.ogc,ows:OpenLayers.Format.OWSCommon.v1_0_0.prototype.readers.ows},writers:{wfs:OpenLayers.Util.applyDefaults({GetFeature:function(e){var t=OpenLayers.Format.WFST.v1.prototype.writers.wfs.GetFeature.apply(this,arguments);return e&&this.setAttributes(t,{resultType:e.resultType,startIndex:e.startIndex,count:e.count}),t},Query:function(e){e=OpenLayers.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName},e);var t=e.featurePrefix,i=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(t?t+":":"")+e.featureType,srsName:e.srsName}});if(e.featureNS&&i.setAttribute("xmlns:"+t,e.featureNS),e.propertyNames)for(var a=0,n=e.propertyNames.length;n>a;a++)this.writeNode("wfs:PropertyName",{property:e.propertyNames[a]},i);return e.filter&&(OpenLayers.Format.WFST.v1_1_0.prototype.setFilterProperty.call(this,e.filter),this.writeNode("ogc:Filter",e.filter,i)),i},PropertyName:function(e){return this.createElementNSPlus("wfs:PropertyName",{value:e.property})}},OpenLayers.Format.WFST.v1.prototype.writers.wfs),gml:OpenLayers.Format.GML.v3.prototype.writers.gml,feature:OpenLayers.Format.GML.v3.prototype.writers.feature,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.writers.ogc},CLASS_NAME:"OpenLayers.Format.WFST.v1_1_0"}),OpenLayers.Lang={code:null,defaultCode:"en",getCode:function(){return OpenLayers.Lang.code||OpenLayers.Lang.setCode(),OpenLayers.Lang.code
},setCode:function(e){var t;e||(e="msie"==OpenLayers.BROWSER_NAME?navigator.userLanguage:navigator.language);var i=e.split("-");if(i[0]=i[0].toLowerCase(),"object"==typeof OpenLayers.Lang[i[0]]&&(t=i[0]),i[1]){var a=i[0]+"-"+i[1].toUpperCase();"object"==typeof OpenLayers.Lang[a]&&(t=a)}t||(OpenLayers.Console.warn("Failed to find OpenLayers.Lang."+i.join("-")+" dictionary, falling back to default language"),t=OpenLayers.Lang.defaultCode),OpenLayers.Lang.code=t},translate:function(e,t){var i=OpenLayers.Lang[OpenLayers.Lang.getCode()],a=i&&i[e];return a||(a=e),t&&(a=OpenLayers.String.format(a,t)),a}},OpenLayers.i18n=OpenLayers.Lang.translate,Oskari.clazz.define("Oskari.mapframework.bundle.MapWmtsBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.MapWmtsBundleInstance")},update:function(e,t,i,a){e.alert("RECEIVED update notification "+a)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/plugin/wmtslayer/WmtsLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/domain/WmtsLayer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/service/WmtsLayerService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/service/WmtsLayerModelBuilder.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/format/WMTS_1_0_0_capabilities.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/layer/WMTS.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/instance.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"mapwmts","Bundle-Name":"mapwmts","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"WMTS",Title:"WMTS"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","Ext"]}}}),Oskari.bundle_manager.installBundleClass("mapwmts","Oskari.mapframework.bundle.MapWmtsBundle"),Oskari.clazz.define("Oskari.mapframework.wmts.mapmodule.plugin.WmtsLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this._wmtsLayerClazz=Oskari.clazz.create("Oskari.openlayers.Patch.layer.WMTS"),this.config=e},{__name:"WmtsLayerPlugin",getName:function(){return this.pluginName},getMap:function(){return this._map},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},register:function(){this.getMapModule().setLayerPlugin("WmtsLayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("WmtsLayer",null)},init:function(e){var t=(this.config?this.config.sandbox:null)||"sandbox",e=Oskari.getSandbox(t),i=e.getService("Oskari.mapframework.service.MapLayerService");if(i){i.registerLayerModel("wmtslayer","Oskari.mapframework.wmts.domain.WmtsLayer");var a=Oskari.clazz.create("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder");i.registerLayerModelBuilder("wmtslayer",a)}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this.afterMapLayerRemoveEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this.afterChangeMapLayerOpacityEvent(e)},AfterChangeMapLayerStyleEvent:function(e){this.afterChangeMapLayerStyleEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var a=e[i],n=a.getId();a.isLayerOfType("WMTS")&&(t.printDebug("preselecting "+n),this.addMapLayerToMap(a,!0,a.isBaseLayer()))}},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},addMapLayerToMap:function(e){if(e.isLayerOfType("WMTS")){var t=this,i=t.getMap();e.getWmtsMatrixSet().matrixIds;var a=e.getWmtsLayerDef(),n=null;n=e.isBaseLayer()||e.isGroupLayer()?"basemap_"+e.getId():"layer_"+e.getId();var s=this._sandbox,r=e.getWmtsUrls()[0],o=e.getWmtsMatrixSet(),l={visibility:!0,transparent:!0,format:"image/png",url:r,layer:e.getWmtsName(),style:e.getCurrentStyle().getName(),matrixIds:o.matrixIds,matrixSet:o.identifier,isBaseLayer:e.isBaseLayer(),buffer:0,minScale:e.getMinScale(),maxScale:e.getMaxScale()};s.printDebug("[WmtsLayerPlugin] creating WMTS Layer "+o.identifier+" / "+l.id+"/"+l.layer+"/"+l.url);var u=OpenLayers.Util.applyDefaults(l,{url:r,name:n,style:e.getCurrentStyle().getName(),matrixIds:o.matrixIds,layerDef:a}),c=this._wmtsLayerClazz.getPatch(),h=new c(u);h.opacity=e.getOpacity()/100,s.printDebug("[WmtsLayerPlugin] created WMTS layer "+h),i.addLayers([h])}},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.removeMapLayerFromMap(t)},removeMapLayerFromMap:function(e){if(e.isLayerOfType("WMTS"))if(e.isBaseLayer()||e.isGroupLayer())if(e.getSubLayers().length>0)for(var t=0;t<e.getSubLayers().length;t++){var i=this._map.getLayersByName("basemap_"+e.getSubLayers()[t].getId());i[0].destroy()}else{var i=this._map.getLayersByName("layer_"+e.getId());i[0].destroy()}else{var i=this._map.getLayersByName("layer_"+e.getId());i[0].destroy()}},getOLMapLayers:function(e){if(!e.isLayerOfType("WMTS"))return null;if(!e.isBaseLayer()&&!e.isGroupLayer())return this._map.getLayersByName("layer_"+e.getId());if(!(e.getSubLayers().length>0))return this._map.getLayersByName("layer_"+e.getId());for(var t=0;t<e.getSubLayers().length;t++)return this._map.getLayersByName("basemap_"+e.getSubLayers()[t].getId());return null},afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WMTS"))if(t.isBaseLayer()||t.isGroupLayer())if(t.getSubLayers().length>0)for(var i=0;i<t.getSubLayers().length;i++){var a=this._map.getLayersByName("basemap_"+t.getSubLayers()[i].getId());a[0].setOpacity(t.getOpacity()/100)}else{var a=this._map.getLayersByName("layer_"+t.getId());null!=a[0]&&a[0].setOpacity(t.getOpacity()/100)}else{this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var a=this._map.getLayersByName("layer_"+t.getId());null!=a[0]&&a[0].setOpacity(t.getOpacity()/100)}},afterChangeMapLayerStyleEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WMTS")&&!t.isBaseLayer()){var i=this._map.getLayersByName("layer_"+t.getId());null!=i&&i[0].mergeNewParams({styles:t.getCurrentStyle().getName()})}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.wmts.domain.WmtsLayer",function(){this._WmtsLayerName=null,this._WmtsMatrixSet=null,this._WmtsUrls=[],this._layerType="WMTS"},{setWmtsName:function(e){this._WmtsName=e},getWmtsName:function(){return this._WmtsName},setWmtsMatrixSet:function(e){this._WmtsMatrixSet=e},getWmtsMatrixSet:function(){return this._WmtsMatrixSet},setWmtsLayerDef:function(e){this._WmtsLayerDef=e},getWmtsLayerDef:function(){return this._WmtsLayerDef},addWmtsUrl:function(e){this._WmtsUrls.push(e)},getWmtsUrls:function(){return this._WmtsUrls}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.wmts.service.WMTSLayerService",function(e){this.mapLayerService=e,this.capabilities={},this.capabilitiesClazz=Oskari.clazz.create("Oskari.openlayers.Patch.WMTSCapabilities_v1_0_0")},{setCapabilities:function(e,t){this.capabilities[e]=t},getCapabilities:function(e){return this.capabilities[e]},readWMTSCapabilites:function(e,t,i){var a=this,n=this.capabilitiesClazz.getPatch(),s=new n;OpenLayers.Request.GET({url:t,params:{SERVICE:"WMTS",VERSION:"1.0.0",REQUEST:"GetCapabilities"},success:function(t){var n=t.responseXML;n&&n.documentElement||(n=t.responseText);var r=s.read(n);a.setCapabilities(e,r),a.parseCapabilitiesToLayers(e,r,i)},failure:function(){alert("Trouble getting capabilities doc"),OpenLayers.Console.error.apply(OpenLayers.Console,arguments)}})},parseCapabilitiesToLayers:function(e,t,i){var a=this.mapLayerService,n=null;n=t.operationsMetadata.GetTile.dcp.http.getArray?t.operationsMetadata.GetTile.dcp.http.getArray:t.operationsMetadata.GetTile.dcp.http.get;for(var s=t.contents.layers,r=t.contents,i=r.tileMatrixSets[i],o=0;o<s.length;o++){var l=s[o],u=l.identifier;l.identifier;var c={wmtsName:u,descriptionLink:"",orgName:"WMTS",type:"wmtslayer",legendImage:"",formats:{value:"text/html"},isQueryable:!0,minScale:1024e4,style:"",dataUrl:"",name:u,opacity:100,inspire:"WMTS",maxScale:1},h=Oskari.clazz.create("Oskari.mapframework.wmts.domain.WmtsLayer");h.setAsNormalLayer(),h.setId(u),h.setName(c.name),h.setWmtsName(c.wmtsName),h.setOpacity(c.opacity),h.setMaxScale(c.maxScale),h.setMinScale(c.minScale),h.setDescription(c.info),h.setDataUrl(c.dataUrl),h.setOrganizationName(c.orgName),h.setInspireName(c.inspire),h.setWmtsMatrixSet(i),h.setWmtsLayerDef(l),h.addWmtsUrl(n);for(var d,p=Oskari.clazz.builder("Oskari.mapframework.domain.Style"),f=0,m=l.styles.length;m>f;++f){d=l.styles[f];var g=p();if(g.setName(d.identifier),g.setTitle(d.identifier),h.addStyle(g),d.isDefault){h.selectStyle(d.identifier);break}}a.addLayer(h,!1)}}}),Oskari.clazz.define("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder",function(){},{parseLayerData:function(e,t){if(e.setWmtsName(t.wmsName),t.wmsUrl)for(var i=t.wmsUrl.split(","),a=0;a<i.length;a++)e.addWmtsUrl(i[a]);for(var n,s=Oskari.clazz.builder("Oskari.mapframework.domain.Style"),a=0,r=t.styles.length;r>a;++a){n=t.styles[a];var o=s();if(o.setName(n.identifier),o.setTitle(n.identifier),e.addStyle(o),n.isDefault){e.selectStyle(n.identifier);break}}e.setFeatureInfoEnabled(!0),t.tileMatrixSetData&&(e.setWmtsMatrixSet(t.tileMatrixSetData),e.setWmtsLayerDef(t.tileLayerData))}}),Oskari.clazz.define("Oskari.openlayers.Patch.WMTSCapabilities_v1_0_0",function(){},{getPatch:function(){return this.patch?this.patch:this.buildPatch()},buildPatch:function(){return this.patch=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1_1_0,{version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]),this.options=e;var t=OpenLayers.Util.extend({},OpenLayers.Format.WMTSCapabilities.prototype.yx);this.yx=OpenLayers.Util.extend(t,this.yx)},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t={};return this.readNode(e,t),t.version=this.version,t},props:{wmts:{TileMatrixLimits:{MinTileRow:["minTileRow",parseInt],MaxTileRow:["maxTileRow",parseInt],MinTileCol:["minTileCol",parseInt],MaxTileCol:["maxTileCol",parseInt],TileMatrix:["tileMatrix",null]}}},readers:{wmts:{Capabilities:function(e,t){this.readChildNodes(e,t)},Contents:function(e,t){t.contents={},t.contents.layers=[],t.contents.tileMatrixSets={},this.readChildNodes(e,t.contents)},Layer:function(e,t){var i={styles:[],formats:[],tileMatrixSetLinks:[],tileMatrixSetLinksMap:{}};i.layers=[],this.readChildNodes(e,i),t.layers.push(i)},Style:function(e,t){var i={};i.isDefault="true"===e.getAttribute("isDefault"),this.readChildNodes(e,i),t.styles.push(i)},Format:function(e,t){t.formats.push(this.getChildValue(e))},TileMatrixSetLink:function(e,t){var i={};this.readChildNodes(e,i),t.tileMatrixSetLinks.push(i),t.tileMatrixSetLinksMap[i.tileMatrixSet]=i},TileMatrixSet:function(e,t){if(t.layers){var i={matrixIds:[]};this.readChildNodes(e,i),t.tileMatrixSets[i.identifier]=i}else t.tileMatrixSet=this.getChildValue(e)},TileMatrix:function(e,t){var i={supportedCRS:t.supportedCRS};this.readChildNodes(e,i),t.matrixIds.push(i)},ScaleDenominator:function(e,t){t.scaleDenominator=parseFloat(this.getChildValue(e))},TopLeftCorner:function(e,t){var i,a=this.getChildValue(e),n=a.split(" ");if(t.supportedCRS){var s=t.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2");i=!!this.yx[s]}t.topLeftCorner=i?new OpenLayers.LonLat(n[1],n[0]):new OpenLayers.LonLat(n[0],n[1])},TileWidth:function(e,t){t.tileWidth=parseInt(this.getChildValue(e))},TileHeight:function(e,t){t.tileHeight=parseInt(this.getChildValue(e))},MatrixWidth:function(e,t){t.matrixWidth=parseInt(this.getChildValue(e))},MatrixHeight:function(e,t){t.matrixHeight=parseInt(this.getChildValue(e))},ResourceURL:function(e,t){t.resourceUrl=t.resourceUrl||{},t.resourceUrl[e.getAttribute("resourceType")]={format:e.getAttribute("format"),template:e.getAttribute("template")}},WSDL:function(e,t){t.wsdl={},t.wsdl.href=e.getAttribute("xlink:href")},ServiceMetadataURL:function(e,t){t.serviceMetadataUrl={},t.serviceMetadataUrl.href=e.getAttribute("xlink:href")},TileMatrixSetLimits:function(e,t){var i={tileMatrixLimits:[]};t.tileMatrixSetLimits=i,this.readChildNodes(e,i);for(var a={},n=0;n<i.tileMatrixLimits.length;n++){var s=i.tileMatrixLimits[n];a[s.tileMatrix]=s}t.tileMatrixSetLimitsMap=a},TileMatrixLimits:function(e,t){for(var i=this.getElementsByTagNameNS(e,this.namespaces.wmts,"*"),a=this.props.wmts.TileMatrixLimits,n={},s=0;s<i.length;s++){var r=i[s],o=this.getChildValue(r),l=r.localName||r.nodeName.split(":").pop(),u=a[l][0],c=a[l][1];n[u]=c?c(o):o}t.tileMatrixLimits.push(n)}},ows:OpenLayers.Util.applyDefaults({HTTP:function(e,t){t.http={},this.readChildNodes(e,t.http)},Get:function(e,t){var i=this.getAttributeNS(e,this.namespaces.xlink,"href");t.get||(t.get=i),t.getArray||(t.getArray=[]),t.getArray.push(i)}},OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows)},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities.v1_0_0"}),this.patch}},{protocol:["Oskari.openlayers.Patch"]}),Oskari.clazz.define("Oskari.openlayers.Patch.layer.WMTS",function(){},{getPatch:function(){return this.patch?this.patch:this.buildPatch()},buildPatch:function(){return this.patch=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,layerDef:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(e){var t={url:!0,layer:!0,style:!0,matrixSet:!0};for(var i in t)if(!(i in e))throw new Error("Missing property '"+i+"' in layer configuration.");e.params=OpenLayers.Util.upperCaseObject(e.params);var a=[e.name,e.url,e.params,e];if(OpenLayers.Layer.Grid.prototype.initialize.apply(this,a),this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop()),this.matrixIds){var n=this.matrixIds.length;if(n&&"string"==typeof this.matrixIds[0]){var s=this.matrixIds;this.matrixIds=new Array(n);for(var r=0;n>r;++r)this.matrixIds[r]={identifier:s[r]}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.updateMatrixProperties()},updateMatrixProperties:function(){this.matrix=this.getMatrix(),this.matrix&&(this.matrix.topLeftCorner&&(this.tileOrigin=this.matrix.topLeftCorner),this.matrix.tileWidth&&this.matrix.tileHeight&&(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)),this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)),this.tileFullExtent||(this.tileFullExtent=this.maxExtent))},moveTo:function(e,t){return(t||!this.matrix)&&this.updateMatrixProperties(),OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.WMTS(this.options)),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},getMatrix:function(){var e;if(this.matrixIds&&0!==this.matrixIds.length)if("scaleDenominator"in this.matrixIds[0])for(var t,i=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.map.getResolution()/28e-5,a=Number.POSITIVE_INFINITY,n=0,s=this.matrixIds.length;s>n;++n)t=Math.abs(1-this.matrixIds[n].scaleDenominator/i),a>t&&(a=t,e=this.matrixIds[n]);else e=this.matrixIds[this.map.getZoom()+this.zoomOffset];else e={identifier:this.map.getZoom()+this.zoomOffset};return e},getTileInfo:function(e){var t=this.map.getResolution(),i=(e.lon-this.tileOrigin.lon)/(t*this.tileSize.w),a=(this.tileOrigin.lat-e.lat)/(t*this.tileSize.h),n=Math.floor(i),s=Math.floor(a);return{col:n,row:s,i:Math.floor((i-n)*this.tileSize.w),j:Math.floor((a-s)*this.tileSize.h)}},getURL:function(e){e=this.adjustBounds(e);var t="";if(this.tileFullExtent&&!this.tileFullExtent.intersectsBounds(e))return t;var i=e.getCenterLonLat(),a=this.getTileInfo(i);if(this.matrix.identifier,this.layerDef&&this.layerDef.tileMatrixSetLinksMap){var n=this.layerDef.tileMatrixSetLinksMap[this.matrixSet],s=n?n.tileMatrixSetLimitsMap[this.matrix.identifier]:null,r=s?a.row>=s.minTileRow&&a.row<=s.maxTileRow:!1,o=s?a.col>=s.minTileCol&&a.col<=s.maxTileCol:!1;if(!r||!o)return OpenLayers.Util.getImagesLocation()+"blank.gif"}if("REST"===this.requestEncoding.toUpperCase()){var l=this.version+"/"+this.layer+"/"+this.style+"/";if(this.dimensions)for(var u=0;u<this.dimensions.length;u++)this.params[this.dimensions[u]]&&(l=l+this.params[this.dimensions[u]]+"/");l=l+this.matrixSet+"/"+this.matrix.identifier+"/"+a.row+"/"+a.col+"."+this.formatSuffix,t=OpenLayers.Util.isArray(this.url)?this.selectUrl(l,this.url):this.url,t.match(/\/$/)||(t+="/"),t+=l}else if("KVP"===this.requestEncoding.toUpperCase()){var c={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:a.row,TILECOL:a.col,FORMAT:this.format};t=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[c])}return t},mergeNewParams:function(e){return"KVP"===this.requestEncoding.toUpperCase()?OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(e)]):void 0},CLASS_NAME:"OpenLayers.Layer.WMTS"}),this.patch}},{protocol:["Oskari.openlayers.Patch"]}),Oskari.clazz.define("Oskari.mapframework.bundle.MapWmtsBundleInstance",function(){this.name="MapWmts",this.mediator=null,this.sandbox=null,this.service=null,this.ui=null},{start:function(){if("started"!=this.mediator.getState()){var e=this,t=e.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);this.sandbox=a;var n=a.getService("Oskari.mapframework.service.MapLayerService");n.registerLayerModel("wmtslayer","Oskari.mapframework.wmts.domain.WmtsLayer");var s=Oskari.clazz.create("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder");n.registerLayerModelBuilder("wmtslayer",s);var r=Oskari.clazz.create("Oskari.mapframework.wmts.service.WMTSLayerService",n);return this.service=r,this.mediator.setState("started"),this}},update:function(e,t,i,a){e.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+a)},stop:function(){return this.mediator.setState("stopped"),this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.MapWmtsBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.MapWfsBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs.MapWfsBundleInstance")},update:function(e,t,i,a){e.alert("RECEIVED update notification "+a)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/WfsLayer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/WfsLayerModelBuilder.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/QueuedTile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/TileQueue.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/WfsTileRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/event/WFSFeaturesSelectedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/service/WfsTileService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/plugin/wfslayer/QueuedTilesGrid.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/plugin/wfslayer/QueuedTilesStrategy.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/plugin/wfslayer/WfsLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/instance.js"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"mapwfs","Bundle-Name":"mapwfs","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"WFS",Title:"WFS"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","Ext"]}}}),Oskari.bundle_manager.installBundleClass("mapwfs","Oskari.mapframework.bundle.mapwfs.MapWfsBundle"),Oskari.clazz.define("Oskari.mapframework.domain.WfsLayer",function(){this._layerType="WFS"},{},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.domain.WfsLayerModelBuilder",function(e){this.sandbox=e,this.localization=Oskari.getLocalization("MapWfs")},{parseLayerData:function(e){var t=this,i=this.localization["object-data"],a=Oskari.clazz.builder("Oskari.mapframework.domain.Tool"),n=a();n.setName("objectData"),n.setTitle(i),n.setTooltip(i),n.setCallback(function(){t.sandbox.postRequestByName("ShowFeatureDataRequest",[e.getId()])}),e.addTool(n)}}),Oskari.clazz.define("Oskari.mapframework.gridcalc.QueuedTile",function(e){for(p in e)this[p]=e[p]},{getBounds:function(){return this.bounds}}),Oskari.clazz.define("Oskari.mapframework.gridcalc.TileQueue",function(){this.queue=[]},{getQueue:function(){return this.queue},getLength:function(){return this.queue.length},popJob:function(){var e=this.queue,t=e.length;if(0===t)return null;if(4>t)return e.shift(-1);var i=null,a=Math.floor(t/2);return i=e[a],this.queue=e.slice(0,a).concat(e.slice(a+1)),i},pushJob:function(e){this.queue.push(e)},flushQueue:function(){this.queue=[]}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.domain.WfsTileRequest",function(e,t,i,a,n,s){this._bbox=t,this._mapWidth=i,this._mapHeight=a,this._mapLayer=e,this._creator=n,this._sequenceNumber=s},{getMapLayer:function(){return this._mapLayer},getBbox:function(){return this._bbox},getMapWidth:function(){return this._mapWidth},getMapHeight:function(){return this._mapHeight},getSequenceNumber:function(){return this._sequenceNumber}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.event.WFSFeaturesSelectedEvent",function(e,t,i){this._wfsFeatureIds=e,this._addToSelection=i,this._mapLayer=t},{__name:"WFSFeaturesSelectedEvent",getName:function(){return this.__name},getWfsFeatureIds:function(){return this._wfsFeatureIds},isKeepSelection:function(){return this._addToSelection?this._addToSelection:!1},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.service.WfsTileService",function(e){this.plugin=e,this._TILE_SIZE_IN_PIXELS=256,this._componentName="WfsRequestTiler",this._mapPollingInterval=100,this._simultaneousPngRequest=4,this._wfsMapUpdateRequests={},this._WFSFeaturesSelectedEvent=null,this._tileCount=16,this._doMapLayerReArrange=!1,this.sandbox=e._sandbox,this.pngUrl=this.sandbox.getAjaxUrl()},{__qname:"Oskari.mapframework.bundle.mapwfs.service.WfsTileService",getQName:function(){return this.__qname},__name:"WfsTileService",getName:function(){return this.__name},scheduleMapLayerRearrangeAfterWfsMapTilesAreReady:function(){this._doMapLayerReArrange=!0},removeWFsLayerRequests:function(e){var t=e.getId();null!==this._wfsMapUpdateRequests[t]&&(this._wfsMapUpdateRequests[t]=null,delete this._wfsMapUpdateRequests[t])},removeWFSMapHighlightRequest:function(){this._WFSFeaturesSelectedEvent=null},scheduleWFSMapLayerUpdate:function(e,t,i,a,n){var s=e.getId(),r=this._wfsMapUpdateRequests[s];null!==r&&(this._wfsMapUpdateRequests[s]=null,delete this._wfsMapUpdateRequests[s]),this._wfsMapUpdateRequests[s]=[];var o=this.splitBbox(t,i,a,this._TILE_SIZE_IN_PIXELS);this._tileCount=o.length;for(var l=Oskari.clazz.builder("Oskari.mapframework.bundle.mapwfs.domain.WfsTileRequest"),u=0;u<o.length;u++){var c=l(e,o[u],i,a,n,u);this._wfsMapUpdateRequests[s].push(c)}this._doMapLayerReArrange=!0},scheduleWFSMapHighlightUpdate:function(e){this._WFSFeaturesSelectedEvent=e,this.processHighlightQueue()},splitBbox:function(){var e=this.sandbox.getMap(),t=[];if(e){var i=this.plugin.getTileQueue();i&&(t=i.getQueue())}return t},processMapQueue:function(){var e=this;this.sandbox.printDebug("[WfsTileService.processMapQueue] Looping this._wfsMapUpdateRequests...");for(var t in this._wfsMapUpdateRequests){var i=this._wfsMapUpdateRequests[t];if(null!==i&&i.length>0){this.sandbox.printDebug("[WfsTileService.processMapQueue] Got requestArray of size "+i.length+" for id "+t);var a=i[0];this.sandbox.printDebug("[WfsTileService.processMapQueue] Creating request for '"+a.getMapLayer().getName()+"'");var n=a.getBbox(),s=this.sandbox.getMap().getZoom(),r=this.pngUrl+"&flow_pm_wfsLayerId="+a.getMapLayer().getId()+"&flow_pm_bbox_min_x="+n.bounds.left+"&flow_pm_bbox_min_y="+n.bounds.bottom+"&flow_pm_bbox_max_x="+n.bounds.right+"&flow_pm_bbox_max_y="+n.bounds.top+"&flow_pm_map_width="+this._TILE_SIZE_IN_PIXELS+"&flow_pm_map_height="+this._TILE_SIZE_IN_PIXELS+"&flow_pm_zoom_level="+s+"&srs="+this.sandbox.getMap().getSrsName()+"&action_route=GET_PNG_MAP",o="WFS_LAYER_IMAGE_"+a.getMapLayer().getId()+"_"+a.getSequenceNumber();return e.plugin.drawImageTile(a.getMapLayer(),r,n,o),this.sandbox.printDebug("[WfsTileService.processMapQueue] removing handled element"),i.splice(0,1),0===i.length&&(delete this._wfsMapUpdateRequests[t],this.sandbox.printDebug("[WfsTileService.processMapQueue] deleting empty requestArray")),void 0}}if(this.sandbox.printDebug("[WfsTileService.processMapQueue] _doMapLayerReArrange is "+this._doMapLayerReArrange),this._doMapLayerReArrange){var l=this.sandbox.getRequestBuilder("RearrangeSelectedMapLayerRequest"),u=l();this.sandbox.request(this.plugin,u),this._doMapLayerReArrange=!1}},processHighlightQueue:function(){var e=this._WFSFeaturesSelectedEvent;if(e)try{var t=e.getMapLayer();if(!t.isLayerOfType("WFS"))throw"Trying to highlight feature from layer that is not WFS layer!";var i=e.getWfsFeatureIds();if(!i||0==i.length)return e.isKeepSelection()||this.plugin.removeHighlightOnMapLayer(t.getId()),void 0;for(var a=this.sandbox.getMap(),n=a.getBbox(),s=a.getWidth(),r=a.getHeight(),o=this,l=o.pngUrl+"&flow_pm_wfsLayerId="+t.getId()+"&flow_pm_bbox_min_x="+n.left+"&flow_pm_bbox_min_y="+n.bottom+"&flow_pm_bbox_max_x="+n.right+"&flow_pm_bbox_max_y="+n.top+"&flow_pm_map_width="+s+"&flow_pm_map_height="+r+"&action_route=GET_HIGHLIGHT_WFS_FEATURE_IMAGE",u=function(a){o.plugin.drawImageTile(t,l+"&wfsFeatureId="+a,n,"HIGHLIGHTED_FEATURE",e.isKeepSelection()||i.length>1)},c=0;c<i.length;++c)u(i[c])}finally{}},startPollers:function(){for(i=0;i<this._tileCount;i++)this.processMapQueue()}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.gridcalc.QueuedTilesGrid",function(e){this.grid=[],this.map=null,this.tileSize=null,this.maxExtent=null,this.buffer=0,this.numLoadingTiles=0;for(p in e)this[p]=e[p]},{destroy:function(){this.clearGrid(),this.grid=null,this.tileSize=null},clearGrid:function(){if(this.grid){for(var e=0,t=this.grid.length;t>e;e++)for(var i=this.grid[e],a=0,n=i.length;n>a;a++){var s=i[a];s.destroy()}this.grid=[]}},moveTo:function(e,t){if(e=e||this.map.getExtent(),null!=e){var i=!this.grid.length||t,a=this.getTilesBounds();i||!a.containsBounds(e,!0)?this.initGriddedTiles(e):this.moveGriddedTiles(e)}},setTileSize:function(){},getTilesBounds:function(){var e=null;if(this.grid.length){var t=this.grid.length-1,i=this.grid[t][0],a=this.grid[0].length-1,n=this.grid[0][a];e=new OpenLayers.Bounds(i.bounds.left,i.bounds.bottom,n.bounds.right,n.bounds.top)}return e},calculateGridLayout:function(e,t,i){var a=i*this.tileSize.w,n=i*this.tileSize.h,s=e.left-t.left,r=Math.floor(s/a)-this.buffer,o=s/a-r,l=-o*this.tileSize.w,u=t.left+r*a,c=e.top-(t.bottom+n),h=Math.ceil(c/n)+this.buffer,d=h-c/n,p=-d*this.tileSize.h,f=t.bottom+h*n;return{tilelon:a,tilelat:n,tileoffsetlon:u,tileoffsetlat:f,tileoffsetx:l,tileoffsety:p}},initGriddedTiles:function(e){var t=this.map.getSize(),i=Math.ceil(t.h/this.tileSize.h)+Math.max(1,2*this.buffer),a=Math.ceil(t.w/this.tileSize.w)+Math.max(1,2*this.buffer),n=this.maxExtent,s=this.map.getResolution(),r=this.calculateGridLayout(e,n,s),o=Math.round(r.tileoffsetx),l=Math.round(r.tileoffsety),u=r.tileoffsetlon,c=r.tileoffsetlat,h=r.tilelon,d=r.tilelat;this.origin=new OpenLayers.Pixel(o,l);var p=o,f=u,m=0,g=parseInt(this.map.layerContainerDiv.style.left),y=parseInt(this.map.layerContainerDiv.style.top);do{var v=this.grid[m++];v||(v=[],this.grid.push(v)),u=f,o=p;var b=0;do{var _=new OpenLayers.Bounds(u,c,u+h,c+d),k=o;k-=g;var L=l;L-=y;var w=new OpenLayers.Pixel(k,L),O=v[b++];O?O.moveTo(_,w,!1):(O=this.addTile(_,w),v.push(O)),u+=h,o+=this.tileSize.w}while(u<=e.right+h*this.buffer||a>b);c-=d,l+=this.tileSize.h}while(c>=e.bottom-d*this.buffer||i>m);this.removeExcessTiles(m,b)},addTile:function(e,t){return new OpenLayers.Tile(this.layer,e,t,"",this.tileSize)},moveGriddedTiles:function(){for(var e=this.buffer||1;;){var t=this.grid[0][0].position,i=this.map.getViewPortPxFromLayerPx(t);if(i.x>-this.tileSize.w*(e-1))this.shiftColumn(!0);else if(i.x<-this.tileSize.w*e)this.shiftColumn(!1);else if(i.y>-this.tileSize.h*(e-1))this.shiftRow(!0);else{if(!(i.y<-this.tileSize.h*e))break;this.shiftRow(!1)}}},shiftRow:function(e){for(var t=e?0:this.grid.length-1,i=this.grid,a=i[t],n=this.map.getResolution(),s=e?-this.tileSize.h:this.tileSize.h,r=n*-s,o=e?i.pop():i.shift(),l=0,u=a.length;u>l;l++){var c=a[l],h=c.bounds.clone(),d=c.position.clone();h.bottom=h.bottom+r,h.top=h.top+r,d.y=d.y+s,o[l].moveTo(h,d)}e?i.unshift(o):i.push(o)},shiftColumn:function(e){for(var t=e?-this.tileSize.w:this.tileSize.w,i=this.map.getResolution(),a=i*t,n=0,s=this.grid.length;s>n;n++){var r=this.grid[n],o=e?0:r.length-1,l=r[o],u=l.bounds.clone(),c=l.position.clone();u.left=u.left+a,u.right=u.right+a,c.x=c.x+t;var h=e?this.grid[n].pop():this.grid[n].shift();h.moveTo(u,c),e?r.unshift(h):r.push(h)}},removeExcessTiles:function(e,t){for(;this.grid.length>e;)for(var i=this.grid.pop(),a=0,n=i.length;n>a;a++){var s=i[a];s.destroy()}for(;this.grid[0].length>t;)for(var a=0,n=this.grid.length;n>a;a++){var i=this.grid[a],s=i.pop();s.destroy()}},onMapResize:function(){},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTilesGrid"}),Oskari.clazz.define("Oskari.mapframework.gridcalc.QueuedTilesStrategy",function(e){this.debugGridFeatures=!0,this.options=e,this.tileQueue=e.tileQueue,this.autoActivate=!0,this.autoDestroy=!1,this.grid=null,this.bounds=null;
for(p in e)this[p]=e[p];this.active=!1},{setLayer:function(e){this.layer=e},flushTileQueue:function(){for(var e=this.tileQueue.queue,t=[],i=0;i<e.length;i++)null!=e[i].tileFeature&&(t.push(e[i].tileFeature),e[i].tileFeature=null);t.length>0&&this.layer.destroyFeatures(t),this.tileQueue.flushQueue()},unloadOutOfViewFeatures:function(){},ratio:1,activate:function(){return this.active?!1:(this.active=!0,this.grid=Oskari.clazz.create("Oskari.mapframework.gridcalc.QueuedTilesGrid",{map:this.layer.map,layer:this.layer,maxExtent:this.layer.map.getMaxExtent(),tileSize:this.layer.map.getTileSize()}),this.layer.events.on({refresh:this.updateRefresh,scope:this}),!0)},deactivate:function(){return this.active?(this.layer.events.un({refresh:this.update,scope:this}),this.grid.destroy(),this.grid=null,!0):!1},updateRefresh:function(){this.update()},updateMoveEnd:function(){this.update()},update:function(){var e=this.layer.map.getExtent();this.grid.moveTo(e,!0),this.flushTileQueue();var t=this.layer.map.getZoom();t<this.minZoom||this.triggerRead()},invalidBounds:function(e){return e||(e=this.layer.map.getExtent()),!this.bounds||!this.bounds.containsBounds(e)},triggerUnload:function(){this.layer.destroyFeatures()},triggerRead:function(){for(var e=this.grid.grid,t=[],i=this.debugGridFeatures,a=0;a<e.length;a++)for(var n=0;n<e[a].length;n++){var s=e[a][n].bounds.clone(),r={left:s.left,top:s.top,right:s.right,bottom:s.bottom},o=null;if(i){var l=new OpenLayers.Geometry.Point(s.left,s.bottom),u=new OpenLayers.Geometry.Point(s.right,s.top),c=new OpenLayers.Geometry.Point(s.left,s.top),h=new OpenLayers.Geometry.Point(s.right,s.bottom),d=new OpenLayers.Geometry.LineString([l,h,u,c,l]),o=new OpenLayers.Feature.Vector(d,{featureClassName:this.CLASS_NAME,description:""});o.renderIntent="tile",t.push(o)}var p=Oskari.clazz.create("Oskari.mapframework.gridcalc.QueuedTile",{bounds:r,tileFeature:o});this.tileQueue.pushJob(p)}i&&this.layer.addFeatures(t)},merge:function(e){var t=e.features;t&&t.length>0&&this.layer.addFeatures(t)},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTilesStrategy"}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.plugin.wfslayer.WfsLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this.service=null,this.config=e},{__name:"WfsLayerPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},init:function(){var e=(this.config?this.config.sandbox:null)||"sandbox",t=Oskari.getSandbox(e),i=t.getService("Oskari.mapframework.service.MapLayerService");if(i){i.registerLayerModel("wfslayer","Oskari.mapframework.domain.WfsLayer");var a=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs.domain.WfsLayerModelBuilder",t);i.registerLayerModelBuilder("wfslayer",a)}},register:function(){this.getMapModule().setLayerPlugin("wfslayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("wfslayer",null)},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this.createTilesGrid(),this.service=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs.service.WfsTileService",this),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapMoveEvent:function(e){var t=this._sandbox.getObjectCreator(e);this._sandbox.printDebug("[WfsLayerPlugin] got AfterMapMoveEvent from "+t),this.afterAfterMapMoveEvent()},AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();t.isLayerOfType("WFS")&&this.afterMapLayerRemoveEvent(e)},AfterHighlightWFSFeatureRowEvent:function(e){this.handleAfterHighlightWFSFeatureRowEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this.afterChangeMapLayerOpacityEvent(e)},AfterDimMapLayerEvent:function(e){this.handleAfterDimMapLayerEvent(e)},MapClickedEvent:function(e){if(!this._sandbox.getMap().isMoving()){var t=e.getLonLat(),i=e.getMouseX(),a=e.getMouseY();this._getFeatureIds(t,i,a)}},WFSFeaturesSelectedEvent:function(e){this.service.scheduleWFSMapHighlightUpdate(e)},MapLayerVisibilityChangedEvent:function(e){e.getMapLayer().isVisible()&&this.afterAfterMapMoveEvent()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var a=e[i],n=a.getId();a.isLayerOfType("WFS")&&(t.printDebug("[WfsLayerPlugin] preselecting "+n),this.addMapLayerToMap(a,!0,a.isBaseLayer()))}},afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WFS"))for(var i=this.getOLMapLayers(t),a=0;a<i.length;a++)i[a].setOpacity(t.getOpacity()/100)},handleAfterDimMapLayerEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WFS"))for(var i=new RegExp("wfs_layer_"+t.getId()+"_HIGHLIGHTED_FEATURE*","i"),a=this._map.getLayersByName(i),n=0;n<a.length;n++)a[n].destroy()},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap()),this.afterAfterMapMoveEvent()},addMapLayerToMap:function(){},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.service.removeWFsLayerRequests(t),this.removeMapLayerFromMap(t)},removeMapLayerFromMap:function(e){for(var t=this.getOLMapLayers(e),i=0;i<t.length;i++)t[i].destroy()},getOLMapLayers:function(e){if(!e||e.isLayerOfType("WFS")){var t="";e&&(t="_"+e.getId());var i=new RegExp("wfs_layer"+t+"_*","i");return this._map.getLayersByName(i)}},drawImageTile:function(e,t,i,a,n){var s="wfs_layer_"+e.getId()+"_"+a,r=null;if(i.bounds&&i.bounds.left&&i.bounds.right&&i.bounds.top&&i.bounds.bottom?r=new OpenLayers.Bounds(i.bounds.left,i.bounds.bottom,i.bounds.right,i.bounds.top):i.left&&i.right&&i.top&&i.bottom&&(r=new OpenLayers.Bounds(i.left,i.bottom,i.right,i.top)),t&&e&&r){var o=this.mapModule.calculateLayerScales(e.getMaxScale(),e.getMinScale()),l=null;if(!n)for(var u=this._map.getLayersByName(s),c=0;c<u.length;c++)l=this._map.getLayerIndex(u[c]),u[c].destroy();var h=new OpenLayers.Size(256,256),d=new OpenLayers.Layer.Image(s,t,r,h,{scales:o,transparent:!0,format:"image/png",isBaseLayer:!1,displayInLayerSwitcher:!0,visibility:!0,buffer:0});d.opacity=e.getOpacity()/100,this._map.addLayer(d),d.setVisibility(!0),d.redraw(!0);var p=this._map.layers.length,f=this._map.getLayersByName("Markers");f.length>0&&(this._map.setLayerIndex(f[0],p),p--),null!==l&&null!==d&&this._map.setLayerIndex(d,l);var m=new RegExp("wfs_layer_"+e.getId()+"_WFS_LAYER_IMAGE*","i"),g=this._map.getLayersByName(m);if(g.length>0){var y=this._map.getLayerIndex(g[g.length-1]),v=this._map.getLayersByName(s);v.length>0&&this._map.setLayerIndex(v[0],y)}}},handleAfterHighlightWFSFeatureRowEvent:function(e){var t=e.getWfsFeatureIds();if(0==t.length&&!e.isKeepSelection()){var i=e.getMapLayer();this.removeHighlightOnMapLayer(i.getId())}},removeHighlightOnMapLayer:function(e){var t="";e&&(t="wfs_layer_"+e);for(var i=new RegExp(t+"_HIGHLIGHTED_FEATURE*","i"),a=this._map.getLayersByName(i),n=0;n<a.length;n++)a[n].destroy()},updateWfsImages:function(){for(var e=Oskari.$().sandbox.findAllSelectedMapLayers(),t=0;t<e.length;t++)e[t].isInScale()&&e[t].isVisible()&&e[t].isLayerOfType("WFS")&&this.doWfsLayerRelatedQueries(e[t])},doWfsLayerRelatedQueries:function(e){if(e.isInScale()){var t=this._sandbox.getMap(),i=t.getBbox(),a=t.getWidth(),n=t.getHeight();this.service.scheduleWFSMapLayerUpdate(e,i,a,n,this.getName()),this.service.startPollers()}},afterAfterMapMoveEvent:function(){this.tileStrategy.update(),this._tilesLayer.redraw(),this.updateWfsImages(this.getName()),this.service.processHighlightQueue()},createTilesGrid:function(){var e=this;e._sandbox;var t=Oskari.clazz.create("Oskari.mapframework.gridcalc.TileQueue"),i=Oskari.clazz.create("Oskari.mapframework.gridcalc.QueuedTilesStrategy",{tileQueue:t});i.debugGridFeatures=!1,this.tileQueue=t,this.tileStrategy=i;var a=new OpenLayers.StyleMap({"default":new OpenLayers.Style({pointRadius:3,strokeColor:"red",strokeWidth:2,fillColor:"#800000"}),tile:new OpenLayers.Style({strokeColor:"#008080",strokeWidth:5,fillColor:"#ffcc66",fillOpacity:.5}),select:new OpenLayers.Style({fillColor:"#66ccff",strokeColor:"#3399ff"})});this._tilesLayer=new OpenLayers.Layer.Vector("Tiles Layer",{strategies:[i],styleMap:a,visibility:!0}),this._map.addLayer(this._tilesLayer),this._tilesLayer.setOpacity(.3)},getTileQueue:function(){return this.tileQueue},_getFeatureIds:function(e){var t=this,i=this._sandbox,a=i.findAllHighlightedLayers();if(0!=a.length&&a[0]&&a[0].isLayerOfType("WFS")){if(1!=a.length)return i.printDebug("Trying to highlight WFS feature but there is either too many or none selected WFS layers. Size: "+a.length),void 0;var n=a[0];if(!n.isInScale())return i.printDebug("Trying to hightlight WFS feature from wfs layer that is not in scale!"),void 0;var s=i.getMap(),r=this._map.getExtent(),o="&flow_pm_wfsLayerId="+n.getId()+"&flow_pm_point_x="+e.lon+"&flow_pm_point_y="+e.lat+"&flow_pm_bbox_min_x="+r.left+"&flow_pm_bbox_min_y="+r.bottom+"&flow_pm_bbox_max_x="+r.right+"&flow_pm_bbox_max_y="+r.top+"&flow_pm_zoom_level="+s.getZoom()+"&flow_pm_map_width="+s.getWidth()+"&flow_pm_map_height="+s.getHeight()+"&srs="+s.getSrsName()+"&action_route=GET_HIGHLIGHT_WFS_FEATURE_IMAGE_BY_POINT",l=i.isCtrlKeyDown();jQuery.ajax({dataType:"json",type:"POST",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:i.getAjaxUrl()+o,data:o,success:function(e){t._handleGetFeatureIdsResponse(e,n,l)}})}},_handleGetFeatureIdsResponse:function(response,layer,keepCollection){var sandbox=this._sandbox;if(!response||"true"==response.error)return sandbox.printWarn("Couldn't get feature id for selected map point."),void 0;var selectedFeatures=eval("("+response.selectedFeatures+")"),featureIds=[];null!=selectedFeatures&&null!=selectedFeatures.id&&featureIds.push(selectedFeatures.id);var builder=sandbox.getEventBuilder("WFSFeaturesSelectedEvent"),event=builder(featureIds,layer,keepCollection);sandbox.notifyAll(event)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.MapWfsBundleInstance",function(){this._localization=null,this._pluginInstances={}},{__name:"MapWFS",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p)}},update:function(){},stop:function(){var e=this.sandbox;for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);this.sandbox.unregister(this),this.started=!1},init:function(){return null},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{MapClickedEvent:function(e){if(!this.sandbox.getMap().isMoving()){var t=e.getLonLat(),i=e.getMouseX(),a=e.getMouseY();this._getFeatureIds(t,i,a)}}},_getFeatureIds:function(e){var t=this,i=this.sandbox,a=i.findAllHighlightedLayers();if(0!=a.length&&a[0]&&a[0].isLayerOfType("WFS")){if(1!=a.length)throw"Trying to highlight WFS feature but there is either too many or none selected WFS layers. Size: "+a.length;var n=a[0];if(!n.isInScale())return core.printDebug("Trying to hightlight WFS feature from wfs layer that is not in scale!"),void 0;var s=i.getMap(),r=this._map.getExtent(),o="&flow_pm_wfsLayerId="+n.getId()+"&flow_pm_point_x="+e.lon+"&flow_pm_point_y="+e.lat+"&flow_pm_bbox_min_x="+r.left+"&flow_pm_bbox_min_y="+r.bottom+"&flow_pm_bbox_max_x="+r.right+"&flow_pm_bbox_max_y="+r.top+"&flow_pm_zoom_level="+s.getZoom()+"&flow_pm_map_width="+s.getWidth()+"&flow_pm_map_height="+s.getHeight()+"&srs="+s.getSrsName()+"&actionKey=GET_HIGHLIGHT_WFS_FEATURE_IMAGE_BY_POINT",l=i.isCtrlKeyDown();jQuery.ajax({dataType:"json",type:"POST",url:this.endpointUrl+o,data:o,success:function(e){t._handleGetFeatureIdsResponse(e,n,l)}})}},_handleGetFeatureIdsResponse:function(response,layer,keepCollection){var sandbox=this.sandbox;"true"==response.error&&sandbox.printWarn("Couldn't get feature id for selected map point.");var selectedFeatures=eval("("+response.selectedFeatures+")"),featureIds=[];null!=selectedFeatures&&null!=selectedFeatures.id&&(featureIds=selectedFeatures.id);var builder=sandbox.getEventBuilder("WFSFeaturesSelectedEvent"),event=builder(featureIds,layer,keepCollection);sandbox.notifyAll(event)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.MapStatsBundle",function(){},{create:function(){return null},update:function(e,t,i,a){e.alert("RECEIVED update notification "+a)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/plugin/StatsLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/domain/StatsLayer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/domain/StatsLayerModelBuilder.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/event/StatsVisualizationChangeEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/event/FeatureHighlightedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/event/HoverTooltipContentEvent.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapstats/css/mapstats.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"mapstats","Bundle-Name":"mapstats","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"Stats",Title:"Stats"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"]}}}),Oskari.bundle_manager.installBundleClass("mapstats","Oskari.mapframework.bundle.mapstats.MapStatsBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.plugin.StatsLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this._statsDrawLayer=null,this._highlightCtrl=null,this._navCtrl=null,this._getFeatureControlHover=null,this._getFeatureControlSelect=null,this._modeVisible=!1,this.config=e,this.ajaxUrl=null,e&&e.ajaxUrl&&(this.ajaxUrl=e.ajaxUrl),e&&e.published&&(this._modeVisible=e.published)},{__name:"StatsLayerPlugin",_layerType:"STATS",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("statslayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("statslayer",null)},init:function(e){var t=(this.config?this.config.sandbox:null)||"sandbox",e=Oskari.getSandbox(t),i=e.getService("Oskari.mapframework.service.MapLayerService");if(i){i.registerLayerModel("statslayer","Oskari.mapframework.bundle.mapstats.domain.StatsLayer");var a=Oskari.clazz.create("Oskari.mapframework.bundle.mapstats.domain.StatsLayerModelBuilder",e);i.registerLayerModelBuilder("statslayer",a)}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.ajaxUrl||(this.ajaxUrl=e.getAjaxUrl()+"action_route=GetStatsTile")},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this._afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)},MapLayerVisibilityChangedEvent:function(e){this._mapLayerVisibilityChangedEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this._afterChangeMapLayerOpacityEvent(e)},AfterChangeMapLayerStyleEvent:function(){},"MapStats.StatsVisualizationChangeEvent":function(e){this._afterStatsVisualizationChangeEvent(e)},"StatsGrid.ModeChangedEvent":function(e){this._afterModeChangedEvent(e)},"StatsGrid.SelectHilightsModeEvent":function(e){this._hilightFeatures(e)},"StatsGrid.ClearHilightsEvent":function(e){this._clearHilights(e)},"MapStats.HoverTooltipContentEvent":function(e){this._afterHoverTooltipContentEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var a=e[i],n=a.getId();a.isLayerOfType(this._layerType)&&(t.printDebug("preselecting "+n),this._addMapLayerToMap(a,!0,a.isBaseLayer()))}},activateControls:function(){this._getFeatureControlHover.activate(),this._getFeatureControlSelect.activate()},deactivateControls:function(){this._getFeatureControlHover.deactivate(),this._getFeatureControlSelect.deactivate()},_afterMapLayerAddEvent:function(e){this._addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},_addMapLayerToMap:function(e,t){var i,a=this,n=a._sandbox.getEventBuilder("MapStats.FeatureHighlightedEvent");if(e.isLayerOfType(this._layerType)){var s=this._map.getLayersByName("Markers");if(s)for(var r=0;r<s.length;r++)s[r]&&this._map.removeLayer(s[r],!1);var o=this.getMapModule().calculateLayerScales(e.getMaxScale(),e.getMinScale()),l=new OpenLayers.Layer.WMS("layer_"+e.getId(),this.ajaxUrl+"&LAYERID="+e.getId(),{layers:e.getWmsName(),transparent:!0,format:"image/png"},{scales:o,isBaseLayer:!1,displayInLayerSwitcher:!1,visibility:!0,singleTile:!0,buffer:0});this._statsDrawLayer=new OpenLayers.Layer.Vector("Stats Draw Layer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillOpacity:0,strokeOpacity:0}),temporary:new OpenLayers.Style({strokeColor:"#ff6666",strokeOpacity:1,strokeWidth:3,fillColor:"#ff0000",fillOpacity:0,graphicZIndex:2,cursor:"pointer"}),select:new OpenLayers.Style({})})}),this._map.addLayers([this._statsDrawLayer]),this._statsDrawLayer.events.register("moveend",this._statsDrawLayer,function(){a.mapModule.notifyMoveEnd()}),this._highlightCtrl=new OpenLayers.Control.SelectFeature(this._statsDrawLayer,{hover:!0,highlightOnly:!0,renderIntent:"temporary"}),this._map.addControl(this._highlightCtrl),this._highlightCtrl.activate(),this._navCtrl=new OpenLayers.Control.Navigation,this._map.addControl(this._navCtrl);var u=[l];if(this._getFeatureControlHover=new OpenLayers.Control.WMSGetFeatureInfo({drillDown:!1,hover:!0,handlerOptions:{hover:{delay:0},stopSingle:!1},infoFormat:"application/vnd.ogc.gml",layers:u,eventListeners:{getfeatureinfo:function(e){var t=a._map.getLayersByName("Stats Draw Layer")[0];if("undefined"!=typeof t){if(0===e.features.length){for(var i=0;i<t.features.length;i++)t.features[i].selected||t.removeFeatures([t.features[i]]);return a._removePopup(),void 0}for(var n=!1,s="kuntakoodi",i=0;i<t.features.length;i++)t.features[i].attributes[s]===e.features[0].attributes[s]?n=!0:t.features[i].selected||t.removeFeatures([t.features[i]]);n||(t.addFeatures([e.features[0]]),a._highlightCtrl.highlight(e.features[0]),a._removePopup(),a._addPopup(e)),t.redraw()}},beforegetfeatureinfo:function(){},nogetfeatureinfo:function(){}}}),this._map.addControl(this._getFeatureControlHover),this._modeVisible&&this._getFeatureControlHover.activate(),this._getFeatureControlSelect=new OpenLayers.Control.WMSGetFeatureInfo({drillDown:!0,hover:!1,handlerOptions:{click:{delay:0},pixelTolerance:5},infoFormat:"application/vnd.ogc.gml",layers:u,eventListeners:{getfeatureinfo:function(e){if(0!==e.features.length){var t=e.features[0],s=a._map.getLayersByName("Stats Draw Layer")[0];if("undefined"!=typeof s){for(var r=-1,o="kuntakoodi",l=0;l<s.features.length;l++)if(s.features[l].attributes[o]===e.features[0].attributes[o]){r=l;break}var u=OpenLayers.Util.applyDefaults(u,OpenLayers.Feature.Vector.style["default"]);u.fillColor="#ff0000",u.strokeColor="#ff3333",u.strokeWidth=3,u.fillOpacity=.2,r>=0?(s.features[l].selected=!s.features[l].selected,s.features[l].selected?s.features[l].style=u:(s.features[l].style=null,a._highlightCtrl.highlight(s.features[l])),n&&(i=n(s.features[l],s.features[l].selected,"click"))):(s.addFeatures([t]),t.selected=!0,t.style=u,n&&(i=n(t,t.selected,"click"))),s.redraw(),i&&a._sandbox.notifyAll(i)}}},beforegetfeatureinfo:function(){},nogetfeatureinfo:function(){}}}),this._map.addControl(this._getFeatureControlSelect),this._modeVisible&&this._getFeatureControlSelect.activate(),l.opacity=e.getOpacity()/100,this._map.addLayer(l),this._sandbox.printDebug("#!#! CREATED OPENLAYER.LAYER.WMS for StatsLayer "+e.getId()),t?this._map.setLayerIndex(l,this._map.layers.length):this._map.setLayerIndex(l,0),s)for(var r=0;r<s.length;r++)s[r]&&this._map.addLayer(s[r])}},_afterModeChangedEvent:function(e){this._modeVisible=e.isModeVisible();var t=this._map.getLayersByName("Stats Draw Layer")[0];this._modeVisible?this.activateControls():(this.deactivateControls(),t&&t.removeAllFeatures(),this._removePopup())},_clearHilights:function(){var e=this._map.getLayersByName("Stats Draw Layer")[0];if(e)for(var t=0;t<e.features.length;t++)e.features[t].style=null,this._highlightCtrl.highlight(e.features[t]);e.redraw(),this._removePopup()},_hilightFeatures:function(e){var t=e.getCodes(),i=this._map.getLayersByName("Stats Draw Layer")[0];if("undefined"!=typeof i){var a="kuntakoodi",n=OpenLayers.Util.applyDefaults(n,OpenLayers.Feature.Vector.style["default"]);n.fillColor="#ff0000",n.strokeColor="#ff3333",n.strokeWidth=3,n.fillOpacity=.2;for(var s in t)for(var r=0;r<i.features.length;r++)if(i.features[r].attributes[a]===s&&t[s]){i.features[r].style=n,this._highlightCtrl.highlight(i.features[r]);break}i.redraw()}},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();t.isLayerOfType(this._layerType)&&(this._removeMapLayerFromMap(t),this._highlightCtrl.deactivate(),this._getFeatureControlHover.deactivate(),this._getFeatureControlSelect.deactivate(),this._map.removeControl(this._highlightCtrl),this._map.removeControl(this._navCtrl),this._map.removeControl(this._getFeatureControlHover),this._map.removeControl(this._getFeatureControlSelect),this._map.removeLayer(this._statsDrawLayer))},_mapLayerVisibilityChangedEvent:function(e){var t=e.getMapLayer();"STATS"===t._layerType&&(this._statsDrawLayer.setVisibility(t.isVisible()),this._modeVisible&&(t.isVisible()?(this._getFeatureControlHover.activate(),this._getFeatureControlSelect.activate()):(this._getFeatureControlHover.deactivate(),this._getFeatureControlSelect.deactivate())))},_removeMapLayerFromMap:function(e){if(e.isLayerOfType(this._layerType)){var t=this.getOLMapLayers(e);t[0].destroy()}},getOLMapLayers:function(e){return e.isLayerOfType(this._layerType)?this._map.getLayersByName("layer_"+e.getId()):null},_removePopup:function(e){e=e||this._popup,e&&this._map.removePopup(e)},_addPopup:function(e){var t=e.features[0].attributes.kuntanimi;this._popup=new OpenLayers.Popup("mapstatsHover",this._map.getLonLatFromPixel(new OpenLayers.Pixel(e.xy.x+5,e.xy.y+5)),new OpenLayers.Size(100,100),t),this._popup.autoSize=!0,this._popup.opacity=.8,this._map.addPopup(this._popup);var i=this._sandbox.getRequestBuilder("StatsGrid.TooltipContentRequest");if(i){var a=i(e.features[0]);this._sandbox.request(this,a)}},_afterHoverTooltipContentEvent:function(e){var t=e.getContent();this._popup&&this._popup.setContentHTML(t)},_afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType(this._layerType)){this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var i=this.getOLMapLayers(t);null!=i[0]&&i[0].setOpacity(t.getOpacity()/100)}},_afterChangeMapLayerStyleEvent:function(e){var t=e.getMapLayer(),i=this.getOLMapLayers(t);null!=i&&i[0].mergeNewParams({VIS_ID:t.getCurrentStyle().getName(),VIS_NAME:"ows:Kunnat2013",VIS_ATTR:"Kuntakoodi",VIS_CLASSES:"020,091|186,086,982|111,139,740",VIS_COLORS:"choro:ccffcc|99cc99|669966"})},_afterStatsVisualizationChangeEvent:function(e){var t=e.getLayer(),i=e.getParams(),a=this.getOLMapLayers(t);null!=a&&a[0].mergeNewParams({VIS_ID:i.VIS_ID,VIS_NAME:i.VIS_NAME,VIS_ATTR:i.VIS_ATTR,VIS_CLASSES:i.VIS_CLASSES,VIS_COLORS:i.VIS_COLORS})}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.domain.StatsLayer",function(){this._layerType="STATS"},{setWmsName:function(e){this._wmsName=e},getWmsName:function(){return this._wmsName},setFilterPropertyName:function(e){this._filterPropertyName=e},getFilterPropertyName:function(){return this._filterPropertyName}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.domain.StatsLayerModelBuilder",function(e){this.localization=Oskari.getLocalization("MapStats"),this.sandbox=e},{parseLayerData:function(e,t){var i=this;e.setWmsName(t.wmsName),t.visualizations&&e.setFilterPropertyName(t.visualizations[0].filterproperty);var a=Oskari.clazz.builder("Oskari.mapframework.domain.Tool"),n=a(),s=i.localization.tools.table_icon;if(n.setName("table_icon"),n.setTitle(s.title),n.setTooltip(s.tooltip),n.setCallback(function(){i.sandbox.postRequestByName("StatsGrid.StatsGridRequest",[!0,e])}),e.addTool(n),e.getMetadataIdentifier()){var r=a();r.setName("info_icon"),r.setIconCls("icon-info"),r.setCallback(function(){var t="catalogue.ShowMetadataRequest",a=e.getMetadataIdentifier(),n=[],s={};s[a]=!0;var r=e.getSubLayers();if(r&&r.length>0)for(var o=0;o<r.length;o++){var l=r[o].getMetadataIdentifier();l&&""!=l&&!s[l]&&(s[l]=!0,n.push({uuid:l}))}i.sandbox.postRequestByName(t,[{uuid:a},n])})}e.addTool(r)}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.event.StatsVisualizationChangeEvent",function(e,t){this._layer=e,this._params=t},{getName:function(){return"MapStats.StatsVisualizationChangeEvent"},getLayer:function(){return this._layer},getParams:function(){return this._params}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.event.FeatureHighlightedEvent",function(e,t,i){this._feature=e,this._highlighted=t,this._highlightType=i},{getName:function(){return"MapStats.FeatureHighlightedEvent"},getFeature:function(){return this._feature},isHighlighted:function(){return this._highlighted},getHighlighType:function(){return this._highlightType}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.event.HoverTooltipContentEvent",function(e){this._content=e},{getName:function(){return"MapStats.HoverTooltipContentEvent"},getContent:function(){return this._content}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.service.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/service/service.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"service-base","Bundle-Name":"mapframework.service.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.service.Bundle",Title:" mapframework.service.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("service-base","Oskari.mapframework.service.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.service.Service",function(){throw"mapframework.service.Service should not be used"},{getName:function(){throw"Running default implementation of Service.getName(). implement your own!"}}),Oskari.clazz.define("Oskari.mapframework.event.map.layer.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/event/common/after-rearrange-selected-map-layer-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-change-map-layer-opacity-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-change-map-layer-style-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-highlight-map-layer-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-dim-map-layer-event.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"event-map-layer","Bundle-Name":"mapframework.event.map.layer.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.event.Bundle",Title:" mapframework.event.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("event-map-layer","Oskari.mapframework.event.map.layer.Bundle"),Oskari.clazz.define("Oskari.mapframework.event.common.AfterRearrangeSelectedMapLayerEvent",function(e,t,i){this._creator=null,this._movedMapLayer=e,this._fromPosition=t,this._toPosition=i},{__name:"AfterRearrangeSelectedMapLayerEvent",getName:function(){return this.__name},getMovedMapLayer:function(){return this._movedMapLayer},getFromPosition:function(){return this._fromPosition},getToPosition:function(){return this._toPosition}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterChangeMapLayerOpacityEvent",function(e){this._mapLayer=e},{__name:"AfterChangeMapLayerOpacityEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterChangeMapLayerStyleEvent",function(e){this._mapLayer=e},{__name:"AfterChangeMapLayerStyleEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterHighlightMapLayerEvent",function(e){this._creator=null,this._mapLayer=e},{__name:"AfterHighlightMapLayerEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterDimMapLayerEvent",function(e){this._creator=null,this._mapLayer=e},{__name:"AfterDimMapLayerEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.request.map.layer.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/request/common/rearrange-selected-map-layer-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/change-map-layer-opacity-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/change-map-layer-style-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/highlight-map-layer-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/dim-map-layer-request.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"request-map-layer","Bundle-Name":"mapframework.request.map.layer.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.request.Bundle",Title:" mapframework.request.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("request-map-layer","Oskari.mapframework.request.map.layer.Bundle"),Oskari.clazz.define("Oskari.mapframework.request.common.RearrangeSelectedMapLayerRequest",function(e,t){this._mapLayerId=e,this._toPosition=t
},{__name:"RearrangeSelectedMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId},getToPosition:function(){return this._toPosition}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.ChangeMapLayerOpacityRequest",function(e,t){this._creator=null,this._mapLayerId=e,this._opacity=t},{__name:"ChangeMapLayerOpacityRequest",getName:function(){return this.__name},getOpacity:function(){return this._opacity},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.ChangeMapLayerStyleRequest",function(e,t){this._creator=null,this._mapLayerId=e,this._style=t},{__name:"ChangeMapLayerStyleRequest",getName:function(){return this.__name},getStyle:function(){return this._style},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.HighlightMapLayerRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"HighlightMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.DimMapLayerRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"DimMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.PluginMapModuleBundle",function(){},{create:function(){return this},update:function(e,t,i,a){e.alert("RECEIVED update notification "+a)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/ui/module/map-module.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/Plugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/ControlsPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/PorttiKeyboard.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/PorttiMouse.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/DisableMapKeyboardMovementRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/DisableMapMouseMovementRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/EnableMapKeyboardMovementRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/EnableMapMouseMovementRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapMovementControlsRequestHandler.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/show-map-measurement-request.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/getinfo/GetFeatureInfoHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/GetFeatureInfoRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/GetFeatureInfoActivationRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/getinfo/GetInfoPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/getinfo/css/getinfo.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/markers/MarkersPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/RemoveMarkerRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MarkerRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/search/SearchPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/service/searchservice.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/search/css/search.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/logo/LogoPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/logo/css/logoplugin.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/datasource/DataSourcePlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/datasource/css/datasource.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/indexmap/IndexMapPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/indexmap/css/indexmap.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/scalebar/ScaleBarPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/fullscreen/FullScreen.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/fullscreen/css/fullscreen.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/layers/LayerSelectionPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/layers/css/layersselection.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/layers/LayersPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapLayerVisibilityRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapLayerVisibilityRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapMoveByLayerContentRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapMoveByLayerContentRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/MapLayerVisibilityChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/wmslayer/WmsLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/vectorlayer/VectorLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/location/GeoLocationPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/ToolSelectionRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/ToolSelectionHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapLayerUpdateRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapLayerUpdateRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapMoveRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/MapClickedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/EscPressedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/GetInfoResultEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/MapSizeChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/ClearHistoryRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/ClearHistoryHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/zoombar/Portti2Zoombar.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/portti2zoombar/css/porttizoombar.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/panbuttons/PanButtons.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/panbuttons/css/panbuttons.css"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/css/mapmodule.css"}],locales:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/fi.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/sv.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"mapmodule-plugin","Bundle-Name":"mapmodule","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"Kartta",Title:"Kartta"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","Ext","OpenLayers"]}}}),Oskari.bundle_manager.installBundleClass("mapmodule-plugin","Oskari.mapframework.bundle.PluginMapModuleBundle"),Oskari.clazz.define("Oskari.mapframework.ui.module.common.MapModule",function(e,t,i){if(this._id=e,this._imageUrl=t,this._options={resolutions:[2e3,1e3,500,200,100,50,20,10,4,2,1,.5,.25],srsName:"EPSG:3067",units:"m"},i)for(var a in i)this._options[a]=i[a];this._controls={},this._layerPlugins={},this._supportedFormats={},this._map=null,this._mapScales=[],this._sandbox=null,this._stealth=!1,this._pluginInstances={},this._navigationHistoryTool=new OpenLayers.Control.NavigationHistory,this._navigationHistoryTool.id="navigationhistory",this._localization=null},{getImageUrl:function(){return this._imageUrl?this._imageUrl:"/Oskari/resources"},getControls:function(){return this._controls},getMapControl:function(e){return this._controls[e]},addMapControl:function(e,t){this._controls[e]=t,this._map.addControl(t)},removeMapControl:function(e){this._map.removeControl(this._controls[e]),this._controls[e]=null,delete this._controls[e]},setLayerPlugin:function(e,t){this._layerPlugins[e]=t},getLayerPlugin:function(e){return this._layerPlugins[e]},getLayerPlugins:function(){return this._layerPlugins},clearNavigationHistory:function(){this._navigationHistoryTool.clear()},getName:function(){return this._id+"MapModule"},getSandbox:function(){return this._sandbox},getLocalization:function(e,t){return this._localization&&t!==!0||(this._localization=Oskari.getLocalization("MapModule")),e?this._localization[e]:this._localization},init:function(e){e.printDebug("Initializing map module...#############################################"),this._sandbox=e,this._sandbox&&this._sandbox.getMap().setSrsName(this._options.srsName);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.requestHandlers={mapLayerUpdateHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapLayerUpdateRequestHandler",e,this),mapMoveRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapMoveRequestHandler",e,this),clearHistoryHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.controls.ClearHistoryHandler",e,this)},e.addRequestHandler("MapModulePlugin.MapLayerUpdateRequest",this.requestHandlers.mapLayerUpdateHandler),e.addRequestHandler("MapMoveRequest",this.requestHandlers.mapMoveRequestHandler),e.addRequestHandler("ClearHistoryRequest",this.requestHandlers.clearHistoryHandler),this._createMap();for(var t=0;t<this._options.resolutions.length;++t){var i=OpenLayers.Util.getScaleFromResolution(this._options.resolutions[t],this._map.units);i=1e8*i,i=Math.round(i),i/=1e8,this._mapScales.push(i)}return this._createBaseLayer(),this.addMapControl("navigationHistoryTool",this._navigationHistoryTool),this.getMapControl("navigationHistoryTool").activate(),this._map},getPluginInstances:function(){return this._pluginInstances},getPluginInstance:function(e){return this._pluginInstances[this.getName()+e]},isPluginActivated:function(e){var t=this._pluginInstances[this.getName()+e];return t?!0:!1},registerPlugin:function(e){var t=this._sandbox;e.setMapModule(this);var i=e.getName();t.printDebug("["+this.getName()+"]"+" Registering "+i),e.register(),this._pluginInstances[i]=e},unregisterPlugin:function(e){var t=this._sandbox,i=e.getName();t.printDebug("["+this.getName()+"]"+" Unregistering "+i),e.unregister(),this._pluginInstances[i]=void 0,e.setMapModule(null),delete this._pluginInstances[i]},startPlugin:function(e){var t=this._sandbox,i=e.getName();t.printDebug("["+this.getName()+"]"+" Starting "+i),e.startPlugin(t)},stopPlugin:function(e){var t=this._sandbox,i=e.getName();t.printDebug("["+this.getName()+"]"+" Starting "+i),e.stopPlugin(t)},startPlugins:function(e){for(var t in this._pluginInstances)e.printDebug("["+this.getName()+"]"+" Starting "+t),this._pluginInstances[t].startPlugin(e)},stopPlugins:function(e){for(var t in this._pluginInstances)e.printDebug("["+this.getName()+"]"+" Starting "+t),this._pluginInstances[t].stopPlugin(e)},getStealth:function(){return this._stealth},setStealth:function(e){this._stealth=1==e},notifyAll:function(e,t){this._stealth||this._sandbox.notifyAll(e,t)},getMap:function(){return this._map},getMapViewPortDiv:function(){return this._map.viewPortDiv},getMapLayersContainerDiv:function(){return this._map.layerContainerDiv},transformCoordinates:function(e,t){return e.transform(new OpenLayers.Projection(t),this.getMap().getProjectionObject())},_createMap:function(){this._sandbox;var e=new OpenLayers.LonLat(0,0),t=new OpenLayers.Bounds(0,0,1e7,1e7);return null!=this._options&&null!=this._options.maxExtent&&null!=this._options.maxExtent.left&&null!=this._options.maxExtent.bottom&&null!=this._options.maxExtent.right&&null!=this._options.maxExtent.top&&(t=new OpenLayers.Bounds(this._options.maxExtent.left,this._options.maxExtent.bottom,this._options.maxExtent.right,this._options.maxExtent.top)),this._map=new OpenLayers.Map({controls:[],units:this._options.units,maxExtent:t,resolutions:this._options.resolutions,projection:this._options.srsName,isBaseLayer:!0,center:e,theme:null,zoom:0}),this._map},getProjection:function(){return this._options.srsName},_createBaseLayer:function(){var e=new OpenLayers.Layer("BaseLayer",{layerId:0,isBaseLayer:!0,displayInLayerSwitcher:!1});this._map.addLayer(e)},moveMapToLanLot:function(e,t,i){var a=i===!0;this._map.setCenter(e,this._map.getZoom(),a),t&&this.adjustZoomLevel(t,!0),this._updateDomain()},panMapToLonLat:function(e,t){this._map.setCenter(e,this._map.getZoom()),this._updateDomain(),t!==!0&&this.notifyMoveEnd()},zoomToScale:function(e,t,i){var a=t===!0;this._map.zoomToScale(e,a),this._updateDomain(),i!==!0&&this.notifyMoveEnd()},centerMap:function(e,t,i){this._map.setCenter(e,t,!1),this._updateDomain(),i!==!0&&this.notifyMoveEnd()},zoomIn:function(){this.adjustZoomLevel(1)},zoomOut:function(){this.adjustZoomLevel(-1)},zoomTo:function(e){this.setZoomLevel(e,!1)},panMapEast:function(){var e=this._map.getSize();this.panMapByPixels(.75*e.w,0)},panMapWest:function(){var e=this._map.getSize();this.panMapByPixels(-.75*e.w,0)},panMapNorth:function(){var e=this._map.getSize();this.panMapByPixels(0,-.75*e.h)},panMapSouth:function(){var e=this._map.getSize();this.panMapByPixels(0,.75*e.h)},panMapByPixels:function(e,t,i,a,n){this._map.pan(e,t,{dragging:n?!0:!1,animate:!1}),this._updateDomain(),i!==!0&&this.notifyStartMove(),a!==!0&&this.notifyMoveEnd()},moveMapByPixels:function(e,t,i,a){this._map.moveByPx(e,t),this._updateDomain(),i!==!0&&this.notifyStartMove(),a!==!0&&this.notifyMoveEnd()},centerMapByPixels:function(e,t,i,a){var n=new OpenLayers.Pixel(e,t),s=this._map.getLonLatFromViewPortPx(n);this.isValidLonLat(s.lon,s.lat)&&(this.moveMapToLanLot(s),i!==!0&&this.notifyStartMove(),a!==!0&&this.notifyMoveEnd())},isValidLonLat:function(e,t){var i=!0;return 625e4>t||t>82e5?i=!1:((0>e||e>135e4)&&(i=!1),i)},zoomToExtent:function(e,t,i){this._map.zoomToExtent(e),this._updateDomain(),t!==!0&&this.notifyStartMove(),i!==!0&&this.notifyMoveEnd()},adjustZoomLevel:function(e,t){var i=this._getNewZoomLevel(e);this._map.zoomTo(i),this._updateDomain(),t!==!0&&this.notifyMoveEnd()},setZoomLevel:function(e,t){e!=this._map.getZoom()&&((0>e||e>this._map.getNumZoomLevels)&&(e=this._map.getZoom()),this._map.zoomTo(e),this._updateDomain(),t!==!0&&this.notifyMoveEnd())},_getNewZoomLevel:function(e){var t=this._map.getZoom()+e;return t>=0&&t<=this._map.getNumZoomLevels()?t:this._map.getZoom()},notifyStartMove:function(){if(!this.getStealth()){this._sandbox.getMap().setMoving(!0);var e=this._map.getCenter().lon,t=this._map.getCenter().lat,i=this._sandbox.getEventBuilder("MapMoveStartEvent")(e,t);this._sandbox.notifyAll(i)}},notifyMoveEnd:function(){if(!this.getStealth()){var e=this._sandbox;e.getMap().setMoving(!1);var t=this._map.getCenter();this._updateDomain();var i=e.getEventBuilder("AfterMapMoveEvent")(t.lon,t.lat,this._map.getZoom(),!1,this._map.getScale());e.notifyAll(i)}},updateSize:function(){this.getMap().updateSize(),this._updateDomain();var e=this._sandbox,t=e.getMap(),i=e.getEventBuilder("MapSizeChangedEvent")(t.getWidth(),t.getHeight());e.notifyAll(i)},_updateDomain:function(){if(!this.getStealth()){var e=this._sandbox,t=e.getMap(),i=this._map.getCenter();t.moveTo(i.lon,i.lat,this._map.getZoom()),t.setScale(this._map.getScale());var a=this._map.getCurrentSize();t.setWidth(a.w),t.setHeight(a.h),t.setResolution(this._map.getResolution()),t.setExtent(this._map.getExtent()),t.setMaxExtent(this._map.getMaxExtent()),t.setBbox(this._map.calculateBounds())}},getMapScales:function(){return this._mapScales},calculateLayerScales:function(e,t){for(var i=[],a=0;a<this._mapScales.length;a++)(!t||t>=this._mapScales[a])&&(!e||e<=this._mapScales[a])&&i.push(this._mapScales[a]);return i},calculateLayerResolutions:function(e,t){for(var i=[],a=0;a<this._mapScales.length;a++)(!t||t>=this._mapScales[a])&&(!e||e<=this._mapScales[a])&&i.push(this._options.resolutions[a]);return i},getClosestZoomLevel:function(e,t){var i=this._map.getZoom();if(!t||!e)return i;var a=this._map.getScale();if(t>a){for(var n=i;n>0;n--)if(this._mapScales[n]>=t)return n}else if(a>e)for(var n=i;n<this._mapScales.length;n++)if(this._mapScales[n]<=e)return n;return i},start:function(e){this.started||(e.printDebug("Starting "+this.getName()),this.startPlugins(e),this.updateCurrentState(),this.started=!0)},stop:function(e){this.started&&(this.stopPlugins(e),this.started=!1)},_drawMarker:function(){this._removeMarkers();var e=this._map.getCenter(),t=new OpenLayers.Layer.Markers("Markers");this._map.addLayer(t);var i=new OpenLayers.Size(32,32),a=new OpenLayers.Pixel(-16,-i.h),n=new OpenLayers.Icon(this.getImageUrl()+"/framework/bundle/mapmodule-plugin/images/marker.png",i,a),s=new OpenLayers.Marker(e,n);t.addMarker(s)},_removeMarkers:function(){var e=this._map.getLayersByName("Markers");if(e)for(var t=0;t<e.length;t++)e[t]&&this._map.removeLayer(e[t],!1)},_hasMarkers:function(){var e=this._map.getLayersByName("Markers");if(e)for(var t=0;t<e.length;t++)if(e[t]&&e[t].markers&&e[t].markers.length>0)return!0;return!1},eventHandlers:{SearchClearedEvent:function(){this._removeMarkers()}},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},getOLMapLayers:function(e){var t=this,i=t._sandbox,a=i.findMapLayerFromSelectedMapLayers(e);if(!a)return null;var n=this.getLayerPlugins();for(var s in n){var r=n[s],o=r.getOLMapLayers(a);if(o)return o}return null},updateCurrentState:function(){var e=this,t=e._sandbox,i=t.findAllSelectedMapLayers(),a=this.getLayerPlugins();for(p in a){var n=a[p];t.printDebug("preselecting "+p),n.preselectLayers(i)}}},{protocol:["Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.ui.module.common.mapmodule.Plugin",function(){throw"Oskari.mapframework.ui.module.common.mapmodule.Plugin should not be instantiated"},{getName:function(){throw"Implement your own"},setMapModule:function(){throw"Implement your own"},register:function(){throw"Implement your own"},unregister:function(){throw"Implement your own"},startPlugin:function(){throw"Implement your own"},stopPlugin:function(){throw"Implement your own"},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}}),Oskari.clazz.define("Oskari.mapframework.mapmodule.ControlsPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.conf=e||{}},{__name:"ControlsPlugin",getName:function(){return this.pluginName},hasUI:function(){return!0},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name,this._createMapControls())},register:function(){},unregister:function(){},init:function(e){var t=this,i=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapMovementControlsRequestHandler",t.getMapModule());this.requestHandlers={ToolSelectionRequest:Oskari.clazz.create("Oskari.mapframework.mapmodule.ToolSelectionHandler",e,t),EnableMapKeyboardMovementRequest:i,DisableMapKeyboardMovementRequest:i,EnableMapMouseMovementRequest:i,DisableMapMouseMovementRequest:i}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(var t in this.requestHandlers)e.addRequestHandler(t,this.requestHandlers[t]);for(var i in this.eventHandlers)e.registerForEventByName(this,i);this._addMapControls()},stopPlugin:function(e){for(var t in this.requestHandlers)e.removeRequestHandler(t,this.requestHandlers[t]);for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._removeMapControls(),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{"Toolbar.ToolSelectedEvent":function(){this.conf.zoomBox!==!1&&this._zoomBoxTool.deactivate(),this.conf.measureControls!==!1&&(this._measureControls.line.deactivate(),this._measureControls.area.deactivate())}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_addMapControls:function(){this.conf.zoomBox!==!1&&(this.getMapModule().addMapControl("zoomBoxTool",this._zoomBoxTool),this._zoomBoxTool.deactivate()),this.getMapModule().addMapControl("keyboardControls",this._keyboardControls),this.getMapModule().getMapControl("keyboardControls").activate(),this.conf.measureControls!==!1&&(this.getMapModule().addMapControl("measureControls_line",this._measureControls.line),this._measureControls.line.deactivate(),this.getMapModule().addMapControl("measureControls_area",this._measureControls.area),this._measureControls.area.deactivate()),this.getMapModule().addMapControl("mouseControls",this._mouseControls)},_removeMapControls:function(){this.conf.zoomBox!==!1&&(this._zoomBoxTool.deactivate(),this.getMapModule().removeMapControl("zoomBoxTool",this._zoomBoxTool)),this._keyboardControls.deactivate(),this.getMapModule().removeMapControl("keyboardControls",this._keyboardControls),this.conf.measureControls!==!1&&(this._measureControls.line.deactivate(),this._measureControls.area.deactivate(),this.getMapModule().removeMapControl("measureControls_line",this._measureControls.line),this.getMapModule().removeMapControl("measureControls_area",this._measureControls.area)),this._mouseControls.deactivate(),this.getMapModule().removeMapControl("mouseControls",this._mouseControls)},_createMapControls:function(){function e(e,i){var a=t._sandbox,n=e.geometry,s=e.units,r=e.order,o=e.measure,l=null;1===r?l=o.toFixed(3)+" "+s:2===r&&(l=o.toFixed(3)+" "+s+"<sup>2</sup>");var u=null,c=null;if(i&&OpenLayers.Format.GeoJSON){var h=new OpenLayers.Format.GeoJSON;u=h.write(n,!0),c="application/json"}a.request(t,a.getRequestBuilder("ShowMapMeasurementRequest")(l,i,u,c))}var t=this;if(t._sandbox,!this._zoomBoxTool){this.conf.zoomBox!==!1&&(OpenLayers.Control.ZoomBox.prototype.draw=function(){this.handler=new OpenLayers.Handler.Box(this,{done:function(e){this.zoomBox(e),t.getMapModule()&&t.getMapModule().notifyMoveEnd()}},{keyMask:this.keyMask})},this._zoomBoxTool=new OpenLayers.Control.ZoomBox({alwaysZoom:!0})),this.conf.keyboardControls!==!1&&(this._keyboardControls=new OpenLayers.Control.PorttiKeyboard,this._keyboardControls.setup(this.getMapModule()));var i={handlerOptions:{persist:!0},immediate:!0},a={handlerOptions:{persist:!0},immediate:!0};this._measureControls={},this.conf.measureControls!==!1&&(this._measureControls={line:new OpenLayers.Control.Measure(OpenLayers.Handler.Path,i),area:new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,a)});for(var n in this._measureControls){var s=this._measureControls[n];s.events.on({measure:function(t){e(t,!0)},measurepartial:function(t){e(t,!1)}})}this.conf.mouseControls!==!1&&(this._mouseControls=new OpenLayers.Control.PorttiMouse(this.conf.mouse),this._mouseControls.setup(this.getMapModule()))}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),OpenLayers.Control.PorttiKeyboard=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,slideFactor:50,core:null,setup:function(e){this.mapmodule=e,this.sandbox=e.getSandbox()},initialize:function(){OpenLayers.Control.prototype.initialize.apply(this,arguments)},draw:function(){this.handler=new OpenLayers.Handler.Keyboard(this,{keydown:this.defaultKeyDown,keyup:this.defaultKeyUp})},defaultKeyDown:function(e){switch(e.keyCode){case OpenLayers.Event.KEY_LEFT:this.mapmodule.panMapByPixels(-this.slideFactor,0,!1,!0);break;case OpenLayers.Event.KEY_RIGHT:this.mapmodule.panMapByPixels(this.slideFactor,0,!1,!0);break;case OpenLayers.Event.KEY_UP:this.mapmodule.panMapByPixels(0,-this.slideFactor,!1,!0);break;case OpenLayers.Event.KEY_DOWN:this.mapmodule.panMapByPixels(0,this.slideFactor,!1,!0);break;case 17:this.sandbox.postRequestByName("CtrlKeyDownRequest");break;case 27:this.sandbox.postRequestByName("EscPressedEvent");break;case 33:this.mapmodule.notifyStartMove(),this.mapmodule.panMapNorth();break;case 34:this.mapmodule.notifyStartMove(),this.mapmodule.panMapSouth();break;case 35:this.mapmodule.notifyStartMove(),this.mapmodule.panMapEast();break;case 36:this.mapmodule.notifyStartMove(),this.mapmodule.panMapWest();break;case 43:case 61:case 187:case 107:this.mapmodule.zoomIn();break;case 45:case 109:case 189:case 95:this.mapmodule.zoomOut();break;case 70:this.sandbox.postRequestByName("MapFull.MapWindowFullScreenRequest")}},defaultKeyUp:function(e){switch(e.keyCode){case 17:this.sandbox.postRequestByName("CtrlKeyUpRequest");break;case 37:case 38:case 39:case 40:case 33:case 34:case 35:case 36:case 43:case 61:case 187:case 107:case 45:case 109:case 189:case 95:this.mapmodule.notifyMoveEnd()}},CLASS_NAME:"OpenLayers.Control.PorttiKeyboard"}),OpenLayers.Control.PorttiMouse=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,panned:!1,interval:1,documentDrag:!1,kinetic:null,enableKinetic:!1,kineticInterval:10,pinchZoom:null,pinchZoomOptions:null,documentDrag:!1,zoomBox:null,zoomBoxEnabled:!0,zoomWheelEnabled:!0,mouseWheelOptions:null,handleRightClicks:!1,zoomBoxKeyMask:OpenLayers.Handler.MOD_SHIFT,autoActivate:!0,useCenterMapInWheelZoom:!1,useCenterMapInDblClickZoom:!1,initialize:function(){this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,arguments)},setup:function(e){this.mapmodule=e,this.sandbox=this.mapmodule.getSandbox(),this._hoverEventBuilder=this.sandbox.getEventBuilder("MouseHoverEvent"),this._hoverEvent=this._hoverEventBuilder(),this._mapClickedBuilder=this.sandbox.getEventBuilder("MapClickedEvent")},destroy:function(){this.deactivate(),this.zoomBox&&this.zoomBox.destroy(),this.zoomBox=null,this.pinchZoom&&this.pinchZoom.destroy(),this.pinchZoom=null,OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){return this.handlers.drag.activate(),this.zoomWheelEnabled&&this.handlers.wheel.activate(),this.handlers.click.activate(),this.handlers.hover.activate(),this.zoomBoxEnabled&&this.zoomBox.activate(),this.pinchZoom&&this.pinchZoom.activate(),OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.pinchZoom&&this.pinchZoom.deactivate(),this.zoomBox.deactivate(),this.handlers.drag.deactivate(),this.handlers.click.deactivate(),this.handlers.wheel.deactivate(),this.handlers.hover.deactivate(),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},draw:function(){if(this.enableKinetic){var e={interval:this.kineticInterval};"object"==typeof this.enableKinetic&&(e=OpenLayers.Util.extend(e,this.enableKinetic)),this.kinetic=new OpenLayers.Kinetic(e)}this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.panMap,done:this.panMapDone,down:this.panMapStart},{interval:this.interval,documentDrag:this.documentDrag}),this.handleRightClicks&&(this.map.viewPortDiv.oncontextmenu=OpenLayers.Function.False);var t={click:this.defaultClick,dblclick:this.defaultDblClick,dblrightclick:this.defaultDblRightClick},i={"double":!0,stopDouble:!0};this.handlers.click=new OpenLayers.Handler.Click(this,t,i);var a={move:this.defaultHoverMove,pause:this.defaultHoverPause},n=this,s={pixelTolerance:1.1,passesTolerance:function(e){var t=!0;if(n.panned)return!1;if(this.pixelTolerance&&this.px){var i=Math.sqrt(Math.pow(this.px.x-e.x,2)+Math.pow(this.px.y-e.y,2));i<this.pixelTolerance&&(t=!1)}return t}};if(this.handlers.hover=new OpenLayers.Handler.Hover(this,a,s),this.dragPan=new OpenLayers.Control.DragPan(OpenLayers.Util.extend({map:this.map,documentDrag:this.documentDrag},this.dragPanOptions)),this.zoomBox=new OpenLayers.Control.ZoomBox({map:this.map,keyMask:this.zoomBoxKeyMask}),this.dragPan.draw(),this.zoomBox.draw(),this.handlers.wheel=new OpenLayers.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown},this.mouseWheelOptions),OpenLayers.Control.PinchZoom){var r=this.pinchZoomOptions||{};r.pinchDone=function(e,t,i){this.applyTransform("");var a=this.map.getZoomForResolution(this.map.getResolution()/i.scale,!0);if(a!==this.map.getZoom()||!this.currentCenter.equals(this.pinchOrigin)){var s=this.map.getResolutionForZoom(a),r=this.map.getLonLatFromPixel(this.pinchOrigin),o=this.currentCenter,l=this.map.getSize();r.lon+=s*(l.w/2-o.x),r.lat-=s*(l.h/2-o.y),n.sendMapSetCenter(r,a)}},this.pinchZoom=new OpenLayers.Control.PinchZoom(OpenLayers.Util.extend({map:this.map},r))}},defaultClick:function(e){if(e.lastTouches&&2==e.lastTouches.length)this.sendMapZoomOut();else{var t=-1!=navigator.userAgent.indexOf("MSIE 8.0");if(t){var i=(new Date).getTime();this.lastDblClickMs?i-this.lastDblClickMs<1e3||this.sendMapClickEvent(e):this.sendMapClickEvent(e)}else this.sendMapClickEvent(e)}},defaultDblClick:function(e){var t=1,i=this.map.getZoom(),a=this.map.getZoom()+Math.round(t);if(a=Math.max(a,0),a=Math.min(a,this.map.getNumZoomLevels()),a!==i){var n=this.map.getSize(),s=n.w/2-e.xy.x,r=e.xy.y-n.h/2,o=this.map.baseLayer.getResolutionForZoom(a),l=this.map.getLonLatFromPixel(e.xy),u=null;u=this.useCenterMapInDblClickZoom?this.map.getCenter():new OpenLayers.LonLat(l.lon+s*o,l.lat+r*o);var c=-1!=navigator.userAgent.indexOf("MSIE 8.0");c&&(this.lastDblClickMs=(new Date).getTime()),this.sendMapSetCenter(u,a)}},defaultDblRightClick:function(){this.sendMapZoomOut()},wheelChange:function(e,t){var i=this.map.getZoom(),a=this.map.getZoom()+Math.round(t);if(a=Math.max(a,0),a=Math.min(a,this.map.getNumZoomLevels()),a!==i){var n=this.map.getSize(),s=n.w/2-e.xy.x,r=e.xy.y-n.h/2,o=this.map.baseLayer.getResolutionForZoom(a),l=this.map.getLonLatFromPixel(e.xy),u=null;
u=this.useCenterMapInWheelZoom?this.map.getCenter():new OpenLayers.LonLat(l.lon+s*o,l.lat+r*o),this.sendMapSetCenter(u,a)}},wheelUp:function(e,t){this.wheelChange(e,t||1)},wheelDown:function(e,t){this.wheelChange(e,t||-1)},disableZoomBox:function(){this.zoomBoxEnabled=!1,this.zoomBox.deactivate()},enableZoomBox:function(){this.zoomBoxEnabled=!0,this.active&&this.zoomBox.activate()},disableZoomWheel:function(){this.zoomWheelEnabled=!1,this.handlers.wheel.deactivate()},enableZoomWheel:function(){this.zoomWheelEnabled=!0,this.active&&this.handlers.wheel.activate()},panMapStart:function(){this.kinetic&&this.kinetic.begin(),this.panned=!1},panMap:function(e){this.kinetic&&this.kinetic.update(e),this.panned||this.mapmodule.notifyStartMove(),this.panned=!0,this.map.pan(this.handlers.drag.last.x-e.x,this.handlers.drag.last.y-e.y,{dragging:!0,animate:!1})},panMapDone:function(e){if(this.panned){var t=null;if(this.kinetic&&(t=this.kinetic.end(e)),this.mapmodule.panMapByPixels(this.handlers.drag.x-e.x,this.handlers.drag.y-e.y,!0,!1,!1),t){var i=this;this.kinetic.move(t,function(e,t){i.mapmodule.panMapByPixels(e,t,!0,!1,!1)})}this.panned=!1}},defaultHoverMove:function(e){if(!this.panned){var t=this.map.getLonLatFromViewPortPx(e.xy);this._hoverEvent.set(t.lon,t.lat,!1,e.pageX,e.pageY),this.sandbox.notifyAll(this._hoverEvent,!0)}},defaultHoverPause:function(e){if(!this.panned){var t=this.map.getLonLatFromViewPortPx(e.xy),i=this._hoverEventBuilder();i.set(t.lon,t.lat,!1,e.pageX,e.pageY),this.sandbox.notifyAll(i)}},sendMapClickEvent:function(e){var t=this.map.getLonLatFromViewPortPx(e.xy),e=this._mapClickedBuilder(t,e.xy.x,e.xy.y);this.sandbox.notifyAll(e)},sendMapSetCenter:function(e,t){this.mapmodule.centerMap(e,t)},sendMapZoomOut:function(){this.mapmodule.zoomOut()},sendMapZoomIn:function(){this.mapmodule.zoomIn()},CLASS_NAME:"OpenLayers.Control.PorttiMouse"}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.DisableMapKeyboardMovementRequest",function(){this._creator=null},{__name:"DisableMapKeyboardMovementRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.DisableMapMouseMovementRequest",function(){this._creator=null},{__name:"DisableMapMouseMovementRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.EnableMapKeyboardMovementRequest",function(){this._creator=null},{__name:"EnableMapKeyboardMovementRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.EnableMapMouseMovementRequest",function(){this._creator=null},{__name:"EnableMapMouseMovementRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapMovementControlsRequestHandler",function(e){this.mapModule=e},{handleRequest:function(e,t){if("EnableMapKeyboardMovementRequest"==t.getName()){var i=this.mapModule.getMapControl("keyboardControls");i&&i.activate()}else if("DisableMapKeyboardMovementRequest"==t.getName()){var i=this.mapModule.getMapControl("keyboardControls");i&&i.deactivate()}else if("EnableMapMouseMovementRequest"==t.getName()){var i=this.mapModule.getMapControl("mouseControls");i&&(i.activate(),i.registerMouseEvents())}else if("DisableMapMouseMovementRequest"==t.getName()){var i=this.mapModule.getMapControl("mouseControls");i&&(i.deactivate(),i.unregisterMouseEvents())}}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.request.common.ShowMapMeasurementRequest",function(e,t,i,a){this._creator=null,this._value=e,this._geometry=i,this._finished=t,this._geometryMimeType=a},{__name:"ShowMapMeasurementRequest",getName:function(){return this.__name},getValue:function(){return this._value},getGeometry:function(){return this._geometry},getGeometryMimeType:function(){return this._geometryMimeType},isFinished:function(){return this._finished}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.getinfo.GetFeatureInfoHandler",function(e){this.getInfoPlugin=e},{handleRequest:function(e,t){"MapModulePlugin.GetFeatureInfoRequest"==t.getName()?this.getInfoPlugin.handleGetInfo({lon:t.getLon(),lat:t.getLat()},t.getX(),t.getY()):"MapModulePlugin.GetFeatureInfoActivationRequest"==t.getName()&&this.getInfoPlugin.setEnabled(t.isEnabled())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.GetFeatureInfoRequest",function(e,t,i,a){this._lon=e,this._lat=t,this._x=i,this._y=a},{__name:"MapModulePlugin.GetFeatureInfoRequest",getName:function(){return this.__name},getLon:function(){return this._lon},getLat:function(){return this._lat},getX:function(){return this._x},getY:function(){return this._y}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.GetFeatureInfoActivationRequest",function(e){this._enable=e===!0},{__name:"MapModulePlugin.GetFeatureInfoActivationRequest",getName:function(){return this.__name},isEnabled:function(){return this._enable}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.GetInfoPlugin",function(e,t){this.config=e,this._locale=t,this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.enabled=!0,this.infoboxId="getinforesult",this._pendingAjaxQuery={busy:!1,jqhr:null,timestamp:null},this.template={};for(p in this.__templates)this.template[p]=jQuery(this.__templates[p])},{__templates:{wrapper:"<div></div>",getinfo_result_table:'<table class="getinforesult_table"></table>',link_outside:'<a target="_blank"></a>',tableRow:"<tr></tr>",tableCell:"<td></td>",span:"<span></span>",header:'<div class="getinforesult_header"><div class="icon-bubble-left"></div>',headerTitle:'<div class="getinforesult_header_title"></div>'},__name:"GetInfoPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(e){var t=this;t._sandbox=e,t._sandbox.printDebug("[GetInfoPlugin] init"),t.getGFIHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.getinfo.GetFeatureInfoHandler",t)},register:function(){},unregister:function(){},startPlugin:function(e){var t=this;e&&e.register&&(t._sandbox=e),t._map=t.getMapModule().getMap(),t._sandbox.register(t);for(p in t.eventHandlers)t._sandbox.registerForEventByName(t,p);t._sandbox.addRequestHandler("MapModulePlugin.GetFeatureInfoRequest",t.getGFIHandler),t._sandbox.addRequestHandler("MapModulePlugin.GetFeatureInfoActivationRequest",t.getGFIHandler)},stopPlugin:function(e){var t=this;t._closeGfiInfo(),e&&e.register&&(t._sandbox=e);for(p in t.eventHandlers)t._sandbox.unregisterFromEventByName(t,p);t._sandbox.unregister(t),t._map=null,t._sandbox=null},start:function(){},stop:function(){},setEnabled:function(e){this.enabled=e===!0,this.enabled||this._closeGfiInfo()},eventHandlers:{EscPressedEvent:function(){this._closeGfiInfo()},MapClickedEvent:function(e){if(this.enabled){var t=e.getLonLat(),i=e.getMouseX(),a=e.getMouseY();this.handleGetInfo(t,i,a)}},AfterMapMoveEvent:function(){this._cancelAjaxRequest()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_cancelAjaxRequest:function(){var e=this;if(e._pendingAjaxQuery.busy){var t=e._pendingAjaxQuery.jqhr;e._pendingAjaxQuery.jqhr=null,t&&(this._sandbox.printDebug("[GetInfoPlugin] Abort jqhr ajax request"),t.abort(),t=null,e._pendingAjaxQuery.busy=!1)}},_buildLayerIdList:function(){for(var e=this,t=e._sandbox.findAllSelectedMapLayers(),i=null,a=e._sandbox.getMap().getScale(),n=0;n<t.length;n++){var s=t[n];e._isIgnoredLayerType(s)||s.getQueryable&&s.getQueryable()&&s.isInScale(a)&&s.isVisible()&&(i||(i=""),""!==i&&(i+=","),i+=s.getId())}return i},_isIgnoredLayerType:function(e){if(null!=this.config&&this.config.ignoredLayerTypes)for(var t=0;t<this.config.ignoredLayerTypes.length;t++)if(e.isLayerOfType(this.config.ignoredLayerTypes[t]))return!0;return!1},_startAjaxRequest:function(e){var t=this;t._pendingAjaxQuery.busy=!0,t._pendingAjaxQuery.timestamp=e},_finishAjaxRequest:function(){var e=this;e._pendingAjaxQuery.busy=!1,e._pendingAjaxQuery.jqhr=null,this._sandbox.printDebug("[GetInfoPlugin] finished jqhr ajax request")},_notifyAjaxFailure:function(){var e=this;e._sandbox.printDebug("[GetInfoPlugin] GetFeatureInfo AJAX failed")},_isAjaxRequestBusy:function(){var e=this;return e._pendingAjaxQuery.busy},handleGetInfo:function(e,t,i){var a=this,n=new Date,s=n.getTime();if(a._pendingAjaxQuery.busy&&a._pendingAjaxQuery.timestamp&&s-a._pendingAjaxQuery.timestamp<500)return a._sandbox.printDebug("[GetInfoPlugin] GetFeatureInfo NOT SENT (time difference < 500ms)"),void 0;a._cancelAjaxRequest();var r=a._buildLayerIdList();if(!r){var o={fragments:[],lonlat:e,popupid:this.infoboxId,title:""},l=this.getMapModule().getLocalization("plugin",!0),u=l[this.__name];o.title=u.title;var c=a._sandbox.getEventBuilder("GetInfoResultEvent")(o);return a._sandbox.notifyAll(c),a._sandbox.printDebug("[GetInfoPlugin] NO layers with featureInfoEnabled, in scale and visible"),void 0}a._startAjaxRequest(s);var h=this._sandbox.getAjaxUrl(),d=e.lon,p=e.lat,f=a._sandbox.getMap();jQuery.ajax({beforeSend:function(e){a._pendingAjaxQuery.jqhr=e,e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(t){if(t.data&&t.data instanceof Array){t.lonlat=e;var i=a._parseGfiResponse(t);if(!i)return;if(i.popupid=a.infoboxId,i.lonlat=e,!a._isAjaxRequestBusy())return;a._showFeatures(i)}a._finishAjaxRequest()},error:function(){a._finishAjaxRequest(),a._notifyAjaxFailure()},always:function(){a._finishAjaxRequest()},complete:function(){a._finishAjaxRequest()},data:{layerIds:r,projection:a.mapModule.getProjection(),x:t,y:i,lon:d,lat:p,width:f.getWidth(),height:f.getHeight(),bbox:f.getBbox().toBBOX(),zoom:f.getZoom(),srs:f.getSrsName()},type:"POST",dataType:"json",url:h+"action_route=GetFeatureInfoWMS"})},_closeGfiInfo:function(){var e=this._sandbox.getRequestBuilder("InfoBox.HideInfoBoxRequest")(this.infoboxId);this._sandbox.request(this,e)},_showGfiInfo:function(e,t){var i=this._sandbox.getRequestBuilder("InfoBox.ShowInfoBoxRequest")("getinforesult","GetInfo Result",e,t,!0);this._sandbox.request(this,i)},_formatResponseForInfobox:function(e){var t=[];if(!e||!e.data)return t;var i=this,a=[];e.data.length?a=e.data:a.push(e.data);for(var n=0;n<a.length;n++){var s=a[n],r=i._formatGfiDatum(s);null!=r&&t.push({html:r})}return t},_parseGfiResponse:function(e){var t=this._sandbox,i=e.data,a=[],n=e.lonlat,s=n.lon+", "+n.lat,r=e.layerCount;if(0!=r&&0!=i.length&&i instanceof Array){for(var o=0;o<i.length;o++){var l=i[o],u=l.layerId,c=t.findMapLayerFromSelectedMapLayers(u),h=c?c.getName():"",d=l.type;if("wfslayer"==d){var p=l.features;if(!p||!p.length)continue;for(var f=0;f<p.length;f++){var m=p[f],g=m.children;if(g&&g.length)for(var y=0;y<g.length;y++){var v=g[y],b=v.pnr_PaikanNimi;b&&b["pnr:kirjoitusasu"]&&(s=b["pnr:kirjoitusasu"]);var _=this._json2html(v);a.push({markup:_,layerId:u,layerName:h,type:d})}}}else{var _=this._formatGfiDatum(l);null!=_&&a.push({markup:_,layerId:u,layerName:h,type:d})}}return{fragments:a,title:s}}},_formatJSONValue:function(e){if(e){var t=this.template.span.clone();if("[object Array]"===Object.prototype.toString.call(e))for(var i=0;i<e.length;++i){var a=e[i];for(objAttr in a){var n=this._formatJSONValue(a[objAttr]);if(n){var s=this.getMapModule().getLocalization("plugin",!0),r=s[this.__name],o=r[objAttr];t.append(o?o:objAttr),t.append(": "),t.append(n),t.append("<br/>")}}}else if(e.indexOf&&e.indexOf("://")>0&&e.indexOf("://")<7){var l=this.template.link_outside.clone();l.attr("href",e),l.append(e),t.append(l)}else t.append(e);return t}},_formatGfiDatum:function(e){if(!e.presentationType)return null;var t=this,i=t.template.wrapper.clone(),a=typeof e.content,n=!1;if("string"==a&&(n=e.content.indexOf("<html>")>=0,n=n||e.content.indexOf("<HTML>")>=0),"JSON"==e.presentationType||e.content&&e.content.parsed){var s=!1,r=e.content.parsed,o=[];"[object Array]"===Object.prototype.toString.call(r)?o=r:o.push(r);for(var l=0;l<o.length;++l){var u=o[l],c=t.template.getinfo_result_table.clone();for(var h in u){var d=t._formatJSONValue(u[h]);if(d){var p=t.template.tableRow.clone();c.append(p),s||p.addClass("odd"),s=!s;var f=t.template.tableCell.clone(),m=this.getMapModule().getLocalization("plugin",!0),g=m[this.__name],y=g[h];f.append(y?y:h),p.append(f);var v=t.template.tableCell.clone();v.append(d),p.append(v)}}i.append(c)}return i}return i.append(e.content),i},_json2html:function(e){if(null==e)return"";var t=!0,i=this.template.getinfo_result_table.clone(),a=null,n=null,s=null;for(var r in e){var o=e[r],l=(typeof o).toLowerCase();switch(l){case"string":0==o.indexOf("http://")?(valpres=this.template.link_outside.clone(),valpres.attr("href",o),valpres.append(o)):valpres=o;break;case"undefined":valpres="n/a";break;case"boolean":valpres=o?"true":"false";break;case"number":valpres=""+o;break;case"function":valpres="?";break;case"object":valpres=this._json2html(o);break;default:valpres=""}t=!t,a=this.template.tableRow.clone(),t||a.addClass("odd"),n=this.template.tableCell.clone(),n.append(r),a.append(n),s=this.template.tableCell.clone(),s.append(valpres),a.append(s),i.append(a)}return i},_showFeatures:function(e){var t=this,i={},a=t.template.wrapper.clone();i.html="",i.actions={};for(var n=0;n<e.fragments.length;n++){var s=e.fragments[n],r=s.layerName,o=s.markup,l=t.template.wrapper.clone(),u=t.template.header.clone(),c=t.template.headerTitle.clone();c.append(r),c.attr("title",r),u.append(c),l.append(u),o&&l.append(o),a.append(l)}i.html=a;var h=this.getMapModule().getLocalization("plugin",!0),d=h[this.__name];if(e.title=d.title,!this.config||this.config.infoBox){var p=t._sandbox.getRequestBuilder("InfoBox.ShowInfoBoxRequest")(e.popupid,e.title,[i],e.lonlat,!0);t._sandbox.request(t,p)}var f=t._sandbox.getEventBuilder("GetInfoResultEvent")(e);t._sandbox.notifyAll(f)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.MarkersPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null},{__name:"MarkersPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this.requestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MarkerRequestHandler",this)},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this._createMapMarkersLayer(),e.register(this),this._sandbox.addRequestHandler("MapModulePlugin.RemoveMarkerRequest",this.requestHandler);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){this._sandbox.removeRequestHandler("MapModulePlugin.RemoveMarkerRequest",this.requestHandler);for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},removeMapMarkers:function(){var e=this.getMapModule();e&&e._removeMarkers()},_createMapMarkersLayer:function(){this._sandbox;var e=new OpenLayers.Layer.Markers("Markers");this._map.addLayer(e)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.RemoveMarkerRequest",function(e){this._list=e},{__name:"MapModulePlugin.RemoveMarkerRequest",getName:function(){return this.__name},getMarkerIds:function(){return this._list}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MarkerRequestHandler",function(e){this.markersPlugin=e},{handleRequest:function(e,t){"MapModulePlugin.RemoveMarkerRequest"==t.getName()&&this.markersPlugin.removeMapMarkers(t.getMarkerIds())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.SearchPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._conf=e,this.container=null,this.loc=null},{__name:"SearchPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(e){var t=this.getMapModule().getLocalization("plugin",!0);this.loc=t[this.__name],this.template=jQuery('<div class="search-div"><div class="search-textarea-and-button"><input placeholder="'+this.loc.placeholder+'" type="text" />'+'<input type="button" value="'+this.loc.search+'" name="search" />'+"</div>"+'<div class="results">'+'<div class="header"><div class="close icon-close" title="'+this.loc.close+'"></div></div>'+'<div class="content">&nbsp;</div>'+"</div>"+"</div>"),this.templateResultsTable=jQuery("<table class='search-results'><thead><tr><th>"+this.loc.column_name+"</th>"+"<th>"+this.loc.column_village+"</th>"+"<th>"+this.loc.column_type+"</th>"+"</tr></thead><tbody></tbody></table>"),this.templateResultsRow=jQuery("<tr><td nowrap='nowrap'><a href='JavaScript:void(0);'></a></td><td nowrap='nowrap'></td><td nowrap='nowrap'></td></tr>");var i=null;i=this.conf&&this.conf.url?this.conf.url:e.getAjaxUrl()+"action_route=GetSearchResult",this.service=Oskari.clazz.create("Oskari.mapframework.bundle.search.service.SearchService",i)},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this._createUI()},stopPlugin:function(e){this.container.remove();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_createUI:function(){var e=this._sandbox,t=this,i=this.template.clone();this.container=i;var a=jQuery("div.mapplugins.left");a&&0!=a.length||(a=jQuery(this._map.div),i.addClass("mapplugin"));var t=this,n=i.find("input[type=text]");n.focus(function(){e.request(t.getName(),e.getRequestBuilder("DisableMapKeyboardMovementRequest")())}),n.blur(function(){e.request(t.getName(),e.getRequestBuilder("EnableMapKeyboardMovementRequest")())}),n.keypress(function(e){t._checkForEnter(e)}),i.find("input[type=button]").click(function(){t._doSearch()}),i.find("div.close").click(function(){t._hideSearch()}),i.find("div.results").hide(),a.append(i),this._conf&&this._conf.location&&(this._conf.location.top&&i.css("top",this._conf.location.top),this._conf.location.left&&i.css("left",this._conf.location.left),this._conf.location.right&&i.css("right",this._conf.location.right),this._conf.location.bottom&&i.css("bottom",this._conf.location.bottom))},_checkForEnter:function(e){var t;window.event?t=window.event.keyCode:e&&(t=e.which),13==e.keyCode&&this._doSearch()},_doSearch:function(){if(1!=this._searchInProgess){var e=this;this._hideSearch(),this._searchInProgess=!0;var t=this.container.find("input[type=text]");t.addClass("search-loading");var i=t.val(),a=function(t){e._showResults(t),e._enableSearch()},n=function(){e._enableSearch()};this.service.doSearch(i,a,n)}},_showResults:function(e){var t=e.error,i=this,a=this.container.find("div.results");a.find("div.header");var n=a.find("div.content");if(null!=t)return n.html(t),a.show(),void 0;var s=e.totalCount;if(0==s)n.html(this.loc.noresults),a.show();else if(1==s){var r=e.locations[0].lon,o=e.locations[0].lat,l=e.locations[0].zoomLevel;this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("MapMoveRequest")(r,o,l,!1))}else{for(var u=this.templateResultsTable.clone(),c=u.find("tbody"),h=0;s>h;h++){if(h>=100){c.append("<tr><td class='search-result-too-many' colspan='3'>"+this.loc.toomanyresults+"</td></tr>");break}var r=e.locations[h].lon,o=e.locations[h].lat,l=e.locations[h].zoomLevel,d=r+"---"+o+"---"+l,p=this.templateResultsRow.clone();p.attr("data-location",d);var f=e.locations[h].name,m=e.locations[h].village,g=e.locations[h].type,y=p.find("td"),v=jQuery(y[0]).find("a");v.attr("data-location",d),v.append(f),v.click(function(){return i._resultClicked(jQuery(this).attr("data-location")),!1}),jQuery(y[1]).append(m),jQuery(y[2]).append(g),c.append(p)}c.find(":odd").addClass("odd"),n.html(u),a.show()}},_resultClicked:function(e){var t=e.split("---"),i=t[0],a=t[1],n=t[2];this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("MapMoveRequest")(i,a,n,!1))},_enableSearch:function(){this._searchInProgess=!1,jQuery("#search-string").removeClass("search-loading")},_hideSearch:function(){this.container.find("div.results").hide(),this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("HideMapMarkerRequest")())}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.search.service.SearchService",function(e){this._searchUrl=e},{__qname:"Oskari.mapframework.bundle.search.service.SearchService",getQName:function(){return this.__qname},__name:"SearchService",getName:function(){return this.__name},doSearch:function(e,t,i){var a=Oskari.getLang();jQuery.ajax({dataType:"json",type:"POST",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/json")},url:this._searchUrl,data:"searchKey="+e+"&Language="+a,error:i,success:t})}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.LogoPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.element=null},{templates:{main:jQuery("<div class='logoplugin'><div class='icon'></div><div class='terms'><a href='JavaScript:void(0);'></a></div></div>")},__name:"LogoPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){},register:function(){},unregister:function(){},startPlugin:function(e){var t=this;t._sandbox=e,t._map=t.getMapModule().getMap(),e.register(t);for(p in t.eventHandlers)e.registerForEventByName(t,p);t._createUI()},stopPlugin:function(e){var t=this;for(p in t.eventHandlers)e.unregisterFromEventByName(t,p);e.unregister(t),t._map=null,t._sandbox=null,t.element&&(t.element.find("a").unbind("click"),t.element.remove(),t.element=void 0)},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_createUI:function(){var e=this,t=e._sandbox,i=jQuery(e._map.div);e.element||(e.element=e.templates.main.clone()),i.append(e.element);var a=e.getMapModule().getLocalization("plugin",!0),n=a[e.__name],s=e.element.find("div.icon");s.bind("click",function(){var e=t.generateMapLinkParameters(),i=n.mapLinkBase+e;return window.open(i,"_blank"),!1});var s=e.element.find("a");s.append(n.terms),s.bind("click",function(){var e=n.termsLink;return window.open(e,"_blank"),!1})}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.DataSourcePlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.template=null,this.element=null,this.sandbox=null,this.tool=null},{__name:"DataSourcePlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this.template=jQuery("<div class='oskari-datasource'><div class='link'><a href='JavaScript:void(0);'></a></div></div>"),this.templateinfoIcon=jQuery('<div class="icon-info"></div>'),this.templategroupTemplate=jQuery('<ul style="padding: 0 12px;"></ul>'),this.templatecontent=jQuery("<div></div>"),this.templateheading=jQuery("<b></b>")},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this._createUI()},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null,this.element.find("a").unbind("click"),this.element.remove(),this.element=void 0},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_layerListComparator:function(e,t){var i=e.getOrganizationName().toLowerCase(),a=t.getOrganizationName().toLowerCase();return i==a&&(i=e.getName().toLowerCase(),a=t.getName().toLowerCase()),a>i?-1:i>a?1:0},_createUI:function(){var e=this;e._sandbox;var t=jQuery(this._map.div);this.element||(this.element=this.template.clone()),t.append(this.element);var i=this.getMapModule().getLocalization("plugin",!0);this.localization=i[this.__name];var a=this.element.find("a");a.append(this.localization.link),a.bind("click",function(){return e._openDialog(),!1})},_openDialog:function(){var e=this;e._sandbox;var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=t.createCloseButton(this.localization.button.close);this.templateinfoIcon.clone();for(var a=this.templategroupTemplate.clone(),n=this._getLayers(),s=null,r=this.templatecontent.clone(),o=null,l=0;l<n.length;++l){var u=n[l];if(s!=u.getOrganizationName()){s=u.getOrganizationName();var c=this.templateheading.clone();s?c.append(s):c.append("N/A"),r.append(c),o=a.clone(),r.append(o)}var h=this._getLayerContainer(u);h&&o.append(h)}t.show(this.localization.popup.title,r,[i]),t.moveTo(this.element.find("a"),"top")},_getLayers:function(){var e=this,t=this._sandbox.findAllSelectedMapLayers();return t.sort(function(t,i){return e._layerListComparator(t,i)}),t},_getLayerContainer:function(e){var t=this,i=this.templateinfoIcon.clone(),a=e.getName();if(a){var n=jQuery("<li>"+a+"</li>"),s=e.getMetadataIdentifier();if(s){var r=i.clone();r.bind("click",function(){t._getMetadataInfoCallback(e)}),n.append(r)}return n}return null},_getMetadataInfoCallback:function(e){var t=this,i=t._sandbox,a=e.getMetadataIdentifier(),n=[],s={};s[a]=!0;var r=e.getSubLayers();if(r&&r.length>0)for(var o=0;o<r.length;o++){var l=r[o].getMetadataIdentifier();l&&""!=l&&!s[l]&&(s[l]=!0,n.push({uuid:l}))}i.postRequestByName("catalogue.ShowMetadataRequest",[{uuid:a},n])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.IndexMapPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._conf=e,this._indexMap=null,this._indexMapUrl="/framework/bundle/mapmodule-plugin/plugin/indexmap/images/suomi25m_tm35fin.png"},{__name:"IndexMapPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){},_createUI:function(){var e=new OpenLayers.Layer.Image("Overview map image",this.getMapModule().getImageUrl()+this._indexMapUrl,new OpenLayers.Bounds(26783,6608595,852783,7787250),new OpenLayers.Size(120,173)),t={mapOptions:{maxExtent:new OpenLayers.Bounds(26783,6608595,852783,7787250),units:"m",projection:this._map.getProjection(),numZoomLevels:1},layers:[e],size:new OpenLayers.Size(120,173),autoPan:!1,controls:[]};this._indexMap=new OpenLayers.Control.OverviewMap(t)},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this._createUI(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.getMapModule().addMapControl("overviewMap",this._indexMap)},stopPlugin:function(e){this.getMapModule().removeMapControl("overviewMap");for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapMoveEvent:function(){this._indexMap&&this._indexMap.update()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.ScaleBarPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._scalebar=null},{__name:"ScaleBarPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this._scalebar=new OpenLayers.Control.ScaleLine},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.getMapModule().addMapControl("scaleBar",this._scalebar)},stopPlugin:function(e){this.getMapModule().removeMapControl("scaleBar");for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapMoveEvent:function(){this._scalebar&&this._scalebar.update()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.FullScreenPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._fullscreen=null,this.__templates={}},{__name:"FullScreenPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){var e=this.getMapModule().getImageUrl()+"/framework/bundle/mapmodule-plugin/plugin/fullscreen/images/";this.__templates.fullscreen=jQuery('<div class="fullscreenDiv"><img class="fullscreenDivImg" src="'+e+"hide-navigation.png"+'"></img>'+"</div>")},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.createUI()},stopPlugin:function(e){jQuery("div.fullscreenDiv").remove();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},createUI:function(){var e=this,t=this.__templates.fullscreen.clone(),i=this.getMapModule().getImageUrl()+"/framework/bundle/mapmodule-plugin/plugin/fullscreen/images/";t.find(".fullscreenDivImg").bind("click",function(t){t.preventDefault(),e._sandbox.postRequestByName("MapFull.MapWindowFullScreenRequest"),jQuery(this).attr("src").match(/hide-navigation/)?jQuery(this).attr("src",i+"show-navigation.png"):jQuery(this).attr("src",i+"hide-navigation.png")
}),jQuery(this._map.div).append(t)},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.LayerSelectionPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.element=void 0,this.conf=e,this.initialSetup=!0},{__name:"LayerSelectionPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},getMap:function(){return this._map},register:function(){},unregister:function(){},init:function(){this.template=jQuery('<div class=\'layerSelectionPlugin\'><div class="header"><div class="header-icon icon-arrow-white-right"></div></div><div class="content"><div class="layers"></div><div class="baselayers"></div></div></div>'),this.templateLayer=jQuery("<div class='layer'><span></span></div>"),this.templateCheckbox=jQuery("<input type='checkbox' />"),this.templateRadiobutton=jQuery("<input type='radio' name='defaultBaselayer'/>"),this.templateBaseLayerHeader=jQuery('<div class="baseLayerHeader"></div>')},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this._createUI()},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this.element&&(this.element.remove(),this.element=void 0,delete this.element)},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerRemoveEvent:function(e){this.removeLayer(e.getMapLayer())},AfterMapLayerAddEvent:function(e){this.addLayer(e.getMapLayer())},MapLayerVisibilityChangedEvent:function(e){this.updateLayer(e.getMapLayer())},AfterMapMoveEvent:function(){if(this.initialSetup&&(this.initialSetup=!1,this.conf&&this.conf.baseLayers)){for(var e=0;e<this.conf.baseLayers.length;++e){var t=this._sandbox.findMapLayerFromSelectedMapLayers(this.conf.baseLayers[e]);this.addBaseLayer(t)}this.conf.defaultBaseLayer&&this.selectBaseLayer(this.conf.defaultBaseLayer)}}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(){},selectBaseLayer:function(e){var t=this.element.find("div.content div.baselayers");if(t&&0!=t.length){var i=t.find("input[value="+e+"]");i.attr("checked","checked"),this._changedBaseLayer()}},addLayer:function(e){var t=this.element.find("div.content"),i=t.find("div.layers"),a=this.templateLayer.clone();a.find("span").append(e.getName());var n=this.templateCheckbox.clone();n.attr("value",e.getId()),e.isVisible()?n.attr("checked",!0):n.attr("checked",!1),this._bindCheckbox(n,e),a.find("span").before(n),this.layerRefs[e.getId()]=a,i.append(a)},updateLayer:function(e){var t=this.layerRefs[e.getId()],i=t.find("input"),a=e.isVisible();a?i.is(":checked")||i.attr("checked","checked"):i.is(":checked")&&i.removeAttr("checked")},_bindCheckbox:function(e,t){var i=this;e.change(function(){var e=jQuery(this),a=e.is(":checked");a?i._setLayerVisible(t,!0):i._setLayerVisible(t,!1)})},_setLayerVisible:function(e,t){var i=this._sandbox,a=i.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest"),n=a(e.getId(),t);i.request(this,n)},removeLayer:function(e){var t=this.layerRefs[e.getId()];t.remove(),delete this.layerRefs[e.getId()]},addBaseLayer:function(e){if(e&&e.getId){var t=this.layerRefs[e.getId()];t.remove();var i=t.find("input");i.remove(),i=this.templateRadiobutton.clone(),i.attr("value",e.getId());var a=this;i.bind("change",function(){a._changedBaseLayer()}),t.find("span").before(i);var n=this.element.find("div.content div.baselayers");if(0==n.find("div.layer").length){var s=this.getMapModule().getLocalization("plugin"),r=s[this.__name],o=this.templateBaseLayerHeader.clone();o.append(r.chooseDefaultBaseLayer),n.before(o),i.attr("checked","checked")}n.append(t),a._changedBaseLayer()}},removeBaseLayer:function(e){var t=this.layerRefs[e.getId()];t.remove();var i=t.find("input");i.remove(),i=this.templateCheckbox.clone(),i.attr("value",e.getId()),this._bindCheckbox(i,e),t.find("span").before(i);var a=this.element.find("div.content div.layers");a.append(t),this._setLayerVisible(e,!0);var n=this.element.find("div.content div.baselayers"),s=n.find("div.layer");if(0==s.length){var r=this.element.find("div.content div.baseLayerHeader");r.remove()}else{var o=s.find("input:checked");0==o.length&&(jQuery(s.find("input").get(0)).attr("checked","checked"),this._changedBaseLayer())}},_changedBaseLayer:function(){for(var e=this.getBaseLayers(),t=0;t<e.baseLayers.length;++t){var i=e.baseLayers[t],a=this._sandbox.findMapLayerFromSelectedMapLayers(i);this._setLayerVisible(a,e.defaultBaseLayer==i)}var n=this._sandbox,s="RearrangeSelectedMapLayerRequest",r=n.getRequestBuilder(s),o=r(e.defaultBaseLayer,0);n.request(this,o)},setupLayers:function(){var e=this;delete this.layerRefs,this.layerRefs={};for(var t=this._sandbox.findAllSelectedMapLayers(),i=0;i<t.length;++i)e.addLayer(t[i])},openSelection:function(){var e=this.element.find("div.header div.header-icon");e.removeClass("icon-arrow-white-right"),e.addClass("icon-arrow-white-down"),this.element.find("div.content").show()},closeSelection:function(){var e=this.element.find("div.header div.header-icon");e.removeClass("icon-arrow-white-down"),e.addClass("icon-arrow-white-right"),this.element.find("div.content").hide()},getBaseLayers:function(){for(var e=this.element.find("div.content div.baselayers div.layer input"),t=[],i=null,a=0;a<e.length;++a){var n=jQuery(e[a]);t.push(n.val()),n.is(":checked")&&(i=n.val())}return{baseLayers:t,defaultBaseLayer:i}},_createUI:function(){var e=this;this.element||(this.element=this.template.clone());var t=this.getMapModule().getLocalization("plugin",!0),i=t[this.__name],a=this.element.find("div.header");a.append(i.title),a.bind("click",function(){var t=e.element.find("div.content");t.is(":hidden")?e.openSelection():e.closeSelection()}),this.closeSelection(),this.setupLayers();var n=jQuery("div.mapplugins.left");if(n&&0!=n.length){var s=n.find("div");s&&0!=s.length?s.first().before(this.element):n.append(this.element)}else{n=jQuery(this._map.div);var r=this.element.find("div.content");r.addClass("mapplugin"),n.append(this.element)}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.LayersPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this._visibilityPollingInterval=1500,this._visibilityCheckOrder=0,this._previousTimer=null},{__name:"LayersPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},getMap:function(){return this._map},register:function(){},unregister:function(){},init:function(e){this.requestHandlers={layerVisibilityHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapLayerVisibilityRequestHandler",e,this),layerContentHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapMoveByLayerContentRequestHandler",e,this)}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);e.addRequestHandler("MapModulePlugin.MapLayerVisibilityRequest",this.requestHandlers.layerVisibilityHandler),e.addRequestHandler("MapModulePlugin.MapMoveByLayerContentRequest",this.requestHandlers.layerContentHandler)},stopPlugin:function(e){e.removeRequestHandler("MapModulePlugin.MapLayerVisibilityRequest",this.requestHandlers.layerVisibilityHandler),e.removeRequestHandler("MapModulePlugin.MapMoveByLayerContentRequest",this.requestHandlers.layerContentHandler);for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterRearrangeSelectedMapLayerEvent:function(e){this._afterRearrangeSelectedMapLayerEvent(e)},MapMoveStartEvent:function(){this._visibilityCheckOrder++,this._previousTimer&&(clearTimeout(this._previousTimer),this._previousTimer=null)},AfterMapMoveEvent:function(){this._scheduleVisiblityCheck()},AfterMapLayerAddEvent:function(e){this._parseGeometryForLayer(e.getMapLayer()),this._scheduleVisiblityCheck()}},_scheduleVisiblityCheck:function(){var e=this;this._previousTimer&&(clearTimeout(this._previousTimer),this._previousTimer=null),this._visibilityCheckOrder++,this._previousTimer=setTimeout(function(){e._checkLayersVisibility(e._visibilityCheckOrder)},this._visibilityPollingInterval)},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(){},_parseGeometryForLayer:function(e){if(e.getGeometry&&0==e.getGeometry().length){var t=e.getGeometryWKT();if(!t)return;var i=new OpenLayers.Format.WKT,a=i.read(t);if(a){a.constructor!=Array&&(a=[a]);for(var n=[],s=0;s<a.length;++s)n.push(a[s].geometry);e.setGeometry(n)}}},_checkLayersVisibility:function(e){if(e==this._visibilityCheckOrder){for(var t=this._sandbox.findAllSelectedMapLayers(),i=0;i<t.length;++i){var a=t[i];a.isVisible()&&this.notifyLayerVisibilityChanged(a)}this._visibilityCheckScheduled=!1}},_isInScale:function(e){var t=this._sandbox.getMap().getScale();return e.isInScale(t)},isInGeometry:function(e){var t=e.getGeometry();if(!t)return!0;if(0==t.length)return!0;for(var i=this.getMap().getExtent(),a=0;a<t.length;++a){var n=t[a].getBounds();if(n&&n.intersectsBounds(i))return!0}return!1},notifyLayerVisibilityChanged:function(e){var t=e.isVisible(),i=e.isVisible();e.isVisible()&&(t=this._isInScale(e),i=this.isInGeometry(e)),this.getMap();var a=this.getMapModule().getOLMapLayers(e.getId()),n=a.length?a[0]:null;t&&i&&e.isVisible()?n&&!n.getVisibility()&&(n.setVisibility(!0),n.display(!0)):n&&n.getVisibility()&&(n.setVisibility(!1),n.display(!1));var s=this._sandbox.getEventBuilder("MapLayerVisibilityChangedEvent")(e,t,i);this._sandbox.notifyAll(s)},_afterRearrangeSelectedMapLayerEvent:function(){var e=this._sandbox.findAllSelectedMapLayers(),t=0,i=this._map.layers.length,a=this._map.getLayersByName("Markers");a.length>0&&(this._map.setLayerIndex(a[0],i),i--);for(var n=0,s=e.length;s>n;n++)for(var r=this.getMapModule().getOLMapLayers(e[n].getId()),o=0,l=r.length;l>o;o++)this._map.setLayerIndex(r[o],t),t++}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapLayerVisibilityRequest",function(e,t){this._creator=null,this._mapLayerId=e,this._visible=t},{__name:"MapModulePlugin.MapLayerVisibilityRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId},getVisible:function(){return this._visible}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapLayerVisibilityRequestHandler",function(e,t){this.sandbox=e,this.layersPlugin=t},{handleRequest:function(e,t){var i=t.getMapLayerId(),a=this.sandbox.findMapLayerFromSelectedMapLayers(i);if(a&&a.isVisible()!=t.getVisible()){a.setVisible(t.getVisible()),this.layersPlugin.getMap();for(var n=this.layersPlugin.getMapModule(),s=n.getOLMapLayers(a.getId()),r=0;r<s.length;r++)s[r].setVisibility(a.isVisible()),s[r].display(a.isVisible());this.layersPlugin.notifyLayerVisibilityChanged(a)}}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapMoveByLayerContentRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"MapModulePlugin.MapMoveByLayerContentRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapMoveByLayerContentRequestHandler",function(e,t){this.sandbox=e,this.layersPlugin=t},{handleRequest:function(e,t){var i=t.getMapLayerId(),a=this.sandbox.findMapLayerFromSelectedMapLayers(i);if(a){var n=this.layersPlugin.getMapModule().getClosestZoomLevel(a.getMinScale(),a.getMaxScale());if(this.layersPlugin.getMapModule().setZoomLevel(n,!0),a.getGeometry().length>0){var s=this.layersPlugin.isInGeometry(a);if(!s){var r=a.getGeometry()[0].getCentroid();this.layersPlugin.getMapModule().moveMapToLanLot(new OpenLayers.LonLat(r.x,r.y))}}this.layersPlugin.getMapModule().notifyMoveEnd(),this.layersPlugin._checkLayersVisibility(this.layersPlugin._visibilityCheckOrder)}}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.MapLayerVisibilityChangedEvent",function(e,t,i){this._mapLayer=e,this._inScale=1==t,this._geomMatch=0!=i},{__name:"MapLayerVisibilityChangedEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer},isInScale:function(){return this._inScale},isGeometryMatch:function(){return this._geomMatch}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.WmsLayerPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={}},{__name:"WmsLayerPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("wmslayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("wmslayer",null)},init:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this._afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this._afterChangeMapLayerOpacityEvent(e)},AfterChangeMapLayerStyleEvent:function(e){this._afterChangeMapLayerStyleEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var a=e[i],n=a.getId();a.isLayerOfType("WMS")&&(t.printDebug("preselecting "+n),this._addMapLayerToMap(a,!0,a.isBaseLayer()))}},_afterMapLayerAddEvent:function(e){this._addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},_addMapLayerToMap:function(e,t,i){if(e.isLayerOfType("WMS")){var a=this._map.getLayersByName("Markers");if(a)for(var n=0;n<a.length;n++)a[n]&&this._map.removeLayer(a[n],!1);var s=[],r="layer_";(e.isGroupLayer()||e.isBaseLayer()||1==i)&&e.getSubLayers().length>0?(s=e.getSubLayers(),r="basemap_"):s.push(e);for(var o=0,l=s.length;l>o;o++){var u=s[o],c={layers:u.getWmsName(),transparent:!0,id:u.getId(),styles:u.getCurrentStyle().getName(),format:"image/png"},h={layerId:u.getWmsName(),isBaseLayer:!1,displayInLayerSwitcher:!1,visibility:!0,buffer:0},d=u.getParams(),p=u.getOptions();if(u.getMaxScale()||u.getMinScale()){var f=this.getMapModule().calculateLayerResolutions(u.getMaxScale(),u.getMinScale());h.resolutions=f}for(var m in d)c[m]=d[m];for(var m in p)h[m]=p[m];var g=new OpenLayers.Layer.WMS(r+u.getId(),u.getWmsUrls(),c,h);g.opacity=u.getOpacity()/100,this._map.addLayer(g),this._sandbox.printDebug("#!#! CREATED OPENLAYER.LAYER.WMS for "+u.getId()),t?this._map.setLayerIndex(g,this._map.layers.length):this._map.setLayerIndex(g,0)}if(a)for(var n=0;n<a.length;n++)a[n]&&this._map.addLayer(a[n])}},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this._removeMapLayerFromMap(t)},_removeMapLayerFromMap:function(e){if(e.isLayerOfType("WMS"))if(e.isBaseLayer()||e.isGroupLayer())if(e.getSubLayers().length>0)for(var t=0;t<e.getSubLayers().length;t++){var i=e.getSubLayers()[t],a=this._map.getLayersByName("basemap_"+i.getId());a&&a[0]&&a[0].destroy&&a[0].destroy()}else{var a=this._map.getLayersByName("layer_"+e.getId());a[0].destroy()}else{var a=this._map.getLayersByName("layer_"+e.getId());a[0].destroy()}},getOLMapLayers:function(e){if(!e.isLayerOfType("WMS"))return null;if(e.isBaseLayer()||e.isGroupLayer()){if(e.getSubLayers().length>0){for(var t=[],i=0;i<e.getSubLayers().length;i++){var a=this._map.getLayersByName("basemap_"+e.getSubLayers()[i].getId());t.push(a[0])}return t}return this._map.getLayersByName("layer_"+e.getId())}return this._map.getLayersByName("layer_"+e.getId())},_afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WMS"))if(t.isBaseLayer()||t.isGroupLayer())if(t.getSubLayers().length>0)for(var i=0;i<t.getSubLayers().length;i++){var a=this._map.getLayersByName("basemap_"+t.getSubLayers()[i].getId());a[0].setOpacity(t.getOpacity()/100)}else{var a=this._map.getLayersByName("layer_"+t.getId());null!=a[0]&&a[0].setOpacity(t.getOpacity()/100)}else{this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var a=this._map.getLayersByName("layer_"+t.getId());null!=a[0]&&a[0].setOpacity(t.getOpacity()/100)}},_afterChangeMapLayerStyleEvent:function(e){if(e.getMapLayer().isLayerOfType("WMS")){var t=e.getMapLayer();if(!t.isBaseLayer()){var i=this._map.getLayersByName("layer_"+t.getId());null!=i&&i[0].mergeNewParams({styles:t.getCurrentStyle().getName()})}}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.VectorLayerPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this._sldFormat=new OpenLayers.Format.SLD({multipleSymbolizers:!1,namedLayersAsArray:!0})},{__name:"VectorLayerPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("vectorlayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("vectorlayer",null)},init:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this.registerVectorFormats(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this.afterMapLayerRemoveEvent(e)},FeaturesAvailableEvent:function(e){this.handleFeaturesAvailableEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var a=e[i],n=a.getId();a.isLayerOfType("VECTOR")&&(t.printDebug("preselecting "+n),this.addMapLayerToMap(a,!0,a.isBaseLayer()))}},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},registerVectorFormat:function(e,t){this._supportedFormats[e]=t},registerVectorFormats:function(){this.registerVectorFormat("application/json",new OpenLayers.Format.GeoJSON({})),this.registerVectorFormat("application/nlsfi-x-openlayers-feature",new function(){this.read=function(e){return e}})},addMapLayerToMap:function(e,t){if(e.isLayerOfType("VECTOR")){var i=this._map.getLayersByName("Markers");this._map.removeLayer(i[0],!1);var a=new OpenLayers.StyleMap,n={styleMap:a},s=e.getStyledLayerDescriptor();if(s){this._sandbox.printDebug(s);var r=this._sldFormat.read(s);window.styleInfo=r;var o=r.namedLayers[0].userStyles,l=o[0];a.styles["default"]=l}var u=new OpenLayers.Layer.Vector("layer_"+e.getId(),n);u.opacity=e.getOpacity()/100,this._map.addLayer(u),this._sandbox.printDebug("#!#! CREATED VECTOR / OPENLAYER.LAYER.VECTOR for "+e.getId()),t?this._map.setLayerIndex(u,this._map.layers.length):this._map.setLayerIndex(u,0),this._map.addLayer(i[0])}},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.removeMapLayerFromMap(t)},removeMapLayerFromMap:function(e){if(e.isLayerOfType("VECTOR")){var t=this._map.getLayersByName("layer_"+e.getId());t[0].destroy()}},getOLMapLayers:function(e){return e.isLayerOfType("VECTOR")?this._map.getLayersByName("layer_"+e.getId()):void 0},handleFeaturesAvailableEvent:function(e){var t=e.getMapLayer(),i=e.getMimeType(),a=e.getFeatures(),n=e.getOp(),s=this._map.getLayersByName("layer_"+t.getId())[0];if(s){n&&"replace"==n&&s.removeFeatures(s.features);var r=this._supportedFormats[i];if(r){var o=r.read(a);s.addFeatures(o)}}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.GeoLocationPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._locationIsSet=!1},{__name:"GeoLocationPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!1},init:function(){},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this),this._setupLocation()},stopPlugin:function(e){e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},hasSetLocation:function(){return this._locationIsSet},_setupLocation:function(){var e=this,t=function(t,i){var a=e.getMapModule().transformCoordinates(new OpenLayers.LonLat(t,i),"EPSG:4326");e.getMapModule().centerMap(a,6),e._locationIsSet=!0};if(navigator.geolocation)navigator.geolocation.getCurrentPosition(function(e){var i=e.coords.latitude,a=e.coords.longitude;t(a,i)},function(){},{maximumAge:36e5,timeout:6e3});else if("function"==typeof window.geoip_latitude&&"function"==typeof window.geoip_longitude){var i=geoip_latitude(),a=geoip_longitude();t(a,i)}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.ToolSelectionRequest",function(e){this._toolId=e},{tools:{navigate:"map_control_navigate_tool",zoom:"map_control_zoom_tool",previous:"map_control_tool_prev",next:"map_control_tool_prev",measure:"map_control_measure_tool",measure_area:"map_control_measure_area_tool",select:"map_control_select_tool",draw_area:"map_control_draw_area_tool"},__name:"ToolSelectionRequest",getName:function(){return this.__name},getToolId:function(){return this._toolId},setToolId:function(e){this._toolId=e},getNamespace:function(){return-1==this._toolId.indexOf(".")?"":this._toolId.substring(0,this._toolId.lastIndexOf("."))},getToolName:function(){return-1==this._toolId.indexOf(".")?this._toolId:this._toolId.substring(this._toolId.lastIndexOf("."))}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.ToolSelectionHandler",function(e,t){this.sandbox=e,this.controlsPlugin=t},{handleRequest:function(e,t){t.getToolId(),t.getNamespace();var i=t.getToolName();if("map_control_tool_prev"==i){var a=this.sandbox.findRegisteredModuleInstance("StateHandler");a&&a.historyMovePrevious()}else if("map_control_tool_next"==i){var a=this.sandbox.findRegisteredModuleInstance("StateHandler");a&&a.historyMoveNext()}else if("map_control_select_tool"==i){var n=this.sandbox.findRegisteredModuleInstance("SketchLayerPlugin");n&&n.clearBbox()}else"map_control_zoom_tool"==i&&this.controlsPlugin._zoomBoxTool?this.controlsPlugin._zoomBoxTool.activate():"map_control_measure_tool"==i&&this.controlsPlugin._measureControls?this.controlsPlugin._measureControls.line.activate():"map_control_measure_area_tool"==i&&this.controlsPlugin._measureControls&&this.controlsPlugin._measureControls.area.activate()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapLayerUpdateRequest",function(e,t,i){this._layerId=e,this._forced=1==t,this._parameters=i},{__name:"MapModulePlugin.MapLayerUpdateRequest",getName:function(){return this.__name},getLayerId:function(){return this._layerId},isForced:function(){return this._forced},getParameters:function(){return this._parameters},setParameters:function(e){this._parameters=e}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapLayerUpdateRequestHandler",function(e,t){this.sandbox=e,this.mapModule=t},{handleRequest:function(e,t){var i=t.getLayerId(),a=t.isForced(),n=t.getParameters(),s=this.sandbox,r=s.findMapLayerFromSelectedMapLayers(i);if(r)if(n&&r.isLayerOfType("WMS")){var o=this.mapModule.getOLMapLayers(i),l=0;if(o){l=o.length;for(var u=0;u<o.length;++u)o[u].mergeNewParams(n)}this.sandbox.printDebug("[MapLayerUpdateRequestHandler] WMS layer / merge new params: "+i+", found "+l)}else{var o=this.mapModule.getOLMapLayers(i),l=0;if(o){l=o.length;for(var u=0;u<o.length;++u)o[u].redraw(a)}this.sandbox.printDebug("[MapLayerUpdateRequestHandler] Layer / update layer "+i+", found "+l)}}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapMoveRequestHandler",function(e,t){this.sandbox=e,this.mapModule=t},{handleRequest:function(e,t){var i=t.getCenterX(),a=t.getCenterY(),n=t.getMarker(),s=t.getZoom(),r=t.getSrsName(),o=new OpenLayers.LonLat(i,a);if(r&&this.mapModule.getProjection()!==r){var l=Proj4js.defs[r];if(!l)throw"SrsName not supported!";o=this.mapModule.transformCoordinates(o,r)}this.mapModule.moveMapToLanLot(o,s,!1),(s||0===s)&&("OpenLayers.Bounds"===s.CLASS_NAME?this.mapModule._map.zoomToExtent(s):this.mapModule._map.zoomTo(s)),this.mapModule._updateDomain(),n&&this.mapModule._drawMarker(),this.mapModule.notifyMoveEnd(),this.sandbox.printDebug("[MapMoveRequestHandler] map moved")}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.MapClickedEvent",function(e,t,i){this._lonlat=e,this._mouseX=Math.floor(t),this._mouseY=Math.floor(i)},{__name:"MapClickedEvent",getName:function(){return this.__name},getLonLat:function(){return this._lonlat},getMouseX:function(){return this._mouseX},getMouseY:function(){return this._mouseY}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.EscPressedEvent",function(){},{__name:"EscPressedEvent",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.GetInfoResultEvent",function(e){this._data=e},{__name:"GetInfoResultEvent",getName:function(){return this.__name},getData:function(){return this._data}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.MapSizeChangedEvent",function(e,t){this._width=e,this._height=t},{__name:"MapSizeChangedEvent",getName:function(){return this.__name},getWidth:function(){return this._width},getHeight:function(){return this._height}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.ClearHistoryRequest",function(){},{__name:"ClearHistoryRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.controls.ClearHistoryHandler",function(e,t){this.mapModule=t,this.sandbox=e},{handleRequest:function(){this.mapModule.clearNavigationHistory()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.Portti2Zoombar",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.__templates={},this.__elements={},this.__parent=null,this._slider=null,this._zoombar_messages={},this._suppressEvents=!1,this._conf=e},{__name:"Portti2Zoombar",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},hasUI:function(){return!0},setMapModule:function(e){this.mapModule=e,e&&(this._map=e.getMap(),this.pluginName=e.getName()+this.__name)},init:function(){this.__templates.zoombar=jQuery('<div class="oskariui mapplugin pzbDiv"><div class="pzbDiv-plus"  title="Katu"></div><input type=\'hidden\' /><div class="slider"></div><div class="pzbDiv-minus"  title="Koko Maa"></div></div>')},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this._draw(),this._setZoombarValue(this._map.getZoom())},stopPlugin:function(e){this.__elements.zoombarSlider&&(this.__elements.zoombarSlider.remove(),this._slider.remove(),delete this.__elements.zoombarSlider),e.unregister(this),this._sandbox=null},_draw:function(){var e=this;e.__parent||(e.__parent=this._map.div),e.__elements.zoombarSlider||(e.__elements.zoombarSlider=e.__templates.zoombar.clone());var t="pzb-input-"+this.getName(),i="pzb-slider-"+this.getName(),a=e.__elements.zoombarSlider.find("div.slider");e.__elements.zoombarSlider.find("input").attr("id",t),a.attr("id",i),e.__elements.zoombarSlider.mousedown(function(e){e.stopPropagation()}),jQuery(e.__parent).append(e.__elements.zoombarSlider);var a=e.__elements.zoombarSlider.find("div.slider");a.css("height",11*this._map.getNumZoomLevels()+"px"),e._slider=a.slider({orientation:"vertical",range:"min",min:0,max:this._map.getNumZoomLevels()-1,value:this._map.getZoom(),slide:function(t,i){e.getMapModule().zoomTo(i.value)}});var n=e.__elements.zoombarSlider.find(".pzbDiv-plus");n.bind("click",function(){e._slider.slider("value")<e._map.getNumZoomLevels()&&e.getMapModule().zoomTo(e._slider.slider("value")+1)});var s=e.__elements.zoombarSlider.find(".pzbDiv-minus");s.bind("click",function(){e._slider.slider("value")>0&&e.getMapModule().zoomTo(e._slider.slider("value")-1)}),this._conf&&this._conf.location&&e.setZoombarLocation(this._conf.location,e.__elements.zoombarSlider)},_setZoombarValue:function(e){var t=this;t._slider&&(this._suppressEvents=!0,t._slider.slider("value",e),this._suppressEvents=!1)},setZoombarLocation:function(e,t){t||(t=this.__elements.zoombarSlider),e.top&&(t.css("bottom","auto"),t.css("top",e.top)),e.left&&(t.css("right","auto"),t.css("left",e.left)),e.right&&(t.css("left","auto"),t.css("right",e.right)),e.bottom&&(t.css("top","auto"),t.css("bottom",e.bottom))},eventHandlers:{AfterMapMoveEvent:function(e){if(this._sandbox){var t=this;t._setZoombarValue(e.getZoom())}}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},start:function(){},stop:function(){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.PanButtons",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.__templates={},this.__elements={},this.__parent=null,this.__conf=e,this.__prestart=null},{__name:"PanButtons",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},hasUI:function(){return!0},setMapModule:function(e){this.mapModule=e,e&&(this._map=e.getMap(),this.pluginName=e.getName()+this.__name)
},init:function(){var e=(new Date).getTime()+"";this.__templates.pan=jQuery('<div class="mapplugin panbuttonDiv"><div>  <img class="panbuttonDivImg" usemap="#panbuttons_'+e+'">'+'    <map name="panbuttons_'+e+'">'+'      <area shape="circle" '+'class="panbuttons_center" '+'coords="45,45,20" href="#">'+'      <area shape="polygon" '+'class="panbuttons_left" '+'coords="13,20,25,30,20,45,27,65,13,70,5,45" '+'href="#">'+'      <area shape="polygon" '+'class="panbuttons_up" '+'coords="30,8,45,4,60,8,60,23,45,20,30,23" '+'href="#">'+'      <area shape="polygon" '+'class="panbuttons_right" '+'coords="79,20,67,30,72,45,65,65,79,70,87,45" '+'href="#">'+'      <area shape="polygon" '+'class="panbuttons_down" '+'coords="30,82,45,86,60,82,60,68,45,70,30,68" '+'href="#">'+"    </map>"+"  </img>"+"</div>"+"</div>")},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);var t=null;if(this._map.div&&(t=jQuery(this._map.div).find(".pzbDiv")),this.__conf&&this.__conf.location&&this.__conf.location.top&&t){var i=this,a=i.__conf.location.top;"auto"==a?a=10:a.indexOf("px")>=0&&(a=a.substring(0,a.indexOf("px"))),jQuery(i._map.div).height();var n="auto",s=t.css("top"),r=t.css("bottom");s||(s="auto"),r||(r="auto"),null==i.__prestart&&(i.__prestart={zbtop:s,zbbtm:r}),a=10,n="auto",s=110,r="auto","auto"!==s&&(s+="px"),"auto"!==r&&(r+="px"),t.css("top",s),t.css("bottom",r),"auto"!==a&&(a+="px"),"auto"!==n&&(n+="px"),i.__conf.location.top=a,i.__conf.location.bottom=n,window.setTimeout(function(){var e=i.__elements.panbuttons;e&&(e.css("top",a),e.css("bottom","auto"))},50)}this._draw()},stopPlugin:function(e){this.__elements.panbuttons&&(this.__elements.panbuttons.remove(),delete this.__elements.panbuttons),this._map.div&&this.__prestart&&(zb=jQuery(this._map.div).find(".pzbDiv"),zb&&(zb.css("top",this.__prestart.zbtop),zb.css("bottom",this.__prestart.zbbtm))),e.unregister(this)},_draw:function(){var e=this;e.__parent||(e.__parent=this._map.div),e.__elements.panbuttons||(e.__elements.panbuttons=e.__templates.pan.clone());var t=e.__elements.panbuttons;jQuery(e.__parent).append(t),e.__conf&&e.__conf.location&&(e.__conf.location.top&&(t.css("bottom","auto"),t.css("top",e.__conf.location.top)),e.__conf.location.left&&(t.css("right","auto"),t.css("left",e.__conf.location.left)),e.__conf.location.right&&(t.css("left","auto"),t.css("right",e.__conf.location.right)),e.__conf.location.bottom&&(t.css("top","auto"),t.css("bottom",e.__conf.location.bottom)));var i=this.getMapModule().getImageUrl()+"/framework/bundle/mapmodule-plugin/plugin/panbuttons/images/",a=t.find(".panbuttonDivImg");a.attr("src",i+"empty.png");var n=t.find(".panbuttons_center");n.bind("mouseover",function(){a.addClass("root")}),n.bind("mouseout",function(){a.removeClass("root")}),n.bind("click",function(){var t="StateHandler.SetStateRequest",i=e.getMapModule(),a=i.getSandbox(),n=a.getRequestBuilder(t);n?a.request(e,n()):a.resetState()});var s=t.find(".panbuttons_left");s.bind("mouseover",function(){a.addClass("left")}),s.bind("mouseout",function(){a.removeClass("left")}),s.bind("click",function(){e.getMapModule().panMapByPixels(-100,0,!0)});var r=t.find(".panbuttons_right");r.bind("mouseover",function(){a.addClass("right")}),r.bind("mouseout",function(){a.removeClass("right")}),r.bind("click",function(){e.getMapModule().panMapByPixels(100,0,!0)});var o=t.find(".panbuttons_up");o.bind("mouseover",function(){a.addClass("up")}),o.bind("mouseout",function(){a.removeClass("up")}),o.bind("click",function(){e.getMapModule().panMapByPixels(0,-100,!0)});var l=t.find(".panbuttons_down");l.bind("mouseover",function(){a.addClass("down")}),l.bind("mouseout",function(){a.removeClass("down")}),l.bind("click",function(){e.getMapModule().panMapByPixels(0,100,!0)}),t.mousedown(function(e){var t=Math.round(.5*a[0].width),i=a.offset(),n=i.left+t,s=i.top+t;Math.sqrt(Math.pow(n-e.pageX,2)+Math.pow(s-e.pageY,2))<t&&e.stopPropagation()})},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},start:function(){},stop:function(){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.event.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/event/event.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"event-base","Bundle-Name":"mapframework.event.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.event.Bundle",Title:" mapframework.event.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("event-base","Oskari.mapframework.event.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.event.Event",function(){throw"mapframework.event.Event should not be used"},{getName:function(){throw"Running default implementation of Event.getName(). implement your own!"},setCreator:function(e){this._creator=e},getCreator:function(){return this._creator}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.MapFullBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.mapfull.MapFullBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/enhancement/start-map-with-link-enhancement.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/request/MapResizeEnabledRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/request/MapResizeEnabledRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/request/MapWindowFullScreenRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/request/MapWindowFullScreenRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapfull/css/style.css"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"mapfull","Bundle-Name":"mapframework.mapfull.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"mapframework.mapfull.Bundle",Title:"mapframework.mapfull.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("mapfull","Oskari.mapframework.bundle.mapfull.MapFullBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.MapFullBundleInstance",function(){this.map=null,this.core=null,this.sandbox=null,this.mapmodule=null,this.state=void 0,this.mapDivId="mapdiv",this.contentMapDivId="contentMap"},{getMapModule:function(){return this.mapmodule},getSandbox:function(){return this.sandbox},_createUi:function(){function e(){if(null==t.resizeEnabled||t.resizeEnabled){var e=jQuery("#"+t.contentMapDivId),a=jQuery("#"+t.mapDivId);a.height(jQuery(window).height()),e.height(jQuery(window).height());var n=e.find(".oskariui-menutoolbar");n.length>0&&n.is(":visible")&&a.height(jQuery(window).height()-n.height()),i.updateSize()}}var t=this,i=Oskari.clazz.create("Oskari.mapframework.ui.module.common.MapModule","Main",this.conf.imageLocation,this.conf.mapOptions);this.mapmodule=i;var a=this.sandbox.register(i);if(this.conf.size)jQuery("#"+this.mapDivId).width(this.conf.size.width),jQuery("#"+this.mapDivId).height(this.conf.size.height);else{var n;jQuery(window).resize(function(){clearTimeout(n),n=setTimeout(e,100)}),e()}if(i.start(this.sandbox),a.render(this.mapDivId),this.conf.plugins)for(var s=this.conf.plugins,r=0;r<s.length;r++)s[r].instance=Oskari.clazz.create(s[r].id,s[r].config),i.registerPlugin(s[r].instance),i.startPlugin(s[r].instance);this.map=a},start:function(){Proj4js.defs={"EPSG:3067":"+proj=utm +zone=35 +ellps=GRS80 +units=m +no_defs","EPSG:4326":"+title=WGS 84 +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"};var e=this,t=e.conf;e.conf.projectionDefs&&(Proj4js.defs=e.conf.projectionDefs),Oskari.getLang();var i=Oskari.clazz.create("Oskari.mapframework.core.Core");this.core=i;var a=i.getSandbox();this.sandbox=a;var n=(t?t.sandbox:null)||"sandbox";Oskari.setSandbox(n,a),t&&(t.mapElement&&(this.mapDivId=t.mapElement),t.mapContainer&&(this.contentMapDivId=t.mapContainer)),a.setUser(t.user),a.setAjaxUrl(t.globalMapAjaxUrl);var s=this._createServices(t),r=[];r.push(Oskari.clazz.create("Oskari.mapframework.enhancement.mapfull.StartMapWithLinkEnhancement")),i.init(s,r),this._createUi();var o=a.getService("Oskari.mapframework.service.MapLayerService"),l=t.layers;if(l)for(var u=0;u<l.length;u++){var c=o.createMapLayer(l[u]);o.addLayer(c,!0)}a.registerAsStateful(this.mediator.bundleId,this);var h=!1;if(this.mapmodule.isPluginActivated("GeoLocationPlugin")){var d=this.mapmodule.getPluginInstance("GeoLocationPlugin");h=d.hasSetLocation()}this.setState(this.state,h),e.mapResizeEnabledRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequestHandler",e),e.mapWindowFullScreenRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequestHandler",e),a.addRequestHandler("MapFull.MapResizeEnabledRequest",e.mapResizeEnabledRequestHandler),a.addRequestHandler("MapFull.MapWindowFullScreenRequest",e.mapWindowFullScreenRequestHandler)},_teardownState:function(e){for(var t=this.sandbox.findAllSelectedMapLayers(),i=this.sandbox.getRequestBuilder("RemoveMapLayerRequest"),a=0;a<t.length;a++)this.sandbox.request(e.getName(),i(t[a].getId()))},_createServices:function(e){var t=[],i=Oskari.clazz.create("Oskari.mapframework.service.MapLayerService",e.globalMapAjaxUrl+"action_route=GetMapLayers&lang="+Oskari.getLang(),this.core.getSandbox());return t.push(i),"true"==e.disableDevelopmentMode&&core.disableDebug(),t},update:function(){},stop:function(){this.sandbox.unregisterStateful(this.mediator.bundleId),alert("Stopped!")},setState:function(e,t){var i=this.sandbox.findRegisteredModuleInstance("MainMapModule");if(this._teardownState(i),e.selectedLayers)for(var a=this.sandbox.getRequestBuilder("AddMapLayerRequest"),n=this.sandbox.getRequestBuilder("ChangeMapLayerOpacityRequest"),s=this.sandbox.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest"),r=this.sandbox.getRequestBuilder("ChangeMapLayerStyleRequest"),o=e.selectedLayers.length,l=0;o>l;++l){var u=e.selectedLayers[l];this.sandbox.request(i.getName(),a(u.id,!0)),this.sandbox.request(i.getName(),s(u.id,u.hidden!==!0)),u.style&&this.sandbox.request(i.getName(),r(u.id,u.style)),u.opacity&&this.sandbox.request(i.getName(),n(u.id,u.opacity))}e.east&&t!==!0&&this.sandbox.getMap().moveTo(e.east,e.north,e.zoom),this.sandbox.syncMapState(!0)},getState:function(){var e=this.sandbox.getMap(),t=this.sandbox.findAllSelectedMapLayers();e.getZoom();for(var i=e.getX(),a=e.getY(),n={north:a,east:i,zoom:e.getZoom(),srs:e.getSrsName(),selectedLayers:[]},s=0;s<t.length;s++){var r=t[s],o={id:r.getId(),opacity:r.getOpacity()};r.isVisible()||(o.hidden=!0),r.getCurrentStyle&&r.getCurrentStyle()&&r.getCurrentStyle().getName()&&"!default!"!=r.getCurrentStyle().getName()&&(o.style=r.getCurrentStyle().getName()),n.selectedLayers.push(o)}return n},getStateParameters:function(){var e=this.getState(),t="zoomLevel="+e.zoom+"&coord="+e.east+"_"+e.north+"&mapLayers=",i=e.selectedLayers,a="",n=null,s=0,r=0;for(s=0,r=i.length;r>s;s++)n=i[s],n.hidden||(""!=a&&(a+=","),a+=n.id+"+"+n.opacity,a+=n.style?"+"+n.style:"+");return t+a},toggleFullScreen:function(){jQuery("#"+this.contentMapDivId).toggleClass("oskari-map-window-fullscreen"),this.mapmodule.getMap().updateSize()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.userinterface.Stateful"]}),Oskari.clazz.define("Oskari.mapframework.enhancement.mapfull.StartMapWithLinkEnhancement",function(){},{enhance:function(e){function t(e){return e===!0||"true"===e}e.printDebug("Checking if map is started with link...");var i=e.getRequestParameter("coord"),a=e.getRequestParameter("zoomLevel");e.getRequestParameter("mapLayers");var n=e.getRequestParameter("showMarker"),s=e.getRequestParameter("isCenterMarker"),r=e.getRequestParameter("keepLayersOrder");if(null===r&&(r=!0),e.getMap().setMarkerVisible(t(n)||t(s)),null!==i&&null!==a){var o;o=i.indexOf("_")>=0?i.split("_"):i.split("%20");var l=o[0],u=o[1];if(null===l||null===u)return e.printDebug("Could not parse link location. Skipping."),void 0;e.printDebug("This is startup by link, moving map..."),e.getMap().moveTo(l,u,a)}}},{protocol:["Oskari.mapframework.enhancement.Enhancement"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequest",function(e){this._creator=null,this._resizeEnabled=e},{__name:"MapFull.MapResizeEnabledRequest",getName:function(){return this.__name},getResizeEnabled:function(){return this._resizeEnabled}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequestHandler",function(e){this.mapfull=e},{handleRequest:function(e,t){this.mapfull.resizeEnabled=t.getResizeEnabled()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequest",function(){this._creator=null},{__name:"MapFull.MapWindowFullScreenRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequestHandler",function(e){this.mapfull=e},{handleRequest:function(){this.mapfull.toggleFullScreen()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.core.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/core/core.js"},{type:"text/javascript",src:"../../../../sources/framework/core/core-enhancement-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/core/core-key-listener-methods.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"core-base","Bundle-Name":"mapframework.core.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.core.Bundle",Title:" mapframework.core.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("core-base","Oskari.mapframework.core.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.core.Core",function(){this._selectedLayers=new Array,this._mapLayersHighlighted=new Array,this._map=null,this._sandbox=Oskari.clazz.create("Oskari.mapframework.sandbox.Sandbox",this),Oskari.$("sandbox")||Oskari.$("sandbox",this._sandbox),this._services=[],this._servicesByQName={},this._debug=!1,this._ctrlKeyDown=!1,this._allowMultipleHighlightLayers=!1,this._availableRequestsByName={},this._availableEventsByName={},this.externalHandlerCls={}},{init:function(e,t){if(this.printDebug("Initializing core..."),this._sandbox,this._services=e,e)for(var i=0;i<e.length;i++)this.registerService(e[i]);this.printDebug("Sandbox ready, building up domain..."),this._map=Oskari.clazz.create("Oskari.mapframework.domain.Map"),this.enhancements=t,this._doEnhancements(this.enhancements),this.printDebug("Modules started. Core ready.")},dispatch:function(e){this._sandbox.notifyAll(e)},defaultRequestHandlers:{AddMapLayerRequest:function(e){return this._handleAddMapLayerRequest(e),!0},RemoveMapLayerRequest:function(e){return this._handleRemoveMapLayerRequest(e),!0},ShowMapLayerInfoRequest:function(e){return this._handleShowMapLayerInfoRequest(e),!0},RearrangeSelectedMapLayerRequest:function(e){return this._handleRearrangeSelectedMapLayerRequest(e),!0},ChangeMapLayerOpacityRequest:function(e){return this._handleChangeMapLayerOpacityRequest(e),!0},ChangeMapLayerStyleRequest:function(e){return this._handleChangeMapLayerStyleRequest(e),!0},HighlightMapLayerRequest:function(e){return this._handleHighlightMapLayerRequest(e),!0},HighlightWFSFeatureRequest:function(e){return this.handleHighlightWFSFeatureRequest(e),!0},HideMapMarkerRequest:function(e){return this._handleHideMapMarkerRequest(e),!0},DimMapLayerRequest:function(e){return this._handleDimMapLayerRequest(e.getMapLayerId()),!0},CtrlKeyDownRequest:function(){return this._handleCtrlKeyDownRequest(),!0},CtrlKeyUpRequest:function(){return this._handleCtrlKeyUpRequest(),!0},__default:function(e){return this.printWarn("!!!"),this.printWarn("  There is no handler for"),this.printWarn("  '"+e.getName()+"'"),!1}},processRequest:function(e){var t=e.getName(),i=this.defaultRequestHandlers[t];if(i)rv=i.apply(this,[e]);else{var a=this.externalHandlerCls[t];a?rv=a.handleRequest(this,e):(i=this.defaultRequestHandlers.__default,rv=i.apply(this,[e]))}return delete e,rv},addRequestHandler:function(e,t){this.externalHandlerCls[e]=t},removeRequestHandler:function(e,t){this.externalHandlerCls[e]===t&&(this.externalHandlerCls[e]=null)},_getQNameForRequest:function(e){var t=this._availableRequestsByName[e];if(!t){this.printDebug("#!#!# ! Updating request metadata...");var i=Oskari.clazz.protocol("Oskari.mapframework.request.Request");for(p in i){var a=i[p],n=a._class.prototype.getName();this._availableRequestsByName[n]=p}this.printDebug("#!#!# ! Finished Updating request metadata..."),t=this._availableRequestsByName[e]}return t},getRequestBuilder:function(e){var t=this._getQNameForRequest(e);return t?Oskari.clazz.builder(t):void 0},_getQNameForEvent:function(e){var t=this._availableEventsByName[e];if(!t){this.printDebug("#!#!# ! Updating event metadata...");var i=Oskari.clazz.protocol("Oskari.mapframework.event.Event");for(p in i){var a=i[p],n=a._class.prototype.getName();this._availableEventsByName[n]=p}this.printDebug("#!#!# ! Finished Updating event metadata..."),t=this._availableEventsByName[e]}return t},getEventBuilder:function(e){var t=this._getQNameForEvent(e);return t?Oskari.clazz.builder(t):void 0},disableDebug:function(){this._debug=!1},enableDebug:function(){this._debug=!0},printDebug:function(e){this._debug&&null!=window.console&&(null!=window.console.debug?console.debug(e):null!=window.console.log&&console.log(e))},printWarn:function(e){null!=window.console&&console.warn(e)},registerService:function(e){this._servicesByQName[e.getQName()]=e},getService:function(e){return this._servicesByQName[e]},getMap:function(){return this._map},getSandbox:function(){return this._sandbox},getRequestParameter:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",i=new RegExp(t),a=i.exec(window.location.href);return null==a?null:a[1]},getObjectName:function(e){return e.__name},getObjectCreator:function(e){return e._creator},setObjectCreator:function(e,t){e._creator=t},copyObjectCreatorToFrom:function(e,t){e._creator=t._creator}}),Oskari.clazz.category("Oskari.mapframework.core.Core","enhancement-methods",{_doEnhancements:function(e){for(var t=0;t<e.length;t++)e[t].enhance(this)}}),Oskari.clazz.category("Oskari.mapframework.core.Core","feature-key-listener-methods",{_handleCtrlKeyDownRequest:function(){this._ctrlKeyDown=!0},_handleCtrlKeyUpRequest:function(){this._ctrlKeyDown=!1},isCtrlKeyDown:function(){return this._ctrlKeyDown}}),Oskari.clazz.define("Oskari.mapframework.bundle.oskariui.OskariUIBundle",function(){this.conf={}},{create:function(){return this},update:function(){},start:function(){var e=this.conf.partsMap||{},t=Oskari.clazz.create("Oskari.framework.bundle.oskariui.DomManager",jQuery,e);Oskari.setDomManager(t)},stop:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/oskariui/jquery-ui-1.9.1.custom.min.js"},{type:"text/javascript",src:"../../../../libraries/jquery/plugins/jquery.base64.min.js"},{type:"text/css",src:"../../../../resources/framework/bundle/oskariui/css/jquery-ui-1.9.1.custom.css"},{type:"text/css",src:"../../../../resources/framework/bundle/oskariui/bootstrap-grid.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/oskariui/DomManager.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/oskariui/Layout.js"}],locales:[]},bundle:{manifest:{"Bundle-Identifier":"oskariui","Bundle-Name":"oskariui","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("oskariui","Oskari.mapframework.bundle.oskariui.OskariUIBundle"),function(e,t){function i(t,i){var n,s,r,o=t.nodeName.toLowerCase();return"area"===o?(n=t.parentNode,s=n.name,t.href&&s&&"map"===n.nodeName.toLowerCase()?(r=e("img[usemap=#"+s+"]")[0],!!r&&a(r)):!1):(/input|select|textarea|button|object/.test(o)?!t.disabled:"a"===o?t.href||i:i)&&a(t)}function a(t){return e.expr.filters.visible(t)&&!e(t).parents().andSelf().filter(function(){return"hidden"===e.css(this,"visibility")}).length}var n=0,s=/^ui-id-\d+$/;e.ui=e.ui||{},e.ui.version||(e.extend(e.ui,{version:"1.9.1",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),e.fn.extend({_focus:e.fn.focus,focus:function(t,i){return"number"==typeof t?this.each(function(){var a=this;setTimeout(function(){e(a).focus(),i&&i.call(a)},t)}):this._focus.apply(this,arguments)},scrollParent:function(){var t;return t=e.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(e.css(this,"position"))&&/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!t.length?e(document):t},zIndex:function(i){if(i!==t)return this.css("zIndex",i);if(this.length)for(var a,n,s=e(this[0]);s.length&&s[0]!==document;){if(a=s.css("position"),("absolute"===a||"relative"===a||"fixed"===a)&&(n=parseInt(s.css("zIndex"),10),!isNaN(n)&&0!==n))return n;s=s.parent()}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++n)})},removeUniqueId:function(){return this.each(function(){s.test(this.id)&&e(this).removeAttr("id")})}}),e("<a>").outerWidth(1).jquery||e.each(["Width","Height"],function(i,a){function n(t,i,a,n){return e.each(s,function(){i-=parseFloat(e.css(t,"padding"+this))||0,a&&(i-=parseFloat(e.css(t,"border"+this+"Width"))||0),n&&(i-=parseFloat(e.css(t,"margin"+this))||0)}),i}var s="Width"===a?["Left","Right"]:["Top","Bottom"],r=a.toLowerCase(),o={innerWidth:e.fn.innerWidth,innerHeight:e.fn.innerHeight,outerWidth:e.fn.outerWidth,outerHeight:e.fn.outerHeight};e.fn["inner"+a]=function(i){return i===t?o["inner"+a].call(this):this.each(function(){e(this).css(r,n(this,i)+"px")})},e.fn["outer"+a]=function(t,i){return"number"!=typeof t?o["outer"+a].call(this,t):this.each(function(){e(this).css(r,n(this,t,!0,i)+"px")})}}),e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(i){return!!e.data(i,t)}}):function(t,i,a){return!!e.data(t,a[3])},focusable:function(t){return i(t,!isNaN(e.attr(t,"tabindex")))},tabbable:function(t){var a=e.attr(t,"tabindex"),n=isNaN(a);return(n||a>=0)&&i(t,!n)}}),e(function(){var t=document.body,i=t.appendChild(i=document.createElement("div"));i.offsetHeight,e.extend(i.style,{minHeight:"100px",height:"auto",padding:0,borderWidth:0}),e.support.minHeight=100===i.offsetHeight,e.support.selectstart="onselectstart"in i,t.removeChild(i).style.display="none"}),function(){var t=/msie ([\w.]+)/.exec(navigator.userAgent.toLowerCase())||[];e.ui.ie=t.length?!0:!1,e.ui.ie6=6===parseFloat(t[1],10)}(),e.fn.extend({disableSelection:function(){return this.bind((e.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(e){e.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),e.extend(e.ui,{plugin:{add:function(t,i,a){var n,s=e.ui[t].prototype;for(n in a)s.plugins[n]=s.plugins[n]||[],s.plugins[n].push([i,a[n]])},call:function(e,t,i){var a,n=e.plugins[t];if(n&&e.element[0].parentNode&&11!==e.element[0].parentNode.nodeType)for(a=0;a<n.length;a++)e.options[n[a][0]]&&n[a][1].apply(e.element,i)}},contains:e.contains,hasScroll:function(t,i){if("hidden"===e(t).css("overflow"))return!1;var a=i&&"left"===i?"scrollLeft":"scrollTop",n=!1;return t[a]>0?!0:(t[a]=1,n=t[a]>0,t[a]=0,n)},isOverAxis:function(e,t,i){return e>t&&t+i>e},isOver:function(t,i,a,n,s,r){return e.ui.isOverAxis(t,a,s)&&e.ui.isOverAxis(i,n,r)}}))}(jQuery),function(e,t){var i=0,a=Array.prototype.slice,n=e.cleanData;e.cleanData=function(t){for(var i,a=0;null!=(i=t[a]);a++)try{e(i).triggerHandler("remove")}catch(s){}n(t)},e.widget=function(t,i,a){var n,s,r,o,l=t.split(".")[0];t=t.split(".")[1],n=l+"-"+t,a||(a=i,i=e.Widget),e.expr[":"][n.toLowerCase()]=function(t){return!!e.data(t,n)},e[l]=e[l]||{},s=e[l][t],r=e[l][t]=function(e,t){return this._createWidget?(arguments.length&&this._createWidget(e,t),void 0):new r(e,t)},e.extend(r,s,{version:a.version,_proto:e.extend({},a),_childConstructors:[]}),o=new i,o.options=e.widget.extend({},o.options),e.each(a,function(t,n){e.isFunction(n)&&(a[t]=function(){var e=function(){return i.prototype[t].apply(this,arguments)},a=function(e){return i.prototype[t].apply(this,e)};return function(){var t,i=this._super,s=this._superApply;return this._super=e,this._superApply=a,t=n.apply(this,arguments),this._super=i,this._superApply=s,t}}())}),r.prototype=e.widget.extend(o,{widgetEventPrefix:o.widgetEventPrefix||t},a,{constructor:r,namespace:l,widgetName:t,widgetBaseClass:n,widgetFullName:n}),s?(e.each(s._childConstructors,function(t,i){var a=i.prototype;e.widget(a.namespace+"."+a.widgetName,r,i._proto)}),delete s._childConstructors):i._childConstructors.push(r),e.widget.bridge(t,r)},e.widget.extend=function(i){for(var n,s,r=a.call(arguments,1),o=0,l=r.length;l>o;o++)for(n in r[o])s=r[o][n],r[o].hasOwnProperty(n)&&s!==t&&(i[n]=e.isPlainObject(s)?e.isPlainObject(i[n])?e.widget.extend({},i[n],s):e.widget.extend({},s):s);return i},e.widget.bridge=function(i,n){var s=n.prototype.widgetFullName;e.fn[i]=function(r){var o="string"==typeof r,l=a.call(arguments,1),u=this;return r=!o&&l.length?e.widget.extend.apply(null,[r].concat(l)):r,o?this.each(function(){var a,n=e.data(this,s);return n?e.isFunction(n[r])&&"_"!==r.charAt(0)?(a=n[r].apply(n,l),a!==n&&a!==t?(u=a&&a.jquery?u.pushStack(a.get()):a,!1):void 0):e.error("no such method '"+r+"' for "+i+" widget instance"):e.error("cannot call methods on "+i+" prior to initialization; "+"attempted to call method '"+r+"'")}):this.each(function(){var t=e.data(this,s);t?t.option(r||{})._init():new n(r,this)}),u}},e.Widget=function(){},e.Widget._childConstructors=[],e.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(t,a){a=e(a||this.defaultElement||this)[0],this.element=e(a),this.uuid=i++,this.eventNamespace="."+this.widgetName+this.uuid,this.options=e.widget.extend({},this.options,this._getCreateOptions(),t),this.bindings=e(),this.hoverable=e(),this.focusable=e(),a!==this&&(e.data(a,this.widgetName,this),e.data(a,this.widgetFullName,this),this._on(this.element,{remove:function(e){e.target===a&&this.destroy()}}),this.document=e(a.style?a.ownerDocument:a.document||a),this.window=e(this.document[0].defaultView||this.document[0].parentWindow)),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:e.noop,_getCreateEventData:e.noop,_create:e.noop,_init:e.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData(e.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:e.noop,widget:function(){return this.element},option:function(i,a){var n,s,r,o=i;if(0===arguments.length)return e.widget.extend({},this.options);if("string"==typeof i)if(o={},n=i.split("."),i=n.shift(),n.length){for(s=o[i]=e.widget.extend({},this.options[i]),r=0;r<n.length-1;r++)s[n[r]]=s[n[r]]||{},s=s[n[r]];if(i=n.pop(),a===t)return s[i]===t?null:s[i];s[i]=a}else{if(a===t)return this.options[i]===t?null:this.options[i];o[i]=a}return this._setOptions(o),this},_setOptions:function(e){var t;for(t in e)this._setOption(t,e[t]);return this},_setOption:function(e,t){return this.options[e]=t,"disabled"===e&&(this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!t).attr("aria-disabled",t),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_on:function(t,i){var a,n=this;i?(t=a=e(t),this.bindings=this.bindings.add(t)):(i=t,t=this.element,a=this.widget()),e.each(i,function(i,s){function r(){return n.options.disabled===!0||e(this).hasClass("ui-state-disabled")?void 0:("string"==typeof s?n[s]:s).apply(n,arguments)}"string"!=typeof s&&(r.guid=s.guid=s.guid||r.guid||e.guid++);var o=i.match(/^(\w+)\s*(.*)$/),l=o[1]+n.eventNamespace,u=o[2];u?a.delegate(u,l,r):t.bind(l,r)})},_off:function(e,t){t=(t||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,e.unbind(t).undelegate(t)},_delay:function(e,t){function i(){return("string"==typeof e?a[e]:e).apply(a,arguments)}var a=this;return setTimeout(i,t||0)},_hoverable:function(t){this.hoverable=this.hoverable.add(t),this._on(t,{mouseenter:function(t){e(t.currentTarget).addClass("ui-state-hover")},mouseleave:function(t){e(t.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(t){this.focusable=this.focusable.add(t),this._on(t,{focusin:function(t){e(t.currentTarget).addClass("ui-state-focus")},focusout:function(t){e(t.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(t,i,a){var n,s,r=this.options[t];if(a=a||{},i=e.Event(i),i.type=(t===this.widgetEventPrefix?t:this.widgetEventPrefix+t).toLowerCase(),i.target=this.element[0],s=i.originalEvent,s)for(n in s)n in i||(i[n]=s[n]);return this.element.trigger(i,a),!(e.isFunction(r)&&r.apply(this.element[0],[i].concat(a))===!1||i.isDefaultPrevented())}},e.each({show:"fadeIn",hide:"fadeOut"},function(t,i){e.Widget.prototype["_"+t]=function(a,n,s){"string"==typeof n&&(n={effect:n});var r,o=n?n===!0||"number"==typeof n?i:n.effect||i:t;
n=n||{},"number"==typeof n&&(n={duration:n}),r=!e.isEmptyObject(n),n.complete=s,n.delay&&a.delay(n.delay),r&&e.effects&&(e.effects.effect[o]||e.uiBackCompat!==!1&&e.effects[o])?a[t](n):o!==t&&a[o]?a[o](n.duration,n.easing,s):a.queue(function(i){e(this)[t](),s&&s.call(a[0]),i()})}}),e.uiBackCompat!==!1&&(e.Widget.prototype._getCreateOptions=function(){return e.metadata&&e.metadata.get(this.element[0])[this.widgetName]})}(jQuery),function(e){var t=!1;e(document).mouseup(function(){t=!1}),e.widget("ui.mouse",{version:"1.9.1",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var t=this;this.element.bind("mousedown."+this.widgetName,function(e){return t._mouseDown(e)}).bind("click."+this.widgetName,function(i){return!0===e.data(i.target,t.widgetName+".preventClickEvent")?(e.removeData(i.target,t.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(i){if(!t){this._mouseStarted&&this._mouseUp(i),this._mouseDownEvent=i;var a=this,n=1===i.which,s="string"==typeof this.options.cancel&&i.target.nodeName?e(i.target).closest(this.options.cancel).length:!1;return n&&!s&&this._mouseCapture(i)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){a.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(i)&&this._mouseDelayMet(i)&&(this._mouseStarted=this._mouseStart(i)!==!1,!this._mouseStarted)?(i.preventDefault(),!0):(!0===e.data(i.target,this.widgetName+".preventClickEvent")&&e.removeData(i.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(e){return a._mouseMove(e)},this._mouseUpDelegate=function(e){return a._mouseUp(e)},e(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),i.preventDefault(),t=!0,!0)):!0}},_mouseMove:function(t){return!e.ui.ie||document.documentMode>=9||t.button?this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,t)!==!1,this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted):this._mouseUp(t)},_mouseUp:function(t){return e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,t.target===this._mouseDownEvent.target&&e.data(t.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(t)),!1},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}})}(jQuery),function(e,t){function i(e,t,i){return[parseInt(e[0],10)*(d.test(e[0])?t/100:1),parseInt(e[1],10)*(d.test(e[1])?i/100:1)]}function a(t,i){return parseInt(e.css(t,i),10)||0}e.ui=e.ui||{};var n,s=Math.max,r=Math.abs,o=Math.round,l=/left|center|right/,u=/top|center|bottom/,c=/[\+\-]\d+%?/,h=/^\w+/,d=/%$/,p=e.fn.position;e.position={scrollbarWidth:function(){if(n!==t)return n;var i,a,s=e("<div style='display:block;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),r=s.children()[0];return e("body").append(s),i=r.offsetWidth,s.css("overflow","scroll"),a=r.offsetWidth,i===a&&(a=s[0].clientWidth),s.remove(),n=i-a},getScrollInfo:function(t){var i=t.isWindow?"":t.element.css("overflow-x"),a=t.isWindow?"":t.element.css("overflow-y"),n="scroll"===i||"auto"===i&&t.width<t.element[0].scrollWidth,s="scroll"===a||"auto"===a&&t.height<t.element[0].scrollHeight;return{width:n?e.position.scrollbarWidth():0,height:s?e.position.scrollbarWidth():0}},getWithinInfo:function(t){var i=e(t||window),a=e.isWindow(i[0]);return{element:i,isWindow:a,offset:i.offset()||{left:0,top:0},scrollLeft:i.scrollLeft(),scrollTop:i.scrollTop(),width:a?i.width():i.outerWidth(),height:a?i.height():i.outerHeight()}}},e.fn.position=function(t){if(!t||!t.of)return p.apply(this,arguments);t=e.extend({},t);var n,d,f,m,g,y=e(t.of),v=e.position.getWithinInfo(t.within),b=e.position.getScrollInfo(v),_=y[0],k=(t.collision||"flip").split(" "),L={};return 9===_.nodeType?(d=y.width(),f=y.height(),m={top:0,left:0}):e.isWindow(_)?(d=y.width(),f=y.height(),m={top:y.scrollTop(),left:y.scrollLeft()}):_.preventDefault?(t.at="left top",d=f=0,m={top:_.pageY,left:_.pageX}):(d=y.outerWidth(),f=y.outerHeight(),m=y.offset()),g=e.extend({},m),e.each(["my","at"],function(){var e,i,a=(t[this]||"").split(" ");1===a.length&&(a=l.test(a[0])?a.concat(["center"]):u.test(a[0])?["center"].concat(a):["center","center"]),a[0]=l.test(a[0])?a[0]:"center",a[1]=u.test(a[1])?a[1]:"center",e=c.exec(a[0]),i=c.exec(a[1]),L[this]=[e?e[0]:0,i?i[0]:0],t[this]=[h.exec(a[0])[0],h.exec(a[1])[0]]}),1===k.length&&(k[1]=k[0]),"right"===t.at[0]?g.left+=d:"center"===t.at[0]&&(g.left+=d/2),"bottom"===t.at[1]?g.top+=f:"center"===t.at[1]&&(g.top+=f/2),n=i(L.at,d,f),g.left+=n[0],g.top+=n[1],this.each(function(){var l,u,c=e(this),h=c.outerWidth(),p=c.outerHeight(),_=a(this,"marginLeft"),w=a(this,"marginTop"),O=h+_+a(this,"marginRight")+b.width,x=p+w+a(this,"marginBottom")+b.height,S=e.extend({},g),C=i(L.my,c.outerWidth(),c.outerHeight());"right"===t.my[0]?S.left-=h:"center"===t.my[0]&&(S.left-=h/2),"bottom"===t.my[1]?S.top-=p:"center"===t.my[1]&&(S.top-=p/2),S.left+=C[0],S.top+=C[1],e.support.offsetFractions||(S.left=o(S.left),S.top=o(S.top)),l={marginLeft:_,marginTop:w},e.each(["left","top"],function(i,a){e.ui.position[k[i]]&&e.ui.position[k[i]][a](S,{targetWidth:d,targetHeight:f,elemWidth:h,elemHeight:p,collisionPosition:l,collisionWidth:O,collisionHeight:x,offset:[n[0]+C[0],n[1]+C[1]],my:t.my,at:t.at,within:v,elem:c})}),e.fn.bgiframe&&c.bgiframe(),t.using&&(u=function(e){var i=m.left-S.left,a=i+d-h,n=m.top-S.top,o=n+f-p,l={target:{element:y,left:m.left,top:m.top,width:d,height:f},element:{element:c,left:S.left,top:S.top,width:h,height:p},horizontal:0>a?"left":i>0?"right":"center",vertical:0>o?"top":n>0?"bottom":"middle"};h>d&&r(i+a)<d&&(l.horizontal="center"),p>f&&r(n+o)<f&&(l.vertical="middle"),l.important=s(r(i),r(a))>s(r(n),r(o))?"horizontal":"vertical",t.using.call(this,e,l)}),c.offset(e.extend(S,{using:u}))})},e.ui.position={fit:{left:function(e,t){var i,a=t.within,n=a.isWindow?a.scrollLeft:a.offset.left,r=a.width,o=e.left-t.collisionPosition.marginLeft,l=n-o,u=o+t.collisionWidth-r-n;t.collisionWidth>r?l>0&&0>=u?(i=e.left+l+t.collisionWidth-r-n,e.left+=l-i):e.left=u>0&&0>=l?n:l>u?n+r-t.collisionWidth:n:l>0?e.left+=l:u>0?e.left-=u:e.left=s(e.left-o,e.left)},top:function(e,t){var i,a=t.within,n=a.isWindow?a.scrollTop:a.offset.top,r=t.within.height,o=e.top-t.collisionPosition.marginTop,l=n-o,u=o+t.collisionHeight-r-n;t.collisionHeight>r?l>0&&0>=u?(i=e.top+l+t.collisionHeight-r-n,e.top+=l-i):e.top=u>0&&0>=l?n:l>u?n+r-t.collisionHeight:n:l>0?e.top+=l:u>0?e.top-=u:e.top=s(e.top-o,e.top)}},flip:{left:function(e,t){var i,a,n=t.within,s=n.offset.left+n.scrollLeft,o=n.width,l=n.isWindow?n.scrollLeft:n.offset.left,u=e.left-t.collisionPosition.marginLeft,c=u-l,h=u+t.collisionWidth-o-l,d="left"===t.my[0]?-t.elemWidth:"right"===t.my[0]?t.elemWidth:0,p="left"===t.at[0]?t.targetWidth:"right"===t.at[0]?-t.targetWidth:0,f=-2*t.offset[0];0>c?(i=e.left+d+p+f+t.collisionWidth-o-s,(0>i||i<r(c))&&(e.left+=d+p+f)):h>0&&(a=e.left-t.collisionPosition.marginLeft+d+p+f-l,(a>0||r(a)<h)&&(e.left+=d+p+f))},top:function(e,t){var i,a,n=t.within,s=n.offset.top+n.scrollTop,o=n.height,l=n.isWindow?n.scrollTop:n.offset.top,u=e.top-t.collisionPosition.marginTop,c=u-l,h=u+t.collisionHeight-o-l,d="top"===t.my[1],p=d?-t.elemHeight:"bottom"===t.my[1]?t.elemHeight:0,f="top"===t.at[1]?t.targetHeight:"bottom"===t.at[1]?-t.targetHeight:0,m=-2*t.offset[1];0>c?(a=e.top+p+f+m+t.collisionHeight-o-s,e.top+p+f+m>c&&(0>a||a<r(c))&&(e.top+=p+f+m)):h>0&&(i=e.top-t.collisionPosition.marginTop+p+f+m-l,e.top+p+f+m>h&&(i>0||r(i)<h)&&(e.top+=p+f+m))}},flipfit:{left:function(){e.ui.position.flip.left.apply(this,arguments),e.ui.position.fit.left.apply(this,arguments)},top:function(){e.ui.position.flip.top.apply(this,arguments),e.ui.position.fit.top.apply(this,arguments)}}},function(){var t,i,a,n,s,r=document.getElementsByTagName("body")[0],o=document.createElement("div");t=document.createElement(r?"div":"body"),a={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},r&&e.extend(a,{position:"absolute",left:"-1000px",top:"-1000px"});for(s in a)t.style[s]=a[s];t.appendChild(o),i=r||document.documentElement,i.insertBefore(t,i.firstChild),o.style.cssText="position: absolute; left: 10.7432222px;",n=e(o).offset().left,e.support.offsetFractions=n>10&&11>n,t.innerHTML="",i.removeChild(t)}(),e.uiBackCompat!==!1&&function(e){var i=e.fn.position;e.fn.position=function(a){if(!a||!a.offset)return i.call(this,a);var n=a.offset.split(" "),s=a.at.split(" ");return 1===n.length&&(n[1]=n[0]),/^\d/.test(n[0])&&(n[0]="+"+n[0]),/^\d/.test(n[1])&&(n[1]="+"+n[1]),1===s.length&&(/left|center|right/.test(s[0])?s[1]="center":(s[1]=s[0],s[0]="center")),i.call(this,e.extend(a,{at:s[0]+n[0]+" "+s[1]+n[1],offset:t}))}}(jQuery)}(jQuery),function(e){e.widget("ui.draggable",e.ui.mouse,{version:"1.9.1",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1},_create:function(){"original"==this.options.helper&&!/^(?:r|a|f)/.test(this.element.css("position"))&&(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},_destroy:function(){this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy()},_mouseCapture:function(t){var i=this.options;return this.helper||i.disabled||e(t.target).is(".ui-resizable-handle")?!1:(this.handle=this._getHandle(t),this.handle?(e(i.iframeFix===!0?"iframe":i.iframeFix).each(function(){e('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(e(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(t){var i=this.options;return this.helper=this._createHelper(t),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),e.ui.ddmanager&&(e.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,i.cursorAt&&this._adjustOffsetFromHelper(i.cursorAt),i.containment&&this._setContainment(),this._trigger("start",t)===!1?(this._clear(),!1):(this._cacheHelperProportions(),e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this._mouseDrag(t,!0),e.ui.ddmanager&&e.ui.ddmanager.dragStart(this,t),!0)},_mouseDrag:function(t,i){if(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),!i){var a=this._uiHash();if(this._trigger("drag",t,a)===!1)return this._mouseUp({}),!1;this.position=a.position}return this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px"),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),!1},_mouseStop:function(t){var i=!1;e.ui.ddmanager&&!this.options.dropBehaviour&&(i=e.ui.ddmanager.drop(this,t)),this.dropped&&(i=this.dropped,this.dropped=!1);for(var a=this.element[0],n=!1;a&&(a=a.parentNode);)a==document&&(n=!0);if(!n&&"original"===this.options.helper)return!1;if("invalid"==this.options.revert&&!i||"valid"==this.options.revert&&i||this.options.revert===!0||e.isFunction(this.options.revert)&&this.options.revert.call(this.element,i)){var s=this;e(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){s._trigger("stop",t)!==!1&&s._clear()})}else this._trigger("stop",t)!==!1&&this._clear();return!1},_mouseUp:function(t){return e("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),e.ui.ddmanager&&e.ui.ddmanager.dragStop(this,t),e.ui.mouse.prototype._mouseUp.call(this,t)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(t){var i=this.options.handle&&e(this.options.handle,this.element).length?!1:!0;return e(this.options.handle,this.element).find("*").andSelf().each(function(){this==t.target&&(i=!0)}),i},_createHelper:function(t){var i=this.options,a=e.isFunction(i.helper)?e(i.helper.apply(this.element[0],[t])):"clone"==i.helper?this.element.clone().removeAttr("id"):this.element;return a.parents("body").length||a.appendTo("parent"==i.appendTo?this.element[0].parentNode:i.appendTo),a[0]!=this.element[0]&&!/(fixed|absolute)/.test(a.css("position"))&&a.css("position","absolute"),a},_adjustOffsetFromHelper:function(t){"string"==typeof t&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left"in t&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();return"absolute"==this.cssPosition&&this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&"html"==this.offsetParent[0].tagName.toLowerCase()&&e.ui.ie)&&(t={top:0,left:0}),{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"==this.cssPosition){var e=this.element.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t=this.options;if("parent"==t.containment&&(t.containment=this.helper[0].parentNode),("document"==t.containment||"window"==t.containment)&&(this.containment=["document"==t.containment?0:e(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,"document"==t.containment?0:e(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,("document"==t.containment?0:e(window).scrollLeft())+e("document"==t.containment?document:window).width()-this.helperProportions.width-this.margins.left,("document"==t.containment?0:e(window).scrollTop())+(e("document"==t.containment?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(t.containment)||t.containment.constructor==Array)t.containment.constructor==Array&&(this.containment=t.containment);else{var i=e(t.containment),a=i[0];if(!a)return;var n=(i.offset(),"hidden"!=e(a).css("overflow"));this.containment=[(parseInt(e(a).css("borderLeftWidth"),10)||0)+(parseInt(e(a).css("paddingLeft"),10)||0),(parseInt(e(a).css("borderTopWidth"),10)||0)+(parseInt(e(a).css("paddingTop"),10)||0),(n?Math.max(a.scrollWidth,a.offsetWidth):a.offsetWidth)-(parseInt(e(a).css("borderLeftWidth"),10)||0)-(parseInt(e(a).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(n?Math.max(a.scrollHeight,a.offsetHeight):a.offsetHeight)-(parseInt(e(a).css("borderTopWidth"),10)||0)-(parseInt(e(a).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=i}},_convertPositionTo:function(t,i){i||(i=this.position);var a="absolute"==t?1:-1,n=(this.options,"absolute"!=this.cssPosition||this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent),s=/(html|body)/i.test(n[0].tagName);return{top:i.top+this.offset.relative.top*a+this.offset.parent.top*a-("fixed"==this.cssPosition?-this.scrollParent.scrollTop():s?0:n.scrollTop())*a,left:i.left+this.offset.relative.left*a+this.offset.parent.left*a-("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():s?0:n.scrollLeft())*a}},_generatePosition:function(t){var i=this.options,a="absolute"!=this.cssPosition||this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,n=/(html|body)/i.test(a[0].tagName),s=t.pageX,r=t.pageY;if(this.originalPosition){var o;if(this.containment){if(this.relative_container){var l=this.relative_container.offset();o=[this.containment[0]+l.left,this.containment[1]+l.top,this.containment[2]+l.left,this.containment[3]+l.top]}else o=this.containment;t.pageX-this.offset.click.left<o[0]&&(s=o[0]+this.offset.click.left),t.pageY-this.offset.click.top<o[1]&&(r=o[1]+this.offset.click.top),t.pageX-this.offset.click.left>o[2]&&(s=o[2]+this.offset.click.left),t.pageY-this.offset.click.top>o[3]&&(r=o[3]+this.offset.click.top)}if(i.grid){var u=i.grid[1]?this.originalPageY+Math.round((r-this.originalPageY)/i.grid[1])*i.grid[1]:this.originalPageY;r=o?u-this.offset.click.top<o[1]||u-this.offset.click.top>o[3]?u-this.offset.click.top<o[1]?u+i.grid[1]:u-i.grid[1]:u:u;var c=i.grid[0]?this.originalPageX+Math.round((s-this.originalPageX)/i.grid[0])*i.grid[0]:this.originalPageX;s=o?c-this.offset.click.left<o[0]||c-this.offset.click.left>o[2]?c-this.offset.click.left<o[0]?c+i.grid[0]:c-i.grid[0]:c:c}}return{top:r-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"==this.cssPosition?-this.scrollParent.scrollTop():n?0:a.scrollTop()),left:s-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():n?0:a.scrollLeft())}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]!=this.element[0]&&!this.cancelHelperRemoval&&this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(t,i,a){return a=a||this._uiHash(),e.ui.plugin.call(this,t,[i,a]),"drag"==t&&(this.positionAbs=this._convertPositionTo("absolute")),e.Widget.prototype._trigger.call(this,t,i,a)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),e.ui.plugin.add("draggable","connectToSortable",{start:function(t,i){var a=e(this).data("draggable"),n=a.options,s=e.extend({},i,{item:a.element});a.sortables=[],e(n.connectToSortable).each(function(){var i=e.data(this,"sortable");i&&!i.options.disabled&&(a.sortables.push({instance:i,shouldRevert:i.options.revert}),i.refreshPositions(),i._trigger("activate",t,s))})},stop:function(t,i){var a=e(this).data("draggable"),n=e.extend({},i,{item:a.element});e.each(a.sortables,function(){this.instance.isOver?(this.instance.isOver=0,a.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=!0),this.instance._mouseStop(t),this.instance.options.helper=this.instance.options._helper,"original"==a.options.helper&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",t,n))})},drag:function(t,i){var a=e(this).data("draggable"),n=this;e.each(a.sortables,function(){var s=!1,r=this;this.instance.positionAbs=a.positionAbs,this.instance.helperProportions=a.helperProportions,this.instance.offset.click=a.offset.click,this.instance._intersectsWith(this.instance.containerCache)&&(s=!0,e.each(a.sortables,function(){return this.instance.positionAbs=a.positionAbs,this.instance.helperProportions=a.helperProportions,this.instance.offset.click=a.offset.click,this!=r&&this.instance._intersectsWith(this.instance.containerCache)&&e.ui.contains(r.instance.element[0],this.instance.element[0])&&(s=!1),s})),s?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=e(n).clone().removeAttr("id").appendTo(this.instance.element).data("sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return i.helper[0]},t.target=this.instance.currentItem[0],this.instance._mouseCapture(t,!0),this.instance._mouseStart(t,!0,!0),this.instance.offset.click.top=a.offset.click.top,this.instance.offset.click.left=a.offset.click.left,this.instance.offset.parent.left-=a.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=a.offset.parent.top-this.instance.offset.parent.top,a._trigger("toSortable",t),a.dropped=this.instance.element,a.currentItem=a.element,this.instance.fromOutside=a),this.instance.currentItem&&this.instance._mouseDrag(t)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",t,this.instance._uiHash(this.instance)),this.instance._mouseStop(t,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),a._trigger("fromSortable",t),a.dropped=!1)})}}),e.ui.plugin.add("draggable","cursor",{start:function(){var t=e("body"),i=e(this).data("draggable").options;t.css("cursor")&&(i._cursor=t.css("cursor")),t.css("cursor",i.cursor)},stop:function(){var t=e(this).data("draggable").options;t._cursor&&e("body").css("cursor",t._cursor)}}),e.ui.plugin.add("draggable","opacity",{start:function(t,i){var a=e(i.helper),n=e(this).data("draggable").options;a.css("opacity")&&(n._opacity=a.css("opacity")),a.css("opacity",n.opacity)},stop:function(t,i){var a=e(this).data("draggable").options;a._opacity&&e(i.helper).css("opacity",a._opacity)}}),e.ui.plugin.add("draggable","scroll",{start:function(){var t=e(this).data("draggable");t.scrollParent[0]!=document&&"HTML"!=t.scrollParent[0].tagName&&(t.overflowOffset=t.scrollParent.offset())},drag:function(t){var i=e(this).data("draggable"),a=i.options,n=!1;i.scrollParent[0]!=document&&"HTML"!=i.scrollParent[0].tagName?(a.axis&&"x"==a.axis||(i.overflowOffset.top+i.scrollParent[0].offsetHeight-t.pageY<a.scrollSensitivity?i.scrollParent[0].scrollTop=n=i.scrollParent[0].scrollTop+a.scrollSpeed:t.pageY-i.overflowOffset.top<a.scrollSensitivity&&(i.scrollParent[0].scrollTop=n=i.scrollParent[0].scrollTop-a.scrollSpeed)),a.axis&&"y"==a.axis||(i.overflowOffset.left+i.scrollParent[0].offsetWidth-t.pageX<a.scrollSensitivity?i.scrollParent[0].scrollLeft=n=i.scrollParent[0].scrollLeft+a.scrollSpeed:t.pageX-i.overflowOffset.left<a.scrollSensitivity&&(i.scrollParent[0].scrollLeft=n=i.scrollParent[0].scrollLeft-a.scrollSpeed))):(a.axis&&"x"==a.axis||(t.pageY-e(document).scrollTop()<a.scrollSensitivity?n=e(document).scrollTop(e(document).scrollTop()-a.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<a.scrollSensitivity&&(n=e(document).scrollTop(e(document).scrollTop()+a.scrollSpeed))),a.axis&&"y"==a.axis||(t.pageX-e(document).scrollLeft()<a.scrollSensitivity?n=e(document).scrollLeft(e(document).scrollLeft()-a.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<a.scrollSensitivity&&(n=e(document).scrollLeft(e(document).scrollLeft()+a.scrollSpeed)))),n!==!1&&e.ui.ddmanager&&!a.dropBehaviour&&e.ui.ddmanager.prepareOffsets(i,t)}}),e.ui.plugin.add("draggable","snap",{start:function(){var t=e(this).data("draggable"),i=t.options;t.snapElements=[],e(i.snap.constructor!=String?i.snap.items||":data(draggable)":i.snap).each(function(){var i=e(this),a=i.offset();this!=t.element[0]&&t.snapElements.push({item:this,width:i.outerWidth(),height:i.outerHeight(),top:a.top,left:a.left})})},drag:function(t,i){for(var a=e(this).data("draggable"),n=a.options,s=n.snapTolerance,r=i.offset.left,o=r+a.helperProportions.width,l=i.offset.top,u=l+a.helperProportions.height,c=a.snapElements.length-1;c>=0;c--){var h=a.snapElements[c].left,d=h+a.snapElements[c].width,p=a.snapElements[c].top,f=p+a.snapElements[c].height;if(r>h-s&&d+s>r&&l>p-s&&f+s>l||r>h-s&&d+s>r&&u>p-s&&f+s>u||o>h-s&&d+s>o&&l>p-s&&f+s>l||o>h-s&&d+s>o&&u>p-s&&f+s>u){if("inner"!=n.snapMode){var m=Math.abs(p-u)<=s,g=Math.abs(f-l)<=s,y=Math.abs(h-o)<=s,v=Math.abs(d-r)<=s;m&&(i.position.top=a._convertPositionTo("relative",{top:p-a.helperProportions.height,left:0}).top-a.margins.top),g&&(i.position.top=a._convertPositionTo("relative",{top:f,left:0}).top-a.margins.top),y&&(i.position.left=a._convertPositionTo("relative",{top:0,left:h-a.helperProportions.width}).left-a.margins.left),v&&(i.position.left=a._convertPositionTo("relative",{top:0,left:d}).left-a.margins.left)}var b=m||g||y||v;if("outer"!=n.snapMode){var m=Math.abs(p-l)<=s,g=Math.abs(f-u)<=s,y=Math.abs(h-r)<=s,v=Math.abs(d-o)<=s;m&&(i.position.top=a._convertPositionTo("relative",{top:p,left:0}).top-a.margins.top),g&&(i.position.top=a._convertPositionTo("relative",{top:f-a.helperProportions.height,left:0}).top-a.margins.top),y&&(i.position.left=a._convertPositionTo("relative",{top:0,left:h}).left-a.margins.left),v&&(i.position.left=a._convertPositionTo("relative",{top:0,left:d-a.helperProportions.width}).left-a.margins.left)}!a.snapElements[c].snapping&&(m||g||y||v||b)&&a.options.snap.snap&&a.options.snap.snap.call(a.element,t,e.extend(a._uiHash(),{snapItem:a.snapElements[c].item})),a.snapElements[c].snapping=m||g||y||v||b}else a.snapElements[c].snapping&&a.options.snap.release&&a.options.snap.release.call(a.element,t,e.extend(a._uiHash(),{snapItem:a.snapElements[c].item})),a.snapElements[c].snapping=!1}}}),e.ui.plugin.add("draggable","stack",{start:function(){var t=e(this).data("draggable").options,i=e.makeArray(e(t.stack)).sort(function(t,i){return(parseInt(e(t).css("zIndex"),10)||0)-(parseInt(e(i).css("zIndex"),10)||0)});if(i.length){var a=parseInt(i[0].style.zIndex)||0;e(i).each(function(e){this.style.zIndex=a+e}),this[0].style.zIndex=a+i.length}}}),e.ui.plugin.add("draggable","zIndex",{start:function(t,i){var a=e(i.helper),n=e(this).data("draggable").options;a.css("zIndex")&&(n._zIndex=a.css("zIndex")),a.css("zIndex",n.zIndex)},stop:function(t,i){var a=e(this).data("draggable").options;a._zIndex&&e(i.helper).css("zIndex",a._zIndex)}})}(jQuery),function(e){e.widget("ui.droppable",{version:"1.9.1",widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect"},_create:function(){var t=this.options,i=t.accept;this.isover=0,this.isout=1,this.accept=e.isFunction(i)?i:function(e){return e.is(i)},this.proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight},e.ui.ddmanager.droppables[t.scope]=e.ui.ddmanager.droppables[t.scope]||[],e.ui.ddmanager.droppables[t.scope].push(this),t.addClasses&&this.element.addClass("ui-droppable")},_destroy:function(){for(var t=e.ui.ddmanager.droppables[this.options.scope],i=0;i<t.length;i++)t[i]==this&&t.splice(i,1);this.element.removeClass("ui-droppable ui-droppable-disabled")},_setOption:function(t,i){"accept"==t&&(this.accept=e.isFunction(i)?i:function(e){return e.is(i)}),e.Widget.prototype._setOption.apply(this,arguments)},_activate:function(t){var i=e.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),i&&this._trigger("activate",t,this.ui(i))},_deactivate:function(t){var i=e.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),i&&this._trigger("deactivate",t,this.ui(i))},_over:function(t){var i=e.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!=this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",t,this.ui(i)))},_out:function(t){var i=e.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!=this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",t,this.ui(i)))},_drop:function(t,i){var a=i||e.ui.ddmanager.current;if(!a||(a.currentItem||a.element)[0]==this.element[0])return!1;var n=!1;return this.element.find(":data(droppable)").not(".ui-draggable-dragging").each(function(){var t=e.data(this,"droppable");return t.options.greedy&&!t.options.disabled&&t.options.scope==a.options.scope&&t.accept.call(t.element[0],a.currentItem||a.element)&&e.ui.intersect(a,e.extend(t,{offset:t.element.offset()}),t.options.tolerance)?(n=!0,!1):void 0}),n?!1:this.accept.call(this.element[0],a.currentItem||a.element)?(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",t,this.ui(a)),this.element):!1},ui:function(e){return{draggable:e.currentItem||e.element,helper:e.helper,position:e.position,offset:e.positionAbs}}}),e.ui.intersect=function(t,i,a){if(!i.offset)return!1;var n=(t.positionAbs||t.position.absolute).left,s=n+t.helperProportions.width,r=(t.positionAbs||t.position.absolute).top,o=r+t.helperProportions.height,l=i.offset.left,u=l+i.proportions.width,c=i.offset.top,h=c+i.proportions.height;switch(a){case"fit":return n>=l&&u>=s&&r>=c&&h>=o;case"intersect":return l<n+t.helperProportions.width/2&&s-t.helperProportions.width/2<u&&c<r+t.helperProportions.height/2&&o-t.helperProportions.height/2<h;case"pointer":var d=(t.positionAbs||t.position.absolute).left+(t.clickOffset||t.offset.click).left,p=(t.positionAbs||t.position.absolute).top+(t.clickOffset||t.offset.click).top,f=e.ui.isOver(p,d,c,l,i.proportions.height,i.proportions.width);return f;case"touch":return(r>=c&&h>=r||o>=c&&h>=o||c>r&&o>h)&&(n>=l&&u>=n||s>=l&&u>=s||l>n&&s>u);default:return!1}},e.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(t,i){var a=e.ui.ddmanager.droppables[t.options.scope]||[],n=i?i.type:null,s=(t.currentItem||t.element).find(":data(droppable)").andSelf();e:for(var r=0;r<a.length;r++)if(!(a[r].options.disabled||t&&!a[r].accept.call(a[r].element[0],t.currentItem||t.element))){for(var o=0;o<s.length;o++)if(s[o]==a[r].element[0]){a[r].proportions.height=0;continue e}a[r].visible="none"!=a[r].element.css("display"),a[r].visible&&("mousedown"==n&&a[r]._activate.call(a[r],i),a[r].offset=a[r].element.offset(),a[r].proportions={width:a[r].element[0].offsetWidth,height:a[r].element[0].offsetHeight})}},drop:function(t,i){var a=!1;return e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){this.options&&(!this.options.disabled&&this.visible&&e.ui.intersect(t,this,this.options.tolerance)&&(a=this._drop.call(this,i)||a),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],t.currentItem||t.element)&&(this.isout=1,this.isover=0,this._deactivate.call(this,i)))
}),a},dragStart:function(t,i){t.element.parentsUntil("body").bind("scroll.droppable",function(){t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,i)})},drag:function(t,i){t.options.refreshPositions&&e.ui.ddmanager.prepareOffsets(t,i),e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){if(!this.options.disabled&&!this.greedyChild&&this.visible){var a=e.ui.intersect(t,this,this.options.tolerance),n=a||1!=this.isover?a&&0==this.isover?"isover":null:"isout";if(n){var s;if(this.options.greedy){var r=this.options.scope,o=this.element.parents(":data(droppable)").filter(function(){return e.data(this,"droppable").options.scope===r});o.length&&(s=e.data(o[0],"droppable"),s.greedyChild="isover"==n?1:0)}s&&"isover"==n&&(s.isover=0,s.isout=1,s._out.call(s,i)),this[n]=1,this["isout"==n?"isover":"isout"]=0,this["isover"==n?"_over":"_out"].call(this,i),s&&"isout"==n&&(s.isout=0,s.isover=1,s._over.call(s,i))}}})},dragStop:function(t,i){t.element.parentsUntil("body").unbind("scroll.droppable"),t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,i)}}}(jQuery),function(e){e.widget("ui.resizable",e.ui.mouse,{version:"1.9.1",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:1e3},_create:function(){var t=this,i=this.options;if(this.element.addClass("ui-resizable"),e.extend(this,{_aspectRatio:!!i.aspectRatio,aspectRatio:i.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:i.helper||i.ghost||i.animate?i.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/canvas|textarea|input|select|button|img/i)&&(this.element.wrap(e('<div class="ui-wrapper" style="overflow: hidden;"></div>').css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("resizable",this.element.data("resizable")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=i.handles||(e(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this.handles.constructor==String){"all"==this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw");var a=this.handles.split(",");this.handles={};for(var n=0;n<a.length;n++){var s=e.trim(a[n]),r="ui-resizable-"+s,o=e('<div class="ui-resizable-handle '+r+'"></div>');o.css({zIndex:i.zIndex}),"se"==s&&o.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[s]=".ui-resizable-"+s,this.element.append(o)}}this._renderAxis=function(t){t=t||this.element;for(var i in this.handles){if(this.handles[i].constructor==String&&(this.handles[i]=e(this.handles[i],this.element).show()),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/textarea|input|select|button/i)){var a=e(this.handles[i],this.element),n=0;n=/sw|ne|nw|se|n|s/.test(i)?a.outerHeight():a.outerWidth();var s=["padding",/ne|nw|n/.test(i)?"Top":/se|sw|s/.test(i)?"Bottom":/^e$/.test(i)?"Right":"Left"].join("");t.css(s,n),this._proportionallyResize()}e(this.handles[i]).length}},this._renderAxis(this.element),this._handles=e(".ui-resizable-handle",this.element).disableSelection(),this._handles.mouseover(function(){if(!t.resizing){if(this.className)var e=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i);t.axis=e&&e[1]?e[1]:"se"}}),i.autoHide&&(this._handles.hide(),e(this.element).addClass("ui-resizable-autohide").mouseenter(function(){i.disabled||(e(this).removeClass("ui-resizable-autohide"),t._handles.show())}).mouseleave(function(){i.disabled||t.resizing||(e(this).addClass("ui-resizable-autohide"),t._handles.hide())})),this._mouseInit()},_destroy:function(){this._mouseDestroy();var t=function(t){e(t).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").removeData("ui-resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};if(this.elementIsWrapper){t(this.element);var i=this.element;this.originalElement.css({position:i.css("position"),width:i.outerWidth(),height:i.outerHeight(),top:i.css("top"),left:i.css("left")}).insertAfter(i),i.remove()}return this.originalElement.css("resize",this.originalResizeStyle),t(this.originalElement),this},_mouseCapture:function(t){var i=!1;for(var a in this.handles)e(this.handles[a])[0]==t.target&&(i=!0);return!this.options.disabled&&i},_mouseStart:function(i){var a=this.options,n=this.element.position(),s=this.element;this.resizing=!0,this.documentScroll={top:e(document).scrollTop(),left:e(document).scrollLeft()},(s.is(".ui-draggable")||/absolute/.test(s.css("position")))&&s.css({position:"absolute",top:n.top,left:n.left}),this._renderProxy();var r=t(this.helper.css("left")),o=t(this.helper.css("top"));a.containment&&(r+=e(a.containment).scrollLeft()||0,o+=e(a.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:r,top:o},this.size=this._helper?{width:s.outerWidth(),height:s.outerHeight()}:{width:s.width(),height:s.height()},this.originalSize=this._helper?{width:s.outerWidth(),height:s.outerHeight()}:{width:s.width(),height:s.height()},this.originalPosition={left:r,top:o},this.sizeDiff={width:s.outerWidth()-s.width(),height:s.outerHeight()-s.height()},this.originalMousePosition={left:i.pageX,top:i.pageY},this.aspectRatio="number"==typeof a.aspectRatio?a.aspectRatio:this.originalSize.width/this.originalSize.height||1;var l=e(".ui-resizable-"+this.axis).css("cursor");return e("body").css("cursor","auto"==l?this.axis+"-resize":l),s.addClass("ui-resizable-resizing"),this._propagate("start",i),!0},_mouseDrag:function(e){var t=this.helper,i=(this.options,this.originalMousePosition),a=this.axis,n=e.pageX-i.left||0,s=e.pageY-i.top||0,r=this._change[a];if(!r)return!1;var o=r.apply(this,[e,n,s]);return this._updateVirtualBoundaries(e.shiftKey),(this._aspectRatio||e.shiftKey)&&(o=this._updateRatio(o,e)),o=this._respectSize(o,e),this._propagate("resize",e),t.css({top:this.position.top+"px",left:this.position.left+"px",width:this.size.width+"px",height:this.size.height+"px"}),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),this._updateCache(o),this._trigger("resize",e,this.ui()),!1},_mouseStop:function(t){this.resizing=!1;var i=this.options,a=this;if(this._helper){var n=this._proportionallyResizeElements,s=n.length&&/textarea/i.test(n[0].nodeName),r=s&&e.ui.hasScroll(n[0],"left")?0:a.sizeDiff.height,o=s?0:a.sizeDiff.width,l={width:a.helper.width()-o,height:a.helper.height()-r},u=parseInt(a.element.css("left"),10)+(a.position.left-a.originalPosition.left)||null,c=parseInt(a.element.css("top"),10)+(a.position.top-a.originalPosition.top)||null;i.animate||this.element.css(e.extend(l,{top:c,left:u})),a.helper.height(a.size.height),a.helper.width(a.size.width),this._helper&&!i.animate&&this._proportionallyResize()}return e("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",t),this._helper&&this.helper.remove(),!1},_updateVirtualBoundaries:function(e){var t,a,n,s,r,o=this.options;r={minWidth:i(o.minWidth)?o.minWidth:0,maxWidth:i(o.maxWidth)?o.maxWidth:1/0,minHeight:i(o.minHeight)?o.minHeight:0,maxHeight:i(o.maxHeight)?o.maxHeight:1/0},(this._aspectRatio||e)&&(t=r.minHeight*this.aspectRatio,n=r.minWidth/this.aspectRatio,a=r.maxHeight*this.aspectRatio,s=r.maxWidth/this.aspectRatio,t>r.minWidth&&(r.minWidth=t),n>r.minHeight&&(r.minHeight=n),a<r.maxWidth&&(r.maxWidth=a),s<r.maxHeight&&(r.maxHeight=s)),this._vBoundaries=r},_updateCache:function(e){this.options,this.offset=this.helper.offset(),i(e.left)&&(this.position.left=e.left),i(e.top)&&(this.position.top=e.top),i(e.height)&&(this.size.height=e.height),i(e.width)&&(this.size.width=e.width)},_updateRatio:function(e){var t=(this.options,this.position),a=this.size,n=this.axis;return i(e.height)?e.width=e.height*this.aspectRatio:i(e.width)&&(e.height=e.width/this.aspectRatio),"sw"==n&&(e.left=t.left+(a.width-e.width),e.top=null),"nw"==n&&(e.top=t.top+(a.height-e.height),e.left=t.left+(a.width-e.width)),e},_respectSize:function(e,t){var a=(this.helper,this._vBoundaries),n=(this._aspectRatio||t.shiftKey,this.axis),s=i(e.width)&&a.maxWidth&&a.maxWidth<e.width,r=i(e.height)&&a.maxHeight&&a.maxHeight<e.height,o=i(e.width)&&a.minWidth&&a.minWidth>e.width,l=i(e.height)&&a.minHeight&&a.minHeight>e.height;o&&(e.width=a.minWidth),l&&(e.height=a.minHeight),s&&(e.width=a.maxWidth),r&&(e.height=a.maxHeight);var u=this.originalPosition.left+this.originalSize.width,c=this.position.top+this.size.height,h=/sw|nw|w/.test(n),d=/nw|ne|n/.test(n);o&&h&&(e.left=u-a.minWidth),s&&h&&(e.left=u-a.maxWidth),l&&d&&(e.top=c-a.minHeight),r&&d&&(e.top=c-a.maxHeight);var p=!e.width&&!e.height;return p&&!e.left&&e.top?e.top=null:p&&!e.top&&e.left&&(e.left=null),e},_proportionallyResize:function(){if(this.options,this._proportionallyResizeElements.length)for(var t=this.helper||this.element,i=0;i<this._proportionallyResizeElements.length;i++){var a=this._proportionallyResizeElements[i];if(!this.borderDif){var n=[a.css("borderTopWidth"),a.css("borderRightWidth"),a.css("borderBottomWidth"),a.css("borderLeftWidth")],s=[a.css("paddingTop"),a.css("paddingRight"),a.css("paddingBottom"),a.css("paddingLeft")];this.borderDif=e.map(n,function(e,t){var i=parseInt(e,10)||0,a=parseInt(s[t],10)||0;return i+a})}a.css({height:t.height()-this.borderDif[0]-this.borderDif[2]||0,width:t.width()-this.borderDif[1]-this.borderDif[3]||0})}},_renderProxy:function(){var t=this.element,i=this.options;if(this.elementOffset=t.offset(),this._helper){this.helper=this.helper||e('<div style="overflow:hidden;"></div>');var a=e.ui.ie6?1:0,n=e.ui.ie6?2:-1;this.helper.addClass(this._helper).css({width:this.element.outerWidth()+n,height:this.element.outerHeight()+n,position:"absolute",left:this.elementOffset.left-a+"px",top:this.elementOffset.top-a+"px",zIndex:++i.zIndex}),this.helper.appendTo("body").disableSelection()}else this.helper=this.element},_change:{e:function(e,t){return{width:this.originalSize.width+t}},w:function(e,t){var i=(this.options,this.originalSize),a=this.originalPosition;return{left:a.left+t,width:i.width-t}},n:function(e,t,i){var a=(this.options,this.originalSize),n=this.originalPosition;return{top:n.top+i,height:a.height-i}},s:function(e,t,i){return{height:this.originalSize.height+i}},se:function(t,i,a){return e.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[t,i,a]))},sw:function(t,i,a){return e.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[t,i,a]))},ne:function(t,i,a){return e.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[t,i,a]))},nw:function(t,i,a){return e.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[t,i,a]))}},_propagate:function(t,i){e.ui.plugin.call(this,t,[i,this.ui()]),"resize"!=t&&this._trigger(t,i,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),e.ui.plugin.add("resizable","alsoResize",{start:function(){var t=e(this).data("resizable"),i=t.options,a=function(t){e(t).each(function(){var t=e(this);t.data("resizable-alsoresize",{width:parseInt(t.width(),10),height:parseInt(t.height(),10),left:parseInt(t.css("left"),10),top:parseInt(t.css("top"),10)})})};"object"!=typeof i.alsoResize||i.alsoResize.parentNode?a(i.alsoResize):i.alsoResize.length?(i.alsoResize=i.alsoResize[0],a(i.alsoResize)):e.each(i.alsoResize,function(e){a(e)})},resize:function(t,i){var a=e(this).data("resizable"),n=a.options,s=a.originalSize,r=a.originalPosition,o={height:a.size.height-s.height||0,width:a.size.width-s.width||0,top:a.position.top-r.top||0,left:a.position.left-r.left||0},l=function(t,a){e(t).each(function(){var t=e(this),n=e(this).data("resizable-alsoresize"),s={},r=a&&a.length?a:t.parents(i.originalElement[0]).length?["width","height"]:["width","height","top","left"];e.each(r,function(e,t){var i=(n[t]||0)+(o[t]||0);i&&i>=0&&(s[t]=i||null)}),t.css(s)})};"object"!=typeof n.alsoResize||n.alsoResize.nodeType?l(n.alsoResize):e.each(n.alsoResize,function(e,t){l(e,t)})},stop:function(){e(this).removeData("resizable-alsoresize")}}),e.ui.plugin.add("resizable","animate",{stop:function(t){var i=e(this).data("resizable"),a=i.options,n=i._proportionallyResizeElements,s=n.length&&/textarea/i.test(n[0].nodeName),r=s&&e.ui.hasScroll(n[0],"left")?0:i.sizeDiff.height,o=s?0:i.sizeDiff.width,l={width:i.size.width-o,height:i.size.height-r},u=parseInt(i.element.css("left"),10)+(i.position.left-i.originalPosition.left)||null,c=parseInt(i.element.css("top"),10)+(i.position.top-i.originalPosition.top)||null;i.element.animate(e.extend(l,c&&u?{top:c,left:u}:{}),{duration:a.animateDuration,easing:a.animateEasing,step:function(){var a={width:parseInt(i.element.css("width"),10),height:parseInt(i.element.css("height"),10),top:parseInt(i.element.css("top"),10),left:parseInt(i.element.css("left"),10)};n&&n.length&&e(n[0]).css({width:a.width,height:a.height}),i._updateCache(a),i._propagate("resize",t)}})}}),e.ui.plugin.add("resizable","containment",{start:function(){var i=e(this).data("resizable"),a=i.options,n=i.element,s=a.containment,r=s instanceof e?s.get(0):/parent/.test(s)?n.parent().get(0):s;if(r)if(i.containerElement=e(r),/document/.test(s)||s==document)i.containerOffset={left:0,top:0},i.containerPosition={left:0,top:0},i.parentData={element:e(document),left:0,top:0,width:e(document).width(),height:e(document).height()||document.body.parentNode.scrollHeight};else{var o=e(r),l=[];e(["Top","Right","Left","Bottom"]).each(function(e,i){l[e]=t(o.css("padding"+i))}),i.containerOffset=o.offset(),i.containerPosition=o.position(),i.containerSize={height:o.innerHeight()-l[3],width:o.innerWidth()-l[1]};var u=i.containerOffset,c=i.containerSize.height,h=i.containerSize.width,d=e.ui.hasScroll(r,"left")?r.scrollWidth:h,p=e.ui.hasScroll(r)?r.scrollHeight:c;i.parentData={element:r,left:u.left,top:u.top,width:d,height:p}}},resize:function(t){var i=e(this).data("resizable"),a=i.options,n=(i.containerSize,i.containerOffset),s=(i.size,i.position),r=i._aspectRatio||t.shiftKey,o={top:0,left:0},l=i.containerElement;l[0]!=document&&/static/.test(l.css("position"))&&(o=n),s.left<(i._helper?n.left:0)&&(i.size.width=i.size.width+(i._helper?i.position.left-n.left:i.position.left-o.left),r&&(i.size.height=i.size.width/i.aspectRatio),i.position.left=a.helper?n.left:0),s.top<(i._helper?n.top:0)&&(i.size.height=i.size.height+(i._helper?i.position.top-n.top:i.position.top),r&&(i.size.width=i.size.height*i.aspectRatio),i.position.top=i._helper?n.top:0),i.offset.left=i.parentData.left+i.position.left,i.offset.top=i.parentData.top+i.position.top;var u=Math.abs((i._helper?i.offset.left-o.left:i.offset.left-o.left)+i.sizeDiff.width),c=Math.abs((i._helper?i.offset.top-o.top:i.offset.top-n.top)+i.sizeDiff.height),h=i.containerElement.get(0)==i.element.parent().get(0),d=/relative|absolute/.test(i.containerElement.css("position"));h&&d&&(u-=i.parentData.left),u+i.size.width>=i.parentData.width&&(i.size.width=i.parentData.width-u,r&&(i.size.height=i.size.width/i.aspectRatio)),c+i.size.height>=i.parentData.height&&(i.size.height=i.parentData.height-c,r&&(i.size.width=i.size.height*i.aspectRatio))},stop:function(){var t=e(this).data("resizable"),i=t.options,a=(t.position,t.containerOffset),n=t.containerPosition,s=t.containerElement,r=e(t.helper),o=r.offset(),l=r.outerWidth()-t.sizeDiff.width,u=r.outerHeight()-t.sizeDiff.height;t._helper&&!i.animate&&/relative/.test(s.css("position"))&&e(this).css({left:o.left-n.left-a.left,width:l,height:u}),t._helper&&!i.animate&&/static/.test(s.css("position"))&&e(this).css({left:o.left-n.left-a.left,width:l,height:u})}}),e.ui.plugin.add("resizable","ghost",{start:function(){var t=e(this).data("resizable"),i=t.options,a=t.size;t.ghost=t.originalElement.clone(),t.ghost.css({opacity:.25,display:"block",position:"relative",height:a.height,width:a.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass("string"==typeof i.ghost?i.ghost:""),t.ghost.appendTo(t.helper)},resize:function(){var t=e(this).data("resizable");t.options,t.ghost&&t.ghost.css({position:"relative",height:t.size.height,width:t.size.width})},stop:function(){var t=e(this).data("resizable");t.options,t.ghost&&t.helper&&t.helper.get(0).removeChild(t.ghost.get(0))}}),e.ui.plugin.add("resizable","grid",{resize:function(t){var i=e(this).data("resizable"),a=i.options,n=i.size,s=i.originalSize,r=i.originalPosition,o=i.axis;a._aspectRatio||t.shiftKey,a.grid="number"==typeof a.grid?[a.grid,a.grid]:a.grid;var l=Math.round((n.width-s.width)/(a.grid[0]||1))*(a.grid[0]||1),u=Math.round((n.height-s.height)/(a.grid[1]||1))*(a.grid[1]||1);/^(se|s|e)$/.test(o)?(i.size.width=s.width+l,i.size.height=s.height+u):/^(ne)$/.test(o)?(i.size.width=s.width+l,i.size.height=s.height+u,i.position.top=r.top-u):/^(sw)$/.test(o)?(i.size.width=s.width+l,i.size.height=s.height+u,i.position.left=r.left-l):(i.size.width=s.width+l,i.size.height=s.height+u,i.position.top=r.top-u,i.position.left=r.left-l)}});var t=function(e){return parseInt(e,10)||0},i=function(e){return!isNaN(parseInt(e,10))}}(jQuery),function(e){e.widget("ui.selectable",e.ui.mouse,{version:"1.9.1",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch"},_create:function(){var t=this;this.element.addClass("ui-selectable"),this.dragged=!1;var i;this.refresh=function(){i=e(t.options.filter,t.element[0]),i.addClass("ui-selectee"),i.each(function(){var t=e(this),i=t.offset();e.data(this,"selectable-item",{element:this,$element:t,left:i.left,top:i.top,right:i.left+t.outerWidth(),bottom:i.top+t.outerHeight(),startselected:!1,selected:t.hasClass("ui-selected"),selecting:t.hasClass("ui-selecting"),unselecting:t.hasClass("ui-unselecting")})})},this.refresh(),this.selectees=i.addClass("ui-selectee"),this._mouseInit(),this.helper=e("<div class='ui-selectable-helper'></div>")},_destroy:function(){this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled"),this._mouseDestroy()},_mouseStart:function(t){var i=this;if(this.opos=[t.pageX,t.pageY],!this.options.disabled){var a=this.options;this.selectees=e(a.filter,this.element[0]),this._trigger("start",t),e(a.appendTo).append(this.helper),this.helper.css({left:t.clientX,top:t.clientY,width:0,height:0}),a.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var a=e.data(this,"selectable-item");a.startselected=!0,!t.metaKey&&!t.ctrlKey&&(a.$element.removeClass("ui-selected"),a.selected=!1,a.$element.addClass("ui-unselecting"),a.unselecting=!0,i._trigger("unselecting",t,{unselecting:a.element}))}),e(t.target).parents().andSelf().each(function(){var a=e.data(this,"selectable-item");if(a){var n=!t.metaKey&&!t.ctrlKey||!a.$element.hasClass("ui-selected");return a.$element.removeClass(n?"ui-unselecting":"ui-selected").addClass(n?"ui-selecting":"ui-unselecting"),a.unselecting=!n,a.selecting=n,a.selected=n,n?i._trigger("selecting",t,{selecting:a.element}):i._trigger("unselecting",t,{unselecting:a.element}),!1}})}},_mouseDrag:function(t){var i=this;if(this.dragged=!0,!this.options.disabled){var a=this.options,n=this.opos[0],s=this.opos[1],r=t.pageX,o=t.pageY;if(n>r){var l=r;r=n,n=l}if(s>o){var l=o;o=s,s=l}return this.helper.css({left:n,top:s,width:r-n,height:o-s}),this.selectees.each(function(){var l=e.data(this,"selectable-item");if(l&&l.element!=i.element[0]){var u=!1;"touch"==a.tolerance?u=!(l.left>r||l.right<n||l.top>o||l.bottom<s):"fit"==a.tolerance&&(u=l.left>n&&l.right<r&&l.top>s&&l.bottom<o),u?(l.selected&&(l.$element.removeClass("ui-selected"),l.selected=!1),l.unselecting&&(l.$element.removeClass("ui-unselecting"),l.unselecting=!1),l.selecting||(l.$element.addClass("ui-selecting"),l.selecting=!0,i._trigger("selecting",t,{selecting:l.element}))):(l.selecting&&((t.metaKey||t.ctrlKey)&&l.startselected?(l.$element.removeClass("ui-selecting"),l.selecting=!1,l.$element.addClass("ui-selected"),l.selected=!0):(l.$element.removeClass("ui-selecting"),l.selecting=!1,l.startselected&&(l.$element.addClass("ui-unselecting"),l.unselecting=!0),i._trigger("unselecting",t,{unselecting:l.element}))),l.selected&&!t.metaKey&&!t.ctrlKey&&!l.startselected&&(l.$element.removeClass("ui-selected"),l.selected=!1,l.$element.addClass("ui-unselecting"),l.unselecting=!0,i._trigger("unselecting",t,{unselecting:l.element})))}}),!1}},_mouseStop:function(t){var i=this;return this.dragged=!1,this.options,e(".ui-unselecting",this.element[0]).each(function(){var a=e.data(this,"selectable-item");a.$element.removeClass("ui-unselecting"),a.unselecting=!1,a.startselected=!1,i._trigger("unselected",t,{unselected:a.element})}),e(".ui-selecting",this.element[0]).each(function(){var a=e.data(this,"selectable-item");a.$element.removeClass("ui-selecting").addClass("ui-selected"),a.selecting=!1,a.selected=!0,a.startselected=!0,i._trigger("selected",t,{selected:a.element})}),this._trigger("stop",t),this.helper.remove(),!1}})}(jQuery),function(e){e.widget("ui.sortable",e.ui.mouse,{version:"1.9.1",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3},_create:function(){var e=this.options;this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.floating=this.items.length?"x"===e.axis||/left|right/.test(this.items[0].item.css("float"))||/inline|table-cell/.test(this.items[0].item.css("display")):!1,this.offset=this.element.offset(),this._mouseInit(),this.ready=!0},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled"),this._mouseDestroy();for(var e=this.items.length-1;e>=0;e--)this.items[e].item.removeData(this.widgetName+"-item");return this},_setOption:function(t,i){"disabled"===t?(this.options[t]=i,this.widget().toggleClass("ui-sortable-disabled",!!i)):e.Widget.prototype._setOption.apply(this,arguments)},_mouseCapture:function(t,i){var a=this;if(this.reverting)return!1;if(this.options.disabled||"static"==this.options.type)return!1;this._refreshItems(t);var n=null;if(e(t.target).parents().each(function(){return e.data(this,a.widgetName+"-item")==a?(n=e(this),!1):void 0}),e.data(t.target,a.widgetName+"-item")==a&&(n=e(t.target)),!n)return!1;if(this.options.handle&&!i){var s=!1;if(e(this.options.handle,n).find("*").andSelf().each(function(){this==t.target&&(s=!0)}),!s)return!1}return this.currentItem=n,this._removeCurrentsFromItems(),!0},_mouseStart:function(t,i,a){var n=this.options;if(this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(t),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,n.cursorAt&&this._adjustOffsetFromHelper(n.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!=this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),n.containment&&this._setContainment(),n.cursor&&(e("body").css("cursor")&&(this._storedCursor=e("body").css("cursor")),e("body").css("cursor",n.cursor)),n.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",n.opacity)),n.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",n.zIndex)),this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",t,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!a)for(var s=this.containers.length-1;s>=0;s--)this.containers[s]._trigger("activate",t,this._uiHash(this));return e.ui.ddmanager&&(e.ui.ddmanager.current=this),e.ui.ddmanager&&!n.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(t),!0},_mouseDrag:function(t){if(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll){var i=this.options,a=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<i.scrollSensitivity?this.scrollParent[0].scrollTop=a=this.scrollParent[0].scrollTop+i.scrollSpeed:t.pageY-this.overflowOffset.top<i.scrollSensitivity&&(this.scrollParent[0].scrollTop=a=this.scrollParent[0].scrollTop-i.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<i.scrollSensitivity?this.scrollParent[0].scrollLeft=a=this.scrollParent[0].scrollLeft+i.scrollSpeed:t.pageX-this.overflowOffset.left<i.scrollSensitivity&&(this.scrollParent[0].scrollLeft=a=this.scrollParent[0].scrollLeft-i.scrollSpeed)):(t.pageY-e(document).scrollTop()<i.scrollSensitivity?a=e(document).scrollTop(e(document).scrollTop()-i.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<i.scrollSensitivity&&(a=e(document).scrollTop(e(document).scrollTop()+i.scrollSpeed)),t.pageX-e(document).scrollLeft()<i.scrollSensitivity?a=e(document).scrollLeft(e(document).scrollLeft()-i.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<i.scrollSensitivity&&(a=e(document).scrollLeft(e(document).scrollLeft()+i.scrollSpeed))),a!==!1&&e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t)}this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var n=this.items.length-1;n>=0;n--){var s=this.items[n],r=s.item[0],o=this._intersectsWithPointer(s);if(o&&s.instance===this.currentContainer&&r!=this.currentItem[0]&&this.placeholder[1==o?"next":"prev"]()[0]!=r&&!e.contains(this.placeholder[0],r)&&("semi-dynamic"==this.options.type?!e.contains(this.element[0],r):!0)){if(this.direction=1==o?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(s))break;this._rearrange(t,s),this._trigger("change",t,this._uiHash());break}}return this._contactContainers(t),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t,i){if(t){if(e.ui.ddmanager&&!this.options.dropBehaviour&&e.ui.ddmanager.drop(this,t),this.options.revert){var a=this,n=this.placeholder.offset();this.reverting=!0,e(this.helper).animate({left:n.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollLeft),top:n.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollTop)},parseInt(this.options.revert,10)||500,function(){a._clear(t)})}else this._clear(t,i);return!1}},cancel:function(){if(this.dragging){this._mouseUp({target:null}),"original"==this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var t=this.containers.length-1;t>=0;t--)this.containers[t]._trigger("deactivate",null,this._uiHash(this)),this.containers[t].containerCache.over&&(this.containers[t]._trigger("out",null,this._uiHash(this)),this.containers[t].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!=this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),e.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?e(this.domPosition.prev).after(this.currentItem):e(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(t){var i=this._getItemsAsjQuery(t&&t.connected),a=[];return t=t||{},e(i).each(function(){var i=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);i&&a.push((t.key||i[1]+"[]")+"="+(t.key&&t.expression?i[1]:i[2]))}),!a.length&&t.key&&a.push(t.key+"="),a.join("&")},toArray:function(t){var i=this._getItemsAsjQuery(t&&t.connected),a=[];return t=t||{},i.each(function(){a.push(e(t.item||this).attr(t.attribute||"id")||"")}),a},_intersectsWith:function(e){var t=this.positionAbs.left,i=t+this.helperProportions.width,a=this.positionAbs.top,n=a+this.helperProportions.height,s=e.left,r=s+e.width,o=e.top,l=o+e.height,u=this.offset.click.top,c=this.offset.click.left,h=a+u>o&&l>a+u&&t+c>s&&r>t+c;return"pointer"==this.options.tolerance||this.options.forcePointerForContainers||"pointer"!=this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>e[this.floating?"width":"height"]?h:s<t+this.helperProportions.width/2&&i-this.helperProportions.width/2<r&&o<a+this.helperProportions.height/2&&n-this.helperProportions.height/2<l},_intersectsWithPointer:function(t){var i="x"===this.options.axis||e.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,t.top,t.height),a="y"===this.options.axis||e.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,t.left,t.width),n=i&&a,s=this._getDragVerticalDirection(),r=this._getDragHorizontalDirection();return n?this.floating?r&&"right"==r||"down"==s?2:1:s&&("down"==s?2:1):!1},_intersectsWithSides:function(t){var i=e.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,t.top+t.height/2,t.height),a=e.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),n=this._getDragVerticalDirection(),s=this._getDragHorizontalDirection();return this.floating&&s?"right"==s&&a||"left"==s&&!a:n&&("down"==n&&i||"up"==n&&!i)},_getDragVerticalDirection:function(){var e=this.positionAbs.top-this.lastPositionAbs.top;return 0!=e&&(e>0?"down":"up")},_getDragHorizontalDirection:function(){var e=this.positionAbs.left-this.lastPositionAbs.left;return 0!=e&&(e>0?"right":"left")},refresh:function(e){return this._refreshItems(e),this.refreshPositions(),this},_connectWith:function(){var e=this.options;return e.connectWith.constructor==String?[e.connectWith]:e.connectWith},_getItemsAsjQuery:function(t){var i=[],a=[],n=this._connectWith();if(n&&t)for(var s=n.length-1;s>=0;s--)for(var r=e(n[s]),o=r.length-1;o>=0;o--){var l=e.data(r[o],this.widgetName);l&&l!=this&&!l.options.disabled&&a.push([e.isFunction(l.options.items)?l.options.items.call(l.element):e(l.options.items,l.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),l])
}a.push([e.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):e(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(var s=a.length-1;s>=0;s--)a[s][0].each(function(){i.push(this)});return e(i)},_removeCurrentsFromItems:function(){var t=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=e.grep(this.items,function(e){for(var i=0;i<t.length;i++)if(t[i]==e.item[0])return!1;return!0})},_refreshItems:function(t){this.items=[],this.containers=[this];var i=this.items,a=[[e.isFunction(this.options.items)?this.options.items.call(this.element[0],t,{item:this.currentItem}):e(this.options.items,this.element),this]],n=this._connectWith();if(n&&this.ready)for(var s=n.length-1;s>=0;s--)for(var r=e(n[s]),o=r.length-1;o>=0;o--){var l=e.data(r[o],this.widgetName);l&&l!=this&&!l.options.disabled&&(a.push([e.isFunction(l.options.items)?l.options.items.call(l.element[0],t,{item:this.currentItem}):e(l.options.items,l.element),l]),this.containers.push(l))}for(var s=a.length-1;s>=0;s--)for(var u=a[s][1],c=a[s][0],o=0,h=c.length;h>o;o++){var d=e(c[o]);d.data(this.widgetName+"-item",u),i.push({item:d,instance:u,width:0,height:0,left:0,top:0})}},refreshPositions:function(t){this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());for(var i=this.items.length-1;i>=0;i--){var a=this.items[i];if(a.instance==this.currentContainer||!this.currentContainer||a.item[0]==this.currentItem[0]){var n=this.options.toleranceElement?e(this.options.toleranceElement,a.item):a.item;t||(a.width=n.outerWidth(),a.height=n.outerHeight());var s=n.offset();a.left=s.left,a.top=s.top}}if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(var i=this.containers.length-1;i>=0;i--){var s=this.containers[i].element.offset();this.containers[i].containerCache.left=s.left,this.containers[i].containerCache.top=s.top,this.containers[i].containerCache.width=this.containers[i].element.outerWidth(),this.containers[i].containerCache.height=this.containers[i].element.outerHeight()}return this},_createPlaceholder:function(t){t=t||this;var i=t.options;if(!i.placeholder||i.placeholder.constructor==String){var a=i.placeholder;i.placeholder={element:function(){var i=e(document.createElement(t.currentItem[0].nodeName)).addClass(a||t.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];return a||(i.style.visibility="hidden"),i},update:function(e,n){(!a||i.forcePlaceholderSize)&&(n.height()||n.height(t.currentItem.innerHeight()-parseInt(t.currentItem.css("paddingTop")||0,10)-parseInt(t.currentItem.css("paddingBottom")||0,10)),n.width()||n.width(t.currentItem.innerWidth()-parseInt(t.currentItem.css("paddingLeft")||0,10)-parseInt(t.currentItem.css("paddingRight")||0,10)))}}}t.placeholder=e(i.placeholder.element.call(t.element,t.currentItem)),t.currentItem.after(t.placeholder),i.placeholder.update(t,t.placeholder)},_contactContainers:function(t){for(var i=null,a=null,n=this.containers.length-1;n>=0;n--)if(!e.contains(this.currentItem[0],this.containers[n].element[0]))if(this._intersectsWith(this.containers[n].containerCache)){if(i&&e.contains(this.containers[n].element[0],i.element[0]))continue;i=this.containers[n],a=n}else this.containers[n].containerCache.over&&(this.containers[n]._trigger("out",t,this._uiHash(this)),this.containers[n].containerCache.over=0);if(i)if(1===this.containers.length)this.containers[a]._trigger("over",t,this._uiHash(this)),this.containers[a].containerCache.over=1;else{for(var s=1e4,r=null,o=this.containers[a].floating?"left":"top",l=this.containers[a].floating?"width":"height",u=this.positionAbs[o]+this.offset.click[o],c=this.items.length-1;c>=0;c--)if(e.contains(this.containers[a].element[0],this.items[c].item[0])&&this.items[c].item[0]!=this.currentItem[0]){var h=this.items[c].item.offset()[o],d=!1;Math.abs(h-u)>Math.abs(h+this.items[c][l]-u)&&(d=!0,h+=this.items[c][l]),Math.abs(h-u)<s&&(s=Math.abs(h-u),r=this.items[c],this.direction=d?"up":"down")}if(!r&&!this.options.dropOnEmpty)return;this.currentContainer=this.containers[a],r?this._rearrange(t,r,null,!0):this._rearrange(t,null,this.containers[a].element,!0),this._trigger("change",t,this._uiHash()),this.containers[a]._trigger("change",t,this._uiHash(this)),this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[a]._trigger("over",t,this._uiHash(this)),this.containers[a].containerCache.over=1}},_createHelper:function(t){var i=this.options,a=e.isFunction(i.helper)?e(i.helper.apply(this.element[0],[t,this.currentItem])):"clone"==i.helper?this.currentItem.clone():this.currentItem;return a.parents("body").length||e("parent"!=i.appendTo?i.appendTo:this.currentItem[0].parentNode)[0].appendChild(a[0]),a[0]==this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(""==a[0].style.width||i.forceHelperSize)&&a.width(this.currentItem.width()),(""==a[0].style.height||i.forceHelperSize)&&a.height(this.currentItem.height()),a},_adjustOffsetFromHelper:function(t){"string"==typeof t&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left"in t&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();return"absolute"==this.cssPosition&&this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&"html"==this.offsetParent[0].tagName.toLowerCase()&&e.ui.ie)&&(t={top:0,left:0}),{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"==this.cssPosition){var e=this.currentItem.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t=this.options;if("parent"==t.containment&&(t.containment=this.helper[0].parentNode),("document"==t.containment||"window"==t.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,e("document"==t.containment?document:window).width()-this.helperProportions.width-this.margins.left,(e("document"==t.containment?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),!/^(document|window|parent)$/.test(t.containment)){var i=e(t.containment)[0],a=e(t.containment).offset(),n="hidden"!=e(i).css("overflow");this.containment=[a.left+(parseInt(e(i).css("borderLeftWidth"),10)||0)+(parseInt(e(i).css("paddingLeft"),10)||0)-this.margins.left,a.top+(parseInt(e(i).css("borderTopWidth"),10)||0)+(parseInt(e(i).css("paddingTop"),10)||0)-this.margins.top,a.left+(n?Math.max(i.scrollWidth,i.offsetWidth):i.offsetWidth)-(parseInt(e(i).css("borderLeftWidth"),10)||0)-(parseInt(e(i).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,a.top+(n?Math.max(i.scrollHeight,i.offsetHeight):i.offsetHeight)-(parseInt(e(i).css("borderTopWidth"),10)||0)-(parseInt(e(i).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(t,i){i||(i=this.position);var a="absolute"==t?1:-1,n=(this.options,"absolute"!=this.cssPosition||this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent),s=/(html|body)/i.test(n[0].tagName);return{top:i.top+this.offset.relative.top*a+this.offset.parent.top*a-("fixed"==this.cssPosition?-this.scrollParent.scrollTop():s?0:n.scrollTop())*a,left:i.left+this.offset.relative.left*a+this.offset.parent.left*a-("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():s?0:n.scrollLeft())*a}},_generatePosition:function(t){var i=this.options,a="absolute"!=this.cssPosition||this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,n=/(html|body)/i.test(a[0].tagName);"relative"==this.cssPosition&&(this.scrollParent[0]==document||this.scrollParent[0]==this.offsetParent[0])&&(this.offset.relative=this._getRelativeOffset());var s=t.pageX,r=t.pageY;if(this.originalPosition&&(this.containment&&(t.pageX-this.offset.click.left<this.containment[0]&&(s=this.containment[0]+this.offset.click.left),t.pageY-this.offset.click.top<this.containment[1]&&(r=this.containment[1]+this.offset.click.top),t.pageX-this.offset.click.left>this.containment[2]&&(s=this.containment[2]+this.offset.click.left),t.pageY-this.offset.click.top>this.containment[3]&&(r=this.containment[3]+this.offset.click.top)),i.grid)){var o=this.originalPageY+Math.round((r-this.originalPageY)/i.grid[1])*i.grid[1];r=this.containment?o-this.offset.click.top<this.containment[1]||o-this.offset.click.top>this.containment[3]?o-this.offset.click.top<this.containment[1]?o+i.grid[1]:o-i.grid[1]:o:o;var l=this.originalPageX+Math.round((s-this.originalPageX)/i.grid[0])*i.grid[0];s=this.containment?l-this.offset.click.left<this.containment[0]||l-this.offset.click.left>this.containment[2]?l-this.offset.click.left<this.containment[0]?l+i.grid[0]:l-i.grid[0]:l:l}return{top:r-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"==this.cssPosition?-this.scrollParent.scrollTop():n?0:a.scrollTop()),left:s-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():n?0:a.scrollLeft())}},_rearrange:function(e,t,i,a){i?i[0].appendChild(this.placeholder[0]):t.item[0].parentNode.insertBefore(this.placeholder[0],"down"==this.direction?t.item[0]:t.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var n=this.counter;this._delay(function(){n==this.counter&&this.refreshPositions(!a)})},_clear:function(t,i){this.reverting=!1;var a=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]==this.currentItem[0]){for(var n in this._storedCSS)("auto"==this._storedCSS[n]||"static"==this._storedCSS[n])&&(this._storedCSS[n]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();this.fromOutside&&!i&&a.push(function(e){this._trigger("receive",e,this._uiHash(this.fromOutside))}),(this.fromOutside||this.domPosition.prev!=this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!=this.currentItem.parent()[0])&&!i&&a.push(function(e){this._trigger("update",e,this._uiHash())}),this!==this.currentContainer&&(i||(a.push(function(e){this._trigger("remove",e,this._uiHash())}),a.push(function(e){return function(t){e._trigger("receive",t,this._uiHash(this))}}.call(this,this.currentContainer)),a.push(function(e){return function(t){e._trigger("update",t,this._uiHash(this))}}.call(this,this.currentContainer))));for(var n=this.containers.length-1;n>=0;n--)i||a.push(function(e){return function(t){e._trigger("deactivate",t,this._uiHash(this))}}.call(this,this.containers[n])),this.containers[n].containerCache.over&&(a.push(function(e){return function(t){e._trigger("out",t,this._uiHash(this))}}.call(this,this.containers[n])),this.containers[n].containerCache.over=0);if(this._storedCursor&&e("body").css("cursor",this._storedCursor),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"==this._storedZIndex?"":this._storedZIndex),this.dragging=!1,this.cancelHelperRemoval){if(!i){this._trigger("beforeStop",t,this._uiHash());for(var n=0;n<a.length;n++)a[n].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!1}if(i||this._trigger("beforeStop",t,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.helper[0]!=this.currentItem[0]&&this.helper.remove(),this.helper=null,!i){for(var n=0;n<a.length;n++)a[n].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!0},_trigger:function(){e.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(t){var i=t||this;return{helper:i.helper,placeholder:i.placeholder||e([]),position:i.position,originalPosition:i.originalPosition,offset:i.positionAbs,item:i.currentItem,sender:t?t.element:null}}})}(jQuery),function(e){var t=5;e.widget("ui.slider",e.ui.mouse,{version:"1.9.1",widgetEventPrefix:"slide",options:{animate:!1,distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null},_create:function(){var i,a,n=this.options,s=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),r="<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",o=[];for(this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget"+" ui-widget-content"+" ui-corner-all"+(n.disabled?" ui-slider-disabled ui-disabled":"")),this.range=e([]),n.range&&(n.range===!0&&(n.values||(n.values=[this._valueMin(),this._valueMin()]),n.values.length&&2!==n.values.length&&(n.values=[n.values[0],n.values[0]])),this.range=e("<div></div>").appendTo(this.element).addClass("ui-slider-range ui-widget-header"+("min"===n.range||"max"===n.range?" ui-slider-range-"+n.range:""))),a=n.values&&n.values.length||1,i=s.length;a>i;i++)o.push(r);this.handles=s.add(e(o.join("")).appendTo(this.element)),this.handle=this.handles.eq(0),this.handles.add(this.range).filter("a").click(function(e){e.preventDefault()}).mouseenter(function(){n.disabled||e(this).addClass("ui-state-hover")}).mouseleave(function(){e(this).removeClass("ui-state-hover")}).focus(function(){n.disabled?e(this).blur():(e(".ui-slider .ui-state-focus").removeClass("ui-state-focus"),e(this).addClass("ui-state-focus"))}).blur(function(){e(this).removeClass("ui-state-focus")}),this.handles.each(function(t){e(this).data("ui-slider-handle-index",t)}),this._on(this.handles,{keydown:function(i){var a,n,s,r,o=e(i.target).data("ui-slider-handle-index");switch(i.keyCode){case e.ui.keyCode.HOME:case e.ui.keyCode.END:case e.ui.keyCode.PAGE_UP:case e.ui.keyCode.PAGE_DOWN:case e.ui.keyCode.UP:case e.ui.keyCode.RIGHT:case e.ui.keyCode.DOWN:case e.ui.keyCode.LEFT:if(i.preventDefault(),!this._keySliding&&(this._keySliding=!0,e(i.target).addClass("ui-state-active"),a=this._start(i,o),a===!1))return}switch(r=this.options.step,n=s=this.options.values&&this.options.values.length?this.values(o):this.value(),i.keyCode){case e.ui.keyCode.HOME:s=this._valueMin();break;case e.ui.keyCode.END:s=this._valueMax();break;case e.ui.keyCode.PAGE_UP:s=this._trimAlignValue(n+(this._valueMax()-this._valueMin())/t);break;case e.ui.keyCode.PAGE_DOWN:s=this._trimAlignValue(n-(this._valueMax()-this._valueMin())/t);break;case e.ui.keyCode.UP:case e.ui.keyCode.RIGHT:if(n===this._valueMax())return;s=this._trimAlignValue(n+r);break;case e.ui.keyCode.DOWN:case e.ui.keyCode.LEFT:if(n===this._valueMin())return;s=this._trimAlignValue(n-r)}this._slide(i,o,s)},keyup:function(t){var i=e(t.target).data("ui-slider-handle-index");this._keySliding&&(this._keySliding=!1,this._stop(t,i),this._change(t,i),e(t.target).removeClass("ui-state-active"))}}),this._refreshValue(),this._animateOff=!1},_destroy:function(){this.handles.remove(),this.range.remove(),this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all"),this._mouseDestroy()},_mouseCapture:function(t){var i,a,n,s,r,o,l,u,c=this,h=this.options;return h.disabled?!1:(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),i={x:t.pageX,y:t.pageY},a=this._normValueFromMouse(i),n=this._valueMax()-this._valueMin()+1,this.handles.each(function(t){var i=Math.abs(a-c.values(t));n>i&&(n=i,s=e(this),r=t)}),h.range===!0&&this.values(1)===h.min&&(r+=1,s=e(this.handles[r])),o=this._start(t,r),o===!1?!1:(this._mouseSliding=!0,this._handleIndex=r,s.addClass("ui-state-active").focus(),l=s.offset(),u=!e(t.target).parents().andSelf().is(".ui-slider-handle"),this._clickOffset=u?{left:0,top:0}:{left:t.pageX-l.left-s.width()/2,top:t.pageY-l.top-s.height()/2-(parseInt(s.css("borderTopWidth"),10)||0)-(parseInt(s.css("borderBottomWidth"),10)||0)+(parseInt(s.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(t,r,a),this._animateOff=!0,!0))},_mouseStart:function(){return!0},_mouseDrag:function(e){var t={x:e.pageX,y:e.pageY},i=this._normValueFromMouse(t);return this._slide(e,this._handleIndex,i),!1},_mouseStop:function(e){return this.handles.removeClass("ui-state-active"),this._mouseSliding=!1,this._stop(e,this._handleIndex),this._change(e,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation="vertical"===this.options.orientation?"vertical":"horizontal"},_normValueFromMouse:function(e){var t,i,a,n,s;return"horizontal"===this.orientation?(t=this.elementSize.width,i=e.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(t=this.elementSize.height,i=e.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),a=i/t,a>1&&(a=1),0>a&&(a=0),"vertical"===this.orientation&&(a=1-a),n=this._valueMax()-this._valueMin(),s=this._valueMin()+a*n,this._trimAlignValue(s)},_start:function(e,t){var i={handle:this.handles[t],value:this.value()};return this.options.values&&this.options.values.length&&(i.value=this.values(t),i.values=this.values()),this._trigger("start",e,i)},_slide:function(e,t,i){var a,n,s;this.options.values&&this.options.values.length?(a=this.values(t?0:1),2===this.options.values.length&&this.options.range===!0&&(0===t&&i>a||1===t&&a>i)&&(i=a),i!==this.values(t)&&(n=this.values(),n[t]=i,s=this._trigger("slide",e,{handle:this.handles[t],value:i,values:n}),a=this.values(t?0:1),s!==!1&&this.values(t,i,!0))):i!==this.value()&&(s=this._trigger("slide",e,{handle:this.handles[t],value:i}),s!==!1&&this.value(i))},_stop:function(e,t){var i={handle:this.handles[t],value:this.value()};this.options.values&&this.options.values.length&&(i.value=this.values(t),i.values=this.values()),this._trigger("stop",e,i)},_change:function(e,t){if(!this._keySliding&&!this._mouseSliding){var i={handle:this.handles[t],value:this.value()};this.options.values&&this.options.values.length&&(i.value=this.values(t),i.values=this.values()),this._trigger("change",e,i)}},value:function(e){return arguments.length?(this.options.value=this._trimAlignValue(e),this._refreshValue(),this._change(null,0),void 0):this._value()},values:function(t,i){var a,n,s;if(arguments.length>1)return this.options.values[t]=this._trimAlignValue(i),this._refreshValue(),this._change(null,t),void 0;if(!arguments.length)return this._values();if(!e.isArray(arguments[0]))return this.options.values&&this.options.values.length?this._values(t):this.value();for(a=this.options.values,n=arguments[0],s=0;s<a.length;s+=1)a[s]=this._trimAlignValue(n[s]),this._change(null,s);this._refreshValue()},_setOption:function(t,i){var a,n=0;switch(e.isArray(this.options.values)&&(n=this.options.values.length),e.Widget.prototype._setOption.apply(this,arguments),t){case"disabled":i?(this.handles.filter(".ui-state-focus").blur(),this.handles.removeClass("ui-state-hover"),this.handles.prop("disabled",!0),this.element.addClass("ui-disabled")):(this.handles.prop("disabled",!1),this.element.removeClass("ui-disabled"));break;case"orientation":this._detectOrientation(),this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation),this._refreshValue();break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":for(this._animateOff=!0,this._refreshValue(),a=0;n>a;a+=1)this._change(null,a);this._animateOff=!1;break;case"min":case"max":this._animateOff=!0,this._refreshValue(),this._animateOff=!1}},_value:function(){var e=this.options.value;return e=this._trimAlignValue(e)},_values:function(e){var t,i,a;if(arguments.length)return t=this.options.values[e],t=this._trimAlignValue(t);for(i=this.options.values.slice(),a=0;a<i.length;a+=1)i[a]=this._trimAlignValue(i[a]);return i},_trimAlignValue:function(e){if(e<=this._valueMin())return this._valueMin();if(e>=this._valueMax())return this._valueMax();var t=this.options.step>0?this.options.step:1,i=(e-this._valueMin())%t,a=e-i;return 2*Math.abs(i)>=t&&(a+=i>0?t:-t),parseFloat(a.toFixed(5))},_valueMin:function(){return this.options.min},_valueMax:function(){return this.options.max},_refreshValue:function(){var t,i,a,n,s,r=this.options.range,o=this.options,l=this,u=this._animateOff?!1:o.animate,c={};this.options.values&&this.options.values.length?this.handles.each(function(a){i=100*((l.values(a)-l._valueMin())/(l._valueMax()-l._valueMin())),c["horizontal"===l.orientation?"left":"bottom"]=i+"%",e(this).stop(1,1)[u?"animate":"css"](c,o.animate),l.options.range===!0&&("horizontal"===l.orientation?(0===a&&l.range.stop(1,1)[u?"animate":"css"]({left:i+"%"},o.animate),1===a&&l.range[u?"animate":"css"]({width:i-t+"%"},{queue:!1,duration:o.animate})):(0===a&&l.range.stop(1,1)[u?"animate":"css"]({bottom:i+"%"},o.animate),1===a&&l.range[u?"animate":"css"]({height:i-t+"%"},{queue:!1,duration:o.animate}))),t=i}):(a=this.value(),n=this._valueMin(),s=this._valueMax(),i=s!==n?100*((a-n)/(s-n)):0,c["horizontal"===this.orientation?"left":"bottom"]=i+"%",this.handle.stop(1,1)[u?"animate":"css"](c,o.animate),"min"===r&&"horizontal"===this.orientation&&this.range.stop(1,1)[u?"animate":"css"]({width:i+"%"},o.animate),"max"===r&&"horizontal"===this.orientation&&this.range[u?"animate":"css"]({width:100-i+"%"},{queue:!1,duration:o.animate}),"min"===r&&"vertical"===this.orientation&&this.range.stop(1,1)[u?"animate":"css"]({height:i+"%"},o.animate),"max"===r&&"vertical"===this.orientation&&this.range[u?"animate":"css"]({height:100-i+"%"},{queue:!1,duration:o.animate}))}})}(jQuery),function(e){function t(t,i){var a=(t.attr("aria-describedby")||"").split(/\s+/);a.push(i),t.data("ui-tooltip-id",i).attr("aria-describedby",e.trim(a.join(" ")))}function i(t){var i=t.data("ui-tooltip-id"),a=(t.attr("aria-describedby")||"").split(/\s+/),n=e.inArray(i,a);-1!==n&&a.splice(n,1),t.removeData("ui-tooltip-id"),a=e.trim(a.join(" ")),a?t.attr("aria-describedby",a):t.removeAttr("aria-describedby")}var a=0;e.widget("ui.tooltip",{version:"1.9.1",options:{content:function(){return e(this).attr("title")},hide:!0,items:"[title]:not([disabled])",position:{my:"left top+15",at:"left bottom",collision:"flipfit flipfit"},show:!0,tooltipClass:null,track:!1,close:null,open:null},_create:function(){this._on({mouseover:"open",focusin:"open"}),this.tooltips={},this.parents={},this.options.disabled&&this._disable()},_setOption:function(t,i){var a=this;return"disabled"===t?(this[i?"_disable":"_enable"](),this.options[t]=i,void 0):(this._super(t,i),"content"===t&&e.each(this.tooltips,function(e,t){a._updateContent(t)}),void 0)},_disable:function(){var t=this;e.each(this.tooltips,function(i,a){var n=e.Event("blur");n.target=n.currentTarget=a[0],t.close(n,!0)}),this.element.find(this.options.items).andSelf().each(function(){var t=e(this);t.is("[title]")&&t.data("ui-tooltip-title",t.attr("title")).attr("title","")})},_enable:function(){this.element.find(this.options.items).andSelf().each(function(){var t=e(this);t.data("ui-tooltip-title")&&t.attr("title",t.data("ui-tooltip-title"))})},open:function(t){var i=this,a=e(t?t.target:this.element).closest(this.options.items);if(a.length)return this.options.track&&a.data("ui-tooltip-id")?(this._find(a).position(e.extend({of:a},this.options.position)),this._off(this.document,"mousemove"),void 0):(a.attr("title")&&a.data("ui-tooltip-title",a.attr("title")),a.data("tooltip-open",!0),t&&"mouseover"===t.type&&a.parents().each(function(){var t;e(this).data("tooltip-open")&&(t=e.Event("blur"),t.target=t.currentTarget=this,i.close(t,!0)),this.title&&(e(this).uniqueId(),i.parents[this.id]={element:this,title:this.title},this.title="")}),this._updateContent(a,t),void 0)},_updateContent:function(e,t){var i,a=this.options.content,n=this;return"string"==typeof a?this._open(t,e,a):(i=a.call(e[0],function(i){e.data("tooltip-open")&&n._delay(function(){this._open(t,e,i)})}),i&&this._open(t,e,i),void 0)},_open:function(i,a,n){function s(e){u.of=e,r.is(":hidden")||r.position(u)}var r,o,l,u=e.extend({},this.options.position);if(n){if(r=this._find(a),r.length)return r.find(".ui-tooltip-content").html(n),void 0;a.is("[title]")&&(i&&"mouseover"===i.type?a.attr("title",""):a.removeAttr("title")),r=this._tooltip(a),t(a,r.attr("id")),r.find(".ui-tooltip-content").html(n),this.options.track&&i&&/^mouse/.test(i.originalEvent.type)?(this._on(this.document,{mousemove:s}),s(i)):r.position(e.extend({of:a},this.options.position)),r.hide(),this._show(r,this.options.show),this.options.show&&this.options.show.delay&&(l=setInterval(function(){r.is(":visible")&&(s(u.of),clearInterval(l))},e.fx.interval)),this._trigger("open",i,{tooltip:r}),o={keyup:function(t){if(t.keyCode===e.ui.keyCode.ESCAPE){var i=e.Event(t);i.currentTarget=a[0],this.close(i,!0)}},remove:function(){this._removeTooltip(r)}},i&&"mouseover"!==i.type||(o.mouseleave="close"),i&&"focusin"!==i.type||(o.focusout="close"),this._on(a,o)}},close:function(t){var a=this,n=e(t?t.currentTarget:this.element),s=this._find(n);this.closing||(n.data("ui-tooltip-title")&&n.attr("title",n.data("ui-tooltip-title")),i(n),s.stop(!0),this._hide(s,this.options.hide,function(){a._removeTooltip(e(this))}),n.removeData("tooltip-open"),this._off(n,"mouseleave focusout keyup"),n[0]!==this.element[0]&&this._off(n,"remove"),this._off(this.document,"mousemove"),t&&"mouseleave"===t.type&&e.each(this.parents,function(e,t){t.element.title=t.title,delete a.parents[e]}),this.closing=!0,this._trigger("close",t,{tooltip:s}),this.closing=!1)},_tooltip:function(t){var i="ui-tooltip-"+a++,n=e("<div>").attr({id:i,role:"tooltip"}).addClass("ui-tooltip ui-widget ui-corner-all ui-widget-content "+(this.options.tooltipClass||""));return e("<div>").addClass("ui-tooltip-content").appendTo(n),n.appendTo(this.document[0].body),e.fn.bgiframe&&n.bgiframe(),this.tooltips[i]=t,n},_find:function(t){var i=t.data("ui-tooltip-id");return i?e("#"+i):e()},_removeTooltip:function(e){e.remove(),delete this.tooltips[e.attr("id")]},_destroy:function(){var t=this;e.each(this.tooltips,function(i,a){var n=e.Event("blur");n.target=n.currentTarget=a[0],t.close(n,!0),e("#"+i).remove(),a.data("ui-tooltip-title")&&(a.attr("title",a.data("ui-tooltip-title")),a.removeData("ui-tooltip-title"))})}})}(jQuery),jQuery.base64=function(){function e(e,t){var i=s.indexOf(e.charAt(t));if(-1===i)throw"Cannot decode base64";return i}function t(t){var i,a,s=0,r=t.length,o=[];if(t=String(t),0===r)return t;if(0!==r%4)throw"Cannot decode base64";for(t.charAt(r-1)===n&&(s=1,t.charAt(r-2)===n&&(s=2),r-=4),i=0;r>i;i+=4)a=e(t,i)<<18|e(t,i+1)<<12|e(t,i+2)<<6|e(t,i+3),o.push(String.fromCharCode(a>>16,255&a>>8,255&a));switch(s){case 1:a=e(t,i)<<18|e(t,i+1)<<12|e(t,i+2)<<6,o.push(String.fromCharCode(a>>16,255&a>>8));break;case 2:a=e(t,i)<<18|e(t,i+1)<<12,o.push(String.fromCharCode(a>>16))}return o.join("")}function i(e,t){var i=e.charCodeAt(t);if(i>255)throw"INVALID_CHARACTER_ERR: DOM Exception 5";return i}function a(e){if(1!==arguments.length)throw"SyntaxError: exactly one argument required";e=String(e);var t,a,r=[],o=e.length-e.length%3;if(0===e.length)return e;for(t=0;o>t;t+=3)a=i(e,t)<<16|i(e,t+1)<<8|i(e,t+2),r.push(s.charAt(a>>18)),r.push(s.charAt(63&a>>12)),r.push(s.charAt(63&a>>6)),r.push(s.charAt(63&a));switch(e.length-o){case 1:a=i(e,t)<<16,r.push(s.charAt(a>>18)+s.charAt(63&a>>12)+n+n);break;case 2:a=i(e,t)<<16|i(e,t+1)<<8,r.push(s.charAt(a>>18)+s.charAt(63&a>>12)+s.charAt(63&a>>6)+n)}return r.join("")}var n="=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r="1.0";return{decode:t,encode:a,VERSION:r}}(jQuery),Oskari.clazz.define("Oskari.framework.bundle.oskariui.DomManager",function(e,t){this.$=e,this.partsMap=t||{},this.layout=null,this.layouts=[]},{getEl:function(e){return this.$(e)},getElForPart:function(e){return this.$(this.partsMap[e])},setElForPart:function(e,t){this.partsMap[e]=this.$(t)},setElParts:function(e){this.partsMap=e},getElParts:function(){return this.partsMap},pushLayout:function(e){this.layout&&this.layout.removeLayout(this),this.layout=e,this.layouts.push(e),e.applyLayout(this)},popLayout:function(){var e=this.layouts.pop();if(e&&e.removeLayout(this),0==this.layouts.length)return this.layout=null,void 0;var e=this.layouts[this.layouts.length-1];this.layout=e,e.applyLayout(this)},getLayout:function(){return this.layout}},{protocol:["Oskari.dom.DomManager"]}),Oskari.clazz.define("Oskari.framework.bundle.oskariui.Layout",function(){},{applyLayout:function(){},removeLayout:function(){}},{protocol:["Oskari.dom.Layout"]}),Oskari.clazz.define("Oskari.mapframework.request.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/request/request.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"request-base","Bundle-Name":"mapframework.request.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.request.Bundle",Title:" mapframework.request.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("request-base","Oskari.mapframework.request.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.request.Request",function(){throw this._creator=null,"mapframework.request.Request should not be used"},{getName:function(){throw"Running default implementation of Request.getName(). implement your own!"},setCreator:function(e){this._creator=e},getCreator:function(){return this._creator}}),Oskari.clazz.define("Oskari.mapframework.domain.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/domain/AbstractLayer.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/wmslayer.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/vectorlayer.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/map.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/style.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/tool.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/user.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"domain","Bundle-Name":"mapframework.domain.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.domain.Bundle",Title:" mapframework.domain.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("domain","Oskari.mapframework.domain.Bundle"),Oskari.clazz.define("Oskari.mapframework.domain.AbstractLayer",function(e,t){this._id=null,this._name=null,this._description=null,this._type=null,this._layerType="",this._params=e||{},this._options=t||{},this._metaType=null,this._maxScale=null,this._minScale=null,this._visible=null,this._opacity=100,this._isSticky=null,this._inspireName=null,this._organizationName=null,this._dataUrl=null,this._orderNumber=null,this._subLayers=[],this._styles=[],this._currentStyle=null,this._legendImage=null,this._featureInfoEnabled=null,this._queryable=null,this._queryFormat=null,this._permissions={},this._geometry=[],this._geometryWKT=null,this._tools=[],this._metadataIdentifier=null,this._backendStatus=null
},{setId:function(e){this._id=e},getId:function(){return this._id},setQueryFormat:function(e){this._queryFormat=e},getQueryFormat:function(){return this._queryFormat},setName:function(e){this._name=e},getName:function(){return this._name},setType:function(e){this._type=e},getType:function(){return this._type},setDataUrl:function(e){this._dataUrl=e},getDataUrl:function(){return this._dataUrl},setOrganizationName:function(e){this._organizationName=e},getOrganizationName:function(){return this._organizationName},setInspireName:function(e){this._inspireName=e},getInspireName:function(){return this._inspireName},setFeatureInfoEnabled:function(e){this._featureInfoEnabled=e},isFeatureInfoEnabled:function(){return this._featureInfoEnabled===!0?!0:!1},setDescription:function(e){this._description=e},getDescription:function(){return this._description},addSubLayer:function(e){this._subLayers.push(e)},getSubLayers:function(){return this._subLayers},setMaxScale:function(e){this._maxScale=e},getMaxScale:function(){return this._maxScale},setMinScale:function(e){this._minScale=e},getMinScale:function(){return this._minScale},setOrderNumber:function(e){this._orderNumber=e},getOrderNumber:function(){return this._orderNumber},isVisible:function(){return this._visible===!0},setVisible:function(e){this._visible=e},setOpacity:function(e){this._opacity=e},getOpacity:function(){return this._opacity},setGeometryWKT:function(e){this._geometryWKT=e},getGeometryWKT:function(){return this._geometryWKT},setGeometry:function(e){this._geometry=e},getGeometry:function(){return this._geometry},addPermission:function(e,t){this._permissions[e]=t},removePermission:function(e){this._permissions[e]=null,delete this._permissions[e]},getPermission:function(e){return this._permissions[e]},getMetadataIdentifier:function(){return this._metadataIdentifier},setMetadataIdentifier:function(e){this._metadataIdentifier=e},getBackendStatus:function(){return this._backendStatus},setBackendStatus:function(e){this._backendStatus=e},setMetaType:function(e){this._metaType=e},getMetaType:function(){return this._metaType},addStyle:function(e){this._styles.push(e)},getStyles:function(){return this._styles},selectStyle:function(e){var t=this,i=null;if(!(t._styles.length>0))return i=Oskari.clazz.create("Oskari.mapframework.domain.Style"),i.setName(""),i.setTitle(""),i.setLegend(""),t._currentStyle=i,void 0;if(""===e)return t._styles.length>1?t._currentStyle=t._styles[0]:(i=Oskari.clazz.create("Oskari.mapframework.domain.Style"),i.setName(""),i.setTitle(""),i.setLegend(""),t._currentStyle=i),void 0;for(var a=0;a<t._styles.length;a++)if(i=t._styles[a],i.getName()==e)return t._currentStyle=i,""!=i.getLegend()&&(t._legendImage=i.getLegend()),void 0},getCurrentStyle:function(){return this._currentStyle},getTools:function(){return this._tools},setTools:function(e){this._tools=e},addTool:function(e){this._tools.push(e)},getTool:function(e){var t=null;if(this._tools.length>0&&""!==e)for(var i=0;i<this._tools.length;i++)if(t=this._tools[i],t.getName()==e)return t;return t},setLegendImage:function(e){this._legendImage=e},getLegendImage:function(){return this._legendImage},hasLegendImage:function(){if(this._legendImage)return!0;for(var e=0;e<this._styles.length;++e)if(this._styles[e].getLegend())return!0;return!1},setSticky:function(e){this._isSticky=e},isSticky:function(){return this._isSticky},setQueryable:function(e){this._queryable=e},getQueryable:function(){return this._queryable},setAsBaseLayer:function(){this._type="BASE_LAYER"},setAsNormalLayer:function(){this._type="NORMAL_LAYER"},setAsGroupLayer:function(){this._type="GROUP_LAYER"},isGroupLayer:function(){return"GROUP_LAYER"===this._type},isBaseLayer:function(){return"BASE_LAYER"===this._type},isInScale:function(e){var t=this.isBaseLayer();if(!e){var i=Oskari.$().sandbox;e=i.getMap().getScale()}return this.isBaseLayer()||((e>this.getMaxScale()||!this.getMaxScale())&&e<this.getMinScale()||!this.getMinScale())&&(t=!0),t},getLayerType:function(){return this._layerType.toLowerCase()},isLayerOfType:function(e){return e&&e.toLowerCase()===this.getLayerType()},getIconClassname:function(){return this.isBaseLayer()?"layer-base":this.isGroupLayer()?"layer-group":"layer-"+this.getLayerType()},getParams:function(){return this._params},getOptions:function(){return this._options}}),Oskari.clazz.define("Oskari.mapframework.domain.WmsLayer",function(){this._wmsLayerName=null,this._wmsUrls=[],this._layerType="WMS"},{addWmsUrl:function(e){this._wmsUrls.push(e)},setWmsUrl:function(e){this._wmsUrls=[e]},getWmsUrls:function(){return this._wmsUrls},setWmsName:function(e){this._wmsName=e},getWmsName:function(){return this._wmsName}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.domain.VectorLayer",function(){this._sldspec=null,this._layerType="VECTOR"},{setStyledLayerDescriptor:function(e){this._sldspec=e},getStyledLayerDescriptor:function(){return this._sldspec}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.domain.Map",function(){this._centerX=null,this._centerY=null,this._zoom=null,this._scale=null,this._bbox=null,this._markerVisible=null,this.width=null,this.height=null,this.resolution=null,this.extent=null,this.maxExtent=null,this._isMoving=!1,this._projectionCode="EPSG:3067"},{moveTo:function(e,t,i){this._centerX=e,this._centerY=t,this._zoom=i},setMoving:function(e){this._isMoving=e},isMoving:function(){return this._isMoving},getX:function(){return this._centerX},getY:function(){return this._centerY},getZoom:function(){return this._zoom},setScale:function(e){this._scale=e},getScale:function(){return this._scale},setBbox:function(e){this._bbox=e},getBbox:function(){return this._bbox},setMarkerVisible:function(e){this._markerVisible=e===!0||"true"===e},isMarkerVisible:function(){return this._markerVisible===!0?!0:!1},setWidth:function(e){this.width=e},getWidth:function(){return this.width},setHeight:function(e){this.height=e},getHeight:function(){return this.height},setResolution:function(e){this.resolution=e},getResolution:function(){return this.resolution},setExtent:function(e){this.extent=e},getExtent:function(){return this.extent},setMaxExtent:function(e){this.maxExtent=e},getMaxExtent:function(){return this.maxExtent},setSrsName:function(e){this._projectionCode=e},getSrsName:function(){return this._projectionCode}}),Oskari.clazz.define("Oskari.mapframework.domain.Style",function(){this._name=null,this._title=null,this._legend=null},{setName:function(e){this._name=e},getName:function(){return this._name},setTitle:function(e){this._title=e},getTitle:function(){return this._title},setLegend:function(e){this._legend=e},getLegend:function(){return this._legend}}),Oskari.clazz.define("Oskari.mapframework.domain.Tool",function(){this._name=null,this._title=null,this._tooltip=null,this._iconCls=null,this._callback=null},{setName:function(e){this._name=e},getName:function(){return this._name},setTitle:function(e){this._title=e},getTitle:function(){return this._title},setTooltip:function(e){this._tooltip=e},getTooltip:function(){return this._tooltip},setIconCls:function(e){this._iconCls=e},getIconCls:function(){return this._iconCls},setCallback:function(e){this._callback=e},getCallback:function(){return this._callback}}),Oskari.clazz.define("Oskari.mapframework.domain.User",function(e){this._loggedIn=!1,e&&(this._firstName=e.firstName,this._lastName=e.lastName,this._nickName=e.nickName,this._loginName=e.loginName,this._uuid=e.userUUID,e.userUUID&&(this._loggedIn=!0))},{getName:function(){return this._firstName+" "+this._lastName},getFirstName:function(){return this._firstName},getLastName:function(){return this._lastName},getNickName:function(){return this._nickName},getLoginName:function(){return this._loginName},getUuid:function(){return this._uuid},isLoggedIn:function(){return this._loggedIn}}),Oskari.clazz.define("Oskari.mapframework.core.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/core/core-map-layer-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/core/core-map-methods.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"core-map","Bundle-Name":"mapframework.core.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.core.Bundle",Title:" mapframework.core.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("core-map","Oskari.mapframework.core.map.Bundle"),Oskari.clazz.category("Oskari.mapframework.core.Core","map-layer-methods",{isLayerAlreadySelected:function(e){var t=this.getService("Oskari.mapframework.service.MapLayerService"),i=t.findMapLayer(e,this._selectedLayers);return null!=i},findMapLayerFromSelectedMapLayers:function(e){var t=this.getService("Oskari.mapframework.service.MapLayerService"),i=t.findMapLayer(e,this._selectedLayers);return i},isMapLayerAlreadyHighlighted:function(e){var t=this.getService("Oskari.mapframework.service.MapLayerService"),i=t.findMapLayer(e,this._mapLayersHighlighted);return null==i&&this.printDebug("[core-map-layer-methods] "+e+" is not yet highlighted."),null!=i},findMapLayerFromAllAvailable:function(e){var t=this.getService("Oskari.mapframework.service.MapLayerService"),i=t.findMapLayer(e);return null==i&&this.printDebug("Cannot find map layer with id '"+e+"' from all available. "+"Check that current user has VIEW permissions to that layer."),i},getAllSelectedLayers:function(){return this._selectedLayers},getAllHighlightedMapLayers:function(){return this._mapLayersHighlighted},allowMultipleHighlightLayers:function(e){this._allowMultipleHighlightLayers=e},_handleAddMapLayerRequest:function(e){var t=this,i=e.getMapLayerId(),a=e.getKeepLayersOrder(),n=e.isBasemap();if(t.printDebug("Trying to add map layer with id '"+i+"' AS "+(n?" BASE ":" NORMAL ")),t.isLayerAlreadySelected(i))return t.printDebug("Attempt to select already selected layer '"+i+"'"),void 0;var s=t.findMapLayerFromAllAvailable(i);if(!s)return t.printDebug("Attempt to select layer that is not available '"+i+"'"),void 0;if(1==n&&s.setType("BASE_LAYER"),null!=a&&a)this._selectedLayers.push(s);else if(s.isBaseLayer()||1==n){var r=[];r.push(s);for(var o=0;o<this._selectedLayers.length;o++)r.push(this._selectedLayers[o]);delete this._selectedLayers,this._selectedLayers=r}else this._selectedLayers.push(s);var l;l=s.isBaseLayer()||n?t.getEventBuilder("AfterMapLayerAddEvent")(s,a,n):t.getEventBuilder("AfterMapLayerAddEvent")(s,!0,n),t.copyObjectCreatorToFrom(l,e),t.dispatch(l)},_handleRemoveMapLayerRequest:function(e){var t=this,i=e.getMapLayerId();if(t.printDebug("Trying to remove map layer with id '"+i+"'"),!t.isLayerAlreadySelected(i))return t.printDebug("Attempt to remove layer '"+i+"' that is not selected."),void 0;for(var a=t.findMapLayerFromAllAvailable(i),n=-1,s=0;s<t._selectedLayers.length;s++)if(t._selectedLayers[s]===a){n=s;break}t._selectedLayers.splice(n,1),t.isMapLayerAlreadyHighlighted(i)&&(t.printDebug("Maplayer is also highlighted, removing it from highlight list."),t._handleDimMapLayerRequest(i));var r=t.getEventBuilder("AfterMapLayerRemoveEvent")(a);t.copyObjectCreatorToFrom(r,e),t.dispatch(r)},_handleShowMapLayerInfoRequest:function(e){var t=this.findMapLayerFromAllAvailable(e.getMapLayerId()),i=this.getEventBuilder("AfterShowMapLayerInfoEvent")(t);this.copyObjectCreatorToFrom(i,e),this.dispatch(i)},_handleRearrangeSelectedMapLayerRequest:function(e){var t=e.getToPosition(),i=e.getMapLayerId(),a=null,n=0;if(null!=i&&null!=t){a=this.findMapLayerFromSelectedMapLayers(i);for(var s=new Array,r=0,o=0,l=0;t>r;l++){o++;var u=this._selectedLayers[l];u.getId()!=i?(s.push(u),r++):n=l}s.push(a);for(var l=o;l<this._selectedLayers.length;l++){var u=this._selectedLayers[l];u.getId()!=i?s.push(u):n=l}delete this._selectedLayers,this._selectedLayers=s}var c=this.getEventBuilder("AfterRearrangeSelectedMapLayerEvent")(a,n,t);this.copyObjectCreatorToFrom(c,e),this.dispatch(c)},_handleChangeMapLayerOpacityRequest:function(e){var t=this.findMapLayerFromSelectedMapLayers(e.getMapLayerId());if(t){t.setOpacity(e.getOpacity());var i=this.getEventBuilder("AfterChangeMapLayerOpacityEvent")(t);this.copyObjectCreatorToFrom(i,e),this.dispatch(i)}},_handleChangeMapLayerStyleRequest:function(e){var t=this.findMapLayerFromSelectedMapLayers(e.getMapLayerId());if(t&&"!default!"!=e.getStyle()){t.selectStyle(e.getStyle());var i=this.getEventBuilder("AfterChangeMapLayerStyleEvent")(t);this.copyObjectCreatorToFrom(i,e),this.dispatch(i)}},_removeHighLightedMapLayer:function(e){for(var t=this.getAllHighlightedMapLayers(),i=0;i<t.length;i++){var a=t[i];if(!e||a.getId()==e){t.splice(i);var n=this.getEventBuilder("AfterDimMapLayerEvent")(a);return this.dispatch(n),void 0}}},_handleHighlightMapLayerRequest:function(e){this.getObjectCreator(e);var t=e.getMapLayerId();if(this.printDebug("[core-map-layer-methods] Trying to highlight map layer with id '"+t+"'"),this.isMapLayerAlreadyHighlighted(t))return this.printWarn("[core-map-layer-methods] Attempt to highlight already highlighted wms feature info map layer '"+t+"'"),void 0;1==this._allowMultipleHighlightLayers?this._removeHighLightedMapLayer(t):this._removeHighLightedMapLayer();var i=this.findMapLayerFromSelectedMapLayers(t);if(i){this._mapLayersHighlighted.push(i),this.printDebug("[core-map-layer-methods] Adding "+i+" ("+i.getId()+") to highlighted list.");var a=this.getEventBuilder("AfterHighlightMapLayerEvent")(i);this.copyObjectCreatorToFrom(a,e),this.dispatch(a)}},_handleDimMapLayerRequest:function(e){1==this._allowMultipleHighlightLayers?this._removeHighLightedMapLayer(e):this._removeHighLightedMapLayer();var t=this.findMapLayerFromAllAvailable(e);if(t){var i=this.getEventBuilder("AfterDimMapLayerEvent")(t);this.dispatch(i)}}}),Oskari.clazz.category("Oskari.mapframework.core.Core","map-methods",{_handleHideMapMarkerRequest:function(e){this._map.setMarkerVisible(!1);var t=this.getEventBuilder("AfterHideMapMarkerEvent")();this.copyObjectCreatorToFrom(t,e),this.dispatch(t)}}),Oskari.clazz.define("Oskari.mapframework.request.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/request/common/add-map-layer-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/remove-map-layer-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/map-move-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/show-map-layer-info-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/hide-map-marker-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/ctrl-key-down-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/ctrl-key-up-request.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"request-map","Bundle-Name":"mapframework.request.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.request.Bundle",Title:" mapframework.request.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("request-map","Oskari.mapframework.request.map.Bundle"),Oskari.clazz.define("Oskari.mapframework.request.common.AddMapLayerRequest",function(e,t,i,a){this._creator=null,this._mapLayerId=e,this._keepLayersOrder=1==t,this._isExternal=1==a,this._isBasemap=1==i},{__name:"AddMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId},getKeepLayersOrder:function(){return this._keepLayersOrder},isBasemap:function(){return this._isBasemap},isExternal:function(){return this._isExternal}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.RemoveMapLayerRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"RemoveMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.MapMoveRequest",function(e,t,i,a,n){this._creator=null,this._centerX=e,this._centerY=t,this._zoom=i,this._marker=a,this._projectionCode=n},{__name:"MapMoveRequest",getName:function(){return this.__name},getCenterX:function(){return this._centerX},getCenterY:function(){return this._centerY},getZoom:function(){return this._zoom},getMarker:function(){return this._marker},getSrsName:function(){return this._projectionCode}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.ShowMapLayerInfoRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"ShowMapLayerInfoRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.HideMapMarkerRequest",function(){this._creator=null},{__name:"HideMapMarkerRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.CtrlKeyDownRequest",function(){},{__name:"CtrlKeyDownRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.CtrlKeyUpRequest",function(){},{__name:"CtrlKeyUpRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.sandbox.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox.js"},{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-key-listener-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-state-methods.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"sandbox-base","Bundle-Name":"mapframework.sandbox.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.sandbox.Bundle",Title:" mapframework.sandbox.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("sandbox-base","Oskari.mapframework.sandbox.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.sandbox.Sandbox",function(e){this._core=e,this._listeners=new Array,this._modules=new Array,this._modulesByName={},this._statefuls={},this.debugRequests=!1,this.debugEvents=!1,this.requestEventLog=[],this.requestEventStack=[],this.gatherDebugRequests=!1,this.maxGatheredRequestsAndEvents=4096,this.requestAndEventGather=[],this._eventLoopGuard=0,this._user=null,this._ajaxUrl=null},{disableDebug:function(){this.debugRequests=!1,this.debugEvents=!1,this.gatherDebugRequests=!1,this._core&&this._core.disableDebug()},enableDebug:function(){this.debugRequests=!0,this.debugEvents=!0,this.gatherDebugRequests=!0,this._core&&this._core.enableDebug()},printDebug:function(e){this._core.printDebug(e)},printWarn:function(e){this._core.printWarn(e)},setUser:function(e){this._user=Oskari.clazz.create("Oskari.mapframework.domain.User",e)},getUser:function(){return this._user||this.setUser(),this._user},setAjaxUrl:function(e){this._ajaxUrl=e},getAjaxUrl:function(){return this._ajaxUrl},registerService:function(e){this._core.registerService(e)},getService:function(e){return this._core.getService(e)},registerAsStateful:function(e,t){this._statefuls[e]=t},unregisterStateful:function(e){this._statefuls[e]=null,delete this._statefuls[e]},getStatefulComponents:function(){return this._statefuls},register:function(e){return this._modules.push(e),this._modulesByName[e.getName()]=e,e.init(this)},unregister:function(e){for(var t=[],i=0;i<this._modules.length;i++)e!==this._modules[i]&&t.push(this._modules[i]);this._modules=t,this._modulesByName[e.getName()]=void 0,delete this._modulesByName[e.getName()]},registerForEventByName:function(e,t){this._core.printDebug("#*#*#* Sandbox is registering module '"+e.getName()+"' to event '"+t+"'");var i=this._listeners[t];null==i&&(i=new Array,this._listeners[t]=i),i.push(e),this._core.printDebug("There are currently "+i.length+" listeners for event '"+t+"'")},unregisterFromEventByName:function(e,t){this._core.printDebug("Sandbox is unregistering module '"+e.getName()+"' from event '"+t+"'");var i=this._listeners[t];if(null==i)return this._core.printDebug("Module does not listen to that event, skipping."),void 0;for(var a=-1,n=0;n<i.length;n++)if(i[n]==e){a=n;break}a>-1?(i.splice(a,1),this._core.printDebug("Module unregistered successfully from event")):this._core.printDebug("Module does not listen to that event, skipping.")},getRequestBuilder:function(e){return this._core.getRequestBuilder(e)},getEventBuilder:function(e){return this._core.getEventBuilder(e)},request:function(e,t){var i=null;i=null!=e.getName?e.getName():e;var a=this.findRegisteredModuleInstance(i);if(null==a)throw"Attempt to create request with unknown component '"+e+"' as creator";this._core.setObjectCreator(t,i),this.printDebug("Module '"+i+"' is requesting for '"+this.getObjectName(t)+"'..."),this.gatherDebugRequests&&this._pushRequestAndEventGather(i+"->Sandbox: ",this.getObjectName(t));var n=null;return this._debugPushRequest(i,t),n=this._core.processRequest(t),this._debugPopRequest(),n},requestByName:function(e,t,i){this.printDebug("#!#!#! --------------> requestByName "+t);var a=this.getRequestBuilder(t),n=a.apply(this,i||[]);return this.request(e,n)},postMasterComponent:"postmaster",postRequestByName:function(e,t){var i=this,a=i.getRequestBuilder(e);a&&window.setTimeout(function(){var e=a.apply(i,t||[]),n=this.postMasterComponent;i._core.setObjectCreator(e,n),i.gatherDebugRequests&&i._pushRequestAndEventGather(n+"->Sandbox: ",i.getObjectName(e));var s=null;this.debugRequests&&i._debugPushRequest(n,e),s=i._core.processRequest(e),this.debugRequests&&i._debugPopRequest()},0)},_findModulesInterestedIn:function(e){var t=e.getName(),i=this._listeners[t];return i?i:[]},notifyAll:function(e,t){var i;t||(i=e.getName(),this._core.printDebug("Sandbox received notifyall for event '"+i+"'"));var a=this._findModulesInterestedIn(e);t||this._core.printDebug("Found "+a.length+" interested modules");for(var n=0;n<a.length;n++){var s=a[n];t||(this._core.printDebug("Notifying module '"+s.getName()+"'."),this.gatherDebugRequests&&this._pushRequestAndEventGather("Sandbox->"+s.getName()+":",i)),this._debugPushEvent(this.getObjectCreator(e),s,e),s.onEvent(e),this._debugPopEvent()}t||delete e},findRegisteredModuleInstance:function(e){return this._modulesByName[e]},getRequestParameter:function(e){return this._core.getRequestParameter(e)},getBrowserWindowSize:function(){jQuery.browser.opera&&null!=window.innerHeight&&window.innerHeight;var e=jQuery(window).width(),t={};return t.height=jQuery(window).height(),t.width=e,this.printDebug("Got browser window size is: width: "+t.width+" px, height:"+t.height+" px."),t},getObjectName:function(e){return this._core.getObjectName(e)},getObjectCreator:function(e){return this._core.getObjectCreator(e)},setObjectCreator:function(e,t){return this._core.setObjectCreator(e,t)},copyObjectCreatorToFrom:function(e,t){return this._core.copyObjectCreatorToFrom(e,t)},addRequestHandler:function(e,t){return this._core.addRequestHandler(e,t)},removeRequestHandler:function(e,t){return this._core.removeRequestHandler(e,t)},_debugPushRequest:function(e,t){if(this.debugRequests){var i={from:e,reqName:t.getName()};this.requestEventStack.push(i),this.requestEventLog.push(i),this.requestEventLog.length>64&&this.requestEventLog.shift()}},_debugPopRequest:function(){this.debugRequests&&this.requestEventStack.pop()},_debugPushEvent:function(e,t,i){if(this.debugEvents){if(this._eventLoopGuard++,this._eventLoopGuard>64)throw"Events Looped?";var a={from:e,to:t.getName(),evtName:i.getName()};this.requestEventStack.push(a),this.requestEventLog.push(a),this.requestEventLog.length>64&&this.requestEventLog.shift()}},_debugPopEvent:function(){this.debugEvents&&(this._eventLoopGuard--,this.requestEventStack.pop())},_pushRequestAndEventGather:function(e,t){var i={};i.name=e,i.request=t,this.requestAndEventGather.push(i),this.requestAndEventGather.length>this.maxGatheredRequestsAndEvents&&this.requestAndEventGather.shift()},popUpSeqDiagram:function(){var e='<html><head></head><body><div class="wsd" wsd_style="modern-blue"><pre>',t="";for(x in this.requestAndEventGather)t+=this.requestAndEventGather[x].name+this.requestAndEventGather[x].request+"\n";if(""!=t){e+=t+'</pre></div><script type="text/javascript" src="http://www.websequencediagrams.com/service.js"></script></body></html>';var i=window.open();i.document.write(e),this.requestAndEventGather=[]}else alert("No requests in queue")}}),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","key-listener-methods",{isCtrlKeyDown:function(){return this._core.isCtrlKeyDown()}}),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","state-methods",{registerAsStateful:function(e,t){this._statefuls[e]=t},unregisterStateful:function(e){this._statefuls[e]=null,delete this._statefuls[e]},getStatefulComponents:function(){return this._statefuls},resetState:function(){var e,t,i=Oskari.app.getConfiguration(),a=this.getStatefulComponents();for(var n in a)t=a[n],e=i[n].state,t.setState&&(jQuery.isEmptyObject(e)?t.setState():t.setState(e))}}),Oskari.clazz.define("Oskari.mapframework.service.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/service/map-layer-service.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"service-map","Bundle-Name":"mapframework.service.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.service.Bundle",Title:" mapframework.service.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("service-map","Oskari.mapframework.service.map.Bundle"),Oskari.clazz.define("Oskari.mapframework.service.MapLayerService",function(e,t){this._mapLayerUrl=e,this._sandbox=t,this._allLayersAjaxLoaded=!1,this._loadedLayersList=new Array,this._reservedLayerIds={},this._stickyLayerIds=[],this.typeMapping={wmslayer:"Oskari.mapframework.domain.WmsLayer",vectorlayer:"Oskari.mapframework.domain.VectorLayer"},this.modelBuilderMapping={}},{__qname:"Oskari.mapframework.service.MapLayerService",getQName:function(){return this.__qname},__name:"MapLayerService",getName:function(){return this.__name},addLayer:function(e,t){if(this.checkForDuplicateId(e.getId(),e.getName()),this._reservedLayerIds[e.getId()]=!0,this._loadedLayersList.push(e),t!==!0){var i=this._sandbox.getEventBuilder("MapLayerEvent")(e.getId(),"add");this._sandbox.notifyAll(i)}},addSubLayer:function(e,t,i){var a,n,s,r=this.findMapLayer(e);if(r&&(r.isBaseLayer()||r.isGroupLayer())){for(a=r.getSubLayers(),s=0,n=a.length;n>s;++s)if(a[s].getId()===t.getId())return!1;if(a.push(t),i!==!0){var o=this._sandbox.getEventBuilder("MapLayerEvent")(t.getId(),"add");this._sandbox.notifyAll(o)}}},removeLayer:function(e,t){for(var i=null,a=0;a<this._loadedLayersList.length;a++)if(this._loadedLayersList[a].getId()==e){i=this._loadedLayersList[a],this._loadedLayersList.splice(a,1);break}if(i&&t!==!0){var n=this._sandbox.getEventBuilder("MapLayerEvent")(i.getId(),"remove");this._sandbox.notifyAll(n)}this._reservedLayerIds[e]=!1},removeSubLayer:function(e,t,i){var a,n,s,r,o=this.findMapLayer(e);if(o&&(o.isBaseLayer()||o.isGroupLayer())){for(a=o.getSubLayers(),r=0,s=a.length;s>r;++r)if(a[r].getId()===t){n=a[r],a.splice(r,1);break}if(n&&i!==!0){var l=this._sandbox.getEventBuilder("MapLayerEvent")(n.getId(),"remove");this._sandbox.notifyAll(l)}}},updateLayer:function(e,t){var i=this.findMapLayer(e);if(i){t.dataUrl&&i.setDataUrl(t.dataUrl),t.legendImage&&i.setLegendImage(t.legendImage),t.minScale&&i.setMinScale(t.minScale),t.maxScale&&i.setMaxSclae(t.maxScale),t.name&&i.setName(t.name),t.type&&i.setType(t.type),t.wmsName&&i.setWmsName(t.wmsName),t.wmsUrl&&i.setWmsUrl(t.wmsUrl);for(var a in t.admin)t.admin[a]&&(i.admin[a]=t.admin[a]);var n=this._sandbox.getEventBuilder("MapLayerEvent")(i.getId(),"update");this._sandbox.notifyAll(n)}},makeLayerSticky:function(e,t){var i=this.findMapLayer(e);if(this._stickyLayerIds.push(e),i){i.setSticky(t);var a=this._sandbox.getEventBuilder("MapLayerEvent")(i.getId(),"sticky");this._sandbox.notifyAll(a)}},loadAllLayersAjax:function(e,t){var i=this,a=(new Date).getTime();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:this._mapLayerUrl+"&timestamp="+a+"&",success:function(t){i._loadAllLayersAjaxCallBack(t,e)},error:function(e){t&&0!=e.status&&t()}})},_loadAllLayersAjaxCallBack:function(e,t){for(var i=e.layers,a=0;a<i.length;a++){var n=this.createMapLayer(i[a]);null!=i[a].admin&&(n.admin=i[a].admin),i[a].names&&(n.names=i[a].names),this._reservedLayerIds[n.getId()]!==!0&&this.addLayer(n,!0)}this._allLayersAjaxLoaded=!0;var s=this._sandbox.getEventBuilder("MapLayerEvent")(null,"add");this._sandbox.notifyAll(s),this._resetStickyLayers(),t&&t()},isAllLayersLoaded:function(){return this._allLayersAjaxLoaded},getAllLayers:function(){return this._loadedLayersList},getAllLayersByMetaType:function(e){for(var t=[],i=0;i<this._loadedLayersList.length;++i){var a=this._loadedLayersList[i];a.getMetaType&&a.getMetaType()===e&&t.push(a)}return t},registerLayerModel:function(e,t){this.typeMapping[e]=t},unregisterLayerModel:function(e){this.typeMapping[e]=void 0},registerLayerModelBuilder:function(e,t){this._sandbox.printDebug("[MapLayerService] registering handler for type "+e),this.modelBuilderMapping[e]=t},unregisterLayerModelBuilder:function(e){this.modelBuilderMapping[e]=void 0},createMapLayer:function(e){var t=null;return t="base"==e.type?this._createGroupMapLayer(e,!0):"groupMap"==e.type?this._createGroupMapLayer(e,!1):this._createActualMapLayer(e)},_createGroupMapLayer:function(e,t){var i=Oskari.clazz.create("Oskari.mapframework.domain.WmsLayer");if(t?i.setAsBaseLayer():i.setAsGroupLayer(),i.setVisible(!0),i.setId(e.id),i.setName(e.name),i.setMaxScale(e.maxScale),i.setMinScale(e.minScale),i.setDataUrl(e.dataUrl),i.setMetadataIdentifier(e.dataUrl_uuid),!i.getMetadataIdentifier()&&i.getDataUrl()){var a=i.getDataUrl().split("uuid=");2==a.length&&i.setMetadataIdentifier(a[1])}if(e.orgName?i.setOrganizationName(e.orgName):i.setOrganizationName(""),e.inspire?i.setInspireName(e.inspire):i.setInspireName(""),i.setLegendImage(e.legendImage),i.setDescription(e.info),i.setQueryable(!1),e.permissions)for(var n in e.permissions)i.addPermission(n,e.permissions[n]);
if(e.subLayer)for(var s=0;s<e.subLayer.length;s++){var r=this._createActualMapLayer(e.subLayer[s]);r.admin=e.subLayer[s].admin||{},i.getSubLayers().push(r)}if(null!=e.opacity)i.setOpacity(e.opacity);else if(i.getSubLayers().length>0){var o=i.getSubLayers()[0].getOpacity();null!=o?i.setOpacity(o):i.setOpacity(100)}else i.setOpacity(100);return i},_createActualMapLayer:function(e){var t=null,i=e.id;if(null!=e){if(!this.typeMapping[e.type])throw"Unknown layer type '"+e.type+"'";if(t=Oskari.clazz.create(this.typeMapping[e.type],e.params,e.options),"wmslayer"==e.type?this._populateWmsMapLayerAdditionalData(t,e):"vectorlayer"==e.type&&t.setStyledLayerDescriptor(e.styledLayerDescriptor),e.metaType&&t.setMetaType&&t.setMetaType(e.metaType),t.setAsNormalLayer(),t.setId(i),t.setName(e.name),null!=e.opacity?t.setOpacity(e.opacity):t.setOpacity(100),t.setMaxScale(e.maxScale),t.setMinScale(e.minScale),t.setDescription(e.subtitle),t.setQueryable("true"===e.isQueryable||e.isQueryable===!0),t.setDataUrl(e.dataUrl),t.setMetadataIdentifier(e.dataUrl_uuid),!t.getMetadataIdentifier()&&t.getDataUrl()){var a=t.getDataUrl().split("uuid=");2==a.length&&t.setMetadataIdentifier(a[1])}if(e.backendStatus&&t.setBackendStatus&&t.setBackendStatus(e.backendStatus),e.orgName?t.setOrganizationName(e.orgName):t.setOrganizationName(""),e.inspire?t.setInspireName(e.inspire):t.setInspireName(""),t.setVisible(!0),e.geom&&t.setGeometryWKT&&t.setGeometryWKT(e.geom),e.permissions)for(var n in e.permissions)t.addPermission(n,e.permissions[n]);var s=this.modelBuilderMapping[e.type];s&&s.parseLayerData(t,e,this)}return t},_populateWmsMapLayerAdditionalData:function(e,t){if(e.setWmsName(t.wmsName),t.wmsUrl)for(var i=t.wmsUrl.split(","),a=0;a<i.length;a++)e.addWmsUrl(i[a]);return e.setFeatureInfoEnabled("disabled"!==t.gfi),this.populateStyles(e,t)},populateStyles:function(e,t){var i=Oskari.clazz.builder("Oskari.mapframework.domain.Style");if(t.styles){for(var a=0;a<t.styles.length;a++){var n=t.styles,s=!isNaN(a);s&&(n=t.styles[a]);var r=i();if(r.setName(n.name),r.setTitle(n.title),r.setLegend(n.legend),e.addStyle(r),!s)break}e.selectStyle(t.style)}if(0==e.getStyles().length){var r=i();r.setName(""),r.setTitle(""),r.setLegend(""),e.addStyle(r),e.selectStyle("")}return e.setLegendImage(t.legendImage),t.formats&&t.formats.value&&e.setQueryFormat(t.formats.value),e},checkForDuplicateId:function(e,t){if(this._reservedLayerIds[e]===!0){var i=this.findMapLayer(e);throw"Trying to add map layer with id '"+e+" ("+t+")' but that id is already reserved for '"+i.getName()+"'"}},_resetStickyLayers:function(){for(var e in this._stickyLayerIds){var t=this._stickyLayerIds[e];this.makeLayerSticky(t,!0)}},findMapLayer:function(e,t){t||(t=this._loadedLayersList);for(var i=0;i<t.length;i++){var a=t[i];if(a.getId()==e)return a}for(var i=0;i<t.length;i++){var a=t[i],n=a.getSubLayers(),s=this.findMapLayer(e,n);if(null!=s)return s}return null}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.sandbox.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-map-layer-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-map-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-abstraction-methods.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"sandbox-map","Bundle-Name":"mapframework.sandbox.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.sandbox.Bundle",Title:" mapframework.sandbox.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("sandbox-map","Oskari.mapframework.sandbox.map.Bundle"),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","map-layer-methods",{findMapLayerFromAllAvailable:function(e){var t=this._core.findMapLayerFromAllAvailable(e);return t},findAllSelectedMapLayers:function(){var e=this._core.getAllSelectedLayers();return e.slice(0)},findMapLayerFromSelectedMapLayers:function(e){var t=this._core.findMapLayerFromSelectedMapLayers(e);return t},isLayerAlreadySelected:function(e){return this._core.isLayerAlreadySelected(e)},findAllHighlightedLayers:function(){var e=this._core.getAllHighlightedMapLayers();return e},isMapLayerHighLighted:function(e){for(var t=this.findAllHighlightedLayers(),i=0;i<t.length;i++)if(t[i].getId()==e)return!0;return!1},allowMultipleHighlightLayers:function(e){this._core.allowMultipleHighlightLayers(e)}}),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","map-methods",{getMap:function(){return this._core.getMap()},syncMapState:function(e){var t=this._core.getMap(),i=t.getZoom(),a=t.isMarkerVisible();e===!0&&12==i&&this._core.processRequest(this._core.getRequestBuilder("MapMoveRequest")(t.getX(),t.getY(),0,!1)),this._core.processRequest(this._core.getRequestBuilder("MapMoveRequest")(t.getX(),t.getY(),i,a)),e===!0&&this._core.processRequest(this._core.getRequestBuilder("ClearHistoryRequest")())},generateMapLinkParameters:function(e){var t=this.getStatefulComponents(),i=null,a=null,n=[],s=[];for(i in t)a=t[i],a.getStateParameters&&"function"==typeof a.getStateParameters&&s.push(a.getStateParameters());e=e||{showMarker:!1,forceCache:!1,noSavedState:!1};for(i in e)n.push(i+"="+(e[i]!==!1));return s.concat(n).join("&")||null}}),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","abstraction-methods",{domSelector:function(e){return jQuery(e)},ajax:function(e,t,i,a){if(jQuery&&jQuery.ajax){var n="GET";a&&(n="POST"),jQuery.ajax({type:n,url:e,beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},data:a,success:t,error:i})}else i()},getDefer:function(){return window.Q&&window.Q.defer?window.Q.defer():void 0}}),Oskari.clazz.define("Oskari.mapframework.event.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/event/common/features-available-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-map-layer-add-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-map-layer-remove-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-map-move-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-map-move-start-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-show-map-layer-info-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-hide-map-marker-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/mouse-hover-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/MapLayerEvent.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"event-map","Bundle-Name":"mapframework.event.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.event.Bundle",Title:" mapframework.event.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("event-map","Oskari.mapframework.event.map.Bundle"),Oskari.clazz.define("Oskari.mapframework.event.common.FeaturesAvailableEvent",function(e,t,i,a,n){this._creator=null,this._features=t,this._op=n,this._mapLayer=e,this._mimeType=i,this._projCode=a},{__name:"FeaturesAvailableEvent",getName:function(){return this.__name},getFeatures:function(){return this._features},getOp:function(){return this._op},getMapLayer:function(){return this._mapLayer},getMimeType:function(){return this._mimeType},getProjCode:function(){return this._projCode}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterMapLayerAddEvent",function(e,t,i){this._creator=null,this._mapLayer=e,this._keepLayersOrder=t,this._isBasemap=i?i:!1},{__name:"AfterMapLayerAddEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer},getKeepLayersOrder:function(){return this._keepLayersOrder},isBasemap:function(){return this._isBasemap}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterMapLayerRemoveEvent",function(e){this._creator=null,this._mapLayer=e},{__name:"AfterMapLayerRemoveEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterMapMoveEvent",function(e,t,i,a,n){this._creator=null,this._centerX=e,this._centerY=t,this._zoom=i,this._marker=a,this._scale=n},{__name:"AfterMapMoveEvent",getName:function(){return this.__name},getCreator:function(){return this._creator},getCenterX:function(){return this._centerX},getCenterY:function(){return this._centerY},getZoom:function(){return this._zoom},getMarker:function(){return this._marker},getScale:function(){return this._scale}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.MapMoveStartEvent",function(e,t){this._creator=null,this._x=e,this._y=t},{__name:"MapMoveStartEvent",getName:function(){return this.__name},getX:function(){return this._x},getY:function(){return this._y}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterShowMapLayerInfoEvent",function(e){this._creator=null,this._mapLayer=e},{__name:"AfterShowMapLayerInfoEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterHideMapMarkerEvent",function(){},{__name:"AfterHideMapMarkerEvent",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.MouseHoverEvent",function(e,t,i){this._creator=null,this._lon=e,this._lat=t,this._paused=i},{__name:"MouseHoverEvent",getName:function(){return this.__name},getLon:function(){return this._lon},getLat:function(){return this._lat},set:function(e,t,i,a,n){this._lon=e,this._lat=t,this._paused=i,this._pageX=a,this._pageY=n},isPaused:function(){return this._paused},getPageX:function(){return this._pageX},getPageY:function(){return this._pageY}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.MapLayerEvent",function(e,t){if(this._creator=null,this._layerId=e,!this.operations[t])throw"Unknown operation '"+t+"'";this._operation=t},{__name:"MapLayerEvent",getName:function(){return this.__name},getLayerId:function(){return this._layerId},getOperation:function(){return this._operation},operations:{add:"add",remove:"remove",sticky:"sticky",update:"update"}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.UserInterfaceBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.userinterface.bundle.ui.UserInterfaceBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/AddExtensionRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/AddExtensionRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/RemoveExtensionRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/RemoveExtensionRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/UpdateExtensionRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/UpdateExtensionRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/ModalDialogRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/ModalDialogRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/event/ExtensionUpdatedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Accordion.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/AccordionPanel.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/TabContainer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/TabDropdownContainer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/TabPanel.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Badge.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Alert.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Popup.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Overlay.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Button.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Form.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/UIHelper.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/FormInput.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Popover.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Grid.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/GridModel.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/ProgressSpinner.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultTile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultFlyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultExtension.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultView.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultLayout.js"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/divman.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/accordion.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/tab.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/modal.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/badge.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/alert.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/grid.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/popup.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/button.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/overlay.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/popover.css"}]},bundle:{manifest:{"Bundle-Identifier":"ui","Bundle-Name":"ui","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" kpI",Title:" kpI"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("divmanazer","Oskari.userinterface.bundle.ui.UserInterfaceBundle"),Oskari.clazz.define("Oskari.userinterface.bundle.ui.UserInterfaceBundleInstance",function(){this.sandbox=null,this.requestHandlers={},this.extensions=[],this.extensionsByName={},this.compiledTemplates={},this.flyoutContainer=null,this.tileContainer=null,this.flyoutZIndexBase=1100,this.menubarContainerId="#menubar"},{getName:function(){return"userinterface.DivManazer"},init:function(){},getExtensionByName:function(e){return this.extensionsByName[e]},getSandbox:function(){return this.sandbox},start:function(){this.compileTemplates();var e=this.conf,t=(e?e.sandbox:null)||"sandbox",i=Oskari.getSandbox(t);if(this.sandbox=i,this.flyoutContainer=jQuery(document.body),(e?e.menubarContainerId:null)||this.menubarContainerId,this.tileContainer=jQuery(this.menubarContainerId),this.tileContainer.addClass("oskari-tile-container"),this.sandbox.register(this),this.requestHandlers.add=Oskari.clazz.create("Oskari.userinterface.bundle.ui.request.AddExtensionRequestHandler",this),this.requestHandlers.remove=Oskari.clazz.create("Oskari.userinterface.bundle.ui.request.RemoveExtensionRequestHandler",this),this.requestHandlers.update=Oskari.clazz.create("Oskari.userinterface.bundle.ui.request.UpdateExtensionRequestHandler",this),i.addRequestHandler("userinterface.AddExtensionRequest",this.requestHandlers.add),i.addRequestHandler("userinterface.RemoveExtensionRequest",this.requestHandlers.remove),i.addRequestHandler("userinterface.UpdateExtensionRequest",this.requestHandlers.update),this.requestHandlers.modal=Oskari.clazz.create("Oskari.userinterface.bundle.ui.request.ModalDialogRequestHandler",this),i.addRequestHandler("userinterface.ModalDialogRequest",this.requestHandlers.modal),jQuery.browser.msie&&jQuery.browser.version<"9.0")for(var a=this.compiledTemplates["Oskari.userinterface.Flyout"].children(".oskari-flyoutcontentcontainer"),n=this.flyoutContainer.height(),s=this.ieFixClasses,r=0;r<s.length;r++){var o=s[r];if(n>=o.min&&n<=o.max){a.addClass(o.cls);break}}},update:function(){},stop:function(){sandbox.removeRequestHandler("userinterface.UpdateExtensionRequest",this.requestHandlers.update),sandbox.removeRequestHandler("userinterface.RemoveExtensionRequest",this.requestHandlers.remove),sandbox.removeRequestHandler("userinterface.AddExtensionRequest",this.requestHandlers.add),sandbox.removeRequestHandler("userinterface.ModalDialogRequest",this.requestHandlers.modal),this.sandbox.unregister(this),this.started=!1},templates:{"Oskari.userinterface.Tile":'<div class="oskari-tile oskari-tile-closed"><div class="oskari-tile-title"></div><div class="oskari-tile-status"></div></div>',"Oskari.userinterface.Flyout":'<div class="oskari-flyout oskari-closed"><div class="oskari-flyouttoolbar"><div class="oskari-flyoutheading"></div><div class="oskari-flyout-title"><p></p></div><div class="oskari-flyouttools"><div class="oskari-flyouttool-help"></div><div class="oskari-flyouttool-attach"></div><div class="oskari-flyouttool-detach"></div><div class="oskari-flyouttool-minimize"></div><div class="oskari-flyouttool-restore"></div><div class="oskari-flyouttool-close icon-close icon-close:hover"></div></div></div><div class="oskari-flyoutcontentcontainer"><div class="oskari-flyoutcontent"></div></div></div>',"Oskari.userinterface.View":'<div class="oskari-view"></div>'},compileTemplates:function(){var e=this;e.compiledTemplates["Oskari.userinterface.Tile"]=jQuery(this.templates["Oskari.userinterface.Tile"]);var t=jQuery(e.templates["Oskari.userinterface.Flyout"]);t.css("left",e.defaults.attach.left),t.css("top",e.defaults.attach.top),e.compiledTemplates["Oskari.userinterface.Flyout"]=t,e.compiledTemplates["Oskari.userinterface.View"]=jQuery(this.templates["Oskari.userinterface.View"])},addExtension:function(e){e.startExtension();var t=e.getPlugins(),i=this.extensions,a=this.extensionsByName,n={state:"close",extension:e,draggable:null,draggableTarget:null,draggableHandle:null,viewState:{},extensionUpdatedEvent:null};n.extensionUpdatedEvent=this.sandbox.getEventBuilder("userinterface.ExtensionUpdatedEvent")(e,n.state);var s=i.length,r=e.getName(),o=t["Oskari.userinterface.Flyout"],l=null;if(null!=o){l=this.createFlyout(e,o,s,n),this._applyDraggableToFlyout(l,n,".oskari-flyouttoolbar");var u=l.children(".oskari-flyoutcontentcontainer");u.children(".oskari-flyoutcontent");var c=u.children(".oskari-flyoutcontent");o.setEl(c.get()),this.flyoutContainer.append(l),o.startPlugin()}var h=t["Oskari.userinterface.Tile"],d=null;null!=h&&(d=this.createTile(e,h,s,n),h.startPlugin(),d.fadeIn(200),this.tileContainer.append(d));var p=t["Oskari.userinterface.View"],f=null;if(null!=p){f=this.createView(e,p,s,n);var c=f;p.setEl(c.get()),p.startPlugin()}return n.plugins={},h&&(n.plugins["Oskari.userinterface.Tile"]={plugin:h,el:d}),o&&(n.plugins["Oskari.userinterface.Flyout"]={plugin:o,el:l}),p&&(n.plugins["Oskari.userinterface.View"]={plugin:p,el:f}),i.push(n),a[r]=n,n},_applyDraggableToFlyout:function(e,t,i){var a=this,n=e.children(i).get()[0],s=e.get()[0];t.draggableHandle=n,t.draggableTarget=s,e.css("position","absolute");var r=!1;t.draggable=$(e).draggable({handle:jQuery(n),helper:r?function(){var t=jQuery("<div />");return t.css("width",e.css("width")),t.css("height",e.css("height")),t.css("border","2px solid rgba(0,0,0,.5)"),t.css("z-index",e.css("z-index")),t}:null,scroll:!1,stack:".oskari-flyout",create:function(){jQuery.browser.msie&&"9"===jQuery.browser.version[0]&&e.css("width",e.width()+"px")},start:function(){r&&e.css("display","none")},drag:function(){},stop:function(i,n){r&&(e.css("top",n.helper.css("top")),e.css("left",n.helper.css("left"))),a.shuffleZIndices(e),r&&e.css("display","");var s=a.getFlyoutViewState(e,"detach");t.viewState=s,a.notifyExtensionViewStateChange(t)}})},createTile:function(e,t){var i=this;jQuery("#menubar");var a=this.compiledTemplates["Oskari.userinterface.Tile"].clone(!0,!0),n=a.children(".oskari-tile-title");return n.append(t.getTitle()),a.children(".oskari-tile-status"),a.click(function(){i.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"toggle"])}),t.setEl(a.get()),a},createFlyout:function(e,t){var i=this,a=this.compiledTemplates["Oskari.userinterface.Flyout"].clone(!0,!0);a.find(".oskari-flyout-title p").append(t.getTitle());var n=a.children(".oskari-flyouttoolbar").children(".oskari-flyouttools"),s={attach:n.children(".oskari-flyouttool-attach"),detach:n.children(".oskari-flyouttool-detach"),minimize:n.children(".oskari-flyouttool-minimize"),restore:n.children(".oskari-flyouttool-restore"),close:n.children(".oskari-flyouttool-close"),help:n.children(".oskari-flyouttool-help")};return s.detach.click(function(){i.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"detach"])}),s.attach.click(function(){i.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"attach"])}),s.minimize.click(function(){i.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"minimize"])}),s.restore.click(function(){i.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"restore"])}),s.close.click(function(){i.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"close"])}),s.help.click(function(){i.getSandbox().postRequestByName("userguide.ShowUserGuideRequest",[{placement:"bottom",el:s.help,extension:e.getName(),toggle:!0}])}),a},createView:function(){var e=this.compiledTemplates["Oskari.userinterface.View"].clone(!0,!0);return e},removeExtension:function(e){var t=this,i=t.extensions,a=this.extensionsByName,n=a[e.getName()];n.state;var s=n.plugins["Oskari.userinterface.Flyout"];if(s){var r=s.plugin,o=s.el,l=this.flyoutOps,u=l.close;u.apply(this,[o,r,n]),o.remove()}var c=n.plugins["Oskari.userinterface.Tile"];if(c){c.plugin;var h=c.el;h.remove()}a[e.getName()]=null;for(var d=[],p=0,f=i.length;f>p;p++)i[p]!==n&&d.push(i[p]);t.extensions=d,e.stopExtension()},updateExtension:function(e,t){var i=this,a=i.extensions;if(e){var n=this.extensionsByName,s=n[e.getName()],r=s.state,o=t.getState();"toggle"==o&&("close"==r?o="attach":"attach"==r?o="close":"detach"==r?o="minimize":"minimize"==r?o="restore":"restore"==r&&(o="minimize"));var l=s.plugins["Oskari.userinterface.Flyout"];if("attach"==o&&l)for(var u=i.flyoutOps,c=u.close,h=0,d=a.length;d>h;h++){var p=a[h];if(p!==s&&"attach"==p.state){var f="close",m=p.plugins,g=m["Oskari.userinterface.Flyout"];if(g){var y=g.plugin,v=g.el;p.state=f,c.apply(this,[v,y,p]),i.notifyExtensionViewStateChange(p);var b=m["Oskari.userinterface.Tile"];if(b){b.plugin;var _=b.el;i.applyTransition(_,f,i.tileTransitions)}}}}if(l){var k=l.plugin,L=l.el,u=i.flyoutOps,w=u[o];w.apply(this,[L,k,s,a])}var O=s.plugins["Oskari.userinterface.Tile"];if(O){O.plugin;var x=O.el;i.applyTransition(x,o,i.tileTransitions)}var S=s.plugins["Oskari.userinterface.View"];if(S){var C=S.plugin,M=S.el,u=i.viewOps,w=u[o];w&&w.apply(this,[M,C,s,a])}s.state=o,i.notifyExtensionViewStateChange(s)}else for(var P=0;P<a.length;++P)this.updateExtension(a[P].extension,t)},notifyExtensionViewStateChange:function(e){var t=e.extensionUpdatedEvent;t.setViewState(e.state),t.setViewInfo(e.viewState),this.sandbox.notifyAll(t,!0)},validStates:{attach:{attach:!0,detach:!1,close:!1,minimize:!1,restore:!1,drawer:!1,sidebar:!1},detach:{attach:!1,detach:!0,close:!1,minimize:!1,restore:!1,drawer:!1,sidebar:!1},minimize:{attach:!0,detach:!0,close:!1,minimize:!0,restore:!1,drawer:!1,sidebar:!1},restore:{attach:!1,detach:!0,close:!1,minimize:!1,restore:!0,drawer:!1,sidebar:!1},close:{attach:!1,detach:!1,close:!0,minimize:!1,restore:!1,drawer:!1,sidebar:!1},drawer:{attach:!1,detach:!1,close:!1,minimize:!1,restore:!1,drawer:!0,sidebar:!1},sidebar:{attach:!1,detach:!1,close:!1,minimize:!1,restore:!1,drawer:!1,sidebar:!0}},defaults:{detach:{left:"212px",top:"50px"},attach:{left:"192px",top:"30px"}},tileTransitions:{attach:{"oskari-tile-attached":!0,"oskari-tile-detached":!1,"oskari-tile-closed":!1},detach:{"oskari-tile-attached":!1,"oskari-tile-detached":!0,"oskari-tile-minimized":!1,"oskari-tile-closed":!1},minimize:{"oskari-tile-minimized":!0,"oskari-tile-closed":!1,"oskari-tile-detached":!1},restore:{"oskari-tile-minimized":!1,"oskari-tile-detached":!0},close:{"oskari-tile-closed":!0,"oskari-tile-attached":!1,"oskari-tile-detached":!1}},flyoutTransitions:{attach:{"oskari-attached":!0,"oskari-detached":!1,"oskari-closed":!1},detach:{"oskari-attached":!1,"oskari-detached":!0,"oskari-closed":!1},minimize:{"oskari-minimized":!0,"oskari-closed":!1,"oskari-detached":!1},restore:{"oskari-minimized":!1,"oskari-closed":!1,"oskari-detached":!0,"oskari-attached":!1},close:{"oskari-closed":!0,"oskari-minimized":!1,"oskari-detached":!1,"oskari-attached":!1}},applyTransition:function(e,t,i){var i=i[t];if(i)for(var a in i)i[a]?e.addClass(a):e.removeClass(a)},getFlyoutViewState:function(e,t){var i={left:e.css("left"),top:e.css("top"),width:e.width(),height:e.height(),"z-index":e.css("z-index"),viewState:t};return i},flyoutOps:{detach:function(e,t,i){var a=this;(!i.viewState.left||!i.viewState.top||i.viewState.left==a.defaults.attach.left&&i.viewState.top==a.defaults.attach.top)&&(i.viewState.left=a.defaults.detach.left,i.viewState.top=a.defaults.detach.top),{left:i.viewState.left,top:i.viewState.top},a.shuffleZIndices(e),a.applyTransition(e,"detach",a.flyoutTransitions);var n=a.getFlyoutViewState(e,"detach");i.viewState=n},attach:function(e,t,i){var a=this;a.shuffleZIndices(e),a.applyTransition(e,"attach",a.flyoutTransitions);var n=a.getFlyoutViewState(e,"attach");i.viewState=n},minimize:function(e,t,i){var a=this,n=a.getFlyoutViewState(e,"minimize");a.applyTransition(e,"minimize",a.flyoutTransitions),i.viewState=n},restore:function(e,t,i){var a=this;a.applyTransition(e,"restore",a.flyoutTransitions),i.viewState},close:function(e,t,i){var a=this;i.viewState={viewState:"close"},a.applyTransition(e,"close",a.flyoutTransitions)}},viewOps:{view:function(){},close:function(){}},setState:function(e){var t=this,i=e;if(i)for(var a in t.extensionsByName){var n=t.extensionsByName[a],s=i.extensionStatesByName[a];s&&(n.state=s.state,n.viewState=s.viewState||{})}},getState:function(){var e=this;e.refreshExtensionViewStates();var t={extensionStatesByName:{}};for(var i in e.extensionsByName){var a=e.extensionsByName[i];t.extensionStatesByName[i]={state:a.state,viewState:a.viewState}}return t},applyState:function(){var e=this;e.restoreExtensionViewStates()},refreshExtensionViewStates:function(){var e=this;for(var t in e.extensionsByName){var i=e.extensionsByName[t],a=i.plugins["Oskari.userinterface.Flyout"];if(a){a.plugin;var n=a.el,s=e.getFlyoutViewState(n,i.state);i.viewState=s}}},restoreExtensionViewStates:function(){var e=this,t=e.flyoutOps,i=e.extensions;for(var a in e.extensionsByName){var n=e.extensionsByName[a];n.extension;var s=n.plugins["Oskari.userinterface.Flyout"];if(s){var r=s.plugin,o=s.el,l=n.viewState;o.removeAttr("style"),o.css("left",l.left),o.css("top",l.top),o.width(l.width),o.height(l.height),o.css("z-index",l["z-index"]);var u=t[n.state];u.apply(e,[o,r,n,i])}var c=n.plugins["Oskari.userinterface.Tile"];if(c){c.plugin;var h=c.el;e.applyTransition(h,n.state,e.tileTransitions)}}},_toggleMapWindowFullScreen:function(){var e=this,t=e.sandbox.getRequestBuilder("MapFull.MapWindowFullScreenRequest");t&&e.sandbox.request(e.getName(),t())},shuffleZIndices:function(e){var t=this;t.extensions;var i=[],a={},n={},s={},r=1100;for(var o in t.extensionsByName){var l=t.extensionsByName[o];l.extension;var u=l.plugins["Oskari.userinterface.Flyout"];if(u){u.plugin;var c=u.el,h=c.css("z-index");i.push(h);var d=""+h;a[d]=h,s[d]=c,n[d]=l}}i.sort();for(var p=0;p<i.length;p++){var d=i[p];a[d]=r+p,s[d].css("z-index",a[i[p]])}e.css("z-index",r+i.length+2)},ieFixClasses:[{min:400,max:599,cls:"oskari-flyoutcontentcontainer_IE_400_599"},{min:600,max:799,cls:"oskari-flyoutcontentcontainer_IE_600_799"},{min:800,max:999,cls:"oskari-flyoutcontentcontainer_IE_800_999"},{min:1e3,max:1199,cls:"oskari-flyoutcontentcontainer_IE_1000_1199"},{min:1200,max:1399,cls:"oskari-flyoutcontentcontainer_IE_1200_1399"},{min:1400,max:9999,cls:"oskari-flyoutcontentcontainer_IE_1400"}]},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Stateful"]}),Oskari.clazz.define("Oskari.userinterface.request.AddExtensionRequest",function(e){this._extension=e},{__name:"userinterface.AddExtensionRequest",getName:function(){return this.__name},getExtension:function(){return this._extension}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.request.AddExtensionRequestHandler",function(e){this.ui=e},{handleRequest:function(e,t){var i=t.getExtension();this.ui.addExtension(i)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.request.RemoveExtensionRequest",function(e){this._extension=e},{__name:"userinterface.RemoveExtensionRequest",getName:function(){return this.__name},getExtension:function(){return this._extension}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.request.RemoveExtensionRequestHandler",function(e){this.ui=e},{handleRequest:function(e,t){var i=t.getExtension();this.ui.removeExtension(i)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.request.UpdateExtensionRequest",function(e,t,i){this._extension=e,this._state=t,this._extensionName=i
},{__name:"userinterface.UpdateExtensionRequest",getName:function(){return this.__name},getExtension:function(){return this._extension},getState:function(){return this._state},getExtensionName:function(){return this._extensionName}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.request.UpdateExtensionRequestHandler",function(e){this.ui=e},{handleRequest:function(e,t){var i=t.getExtension(),a=t.getExtensionName();if(!i&&a&&"*"!=a){var n=this.ui.getExtensionByName(a);if(!n)return;i=n.extension}this.ui.updateExtension(i,t)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.request.ModalDialogRequest",function(e,t,i,a){this._title=e?e:"Untitled",this._message=t?t:"Lorem ipsum",this._buttons=i?i:{},this._parent=parent?parent:jQuery("#mapdiv"),this._onshow=a?a:null},{__name:"userinterface.ModalDialogRequest",getName:function(){return this.__name},getTitle:function(){return this._title},getMessage:function(){return this._message},getButtons:function(){return this._buttons},getGeom:function(){return this._geom},getParent:function(){return this._parent},getOnShow:function(){return this._onshow}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.request.ModalDialogRequestHandler",function(e){this._ui=e,this._tpl={},this._tpl.modal=jQuery('<div id="modaldialog" class="modaldialog">  <div class="modaltitle"></div>  <div class="modalmessage"></div>  <div class="modalbuttons"></div> </div>'),this._tpl.button=jQuery('<div class="modalbutton"><input type="button" /></input></div>'),this._buttons={},this._args={closeClass:"modalclose",overlayId:"modaloverlay",overlayCss:{"background-color":"lightgrey",cursor:"wait"},containerId:"modalcontainer",containerCss:{"background-color":"white"},onClose:function(){this.close()},zIndex:80130}},{handleRequest:function(e,t){var i=this._tpl.modal.clone();i.find(".modaltitle").append(t.getTitle()),i.find(".modalmessage").append(t.getMessage());var a=t.getButtons(),n=i.find(".modalbuttons");for(var s in a)if(a[s].name){var r=a[s],o=this._tpl.button.clone(),l=o.find("input");l.attr("name",r.name),l.attr("text",r.text),l.attr("value",r.text),l.bind("click",r.onclick),r.close!==!1&&l.addClass(this._args.closeClass),n.append(o)}t.onshow&&(this._args.onShow=onshow),$.modal=i.modal(this._args)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.event.ExtensionUpdatedEvent",function(e,t,i){this._creator=null,this._extension=e,this.viewstate=t,this.viewinfo=i},{__name:"userinterface.ExtensionUpdatedEvent",getName:function(){return this.__name},getExtension:function(){return this._extension},getViewState:function(){return this.viewstate},setViewState:function(e){this.viewstate=e},getViewInfo:function(){return this.viewinfo},setViewInfo:function(e){this.viewinfo=e}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.userinterface.component.Accordion",function(){this.template=jQuery('<div class="accordion"></div>'),this.templateMsg=jQuery('<div class="accordionmsg"></div>'),this.panels=[],this.ui=this.template.clone()},{addPanel:function(e){this.removeMessage(),this.panels.push(e),e.insertTo(this.ui)},removePanel:function(e){for(var t=null,i=0;i<this.panels.length;i++)if(this.panels[i]===e){t=this.panels[i],this.panels.splice(i,1);break}return t?(t.destroy(),!0):!1},removeAllPanels:function(){this.ui.empty(),this.panels=[]},removeMessage:function(){var e=this.ui.find("div.accordionmsg");e.length>0&&e.remove()},showMessage:function(e){this.removeMessage();var t=this.templateMsg.clone();t.append(e),this.ui.append(t)},showPanels:function(){for(var e=0;e<this.panels.length;e++)this.panels[e].setVisible(!0)},hidePanels:function(){for(var e=0;e<this.panels.length;e++)this.panels[e].setVisible(!1)},insertTo:function(e){e.append(this.ui)},getContainer:function(){return this.ui}}),Oskari.clazz.define("Oskari.userinterface.component.AccordionPanel",function(){this.template=jQuery('<div class="accordion_panel"><div class="header"><div class="headerIcon icon-arrow-right"></div><div class="headerText"></div></div><div class="content"></div></div>'),this.title=null,this.content=null,this.html=this.template.clone();var e=this,t=this.html.find("div.header");t.click(function(){e.isOpen()?e.close():e.open()}),this.html.find("div.content").hide()},{setVisible:function(e){1==e?this.html.show():this.html.hide()},isVisible:function(){return this.html.is(":visible")},isOpen:function(){return this.html.hasClass("open")},open:function(){this.html.addClass("open");var e=this.html.find("div.header div.headerIcon");e.removeClass("icon-arrow-right"),e.addClass("icon-arrow-down"),this.html.find("div.content").show()},close:function(){this.html.removeClass("open");var e=this.html.find("div.header div.headerIcon");e.removeClass("icon-arrow-down"),e.addClass("icon-arrow-right"),this.html.find("div.content").hide()},setTitle:function(e){this.title=e;var t=this.html.find("div.header div.headerText");t.html(this.title)},getTitle:function(){return this.title},setContent:function(e){this.content=e;var t=this.html.find("div.content");t.append(this.content)},destroy:function(){this.html.remove()},getContainer:function(){return this.html.find("div.content")},insertTo:function(e){e.append(this.html)}}),Oskari.clazz.define("Oskari.userinterface.component.TabContainer",function(e){this.panels=[],this.tabChangeListeners=[],this.emptyMsg=e?e:"No content",this.template=jQuery('<div class="oskariTabs">'+this.emptyMsg+"</div>"),this.templateTabs=jQuery('<div class="tabsHeader"><ul></ul></div><br clear="all"/><div class="tabsContent"></div>'),this.ui=this.template.clone()},{addPanel:function(e){var t=this;if(0==this.panels.length){var i=this.templateTabs.clone();this.ui.html(i)}var a=this.ui.find("ul"),n=e.getHeader();a.append(n),e.insertTo(this.ui.find("div.tabsContent")),this.panels.push(e),1==this.panels.length&&this.select(e);var s=n.find("a");s.bind("click",function(){return t.select(e),!1})},addTabChangeListener:function(e){this.tabChangeListeners.push(e)},select:function(e){for(var t=null,i=0;i<this.panels.length;i++)if(this.isSelected(this.panels[i])){t=this.panels[i],t.handleSelection(!1);break}var a=this.ui.find("ul");a.find("li").removeClass("active");var n=this.ui.children().children("div.tab-content");n.hide(),e.getHeader().addClass("active"),e.getContainer().show(),e.handleSelection(!0);for(var i=0;i<this.tabChangeListeners.length;i++)this.tabChangeListeners[i](t,e)},isSelected:function(e){return e.getHeader().hasClass("active")},removePanel:function(e){for(var t=null,i=0;i<this.panels.length;i++)if(this.panels[i]===e){t=this.panels[i],this.panels.splice(i,1);break}if(0==this.panels.length){this.ui.html(this.emptyMsg);for(var i=0;i<this.tabChangeListeners.length;i++)this.tabChangeListeners[i](e)}else this.select(this.panels[0]);return t?(t.destroy(),!0):!1},insertTo:function(e){e.append(this.ui)}}),Oskari.clazz.define("Oskari.userinterface.component.TabDropdownContainer",function(e){this.panels=[],this.tabChangeListeners=[],this.emptyMsg=e?e:"No content",this.template=jQuery('<div class="oskariTabs">'+this.emptyMsg+"</div>"),this.templateTabOption=jQuery("<option></option>"),this.templateTabs=jQuery('<div class="tabsHeader"><ul><li><select name="tabs"></select></li></ul></div><br clear="all"/><div class="tabsContent"></div>'),this.ui=this.template.clone()},{addPanel:function(e){var t=this;if(0==this.panels.length){var i=this.templateTabs.clone();this.ui.html(i)}var a=this.ui.find("ul li select"),n=this.templateTabOption.clone();n.append(e.getTitle()),a.append(n),e.setHeader(n),e.insertTo(this.ui.find("div.tabsContent")),this.panels.push(e),1==this.panels.length&&(this.select(e),a.bind("change",function(){t.select(t.panels[this.selectedIndex])}))},addTabChangeListener:function(e){this.tabChangeListeners.push(e)},select:function(e){var t=null;if(this.tabChangeListeners.length>0)for(var i=0;i<this.panels.length;i++)if(this.isSelected(this.panels[i])){t=this.panels[i];break}var a=this.ui.children().children("div.tab-content");a.hide();var n=this.ui.find("ul li select"),s=n.find("option");s.removeAttr("selected");var r=this._getPanelIndex(e);jQuery(s[r]).attr("selected","selected"),e.getContainer().show();for(var i=0;i<this.tabChangeListeners.length;i++)this.tabChangeListeners[i](t,e)},isSelected:function(e){var t=this.ui.find("ul li select :selected");return t.index()==this._getPanelIndex(e)},_getPanelIndex:function(e){for(var t=0;t<this.panels.length;t++)if(this.panels[t]==e)return t;return-1},removePanel:function(e){for(var t=null,i=0;i<this.panels.length;i++)if(this.panels[i]===e){t=this.panels[i],this.panels.splice(i,1);break}if(0==this.panels.length){this.ui.html(this.emptyMsg);for(var i=0;i<this.tabChangeListeners.length;i++)this.tabChangeListeners[i](e)}else this.select(this.panels[0]);return t?(t.destroy(),!0):!1},insertTo:function(e){e.append(this.ui)}}),Oskari.clazz.define("Oskari.userinterface.component.TabPanel",function(){this.template=jQuery('<div class="tab-content"></div>'),this.templateTabHeader=jQuery('<li><a href="JavaScript:void(0);"></a></li>'),this.title=null,this.content=null,this.header=null,this.selectionHandler=null,this.html=this.template.clone(),this.html.hide()},{setTitle:function(e){this.title=e;var t=this.templateTabHeader.clone();this.header=t;var i=t.find("a");i.html(this.getTitle())},getTitle:function(){return this.title},setHeader:function(e){this.header=e},getHeader:function(){return this.header},setContent:function(e){this.content=e,this.html.html(this.content)},destroy:function(){this.header.remove(),this.html.remove()},getContainer:function(){return this.html},setSelectionHandler:function(e){this.selectionHandler=e},handleSelection:function(e){this.selectionHandler&&this.selectionHandler(1==e)},insertTo:function(e){e.append(this.html)}}),Oskari.clazz.define("Oskari.userinterface.component.Badge",function(){this.compiledTemplates={},this.compileTemplates(),this.ui=null,this.container=null},{templates:{"default":'<span class="oskari-badge"></span>',success:'<span class="oskari-badge oskari-badge-success"></span>',warning:'<span class="oskari-badge oskari-badge-warning"></span>',important:'<span class="oskari-badge oskari-badge-important"></span>',info:'<span class="oskari-badge oskari-badge-info"></span>',success:'<span class="oskari-badge oskari-badge-inverse"></span>'},compileTemplates:function(){for(var e in this.templates)this.compiledTemplates[e]=jQuery(this.templates[e])},insertTo:function(e){this.container=e},setContent:function(e,t){this.ui&&(this.ui.remove(),this.ui=null);var i=this.compiledTemplates[t||"default"].clone();i.append(e),this.container.append(i),this.ui=i},hide:function(){this.ui&&(this.ui.remove(),this.ui=null)}}),Oskari.clazz.define("Oskari.userinterface.component.Alert",function(){this.compiledTemplates={},this.compileTemplates(),this.ui=null,this.container=null},{templates:{"default":'<div class="oskari-alert"><div class="oskari-alert-icon-close"><div class="icon-close"></div></div></div>',success:'<div class="oskari-alert oskari-alert-success"><div class="oskari-alert-icon-close"><div class="icon-close"></div></div></div>',error:'<div class="oskari-alert oskari-alert-error"><div class="oskari-alert-icon-close"><div class="icon-close"></div></div></div>',info:'<div class="oskari-alert oskari-alert-info"><div class="oskari-alert-icon-close"><div class="icon-close"></div></div></div>'},compileTemplates:function(){for(var e in this.templates)this.compiledTemplates[e]=jQuery(this.templates[e])},insertTo:function(e){this.container=e},setContent:function(e,t,i){this.ui&&(this.ui.remove(),this.ui=null);var a=this.compiledTemplates[t||"default"].clone();a.append(e),this.container.prepend(a),this.ui=a;var n=this;i?a.children(".oskari-alert-icon-close").remove():a.children(".oskari-alert-icon-close").click(function(){n.hide()})},hide:function(){this.ui&&(this.ui.remove(),this.ui=null)}}),Oskari.clazz.define("Oskari.userinterface.component.Popup",function(){this.template=jQuery('<div class="divmanazerpopup"><h3></h3><div class="content"></div><div class="actions"></div></div>'),this.templateButton=jQuery('<div class="button"><a href="JavaScript:void(0);"></a></div>'),this.dialog=this.template.clone(),this.overlay=null},{show:function(e,t,i){var a=this;this.dialog.find("h3").html(e);var n=this.dialog.find("div.content");if(n.html(t),i&&i.length>0){var s=this.dialog.find("div.actions");s.empty();for(var r=0;r<i.length;++r)i[r].insertTo(s)}else this.dialog.bind("click",function(){a.close(!0)});jQuery("body").append(this.dialog);var o=n.height(),l=.6*jQuery(document).height();o>l&&(n.height(l),n.css("overflow-y","auto")),this.dialog.css("margin-left",-(this.dialog.width()/2)+"px"),this.dialog.css("margin-top",-(this.dialog.height()/2)+"px")},fadeout:function(e){var t=this,i=3e3;e&&(i=e),setTimeout(function(){t.close()},i)},addClass:function(e){this.dialog.addClass(e)},createCloseButton:function(e){var t=this,i=Oskari.clazz.create("Oskari.userinterface.component.Button");return i.setTitle(e),i.setHandler(function(){t.close(!0)}),i},close:function(e){var t=this;this.overlay&&this.overlay.close(),e?t.dialog.remove():(t.dialog.animate({opacity:0},500),setTimeout(function(){t.dialog.remove()},500))},alignment:["left","right","top","bottom"],moveTo:function(e,t){var i="right";t&&-1!=jQuery.inArray(t,this.alignment)&&(i=t);var a=jQuery(e),n=a.offset(),s=a.outerWidth(),r=a.outerHeight(),o=this.dialog.outerWidth(),l=this.dialog.outerHeight(),u=n.left,c=n.top;"right"==i?(u=u+s+5,c=c+r/2-l/2):"left"==i?(u=u-o-5,c=c+r/2-l/2):"top"==i?(c=c-l-5,u=u+s/2-o/2):"bottom"==i&&(c=c+r+5,u=u+s/2-o/2),0>u&&(u=0),0>c&&(c=0),this.dialog.addClass("arrow"),this.dialog.addClass(t),this.dialog.css({left:u+"px",top:c+"px","margin-left":0,"margin-top":0})},resetPosition:function(){this.dialog.removeClass("arrow");for(var e=0;e<this.alignment.length;++e)this.dialog.removeClass(this.alignment[e]);this.dialog.removeAttr("style")},makeModal:function(){var e=Oskari.clazz.create("Oskari.userinterface.component.Overlay");e.overlay("body"),this.overlay=e,e.followResizing(!0)},setContent:function(e){var t=this.dialog.find("div.content");t.empty(),t.append(e)},getContent:function(){return this.dialog.find("div.content")[0].textContent},getJqueryContent:function(){return this.dialog.find("div.content")},makeDraggable:function(){var e=this;e.dialog.css("position","absolute"),e.dialog.draggable({scroll:!1})}}),Oskari.clazz.define("Oskari.userinterface.component.Overlay",function(){this.template=jQuery('<div class="oskarioverlay transparent"></div>'),this._overlay=null,this._targetSelector=null,this._resizingWorkaround=null},{overlay:function(e){this._overlay=this.template.clone(),this._targetSelector=e,this._targetSelector||(this._targetSelector="body");var t=jQuery(this._targetSelector);t.append(this._overlay),this._setupSizeAndLocation(),this._overlay.bind("click",function(e){e.preventDefault()})},_setupSizeAndLocation:function(){var e=jQuery(this._targetSelector);this._overlay.css({left:"0px",top:"0px",width:e.width()+"px",height:e.height()+"px"})},resize:function(){var e=jQuery(this._targetSelector);this._overlay.height(e.height()),this._overlay.width(e.width())},followResizing:function(e){var t=this;e?jQuery(window).resize(function(){t.resize()}):this._resizingWorkaround=setTimeout(function(){t.resize(),t.followResizing()},500)},close:function(){this._overlay.remove(),jQuery(this._targetSelector),this._resizingWorkaround&&clearTimeout(this._resizingWorkaround)},bindClickToClose:function(){var e=this;this._overlay.bind("click",function(){e.close()})}}),Oskari.clazz.define("Oskari.userinterface.component.Button",function(){this.template=jQuery('<input type="button"/>'),this.title=null,this.ui=this.template.clone(),this.handler=null},{setTitle:function(e){this.title=e,this.ui&&this.ui.attr("value",e)},addClass:function(e){this.ui.addClass(e)},setEnabled:function(e){e===!0?this.ui.removeAttr("disabled"):this.ui.attr("disabled","disabled")},getTitle:function(){return this.title},setHandler:function(e){this.handler&&this.ui.unbind("click",this.handler),this.handler=e,this.ui.bind("click",this.handler)},destroy:function(){this.ui.remove()},insertTo:function(e){e.append(this.ui)},getButton:function(){return this.ui}}),Oskari.clazz.define("Oskari.userinterface.component.Form",function(){this.template=jQuery('<div class="oskariform"></div>'),this._form=this.template.clone(),this.fields=[]},{addField:function(e){this.fields.push(e)},getForm:function(){this._form=this.template.clone();for(var e=0;e<this.fields.length;++e)this._form.append(this.fields[e].getField());return this._form},validate:function(){for(var e=[],t=0;t<this.fields.length;++t)e=e.concat(this.fields[t].validate());return e},showErrors:function(){for(var e=0;e<this.fields.length;++e){var t=this.fields[e].validate();this.fields[e].showErrors(t)}},clearErrors:function(){for(var e=0;e<this.fields.length;++e)this.fields[e].clearErrors()}}),Oskari.clazz.define("Oskari.userinterface.component.UIHelper",function(e){this.sandbox=e},{processHelpLinks:function(e,t,i,a){if(t){var n=this,s=function(t){return function(n,s){var r=Oskari.clazz.create("Oskari.userinterface.component.Popup"),o=r.createCloseButton("OK");o.addClass("primary"),n?(r.show(e,s["static"],[o]),r.moveTo(t,"bottom")):r.show(i,a,[o])}};t.find("[helptags]").each(function(e,t){var i=jQuery(t),a=i.attr("helptags");i.bind("click",function(){n.getHelpArticle(a,s(i))})})}},getHelpArticle:function(e,t){var i=this;jQuery.ajax({url:i.sandbox.getAjaxUrl()+"action_route=GetArticlesByTag",data:{tags:e},type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(e){e&&e.articles[0]&&e.articles[0].content?t(!0,e.articles[0].content):t(!1)},error:function(){t(!1)}})}}),Oskari.clazz.define("Oskari.userinterface.component.FormInput",function(e,t){var i=t||Oskari.getSandbox();this.sandbox=i,this.template=jQuery('<div class="oskarifield"><label></label><input type="text" autofocus/></div>'),this.templateErrors=jQuery('<div class="error"></div>'),this.templateTooltip=jQuery('<div class="icon-info"></div>'),this.templateClearButton=jQuery('<div class="icon-close" style="margin-left: 0px; position: relative; display: inline-block; left: -20px; top: 3px;"></div>'),this._field=this.template.clone();var a=this._field.find("label");a.attr("for",e);var n=this._field.find("input").focus();n.attr("name",e),this._name=e,this._validator=null,this._required=!1,this._requiredMsg="required",this._contentCheck=!1,this._contentCheckMsg="illegal characters",this._bindFocusAndBlur(),this._regExp=/[\s\w\d\.\,\?\!\-äöåÄÖÅ]*/,this._colorRegExp=/^([A-Fa-f0-9]{6})$/},{setLabel:function(e){var t=this._field.find("label");t.html(e)},setTooltip:function(e,t){var i=this.templateTooltip.clone();i.attr("title",e),t&&(i.addClass("help"),i.attr("helptags",t));var a=this._field.find("label");a.before(i)},setPlaceholder:function(e){var t=this._field.find("input");t.attr("placeholder",e)},setRequired:function(e,t){this._required=1==e,t&&(this._requiredMsg=t)},setContentCheck:function(e,t,i){this._contentCheck=1==e,i&&(this._regExp=i),t&&(this._contentCheckMsg=t)},showErrors:function(e){this.clearErrors();for(var t=this.templateErrors.clone(),i=0;i<e.length;++i)t.append(e[i].error+"<br/>");this._field.append(t)},clearErrors:function(){var e=this._field.find("div.error");e.remove()},getField:function(){return this._field},getValue:function(e){var t=this._field.find("input").val();return e&&(t=t.match(this._regExp)),t},setValue:function(e){this._field.find("input").attr("value",e)},getName:function(){return this._name},setEnabled:function(e){e===!0?this._field.find("input").removeAttr("disabled"):this._field.find("input").attr("disabled","disabled")},setRegExp:function(e){this._regExp=e},setValidator:function(e){this._validator=e},validate:function(){var e=[];this._validator&&(e=this._validator(this));var t=this.getValue();return this._required&&(this.checkLength(t,1)||e.push({field:this.getName(),error:this._requiredMsg})),this._contentCheck&&(this.checkValue()||e.push({field:this.getName(),error:this._contentCheckMsg})),e},checkLength:function(e,t,i){if(e){var a=jQuery.trim(e.toString());return t&&a.length<t?!1:i&&a.length>i?!1:!0}return!1},checkValue:function(){var e=this.getValue(),t=this.getValue(!0);return e==t},validateNumberRange:function(e,t,i){return isNaN(parseInt(e))?!1:isFinite(e)?t>e||e>i?!1:!0:!1},validateHexColor:function(e){return this._colorRegExp.test(e)},bindEnterKey:function(e){var t=this,i=this._field.find("input");i.keypress(function(i){t._isEnterPress(i)&&e(i)})},bindUpKey:function(e){var t=this,i=this._field.find("input");i.keydown(function(i){t._isUpPress(i)&&(i.preventDefault(),e(i))})},bindDownKey:function(e){var t=this,i=this._field.find("input");i.keydown(function(i){t._isDownPress(i)&&(i.preventDefault(),e(i))})},bindOnBlur:function(e){var t=this._field.find("input");t.blur(function(){e()})},bindChange:function(e,t){var i=this._field.find("input");t?i.keyup(e):i.on("change",e)},addClearButton:function(){var e=this.templateClearButton.clone(),t=this._field.find("input");e.bind("click",function(){t.val(""),t.trigger("change"),t.trigger("keyup")}),t.after(e)},_bindFocusAndBlur:function(){var e=this.sandbox;if(e){var t=e.getRequestBuilder("EnableMapKeyboardMovementRequest"),i=e.getRequestBuilder("DisableMapKeyboardMovementRequest");if(t&&i){var a=this._field.find("input");a.focus(function(){e.postRequestByName("DisableMapKeyboardMovementRequest")}),a.blur(function(){e.postRequestByName("EnableMapKeyboardMovementRequest")})}}},_isEnterPress:function(e){var t=e.which;return 13==t},_isDownPress:function(e){var t=e.which;return 40==t},_isUpPress:function(e){var t=e.which;return 38==t}}),!function(e){"use strict";var t=function(e,t){this.init("oskariTooltip",e,t)};t.prototype={constructor:t,init:function(t,i,a){var n,s;this.type=t,this.$element=e(i),this.options=this.getOptions(a),this.enabled=!0,"manual"!=this.options.trigger&&(n="hover"==this.options.trigger?"mouseenter":"focus",s="hover"==this.options.trigger?"mouseleave":"blur",this.$element.on(n,this.options.selector,e.proxy(this.enter,this)),this.$element.on(s,this.options.selector,e.proxy(this.leave,this))),this.options.selector?this._options=e.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},getOptions:function(t){return t=e.extend({},e.fn[this.type].defaults,t,this.$element.data()),t.delay&&"number"==typeof t.delay&&(t.delay={show:t.delay,hide:t.delay}),t},enter:function(t){var i=e(t.currentTarget)[this.type](this._options).data(this.type);return i.options.delay&&i.options.delay.show?(clearTimeout(this.timeout),i.hoverState="in",this.timeout=setTimeout(function(){"in"==i.hoverState&&i.show()},i.options.delay.show),void 0):i.show()},leave:function(t){var i=e(t.currentTarget)[this.type](this._options).data(this.type);return i.options.delay&&i.options.delay.hide?(clearTimeout(this.timeout),i.hoverState="out",this.timeout=setTimeout(function(){"out"==i.hoverState&&i.hide()},i.options.delay.hide),void 0):i.hide()},show:function(){var e,t,i,a,n,s,r;if(this.hasContent()&&this.enabled){switch(e=this.tip(),this.setContent(),this.options.animation&&e.addClass("fade"),s=this.options.placement.apply(this.options.scope),t=/in/.test(s),e.remove().css({top:0,left:0,display:"block"}).appendTo(t?this.$element:document.body),i=this.getPosition(t),a=e[0].offsetWidth,n=e[0].offsetHeight,t?s.split(" ")[1]:s){case"bottom":r={top:i.top+i.height,left:i.left+i.width/2-a/2};break;case"top":r={top:i.top-n,left:i.left+i.width/2-a/2};break;case"left":r={top:i.top+i.height/2-n/2,left:i.left-a};break;case"right":r={top:i.top+i.height/2-n/2,left:i.left+i.width}}e.css(r).addClass(s).addClass("in")}},isHTML:function(e){return"string"!=typeof e||"<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3||/^(?:[^<]*<[\w\W]+>[^>]*$)/.exec(e)},setContent:function(){var e=this.tip(),t=this.getTitle();e.find(".oskari-tooltip-inner")[this.isHTML(t)?"html":"text"](t),e.removeClass("fade in top bottom left right")},hide:function(){function t(){var t=setTimeout(function(){i.off(e.support.transition.end).remove()},500);i.one(e.support.transition.end,function(){clearTimeout(t),i.remove()})}var i=this.tip();i.removeClass("in"),e.support.transition&&this.$tip.hasClass("fade")?t():i.remove()},fixTitle:function(){var e=this.$element;(e.attr("title")||"string"!=typeof e.attr("data-original-title"))&&e.attr("data-original-title",e.attr("title")||"").removeAttr("title")},hasContent:function(){return this.getTitle()},getPosition:function(t){return e.extend({},t?{top:0,left:0}:this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight})},getTitle:function(){return this.options.title.apply(this.options.scope)},tip:function(){return this.$tip=this.$tip||e(this.options.template)},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled},toggle:function(){this[this.tip().hasClass("in")?"hide":"show"]()},attach:function(e){this.$element=e}},e.fn.oskariTooltip=function(i){return this.each(function(){var a=e(this),n=a.data("oskariTooltip"),s="object"==typeof i&&i;n||a.data("oskariTooltip",n=new t(this,s)),"string"==typeof i&&n[i]()})},e.fn.oskariTooltip.Constructor=t,e.fn.oskariTooltip.defaults={animation:!0,placement:"top",selector:!1,template:'<div class="oskari-tooltip"><div class="oskari-tooltip-arrow"></div><div class="oskari-tooltip-inner"></div></div>',trigger:"hover",title:"",delay:0};var i=function(e,t){this.init("oskariPopover",e,t)};i.prototype=e.extend({},e.fn.oskariTooltip.Constructor.prototype,{constructor:i,setContent:function(){var e=this.tip(),t=this.getTitle(),i=this.getContent();e.find(".oskari-popover-title")[this.isHTML(t)?"html":"text"](t),e.find(".oskari-popover-content > *")[this.isHTML(i)?"html":"text"](i),e.removeClass("fade top bottom left right in")},hasContent:function(){return this.getTitle()||this.getContent()},getContent:function(){return this.options.content.apply(this.options.scope)},tip:function(){return this.$tip||(this.$tip=e(this.options.template)),this.$tip}}),e.fn.oskariPopover=function(t){return this.each(function(){var a=e(this),n=a.data("oskariPopover"),s="object"==typeof t&&t;n||a.data("oskariPopover",n=new i(this,s)),"string"==typeof t&&n[t]()})},e.fn.oskariPopover.Constructor=i,e.fn.oskariPopover.defaults=e.extend({},e.fn.oskariTooltip.defaults,{placement:"right",content:"",template:'<div class="oskari-popover"><div class="oskari-arrow"></div><div class="oskari-popover-inner"><h3 class="oskari-popover-title"></h3><div class="oskari-popover-content"><p></p></div></div></div>'}),Oskari.clazz.define("Oskari.userinterface.component.Popover",function(e,t){this.title=e,this.content=t,this.$container=null,this.data=null,this.shown=!1,this.placement="bottom"},{templates:{container:'<div class="oskari-popover-container"/>'},hide:function(){this.shown&&(this.shown=!1,this.data&&this.data.hide())},show:function(){this.shown||this.data&&(this.data.show(),this.shown=!0)},attachTo:function(t){var a=this;this.$container=e(t),this.data?this.data.attach(this.$container):this.data=new i(t,{scope:a,title:a.getTitle,content:a.getContent,trigger:"manual",placement:a.getPlacement}),this.$container.data("oskariPopover",this.data)},getTitle:function(){return this.title},getContent:function(){return this.content},setContent:function(e,t){this.hide(),this.content=e,t&&(this.title=t),this.show()},setTitle:function(e,t){this.hide(),this.title=e,t&&(this.content=t),this.show()},setPlacement:function(e){this.placement=e},getPlacement:function(){return this.placement}})}(window.jQuery),Oskari.clazz.define("Oskari.userinterface.component.Grid",function(e){this.model=null;var t="";"undefined"!=typeof e&&(t=e),this.template=jQuery('<table class="oskari-grid"><thead><tr></tr></thead><tbody></tbody></table>'),this.templateTableHeader=jQuery('<th><a href="JavaScript:void(0);"></a></th>'),this.templateRow=jQuery("<tr></tr>"),this.templateCell=jQuery("<td></td>"),this.templatePopupLink=jQuery('<a href="JavaScript: void(0);"></a>'),this.templateColumnSelectorButtonWrapper=jQuery("<div/>",{}),this.templateColumnSelectorButton=jQuery("<div/>",{title:t}),this.templateColumnSelector=jQuery("<div/>",{}),this.templateColumnSelectorList=jQuery("<ul/>",{}),this.templateColumnSelectorListItem=jQuery('<li><div><input type="checkbox"/><label></label></div></li>'),this.templateColumnSelectorClose=jQuery('<div class="icon-close close-selector-button"></div>'),this.table=null,this.fieldNames=[],this.selectionListeners=[],this.additionalDataHandler=null,this.visibleColumnSelector=null,this.showColumnSelector=!1,this.resizableColumns=!1,this.uiNames={},this.valueRenderer={},this.lastSort=null},{setDataModel:function(e){this.model=e},getDataModel:function(){return this.model},setColumnSelector:function(e){this.showColumnSelector=e},setResizableColumns:function(e){this.resizableColumns=e},setColumnUIName:function(e,t){this.uiNames[e]=t},setColumnValueRenderer:function(e,t){this.valueRenderer[e]=t},setVisibleFields:function(e){this.fieldNames=e},addSelectionListener:function(e){this.selectionListeners.push(e)},setAdditionalDataHandler:function(e,t){this.additionalDataHandler={title:e,handler:t}},_createAdditionalDataField:function(e){var t=this._renderAdditionalData(e);if(!e.size&&this.additionalDataHandler){var i=this,a=this.templatePopupLink.clone();return a.append(this.additionalDataHandler.title),a.bind("click",function(){return i.additionalDataHandler.handler(a,t),!1}),a}return t},_renderAdditionalData:function(e){if(e.size){for(var t="",i=0;i<e.size();++i)0!=i&&(t+=", "),t+=e[i];return t}var a=this.template.clone(),n=a.find("tbody");for(var s in e){var r=this.templateRow.clone(),t=e[s],o=this.templateCell.clone();o.append(s),r.append(o);var l=this.templateCell.clone();try{var u=typeof t;if("object"===u){var c=this._renderAdditionalData(t);l.append(c)}else"function"!==u&&l.append(t);r.append(l)}catch(h){}n.append(r)}return a},_renderHeader:function(e,t){for(var i=this,a=e.find("thead tr"),n=e.find("tbody"),s=function(s){return function(){var r=jQuery(this),o=i.getSelection();n.empty();var l=!1;i.lastSort&&i.lastSort.attr==s&&(l=!i.lastSort.descending),i._sortBy(s,l),i._renderBody(e,t),a.find("th").removeClass("asc"),a.find("th").removeClass("desc"),l?r.parent().addClass("desc"):r.parent().addClass("asc");for(var u=i.model.getIdField(),c=0;c<o.length;++c)i.select(o[c][u],!0);return!1}},r=0;r<t.length;++r){var o=this.templateTableHeader.clone(),l=o.find("a"),u=t[r],c=this.uiNames[u];c||(c=u),l.append(c),i.lastSort&&u==i.lastSort.attr&&(i.lastSort.descending?o.addClass("desc"):o.addClass("asc")),l.bind("click",s(t[r])),a.append(o)}},_renderBody:function(e,t){for(var i=this,a=e.find("tbody"),n=this.model.getData(),s=0;s<n.length;++s){var r=this.templateRow.clone(),o=n[s];r.attr("data-id",o[this.model.getIdField()]);for(var l=0;l<t.length;++l){var u=t[l],c=o[u],h=this.templateCell.clone();if("object"==typeof c)h.append(this._createAdditionalDataField(c));else{var d=this.valueRenderer[u];d&&(c=d(c,o)),h.append(c)}r.append(h)}a.append(r)}var p=e.find("tbody tr"),f=function(){i._dataSelected(jQuery(this).attr("data-id"))};p.bind("click",f),p.find("a").hover(function(){jQuery(this).parents("tr").unbind("click")},function(){jQuery(this).parents("tr").bind("click",f)})},_renderColumnSelector:function(e,t){this.visibleColumnSelector=this.templateColumnSelectorButtonWrapper.clone();var i=this.templateColumnSelectorButton.clone(),a=this.templateColumnSelector.clone(),n=this.templateColumnSelectorList.clone(),s=this.templateColumnSelectorClose.clone();
this.visibleColumnSelector.addClass("column-selector-placeholder"),i.addClass("icon-menu"),a.addClass("column-selector"),this.visibleColumnSelector.append(i),this.visibleColumnSelector.append(a);var r=this;jQuery("input.column-selector-list-item").remove(),i.click(function(){"hidden"!==a.css("visibility")?a.css("visibility","hidden"):a.css("visibility","visible")}),s.click(function(e){e.stopPropagation(),a.css("visibility","hidden")});for(var o,l=this.model.getFields(),u=0;u<l.length;u++){o=!1;for(var c=0;c<t.length;c++)if(l[u]===t[c]){o=!0;break}var h=this.templateColumnSelectorListItem.clone();h.addClass("column-selector-list-item");var d=h.find("input");d.attr("checked",o),d.addClass("column-selector-list-item"),d.attr("id",l[u]),h.find("label").attr({"for":l[u],"class":"column-label"}).html(l[u]),h.css({margin:"5px"}),d.change(function(){for(var e=jQuery("input.column-selector-list-item"),t=r.model.getFields(),i=[],a=0;a<t.length;a++)for(var n=0;n<e.length;n++)if(t[a]===e[n].id){e[n].checked&&i.push(t[a]);break}i.length>0&&r.setVisibleFields(i),r.renderTo(r.visibleColumnSelector.parent(),{columnSelector:"open"})}),n.append(h)}n.attr("class","column-selector-list"),a.append(n,s),s.click(function(e){e.stopPropagation(),a.css("visibility","hidden")})},_enableColumnResizer:function(){var e,t,i=!1,a=void 0,n=jQuery("table.oskari-grid th");n.css("cursor","e-resize"),n.mousedown(function(n){a=jQuery(this),i=!0,e=n.pageX,t=jQuery(this).width(),jQuery(a).addClass("resizing"),jQuery(document).attr("unselectable","on").css("user-select","none").on("selectstart",!1)}),jQuery(document).mousemove(function(n){i&&jQuery(a).width(t+(n.pageX-e))}),jQuery(document).mouseup(function(){i&&(jQuery(a).removeClass("resizing"),i=!1)})},renderTo:function(e,t){e.empty();var i=this.fieldNames;0==i.length&&(i=this.model.getFields());var a=this.template.clone();this.table=a,this._renderHeader(a,i),this.lastSort&&this._sortBy(this.lastSort.attr,this.lastSort.descending),this._renderBody(a,i),this.showColumnSelector&&(this._renderColumnSelector(a,i),e.append(this.visibleColumnSelector),null!=t&&"open"==t.columnSelector&&this.visibleColumnSelector.find(".column-selector").css("visibility","visible")),e.append(a),this.resizableColumns&&this._enableColumnResizer()},_dataSelected:function(e){for(var t=0;t<this.selectionListeners.length;t++)this.selectionListeners[t](this,e)},select:function(e,t){for(var i=this.model.getIdField(),a=this.model.getData(),n=0;n<a.length;++n){var s=a[n];if(s[i]==e)break}var r=this.table.find("tbody tr");1!=t&&r.removeClass("selected"),jQuery(r[n]).addClass("selected")},removeSelections:function(){var e=this.table.find("tbody tr");e.removeClass("selected")},getSelection:function(){for(var e=this.model.getData(),t=[],i=this.table.find("tbody tr"),a=0;a<i.length;++a){var n=jQuery(i[a]);n.hasClass("selected")&&t.push(e[a])}return t},getTable:function(){return this.table},_sortBy:function(e,t){var i=this,a=this.model.getData();0!=a.length&&(this.lastSort={attr:e,descending:t},a.sort(function(a,n){return i._sortComparator(a,n,e,t)}))},_sortComparator:function(e,t,i,a){if("object"==typeof e[i]||"object"==typeof t[i])return 0;var n=e[i];n?n.toLowerCase&&(n=n.toLowerCase()):n="";var s=t[i];s?s.toLowerCase&&(s=s.toLowerCase()):s="";var r=0;return s>n?r=-1:n>s&&(r=1),a&&(r=-1*r),r}}),Oskari.clazz.define("Oskari.userinterface.component.GridModel",function(){this.fields=[],this.data=[],this.idField=null},{_addField:function(e){this.idField||(this.idField=e),this.fields.push(e)},getFields:function(){return this.fields},setIdField:function(e){this.idField=e},getIdField:function(){return this.idField},addData:function(e){if(0==this.fields.length)for(var t in e)this._addField(t);this.data.push(e)},getData:function(){return this.data}}),Oskari.clazz.define("Oskari.userinterface.component.ProgressSpinner",function(){this.container=void 0,this.opts=void 0},{__opts:{lines:15,length:0,width:5,radius:16,corners:0,rotate:0,color:"#000",speed:.6,trail:59,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},insertTo:function(e,t){this.container=e,this.opts=t||this.__opts},start:function(){var e=this.container,t=$(e),i=t.data(),a=this._Spinner,n=this.opts;i.spinner&&(i.spinner.stop(),delete i.spinner),n!==!1&&(i.spinner=new a($.extend({color:t.css("color")},n)).spin(t.get()[0]))},stop:function(){var e=this.container;if(e){var t=$(e),i=t.data();i.spinner&&(i.spinner.stop(),delete i.spinner)}},_Spinner:function(e,t,i){function a(e,i){var a,n=t.createElement(e||"div");for(a in i)n[a]=i[a];return n}function n(e){for(var t=1,i=arguments.length;i>t;t++)e.appendChild(arguments[t]);return e}function s(e,t,i,a){var n=["opacity",t,~~(100*e),i,a].join("-"),s=.01+100*(i/a),r=Math.max(1-(1-e)/t*(100-s),e),o=h.substring(0,h.indexOf("Animation")).toLowerCase(),l=o&&"-"+o+"-"||"";return p[n]||(f.insertRule("@"+l+"keyframes "+n+"{"+"0%{opacity:"+r+"}"+s+"%{opacity:"+e+"}"+(s+.01)+"%{opacity:1}"+(s+t)%100+"%{opacity:"+e+"}"+"100%{opacity:"+r+"}"+"}",f.cssRules.length),p[n]=1),n}function r(e,t){var a,n,s=e.style;if(s[t]!==i)return t;for(t=t.charAt(0).toUpperCase()+t.slice(1),n=0;n<d.length;n++)if(a=d[n]+t,s[a]!==i)return a}function o(e,t){for(var i in t)e.style[r(e,i)||i]=t[i];return e}function l(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)e[n]===i&&(e[n]=a[n])}return e}function u(e){for(var t={x:e.offsetLeft,y:e.offsetTop};e=e.offsetParent;)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function c(e){return this.spin?(this.opts=l(e||{},c.defaults,m),void 0):new c(e)}var h,d=["webkit","Moz","ms","O"],p={},f=function(){var e=a("style",{type:"text/css"});return n(t.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}(),m={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};return c.defaults={},l(c.prototype,{spin:function(e){this.stop();var t,i,n=this,s=n.opts,r=n.el=o(a(0,{className:s.className}),{position:s.position,width:0,zIndex:s.zIndex}),l=s.radius+s.length+s.width;if(e&&(e.insertBefore(r,e.firstChild||null),i=u(e),t=u(r),o(r,{left:("auto"==s.left?i.x-t.x+(e.offsetWidth>>1):parseInt(s.left,10)+l)+"px",top:("auto"==s.top?i.y-t.y+(e.offsetHeight>>1):parseInt(s.top,10)+l)+"px"})),r.setAttribute("aria-role","progressbar"),n.lines(r,n.opts),!h){var c=0,d=s.fps,p=d/s.speed,f=(1-s.opacity)/(p*s.trail/100),m=p/s.lines;!function g(){c++;for(var e=s.lines;e;e--){var t=Math.max(1-(c+e*m)%p*f,s.opacity);n.opacity(r,s.lines-e,t,s)}n.timeout=n.el&&setTimeout(g,~~(1e3/d))}()}return n},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=i),this},lines:function(e,t){function i(e,i){return o(a(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:e,boxShadow:i,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*l+t.rotate)+"deg) translate("+t.radius+"px"+",0)",borderRadius:(t.corners*t.width>>1)+"px"})}for(var r,l=0;l<t.lines;l++)r=o(a(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:h&&s(t.opacity,t.trail,l,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&n(r,o(i("#000","0 0 4px #000"),{top:"2px"})),n(e,n(r,i(t.color,"0 0 1px rgba(0,0,0,.1)")));return e},opacity:function(e,t,i){t<e.childNodes.length&&(e.childNodes[t].style.opacity=i)}}),function(){function e(e,t){return a("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}var t=o(a("group"),{behavior:"url(#default#VML)"});!r(t,"transform")&&t.adj?(f.addRule(".spin-vml","behavior:url(#default#VML)"),c.prototype.lines=function(t,i){function a(){return o(e("group",{coordsize:u+" "+u,coordorigin:-l+" "+-l}),{width:u,height:u})}function s(t,s,r){n(h,n(o(a(),{rotation:360/i.lines*t+"deg",left:~~s}),n(o(e("roundrect",{arcsize:i.corners}),{width:l,height:i.width,left:i.radius,top:-i.width>>1,filter:r}),e("fill",{color:i.color,opacity:i.opacity}),e("stroke",{opacity:0}))))}var r,l=i.length+i.width,u=2*l,c=2*-(i.width+i.length)+"px",h=o(a(),{position:"absolute",top:c,left:c});if(i.shadow)for(r=1;r<=i.lines;r++)s(r,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(r=1;r<=i.lines;r++)s(r);return n(t,h)},c.prototype.opacity=function(e,t,i,a){var n=e.firstChild;a=a.shadow&&a.lines||0,n&&t+a<n.childNodes.length&&(n=n.childNodes[t+a],n=n&&n.firstChild,n=n&&n.firstChild,n&&(n.opacity=i))}):h=r(t,"animation")}(),c}(window,document)}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultTile",function(e,t){this.locale=t,this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.userinterface.extension.DefaultTile"},setEl:function(e){this.container=$(e)},startPlugin:function(){},stopPlugin:function(){},getTitle:function(){return this.locale.title},getDescription:function(){return this.locale.description},getOptions:function(){},setState:function(e){this.state=e},getState:function(){return this.state}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultFlyout",function(e,t){this.instance=e,this.locale=t,this.container=null},{getName:function(){return"Oskari.userinterface.extension.DefaultFlyout"},setEl:function(e){this.container=jQuery(e)},getEl:function(){return this.container},startPlugin:function(){},stopPlugin:function(){},getTitle:function(){return this.locale.title},getDescription:function(){return this.locale.description},setState:function(e){this.state=e},getState:function(){return this.state},getLocalization:function(){return this.locale}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultExtension",function(e,t,i,a){this.sandbox=null,this.plugins={},this._localization=null,this.conf={name:e,tileClazz:i||"Oskari.userinterface.extension.DefaultTile",flyoutClazz:t||"Oskari.userinterface.extension.DefaultFlyout",viewClazz:a}},{getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},getSandbox:function(){return this.sandbox},update:function(){},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this,t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,a.register(this),t&&t.stateful===!0&&a.registerAsStateful(this.mediator.bundleId,this);var n=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,n)},stop:function(){var e=this.sandbox,t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),e.unregisterStateful(this.mediator.bundleId),e.unregister(this),this.sandbox=null,this.started=!1},startExtension:function(){var e=this,t=e.sandbox;for(p in e.eventHandlers)t.registerForEventByName(e,p);var i=e.getLocalization("flyout");i&&e.conf.flyoutClazz&&(e.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create(e.conf.flyoutClazz,e,i));var a=e.getLocalization("tile");a&&e.conf.tileClazz&&(e.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create(e.conf.tileClazz,e,a));var n=e.getLocalization("view");n&&e.conf.viewClazz&&(e.plugins["Oskari.userinterface.View"]=Oskari.clazz.create(e.conf.viewClazz,e,n))},stopExtension:function(){var e=this,t=e.sandbox;for(p in e.eventHandlers)t.unregisterFromEventByName(e,p);for(var i in e.plugins)i&&(e.plugins[i]=null)},getPlugins:function(){return this.plugins},init:function(){return null},getName:function(){return this.conf.name},getConfiguration:function(){return this.conf},eventHandlers:{},onEvent:function(e){var t=this,i=t.eventHandlers[e.getName()];return i?i.apply(this,[e]):void 0},getLang:function(){return Oskari.getLang()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultView",function(e,t){this.instance=e,this.locale=t,this.container=null},{getName:function(){return"Oskari.userinterface.extension.DefaultView"},setEl:function(e){this.container=jQuery(e)},getEl:function(){return this.container},startPlugin:function(){},stopPlugin:function(){},getTitle:function(){return this.locale.title},getDescription:function(){return this.locale.description},setState:function(e){this.state=e},getState:function(){return this.state},getLocalization:function(){return this.locale}},{protocol:["Oskari.userinterface.View"]}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultLayout",function(e,t){this.instance=e,this.locale=t,this.container=null},{getName:function(){return"Oskari.userinterface.extension.DefaultLayout"},setEl:function(e){this.container=jQuery(e)},getEl:function(){return this.container},startPlugin:function(){},stopPlugin:function(){},getTitle:function(){return this.locale.title},getDescription:function(){return this.locale.description},setState:function(e){this.state=e},getState:function(){return this.state},getLocalization:function(){return this.locale}},{protocol:["Oskari.userinterface.Layout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.ToolbarBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.toolbar.ToolbarBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/button-methods.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/default-buttons.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/AddToolButtonRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/RemoveToolButtonRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ToolButtonStateRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/SelectToolButtonRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ToolButtonRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ShowMapMeasurementRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/event/ToolSelectedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ToolbarRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ToolbarRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/toolbar/css/toolbar.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"toolbar","Bundle-Name":"toolbar","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"Toolbar",Title:"Toolbar"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("toolbar","Oskari.mapframework.bundle.toolbar.ToolbarBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.ToolbarBundleInstance",function(){this.sandbox=null,this.started=!1,this.buttons={},this.selectedButton=null,this.defaultButton=null,this.container=null,this.menutoolbarcontainer=null,this.containers={},this.toolbars={},this.groupsToToolbars={}},{__name:"Toolbar",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},update:function(){},start:function(){var e=this;if(!e.started){e.started=!0;var t=e.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);a.register(e),e.setSandbox(a);var n=(t?t.defaultToolbarContainer:null)||"#toolbar";this.container=jQuery(n),this.containers["default"]=this.container,this.toolbars["default"]=this.container;var s=(t?t.defaultMenuToolbarContainer:null)||"#menutoolbar";this.menutoolbarcontainer=jQuery(s);for(var r in e.eventHandlers)r&&a.registerForEventByName(e,r);a.addRequestHandler("Toolbar.AddToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),a.addRequestHandler("Toolbar.RemoveToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),a.addRequestHandler("Toolbar.ToolButtonStateRequest",this.requestHandlers.toolButtonRequestHandler),a.addRequestHandler("Toolbar.SelectToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),a.addRequestHandler("Toolbar.ToolbarRequest",this.requestHandlers.toolbarRequestHandler),a.addRequestHandler("ShowMapMeasurementRequest",this.requestHandlers.showMapMeasurementRequestHandler),a.registerAsStateful(this.mediator.bundleId,this),this._addDefaultButtons&&this._addDefaultButtons()}},templates:{group:'<div class="toolrow"></div>',tool:'<div class="tool"></div>',menutoolbar:'<div class="oskari-closed oskariui-menutoolbar"><div class="oskariui-menutoolbar-modetitle"><div class="oskariui-menutoolbar-title"><p></p></div></div><div class="oskariui-menutoolbar-container"><div class="oskariui-menutoolbarbuttongroup"></div></div><div class="oskariui-menutoolbar-closebox"><div class="icon-close-white"></div></div></div>'},init:function(){var e=this;this.templateGroup=jQuery(this.templates.group),this.templateTool=jQuery(this.templates.tool),this.templateMenutoolbar=jQuery(this.templates.menutoolbar),this.requestHandlers={toolButtonRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.toolbar.request.ToolButtonRequestHandler",e),toolbarRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.toolbar.request.ToolbarRequestHandler",e),showMapMeasurementRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.toolbar.request.ShowMapMeasurementRequestHandler",e)}},createMenuToolbarContainer:function(e,t){var i=t||{},a=this.templateMenutoolbar.clone();this.menutoolbarcontainer.append(a),this.toolbars[e]=a;var n=a.find(".oskariui-menutoolbarbuttongroup");return this.containers[e]=n,i.title&&a.find(".oskariui-menutoolbar-title p").append(i.title),i.show&&a.removeClass("oskari-closed"),i.closeBoxCallback&&a.find(".oskariui-menutoolbar-closebox div").click(i.closeBoxCallback),n},changeMenuToolbarTitle:function(e){e&&this.menutoolbarcontainer.find(".oskariui-menutoolbar-title p").html(e)},getToolbarContainer:function(e,t){var i=e||"default",a=this.containers[i];return void 0===a&&this.menutoolbarcontainer&&(a=this.createMenuToolbarContainer(i,t)),a},onEvent:function(e){var t=this,i=t.eventHandlers[e.getName()];return i?i.apply(this,[e]):void 0},measureTools:{basictools:{measureline:!0,measurearea:!0}},eventHandlers:{"Toolbar.ToolSelectedEvent":function(e){var t=this,i=this.getSandbox();if(t.measureTools[e.getGroupId()]&&t.measureTools[e.getGroupId()][e.getToolId()]){var a=t.getLocalization("measure").guidance[e.getToolId()];i.request(t,i.getRequestBuilder("ShowMapMeasurementRequest")(a?a:"",!1,null,null))}}},stop:function(){var e=this,t=e.sandbox();for(var i in e.eventHandlers)i&&t.unregisterFromEventByName(e,i);t.removeRequestHandler("ShowMapMeasurementRequest",this.requestHandlers.showMapMeasurementRequestHandler),t.removeRequestHandler("Toolbar.ToolbarRequest",this.requestHandlers.toolbarRequestHandler),t.removeRequestHandler("Toolbar.AddToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),t.removeRequestHandler("Toolbar.RemoveToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),t.removeRequestHandler("Toolbar.ToolButtonStateRequest",this.requestHandlers.toolButtonRequestHandler),t.removeRequestHandler("Toolbar.SelectToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),this.sandbox.unregisterStateful(this.mediator.bundleId),e.sandbox.unregister(e),e.started=!1},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},setState:function(e){if(e)if(e.selected){this.selectedButton=e.selected;var t=e.selected.id,i=e.selected.group,a=this.getToolbarContainer();this._removeToolSelections();var n=a.find("div.toolrow[tbgroup="+i+"]");if(n.length>0){var s=n.find("div.tool[tool="+t+"]");s.length>0&&(s.addClass("selected"),this.buttons[i][t].callback())}}else this.selectedButton=null},getState:function(){var e={};return this.selectedButton&&(e.selected=this.selectedButton),e},_removeToolbar:function(e){var t=this.toolbars[e];this.toolbars[e]=void 0,t.remove(),delete t},_showToolbar:function(e){this.toolbars[e].show()},_hideToolbar:function(e){this.toolbars[e].hide()},_addToolbar:function(e,t){this.getToolbarContainer(e,t)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.category("Oskari.mapframework.bundle.toolbar.ToolbarBundleInstance","button-methods",{addToolButton:function(e,t,i){if(e&&t&&i&&i.callback){var a=this,n=this.getToolbarContainer(i?i.toolbarid:null,i),s=null;if(this.buttons[t]?s=n.find("div.toolrow[tbgroup="+t+"]"):(this.buttons[t]={},s=this.templateGroup.clone(),s.attr("tbgroup",t),n.append(s),this.groupsToToolbars[t]=i?i.toolbarid:null),!this.buttons[t][e]){this.buttons[t][e]=i;var r=this.templateTool.clone();r.attr("tool",e),r.attr("title",i.tooltip),r.addClass(i.iconCls),this.selectedButton?this.selectedButton.id==e&&this.selectedButton.group==t&&(r.addClass("selected"),i.callback()):i.selected&&(r.addClass("selected"),this.selectedButton={id:e,group:t}),i.selected&&(this.defaultButton={id:e,group:t}),r.bind("click",function(){a._clickButton(e,t)}),i.prepend?s.prepend(r):s.append(r),i.disabled===!0&&r.addClass("disabled")}}},_clickButton:function(e,t){e||(e=this.defaultButton.id,t=this.defaultButton.group);var i=this.buttons[t][e];if(0!=i.enabled){if(1==i.sticky){var a=this.sandbox.getEventBuilder("Toolbar.ToolSelectedEvent")(e,t);this.sandbox.notifyAll(a),this._removeToolSelections(t);var n=this.getToolbarContainer(this.groupsToToolbars[t]),s=n.find("div.toolrow[tbgroup="+t+"]"),r=s.find("div.tool[tool="+e+"]");r.addClass("selected"),this.selectedButton={id:e,group:t}}if(i.toggleSelection){var n=this.getToolbarContainer(this.groupsToToolbars[t]),s=n.find("div.toolrow[tbgroup="+t+"]"),r=s.find("div.tool[tool="+e+"]");r.hasClass("selected")?r.removeClass("selected"):r.addClass("selected")}i.callback()}},_removeToolSelections:function(e){var t=this.getToolbarContainer(this.groupsToToolbars[e]),i=t.find("div.tool");i.removeClass("selected")},removeToolButton:function(e,t){if(t&&this.buttons[t]){var i=this.getToolbarContainer(this.groupsToToolbars[t]),a=i.find("div.toolrow[tbgroup="+t+"]");if(e){var n=a.find("div.tool[tool="+e+"]");n.remove(),this.buttons[t][e]=null,delete this.buttons[t][e]}else a.remove(),this.buttons[t]=null,delete this.buttons[t]}},changeToolButtonState:function(e,t,i){if(t&&this.buttons[t]){var a=this.getToolbarContainer(this.groupsToToolbars[t]),n=a.find("div.toolrow[tbgroup="+t+"]");if(e){var s=n.find("div.tool[tool="+e+"]");this.buttons[t][e].enabled=i,i?s.removeClass("disabled"):s.addClass("disabled")}else{var r=n.find("div.tool");i?r.removeClass("disabled"):r.addClass("disabled");for(var o in this.buttons[t])this.buttons[t][o].enabled=i}}}}),Oskari.clazz.category("Oskari.mapframework.bundle.toolbar.ToolbarBundleInstance","default-buttons",{_isButtonConfigured:function(e,t){return this.conf&&(this.conf[t]===!1||this.conf[t]&&this.conf[t][e]===!1)?!1:!0},_addDefaultButtons:function(){var e=this,t=this.getLocalization("buttons"),i=this.getSandbox().getRequestBuilder("ToolSelectionRequest"),a="MapModulePlugin.GetFeatureInfoActivationRequest",n=this.getSandbox().getRequestBuilder(a);this._isButtonConfigured("reset","history")&&this.addToolButton("reset","history",{iconCls:"tool-reset",tooltip:t.history.reset,sticky:!1,callback:function(){var t=e.getSandbox().getRequestBuilder("StateHandler.SetStateRequest");t&&e.getSandbox().request(e,t());var i=e.getSandbox().getRequestBuilder("ClearHistoryRequest")();e.getSandbox().request(e,i)}}),this._isButtonConfigured("history_back","history")&&this.addToolButton("history_back","history",{iconCls:"tool-history-back",tooltip:t.history.back,sticky:!1,callback:function(){e.getSandbox().request(e,i("map_control_tool_prev"))}}),this._isButtonConfigured("history_forward","history")&&this.addToolButton("history_forward","history",{iconCls:"tool-history-forward",tooltip:t.history.next,sticky:!1,callback:function(){e.getSandbox().request(e,i("map_control_tool_next"))}}),this._isButtonConfigured("zoombox","basictools")&&this.addToolButton("zoombox","basictools",{iconCls:"tool-zoombox",tooltip:t.zoom,sticky:!0,callback:function(){var t="map_control_zoom_tool";e.getSandbox().request(e,n(!1)),e.getSandbox().request(e,i(t))}}),this._isButtonConfigured("select","basictools")&&this.addToolButton("select","basictools",{iconCls:"tool-pan",tooltip:t.pan,selected:!0,sticky:!0,callback:function(){var t="map_control_navigate_tool";e.getSandbox().request(e,n(!0)),e.getSandbox().request(e,i(t))}}),this._isButtonConfigured("measureline","basictools")&&this.addToolButton("measureline","basictools",{iconCls:"tool-measure-line",tooltip:t.measure.line,sticky:!0,callback:function(){var t="map_control_measure_tool";e.getSandbox().request(e,n(!1)),e.getSandbox().request(e,i(t))}}),this._isButtonConfigured("measurearea","basictools")&&this.addToolButton("measurearea","basictools",{iconCls:"tool-measure-area",tooltip:t.measure.area,sticky:!0,callback:function(){var t="map_control_measure_area_tool";e.getSandbox().request(e,n(!1)),e.getSandbox().request(e,i(t))}}),this._isButtonConfigured("link","viewtools")&&this.addToolButton("link","viewtools",{iconCls:"tool-link",tooltip:t.link.tooltip,sticky:!1,callback:function(){var i=e.getSandbox().generateMapLinkParameters({showMarker:!0}),a="Oskari.userinterface.component.Popup",n="Oskari.userinterface.component.Button",s=Oskari.clazz.create(a);s.addClass("no_resize");var r=Oskari.clazz.create(n);r.setTitle(t.link.ok),r.addClass("primary"),r.setHandler(function(){var t="EnableMapKeyboardMovementRequest";s.close(),e.getSandbox().postRequestByName(t)});var o='<textarea rows="3" cols="80">'+t.link.prefixUrl+i+"</textarea>",l="DisableMapKeyboardMovementRequest";e.getSandbox().postRequestByName(l),s.show(t.link.title,o,[r])}}),this._isButtonConfigured("print","viewtools")&&this.addToolButton("print","viewtools",{iconCls:"tool-print",tooltip:t.print.tooltip,sticky:!1,callback:function(){var t="location=1,status=1,scrollbars=1,width=850,height=1200",i=window.location.pathname+"?"+e.getSandbox().generateMapLinkParameters()+"&p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=0&p_p_state=exclusive"+"&showMarker=false&forceCache=true&mapmode=print&viewId=2";window.open(i,"Print",t)}})}}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.AddToolButtonRequest",function(e,t,i){this._id=e,this._group=t,this._config=i},{__name:"Toolbar.AddToolButtonRequest",getName:function(){return this.__name},getId:function(){return this._id},getGroup:function(){return this._group},getConfig:function(){return this._config}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.RemoveToolButtonRequest",function(e,t){this._id=e,this._group=t},{__name:"Toolbar.RemoveToolButtonRequest",getName:function(){return this.__name},getId:function(){return this._id},getGroup:function(){return this._group}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ToolButtonStateRequest",function(e,t,i){this._id=e,this._group=t,this._state=1==i},{__name:"Toolbar.ToolButtonStateRequest",getName:function(){return this.__name},getId:function(){return this._id},getGroup:function(){return this._group},getState:function(){return this._state}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.SelectToolButtonRequest",function(e,t){this._id=e,this._group=t},{__name:"Toolbar.SelectToolButtonRequest",getName:function(){return this.__name},getId:function(){return this._id},getGroup:function(){return this._group}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ToolButtonRequestHandler",function(e){this._toolbar=e},{handleRequest:function(e,t){var i=e.getSandbox();"Toolbar.AddToolButtonRequest"==t.getName()?this._handleAdd(i,t):"Toolbar.RemoveToolButtonRequest"==t.getName()?this._handleRemove(i,t):"Toolbar.ToolButtonStateRequest"==t.getName()?this._handleState(i,t):"Toolbar.SelectToolButtonRequest"==t.getName()&&this._handleClick(i,t)},_handleAdd:function(e,t){this._toolbar.addToolButton(t.getId(),t.getGroup(),t.getConfig())},_handleRemove:function(e,t){this._toolbar.removeToolButton(t.getId(),t.getGroup())},_handleState:function(e,t){this._toolbar.changeToolButtonState(t.getId(),t.getGroup(),t.getState())},_handleClick:function(e,t){this._toolbar._clickButton(t.getId(),t.getGroup())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ShowMapMeasurementRequestHandler",function(e){var t=this;t._toolbar=e;var i=this._toolbar.getLocalization("measure"),a=i.title;t._title=a,t._dialog=Oskari.clazz.create("Oskari.userinterface.component.Popup"),t._dialog.addClass("oskari-measurement");var n=[],s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(i.close),n.push(s),t._buttons=n,t._dialogShown=!1,t._content=null},{handleRequest:function(e,t){e.getSandbox(),this._showMeasurementResults(t.getValue())},getValue:function(){return this._value},_showMeasurementResults:function(e){var t=this,i=t._dialog;if(!t._dialogShown){i.show(t._title,"",t._buttons);var a=t._buttons[0];a.setHandler(function(){t._dialogShown=!1;var e=t._toolbar.getSandbox().getRequestBuilder("Toolbar.SelectToolButtonRequest")();t._toolbar.getSandbox().request(t._toolbar,e),t._dialog.close(!0)}),i.moveTo("#toolbar div.toolrow[tbgroup=basictools]","top"),t._content=jQuery("<div></div>"),i.setContent(t._content),t._dialogShown=!0}t._content.html(e)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.event.ToolSelectedEvent",function(e,t){this._toolId=e,this._groupId=t},{__name:"Toolbar.ToolSelectedEvent",getName:function(){return this.__name},getToolId:function(){return this._toolId},getGroupId:function(){return this._groupId}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ToolbarRequest",function(e,t,i){this._id=e,this._op=t,this._data=i},{__name:"Toolbar.ToolbarRequest",getName:function(){return this.__name},getId:function(){return this._id},getOp:function(){return this._op},getData:function(){return this._data}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ToolbarRequestHandler",function(e){this._toolbar=e},{handleRequest:function(e,t){e.getSandbox(),"add"==t.getOp()?this._toolbar._addToolbar(t.getId(),t.getData()):"show"==t.getOp()?this._toolbar._showToolbar(t.getId()):"hide"==t.getOp()?this._toolbar._hideToolbar(t.getId()):"remove"==t.getOp()?this._toolbar._removeToolbar(t.getId()):"changeName"==t.getOp()&&this._toolbar.changeMenuToolbarTitle(t.getData())},_handleAdd:function(e,t){this._toolbar.addToolButton(t.getId(),t.getGroup(),t.getConfig())
},_handleRemove:function(e,t){this._toolbar.removeToolButton(t.getId(),t.getGroup())},_handleState:function(e,t){this._toolbar.changeToolButtonState(t.getId(),t.getGroup(),t.getState())},_handleClick:function(e,t){this._toolbar._clickButton(t.getId(),t.getGroup())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.StateHandlerBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.StateHandlerBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/state-methods.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/plugin/Plugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/plugin/SaveViewPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/request/SetStateRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/request/SetStateRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/event/StateSavedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/request/SaveStateRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/request/SaveStateRequestHandler.js"}]},bundle:{manifest:{"Bundle-Identifier":"statehandler","Bundle-Name":"statehandler","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"statehandler",Title:"statehandler"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("statehandler","Oskari.mapframework.bundle.statehandler.StateHandlerBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.StateHandlerBundleInstance",function(){this._localization=null,this._pluginInstances={},this._startupState=null,this._historyPollingInterval=1500,this._historyTimer=null,this._historyPrevious=[],this._historyNext=[],this._historyEnabled=!0,this._defaultViewId=1,this._currentViewId="undefined"!=typeof window.viewId?window.viewId:this._defaultViewId},{__name:"StateHandler",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p);var n=a.getAjaxUrl(),s=Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.plugin.SaveViewPlugin",n);this.registerPlugin(s),this.startPlugin(s),a.addRequestHandler("StateHandler.SetStateRequest",this.requestHandlers.setStateHandler),a.addRequestHandler("StateHandler.SaveStateRequest",this.requestHandlers.saveStateHandler)}},update:function(){},stop:function(){var e=this.sandbox();e.removeRequestHandler("StateHandler.SetStateRequest",this.requestHandlers.setStateHandler),e.removeRequestHandler("StateHandler.SaveStateRequest",this.requestHandlers.saveStateHandler);var t=e.getRequestBuilder("MapControls.ToolButtonRequest");t&&e.request(this,t(this.toolbar.config,"remove"));for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);this.sandbox.unregister(this),this.started=!1},init:function(){var e=this.sandbox;return this.requestHandlers={setStateHandler:Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.request.SetStateRequestHandler",e,this),saveStateHandler:Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.request.SaveStateRequestHandler",e,this)},null},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapMoveEvent:function(){var e=this;e._pushState()},AfterMapLayerAddEvent:function(){var e=this;e._pushState()},AfterMapLayerRemoveEvent:function(){var e=this;e._pushState()},AfterChangeMapLayerStyleEvent:function(){var e=this;e._pushState()},MapLayerVisibilityChangedEvent:function(){var e=this;e._pushState()}},registerPlugin:function(e){e.setHandler(this);var t=e.getName();this.sandbox.printDebug("["+this.getName()+"]"+" Registering "+t),this._pluginInstances[t]=e},unregisterPlugin:function(e){var t=e.getName();this.sandbox.printDebug("["+this.getName()+"]"+" Unregistering "+t),this._pluginInstances[t]=void 0,e.setHandler(null)},startPlugin:function(e){var t=e.getName();this.sandbox.printDebug("["+this.getName()+"]"+" Starting "+t),e.startPlugin(this.sandbox)},stopPlugin:function(e){var t=e.getName();this.sandbox.printDebug("["+this.getName()+"]"+" Starting "+t),e.stopPlugin(this.sandbox)},setCurrentViewId:function(e){this._currentViewId=e},getCurrentViewId:function(){return this._currentViewId},_stateComparators:[{rule:"nohistory",cmp:function(e){return e?void 0:!0}},{rule:"location",cmp:function(e,t){return e.east!=t.east||e.north!=t.north?!0:e.zoom!=t.zoom?!0:void 0}},{rule:"layers",cmp:function(e,t){var i=this,a=e.selectedLayers,n=t.selectedLayers;if(a.length!=n.length)return!0;for(var s=0;s<n.length;s++){var r=a[s],o=n[s];if(i.sandbox.printDebug("[StateHandler] comparing layer state "+r.id+" vs "+o.id),r.id!==o.id)return!0;if(r.opacity!==o.opacity)return!0;if(r.hidden!==o.hidden)return!0;if(r.style!==o.style)return!0}return!1}}],_compareState:function(e,t,i){for(var a={result:!1,rule:null,rulesMatched:{}},n=this,s=0;s<n._stateComparators.length;s++){var r=n._stateComparators[s];if(n.sandbox.printDebug("[StateHandler] comparing state "+r.rule),r.cmp.apply(this,[e,t])&&(n.sandbox.printDebug("[StateHandler] comparing state MATCH "+r.rule),a.result=!0,a.rule=r.rule,a.rulesMatched[r.rule]=r.rule,i))return a}return a},_logState:function(){var e=this,t=e.conf.logUrl+"?"+e.sandbox.generateMapLinkParameters();jQuery.ajax({type:"GET",url:t})},_pushState:function(){var e=this;if(e._historyEnabled){var t=e._historyPrevious,i=this._getMapState(),a=0==t.length?null:t[t.length-1],n=e._compareState(a,i,!0);n.result&&(e.sandbox.printDebug("[StateHandler] PUSHING state"),i.rule=n.rule,e._historyPrevious.push(i),e._historyNext=[],e.conf&&e.conf.logUrl&&e._logState())}},historyMoveNext:function(){var e=this.getSandbox();if(this._historyNext.length>0){var t=this._historyNext.pop();this._historyPrevious.push(t);var i=e.findRegisteredModuleInstance("MainMapModule");this._historyEnabled=!1;var a=this._getMapState();this._setMapState(i,t,a),this._historyEnabled=!0}},historyMovePrevious:function(){var e=this.getSandbox();switch(this._historyPrevious.length){case 0:break;case 1:var t=this._historyNext;this.resetState(),this._historyNext=t;break;default:var i=this._historyPrevious.pop();this._historyNext.push(i);var a=this._historyPrevious[this._historyPrevious.length-1],n=e.findRegisteredModuleInstance("MainMapModule"),s=this._getMapState();this._historyEnabled=!1,this._setMapState(n,a,s),this._historyEnabled=!0}},_getMapState:function(){var e=this.getSandbox(),t=e.getMap(),i=e.findAllSelectedMapLayers();t.getZoom();for(var a=t.getX(),n=t.getY(),s={north:n,east:a,zoom:t.getZoom(),selectedLayers:[]},r=0;r<i.length;r++){var o=i[r],l={id:o.getId(),opacity:o.getOpacity()};o.isVisible()||(l.hidden=!0),o.getCurrentStyle&&o.getCurrentStyle()&&o.getCurrentStyle().getName()&&"!default!"!=o.getCurrentStyle().getName()&&(l.style=o.getCurrentStyle().getName()),s.selectedLayers.push(l)}return s},_setMapState:function(e,t,i){var a=this.getSandbox(),n=this._compareState(i,t,!1);if(t.selectedLayers&&n.rulesMatched.layers){a.printDebug("[StateHandler] restoring LAYER state"),this._teardownState(e);for(var s=a.getRequestBuilder("AddMapLayerRequest"),r=a.getRequestBuilder("ChangeMapLayerOpacityRequest"),o=a.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest"),l=a.getRequestBuilder("ChangeMapLayerStyleRequest"),u=t.selectedLayers.length,c=0;u>c;++c){var h=t.selectedLayers[c];a.request(e.getName(),s(h.id,!0)),h.hidden?a.request(e.getName(),o(h.id,!1)):a.request(e.getName(),o(h.id,!0)),h.style&&a.request(e.getName(),l(h.id,h.style)),h.opacity&&a.request(e.getName(),r(h.id,h.opacity))}}t.east&&(a.printDebug("[StateHandler] restoring LOCATION state"),this.getSandbox().getMap().moveTo(t.east,t.north,t.zoom)),a.syncMapState(!0)},_teardownState:function(e){for(var t=this.getSandbox(),i=t.findAllSelectedMapLayers(),a=t.getRequestBuilder("RemoveMapLayerRequest"),n=0;n<i.length;n++)t.request(e.getName(),a(i[n].getId()))}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.category("Oskari.mapframework.bundle.statehandler.StateHandlerBundleInstance","state-methods",{useState:function(e){if(!e)return[];var t=this.sandbox.getStatefulComponents(),i=[];for(var a in e)t[a]&&t[a].setState&&t[a].setState(e[a].state),i.push(a);return i},resetState:function(){var e=this;e._historyEnabled=!1,e._historyPrevious=[],e._historyNext=[];for(var t in this._pluginInstances)e.sandbox.printDebug("["+e.getName()+"]"+" resetting state on "+t),e._pluginInstances[t].resetState();e._currentViewId=this._defaultViewId,e._startupState?e._resetComponentsWithNoStateData(e.useState(this._startupState)):jQuery.ajax({dataType:"json",type:"GET",url:e.sandbox.getAjaxUrl()+"action_route=GetAppSetup&noSavedState=true",success:function(t){t&&t.configuration?(e._startupState=t.configuration,e._resetComponentsWithNoStateData(e.useState(t.configuration)),e._historyEnabled=!0):alert("error in getting configuration")},error:function(){alert("error loading conf"),e._historyEnabled=!0},complete:function(){e._historyEnabled=!0}}),e._historyEnabled=!0},_resetComponentsWithNoStateData:function(e){var t=this.sandbox.getStatefulComponents();for(var i in t){for(var a=!1,n=0;n<e.length;++n)if(i==e[n]){a=!0;break}a||t[i].setState()}},saveState:function(e,t){if(t)this.sandbox.printDebug("["+this.getName()+"]"+" saving state with "+t),this._pluginInstances[t].saveState(e);else for(var t in this._pluginInstances)this.saveState(e,t)},getCurrentState:function(){var e={},t=this.sandbox.getStatefulComponents();for(var i in t)t[i].getState?e[i]={state:t[i].getState()}:this.sandbox.printWarn("Stateful component "+i+" doesnt have getState()");return e},getSavedState:function(e){return this._pluginInstances[e].getState()}}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.plugin.Plugin",function(){throw"Oskari.mapframework.bundle.statehandler.Plugin should not be instantiated"},{getName:function(){throw"Implement your own"},setHandler:function(){throw"Implement your own"},startPlugin:function(){throw"Implement your own"},stopPlugin:function(){throw"Implement your own"},getState:function(){throw"Implement your own"},resetState:function(){throw"Implement your own"},saveState:function(){throw"Implement your own"}}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.plugin.SaveViewPlugin",function(e){this.handler=null,this.pluginName=null,this._sandbox=null,this._ajaxUrl=e},{__name:"statehandler.SaveViewPlugin",getName:function(){return this.pluginName},getHandler:function(){return this.handler},setHandler:function(e){this.handler=e,this.pluginName=e.getName()+this.__name},getState:function(){},resetState:function(){},saveState:function(e,t){var i=t,a=this;i||(i=this.handler.getCurrentState());var n={currentViewId:a.handler.getCurrentViewId(),viewData:i};e&&(n.viewName=e.name,n.viewDescription=e.description);var s=a._sandbox.getEventBuilder("StateSavedEvent"),r=s(n.viewName,i);jQuery.cookie.json=!0;var o=7;jQuery.cookie("oskaristate",n,{expires:o}),n.viewData=JSON.stringify(n.viewData),jQuery.ajax({type:"POST",url:this._ajaxUrl+"action_route=AddView",data:n,success:function(e){a._sandbox.notifyAll(r),a.handler.setCurrentViewId(e.id)},error:function(){n.viewName&&(r.setError(!0),a._sandbox.notifyAll(r))}})},serializeJSON:function(e){var t=this,i=typeof e;if("object"!=i||null===e)return"string"==i&&(e='"'+e+'"'),String(e);var a=[],n=e&&e.constructor==Array;return jQuery.each(e,function(e,s){i=typeof s,"string"==i?s='"'+s+'"':"object"==i&null!==s&&(s=t.serializeJSON(s)),a.push((n?"":'"'+e+'":')+String(s))}),(n?"[":"{")+String(a)+(n?"]":"}")},startPlugin:function(e){this._sandbox=e;var t=this;jQuery(document).ready(function(){window.onbeforeunload=function(){t.saveState()}})},stopPlugin:function(){this._sandbox=null}},{protocol:["Oskari.mapframework.bundle.statehandler.plugin.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.request.SetStateRequest",function(e){this._creator=null,this._state=e,this._currentViewId=1},{__name:"StateHandler.SetStateRequest",getName:function(){return this.__name},getState:function(){return this._state},getCurrentViewId:function(){return this._currentViewId},setCurrentViewId:function(e){this.currentViewId=e}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.request.SetStateRequestHandler",function(e,t){this.sandbox=e,this.statehandler=t},{handleRequest:function(e,t){t.getState()?(this.statehandler.setCurrentViewId(t.getCurrentViewId()),this.statehandler.useState(t.getState())):this.statehandler.resetState()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.event.StateSavedEvent",function(e,t){this._name=e,this._state=t,this._error=!1},{__name:"StateSavedEvent",getName:function(){return this.__name},getViewName:function(){return this._name},getState:function(){return this._state},isError:function(){return this._error},setError:function(e){this._error=1==e}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.request.SaveStateRequest",function(e,t){this._viewName=e,this._viewDescription=t},{__name:"StateHandler.SaveStateRequest",getName:function(){return this.__name},getViewName:function(){return this._viewName},getViewDescription:function(){return this._viewDescription}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.request.SaveStateRequestHandler",function(e,t){this.sandbox=e,this.statehandler=t},{handleRequest:function(e,t){this.statehandler.saveState({name:t.getViewName(),description:t.getViewDescription()})}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.InfoBoxBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.infobox.InfoBoxBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/plugin/openlayerspopup/OpenlayersPopupPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/request/ShowInfoBoxRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/request/ShowInfoBoxRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/request/HideInfoBoxRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/request/HideInfoBoxRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/infobox/css/infobox.css"}]},bundle:{manifest:{"Bundle-Identifier":"infobox","Bundle-Name":"infobox","Bundle-Author":[{Name:"ev",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("infobox","Oskari.mapframework.bundle.infobox.InfoBoxBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.InfoBoxBundleInstance",function(){this.sandbox=null,this.started=!1,this.mediator=null},{__name:"Infobox",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},update:function(){},start:function(){var e=this;if(!e.started){e.started=!0;var t=Oskari.$("sandbox");t.register(e),e.setSandbox(t);for(var i in e.eventHandlers)i&&t.registerForEventByName(e,i);var a=t.findRegisteredModuleInstance("MainMapModule");a.registerPlugin(this.popupPlugin),a.startPlugin(this.popupPlugin),t.addRequestHandler("InfoBox.ShowInfoBoxRequest",this.requestHandlers.showInfoHandler),t.addRequestHandler("InfoBox.HideInfoBoxRequest",this.requestHandlers.hideInfoHandler)}},init:function(){var e=this.conf&&this.conf.adaptable===!0;return this.popupPlugin=Oskari.clazz.create("Oskari.mapframework.bundle.infobox.plugin.mapmodule.OpenlayersPopupPlugin"),this.popupPlugin.setAdaptable(e),this.requestHandlers={showInfoHandler:Oskari.clazz.create("Oskari.mapframework.bundle.infobox.request.ShowInfoBoxRequestHandler",this.popupPlugin),hideInfoHandler:Oskari.clazz.create("Oskari.mapframework.bundle.infobox.request.HideInfoBoxRequestHandler",this.popupPlugin)},null},onEvent:function(e){var t=this,i=t.eventHandlers[e.getName()];return i?i.apply(this,[e]):void 0},eventHandlers:{},stop:function(){var e=this,t=this.sandbox;for(var i in e.eventHandlers)i&&t.unregisterFromEventByName(e,i);e.sandbox.unregister(e),e.started=!1},setState:function(e){if(e&&e.popups){this.popupPlugin.close();for(var t=0;t<e.popups.length;++t){var i=e.popups[t];this.popupPlugin.popup(i.id,i.title,i.data,i.lonlat)}}},getState:function(){var e={popups:[]},t=this.popupPlugin.getPopups();for(var i in t){var a=t[i],n={id:i,title:a.title,data:a.contentData,lonlat:a.lonlat};e.popups.push(n)}return e}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),jQuery.fn.outerHTML=function(e){var t;return this.length?e?(jQuery.each(this,function(t,i){var a,n=i,s=i.outerHTML?"outerHTML":"innerHTML";i.outerHTML||(i=jQuery(i).wrap("<div>").parent()[0]),jQuery.isFunction(e)?(a=e.call(n,t,i[s]))!==!1&&(i[s]=a):i[s]=e,i.outerHTML||jQuery(i).children().unwrap()}),this):this[0].outerHTML||(t=this.wrap("<div>").parent().html(),this.unwrap(),t):"undefined"==typeof val?this:null},Oskari.clazz.define("Oskari.mapframework.bundle.infobox.plugin.mapmodule.OpenlayersPopupPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._popups={}},{__name:"OpenLayersPopupPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+this.__name},init:function(){this._arrow=jQuery('<div class="popupHeaderArrow"></div>'),this._header=jQuery("<div></div>"),this._headerWrapper=jQuery('<div class="popupHeader"></div>'),this._headerCloseButton=jQuery('<div class="olPopupCloseBox icon-close-white" style="position: absolute; top: 12px;"></div>'),this._contentDiv=jQuery('<div class="popupContent"></div>'),this._contentWrapper=jQuery('<div class="contentWrapper"></div>'),this._actionLink=jQuery('<span class="infoboxActionLinks"><a href="#"></a></span>'),this._actionButton=jQuery('<span class="infoboxActionLinks"><input type="button" /></span>'),this._contentSeparator=jQuery('<div class="infoboxLine">separator</div>')},popup:function(e,t,i,a){var n=this,s=this._arrow.clone(),r=this._header.clone(),o=this._headerWrapper.clone(),l=this._contentDiv.clone(),u=this._headerCloseButton.clone();r.append(t),o.append(r),o.append(u);for(var c=0;c<i.length;c++){0!=c&&l.append(this._contentSeparator.clone());var h=i[c].html,d=this._contentWrapper.clone();d.append(h);var p=i[c].actions,f=1==i[c].useButtons,m=i[c].primaryButton;for(var g in p){var y=g;p[g];var v=null;if(f){v=this._actionButton.clone();var b=v.find("input");b.attr("contentdata",c),b.attr("value",y),y==m&&b.addClass("primary")}else{v=this._actionLink.clone();var _=v.find("a");_.attr("contentdata",c),_.append(y)}d.append(v)}l.append(d)}var k=this.getMapModule().getMap(),L=new OpenLayers.Popup(e,new OpenLayers.LonLat(a.lon,a.lat),new OpenLayers.Size(400,300),s.outerHTML()+o.outerHTML()+l.outerHTML(),!1);L.moveTo=function(e){if(null!=e&&null!=this.div){this.div.style.left=e.x+"px";var t=e.y-20;this.div.style.top=t+"px"}},L.setBackgroundColor("transparent"),this._popups[e]={title:t,contentData:i,lonlat:a,popup:L},jQuery(L.div).css("overflow","visible"),jQuery(L.groupDiv).css("overflow","visible"),L.events.un({click:L.onclick,scope:L}),L.events.on({click:function(t){var a=jQuery(t.target||t.srcElement);if(a.hasClass("olPopupCloseBox"))n.close(e);else{var s=a.attr("contentdata"),r=a.attr("value");r||(r=a.html()),i[s]&&i[s].actions&&i[s].actions[r]&&i[s].actions[r]()}},scope:L}),k.addPopup(L),this.adaptable&&jQuery(this._adaptPopupSize($)),this._panMapToShowPopup(a)},setAdaptable:function(e){this.adaptable=e},_adaptPopupSize:function(e){var t=e(".olMapViewport"),i=e(".olPopup"),a=parseFloat(i.css("left"))+10;i.find(".popupHeaderArrow").css({"margin-left":"-10px"}),i.find(".popupHeader").css("width","100%");var n=i.find(".popupContent").css({"margin-left":"0",padding:"5px 20px 5px 20px"});i.find(".olPopupContent").css({width:"100%",height:"100%"});var s=.7*t.width(),r=.7*t.height(),o=n.find(".contentWrapper");if(jQuery.browser.msie)o.css({"padding-bottom":"5px"});else{var l=o.height();l=l>r?r+30+"px":"auto",n.css({height:l})}i.css({height:"auto",width:"auto","min-width":"256px","max-width":s+"px","min-height":"200px","max-height":r+"px",left:a+"px","z-index":"16000"})},_panMapToShowPopup:function(e){var t=this._map.getViewPortPxFromLonLat(e),i=this._map.getCurrentSize(),a=i.w,n=i.h,s=0,r=0,o=jQuery(".olPopup"),l=o.width()+50,u=o.height()+90;t.x+l>a&&(s=a-(t.x+l)),t.y+u>n?r=n-(t.y+u):t.y<25&&(r=25),(0!=s||0!=r)&&this.getMapModule().panMapByPixels(-s,-r)},close:function(e){if(e)this._popups[e]&&(this._popups[e].popup&&this._popups[e].popup.destroy(),delete this._popups[e]);else for(var t in this._popups)this._popups[t].popup.destroy(),delete this._popups[t]},getPopups:function(){return this._popups},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this)},stopPlugin:function(e){e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.request.ShowInfoBoxRequest",function(e,t,i,a,n){this._creator=null,this._id=e,this._title=t,this._content=i,this._position=a,this._hidePrevious=1==n},{__name:"InfoBox.ShowInfoBoxRequest",getName:function(){return this.__name},getId:function(){return this._id},getTitle:function(){return this._title},getContent:function(){return this._content},getPosition:function(){return this._position},getHidePrevious:function(){return this._hidePrevious}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.request.ShowInfoBoxRequestHandler",function(e){this.popupPlugin=e},{handleRequest:function(e,t){t.getHidePrevious()&&this.popupPlugin.close(),this.popupPlugin.popup(t.getId(),t.getTitle(),t.getContent(),t.getPosition())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.request.HideInfoBoxRequest",function(e){this._creator=null,this._id=e},{__name:"InfoBox.HideInfoBoxRequest",getName:function(){return this.__name},getId:function(){return this._id}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.request.HideInfoBoxRequestHandler",function(e){this.popupPlugin=e},{handleRequest:function(e,t){this.popupPlugin.close(t.getId())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.search.SearchBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.search.SearchBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/service/searchservice.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/Tile.js"},{type:"text/css",src:"../../../../resources/framework/bundle/search/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"search","Bundle-Name":"search","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("search","Oskari.mapframework.bundle.search.SearchBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.search.SearchBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.service=null},{__name:"Search",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e&&this._localization[e]?this._localization[e]:this.localization?this._localization:{}},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,this.localization=Oskari.getLocalization(this.getName());var n=null;n=this.conf&&this.conf.url?this.conf.url:a.getAjaxUrl()+"action_route=GetSearchResult";var s="Oskari.mapframework.bundle.search.service.SearchService";this.service=Oskari.clazz.create(s,n),a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p);var r="userinterface.AddExtensionRequest",o=a.getRequestBuilder(r),l=o(this);a.request(this,l),a.registerAsStateful(this.mediator.bundleId,this),e.createUi()}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t="userinterface.RemoveExtensionRequest",i=e.getRequestBuilder(t),a=i(this);e.request(this,a),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.search.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.search.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.search.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.templateResultTable=null,this.templateResultTableHeader=null,this.templateResultTableRow=null,this.resultHeaders=[],this.lastResult=null,this.lastSort=null,this._searchContainer=null},{getName:function(){return"Oskari.mapframework.bundle.search.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("search")||jQuery(this.container).addClass("search")},startPlugin:function(){this.template=jQuery('<div class="searchContainer"><div class="searchDescription"></div><div class="controls"></div><div><br></div><div class="info"></div><div><br></div><div class="resultList"></div></div>'),this.templateResultTable=jQuery('<table class="search_result"><thead><tr></tr></thead><tbody></tbody></table>'),this.templateResultTableHeader=jQuery('<th><a href="JavaScript:void(0);"></a></th>'),this.templateResultTableRow=jQuery('<tr><td><a href="JavaScript:void(0);"></a></td><td></td><td></td></tr>'),this.resultHeaders=[{title:this.instance.getLocalization("grid").name,prop:"name"},{title:this.instance.getLocalization("grid").village,prop:"village"},{title:this.instance.getLocalization("grid").type,prop:"type"}]},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},getState:function(){return this.state?this.state:{}},createUi:function(){var e=this,t=e.instance.getSandbox(),i=jQuery(this.container);i.empty();var a=this.template.clone();this._searchContainer=a;var n=a.find("div.searchDescription");n.html(this.instance.getLocalization("searchDescription"));var s=Oskari.clazz.create("Oskari.userinterface.component.FormInput"),r=/[\s\w\d\.\,\?\!\-äöåÄÖÅ]*\*?$/;s.setContentCheck(!0,this.instance.getLocalization("contentErrorMsg"),r),s.bindChange(function(){null===e.state&&(e.state={});var i=s.getValue();if(e.state.searchtext=i,!i){var n=a.find("div.info");n.empty();var r=a.find("div.resultList");r.empty();var o=t.getRequestBuilder("MapModulePlugin.RemoveMarkerRequest");o&&t.request(e.instance.getName(),o())}}),s.addClearButton();var o=Oskari.clazz.create("Oskari.userinterface.component.Button");o.setTitle(this.instance.getLocalization("searchButton"));var l=function(){s.setEnabled(!1),o.setEnabled(!1);var t=a.find("div.resultList");t.empty();var i=a.find("div.info");i.empty();var n=s.getValue(!0);e.instance.service.doSearch(n,function(t){s.setEnabled(!0),o.setEnabled(!0),e._renderResults(t,n)},function(){s.setEnabled(!0),o.setEnabled(!0);var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=t.createCloseButton("OK"),a=e.instance.getLocalization("searchservice_search_alert_title");t.show(a,a,[i])})};o.setHandler(l),s.bindEnterKey(l);var u=a.find("div.controls");u.append(s.getField()),u.append(o.getButton()),i.append(a)},_renderResults:function(e,t){if(e&&"number"==typeof e.totalCount){var i=this._searchContainer.find("div.resultList");i.empty(),this.lastResult=e;var a=this,n=this._searchContainer.find("div.info");n.empty();var s=this.instance;if(-1==e.totalCount)return i.append(this.instance.getLocalization("searchservice_search_alert_title")+this.instance.getLocalization(e.errorText)),void 0;if(0==e.totalCount){var r="searchservice_search_alert_title",o=s.getLocalization(r),l="searchservice_search_not_found_anything_text",u=s.getLocalization(l);
return i.append(o+":"+u),void 0}n.append(this.instance.getLocalization("searchResultCount")+e.totalCount+this.instance.getLocalization("searchResultCount2")),n.append("<br/>"),e.hasMore&&(n.append(this.instance.getLocalization("searchResultDescriptionMoreResults")),n.append("<br/>")),n.append(this.instance.getLocalization("searchResultDescriptionOrdering")),1==e.totalCount&&(a._resultClicked(e.locations[0]),s.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[a.instance,"close"]));for(var c=this.templateResultTable.clone(),h=c.find("thead tr"),d=c.find("tbody"),p=function(e){return function(){d.empty();var t=!1;a.lastSort&&a.lastSort.attr==e.prop&&(t=!a.lastSort.descending),a._sortResults(e.prop,t),a._populateResultTable(d);var i=h.find("a:contains("+e.title+")");return h.find("th").removeClass("asc"),h.find("th").removeClass("desc"),t?i.parent().addClass("desc"):i.parent().addClass("asc"),!1}},f=0;f<this.resultHeaders.length;++f){var m=this.templateResultTableHeader.clone(),g=m.find("a");g.append(this.resultHeaders[f].title),g.bind("click",p(this.resultHeaders[f])),h.append(m)}this._populateResultTable(d),i.append("<div><h3>"+this.instance.getLocalization("searchResults")+e.totalCount+this.instance.getLocalization("searchResultsDescription")+t+"</h3></div>"),i.append(c)}},_populateResultTable:function(e){for(var t=this,i=function(e){return function(){return t._resultClicked(e),!1}},a=this.lastResult.locations,n=0;n<a.length;++n){var s=a[n],r=this.templateResultTableRow.clone(),o=r.find("td"),l=jQuery(o[0]),u=l.find("a");u.append(s.name),u.bind("click",i(s)),jQuery(o[1]).append(s.village),jQuery(o[2]).append(s.type),e.append(r)}},_resultClicked:function(e){var t=this,i="searchResultPopup",a=this.instance,n=a.sandbox,s=n.getRequestBuilder("MapMoveRequest");n.request(t.instance.getName(),s(e.lon,e.lat,e.zoomLevel,!1));var r=this.instance.getLocalization("resultBox"),o={html:"<h3>"+e.name+"</h3>"+"<p>"+e.village+"<br/>"+e.type+"</p>",actions:{}},l=[o];o.actions[r.close]=function(){var e="InfoBox.HideInfoBoxRequest",a=n.getRequestBuilder(e),s=a(i);n.request(t.instance.getName(),s)};var u="InfoBox.ShowInfoBoxRequest",c=n.getRequestBuilder(u),h=c(i,r.title,l,new OpenLayers.LonLat(e.lon,e.lat),!0);n.request(this.instance.getName(),h)},_sortResults:function(e,t){var i=this;this.lastResult&&(this.lastSort={attr:e,descending:t},this.lastResult.locations.sort(function(a,n){return i._searchResultComparator(a,n,e,t)}))},_searchResultComparator:function(e,t,i,a){var n=e[i].toLowerCase(),s=t[i].toLowerCase(),r=0;return(n==s||"name"==i)&&(n=e.id,s=t.id),s>n?r=-1:n>s&&(r=1),a&&(r=-1*r),r}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.search.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.search.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){var e=this,t=e.instance,i=this.container;this.template,t.getSandbox(),i.children(".oskari-tile-status")}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/Tile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/model/LayerGroup.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/view/Layer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/view/LayersTab.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/view/PublishedLayersTab.js"},{type:"text/css",src:"../../../../resources/framework/bundle/layerselector2/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"layerselector2","Bundle-Name":"layerselector2","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("layerselector2","Oskari.mapframework.bundle.layerselector2.LayerSelectorBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null},{__name:"LayerSelector",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p);var n=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,n),e.createUi();var s=this.sandbox.getService("Oskari.mapframework.service.MapLayerService");a.registerAsStateful(this.mediator.bundleId,this);var r=function(){},o=function(){alert(e.getLocalization("errors").loadFailed)};s.loadAllLayersAjax(r,o)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!1)},AfterMapLayerAddEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!0)},MapLayerEvent:function(e){var t=this.sandbox.getService("Oskari.mapframework.service.MapLayerService"),i=e.getLayerId();if("update"===e.getOperation()){var a=t.findMapLayer(i);this.plugins["Oskari.userinterface.Flyout"].handleLayerModified(a)}else if("add"===e.getOperation()){var a=t.findMapLayer(i);this.plugins["Oskari.userinterface.Flyout"].handleLayerAdded(a),this.plugins["Oskari.userinterface.Tile"].refresh()}else if("remove"===e.getOperation())this.plugins["Oskari.userinterface.Flyout"].handleLayerRemoved(i),this.plugins["Oskari.userinterface.Tile"].refresh();else if("sticky"===e.getOperation()){var a=t.findMapLayer(i);this.plugins["Oskari.userinterface.Flyout"].handleLayerSticky(a),this.plugins["Oskari.userinterface.Tile"].refresh()}}},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setContentState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getContentState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.Flyout",function(e){this.instance=e,this.container=null,this.template=null,this.state=null,this.layerTabs=[]},{getName:function(){return"Oskari.mapframework.bundle.layerselector2.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("layerselector2")||jQuery(this.container).addClass("layerselector2")},startPlugin:function(){this.template=jQuery('<div class="allLayersTabContent"></div>');var e=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.LayersTab",this.instance,this.instance.getLocalization("filter").inspire);e.groupingMethod="getInspireName";var t=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.LayersTab",this.instance,this.instance.getLocalization("filter").organization);if(t.groupingMethod="getOrganizationName",this.layerTabs.push(e),this.layerTabs.push(t),this.instance.conf&&1==this.instance.conf.showPublishedTab){var i=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.PublishedLayersTab",this.instance,this.instance.getLocalization("filter").published);this.layerTabs.push(i)}},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},setContentState:function(e){e||(e={});for(var t=0;t<this.layerTabs.length;++t){var i=this.layerTabs[t];i.getTitle()==e.tab&&(this.tabContainer.select(i.getTabPanel()),i.setState(e))}},getContentState:function(){for(var e={},t=0;t<this.layerTabs.length;++t){var i=this.layerTabs[t];if(this.tabContainer.isSelected(i.getTabPanel())){e=i.getState();break}}return e},createUi:function(){var e=this;e.instance.getSandbox();var t=jQuery(this.container);t.empty(),this.tabContainer=Oskari.clazz.create("Oskari.userinterface.component.TabContainer"),this.tabContainer.insertTo(t);for(var i=0;i<this.layerTabs.length;++i){var a=this.layerTabs[i];this.tabContainer.addPanel(a.getTabPanel())}this.populateLayers()},populateLayers:function(){for(var e=this.instance.getSandbox(),t=e.getService("Oskari.mapframework.service.MapLayerService"),i=t.getAllLayers(),a=0;a<this.layerTabs.length;++a){var n=this.layerTabs[a];if(n.groupingMethod){var s=i.slice(0),r=this._getLayerGroups(s,n.groupingMethod);n.showLayerGroups(r)}}},_getLayerGroups:function(e,t){var i=this;this.instance.getSandbox();var a=[];e.sort(function(e,a){return i._layerListComparator(e,a,t)});for(var n=null,s=0;s<e.length;++s){var r=e[s];if(!r.getMetaType||"published"!=r.getMetaType()){var o=r[t]();n&&n.getTitle()==o||(n=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",o),a.push(n)),n.addLayer(r)}}return a},_layerListComparator:function(e,t,i){var a=e[i]().toLowerCase(),n=t[i]().toLowerCase();return a==n&&e.getName()&&t.getName()&&(a=e.getName().toLowerCase(),n=t.getName().toLowerCase()),n>a?-1:a>n?1:0},handleLayerSelectionChanged:function(e,t){for(var i=0;i<this.layerTabs.length;++i){var a=this.layerTabs[i];a.setLayerSelected(e.getId(),t)}},handleLayerModified:function(e){for(var t=0;t<this.layerTabs.length;++t){var i=this.layerTabs[t];i.updateLayerContent(e.getId(),e)}},handleLayerSticky:function(e){for(var t=0;t<this.layerTabs.length;++t){var i=this.layerTabs[t];i.updateLayerContent(e.getId(),e)}},handleLayerAdded:function(){this.populateLayers()},handleLayerRemoved:function(){this.populateLayers()}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.layerselector2.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",function(e){this.name=e,this.layers=[],this.searchIndex={}},{setTitle:function(e){this.name=e},getTitle:function(){return this.name},addLayer:function(e){this.layers.push(e),this.searchIndex[e.getId()]=this._getSearchIndex(e)},getLayers:function(){return this.layers},_getSearchIndex:function(e){var t=e.getName()+" "+e.getInspireName()+" "+e.getOrganizationName();return t.toLowerCase()},matchesKeyword:function(e,t){var i=this.searchIndex[e];return-1!=i.indexOf(t.toLowerCase())}}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.Layer",function(e,t,i){this.sandbox=t,this.localization=i,this.layer=e,this.backendStatus="OK",this.ui=this._createLayerContainer(e)},{__template:'<div class="layer"><input type="checkbox" /> <div class="layer-tools"><div class="layer-backendstatus-icon backendstatus-ok"></div><div class="layer-icon"></div><div class="layer-info"></div></div><div class="layer-title"></div></div>',getId:function(){return this.layer.getId()},setVisible:function(e){1==e?this.ui.show():this.ui.hide()},setSelected:function(e){this.ui.find("input").attr("checked",1==e)},updateLayerContent:function(e){var t=e.getName();this.ui.find(".layer-title").html(t),e.isSticky()&&this.ui.find("input").attr("disabled","disabled");var i=this.backendStatus,a=e.getBackendStatus(),n=this.localization.backendStatus,s=i?n[i]:null,r=a?n[a]:null,o=s?s.iconClass:null,l=r?r.iconClass:null,u=s?s.tooltip:null,c=r?r.tooltip:null,h=this.ui.find(".layer-backendstatus-icon");o&&o!=l&&h.removeClass(o),l&&o!=l&&h.addClass(l),c?u!=c&&h.attr("title",c):u&&h.attr("title",""),this.backendStatus=a},getContainer:function(){return this.ui},_createLayerContainer:function(e){var t=this.sandbox,i=jQuery(this.__template),a=this.localization.tooltip,n=jQuery(i).find("div.layer-tools"),s=n.find("div.layer-icon");s.addClass(e.getIconClassname()),e.isBaseLayer()?s.attr("title",a["type-base"]):e.isLayerOfType("WMS")?s.attr("title",a["type-wms"]):e.isLayerOfType("WMTS")?s.attr("title",a["type-wms"]):e.isLayerOfType("WFS")?s.attr("title",a["type-wfs"]):e.isLayerOfType("VECTOR")&&s.attr("title",a["type-wms"]),e.getMetadataIdentifier()&&(n.find("div.layer-info").addClass("icon-info"),n.find("div.layer-info").click(function(){var i="catalogue.ShowMetadataRequest",a=e.getMetadataIdentifier(),n=[],s={};s[a]=!0;var r=e.getSubLayers();if(r&&r.length>0)for(var o=0;o<r.length;o++){var l=r[o].getMetadataIdentifier();l&&""!=l&&!s[l]&&(s[l]=!0,n.push({uuid:l}))}t.postRequestByName(i,[{uuid:a},n])})),jQuery(i).attr("layer_id",e.getId()),jQuery(i).find(".layer-title").append(e.getName()),jQuery(i).find("input").change(function(){var i=jQuery(this);i.is(":checked")?t.postRequestByName("AddMapLayerRequest",[e.getId(),!1,e.isBaseLayer()]):t.postRequestByName("RemoveMapLayerRequest",[e.getId()])});var r=n.find(".layer-backendstatus-icon");return r.click(function(){var i=e.getId();t.postRequestByName("ShowMapLayerInfoRequest",[i])}),i}},{protocol:["Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.LayersTab",function(e,t){this.instance=e,this.title=t,this.layerGroups=[],this.layerContainers={},this.templates={shortDescription:'<div class="field-description"></div>',description:'<div><h4 class="indicator-msg-popup"></h4><p></p></div>',relatedKeywords:'<div class="related-keywords"></div>',keywordsTitle:'<div class="keywords-title"></div>',keywordContainer:'<div class="keyword-cont"><div class="keyword"></div></div>',keywordType:'<div class="type"></div>'},this._createUI()},{getTitle:function(){return this.title},getTabPanel:function(){return this.tabPanel},getState:function(){var e={tab:this.getTitle(),filter:this.filterField.getValue(),groups:[]};return e},setState:function(e){e&&(e.filter||(this.filterField.setValue(e.filter),this.filterLayers(e.filter)),e.groups&&e.groups.length>0)},_createUI:function(){this._locale=this.instance._localization,this.tabPanel=Oskari.clazz.create("Oskari.userinterface.component.TabPanel"),this.tabPanel.setTitle(this.title);var e=this.getFilterField().getField();e.append(jQuery(this.templates.shortDescription).text(this._locale.filter.shortDescription)),this._createInfoIcon(e),this.tabPanel.getContainer().append(e),this.accordion=Oskari.clazz.create("Oskari.userinterface.component.Accordion"),this.accordion.insertTo(this.tabPanel.getContainer())},_createInfoIcon:function(e){var t=this,i=jQuery('<div class="icon-info"></div>'),a=e.find(".field-description");a.find(".icon-info").remove(),a.append(i),i.click(function(){Oskari.getLang();var e=jQuery(t.templates.description);e.find("p").text(t._locale.filter.description);var i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(t._locale.buttons.ok),a.addClass("primary"),a.setHandler(function(){i.close(!0)}),i.show(t._locale.filter.text,e,[a])})},getFilterField:function(){if(this.filterField)return this.filterField;var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.FormInput");return t.setPlaceholder(this.instance.getLocalization("filter").text),t.addClearButton(),t.bindChange(function(i){i.stopPropagation(),i.which&&38!=i.which&&40!=i.which&&13!=i.which&&(e.filterLayers(t.getValue()),e.clearRelatedKeywordsPopup(t.getValue(),jQuery(i.currentTarget).parents(".oskarifield")))},!0),t.bindEnterKey(function(i){e._relatedKeywordsPopup(t.getValue(),i,e)}),t.bindOnBlur(function(){this.relatedKeywords=null;var e=jQuery(t.getField()[0]);e.find("input").off("keydown")}),this.filterField=t,t},showLayerGroups:function(e){this.accordion.removeAllPanels(),this.layerContainers=void 0,this.layerContainers={},this.layerGroups=e;for(var t=0;t<e.length;++t){var i=e[t],a=i.getLayers(),n=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");n.setTitle(i.getTitle()+" ("+a.length+")"),i.layerListPanel=n;for(var s=n.getContainer(),r=0;r<a.length;++r){var o=a[r],l=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.Layer",o,this.instance.sandbox,this.instance.getLocalization()),u=l.getContainer();s.append(u),this.layerContainers[o.getId()]=l}this.accordion.addPanel(n)}for(var c=this.instance.sandbox.findAllSelectedMapLayers(),t=0;t<c.length;++t)this.setLayerSelected(c[t].getId(),!0);this.filterLayers(this.filterField.getValue())},filterLayers:function(e){if(this.accordion.showPanels(),!e||0==e.length)return this._showAllLayers(),void 0;for(var t=0,i=0;i<this.layerGroups.length;++i){for(var a=this.layerGroups[i],n=a.getLayers(),s=0,r=0;r<n.length;++r){var o=n[r],l=o.getId(),u=this.layerContainers[l],c=a.matchesKeyword(l,e);u.setVisible(c),c&&(s++,1==s%2?u.getContainer().addClass("odd"):u.getContainer().removeClass("odd"),a.layerListPanel.open())}a.layerListPanel.setVisible(s>0),a.layerListPanel.isVisible()&&t++,a.layerListPanel.setTitle(a.getTitle()+" ("+s+"/"+n.length+")")}if(0==t){var h=this.instance.getLocalization("errors");this.accordion.showMessage(h.noResults)}else this.accordion.removeMessage()},clearRelatedKeywordsPopup:function(e,t){if(this.sentKeyword&&this.sentKeyword!==e){var i=t.find(".related-keywords");t.find("input").off("keydown"),i.remove()}},_relatedKeywordsPopup:function(e,t,i){t.preventDefault();var a=jQuery(t.currentTarget).parents(".oskarifield");if(!e||0==e.length)return this._showAllLayers(),void 0;if(e.length<4){a.find(".related-keywords").remove();var n=a.find("input"),s=n.position().top+n.outerHeight(),r=n.position().left,o=i.instance.getLocalization("errors"),l=jQuery(i.templates.relatedKeywords);return l.css({top:s,left:r,padding:"3px 5px"}),l.text(o.minChars),a.append(l),void 0}if(i.sentKeyword=e,!i._selectedKeywordFromPopup(t,i)){var u=this.instance.sandbox.getAjaxUrl();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:u+"action_route=SearchKeywords&keyword="+e+"&lang="+Oskari.getLang(),success:function(e){i.relatedKeywords=e,i._showRelatedKeywords(e,a)},error:function(){var e=i.instance.getLocalization("errors");i.accordion.showMessage(e.generic)}})}},_selectedKeywordFromPopup:function(e,t){for(var i=jQuery(e.currentTarget).parents(".oskarifield"),a=i.find(".keyword-cont"),n=!1,s=0;s<a.length;s++){var r=jQuery(a[s]);if(r.hasClass("focus")){t._filterRelatedLayers(r,t),n=r;break}}return n},_showRelatedKeywords:function(e,t){var i=this;this.clearRelatedKeywordsPopup(null,t);var a=t.find("input"),n=a.position().top+a.outerHeight(),s=a.position().left,r=jQuery(i.templates.relatedKeywords);if(r.css({top:n,left:s}),1!=e.length||e[0].type||0!=e[0].layers.length){r.append(jQuery(i.templates.keywordsTitle).text("Avainsanat:"));for(var o=0;o<e.length;o++){var l=e[o];if(l.layers.length>0){var u=jQuery(i.templates.keywordContainer);if(u.addClass(0!=o%2?" odd":"").attr("data-id",l.id).find(".keyword").text(l.keyword+" ("+l.layers.length+")"),l.type){var c=jQuery(i.templates.keywordType);c.attr("title",i._locale.types[l.type]),u.append(c.text(l.type.toUpperCase()))}r.append(u)}}}else r.append(jQuery(i.templates.keywordsTitle).text(i._locale.errors.noResultsForKeyword));t.append(r),r.find(".keyword-cont").on("click",function(e){t.off("keydown"),i._filterRelatedLayers(jQuery(e.currentTarget),i)}),i.filterField.bindDownKey(function(e){e.stopPropagation();for(var t=r.find(".keyword-cont"),i=!1,a=0;a<t.length;a++){var n=jQuery(t[a]);if(n.hasClass("focus")){var s=(a+1)%(t.length+1);if(s>t.length)t.removeClass("focus");else{var o=jQuery(t[s]);t.removeClass("focus"),o.addClass("focus"),i=!0}break}}i||jQuery(t[0]).addClass("focus")}),i.filterField.bindUpKey(function(e){e.stopPropagation();for(var t=r.find(".keyword-cont"),i=!1,a=0;a<t.length;a++){var n=jQuery(t[a]);if(n.hasClass("focus")){var s=(a-1)%(t.length+1);if(s>t.length)t.removeClass("focus");else{var o=jQuery(t[s]);t.removeClass("focus"),o.addClass("focus"),i=!0}break}}i||jQuery(t[t.length-1]).addClass("focus")})},_filterRelatedLayers:function(e,t){for(var i=e.attr("data-id"),a=t.relatedKeywords,n=0;n<a.length;n++)if(a[n].id==i){a=a[n];break}if(e.parents(".oskarifield").find("input").val(a.keyword),e.parent().find(".keyword-cont").off(),0==a.layers.length){var s=t.instance.getLocalization("errors");t.accordion.showMessage(s.noResults)}else t.accordion.removeMessage();for(var r=0,n=0;n<this.layerGroups.length;++n){for(var o=this.layerGroups[n],l=o.getLayers(),u=0,c=0;c<l.length;++c){for(var h=l[c],d=h.getId(),p=this.layerContainers[d],f=!1,m=0;m<a.layers.length;m++)d==a.layers[m]&&(f=!0);p.setVisible(f),f&&(u++,1==u%2?p.getContainer().addClass("odd"):p.getContainer().removeClass("odd"),o.layerListPanel.open())}o.layerListPanel.setVisible(u>0),o.layerListPanel.isVisible()&&r++,o.layerListPanel.setTitle(o.getTitle()+" ("+u+"/"+l.length+")")}e.parents(".oskarifield").find(".related-keywords").remove()},_showAllLayers:function(){for(var e=0;e<this.layerGroups.length;++e){for(var t=this.layerGroups[e],i=t.getLayers(),a=0;a<i.length;++a){var n=i[a],s=n.getId(),r=this.layerContainers[s];r.setVisible(!0),1==a%2?r.getContainer().addClass("odd"):r.getContainer().removeClass("odd")}t.layerListPanel.setVisible(!0),t.layerListPanel.close(),t.layerListPanel.setTitle(t.getTitle()+" ("+i.length+")")}},setLayerSelected:function(e,t){var i=this.layerContainers[e];i&&i.setSelected(t)},updateLayerContent:function(e,t){var i=this.layerContainers[e];i&&i.updateLayerContent(t)}}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.PublishedLayersTab",function(e,t){this.instance=e,this.title=t,this.layerGroups=[],this.layerContainers={},this._createUI()},{getTitle:function(){return this.title},getTabPanel:function(){return this.tabPanel},getState:function(){var e={tab:this.getTitle(),filter:this.filterField.getValue(),groups:[]};return e},setState:function(e){e&&(e.filter||(this.filterField.setValue(e.filter),this.filterLayers(e.filter)),e.groups&&e.groups.length>0)},_createUI:function(){var e=this;this.tabPanel=Oskari.clazz.create("Oskari.userinterface.component.TabPanel"),this.tabPanel.setTitle(this.title),this.tabPanel.setSelectionHandler(function(t){t?e.tabSelected():e.tabUnselected()}),this.tabPanel.getContainer().append(this.getFilterField().getField()),this.accordion=Oskari.clazz.create("Oskari.userinterface.component.Accordion"),this.accordion.insertTo(this.tabPanel.getContainer())},getFilterField:function(){if(this.filterField)return this.filterField;var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.FormInput");return t.setPlaceholder(this.instance.getLocalization("filter").text),t.addClearButton(),t.bindChange(function(){e._searchTrigger(t.getValue())},!0),t.bindEnterKey(function(){e._relatedSearchTrigger(t.getValue())}),this.filterField=t,t},_searchTrigger:function(e){var t=this;this.searchTimer&&clearTimeout(this.searchTimer),e&&0!=e.length?this.searchTimer=setTimeout(function(){t._search(e),t.searchTimer=void 0},500):t._search(e)},_relatedSearchTrigger:function(e){this.searchTimer&&clearTimeout(this.searchTimer),!e||0==e.length},tabSelected:function(){if(0==this.layerGroups.length){this.accordion.showMessage(this.instance.getLocalization("loading"));var e=this,t=this.instance.sandbox.getAjaxUrl();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:t+"action_route=GetPublishedMyPlaceLayers",success:function(t){e._populateLayerGroups(t),e.showLayerGroups(e.layerGroups)},error:function(){var t=e.instance.getLocalization("errors");e.accordion.showMessage(t.generic)}})}},tabUnselected:function(){},_populateLayerGroups:function(e){var t=this.instance.getSandbox();this.layerGroups=[];for(var i=t.getService("Oskari.mapframework.service.MapLayerService"),a=t.getUser().getUuid(),n=null,s=0;s<e.length;++s){var r=e[s];n&&n.getTitle()==r.name||(n=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",r.name),this.layerGroups.push(n));for(var o=0;o<r.layers.length;++o){var l=r.layers[o],u=this._getPublishedLayer(l,i,a==r.id);u.setDescription(r.name),n.addLayer(u)}}},_getPublishedLayer:function(e,t,i){var a=this._getMapLayerJsonBase();a.wmsUrl="/karttatiili/myplaces?myCat="+e.id+"&",a.name=e.name,a.id="myplaces_"+e.id,a.permissions=i?{publish:"publication_permission_ok"}:{publish:"no_publication_permission"};var n=t.createMapLayer(a);if(!i)try{t.addLayer(n)}catch(s){}return n},_getMapLayerJsonBase:function(){var e=this.instance.getLocalization("published"),t={wmsName:"ows:my_places_categories",type:"wmslayer",isQueryable:!0,opacity:50,metaType:"published",orgName:e.organization,inspire:e.inspire};return t},showLayerGroups:function(e){this.accordion.removeAllPanels(),this.layerContainers=void 0,this.layerContainers={},this.layerGroups=e;for(var t=0;t<e.length;++t){var i=e[t],a=i.getLayers(),n=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");n.setTitle(i.getTitle()+" ("+a.length+")"),i.layerListPanel=n;for(var s=n.getContainer(),r=0;r<a.length;++r){var o=a[r],l=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.Layer",o,this.instance.sandbox,this.instance.getLocalization()),u=l.getContainer();s.append(u),this.layerContainers[o.getId()]=l}this.accordion.addPanel(n)}if(0==this.layerGroups.length){var c=this.instance.getLocalization("errors");this.accordion.showMessage(c.noResults)}else for(var h=this.instance.sandbox.findAllSelectedMapLayers(),t=0;t<h.length;++t)this.setLayerSelected(h[t].getId(),!0)},_search:function(e){var t=this;return e&&0!=e.length?(this.showLayerGroups([]),this.accordion.showMessage(this.instance.getLocalization("loading")),jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},data:{searchKey:e},url:ajaxUrl+"action_route=FreeFindFromMyPlaceLayers",success:function(e){t._populateLayerGroups(e),t.showLayerGroups(t.layerGroups)},error:function(){var e=t.instance.getLocalization("errors");t.accordion.showMessage(e.generic)}}),void 0):(this.updateLayerContent(),void 0)},setLayerSelected:function(e,t){var i=this.layerContainers[e];i&&i.setSelected(t)},updateLayerContent:function(){this.showLayerGroups([]),this.tabSelected()}}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.LayerSelectionBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.layerselection2.LayerSelectionBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/Tile.js"},{type:"text/css",src:"../../../../resources/framework/bundle/layerselection2/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"layerselection2","Bundle-Name":"layerselection2","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("layerselection2","Oskari.mapframework.bundle.layerselection2.LayerSelectionBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.LayerSelectionBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null},{__name:"LayerSelection",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,this.localization=Oskari.getLocalization(this.getName()),a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p);var n=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,n),e.createUi()}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(e){this.plugins["Oskari.userinterface.Tile"].refresh(),this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!1)
},AfterMapLayerAddEvent:function(e){this.plugins["Oskari.userinterface.Tile"].refresh(),this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!0,e.getKeepLayersOrder())},MapLayerEvent:function(e){var t=this.sandbox.getService("Oskari.mapframework.service.MapLayerService"),i=e.getLayerId();if("update"===e.getOperation()){var a=t.findMapLayer(i);this.plugins["Oskari.userinterface.Flyout"].handleLayerModified(a)}else if("sticky"===e.getOperation()){var a=t.findMapLayer(i);this.plugins["Oskari.userinterface.Flyout"].handleLayerSticky(a)}},MapLayerVisibilityChangedEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerVisibilityChanged(e.getMapLayer(),e.isInScale(),e.isGeometryMatch())},AfterChangeMapLayerOpacityEvent:function(e){e._creator!=this.getName()&&this.plugins["Oskari.userinterface.Flyout"].handleLayerOpacityChanged(e.getMapLayer())},AfterChangeMapLayerStyleEvent:function(e){e._creator!=this.getName()&&this.plugins["Oskari.userinterface.Flyout"].handleLayerStyleChanged(e.getMapLayer())},"userinterface.ExtensionUpdatedEvent":function(e){var t=this;e.getExtension().getName()==t.getName()&&"close"!=e.getViewState()}},stop:function(){var e=this.sandbox;for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselection2.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselection2.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.templateLayer=null,this.templateLayerTools=null,this.templateLayerOutOfScale=null,this.templateLayerOutOfContentArea=null,this.sortableBinded=!1,this._sliders={}},{getName:function(){return"Oskari.mapframework.bundle.layerselection2.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("layerselection2")||jQuery(this.container).addClass("layerselection2")},startPlugin:function(){var e=this.instance.getLocalization("layer");this.template=jQuery('<ul class="selectedLayersList sortable" data-sortable=\'{itemCss: "li.layer.selected", handleCss: "div.layer-title" }\'></ul>'),this.templateLayer=jQuery('<li class="layer selected"><div class="layer-info"><div class="layer-icon"></div><div class="layer-tool-remove"></div><div class="layer-title"><h4></h4></div></div><div class="stylesel"><label for="style">'+e.style+"</label>"+'<select name="style"></select></div>'+'<div class="layer-tools volatile">'+"</div>"+"</li>"),this.templateLayerFooterTools=jQuery('<div class="left-tools"><div class="layer-visibility"><a href="JavaScript:void(0);">'+e.hide+"</a>"+"&nbsp;"+'<span class="temphidden" '+'style="display: none;">'+e.hidden+"</span>"+"</div>"+'<div class="oskariui layer-opacity">'+'<div class="layout-slider" id="layout-slider">'+"</div> "+'<div class="opacity-slider" style="display:inline-block">'+'<input type="text" name="opacity-slider" class="opacity-slider opacity" id="opacity-slider" />%</div>'+"</div>"+"</div>"+'<div class="right-tools">'+'<div class="layer-rights"></div>'+'<div class="object-data"></div>'+'<div class="layer-description">'+'<div class="icon-info"></div>'+"</div></div>"),this.templateLayerFooterHidden=jQuery('<p class="layer-msg"><a href="JavaScript:void(0);">'+e.show+"</a> "+e.hidden+"</p>"),this.templateLayerFooterOutOfScale=jQuery('<p class="layer-msg">'+e["out-of-scale"]+' <a href="JavaScript:void(0);">'+e["move-to-scale"]+"</a></p>"),this.templateLayerFooterOutOfContentArea=jQuery('<p class="layer-msg">'+e["out-of-content-area"]+' <a href="JavaScript:void(0);">'+e["move-to-content-area"]+"</a></p>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},createUi:function(){var e=this,t=jQuery(this.container);t.empty();var i=this.template.clone();t.append(i);for(var a=e.instance.getSandbox(),n=a.findAllSelectedMapLayers(),s=a.getMap().getScale(),r=n.length-1;r>=0;--r){var o=n[r],l=this._createLayerContainer(o);i.append(l),this._appendLayerFooter(l,o,o.isInScale(s),!0)}i.sortable({stop:function(t,i){var a=i.item;e._layerOrderChanged(a)}}),this.sortableBinded||(this.sortableBinded=!0)},_appendLayerFooter:function(e,t,i,a){var n=e.find("div.layer-tools"),s=this._createLayerFooter(t,e);if(t.isVisible())if(i)if(a)s.css("display","");else{var r=this._createLayerFooterOutOfContentArea(t);n.addClass("out-of-content"),s.css("display","none"),n.append(r)}else{var o=this._createLayerFooterOutOfScale(t);n.addClass("out-of-scale"),s.css("display","none"),n.append(o)}else n.addClass("hidden-layer"),s.css("display","none"),n.append(this._createLayerFooterHidden(t));n.append(s),this._addSlider(t,e);var l=e.find("div.layer-opacity input.opacity");l.attr("value",t.getOpacity())},_addSlider:function(e,t){var i=this,a=e.getId(),n=e.getOpacity(),s=t.find(".layout-slider"),r=s.slider({min:0,max:100,value:n,slide:function(t,a){i._layerOpacityChanged(e,a.value)},stop:function(t,a){i._layerOpacityChanged(e,a.value)}});return i._sliders[a]=r,r},_layerOrderChanged:function(e){var t=jQuery(this.container).find(".selectedLayersList li"),i=e.attr("layer_id"),a=-1;if(t.each(function(e){return $(this).attr("layer_id")==i?(a=e,!1):!0}),a>-1){a=t.length-1-a;var n=this.instance.getSandbox(),s="RearrangeSelectedMapLayerRequest",r=n.getRequestBuilder(s),o=r(i,a);n.request(this.instance.getName(),o)}},_createLayerContainer:function(e){var t=this,i=t.instance.getSandbox(),a="ChangeMapLayerOpacityRequest";i.getRequestBuilder(a);var n=e.getId();e.getOpacity();var s=this.templateLayer.clone();s.attr("layer_id",n),s.find("div.layer-title h4").append(e.getName()),s.find("div.layer-title").append(e.getDescription());var r=s.find("div.stylesel");if(r.hide(),e.getStyles&&e.getStyles().length>1){for(var o=!1,l=e.getStyles(),u=r.find("select"),c=0;c<l.length;c++)if(l[c].getName()){var h=jQuery('<option value="'+l[c].getName()+'">'+l[c].getTitle()+"</option>");u.append(h),o=!0}u.change(function(){var a=u.find("option:selected").val();e.selectStyle(a);var n="ChangeMapLayerStyleRequest",s=i.getRequestBuilder(n),r=s(e.getId(),a);i.request(t.instance.getName(),r)}),o&&(u.val(e.getCurrentStyle().getName()),r.show())}var d=this.instance.getLocalization("layer").tooltip,p=s.find("div.layer-icon");return p.addClass(e.getIconClassname()),e.isBaseLayer()?p.attr("title",d["type-base"]):e.isLayerOfType("WMS")?p.attr("title",d["type-wms"]):e.isLayerOfType("WMTS")?p.attr("title",d["type-wms"]):e.isLayerOfType("WFS")?p.attr("title",d["type-wfs"]):e.isLayerOfType("VECTOR")&&p.attr("title",d["type-wms"]),e.isSticky()||(s.find("div.layer-tool-remove").addClass("icon-close"),s.find("div.layer-tool-remove").bind("click",function(){var a="RemoveMapLayerRequest",n=i.getRequestBuilder(a),s=n(e.getId());i.request(t.instance.getName(),s)})),s},handleLayerVisibilityChanged:function(e,t,i){var a=this;a.instance.getSandbox();var n="li.layer.selected[layer_id="+e.getId()+"]",s=jQuery(this.container).find(n);this.instance.getLocalization("layer");var r=s.find("div.layer-tools");r.empty(),s.removeClass("hidden-layer"),s.removeClass("out-of-scale"),s.removeClass("out-of-content"),this._sliders[e.getId()]=null,this._appendLayerFooter(s,e,t,i)},_layerOpacityChanged:function(e,t){var i=this.instance.getSandbox(),a="ChangeMapLayerOpacityRequest",n=i.getRequestBuilder(a),s=n(e.getId(),t);i.request(this.instance.getName(),s);var r="li.layer.selected[layer_id="+e.getId()+"]",o=jQuery(this.container).find(r),l=o.find("div.layer-opacity input.opacity");l.attr("value",e.getOpacity())},handleLayerOpacityChanged:function(e){this._sliders[e.getId()]&&this._sliders[e.getId()].slider("value",e.getOpacity())},handleLayerStyleChanged:function(e){var t="li.layer.selected[layer_id="+e.getId()+"]",i=jQuery(this.container).find(t),a=i.find("div.stylesel select");a.val(e.getCurrentStyle().getName())},_createLayerFooterOutOfScale:function(e){var t=this,i=t.instance.getSandbox(),a=this.templateLayerFooterOutOfScale.clone();a.addClass("layer-msg-for-outofscale");var n="MapModulePlugin.MapMoveByLayerContentRequest",s=i.getRequestBuilder(n);return a.find("a").bind("click",function(){var a=s(e.getId());return i.request(t.instance.getName(),a),!1}),a},_createLayerFooterHidden:function(e){var t=this,i=t.instance.getSandbox(),a=this.templateLayerFooterHidden.clone();a.addClass("layer-msg-for-hidden");var n="MapModulePlugin.MapLayerVisibilityRequest",s=i.getRequestBuilder(n);return a.find("a").bind("click",function(){var a=s(e.getId(),!0);return i.request(t.instance.getName(),a),!1}),a},_createLayerFooterOutOfContentArea:function(e){var t=this,i=t.instance.getSandbox(),a=this.templateLayerFooterOutOfContentArea.clone();a.addClass("layer-msg-for-outofcontentarea");var n="MapModulePlugin.MapMoveByLayerContentRequest",s=i.getRequestBuilder(n);return a.find("a").bind("click",function(){var a=s(e.getId());return i.request(t.instance.getName(),a),!1}),a},_createLayerFooter:function(e){var t=this,i=t.instance.getSandbox(),a=this.templateLayerFooterTools.clone();this.instance.getLocalization("layer");var n="MapModulePlugin.MapLayerVisibilityRequest",s=i.getRequestBuilder(n);a.find("div.layer-visibility a").bind("click",function(){var a=s(e.getId(),!1);return i.request(t.instance.getName(),a),!1}),e.getMetadataIdentifier()?a.find("div.icon-info").bind("click",function(){var t="catalogue.ShowMetadataRequest",a=e.getMetadataIdentifier(),n=[],s={};s[a]=!0;var r=e.getSubLayers();if(r&&r.length>0)for(var o=0;o<r.length;o++){var l=r[o].getMetadataIdentifier();l&&""!=l&&!s[l]&&(s[l]=!0,n.push({uuid:l}))}i.postRequestByName(t,[{uuid:a},n])}):a.find("div.layer-description").hide();for(var r=function(e){return function(){return e.getCallback()(),!1}},o=e.getTools(),l=0;l<o.length;l++){var u=o[l];if(u)if(u.getIconCls()){var c=jQuery("<div></div>");c.addClass(u.getIconCls()),c.attr("title",u.getTooltip()),a.find("div.object-data").append(c),c.bind("click",r(u))}else{var c=jQuery('<a href="JavaScript:void(0);"></a>');c.append(u.getTitle()),a.find("div.object-data").append(c),c.bind("click",r(u))}}return this._updatePublishPermissionText(e,a),a},_updatePublishPermissionText:function(e,t){var i=this.instance.getSandbox(),a=this.instance.getLocalization("layer"),n=e.getPermission("publish");"publication_permission_ok"==n&&i.getUser().isLoggedIn()&&(t.find("div.layer-rights").html(a.rights.can_be_published_map_user.label),t.find("div.layer-rights").attr("title",a.rights.can_be_published_map_user.tooltip))},handleLayerSelectionChanged:function(e,t,i){if(1==t){var a=this,n=a.instance.getSandbox(),s=n.getMap().getScale(),r=jQuery("ul.selectedLayersList"),o=this._createLayerContainer(e);o.find("div.layer-tools");var l=[];l=e.isBaseLayer()&&1!=i?r.find("li[layer_id^=base_]"):r.find(".layer.selected"),l.length>0?e.isBaseLayer()&&1!=i?l.last().after(o):l.first().before(o):r.append(o),this._appendLayerFooter(o,e,e.isInScale(s),!0)}else{var u=jQuery(this.container).find("li[layer_id="+e.getId()+"]");u&&(this._sliders[e.getId()]=null,u.remove())}},handleLayerModified:function(e){var t=jQuery(this.container).find("li[layer_id="+e.getId()+"]");jQuery(t).find(".layer-title h4").html(e.getName());var i=t.find("div.layer-tools");this._updatePublishPermissionText(e,i)},handleLayerSticky:function(e){var t=jQuery(this.container).find("li[layer_id="+e.getId()+"]");t.find("div.layer-tool-remove").removeClass("icon-close")},refresh:function(){for(var e=this,t=e.instance.getSandbox(),i=t.findAllSelectedMapLayers(),a=i.length-1;a>=0;--a){var n=i[a];this.handleLayerOpacityChanged(n)}}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.Tile",function(e){this.instance=e,this.container=null,this.template=null,this.shownLayerCount=null},{getName:function(){return"Oskari.mapframework.bundle.layerselection2.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},notifyUser:function(){var e=this.container.children(".oskari-tile-status");e.stop(),this._blink(e,2)},_blink:function(e,t){var i=this;e&&(t||(t=1),e.animate({opacity:.25},500,function(){e.animate({opacity:1},500,function(){t>1&&i._blink(e,--t)})}))},refresh:function(){var e=this,t=e.instance;this.container,this.template;var i=t.getSandbox(),a=i.findAllSelectedMapLayers(),n=a.length,s=this.container.children(".oskari-tile-status");s.addClass("icon-bubble-right"),s.html(n),this.notifyUser()}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.promote.PromoteBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.promote.PromoteBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/promote/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/promote/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/promote/Tile.js"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/promote/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/promote/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/promote/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"promote","Bundle-Name":"promote","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("promote","Oskari.mapframework.bundle.promote.PromoteBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.promote.PromoteBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.userInterfaceLanguage=null,this.service=null},{__name:"Promote",getName:function(){return this.conf.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this.conf&&this.conf[e]?this.conf[e][this.userInterfaceLanguage]:(this._localization||(this._localization=Oskari.getLocalization(this.__name)),e&&this._localization[e]?this._localization[e]:this.localization?this._localization:{})},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,e.userInterfaceLanguage=Oskari.getLang(),this.localization=Oskari.getLocalization(this.getName()),a.register(e);var n="userinterface.AddExtensionRequest",s=a.getRequestBuilder(n),r=s(this);if(a.request(this,r),e.createUi(),this.conf&&this.conf.toolbarButtons){s=a.getRequestBuilder("Toolbar.AddToolButtonRequest");for(var o in this.conf.toolbarButtons)for(var l in this.conf.toolbarButtons[o]){var u=this.conf.toolbarButtons[o][l];u.tooltip=u.tooltip[e.userInterfaceLanguage],u.disabled=!0,u.callback=function(){},a.request(e,s(l,o,u))}}}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{},stop:function(){var e=this.sandbox,t="userinterface.RemoveExtensionRequest",i=e.getRequestBuilder(t),a=i(this);e.request(this,a),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.promote.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.promote.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.promote.Flyout",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.promote.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("promote")||jQuery(this.container).addClass("promote")},startPlugin:function(){this.template=jQuery('<div class="promoteContainer"><div class="promoteDescription"></div><div><a class="promoteSignup"></a></div><div><a class="promoteRegister"></a></div></div>')},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},createUi:function(){var e=this;e.instance.getSandbox();var t=jQuery(this.container);t.empty();var i=this.template.clone(),a=i.find("div.promoteDescription");if(a.html(this.instance.getLocalization("desc")),e.instance.conf.signup){var n=i.find("a.promoteSignup");n.attr("href",this.instance.getLocalization("signupUrl")),n.append(this.instance.getLocalization("signup"))}if(e.instance.conf.register){var s=i.find("a.promoteRegister");s.attr("href",this.instance.getLocalization("registerUrl")),s.append(this.instance.getLocalization("register"))}t.append(i)}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.promote.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.promote.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},refresh:function(){var e=this,t=e.instance,i=this.container;this.template,t.getSandbox(),i.children(".oskari-tile-status")}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.coordinatedisplay.CoordinateDisplayBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.coordinatedisplay.CoordinateDisplayBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/plugin/CoordinatesPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/coordinatedisplay/css/coordinatedisplay.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"coordinatedisplay","Bundle-Name":"coordinatedisplay","Bundle-Author":[{Name:"ah",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("coordinatedisplay","Oskari.mapframework.bundle.coordinatedisplay.CoordinateDisplayBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.coordinatedisplay.CoordinateDisplayBundleInstance",function(){this.sandbox=null,this.started=!1,this._localization=null},{__name:"coordinatedisplay",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},update:function(){},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=e.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.setSandbox(a);var n=a.findRegisteredModuleInstance("MainMapModule"),t={},s=this.getLocalization("display"),r=Oskari.clazz.create("Oskari.mapframework.bundle.coordinatedisplay.plugin.CoordinatesPlugin",t,s);n.registerPlugin(r),n.startPlugin(r),this.plugin=r}},stop:function(){this.sandbox=null,this.started=!1}},{protocol:["Oskari.bundle.BundleInstance"]}),Oskari.clazz.define("Oskari.mapframework.bundle.coordinatedisplay.plugin.CoordinatesPlugin",function(e,t){this._conf=e,this._locale=t,this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._elements={},this.__templates={}},{__name:"CoordinatesPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this.__templates.latlondiv=jQuery('<div class="mapplugin cbDiv"> <div class="cbSpansWrapper"> <div class="cbRow">  <div class="cbCrsLabel"></div> </div> <div class="cbRow">  <div class="cbLabel cbLabelN" axis="lat"></div>  <div class="cbValue" axis="lat"></div> </div>  <br clear="both"> <div class="cbRow">  <div class="cbLabel cbLabelE" axis="lon"></div>  <div class="cbValue" axis="lon"></div> </div> </div></div>')},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this),this._createUI();for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);this._elements.display&&(this._elements.display.remove(),delete this._elements.display),e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},_createUI:function(){this._sandbox;var e=this,t=jQuery(this._map.div),i=e._elements.display;e._elements.display||(i=e._elements.display=e.__templates.latlondiv.clone());var a=e._map.getProjection(),n=e._locale.crs[a];i.find(".cbCrsLabel").html(n),i.find(".cbLabelN").html(e._locale.compass.N),i.find(".cbLabelE").html(e._locale.compass.E),i.mousedown(function(e){e.stopPropagation()}),t.append(i),this.update(),i.show()},update:function(e){if(!e||!e.latlon){var t=this._sandbox.getMap();e={latlon:{lat:t.getY(),lon:t.getX()}}}var i=this,a=e.latlon,n=i._elements.display,s=n.find('.cbValue[axis="lat"]'),r=n.find('.cbValue[axis="lon"]');s&&r&&(s.text(a.lat),r.text(a.lon))},eventHandlers:{MouseHoverEvent:function(e){this.update({latlon:{lat:Math.floor(e.getLat()),lon:Math.floor(e.getLon())}})},AfterMapMoveEvent:function(){this.update()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.maplegend.MapLegendBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.maplegend.MapLegendBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/Tile.js"},{type:"text/css",src:"../../../../resources/framework/bundle/maplegend/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"maplegend","Bundle-Name":"maplegend","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("maplegend","Oskari.mapframework.bundle.maplegend.MapLegendBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.maplegend.MapLegendBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null},{__name:"maplegend",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p);var n=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,n),e.createUi(),a.registerAsStateful(this.mediator.bundleId,this)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(){this.plugins["Oskari.userinterface.Flyout"].refresh()},AfterMapLayerAddEvent:function(){this.plugins["Oskari.userinterface.Flyout"].refresh()},AfterChangeMapLayerStyleEvent:function(){this.plugins["Oskari.userinterface.Flyout"].refresh()},AfterRearrangeSelectedMapLayerEvent:function(){this.plugins["Oskari.userinterface.Flyout"].refresh()}},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.maplegend.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.maplegend.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setContentState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getContentState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.maplegend.Flyout",function(e){this.instance=e,this.container=null,this.templateLayer=null,this.templateLayerLegend=null,this.state=null},{getName:function(){return"Oskari.mapframework.bundle.maplegend.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("maplegend")||jQuery(this.container).addClass("maplegend")},startPlugin:function(){var e=this;e.templateLayer=jQuery('<div class="maplegend-layer"><div class="maplegend-tools"><div class="layer-description"><div class="icon-info"></div></div></div></div>'),e.templateLayerLegend=jQuery('<div class="maplegend-legend"><img /></div>')},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},setContentState:function(){},getContentState:function(){return{}},createUi:function(){this.refresh()},refresh:function(){this._populateLayerList()},_populateLayerList:function(){var e=this,t=jQuery(this.container);t.empty();var i=Oskari.clazz.create("Oskari.userinterface.component.Accordion");i.insertTo(t);for(var a=this.instance.getSandbox(),n=a.findAllSelectedMapLayers().slice(0),s=n.length-1;s>=0;s--){var r=n[s];r.getName(),this._createLayerContainer(r);var o=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");o.open(),o.setTitle(r.getName()),o.getContainer().append(e._createLayerContainer(r)),i.addPanel(o)}},_createLayerContainer:function(e){var t=this,i=t.instance.getSandbox(),a=this.templateLayer.clone(),n={},s=t._createLegendDiv(e,n);s&&a.append(s);var r=e.getSubLayers?e.getSubLayers():null;if(r)for(var o=0;o<r.length;o++){var l=r[o],u=t._createLegendDiv(l,n);u&&a.append(u)}var c=e.getMetadataIdentifier(),h=a.find(".maplegend-tools");return c?h.find("div.icon-info").bind("click",function(){var e="catalogue.ShowMetadataRequest";i.postRequestByName(e,[{uuid:c}])}):h.find("div.layer-description").hide(),a},_createLegendDiv:function(e,t){var i=this,a=e.getLegendImage?e.getLegendImage():null;if(a&&""!=a&&!t[a]){var n=i.templateLayerLegend.clone(),s=n.find("img");t[a]=!0;var r=new Image;return r.onload=function(){s.attr("src",a),r.onload=null},r.src=a,n}}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.maplegend.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.maplegend.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.UserGuideBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.userguide.UserGuideBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/request/ShowUserGuideRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/request/ShowUserGuideRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/service/UserGuideService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/Tile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/Flyout.js"},{type:"text/css",src:"../../../../resources/framework/bundle/userguide/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"userguide","Bundle-Name":"userguide","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"userguide",Title:"userguide"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("userguide","Oskari.mapframework.bundle.userguide.UserGuideBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.UserGuideBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.ui=null,this._requestHandlers={},this.attachedToDefault=!1,this.helper=null,this.isContentLoaded=!1
},{templates:{userguide:'<div class="oskari-userguide"><span class="oskari-prompt"></span><br /></div>'},__name:"userinterface.UserGuide",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,this._localization=Oskari.getLocalization(this.getName());var n=this.getLocalization("title"),s=Oskari.clazz.create("Oskari.userinterface.component.Popover",n,"");this.ui=s,s.setContent($(this.templates.userguide)),a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p);this._requestHandlers["userguide.ShowUserGuideRequest"]=Oskari.clazz.create("Oskari.mapframework.bundle.userguide.request.ShowUserGuideRequestHandler",a,this),a.addRequestHandler("userguide.ShowUserGuideRequest",this._requestHandlers["userguide.ShowUserGuideRequest"]);var r=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,r),e.createUi();var o=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",a);this.helper=o}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{"userinterface.ExtensionUpdatedEvent":function(e){var t=this;if(e.getExtension().getName()==t.getName()){var i="close"!=e.getViewState();t.displayContent(i)}}},displayContent:function(e){var t=this;if(e&&!t.isContentLoaded){var i="help.contentPart";t.getLocalization("help")&&t.getLocalization("help").contentPart&&(i=t.getLocalization("help").contentPart);var a="help.tags";this.getLocalization("help")&&this.getLocalization("help").tags&&(a=this.getLocalization("help").tags),this.helper.getHelpArticle(a,function(e,a){var n=a,s="error.generic";t.getLocalization("error")&&t.getLocalization("error").generic&&(s=t.getLocalization("error").generic),e?n[i]&&(n=n[i]):n=s,t.plugins["Oskari.userinterface.Flyout"].setContent(n),t.isContentLoaded=!0})}},toggleUserInterface:function(e,t){var i=this,a=this.ui;if(e){if(!i.attachedToDefault){var t=i.plugins["Oskari.userinterface.Tile"].getEl();a.setPlacement("right"),a.attachTo(t),i.attachedToDefault=!0}a.show()}else a.hide()},scheduleShowUserGuide:function(e){var t=this,i=t.ui,a=e.isToggle();if(a&&i.shown)return t.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[this,"close"]),void 0;t.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[this,"attach"]);var n=jQuery(this.templates.userguide),s=jQuery("<div />"),r=Oskari.getLang(),o=s.clone(),l=e.getContent();if(l)n.append(l);else{o.append("Lang: "+r),n.append(o);var o=s.clone();o.append("Extension: "+e.getExtension()),n.append(o);var o=s.clone();o.append("Context: "+e.getContext()),n.append(o);var o=s.clone();o.append("Element: "+(e.getEl()?"YES":"NO")),n.append(o)}var u=e.getEl(),c=e.getPlacement();c&&i.setPlacement(c),u?(i.hide(),t.attachedToDefault=!1,i.attachTo(u)):t.attachedToDefault||(u=t.plugins["Oskari.userinterface.Tile"].getEl(),i.attachTo(u),t.attachedToDefault=!0),i.setContent(n)},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.removeRequestHandler("userguide.ShowUserGuideRequest",this._requestHandlers["userguide.ShowUserGuideRequest"]);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.userguide.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.userguide.Tile",this,this.getLocalization("tile"))},stopExtension:function(){this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Tile"].refresh(),this.plugins["Oskari.userinterface.Flyout"].setContent("")}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.request.ShowUserGuideRequest",function(e){var t=e||{};this._creator=null,this._el=t.el,this._context=t.context,this._extension=t.extension,this._toggle=t.toggle,this._placement=t.placement,this._content=t.content},{__name:"userguide.ShowUserGuideRequest",getName:function(){return this.__name},getUuid:function(){return this._uuid},getContext:function(){return this._context},getExtension:function(){return this._extension},getEl:function(){return this._el},isToggle:function(){return this._toggle},getPlacement:function(){return this._placement},getContent:function(){return this._content}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.request.ShowUserGuideRequestHandler",function(e,t){this.sandbox=e,this.instance=t},{handleRequest:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.userguide.request.ShowUserGuideRequestHandler] Show UserGuide: "+t.getUuid()),this.instance.scheduleShowUserGuide(t)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.Tile",function(e,t){this.instance=e,this.locale=t,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.userguide.Tile"},setEl:function(e){this.container=jQuery(e),this.container.children(".oskari-tile-status")},getEl:function(){return this.container},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){return this.locale.desciption},getOptions:function(){},refresh:function(){var e=this,t=e.instance;this.container,this.template,t.getSandbox()}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.userguide.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("userguide")||jQuery(this.container).addClass("userguide")},startPlugin:function(){this.template=jQuery('<div class="userguide"></div>')},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},getState:function(){return this.state?this.state:{}},setContent:function(e){var t=this;t.instance.getSandbox();var i=jQuery(this.container);i.empty();var a=this.template.clone();a.append(e),i.append(a)}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.MetadataFlyoutBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.MetadataFlyoutBundleInstance")},start:function(){},stop:function(){},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/instance.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/service/MetadataLoader.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/view/MetadataPage.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/Tile.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/request/ShowMetadataRequest.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/request/ShowMetadataRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/plugin/MetadataLayerPlugin.js"},{type:"text/css",src:"../../../../resources/catalogue/bundle/metadataflyout/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/locale/fi.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/locale/en.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/locale/sv.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"metadataflyout","Bundle-Name":"catalogue.bundle.metadataflyout","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012",End:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("metadataflyout","Oskari.catalogue.bundle.metadataflyout.MetadataFlyoutBundle"),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.MetadataFlyoutBundleInstance",function(){this.map=null,this.core=null,this.sandbox=null,this.mapmodule=null,this.started=!1,this.plugins={},this._locale=null,this._requestHandlers={},this.loader=null,this.layerPlugin=null,this.layer=null},{__name:"catalogue.bundle.metadataflyout",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocale:function(){return this._locale},getLoader:function(){return this.loader},layerSpec:{text:"",name:"Metadata",wmsName:"1",type:"vectorlayer",styles:{title:"Trains",legend:"",name:"1"},descriptionLink:"http://www.paikkatietohakemisto.fi/",orgName:"Metadata",inspire:"Metadata",legendImage:"",info:"",isQueryable:!0,formats:{value:"text/html"},id:"catalogue_metadataflyout_layer",minScale:36e6,maxScale:1,style:"",dataUrl:"",wmsUrl:"x",opacity:60,checked:"false",styledLayerDescriptor:'<StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"     xmlns="http://www.opengis.net/sld"     xmlns:ogc="http://www.opengis.net/ogc"     xmlns:xlink="http://www.w3.org/1999/xlink"     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">   <NamedLayer>     <Name>Simple point with stroke</Name>    <UserStyle><Title>GeoServer SLD Cook Book: Simple point with stroke</Title>     <FeatureTypeStyle><Rule><PolygonSymbolizer> <Graphic><Mark><WellKnownName>circle</WellKnownName><Fill>        <CssParameter name="fill">#000040</CssParameter>       </Fill><Stroke>          <CssParameter name="stroke">#000040</CssParameter>           <CssParameter name="stroke-width">2</CssParameter>          </Stroke></Mark><Size>12</Size></Graphic>     </PolygonSymbolizer><TextSymbolizer><Label><ogc:PropertyName>title</ogc:PropertyName></Label><Fill><CssParameter name="fill">#000000</CssParameter></Fill></TextSymbolizer></Rule></FeatureTypeStyle></UserStyle></NamedLayer></StyledLayerDescriptor>'},start:function(){if(!this.started){this.started=!0,this._locale=Oskari.getLocalization(this.getName());var e=this.conf,t=(e?e.sandbox:null)||"sandbox",i=Oskari.getSandbox(t);this.sandbox=i,this.loader=Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.service.MetadataLoader",this.getLocale().loader,i),i.register(this);for(n in this.eventHandlers)i.registerForEventByName(this,n);this._requestHandlers["catalogue.ShowMetadataRequest"]=Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.request.ShowMetadataRequestHandler",i,this),i.addRequestHandler("catalogue.ShowMetadataRequest",this._requestHandlers["catalogue.ShowMetadataRequest"]);var a={};for(var n in this.layerSpec)a[n]=this.layerSpec[n];var s=this.getLocale().layer;for(var n in s)a[n]=s[n];var r=i.getService("Oskari.mapframework.service.MapLayerService"),o=r.createMapLayer(a);r.addLayer(o,!0),this.layer=o;var l=i.findRegisteredModuleInstance("MainMapModule"),u=Oskari.clazz.create("Oskari.mapframework.mapmodule.MetadataLayerPlugin");u.setMapLayer(o),l.registerPlugin(u),l.startPlugin(u),this.layerPlugin=u;var c=i.getRequestBuilder("userinterface.AddExtensionRequest")(this);i.request(this,c),i.registerAsStateful(this.mediator.bundleId,this)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerAddEvent:function(){},AfterMapLayerRemoveEvent:function(){},AfterMapMoveEvent:function(){}},stop:function(){var e=this.sandbox;e.removeRequestHandler("catalogue.ShowMetadataRequest",this._requestHandlers["catalogue.ShowMetadataRequest"]);for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},setSandbox:function(){this.sandbox=null},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.Flyout",this,this.getLocale().flyout,this.getLoader())},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null},getTitle:function(){return this.getLocale().title},getDescription:function(){return"Sample"},getPlugins:function(){return this.plugins},scheduleShowMetadata:function(e){this.plugins["Oskari.userinterface.Flyout"].scheduleShowMetadata(e),this.getSandbox().requestByName(this,"userinterface.UpdateExtensionRequest",[this,"detach"])},showExtentOnMap:function(e,t,i){var a=this;if(t){for(var n=[],s=0;s<t.length;s++){var r=t[s],o=new OpenLayers.Bounds(r.westBoundLongitude,r.southBoundLatitude,r.eastBoundLongitude,r.northBoundLatitude),l=o.toGeometry(),u=new OpenLayers.Feature.Vector(l);u.attributes=i||u.attributes,n.push(u)}var c=a.getSandbox().getEventBuilder("FeaturesAvailableEvent")(this.layer,n,"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");a.sandbox.notifyAll(c)}},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setContentState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getContentState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.service.MetadataLoader",function(e,t){this.urls=e,this.sandbox=t,this.dev=!1},{getURLForView:function(e,t){var i=this.urls[e],a=i+"uuid="+t;if(this.dev){var n={"abstract":"abstract",jhs:"jhs158",inspire:"inspire",json:"json"}[e];null!=n&&(a=n)}return a},loadMetadata:function(e,t,i,a,n,s){var r=this.getURLForView(e,t,i,a);this.sandbox.printDebug("loadMetadata "+r),null!=r&&jQuery.ajax({url:r,dataType:s||"xml",beforeSend:function(e){e&&e.overrideMimeType&&(s&&"json"==s?e.overrideMimeType("application/json"):e.overrideMimeType("text/html"))},success:function(e){n(e,!0)},error:function(){n(null,!1)}})},loadGeonetworkAjaxHTML:function(e,t,i,a,n){var s=this.getURLForView(t,i,a,n);OpenLayers.Request.GET({url:s,callback:e})},openMetadata:function(e,t,i,a,n,s,r){var o=this.getURLForView(e,t,i,a);this.sandbox.printDebug("openMetadata "+o),window.open(o,r,"resizable=yes,scrollbars=yes,status=yes")}}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.view.MetadataPage",function(e,t){this.instance=e,this.locale=t,this.container=null,this.views={},this.titles={},this.tabs={},this.browseGraphic=null,this.compileTemplates(),this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert"),this.state=null,this.contentState={title:"...",metadata:{uuid:null,RS_Identifier_Code:null,RS_Identifier_CodeSpace:null},view:"abstract",metadataJson:null},this.panel=null},{getPanel:function(){return this.panel},compileTemplates:function(){},templates:{content:"<div class='metadataflyout_content'></div>",browseGraphic:"<div class='metadataflyout_content_browseGraphic'></div>",viewTabs:"<div class='metadataflyout_content_tabs'></div>",viewTab:"<div class='metadataflyout_content_tab'></div>",titles:{"abstract":"<div class='metadataflyout_content_abstract_title'></div>",jhs:"<div class='metadataflyout_content_jhs_title'></div>",inspire:"<div class='metadataflyout_content_inspire_title'></div>"},views:{"abstract":"<div class='metadataflyout_content_abstract'></div>",jhs:"<div class='metadataflyout_content_jhs'></div>",inspire:"<div class='metadataflyout_content_inspire'></div>"}},init:function(){this.container=jQuery("<div />");var e=this.locale,t=jQuery(this.templates.content),i=this,a=jQuery(this.templates.viewTabs),n=jQuery(this.templates.viewTab);for(var s in this.templates.views){var r=a.clone(),o=e.tabs[s];for(var l in o){var u=n.clone();if("string"==typeof o[l])u.append(o[l]),r.append(u),l!=s&&u.click({viewId:l},function(e){var t=e.data;i.showMetadataView(t.viewId)});else{var c=o[l].text,h=o[l].target;u.append(c),r.append(u),u.click({viewId:l,target:h},function(e){var t=e.data;i.openMetadataView(t.viewId,t.target)})}}r.hide(),this.tabs[s]=r,t.append(r)}var d=jQuery(this.templates.browseGraphic);this.browseGraphic=d,t.append(d);for(var s in this.templates.views)this.titles[s]=jQuery(this.templates.titles[s]),this.titles[s].append(this.locale[s]),this.views[s]=jQuery(this.templates.views[s]),t.append(this.titles[s]),t.append(this.views[s]);t.append(a),this.alert.insertTo(this.container),this.container.append(t);var p=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");p.setTitle(this.contentState.title);var f=p.getContainer();f.append(this.container),this.panel=p},destroy:function(){this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){},getOptions:function(){},setState:function(e){this.state=e},openMetadataView:function(e,t){if(this.contentState){var i=this.contentState.metadata;this.instance.getLoader().openMetadata(e,i.uuid,i.RS_Identifier_Code,i.RS_Identifier_CodeSpace,function(){},null,t)}},showMetadataView:function(e){this.instance.getSandbox().printDebug("ShowMetadataView "+e);var t=this.tabs,i=this.views,a=this.titles;for(var n in i)n!=e?(t[n].hide(),a[n].hide(),i[n].hide()):(t[n].show(),a[n].show(),i[n].hide());this.contentState.view=e,this.loadMetadataForState()},resetBrowseGraphic:function(e){var t=jQuery(this.browseGraphic);t.empty(),e&&t.append(e)},loadMetadataForState:function(){function e(e){var n=jQuery("<div />");n.html(e.responseText),jQuery.each(n.find("td.metadataContent"),function(e,i){var a=jQuery(i),n=a.parent(),s=jQuery('<td class="metadataContent"/>');a.hasClass("MD_DigitalTransferOptions")&&s.addClass("MD_DigitalTransferOptions");var r=a.text().split(".\n");jQuery.each(r,function(e,t){var i=jQuery.trim(t);if(0!=i.length){var a=jQuery('<div class="metadataflyout_content_section"/>');r.length>1?a.text(i+"."):a.text(i),s.append(a)}}),a.remove(),n.append(s),t._linkify(s)});var s=n.find("a[href]"),r=new RegExp("^\\?.*");jQuery.each(s,function(e,i){var n=jQuery(i),s=n.attr("href");if(s&&r.test(s)){var o=s.split("&"),l={};jQuery.each(o,function(e,t){var i=t.split("=");l[i[0]]=i[1]}),n.attr("href",null),n.click({viewId:a,uuid:l.uuid},function(e){var i=e.data,a=i.uuid;t.showMetadata(a)})}}),i[a].append(n),i[a].css("display",""),t._updatePanel()}var t=this,i=this.views;if(!this.contentState||!this.contentState.metadata||!this.contentState.metadata.uuid)return!1;var a=this.contentState.view,n=this.contentState.metadata;i[a].empty(),t.instance.getLoader().loadGeonetworkAjaxHTML(e,a,n.uuid,n.RS_Identifier_Code,n.RS_Identifier_CodeSpace)},_updatePanel:function(){var e=this,t=e.contentState.metadataJson;if(t){var i=t.title;i&&this.panel.setTitle(i)}},loadMetadataJSONForState:function(){var e=this;if(!this.contentState||!this.contentState.metadata||!this.contentState.metadata.uuid)return!1;var t=this.contentState.metadata;return this.instance.getLoader().loadMetadata("json",t.uuid,t.RS_Identifier_Code,t.RS_Identifier_CodeSpace,function(t){if(t&&t.mdcs&&t.mdcs.length&&0!=t.mdcs.length){var i=t.mdcs[0];e.processJSON(i)}},"json"),!0},processJSON:function(e){var t=this,i=e.browseGraphic,a=e.env;if(this.resetBrowseGraphic(),i){var n=jQuery("<img />"),s=null;s=this.instance.getLoader().dev?"espoo_johtokartta_s.png":i;var r=new Image;r.onload=function(){n.attr("src",s),r.onload=null},r.src=s,this.resetBrowseGraphic(n)}a&&this.instance.showExtentOnMap(this.contentState.metadata.uuid,a,e),t.contentState.metadataJson=e,t._updatePanel()},resetContentState:function(){},showMetadata:function(e,t,i){this.resetContentState(),this.contentState.metadata.uuid=e,this.contentState.metadata.RS_Identifier_Code=t,this.contentState.metadata.RS_Identifier_CodeSpace=i,this.instance.getSandbox().printDebug("showMetadata { uuid="+e+", view="+this.contentState.view+"}"),this.loadMetadataJSONForState(),this.showMetadataView(this.contentState.view)},scheduleShowMetadata:function(e,t,i){this.showMetadata(e,t,i)},_linkify:function(e){var t=e.html(),i=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,a=t.replace(i,'<a href="$1" target="_blank">$1</a>'),n=/(^|[^\/])(www\.[\S]+(\b|$))/gim;a=a.replace(n,'$1<a href="http://$2" target="_blank">$2</a>'),e.html(a)}},{}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.Flyout",function(e,t){this.instance=e,this.locale=t,this.container=null,this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert"),this.accordion=null,this.pages={}},{getName:function(){return"Oskari.catalogue.bundle.metadataflyout.Flyout"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.locale;var e=Oskari.clazz.create("Oskari.userinterface.component.Accordion");this.accordion=e,e.insertTo(this.container)},stopPlugin:function(){for(p in this.pages)this.pages[p].destroy(),delete this.pages[p];this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){},getOptions:function(){},setState:function(e){this.state=e},scheduleShowMetadata:function(e){var t=this.accordion;for(p in this.pages){var i=this.pages[p];i&&(this.pages[p]=null,i.page.destroy(),t.removePanel(i.panel))}for(var a=0;a<e.length;a++){var n=e[a],s=Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.view.MetadataPage",this.instance,this.locale);s.init();var r=s.getPanel();t.addPanel(r),0==a&&r.open(),this.pages[n.uuid||n.RS_Identifier_CodeSpace+":"+n.RS_Identifier_Code]={page:s,panel:r,data:n}}for(p in this.pages){var i=this.pages[p];if(i){var n=i.data,s=i.page;s.scheduleShowMetadata(n.uuid,n.RS_Identifier_Code,n.RS_Identifier_CodeSpace)}}},setContentState:function(e){this.contentState=e},getContentState:function(){return this.contentState},resetContentState:function(){this.contentState={}}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.Tile",function(e,t){this.instance=e,this.locale=t,this.container=null,this.template=null},{getName:function(){return"Oskari.catalogue.bundle.metadataflyout.Tile"},setEl:function(e){this.container=$(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){},getOptions:function(){},setState:function(e){this.state=e},refresh:function(){var e=this,t=e.instance;this.container,this.template,t.getSandbox()}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.request.ShowMetadataRequest",function(e,t){if(this._creator=null,this._uuid=e.uuid,this._RS_Identifier_Code=e.RS_Identifier_Code,this._RS_Identifier_CodeSpace=e.RS_Identifier_CodeSpace,this._additionalMetadata=t,this._allMetadata=[],this._allMetadata.push(e),t){this._additionalMetadata=t;for(var i=0;i<t.length;i++)this._allMetadata.push(t[i])}},{__name:"catalogue.ShowMetadataRequest",getName:function(){return this.__name},getUuid:function(){return this._uuid},getRS_Identifier_Code:function(){return this._RS_Identifier_Code},getRS_Identifier_CodeSpace:function(){return this._RS_Identifier_CodeSpace},getAdditionalMetadata:function(){return this._additionalMetadata},getAllMetadata:function(){return this._allMetadata}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.request.ShowMetadataRequestHandler",function(e,t){this.sandbox=e,this.instance=t},{handleRequest:function(e,t){this.instance.scheduleShowMetadata(t.getAllMetadata())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.MetadataLayerPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._layer=null,this._supportedFormats={},this._features=null,this._sldFormat=new OpenLayers.Format.SLD({multipleSymbolizers:!1,namedLayersAsArray:!0})},{__name:"MetadataLayerPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},register:function(){this.getMapModule().setLayerPlugin("metadatalayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("metadatalayer",null)},init:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this.registerVectorFormats(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this.afterMapLayerRemoveEvent(e)},FeaturesAvailableEvent:function(e){this.handleFeaturesAvailableEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this.afterChangeMapLayerOpacityEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this.getMapLayer(),i=this._sandbox,a=0;a<e.length;a++){var n=e[a],s=n.getId();n.isLayerOfType("VECTOR")&&t.getId()==n.getId()&&(i.printDebug("preselecting "+s),this.addMapLayerToMap(n,!0,n.isBaseLayer()))}},setMapLayer:function(e){this._layer=e},getMapLayer:function(){return this._layer},registerVectorFormat:function(e,t){this._supportedFormats[e]=t},registerVectorFormats:function(){this.registerVectorFormat("application/json",new OpenLayers.Format.GeoJSON({})),this.registerVectorFormat("application/nlsfi-x-openlayers-feature",new function(){this.read=function(e){return e}})},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.removeMapLayerFromMap(t)},afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer(),i=this.getMapLayer();if(t.isLayerOfType("VECTOR")&&t.getId()==i.getId()){this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var a=this._map.getLayersByName("layer_"+t.getId());null!=a[0]&&a[0].setOpacity(t.getOpacity()/100)}},addMapLayerToMap:function(e,t){var i=this.getMapLayer();if(e.isLayerOfType("VECTOR")&&e.getId()==i.getId()){var a=this._map.getLayersByName("Markers");this._map.removeLayer(a[0],!1);var n=new OpenLayers.StyleMap,s={styleMap:n},r=e.getStyledLayerDescriptor();if(r){this._sandbox.printDebug(r);var o=this._sldFormat.read(r);window.styleInfo=o;var l=o.namedLayers[0].userStyles,u=l[0];n.styles["default"]=u}else this._sandbox.printDebug("NO SLD FOUND");var c=new OpenLayers.Layer.Vector("layer_"+e.getId(),s);c.opacity=e.getOpacity()/100,this._map.addLayer(c),this._features&&c.addFeatures(this._features),this._sandbox.printDebug("#!#! CREATED VECTOR / OPENLAYER.LAYER.VECTOR for "+e.getId()),t?this._map.setLayerIndex(c,this._map.layers.length):this._map.setLayerIndex(c,0),this._map.addLayer(a[0])}},removeMapLayerFromMap:function(e){var t=this.getMapLayer();if(e.isLayerOfType("VECTOR")&&e.getId()==t.getId()){var i=this._map.getLayersByName("layer_"+e.getId());i[0].destroy()}},getOLMapLayers:function(e){if(e.isLayerOfType("VECTOR")){var t=this.getMapLayer();if(e.getId()==t.getId())return this._map.getLayersByName("layer_"+e.getId())}},handleFeaturesAvailableEvent:function(e){var t=e.getMapLayer();if(null!=t){var i=this.getMapLayer();if(t.getId()==i.getId()){var a=e.getMimeType(),n=e.getFeatures(),s=e.getOp(),r=this._supportedFormats[a];if(r){var o=r.read(n);this._features=o;var l=this._map.getLayersByName("layer_"+t.getId())[0];l&&(s&&"replace"==s&&l.removeFeatures(l.features),l.addFeatures(o))}}}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.FeatureDataBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.FeatureDataBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/PopupHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/plugin/MapSelectionPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/event/FinishedDrawingEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/event/AddedFeatureEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/plugin/FeaturedataPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/service/GridJsonService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/service/GridModelManager.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/domain/WfsGridUpdateParams.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/request/ShowFeatureDataRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/request/ShowFeatureDataRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/featuredata/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"featuredata","Bundle-Name":"featuredata","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("featuredata","Oskari.mapframework.bundle.featuredata.FeatureDataBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.FeatureDataBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.popupHandler=null,this.selectionPlugin=null,this.geometry=null},{__name:"FeatureData",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;
if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,a.register(e);for(var n in e.eventHandlers)a.registerForEventByName(e,n);var s=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,s),e.createUi();var r=this.getLocalization("popup");if(this.conf&&this.conf.selectionTools===!0){this.popupHandler=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.PopupHandler",this);var o=a.getRequestBuilder("Toolbar.AddToolButtonRequest"),l={iconCls:"tool-feature-selection",tooltip:r.tools.select.tooltip,sticky:!1,callback:function(){e.popupHandler.showSelectionTools()}};a.request(this,o("dialog","selectiontools",l))}for(var u=a.findAllSelectedMapLayers(),c=0;c<u.length;++c)u[c].isLayerOfType("WFS")&&(this.plugin.update(),this.plugins["Oskari.userinterface.Flyout"].layerAdded(u[c]));a.addRequestHandler("ShowFeatureDataRequest",this.requestHandlers.showFeatureHandler)}},init:function(){var e=this;return this.requestHandlers={showFeatureHandler:Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.request.ShowFeatureDataRequestHandler",e)},this.service=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.service.GridJsonService",this.sandbox.getAjaxUrl()),null},getService:function(){return this.service},getSelectionPlugin:function(){return this.selectionPlugin},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(e){e.getMapLayer().isLayerOfType("WFS")&&(this.plugin.update(),this.plugins["Oskari.userinterface.Flyout"].layerRemoved(e.getMapLayer()))},AfterMapLayerAddEvent:function(e){e.getMapLayer().isLayerOfType("WFS")&&(this.plugin.update(),this.plugins["Oskari.userinterface.Flyout"].layerAdded(e.getMapLayer()))},AfterMapMoveEvent:function(){this.setGeometry(null);var e=this.getSelectionPlugin().getFullScreenSelection();this.plugins["Oskari.userinterface.Flyout"].updateGrid(e)},WFSFeaturesSelectedEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].featureSelected(e)},"userinterface.ExtensionUpdatedEvent":function(e){var t=this.plugins["Oskari.userinterface.Flyout"];if(e.getExtension().getName()===this.getName())if("close"===e.getViewState())this.setGeometry(null),t.setEnabled(!1);else if(!t.isEnabled()){var i=this.geometry;i?this.setGeometry(null):i=this.getSelectionPlugin().getFullScreenSelection(),t.setEnabled(!0,i)}}},setGeometry:function(e){this.geometry=e},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.Flyout",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi();var e=this.sandbox.findRegisteredModuleInstance("MainMapModule"),t=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.plugin.FeaturedataPlugin",{instance:this});e.registerPlugin(t),e.startPlugin(t),this.plugin=t;var i={id:"FeatureData"};this.selectionPlugin=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.plugin.MapSelectionPlugin",i),e.registerPlugin(this.selectionPlugin),e.startPlugin(this.selectionPlugin)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.PopupHandler",function(e){this.instance=e,this.localization=e.getLocalization("popup"),this.templateContent=jQuery("<div></div>"),this.templateEditDialogContent=jQuery("<div></div>"),this.templateEditButtons=jQuery("<div></div>"),this.templateToolsButton=jQuery('<div style= "display: inline-block; border: 1px solid;"></div>'),this.templateInstructions=jQuery("<div class='instructions' style= 'padding: 20px 0px 0px 0px;'></div>"),this.templateLink=jQuery("<div class='link'><a href='JavaScript:void(0);'></a></div></div>");var t=this,i=t.instance.getSelectionPlugin();this.buttons={point:{iconCls:"selection-point",tooltip:t.localization.tools.point.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"point"})}},line:{iconCls:"selection-line",tooltip:t.localization.tools.line.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"line"})}},polygon:{iconCls:"selection-area",tooltip:t.localization.tools.polygon.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"polygon"})}},square:{iconCls:"selection-square",tooltip:t.localization.tools.square.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"square"})}},circle:{iconCls:"selection-circle",tooltip:t.localization.tools.circle.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"circle"})}}}},{showSelectionTools:function(){var e=this;e.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e.instance,"close"]);var t=function(t){return function(){e.buttons[t].callback(),i.close(),e._selectionStarted()}},i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),a=this.localization.title,n=this.templateContent.clone();for(var s in this.buttons){var r=this.templateToolsButton.clone(),o=this.buttons[s];r.attr("title",o.tooltip),r.addClass(o.iconCls),r.bind("click",t(s)),n.append(r)}var l=this.templateInstructions.clone();l.append(this.localization.instructions),n.append(l);var u=i.createCloseButton(this.localization.button.cancel);u.addClass("primary"),i.addClass("tools_selection"),i.show(a,n,[u]),i.moveTo("#toolbar div.toolrow[tbgroup=selectiontools]","top")},_selectionStarted:function(){var e=this;e._sandbox;var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=e.localization.title,a=e.templateEditDialogContent.clone(),n=e.templateEditButtons.clone(),s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(e.localization.button.edit),s.setHandler(function(){t.close(),e.showSelectionTools(),e.instance.getSelectionPlugin().startDrawing({drawMode:"modify"})}),n.append(s.getButton());var r=t.createCloseButton(e.localization.button.close);n.append(r.getButton()),r.setHandler(function(){t.close(),e.instance.getSelectionPlugin().stopDrawing(),e.showSelectionTools()}),a.append(n);var o=e.templateLink.clone();o.append(e.localization.link.title),o.bind("click",function(){t.close(),e.showSelectionTools()}),a.append(o),e.instance.setGeometry(null);var l=Oskari.clazz.create("Oskari.userinterface.component.Button");l.setTitle(e.localization.button.show),l.addClass("primary showSelection"),l.setHandler(function(){var i=e.instance.getSelectionPlugin().getFeaturesAsGeoJSON();e.instance.setGeometry(i),e.instance.getSelectionPlugin().stopDrawing(),e.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e.instance,"detach"]),t.close()});var u=Oskari.clazz.create("Oskari.userinterface.component.Button");u.setTitle(e.localization.button.cancel),u.setHandler(function(){t.close(),e.instance.getSelectionPlugin().stopDrawing()}),t.show(i,a,[u,l]),t.moveTo("#toolbar div.toolrow[tbgroup=selectiontools]","top")}}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.plugin.MapSelectionPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.drawControls=null,this.drawLayer=null,this.editMode=!1,this.listeners=[],this.currentDrawMode=null,this.prefix="Default.",e&&e.id&&(this.prefix=e.id+"."),e&&e.graphicFill&&(this.graphicFill=e.graphicFill),this.multipart=e&&e.multipart===!0},{__name:"MapSelectionPlugin",getName:function(){return this.prefix+this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+this.__name},addListener:function(e){this.listeners.push(e)},startDrawing:function(e){if(e.isModify)this.modifyControls.modify.selectControl.select(this.drawLayer.features[0]);else if(e.geometry){this.editMode=!0;var t=[new OpenLayers.Feature.Vector(e.geometry)];this.drawLayer.addFeatures(t),this.drawControls.modify.selectControl.select(this.drawLayer.features[0])}else this.editMode=!1,this._toggleControl(e.drawMode)},stopDrawing:function(){this._toggleControl(),this.drawLayer.removeAllFeatures()},setDrawing:function(e){var t=[new OpenLayers.Feature.Vector(e)];this.drawLayer.addFeatures(t)},forceFinishDraw:function(){this._finishedDrawing(!0)},_finishedDrawing:function(e){if((!this.multipart||e)&&this._toggleControl(),!this.editMode){var t=this.drawLayer.features.length-1;this.drawControls.modify.selectControl.select(this.drawLayer.features[t])}var i;!this.multipart||e?(i=this._sandbox.getEventBuilder(this.prefix+"FinishedDrawingEvent")(this.getDrawing(),this.editMode),this._sandbox.notifyAll(i)):(i=this._sandbox.getEventBuilder(this.prefix+"AddedFeatureEvent")(this.getDrawing(),this.currentDrawMode),this._sandbox.notifyAll(i))},_toggleControl:function(e){this.currentDrawMode=e;for(var t in this.drawControls){var i=this.drawControls[t];e==t?i.activate():i.deactivate()}},init:function(){var e=this;if(this.drawLayer=new OpenLayers.Layer.Vector(this.prefix+"FeatureData Draw Layer",{eventListeners:{featuresadded:function(){e._finishedDrawing()}}}),this.drawControls={point:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.Path),polygon:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.Polygon),square:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4}}),circle:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:40}}),modify:new OpenLayers.Control.ModifyFeature(e.drawLayer)},null!=this.graphicFill){var t=this.graphicFill,i=new OpenLayers.Format.SLD,a=i.read(t);if(a&&a.namedLayers)for(var n in a.namedLayers){this.drawLayer.styleMap.styles["default"]=a.namedLayers[n].userStyles[0],this.drawLayer.redraw();break}}this._map.addLayers([e.drawLayer]);for(var s in this.drawControls)this._map.addControl(this.drawControls[s]);this.geojson_format=new OpenLayers.Format.GeoJSON},getDrawing:function(){if(0===this.drawLayer.features.length)return null;var e=this.drawLayer.features[0].geometry.CLASS_NAME;if("OpenLayers.Geometry.MultiPoint"===e||"OpenLayers.Geometry.MultiLineString"===e||"OpenLayers.Geometry.MultiPolygon"===e)return this.drawLayer.features[0].geometry;for(var t=null,i=[],a=0;a<this.drawLayer.features.length;a++)i.push(this.drawLayer.features[a].geometry);switch(e){case"OpenLayers.Geometry.Point":t=new OpenLayers.Geometry.MultiPoint(i);break;case"OpenLayers.Geometry.LineString":t=new OpenLayers.Geometry.MultiLineString(i);break;case"OpenLayers.Geometry.Polygon":t=new OpenLayers.Geometry.MultiPolygon(i)}return t},getFeatures:function(){return this.drawLayer.features},getFeaturesAsGeoJSON:function(){var e=this.geojson_format.write(this.getFeatures()),t=JSON.parse(e);return t.crs=this._getSRS(),t},getFullScreenSelection:function(){var e=this._sandbox.getMap().getBbox(),t=e.toGeometry(),i=this.geojson_format.write(t),a=JSON.parse(i),n={type:"FeatureCollection",crs:this._getSRS(),features:[]},s={type:"Feature",geometry:a,properties:{geom_type:"polygon",buffer_radius:"0"}};return n.features.push(s),n},_getSRS:function(){return{type:"EPSG",properties:{code:3067}}},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this)},stopPlugin:function(e){e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.event.FinishedDrawingEvent",function(e,t){this._drawing=e,this._modification=1==t},{__name:"FeatureData.FinishedDrawingEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},isModification:function(){return this._modification}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.event.AddedFeatureEvent",function(e,t){this._drawing=e,this._drawingMode=t},{__name:"FeatureData.AddedFeatureEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},getDrawingMode:function(){return this._drawingMode}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.layers={},this.tabsContainer=null,this.modelMngr=null,this.selectedTab=null,this.active=!1,this.mapDivId="#mapdiv",this.templateLink=jQuery('<a href="JavaScript:void(0);"></a>'),this.resizable=!0,this.resizing=!1,this.resized=!1},{getName:function(){return"Oskari.mapframework.bundle.featuredata.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("featuredata")||jQuery(this.container).addClass("featuredata")},startPlugin:function(){this.tabsContainer=Oskari.clazz.create("Oskari.userinterface.component.TabContainer",this.instance.getLocalization("nodata")),this.modelMngr=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.service.GridModelManager");var e=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule"),t=e.getMap().div;t&&(this.mapDivId=t)},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},setResizable:function(e){this.resizable=e},createUi:function(){var e=this,t=jQuery(this.container);t.empty();var i=this.instance.sandbox,a=i.getRequestBuilder("DimMapLayerRequest"),n=i.getRequestBuilder("HighlightMapLayerRequest");this.tabsContainer.addTabChangeListener(function(t,s){if(t){e.instance.getService().cancelWFSGridUpdateForLayer(t.layer.getId());var r=a(t.layer.getId());i.request(e.instance.getName(),r)}if(e.selectedTab=s,s&&(e._updateData(s.layer),e.active)){var r=n(s.layer.getId());i.request(e.instance.getName(),r)}}),this.tabsContainer.insertTo(t)},layerAdded:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.TabPanel");t.setTitle(e.getName()),t.getContainer().append(this.instance.getLocalization("loading")),t.layer=e,this.layers[""+e.getId()]=t,this.tabsContainer.addPanel(t)},layerRemoved:function(e){var t=""+e.getId();this.instance.getService().cancelWFSGridUpdateForLayer(t);var i=this.layers[t];this.tabsContainer.removePanel(i),i.grid=null,delete i.grid,i.layer=null,delete i.layer,this.layers[t]=null,delete this.layers[t]},_updateData:function(e,t){if(this.active){this.instance.getService().cancelWFSGridUpdateForLayer(e.getId());var i=this.instance.sandbox.getMap(),a=this.layers[""+e.getId()],n=null;if(a.grid&&(n=a.grid.getSelection()),a.getContainer().empty(),!e.isInScale(i.getScale()))return a.getContainer().append(this.instance.getLocalization("errorscale")),void 0;a.getContainer().append(this.instance.getLocalization("loading"));var s=this,r=i.getWidth(),o=i.getHeight(),l=function(t){if(s._prepareData(e,t),n)for(var i=0;i<n.length;++i)a.grid.select(n[i].featureId,!0)};this.instance.getService().scheduleWFSGridUpdate(e,t,r,o,l)}},updateGrid:function(e){this.selectedTab&&(e=JSON.stringify(e),this._updateData(this.selectedTab.layer,e))},_enableResize:function(){var e=this,t=jQuery("div.oskari-flyoutcontent.featuredata"),i=t.parent().parent(),a=t.parent();t.find("div.tabsContent");var n=0,s=0;i.find("div.tab-content").css({"padding-top":"1px","padding-right":"1px"});var r=jQuery("<div/>");r.addClass("flyout-resizer");var o=16;r.removeClass("allowHover"),r.addClass("icon-drag"),r.bind("dragstart",function(e){e.preventDefault()}),r.mousedown(function(t){e.resizing||(e.resizing=!0,n=t.pageX-i[0].offsetWidth-i[0].offsetLeft,s=t.pageY-i[0].offsetHeight-i[0].offsetTop,jQuery(document).attr("unselectable","on").css("user-select","none").on("selectstart",!1))}),jQuery(document).mouseup(function(){e.resizing=!1,e.resized=!0}),jQuery(document).mousemove(function(t){if(e.resizing){var r=100,l=60,u=i.offset(),c=a.offset();if(t.pageX>u.left){var h=t.pageX-u.left-n;i.css("max-width",h.toString()+"px"),i.css("width",h.toString()+"px")}if(t.pageY-u.top>r){var d=t.pageY-u.top-s;i.css("max-height",d.toString()+"px"),i.css("height",d.toString()+"px");var p=t.pageY-c.top-s;a.css("max-height",(p-o).toString()+"px"),a.css("height",(p-o).toString()+"px");var f=jQuery("div.oskari-flyoutcontent.featuredata").find("div.tabsContent"),m=t.pageY-f[0].offsetTop-o-l;i.find("div.tab-content").css("max-height",m.toString()+"px")}}}),i.find("div.oskari-flyoutcontent").css("padding-bottom","5px"),0===jQuery("div.flyout-resizer").length&&i.append(r)},_prepareData:function(e,t){var i=this,a=this.layers[""+e.getId()],n=this.tabsContainer.isSelected(a);if(n){var s=this.modelMngr.getData(t);if(a.getContainer().empty(),!s)return a.getContainer().append(this.instance.getLocalization("errordata")),void 0;var r=s.all;r.setIdField("featureId");var o=r.getFields();if(!a.grid){var l=Oskari.clazz.create("Oskari.userinterface.component.Grid",this.instance.getLocalization("columnSelectorTooltip"));l.setColumnUIName("__featureName",this.instance.getLocalization("featureNameAll")),l.addSelectionListener(function(t,a){i._handleGridSelect(e,a)});var u=this.instance.getLocalization("showmore");l.setAdditionalDataHandler(u,function(e,t){var i=Oskari.clazz.create("Oskari.userinterface.component.Popup");i.show(u,t),i.moveTo(e,"bottom")});for(var c=[],h=0;h<o.length;++h)"featureId"!=o[h]&&"qName"!=o[h]&&c.push(o[h]);l.setVisibleFields(c),l.setColumnSelector(!0),l.setResizableColumns(!0),a.grid=l}a.grid.setDataModel(r),a.grid.renderTo(a.getContainer());var d=jQuery(i.mapDivId),p=jQuery("div.oskari-flyoutcontent.featuredata"),f=p.parent().parent();i.resized||(f.find("div.tab-content").css("max-height",(d.height()/4).toString()+"px"),f.css("max-width",d.width().toString()+"px")),i.resizable&&this._enableResize()}},_handleGridSelect:function(e,t,i){var a=this.instance.sandbox,n=[t],s=a.getEventBuilder("WFSFeaturesSelectedEvent");void 0===i&&(i=a.isCtrlKeyDown());var r=s(n,e,i);a.notifyAll(r)},featureSelected:function(e){if(this.active){var t=e.getMapLayer(),i=this.layers[""+t.getId()],a=e.getWfsFeatureIds()[0];i.grid&&i.grid.select(a,e.isKeepSelection())}},isEnabled:function(){return this.active===!0},setEnabled:function(e,t){if(this.active==e)return t&&this.updateGrid(t),void 0;this.active=e===!0;var i=this.instance.sandbox,a=i.getRequestBuilder("MapModulePlugin.GetFeatureInfoActivationRequest");if(a&&i.request(this.instance.getName(),a(!this.active)),this.active){if(this.selectedTab){var n=i.getRequestBuilder("HighlightMapLayerRequest"),s=n(this.selectedTab.layer.getId());i.request(this.instance.getName(),s),this.updateGrid(t)}}else{if(this.selectedTab){this.instance.getService().cancelWFSGridUpdateForLayer(this.selectedTab.layer.getId());var r=i.getRequestBuilder("DimMapLayerRequest"),s=r(this.selectedTab.layer.getId());i.request(this.instance.getName(),s)}for(var o in this.layers)o.getContainer&&o.getContainer().empty()}}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.plugin.FeaturedataPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._conf=e,this.__elements={},this.__templates={},this.instance=e.instance},{__name:"FeaturedataPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this.__templates.main=jQuery('<div class="mapplugin featuredataplugin"><a href="JavaScript: void(0);"></a></div>')},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this),this._createUI();for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);this.__elements.main&&(this.__elements.main.remove(),delete this.__elements.main),e.unregister(this)},start:function(){},stop:function(){},_createUI:function(){this._sandbox;var e=this,t=jQuery(this._map.div);e.__elements.main||(e.__elements.main=e.__templates.main.clone());var i=e.__elements.main.find("a");i.html(this.instance.getLocalization("title")),i.bind("click",function(){return e.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e.instance,"detach"]),!1}),e.__elements.main.mousedown(function(e){e.stopPropagation()}),t.append(e.__elements.main),this.update()},update:function(){for(var e=this.mapModule.getSandbox(),t=e.findAllSelectedMapLayers(),i=0,a=0;a<t.length;a++){var n=t[a];n.isLayerOfType("WFS")&&i++}var s=this;i>0?s.__elements.main.show():s.__elements.main.hide()},eventHandlers:{AfterMapMoveEvent:function(){this.update()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.service.GridJsonService",function(e){this._gridPollingInterval=200,this.endpointUrl=e,this.pendingOperations={},this._wfsTableQueryId=0},{__qname:"Oskari.mapframework.bundle.featuredata.service.GridJsonService",getQName:function(){return this.__qname},__name:"GridJsonService",getName:function(){return this.__name},cancelWFSGridUpdateForLayer:function(e){var t=this.pendingOperations[e];t&&(t.timer&&clearTimeout(t.timer),t.query&&t.query.abort(),this.pendingOperations[e]=null,delete this.pendingOperations[e])},scheduleWFSGridUpdate:function(e,t,i,a,n){this.cancelWFSGridUpdateForLayer(e.getId());var s=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.domain.WfsGridUpdateParams",e,t,i,a,n),r=this,o=setTimeout(function(){r._processGridUpdate(s)},this._gridPollingInterval);this.pendingOperations[e.getId()]={timer:o}},_processGridUpdate:function(e){var t=this,i=e.getMapLayer();this.pendingOperations[i.getId()].timer=null,delete this.pendingOperations[i.getId()].timer;var a=function(a){t.cancelWFSGridUpdateForLayer(i.getId()),a.error||t._getLatestWfsTableQueryId()==parseInt(a.wfsQueryId)&&e.getCallback()(a)},n=jQuery.ajax({dataType:"json",type:"POST",data:{layerIds:i.getId(),flow_pm_map_width:e.getMapWidth(),flow_pm_map_height:e.getMapHeight(),mode:"data_to_table",geojson:e.getGeometry(),flow_pm_map_wfs_query_id:t._generateWfsTableQueryId()},beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:this.endpointUrl+"action_route=GetWfsFeatureData",success:a});this.pendingOperations[i.getId()].query=n},_getLatestWfsTableQueryId:function(){return this._wfsTableQueryId},_generateWfsTableQueryId:function(){return this._wfsTableQueryId++,this._wfsTableQueryId}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.service.GridModelManager",function(){},{getData:function(e){if(!this._isValidData(e))return!1;var t=this._getModels(e);if(e.featureDatas.length<2)for(var i in t)t.all=t[i];else{var a="__featureName",n=Oskari.clazz.create("Oskari.userinterface.component.GridModel");n._addField(a);for(var i in t){for(var s=t[i],r=s.getFields(),o=0;o<r.length;o++){var l=r[o],u=this._findInList(n.getFields(),l);-1===u&&n._addField(l)}for(var e=s.getData(),o=0;o<e.length;o++){var c=e[o];c[a]=i,n.addData(c)}}t.all=n}return t},_isValidData:function(e){if(!e||!e.headers||!e.featureDatas)return!1;for(var t=0;t<e.featureDatas.length;t++)if(null==e.featureDatas[t].children)return!1;return!0},_findInList:function(e,t){for(var i=0;i<e.length;++i)if(e[i]==t)return i;return-1},_getModels:function(e){for(var t=Oskari.getLang(),i={},a=0;a<e.featureDatas.length;a++){var n=e.featureDatas[a],s=this._getIndividualModel(n),r=n["feature_"+t];i[r]=s}return i},_getIndividualModel:function(e){for(var t=Oskari.clazz.create("Oskari.userinterface.component.GridModel"),i=0;i<e.children.length;i++)t.addData(e.children[i]);return t}}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.domain.WfsGridUpdateParams",function(e,t,i,a,n){this._geometry=t,this._mapWidth=i,this._mapHeight=a,this._mapLayer=e,this._onReady=n},{getMapLayer:function(){return this._mapLayer},getGeometry:function(){return this._geometry},getMapWidth:function(){return this._mapWidth},getMapHeight:function(){return this._mapHeight},getCallback:function(){return this._onReady}}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.request.ShowFeatureDataRequest",function(e){this._id=e},{__name:"ShowFeatureDataRequest",getName:function(){return this.__name},getId:function(){return this._id}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.request.ShowFeatureDataRequestHandler",function(e){this.featureData=e},{handleRequest:function(e,t){for(var i=t.getId(),a=this.featureData.plugins["Oskari.userinterface.Flyout"],n=a.tabsContainer.panels,s=0;s<n.length;s++)if(n[s].layer.getId()===i){a.tabsContainer.select(n[s]);break}this.featureData.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[this.featureData,"detach"])}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.framework.bundle.guidedtour.GuidedTourBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.framework.bundle.guidedtour.GuidedTourBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/instance.js"},{type:"text/javascript",src:"../../../../libraries/jquery/plugins/jquery.cookie.js"},{type:"text/css",src:"../../../../resources/framework/bundle/guidedtour/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"guidedtour","Bundle-Name":"guidedtour","Bundle-Author":[{Name:"ev",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("guidedtour","Oskari.framework.bundle.guidedtour.GuidedTourBundle"),Oskari.clazz.define("Oskari.framework.bundle.guidedtour.GuidedTourBundleInstance",function(){this.sandbox=null,this._localization=null,this.mediator=null,this.guideStep=0},{__name:"GuidedTour",getName:function(){return this.__name},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},getSandbox:function(){return this.sandbox},update:function(){},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){if("1"!=jQuery.cookie("pti_tour_seen")){var e=this,t=e.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);this.sandbox=a,this.localization=Oskari.getLocalization(this.getName()),a.register(e),e._startGuide()}},_startGuide:function(){this.guideStep=0;var e="Oskari.userinterface.component.Popup",t=Oskari.clazz.create(e);t.makeDraggable(),t.addClass("guidedtour"),this._showGuideContentForStep(this.guideStep,t)},_guideSteps:[{appendTourSeenCheckbox:!0,setScope:function(e){this.ref=e},getTitle:function(){return this.ref.getLocalization("page1").title},getContent:function(){var e=this.ref;e.getLocalization("page1");var t=jQuery("<div></div>");return t.append(this.ref.getLocalization("page1").message),t}},{setScope:function(e){this.ref=e},getTitle:function(){return""+this.ref.getLocalization("page2").title+"<span>1/8</span>"},getContent:function(){var e=this.ref;e._openExtension("Search");var t=e.getLocalization("page2"),i=jQuery("<div></div>");i.append(t.message);var a=jQuery('<a href="#"></a>'),n=a.clone();n.append(t.openLink),n.bind("click",function(){e._openExtension("Search"),n.hide(),s.show()});var s=a.clone();return s.append(t.closeLink),s.bind("click",function(){e._closeExtension("Search"),n.show(),s.hide()}),i.append("<br /><br />"),i.append(n),i.append(s),s.show(),n.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page3").title;return e+"<span>2/8</span>"},getContent:function(){var e=this.ref;e._openExtension("LayerSelector");var t=e.getLocalization("page3"),i=jQuery("<div></div>");i.append(t.message);var a=jQuery('<a href="#"></a>'),n=a.clone();n.append(t.openLink),n.bind("click",function(){e._openExtension("LayerSelector"),n.hide(),s.show()});var s=a.clone();return s.append(t.closeLink),s.bind("click",function(){e._closeExtension("LayerSelector"),n.show(),s.hide()}),i.append("<br><br>"),i.append(n),i.append(s),s.show(),n.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page4").title;return e+"<span>3/8</span>"},getContent:function(){var e=this.ref;e._openExtension("LayerSelection");var t=e.getLocalization("page4"),i=jQuery("<div></div>");i.append(t.message);var a=jQuery('<a href="#"></a>'),n=a.clone();n.append(t.openLink),n.bind("click",function(){e._openExtension("LayerSelection"),n.hide(),s.show()});var s=a.clone();return s.append(t.closeLink),s.bind("click",function(){e._closeExtension("LayerSelection"),n.show(),s.hide()}),i.append("<br><br>"),i.append(n),i.append(s),s.show(),n.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page5").title;return e+"<span>4/8</span>"},getContent:function(){var e=this.ref;e._openExtension("PersonalData");var t=e.getLocalization("page5"),i=jQuery("<div></div>");i.append(t.message);var a=jQuery('<a href="#"></a>'),n=a.clone();n.append(t.openLink),n.bind("click",function(){e._openExtension("PersonalData"),n.hide(),s.show()});var s=a.clone();return s.append(t.closeLink),s.bind("click",function(){e._closeExtension("PersonalData"),n.show(),s.hide()}),i.append("<br><br>"),i.append(n),i.append(s),s.show(),n.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page6").title;return e+"<span>5/8</span>"},getContent:function(){var e=this.ref;e._openExtension("Publisher");var t=e.getLocalization("page6"),i=jQuery("<div></div>");i.append(t.message);var a=jQuery('<a href="#"></a>'),n=a.clone();n.append(t.openLink),n.bind("click",function(){e._openExtension("Publisher"),n.hide(),s.show()});var s=a.clone();return s.append(t.closeLink),s.bind("click",function(){e._closeExtension("Publisher"),n.show(),s.hide()}),i.append("<br><br>"),i.append(n),i.append(s),s.show(),n.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page7").title;return e+"<span>6/8</span>"},getContent:function(){var e=this.ref;e._closeExtension("Publisher");var t=e.getLocalization("page7"),i=jQuery("<div></div>");return i.append(t.message),i},getPositionRef:function(){return jQuery("#toolbar")},positionAlign:"right"},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page8").title;
return e+"<span>7/8</span>"},getContent:function(){var e=this.ref,t=e.getLocalization("page8"),i=jQuery("<div></div>");return i.append(t.message),i},getPositionRef:function(){return jQuery(".panbuttonDiv")},positionAlign:"left"},{appendTourSeenCheckbox:!0,setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page9").title;return e+"<span>8/8</span>"},getContent:function(){var e=this.ref,t=e.getLocalization("page9"),i=jQuery("<div></div>");return i.append(t.message),i},getPositionRef:function(){return jQuery(".pzbDiv")},positionAlign:"left"}],_showGuideContentForStep:function(e,t){var i=this._guideSteps[e];i.setScope(this);var a=this._getDialogButton(t),n=i.getTitle(),s=i.getContent();if(i.appendTourSeenCheckbox){s.append("<br><br>");var r=jQuery('<input type="checkbox" name="pti_tour_seen" id="pti_tour_seen" value="1">'),o=r.clone(),l=jQuery('<label for="pti_tour_seen"></label>'),u=l.clone();u.append(this.getLocalization("tourseen").label),o.bind("change",function(){jQuery(this).attr("checked")?jQuery.cookie("pti_tour_seen","1",{expires:365}):jQuery.cookie("pti_tour_seen","0",{expires:1})}),s.append(o),s.append("&nbsp;"),s.append(u)}t.show(n,s,a),i.getPositionRef?t.moveTo(i.getPositionRef(),i.positionAlign):t.resetPosition()},_getFakeExtension:function(e){return{getName:function(){return e}}},_openExtension:function(e){var t=this._getFakeExtension(e),i="userinterface.UpdateExtensionRequest";this.sandbox.postRequestByName(i,[t,"attach"])},_closeExtension:function(e){var t=this._getFakeExtension(e),i="userinterface.UpdateExtensionRequest";this.sandbox.postRequestByName(i,[t,"close"])},_getDialogButton:function(e){var t=this,i=[],a="!button.close!";this.localization&&this.localization.button&&this.localization.button.previous&&(a=this.localization.button.close);var n=e.createCloseButton(a);if(i.push(n),this.guideStep>1){var s="Oskari.userinterface.component.Button",r=Oskari.clazz.create(s),o="!button.previous!";this.localization&&this.localization.button&&this.localization.button.previous&&(o=this.localization.button.previous),r.setTitle(o),r.setHandler(function(){t.guideStep--,t._showGuideContentForStep(t.guideStep,e)}),i.push(r)}if(0==this.guideStep){var s="Oskari.userinterface.component.Button",l=Oskari.clazz.create(s),u="!button.start!";this.localization&&this.localization.button&&this.localization.button.start&&(u=this.localization.button.start),l.setTitle(u),l.setHandler(function(){t.guideStep++,t._showGuideContentForStep(t.guideStep,e)}),i.push(l)}else if(this.guideStep<this._guideSteps.length-1){var s="Oskari.userinterface.component.Button",c=Oskari.clazz.create(s),h="!button.next!";this.localization&&this.localization.button&&this.localization.button.start&&(h=this.localization.button.next),c.setTitle(h),c.setHandler(function(){t.guideStep++,t._showGuideContentForStep(t.guideStep,e)}),i.push(c),e.addClass("bluetitle")}else if(this.guideStep==this._guideSteps.length-1){var d="!button.finish!";this.localization&&this.localization.button&&this.localization.button.start&&(d=this.localization.button.finish);var p=e.createCloseButton(d);i.push(p)}return i},init:function(){return null},onEvent:function(e){var t=this,i=t.eventHandlers[e.getName()];if(!i){var a=i.apply(this,[e]);if(a)return a}return null},eventHandlers:{},stop:function(){var e=this;e.sandbox(),e.sandbox.unregister(e)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),function(e,t,i){function a(e){return e}function n(e){return decodeURIComponent(e.replace(s," "))}var s=/\+/g,r=e.cookie=function(s,o,l){if(o!==i){if(l=e.extend({},r.defaults,l),null===o&&(l.expires=-1),"number"==typeof l.expires){var u=l.expires,c=l.expires=new Date;c.setDate(c.getDate()+u)}return o=r.json?JSON.stringify(o):String(o),t.cookie=[encodeURIComponent(s),"=",r.raw?o:encodeURIComponent(o),l.expires?"; expires="+l.expires.toUTCString():"",l.path?"; path="+l.path:"",l.domain?"; domain="+l.domain:"",l.secure?"; secure":""].join("")}for(var h,d=r.raw?a:n,p=t.cookie.split("; "),f=0;h=p[f]&&p[f].split("=");f++)if(d(h.shift())===s){var m=d(h.join("="));return r.json?JSON.parse(m):m}return null};r.defaults={},e.removeCookie=function(t,i){return null!==e.cookie(t)?(e.cookie(t,null,i),!0):!1}}(jQuery,document),Oskari.clazz.define("Oskari.mapframework.bundle.backendstatus.BackendStatusBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.backendstatus.BackendStatusBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/backendstatus/instance.js"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/backendstatus/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/backendstatus/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/backendstatus/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"backendstatus","Bundle-Name":"backendstatus","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"backendstatus",Title:"backendstatus"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("backendstatus","Oskari.mapframework.bundle.backendstatus.BackendStatusBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.backendstatus.BackendStatusBundleInstance",function(){this._localization=null,this._sandbox=null,this._started=!1,this._pendingAjaxQuery={busy:!1,jqhr:null,timestamp:null},this.timeInterval=this.ajaxSettings.defaultTimeThreshold,this.backendStatus={},this.backendExtendedStatus={},this.gotStartupEvent=!1,this.gotStartupTimeoutEvent=!1,this.gotStartupProcessCall=!1,this._mapLayerService=null},{ajaxSettings:{defaultTimeThreshold:15e3},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},__name:"BackendStatus",getName:function(){return this.__name},setSandbox:function(e){this._sandbox=e},getSandbox:function(){return this._sandbox},getAjaxUrl:function(e,t){var i=this.getSandbox().getAjaxUrl(),a=null;return a=t?i+"action_route=GetBackendStatus&Subset=AllKnown":i+"action_route=GetBackendStatus&Subset=Alert"},start:function(){var e=this;if(!e._started){e._started=!0;var t=e.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e._sandbox=a,e._mapLayerService=a.getService("Oskari.mapframework.service.MapLayerService"),a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p);e._mapLayerService.isAllLayersLoaded()&&!e.gotStartupProcessCall&&e.updateBackendStatus(!0)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},extensionsByName:{LayerSelector:!0},extensionStatesByName:{attach:!0,detach:!0},eventHandlers:{"userinterface.ExtensionUpdatedEvent":function(e){var t=e.getExtension();if(t){var i=t.getName();if(i&&this.extensionsByName[i]){var a=e.getViewState();this.extensionStatesByName[a]&&this.updateBackendStatus()}}},AfterShowMapLayerInfoEvent:function(e){var t=e.getMapLayer(),i=t.getId();t.getBackendStatus();var a=this.backendExtendedStatus[i];if(!a)return this.showFeedbackDialog("missing_backendstatus_information"),void 0;var n=a.infourl;return n?(this.openURLinWindow(n),void 0):(this.showFeedbackDialog("missing_backendstatus_infourl"),void 0)},MapLayerEvent:function(e){if(null==e.getLayerId()&&"add"==e.getOperation()){var t=this;t.gotStartupEvent=!0,window.setTimeout(function(){t.gotStartupTimeoutEvent=!0,t.updateBackendStatus(!0)},15)}}},showFeedbackDialog:function(e){var t=this.getLocalization("feedback")[e],i=Oskari.clazz.create("Oskari.userinterface.component.Popup");i.show(t.title,t.message),i.fadeout()},openURLinWindow:function(e){var t="location=1,status=1,scrollbars=1,width=850,height=1200",i=e;window.open(i,"BackendStatus",t)},stop:function(){var e=this,t=e._sandbox;e._cancelAjaxRequest();for(p in e.eventHandlers)t.unregisterFromEventByName(this,p);t.unregister(this),this._started=!1,this._sandbox=null},getTitle:function(){return"Backend Status"},getDescription:function(){return"Backend Status"},_cancelAjaxRequest:function(){var e=this;if(e._pendingAjaxQuery.busy){var t=e._pendingAjaxQuery.jqhr;e._pendingAjaxQuery.jqhr=null,t&&(this._sandbox.printDebug("[BackendStatus] Abort jqhr ajax request"),t.abort(),t=null,e._pendingAjaxQuery.busy=!1)}},_startAjaxRequest:function(e){var t=this;t._pendingAjaxQuery.busy=!0,t._pendingAjaxQuery.timestamp=e},_finishAjaxRequest:function(){var e=this;e._pendingAjaxQuery.busy=!1,e._pendingAjaxQuery.jqhr=null,this._sandbox.printDebug("[BackendStatus] finished jqhr ajax request")},_notifyAjaxFailure:function(){var e=this;e._sandbox.printDebug("[BackendStatus] BackendStatus AJAX failed"),e._processResponse({backendstatus:[]})},_isAjaxRequestBusy:function(){var e=this;return e._pendingAjaxQuery.busy},updateBackendStatus:function(e){var t=this;t.gotStartupProcessCall=t.gotStartupProcessCall||e;var i=t._sandbox;if(!e&&t._pendingAjaxQuery.busy)return i.printDebug("[BackendStatus] updateBackendStatus NOT SENT previous query is busy"),void 0;var a=new Date,n=a.getTime();if(!e&&t._pendingAjaxQuery.timestamp&&n-t._pendingAjaxQuery.timestamp<t.timeInterval)return i.printDebug("[BackendStatus] updateBackendStatus NOT SENT (time difference < "+t.timeInterval+"ms)"),void 0;t._cancelAjaxRequest(),t._startAjaxRequest(n);var s=t.getAjaxUrl(null,e);jQuery.ajax({beforeSend:function(e){t._pendingAjaxQuery.jqhr=e,e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(i){t._finishAjaxRequest(),t._processResponse(i,e)},error:function(){t._finishAjaxRequest(),t._notifyAjaxFailure()},always:function(){t._finishAjaxRequest()},complete:function(){t._finishAjaxRequest()},data:{},type:"POST",dataType:"json",url:s})},_processResponse:function(e,t){var i=this,a=this._sandbox;if(!e)return a.printDebug("[BackendStatus] empty data from server"),void 0;var n=e.backendstatus;if(!n||void 0==n.length)return a.printDebug("[BackendStatus] backendStatus NO data"),void 0;for(var s=a.getEventBuilder("MapLayerEvent"),r={},o=t?{}:this.backendExtendedStatus,l=0;l<n.length;l++){var u=n[l],c=u.maplayer_id;this.backendStatus[c]?this.backendStatus[c].status!=u.status?(r[c]={status:u.status,changed:!0},o[c]=u):(r[c]={status:u.status,changed:!1},o[c]=u):(r[c]={status:u.status,changed:!0},o[c]=u)}for(p in this.backendStatus)r[p]||null==this.backendStatus[p].status||(r[p]={status:null,changed:!0});this.backendExtendedStatus=o;var h={};for(p in r){this.backendStatus[p]=r[p];var d=a.findMapLayerFromAllAvailable(p);d&&(d.setBackendStatus(this.backendStatus[p].status),(r[p].changed||"DOWN"==d.getBackendStatus())&&(h[p]=d))}if(t)i._pendingAjaxQuery.timestamp=null,i.backendStatus={};else for(p in h){var f=s(p,"update");a.notifyAll(f)}}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.PrintoutBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.printout.PrintoutBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/jquery.imagesLoaded.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/Tile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/plugin/LegendPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/service/PrintService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/view/StartView.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/view/BasicPrintout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/request/PrintMapRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/request/PrintMapRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/event/PrintableContentEvent.js"},{type:"text/css",src:"../../../../resources/framework/bundle/printout/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"printout","Bundle-Name":"printout","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("printout","Oskari.mapframework.bundle.printout.PrintoutBundle"),function(e,t){"use strict";var i="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";e.fn.imagesLoaded=function(a){function n(){var t=e(d),i=e(p);l&&(p.length?l.reject(c,t,i):l.resolve(c)),e.isFunction(a)&&a.call(o,c,t,i)}function s(e){r(e.target,"error"===e.type)}function r(t,a){t.src!==i&&-1===e.inArray(t,h)&&(h.push(t),a?p.push(t):d.push(t),e.data(t,"imagesLoaded",{isBroken:a,src:t.src}),u&&l.notifyWith(e(t),[a,c,e(d),e(p)]),c.length===h.length&&(setTimeout(n),c.unbind(".imagesLoaded",s)))}var o=this,l=e.isFunction(e.Deferred)?e.Deferred():0,u=e.isFunction(l.notify),c=o.find("img").add(o.filter("img")),h=[],d=[],p=[];return e.isPlainObject(a)&&e.each(a,function(e,t){"callback"===e?a=t:l&&l[e](t)}),c.length?c.bind("load.imagesLoaded error.imagesLoaded",s).each(function(a,n){var s=n.src,o=e.data(n,"imagesLoaded");return o&&o.src===s?(r(n,o.isBroken),void 0):n.complete&&n.naturalWidth!==t?(r(n,0===n.naturalWidth||0===n.naturalHeight),void 0):((n.readyState||n.complete)&&(n.src=i,n.src=s),void 0)}):n(),l?l.promise(o):o}}(jQuery),Oskari.clazz.define("Oskari.mapframework.bundle.printout.PrintoutBundleInstance",function(){this.sandbox=void 0,this.started=!1,this.plugins={},this.localization=void 0,this.printout=void 0,this.buttonGroup="viewtools",this.ignoreEvents=!1,this.dialog=void 0,this.printoutHandler=void 0,this.isMapStateChanged=!0,this.state=void 0,this.geoJson=void 0,this.tileData=void 0,this.printService=void 0,this.legendPlugin=void 0,this.conf={backendConfiguration:{formatProducers:{"application/pdf":"http://wps.paikkatietoikkuna.fi/dataset/map/process/imaging/service/thumbnail/maplink.pdf?","image/png":"http://wps.paikkatietoikkuna.fi/dataset/map/process/imaging/service/thumbnail/maplink.png?"}}}},{__name:"Printout",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,this.localization=Oskari.getLocalization(this.getName()),a.register(e);for(p in e.eventHandlers)a.registerForEventByName(e,p);this.printoutHandler=Oskari.clazz.create("Oskari.mapframework.bundle.printout.request.PrintMapRequestHandler",a,function(){e.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e.instance,"attach"])}),a.addRequestHandler("printout.PrintMapRequest",this.printoutHandler);var n=a.getRequestBuilder("Toolbar.AddToolButtonRequest"),s={print:{iconCls:"tool-print",tooltip:this.localization.btnTooltip,sticky:!0,callback:function(){e.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e,"attach"])}}};for(var r in s)a.request(this,n(r,this.buttonGroup,s[r]));var o=Oskari.clazz.create("Oskari.mapframework.bundle.printout.service.PrintService",e);a.registerService(o),this.printService=o;var l=e.getLocalization(),u=a.findRegisteredModuleInstance("MainMapModule"),c=this.conf.legend,h=Oskari.clazz.create("Oskari.mapframework.bundle.printout.plugin.LegendPlugin",e,c,l);u.registerPlugin(h),u.startPlugin(h),this.legendPlugin=h;var d=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,d),e._createUi(),a.registerAsStateful(this.mediator.bundleId,this),this.tileData={}}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{MapLayerVisibilityChangedEvent:function(){this.printout&&this.printout.isEnabled&&this.isMapStateChanged&&(this.isMapStateChanged=!1,this.getSandbox().printDebug("PRINTOUT REFRESH"),this.printout.refresh(!0))},AfterMapMoveEvent:function(){this.isMapStateChanged=!0,this.printout&&this.printout.isEnabled&&this.printout.refresh(!1),this.isMapStateChanged=!0},AfterMapLayerAddEvent:function(){this.isMapStateChanged=!0,this.printout&&this.printout.isEnabled&&this.printout.refresh(!1)},AfterMapLayerRemoveEvent:function(){this.isMapStateChanged=!0,this.printout&&this.printout.isEnabled&&this.printout.refresh(!1)},AfterChangeMapLayerStyleEvent:function(){this.isMapStateChanged=!0,this.printout&&this.printout.isEnabled&&this.printout.refresh(!1)},"userinterface.ExtensionUpdatedEvent":function(e){var t=this;if(e.getExtension().getName()==t.getName()){var i="close"!=e.getViewState();t.displayContent(i)}},"Printout.PrintableContentEvent":function(e){var t=(e.getContentId(),e.getLayer()),i=t&&t.getId?t.getId():null,a=e.getTileData(),n=e.getGeoJsonData();n&&(this.geoJson=n),a&&i&&(this.tileData[i]=a)}},stop:function(){this.printout&&(this.printout.destroy(),this.printout=void 0),this.geoJson=null,this.tileData=null;var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.removeRequestHandler("printout.PrintMapRequest",this.printoutHandler),this.printoutHandler=null;var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.printout.Flyout",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},_createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi()},setPublishMode:function(e){var t=this,i=jQuery("#contentMap");if(jQuery("#maptools"),1==e){var a=t.sandbox.getRequestBuilder("userinterface.UpdateExtensionRequest")(t,"close",t.getName());t.sandbox.request(t.getName(),a),this.printout||(this.printout=Oskari.clazz.create("Oskari.mapframework.bundle.printout.view.BasicPrintout",this,this.getLocalization("BasicView"),this.conf.backendConfiguration),this.printout.render(i)),this.state&&this.state.form&&this.printout.setState(this.state.form),this.printout.show(),this.printout.setEnabled(!0),this.printout.refresh(!1),this.printout.refresh(!0)}else this.printout&&(this.printout.setEnabled(!1),this.printout.hide(),this.printout&&this.legendPlugin.clearLegendLayers())},displayContent:function(e){e&&this.plugins["Oskari.userinterface.Flyout"].refresh()},setState:function(e){this.state=e},getState:function(){var e=this.state||{};if(this.printout){var t=this.printout.getState();e.form=t}return e}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension","Oskari.userinterface.Stateful"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.view=null},{getName:function(){return"Oskari.mapframework.bundle.printout.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("printout")||jQuery(this.container).addClass("printout")},startPlugin:function(){this.template=jQuery("<div></div>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("flyouttitle")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},createUi:function(){jQuery(this.container),this.view=Oskari.clazz.create("Oskari.mapframework.bundle.printout.view.StartView",this.instance,this.instance.getLocalization("StartView"))},refresh:function(){var e=jQuery(this.container);e.empty(),this.view.render(e)}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.printout.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.plugin.LegendPlugin",function(e,t,i){this.instance=e,this.sandbox=e.sandbox,this.mapModule=null,this.pluginName=null,this.conf=t,this.conf||(this.conf={}),this.locale=i,this.headerLayer=null,this.printAreaLayer=null,this.boxesLayer=null,this._map=null},{__name:"LegendPlugin",__qname:"Oskari.mapframework.bundle.printout.plugin.LegendPlugin",getQName:function(){return this.__qname},getName:function(){return this.pluginName},getMap:function(){return this._map},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this)},stopPlugin:function(e){e.unregister(this)},start:function(){},stop:function(){},init:function(){var e=new OpenLayers.StyleMap({"default":this.conf.printAreaDefault});this.printAreaLayer=new OpenLayers.Layer.Vector("PrintArea",{styleMap:e});var t=new OpenLayers.StyleMap({"default":this.conf.legendBoxDefault});this.headerLayer=new OpenLayers.Layer.Vector("LegendHeader",{styleMap:t});var i=new OpenLayers.StyleMap({"default":this.conf.colorBoxDefault});this.boxesLayer=new OpenLayers.Layer.Vector("LegendBoxes",{styleMap:i})},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this._map=e.getMap(),this.pluginName=e.getName()+this.__name)},plotLegend:function(e,t,i,a){var n=this.getMapModule().getMap();-1==n.getLayerIndex(this.printAreaLayer)?(n.addLayer(this.printAreaLayer),n.setLayerIndex(this.printAreaLayer,10004)):n.raiseLayer(this.printAreaLayer,101),-1==n.getLayerIndex(this.headerLayer)?(n.addLayer(this.headerLayer),n.setLayerIndex(this.headerLayer,10005)):n.raiseLayer(this.headerLayer,102),n.getLayerIndex(-1==this.boxesLayer)?(n.addLayer(this.boxesLayer),n.setLayerIndex(this.boxesLayer,10006)):n.raiseLayer(this.boxesLayer,103),this.clearLegendLayers();var s=this._getLegendGeom(e,t,i,a);return this._plotLegendHeader(e,t,s),this._plotLegendBoxes(e,t,s),this._createPrintGeoJSON()},_maxLayerIndex:function(){for(var e=0,t=this.instance.getSandbox().findAllSelectedMapLayers(),i=0;i<t.length;i++)this.getMapModule().getMap().getLayerIndex(t[i])>e&&(e=this.getMapModule().getMap().getLayerIndex(t[i]));return e},_getLegendGeom:function(e,t,i,a){var n=i.features[0].properties;n.targetWidth,n.targetHeight;var s=i.features[0].geometry.coordinates[0],r=Number(s[1][0])-Number(s[0][0]),o=Number(s[2][1])-Number(s[1][1]),l=[];if(e.length>this.conf.general.charsInrow){for(var u=e.split(" "),c="",h=0;h<u.length;h++)c.length+u[h].length+1<this.conf.general.charsInrow?c=c+u[h]+" ":(l.push(c),c=u[h]);c.length>0&&l.push(c)}else l.push(e);var d=r;o>r&&(d=o);var p=this.conf.general.legendRowHeight*d*(t.length+l.length+1),f=this.conf.general.legendWidth*d,m=p/(t.length+l.length+1),g=[];"LL"==a?(g.push(new OpenLayers.Geometry.Point(s[0][0],s[0][1]+p)),g.push(new OpenLayers.Geometry.Point(s[0][0]+f,s[0][1]+p)),g.push(new OpenLayers.Geometry.Point(s[0][0]+f,s[0][1])),g.push(new OpenLayers.Geometry.Point(s[0][0],s[0][1]))):"LU"==a?(g.push(new OpenLayers.Geometry.Point(s[0][0],s[3][1])),g.push(new OpenLayers.Geometry.Point(s[0][0]+f,s[3][1])),g.push(new OpenLayers.Geometry.Point(s[0][0]+f,s[3][1]-p)),g.push(new OpenLayers.Geometry.Point(s[0][0],s[3][1]-p))):"RU"==a?(g.push(new OpenLayers.Geometry.Point(s[2][0]-f,s[2][1])),g.push(new OpenLayers.Geometry.Point(s[2][0],s[2][1])),g.push(new OpenLayers.Geometry.Point(s[2][0],s[2][1]-p)),g.push(new OpenLayers.Geometry.Point(s[2][0]-f,s[2][1]-p))):"RL"==a&&(g.push(new OpenLayers.Geometry.Point(s[1][0]-f,s[1][1]+p)),g.push(new OpenLayers.Geometry.Point(s[1][0],s[1][1]+p)),g.push(new OpenLayers.Geometry.Point(s[1][0],s[1][1])),g.push(new OpenLayers.Geometry.Point(s[1][0]-f,s[1][1])));for(var y=[],h=0;coordp=s[h++];)y.push(new OpenLayers.Geometry.Point(coordp[0],coordp[1]));var v={print_area:y,bbox:g,rangebox_size:m,properties:n,titles:l};return v},clearLegendLayers:function(){this.headerLayer&&this.headerLayer.removeAllFeatures(),this.boxesLayer&&this.boxesLayer.removeAllFeatures(),this.printAreaLayer&&this.printAreaLayer.removeAllFeatures()},_plotLegendHeader:function(e,t,i){var a=this,n=i.bbox,s=n,r=new OpenLayers.Geometry.LinearRing(s),o=new OpenLayers.Geometry.Polygon([r]),l="\0",u={color:"#FFFFFF",name:l},c=new OpenLayers.Geometry.LineString(i.print_area),h=new OpenLayers.Feature.Vector(c,null);a.printAreaLayer.addFeatures([h]),a.printAreaLayer.redraw();var d=new OpenLayers.Feature.Vector(o,u);a.headerLayer.addFeatures([d]);for(var p=i.titles,f=0;f<p.length;f++){var m=n[0].clone(),g=new OpenLayers.Geometry.Point(m.x+.2*i.rangebox_size,m.y-(f*i.rangebox_size+i.rangebox_size/2)),y={name:p[f]},v=new OpenLayers.Feature.Vector(g,y);a.headerLayer.addFeatures([v])}a.headerLayer.redraw()},_plotLegendBoxes:function(e,t,i){for(var a=this,n="\0",s=i.bbox,r=i.titles,o=i.rangebox_size,l=.8*i.rangebox_size,u=s[0].clone(),c=u.x+.2*o,h=u.y-o*r.length,d=0;d<t.length;d++){var p=t[d],f="#FFFFFF";p.boxcolor.split(":").length>1&&(f=p.boxcolor.split(":")[1]);var m=c,g=h,y=[new OpenLayers.Geometry.Point(m,g),new OpenLayers.Geometry.Point(m+l,g),new OpenLayers.Geometry.Point(m+l,g-l),new OpenLayers.Geometry.Point(m,g-l)],v=new OpenLayers.Geometry.LinearRing(y),b=new OpenLayers.Geometry.Polygon([v]),_={color:f,name:n},k=new OpenLayers.Feature.Vector(b,_);a.boxesLayer.addFeatures([k]);var u=new OpenLayers.Geometry.Point(m+o,g-l),L={name:p.range},w=new OpenLayers.Feature.Vector(u,L);a.boxesLayer.addFeatures([w]),h-=o}a.boxesLayer.redraw()},_createPrintGeoJSON:function(){var e=new OpenLayers.Format.GeoJSON,t=[],i=JSON.parse(e.write(this.headerLayer.features)),a={type:"geojson",name:this.headerLayer.name,id:this.headerLayer.name,data:{type:"FeatureCollection",features:i.features},styles:[]};a.styles.push(this._getDefaultStyle(this.headerLayer.styleMap)),t.push(a);var n=JSON.parse(e.write(this.boxesLayer.features)),a={type:"geojson",name:this.boxesLayer.name,id:this.boxesLayer.name,data:{type:"FeatureCollection",features:n.features},styles:[]};return a.styles.push(this._getDefaultStyle(this.boxesLayer.styleMap)),t.push(a),t},_getDefaultStyle:function(e){var t=e.styles["default"].defaultStyle,i=e.styles["default"].id,a={title:"Standard",name:i,styleMap:{"default":{}}};return a.styleMap["default"]=this._cleanStyle(t,["labelXOffset","labelYOffset"]),a},_cleanStyle:function(e,t){for(var i=jQuery.extend(!0,{},e),a=0;a<t.length;a++){var n=t[a];i[n]&&i[n].toString().indexOf("${delta")>-1&&delete i[n]}return i},protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.service.PrintService",function(e){this.instance=e,this.sandbox=e.sandbox},{__name:"Printout.PrintService",__qname:"Oskari.mapframework.bundle.printout.service.PrintService",getQName:function(){return this.__qname},getName:function(){return this.__name},init:function(){},fetchPrintMapData:function(e,t,i){jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:e,success:function(e){t&&t(e)},error:function(e,t){i&&0!=e.status&&i(e,t)}})}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.view.StartView",function(e,t){this.instance=e,this.template=jQuery("<div class='startview'><div class='content'></div><div class='buttons'></div></div>"),this.templateError=jQuery('<div class="error"><ul></ul></div>'),this.templateInfo=jQuery("<div class='icon-info'></div>"),this.loc=t,this.content=void 0,this.buttons={},this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert")},{_isTooManyLayers:function(){var e=this.instance.getSandbox().findAllSelectedMapLayers().length,t=e>7;return t},_isManyLayers:function(){var e=this.instance.getSandbox().findAllSelectedMapLayers().length,t=e>2;return t},render:function(e){var t=this,i=this.template.clone();this.content=i,e.append(i),this.alert.insertTo(e);var a=this._isTooManyLayers(),n=this._isManyLayers();if(a?this.alert.setContent(this.loc.info.maxLayers,"error"):n?this.alert.setContent(this.loc.info.printoutProcessingTime,"info"):this.alert.setContent(this.loc.text,"default"),!a){var s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.addClass("primary"),s.setTitle(this.loc.buttons["continue"]),s.setHandler(function(){t.instance.setPublishMode(!0)}),this.buttons["continue"]=s,s.insertTo(i.find("div.buttons"))}var r=Oskari.clazz.create("Oskari.userinterface.component.Button");a&&r.addClass("primary"),r.setTitle(this.loc.buttons.cancel),r.setHandler(function(){t.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[t.instance,"close"])}),this.buttons.cancel=r,r.insertTo(i.find("div.buttons"))}}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.view.BasicPrintout",function(e,t,i){this.isEnabled=!1,this.instance=e,this.loc=t,this.backendConfiguration=i,this.legendInProcess=!1,this.template={};for(p in this.__templates)this.template[p]=jQuery(this.__templates[p]);this.sizeOptions=this.loc.size.options,this.sizeOptionsMap={};for(var a=0;a<this.sizeOptions.length;a++)this.sizeOptionsMap[this.sizeOptions[a].id]=this.sizeOptions[a];this.formatOptions=this.loc.format.options,this.formatOptionsMap={};for(var n=0;n<this.formatOptions.length;n++)this.formatOptionsMap[this.formatOptions[n].id]=this.formatOptions[n];this.contentOptions=this.loc.content.options,this.contentOptionsMap={};for(var n=0;n<this.contentOptions.length;n++)this.contentOptionsMap[this.contentOptions[n].id]=this.contentOptions[n];this.legendOptions=this.loc.legend.options,this.legendOptionsMap={};for(var n=0;n<this.legendOptions.length;n++)this.legendOptionsMap[this.legendOptions[n].id]=this.legendOptions[n];this.accordion=null,this.mainPanel=null,this.progressSpinner=Oskari.clazz.create("Oskari.userinterface.component.ProgressSpinner"),this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert"),this.previewContent=null,this.previewImgDiv=null,this.contentOptionDivs={}
},{__templates:{preview:'<div class="preview"><img /><span></span></div>',previewNotes:'<div class="previewNotes"><span></span></div>',location:'<div class="location"></div>',tool:'<div class="tool "><input type="checkbox"/><label></label></div>',buttons:'<div class="buttons"></div>',help:'<div class="help icon-info"></div>',main:'<div class="basic_printout"><div class="header"><div class="icon-close"></div><h3></h3></div><div class="content"></div><form method="post" target="map_popup_111" id="oskari_print_formID" style="display:none" action="" ><input name="geojson" type="hidden" value="" id="oskari_geojson"/><input name="tiles" type="hidden" value="" id="oskari_tiles"/></form></div>',format:'<div class="printout_format_cont printout_settings_cont"><div class="printout_format_label"></div></div>',formatOptionTool:'<div class="tool "><input type="radio" name="format" /><label></label></div>',legend:'<div class="printout_legend_cont printout_settings_cont"><div class="printout_legend_label"></div></div>',legendOptionTool:'<div class="tool "><input type="radio" name="legend" /><label></label></div>',title:'<div class="printout_title_cont printout_settings_cont"><div class="printout_title_label"></div><input class="printout_title_field" type="text"></div>',option:'<div class="printout_option_cont printout_settings_cont"><input type="checkbox" /><label></label></div>',sizeOptionTool:'<div class="tool "><input type="radio" name="size" /><label></label></div>'},render:function(e){var t=this,i=this.template.main.clone();this.mainPanel=i,i.find("div.header h3").append(this.loc.title),e.append(i);var a=i.find("div.content");this.alert.insertTo(a);var n=Oskari.clazz.create("Oskari.userinterface.component.Accordion");this.accordion=n;var s=this._createSizePanel();s.open(),n.addPanel(s);var r=this._createSettingsPanel();n.addPanel(r);var o=this._createPreviewPanel();o.open(),n.addPanel(o),n.insertTo(a),this._setLegendVisibility(),e.find("div.header div.icon-close").bind("click",function(){t.instance.setPublishMode(!1)}),a.append(this._getButtons());var l=this.mainPanel.find("input[type=text]");l.focus(function(){t.instance.sandbox.postRequestByName("DisableMapKeyboardMovementRequest")}),l.blur(function(){t.instance.sandbox.postRequestByName("EnableMapKeyboardMovementRequest")});var u=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",this.instance.sandbox);u.processHelpLinks(this.loc.help,i,this.loc.error.title,this.loc.error.nohelp)},_createSizePanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.size.label);var i=t.getContainer(),a=this.template.help.clone();a.attr("title",this.loc.size.tooltip),i.append(a);for(var n=function(t){return function(){i.find("input[name=size]:checked").val();for(var a=0;a<e.sizeOptions.length;++a)e.sizeOptions[a].selected=!1;t.selected=!0,e._cleanMapPreview(),e._updateMapPreview(),e._createLegend()}},s=0;s<this.sizeOptions.length;++s){var r=this.sizeOptions[s],o=this.template.sizeOptionTool.clone(),l=r.label;r.width&&r.height&&(l=l+" ("+r.width+" x "+r.height+"px)"),o.find("label").append(l).attr({"for":r.id,"class":"printout_radiolabel"}),r.selected&&o.find("input").attr("checked","checked"),i.append(o),o.find("input").attr({value:r.id,name:"size",id:r.id}),o.find("input").change(n(r))}return t},_createSettingsPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.settings.label);var i=t.getContainer(),a=this.template.help.clone();a.attr("title",this.loc.settings.tooltip),i.append(a);var n=function(t){return function(){i.find("input[name=format]:checked").val();for(var a=0;a<e.formatOptions.length;++a)e.formatOptions[a].selected=!1;t.selected=!0}},s=this.template.format.clone();s.find(".printout_format_label").html(this.loc.format.label);for(var r=0;r<this.formatOptions.length;++r){var o=this.formatOptions[r],l=this.template.formatOptionTool.clone(),u=o.label;l.find("label").append(u).attr({"for":o.id,"class":"printout_radiolabel"}),o.selected&&l.find("input").attr("checked","checked"),s.append(l),l.find("input").attr({value:o.format,name:"format",id:o.id}),l.find("input").change(n(o))}i.append(s);var c=this.template.title.clone();c.find(".printout_title_label").html(this.loc.mapTitle.label),c.find(".printout_title_field").attr({value:"",placeholder:this.loc.mapTitle.label}),i.append(c);for(var h=0;h<this.contentOptions.length;h++){var d=this.contentOptions[h],p=this.template.option.clone();p.find("input").attr({id:d.id,checked:d.checked}),p.find("label").html(d.label).attr({"for":d.id,"class":"printout_checklabel"}),this.contentOptionDivs[d.id]=p,i.append(p)}var f=function(t){return function(){i.find("input[name=legend]:checked").val();for(var a=0;a<e.legendOptions.length;++a)e.legendOptions[a].selected=!1;t.selected=!0}},m=this.template.legend.clone();m.find(".printout_legend_label").html(this.loc.legend.label);for(var r=0;r<this.legendOptions.length;++r){var o=this.legendOptions[r],l=this.template.legendOptionTool.clone(),u=o.label;l.find("label").append(u).attr({"for":o.id,"class":"printout_radiolabel"}),o.selected&&l.find("input").attr("checked","checked"),m.append(l),l.find("input").attr({value:o.loca,name:"location",id:o.id}),l.find("input").change(f(o)),l.find('input[name="location"]').click(function(){e._createLegend()})}return i.append(m),t},_createPreviewPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.preview.label);var i=t.getContainer(),a=this.template.help.clone();a.attr("title",this.loc.preview.tooltip),i.append(a);var n=this.template.preview.clone();i.append(n),e.progressSpinner.insertTo(n);var s=n.find("img");s.click(function(){e.showFullScaleMapPreview()});var r=n.find("span");this.previewContent=n,this.previewImgDiv=s,this.previewSpan=r;for(var o in this.loc.preview.notes){var l=this.template.previewNotes.clone();l.find("span").text(this.loc.preview.notes[o]),i.append(l)}return t},_createLocationAndScalePanel:function(){var e=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");e.setTitle(this.loc.location.label);var t=e.getContainer(),i=this.template.help.clone();i.attr("title",this.loc.location.tooltip),t.append(i);var a=this.template.location.clone();return t.append(a),e},_cleanMapPreview:function(){var e=this.loc,t=this.previewImgDiv,i=this.previewSpan;t.hide(),i.text(e.preview.pending)},_updateMapPreview:function(){var e=this,t=this._gatherSelections("image/png");this.backendConfiguration={formatProducers:{"application/pdf":"http://wps.paikkatietoikkuna.fi/dataset/map/process/imaging/service/thumbnail/maplink.pdf?","image/png":"http://wps.paikkatietoikkuna.fi/dataset/map/process/imaging/service/thumbnail/maplink.png?"}};var i=this.backendConfiguration.formatProducers[t.format],a=t.maplinkArgs,n="&pageSize="+t.pageSize,s="&scaledWidth=200",r=i+a+n+s;this.previewContent.removeClass("preview-portrait"),this.previewContent.removeClass("preview-landscape"),this.previewContent.addClass(this.sizeOptionsMap[t.pageSize].classForPreview);var o=this.previewImgDiv,l=this.previewSpan;e.progressSpinner.start(),window.setTimeout(function(){o.imagesLoaded(function(){l.text(""),o.fadeIn("slow",function(){e.progressSpinner.stop()})}),o.attr("src",r)},100)},showFullScaleMapPreview:function(){var e=this._gatherSelections("image/png"),t=this.backendConfiguration.formatProducers[e.format],i=e.maplinkArgs,a="&pageSize="+e.pageSize,n=t+i+a;this.openURLinWindow(n,e)},_getButtons:function(){var e=this,t=this.template.buttons.clone(),i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.setTitle(this.loc.buttons.cancel),i.setHandler(function(){e.instance.setPublishMode(!1)}),i.insertTo(t);var a=Oskari.clazz.create("Oskari.userinterface.component.Button");return a.setTitle(this.loc.buttons.save),a.addClass("primary"),a.setHandler(function(){var t=e.instance.sandbox.getMap(),i="undefined"==typeof t.geojs?null:t.geojs,a=e._gatherSelections();a&&e._printMap(a,i)}),a.insertTo(t),t},_gatherSelections:function(e){var t=this.mainPanel,i=this.instance.getSandbox(),a=t.find("input[name=size]:checked").val(),n=null!=e?e:t.find("input[name=format]:checked").val(),s=t.find(".printout_title_field").val(),r=i.generateMapLinkParameters(),o={pageTitle:s,pageSize:a,maplinkArgs:r,format:n||"application/pdf"};for(var l in this.contentOptionsMap)o[l]=this.contentOptionDivs[l].find("input").prop("checked");return o},openURLinWindow:function(e,t){var i="location=1,status=1,scrollbars=1,width=850,height=1200";this._isLandscape(t)&&(i="location=1,status=1,scrollbars=1,width=1200,height=850");var a=e;window.open(a,"BasicPrintout",i)},openPostURLinWindow:function(e,t,i,a){var n=this,s="location=1,status=1,scrollbars=1,width=850,height=1200";this._isLandscape(a)&&(s="location=1,status=1,scrollbars=1,width=1200,height=850");var r=i;if(n.mainPanel.find("#oskari_print_formID").attr("action",r),e){var o=unescape(encodeURIComponent(e));n.mainPanel.find("input[name=geojson]").val(jQuery.base64.encode(o))}t&&n.mainPanel.find("input[name=tiles]").val(t),window.open("about:blank","map_popup_111",s),n.mainPanel.find("#oskari_print_formID").submit()},_printMap:function(e){var t=this.instance.getSandbox(),i=t.getAjaxUrl();this.backendConfiguration.formatProducers[e.format];var a=e.maplinkArgs,n="&pageSize="+e.pageSize,s="&pageTitle="+e.pageTitle,r=[];for(var o in this.contentOptionsMap)e[o]&&r.push("&"+o+"=true");var l=r.join(""),u="&format="+e.format,c=a+"&action_route=GetPreview"+n+s+l+u;if(i+=c,this.instance.geoJson||!jQuery.isEmptyObject(this.instance.tileData)){var h=this._stringifyGeoJson(this.instance.geoJson),d=this._stringifyTileData(this.instance.tileData);this.instance.getSandbox().printDebug("PRINT POST URL "+i),this.openPostURLinWindow(h,d,i,e)}else this.instance.getSandbox().printDebug("PRINT URL "+i),this.openURLinWindow(i,e)},_isLandscape:function(e){return this.sizeOptionsMap[e.pageSize].id.indexOf("Land")>-1?!0:!1},_stringifyGeoJson:function(e){return e?JSON.stringify(e).replace('"','"'):null},_stringifyTileData:function(e){if(jQuery.isEmptyObject(e))return null;var t,i=[];for(var a in e)i.push(e[a]);return t=[].concat.apply([],i),JSON.stringify(t)},_setLegendVisibility:function(){var e=this.mainPanel;this._hasStatsLayers()?e.find(".printout_legend_cont").show():e.find(".printout_legend_cont").hide()},_hasStatsLayers:function(){for(var e=this.instance.getSandbox().findAllSelectedMapLayers(),t=0;t<e.length;t++)if(e[t].isLayerOfType("STATS")&&e[t].isVisible())return!0;return!1},_createLegend:function(){var e=this;if(e._setLegendVisibility(),e._hasStatsLayers()){this.instance.sandbox.getMap();var t=this.mainPanel,i=jQuery("#contentMap"),a=t.find("input[name=location]:checked").val();if("NO"==a)e.instance.getSandbox().getMap().GeoJSON&&(e.instance.getSandbox().getMap().GeoJSON=null),e.instance.legendPlugin.clearLegendLayers();else{var n=i.find("div.geostats-legend");if(n.length>0){if(e.legendInProcess)return;e.legendInProcess=!0,this._printMapInfo(n,function(t){var i=n.find(".geostats-legend-title").html(),s=[];n.find("div").each(function(){var e=jQuery(this).attr("class");if(void 0==e){var t={boxcolor:jQuery(this).find(".geostats-legend-block").attr("style"),range:jQuery(this).text()};s.push(t)}});var r=e.instance.legendPlugin.plotLegend(i,s,t,a);e.instance.geoJson=r,e.legendInProcess=!1})}}}},_printMapInfo:function(e,t){var i=this,a=i._gatherSelections(),n=this.instance.getSandbox(),s=n.getAjaxUrl();this.backendConfiguration.formatProducers[a.format];var r=a.maplinkArgs,o="&pageSize="+a.pageSize,l="&pageTitle="+a.pageTitle,u=[];for(var c in this.contentOptionsMap)a[c]&&u.push("&"+c+"=true");var h=u.join(""),d="&format="+a.format,p=r+"&action_route=GetProxyRequest&serviceId=print"+o+l+h+d;s+=p,i.instance.printService.fetchPrintMapData(s,function(e){e?t(e):alert("Error to fetch print info: ")},function(){alert("Error to fetch print info: ")})},destroy:function(){this.mainPanel.remove()},hide:function(){this.mainPanel.hide()},show:function(){this.mainPanel.show()},setEnabled:function(e){this.isEnabled=e},getEnabled:function(){return this.isEnabled},refresh:function(e){e?this._updateMapPreview():this._cleanMapPreview(),this._createLegend()},getState:function(){return this._gatherSelections()},setState:function(){}}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.request.PrintMapRequest",function(e){this._creator=null,this._selections=e},{__name:"printout.PrintMapRequest",getName:function(){return this.__name},getSelections:function(){return this._selections}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.request.PrintMapRequestHandler",function(e,t){this.sandbox=e,this.cb=t},{handleRequest:function(e,t){var i=t.getSelections();this.sandbox.printDebug("[Oskari.mapframework.bundle.printout.request.PrintMapRequestHandler] printout requested"),this.cb(i)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.event.PrintableContentEvent",function(e,t,i,a){this._contentId=e,this._layer=t,this._tileData=i,this._geojsonData=a},{getName:function(){return"Printout.PrintableContentEvent"},getContentId:function(){return this._contentId},getLayer:function(){return this._layer},setLayer:function(e){this._layer=e},getTileData:function(){return this._tileData},setTileData:function(e){this._tileData=e},getGeoJsonData:function(){return this._geojsonData},setGeoJsonData:function(e){this._geojsonData=e}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.postprocessor.PostProcessorBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.postprocessor.PostProcessorBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/postprocessor/instance.js"}]},bundle:{manifest:{"Bundle-Identifier":"postprocessor","Bundle-Name":"postprocessor","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("postprocessor","Oskari.mapframework.bundle.postprocessor.PostProcessorBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.postprocessor.PostProcessorBundleInstance",function(){this.sandbox=null},{__name:"PostProcessor",getName:function(){return this.__name},start:function(){var e=this.conf,t=(e?e.sandbox:null)||"sandbox",i=Oskari.getSandbox(t);if(this.sandbox=i,i.register(this),this.state){var a=this.state.highlightFeatureLayerId;this._highlightFeature(a,this.state.highlightFeatureId)}},_highlightFeature:function(e,t){if(t&&e){var i=this.state.featurePoints;i&&this._showPoints(i);var a=this.sandbox.getEventBuilder("WFSFeaturesSelectedEvent"),n=[];"[object Array]"===Object.prototype.toString.call(t)?n=t:n.push(t);var s=Oskari.clazz.create("Oskari.mapframework.domain.WfsLayer");s.setId(e),s.setOpacity(100);var r=a(n,s);this.sandbox.notifyAll(r)}},_showPoints:function(e){for(var t=new OpenLayers.Geometry.MultiPoint,i=0;i<e.length;++i){var a=e[i],n=new OpenLayers.Geometry.Point(a.lat,a.lon);t.addPoint(n)}var s=t.getBounds(),r=t.getCentroid(),o=this.sandbox.getRequestBuilder("MapMoveRequest");if(o&&i>0)if(1==i){var l=o(r.x,r.y,9);this.sandbox.request(this,l)}else{var l=o(r.x,r.y,s);this.sandbox.request(this,l)}},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{MapLayerEvent:function(e){"add"!=e.getOperation()||e.getLayerId()||this._highlightFeature(this.state.highlightFeatureLayerId,this.state.highlightFeatureId)}},init:function(){return null},update:function(){},stop:function(){}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatsGridBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.StatsGridBundleInstance","statsgrid")},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/instance.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/StatsView.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/GridModeView.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/StatsToolbar.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/plugin/ManageClassificationPlugin.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/plugin/ManageStatsPlugin.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/event/SotkadataChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/event/ModeChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/event/ClearHilightsEvent.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/event/SelectHilightsModeEvent.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/request/StatsGridRequest.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/request/StatsGridRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/request/TooltipContentRequest.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/request/TooltipContentRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/service/StatisticsService.js"},{type:"text/css",src:"../../../../resources/statistics/bundle/statsgrid/css/style.css"},{type:"text/css",src:"../../../../resources/statistics/bundle/statsgrid/css/classifyplugin.css"},{type:"text/css",src:"../../../../libraries/slickgrid/css/slick.grid.css"},{type:"text/css",src:"../../../../libraries/slickgrid/css/municipality.css"},{type:"text/css",src:"../../../../libraries/slickgrid/css/slick-default-theme.css"},{src:"../../../../libraries/jquery/jquery.event.drag-2.0.min.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.core.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.formatters.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.editors.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.cellrangedecorator.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.cellrangeselector.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.cellselectionmodel.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.headermenu2.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.headermenu2.css",type:"text/css"},{src:"../../../../libraries/slickgrid/plugins/slick.rowselectionmodel.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.checkboxselectcolumn2.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.grid.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.groupitemmetadataprovider.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.dataview.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/controls/slick.pager.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/controls/slick.columnpicker.js",type:"text/javascript"},{src:"../../../../libraries/chosen/chosen.jquery.js",type:"text/javascript"},{src:"../../../../libraries/chosen/chosen.css",type:"text/css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"statsgrid","Bundle-Name":"statsgrid","Bundle-Author":[{Name:"jjk",Organisatpation:"nls.fi",Temporal:{Start:"2013",End:"2013"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Verspation":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("statsgrid","Oskari.statistics.bundle.statsgrid.StatsGridBundle"),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatsGridBundleInstance",function(){this.conf={name:"StatsGrid",sandbox:"sandbox",stateful:!0,viewClazz:"Oskari.statistics.bundle.statsgrid.StatsView"},this.state={indicators:[],layerId:null}},{start:function(){var e=this,t=this.conf,i=(t?t.sandbox:null)||"sandbox",a=Oskari.getSandbox(i);e.sandbox=a,a.register(this),t&&t.stateful===!0&&a.registerAsStateful(this.mediator.bundleId,this);var n=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,n);var s=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.request.TooltipContentRequestHandler",this);a.addRequestHandler("StatsGrid.TooltipContentRequest",s);var r=e.getLocalization(),o=a.findRegisteredModuleInstance("MainMapModule");this.mapModule=o;var l=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.StatisticsService",e);a.registerService(l),this.statsService=l;var u={state:e.getState(),statistics:[{id:"avg",visible:!0},{id:"max",visible:!0},{id:"min",visible:!0},{id:"mde",visible:!0},{id:"mdn",visible:!0},{id:"std",visible:!0},{id:"sum",visible:!0}]},c=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.plugin.ManageStatsPlugin",u,r);o.registerPlugin(c),o.startPlugin(c),this.gridPlugin=c;var h=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.plugin.ManageClassificationPlugin",t,r);o.registerPlugin(h),o.startPlugin(h),this.classifyPlugin=h,this.setState(this.state)},eventHandlers:{"userinterface.ExtensionUpdatedEvent":function(e){var t=this,i=this.plugins["Oskari.userinterface.View"];if(e.getExtension().getName()==t.getName()){var a="close"!=e.getViewState();i.prepareMode(a,null,!0)}},"MapStats.StatsVisualizationChangeEvent":function(e){this._afterStatsVisualizationChangeEvent(e)},AfterMapMoveEvent:function(){var e=this.plugins["Oskari.userinterface.View"];e.isVisible&&e._layer&&this._createPrintParams(e._layer)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)}},setState:function(e){var t=this,i=this.plugins["Oskari.userinterface.View"],a=i.getEl(),n=this.sandbox.findMapLayerFromAllAvailable(e.layerId);n&&(t.gridPlugin.setState(e),i.isVisible?t.gridPlugin.loadStateIndicators(e,a):i.prepareMode(!0,n))},getState:function(){return this.state},getStateParameters:function(){if(!this.state||jQuery.isEmptyObject(this.state))return null;var e=null,t=null,i=null,a="statsgrid=",n="+",s=",",r=null,o=null,l=this.state,u=["layerId","currentColumn","methodId","numberOfClasses","manualBreaksInput"],c=l.indicators||[];for(e=0,t=u.length,i=t-1;t>e;e++)value=l[u[e]],null==value||(r+=value),e!=i&&(r+=n);for(e=0,t=c.length,i=t-1;t>e;e++)o+=c[e].indicator,o+=n,o+=c[e].year,o+=n,o+=c[e].gender,e!=i&&(o+=s);return r&&o?a+r+"-"+o:null},getView:function(){return this.plugins["Oskari.userinterface.View"]},_createPrintParams:function(e){var t,i,a=this.mapModule.getOLMapLayers(e.getId())[0],n=[{bbox:a.maxExtent.toArray(),url:a.getURL(a.getExtent())}];this.printEvent?(t=!0,this.printEvent.setLayer(e),this.printEvent.setTileData(n)):(t=!1,i=this.sandbox.getEventBuilder("Printout.PrintableContentEvent"),i&&(this.printEvent=i(this.getName(),e,n))),this.sandbox.notifyAll(this.printEvent,t)},_afterStatsVisualizationChangeEvent:function(e){var t=e.getParams(),i=e.getLayer();this.state.methodId=t.methodId,this.state.numberOfClasses=t.numberOfClasses,this.state.manualBreaksInput=t.manualBreaksInput,this.state.colors=t.colors,this._createPrintParams(i)},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer(),i=t.getId(),a=this.plugins["Oskari.userinterface.View"];a._layer&&i===a._layer.getId()&&a.prepareMode(!1)}},{extend:["Oskari.userinterface.extension.DefaultExtension"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatsView",function(){},{showContent:function(e){e?(this.getLeftColumn().addClass("statsgrid_100"),this.getLeftColumn().append(this.getEl())):(this.getLeftColumn().removeClass("statsgrid_100"),this.getEl().empty(),this.getEl().remove())}},{protocol:["Oskari.userinterface.View"],extend:["Oskari.statistics.bundle.statsgrid.GridModeView"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.GridModeView",function(){},{startPlugin:function(){var e=this,t=e.instance.getSandbox();this.toolbar=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.StatsToolbar",{title:e.getTitle()},this.instance),this.requestHandler=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.request.StatsGridRequestHandler",e),t.addRequestHandler("StatsGrid.StatsGridRequest",this.requestHandler);var i=e.getEl();i.addClass("statsgrid")},prepareMode:function(e,t,i){if(!this.isVisible||!e){this.isVisible=1==e,(null!=t&&null==this._layer||null!=t&&this._layer.getId()!=t.getId())&&(this._layer=t,this.instance.gridPlugin.setLayer(t),this.instance.state.layerId=this._layer.getId(),this.toolbar.changeName(this._layer.getName())),this.showMode(e,i),this.showContent(e),e&&this.instance.gridPlugin.createStatsOut(this.getEl());var a=this.instance.getSandbox().getEventBuilder("StatsGrid.ModeChangedEvent");if(a){var n=a(this.isVisible);this.instance.getSandbox().notifyAll(n)}}},showMode:function(e,t){var i=this,a=this.instance.getSandbox();this.toolbar.show(e);var n=this.instance.getSandbox().findRegisteredModuleInstance("MainMapModule"),s=n.getMap();if(e){n.zoomTo(0),jQuery("#contentMap").addClass("statsgrid-contentMap"),jQuery(".oskariui-mode-content").addClass("statsgrid-mode");var r=40,o=this.getCenterColumn();o.removeClass("span12"),o.width(100-r+"%"),jQuery("#mapdiv").height(jQuery(window).height()-jQuery("#contentMap").find(".oskariui-menutoolbar").height());var l=this.getLeftColumn();l.empty(),l.removeClass("oskari-closed"),l.width(r+"%"),l.resizable({minWidth:450,handles:"e",resize:function(){o.width(jQuery(".row-fluid").width()-l.width()),s.updateSize(),i.instance.gridPlugin.grid.resizeCanvas()}}),s.updateSize()}else{jQuery("#contentMap").removeClass("statsgrid-contentMap"),jQuery(".oskariui-mode-content").removeClass("statsgrid-mode");var o=jQuery(".oskariui-center");o.width("").addClass("span12"),jQuery("#mapdiv").height(jQuery(window).height());var l=jQuery(".oskariui-left");if(l.addClass("oskari-closed"),l.width(""),l.empty(),!t){var u=a.getRequestBuilder("userinterface.UpdateExtensionRequest")(this.instance,"close",this.instance.getName());a.request(this.instance.getName(),u)}s.updateSize()}},getLeftColumn:function(){return jQuery(".oskariui-left")},getCenterColumn:function(){return jQuery(".oskariui-center")},getRightColumn:function(){return jQuery(".oskariui-right")},stopPlugin:function(){this.toolbar.destroy(),sandbox.removeRequestHandler("StatsGrid.StatsGridRequest",this.requestHandler)}},{protocol:["Oskari.userinterface.View"],extend:["Oskari.userinterface.extension.DefaultView"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatsToolbar",function(e,t){this.toolbarId="statsgrid",this.instance=t,this.localization=e,this._createUI()},{show:function(e){var t=e?"show":"hide",i=this.instance.getSandbox();i.requestByName(this.instance,"Toolbar.ToolbarRequest",[this.toolbarId,t])},destroy:function(){var e=this.instance.getSandbox();e.requestByName(this.instance,"Toolbar.ToolbarRequest",[this.toolbarId,"remove"])},changeName:function(e){var t=this.instance.getSandbox();t.requestByName(this.instance,"Toolbar.ToolbarRequest",[this.toolbarId,"changeName",e])},_createUI:function(){var e=this.instance.plugins["Oskari.userinterface.View"],t=this,i=this.instance.getSandbox();i.requestByName(this.instance,"Toolbar.ToolbarRequest",[this.toolbarId,"add",{title:t.localization.title,show:!1,closeBoxCallback:function(){e.prepareMode(!1)}}]);var a="statsgrid-tools",n={selectAreas:{toolbarid:t.toolbarId,iconCls:"selection-square",tooltip:this.instance._localization.showSelected,sticky:!1,toggleSelection:!0,callback:function(){var i=e.instance.gridPlugin,a=i.toggleSelectMunicipalitiesMode();if(a){i.unselectAllAreas(!0);var n=t.instance.getSandbox().getEventBuilder("StatsGrid.SelectHilightsModeEvent");if(n){var s=n(i.selectedMunicipalities);t.instance.getSandbox().notifyAll(s)}}else{i.grid.scrollRowToTop(0);var n=t.instance.getSandbox().getEventBuilder("StatsGrid.ClearHilightsEvent");if(n){var s=n(t.isVisible);t.instance.getSandbox().notifyAll(s)}}}}},s=this.instance,r=i.getRequestBuilder("Toolbar.AddToolButtonRequest");for(var o in n)i.request(s,r(o,a,n[o]))}}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.plugin.ManageClassificationPlugin",function(e,t){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.element=void 0,this.conf=e,this._locale=null!=t?t:Oskari.getLocalization("StatsGrid"),this.initialSetup=!0,this.colorsets_div=null,this.colorsets_seq=null,this.colorsets_qual=null,this.content=null,this.dialog=null,this.colorsetIndex=0,this.currentColorSet="seq",this.curCol=null,this._layer=null,this._params=null,this.minClassNum=2,this.maxClassNum=9,this.isSelectHilightedMode=!1,this.templates={block:'<div class="block"></div>',classificationGuide:'<p class="classification-guide"></p>'}},{__name:"ManageClassificationPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},getMap:function(){return this._map},register:function(){},unregister:function(){},init:function(){this.classify_temp=jQuery('<div class=\'manageClassificationPlugin\'><div class="classheader"><div class="header-icon icon-arrow-white-right"></div></div><div class="content"></div></div>'),this.templateContent=jQuery("<div></div>"),this.templateInstructions2=jQuery("<div class='instructions2' style= 'padding: 20px 0px 0px 0px;'></div>"),this.setColors()},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.statsService=e.getService("Oskari.statistics.bundle.statsgrid.StatisticsService"),this._createUI()},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this.element&&(this.element.remove(),this.element=void 0,delete this.element)},start:function(){},stop:function(){},eventHandlers:{MapLayerEvent:function(){for(var e=this._sandbox.findAllSelectedMapLayers(),t=e.length-1;t>=0;--t){var i=e[t];if("STATS"===i._layerType&&!i.isBaseLayer()){i.isVisible()?this._visibilityOn():this._visibilityOff();break}}},AfterMapLayerRemoveEvent:function(e){"STATS"===e.getMapLayer()._layerType&&this._visibilityOff()},AfterMapLayerAddEvent:function(e){"STATS"===e.getMapLayer()._layerType&&this._visibilityOn()},MapLayerVisibilityChangedEvent:function(e){if("STATS"===e.getMapLayer()._layerType){var t=e.getMapLayer().isVisible();t?this._visibilityOn():this._visibilityOff()}},AfterMapMoveEvent:function(){},"StatsGrid.SelectHilightsModeEvent":function(){this.isSelectHilightedMode=!0},"StatsGrid.ClearHilightsEvent":function(){this.isSelectHilightedMode=!1},"StatsGrid.SotkadataChangedEvent":function(e){this._layer=e.getLayer(),this._params=e.getParams(),this.classifyData(e)
}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},classifyData:function(){var e=this;if(e._layer){var t,i,a=this._layer,n=this._params,s=n.CUR_COL,r=[],o=!1,l=[];if(!(s.field.indexOf("indicator")<0)){var u=e._adjustClassificationSlider(n.CHECKED_COUNT),c=u.slider("option","disabled");if(c){var h=e.element.find(".classificationMethod");h.find(".block").remove();var d=jQuery(e.templates.block);return d.append(jQuery(e.templates.classificationGuide).text(this._locale.select4Municipalities)),h.append(d),this.element.find("div.content").show(),void 0}var p=e.element.find(".classificationMethod").find(".method").val(),f=Number(e.element.find(".classificationMethod").find(".classCount").find("#amount_class").val()),m=n.COL_VALUES;m=m.slice(0);var g=n.VIS_CODES,y=new geostats(m),v=n.COL_VALUES;if(1==p&&(l=y.getJenks(f)),2==p&&(l=y.getQuantile(f)),3==p&&(l=y.getEqInterval(f)),4==p){if(l=this.setManualBreaks(y),!l)return;f=l.length-1}for(t=0;f>t;t++)r[t]=[];for(i=0;i<v.length;i++){for(t=0;t<r.length;t++){if(parseFloat(v[i])>=l[t]&&parseFloat(v[i])<=l[t+1]){r[t].push(g[i]),o=!0;break}if(parseFloat(v[i])==l[t]&&parseFloat(v[i])==l[t+1]){r[t].push(g[i]),o=!0;break}}o?o=!1:r[r.length-1].push(g[i])}var b=[];for(t=0;t<r.length;t++)b.push(r[t].join(","));var _=b.join("|"),k=e._getColors(this.currentColorSet,e.colorsetIndex,f-2);e.colorsFlipped&&(k=k.split(",").reverse().join(","));var L=k.split(",");for(t=0;t<L.length;t++)L[t]="#"+L[t];y.setColors(L);var w=this.element.find(".manualBreaks").find("input[name=breaksInput]").val(),k=k.replace(/,/g,"|"),O={methodId:p,numberOfClasses:f,manualBreaksInput:w.toString(),colors:{set:e.currentColorSet,index:e.colorsetIndex,flipped:e.colorsFlipped},VIS_ID:-1,VIS_NAME:n.VIS_NAME,VIS_ATTR:n.VIS_ATTR,VIS_CLASSES:_,VIS_COLORS:"choro:"+k};this.statsService.sendVisualizationData(a,O);var x=function(e){return 0===e%1?e:Math.round(10*e)/10},S=y.getHtmlLegend(null,s.name,!0,x),h=e.element.find(".classificationMethod");h.find(".block").remove();var d=jQuery('<div class="block"></div>');d.append(S),h.append(d),this.element.find("div.content").show()}}},_createUI:function(){var e=this;this.element||(this.element=this.classify_temp.clone());var t=this.element.find("div.classheader");t.append(this._locale.classify.classify);for(var i=e.element.find("div.content"),a=jQuery('<div class="classificationMethod"><br>'+this._locale.classify.classifymethod+'<br><select class="method"></select><br></div>'),n=a.find("select"),s=[this._locale.classify.jenks,this._locale.classify.quantile,this._locale.classify.eqinterval,this._locale.classify.manual],r=0;r<s.length;r++){var o=jQuery('<option value="'+(r+1)+'">'+s[r]+"</option>");n.append(o)}n.change(function(){4==jQuery(this).val()?(jQuery(".classCount").hide(),jQuery(".manualBreaks").show()):(jQuery(".manualBreaks").hide(),jQuery(".classCount").show(),e.classifyData())});var l=jQuery('<div class="classCount">'+this._locale.classify.classes+' <input type="text" id="amount_class" readonly="readonly" value="5" /><div id="slider-range-max"></div>'),u=l.find("#slider-range-max").slider({range:"min",min:e.minClassNum,max:e.maxClassNum,value:5,slide:function(t,i){jQuery("input#amount_class").val(i.value),jQuery(this).slider("option","value",i.value),e.classifyData(t)}});this.rangeSlider=u;var c=jQuery('<div class="manualBreaks"><input type="text" name="breaksInput" placeholder="'+this._locale.classify.manualPlaceholder+'"></input>'+'<div class="icon-info"></div>'+"</div>");c.find("input[type=button]").click(function(){e._createColorDialog()}),c.find("input[name=breaksInput]").keypress(function(t){13==t.which&&e.classifyData()}).focus(function(){e._sandbox.postRequestByName("DisableMapKeyboardMovementRequest")}).blur(function(){e._sandbox.postRequestByName("EnableMapKeyboardMovementRequest")}),c.find(".icon-info").click(function(){var t="<p>"+e._locale.classify.info+"</p>";e.showMessage(e._locale.classify.infoTitle,t)}),c.hide();var h=jQuery('<input type="button" value="'+e._locale.colorset.button+'" />');h.click(function(){e._createColorDialog()});var d=jQuery('<input type="button" value="'+e._locale.colorset.flipButton+'" />');d.click(function(){e._flipCurrentColors()}),a.append(l),a.append(c),a.append(h),a.append(d),i.append(a),t.click(function(){i.animate({height:"toggle"},500)});var p=jQuery(this._map.div),f=p.find("div");f&&0!=f.length?f.first().before(this.element):p.append(this.element),i.hide(),this._visibilityOff()},showMessage:function(e,t){if(!this._published){var i=this._locale,a=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=Oskari.clazz.create("Oskari.userinterface.component.Button");n.setTitle(i.buttons.ok),n.addClass("primary"),n.setHandler(function(){a.close(!0)}),a.show(e,t,[n])}},setManualBreaks:function(e){var t,i,a=this,n=[],s=this.element.find(".classificationMethod").find(".manualBreaks").find("input[name=breaksInput]").val().split(",");return s.length-1<this.minClassNum||s.length-1>this.maxClassNum?(t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=this._locale.classify.manualRangeError.replace(/\{min\}/,this.minClassNum+1).replace(/\{max\}/,this.maxClassNum+1),t.show(null,i),t.fadeout(),null):(jQuery.each(s,function(e,s){var r=Number(s);return isNaN(r)?(t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=a._locale.classify.nanError,t.show(null,i),t.fadeout(),null):(n.push(r),void 0)}),e.bounds=n,e.setRanges(),n)},setColors:function(){this.colorsets_div=[{colorname:"BrBG",type:"div",colors:["d8b365,5ab4ac","d8b365,f5f5f5,5ab4ac","a6611a,dfc27d,80cdc1,018571","a6611a,dfc27d,f5f5f5,80cdc1,018571","8c510a,d8b365,f6e8c3,c7eae5,5ab4ac,01665e","8c510a,d8b365,f6e8c3,f5f5f5,c7eae5,5ab4ac,01665e","8c510a,bf812d,dfc27d,f6e8c3,c7eae5,80cdc1,35978f,01665e","8c510a,bf812d,dfc27d,f6e8c3,f5f5f5,c7eae5,80cdc1,35978f,01665e","543005,8c510a,bf812d,dfc27d,f6e8c3,c7eae5,80cdc1,35978f,01665e,003c30","543005,8c510a,bf812d,dfc27d,f6e8c3,f5f5f5,c7eae5,80cdc1,35978f,01665e,003c30"]},{colorname:"PiYG",type:"div",colors:["e9a3c9,a1d76a","e9a3c9,f7f7f7,a1d76a","d01c8b,f1b6da,b8e186,4dac26","d01c8b,f1b6da,f7f7f7,b8e186,4dac26","c51b7d,e9a3c9,fde0ef,e6f5d0,a1d76a,4d9221","c51b7d,e9a3c9,fde0ef,f7f7f7,e6f5d0,a1d76a,4d9221","c51b7d,de77ae,f1b6da,fde0ef,e6f5d0,b8e186,7fbc41,4d9221","c51b7d,de77ae,f1b6da,fde0ef,f7f7f7,e6f5d0,b8e186,7fbc41,4d9221","8e0152,c51b7d,de77ae,f1b6da,fde0ef,e6f5d0,b8e186,7fbc41,4d9221,276419","8e0152,c51b7d,de77ae,f1b6da,fde0ef,f7f7f7,e6f5d0,b8e186,7fbc41,4d9221,276419"]},{colorname:"PRGn",type:"div",colors:["af8dc3,7fbf7b","af8dc3,f7f7f7,7fbf7b","7b3294,c2a5cf,a6dba0,008837","7b3294,c2a5cf,f7f7f7,a6dba0,008837","762a83,af8dc3,e7d4e8,d9f0d3,7fbf7b,1b7837","762a83,af8dc3,e7d4e8,f7f7f7,d9f0d3,7fbf7b,1b7837","762a83,9970ab,c2a5cf,e7d4e8,d9f0d3,a6dba0,5aae61,1b7837","762a83,9970ab,c2a5cf,e7d4e8,f7f7f7,d9f0d3,a6dba0,5aae61,1b7837","40004b,762a83,9970ab,c2a5cf,e7d4e8,d9f0d3,a6dba0,5aae61,1b7837,00441b","40004b,762a83,9970ab,c2a5cf,e7d4e8,f7f7f7,d9f0d3,a6dba0,5aae61,1b7837,00441b"]},{colorname:"PuOr",type:"div",colors:["f1a340,998ec3","f1a340,f7f7f7,998ec3","e66101,fdb863,b2abd2,5e3c99","e66101,fdb863,f7f7f7,b2abd2,5e3c99","b35806,f1a340,fee0b6,d8daeb,998ec3,542788","b35806,f1a340,fee0b6,f7f7f7,d8daeb,998ec3,542788","b35806,e08214,fdb863,fee0b6,d8daeb,b2abd2,8073ac,542788","b35806,e08214,fdb863,fee0b6,f7f7f7,d8daeb,b2abd2,8073ac,542788","7f3b08,b35806,e08214,fdb863,fee0b6,d8daeb,b2abd2,8073ac,542788,2d004b","7f3b08,b35806,e08214,fdb863,fee0b6,f7f7f7,d8daeb,b2abd2,8073ac,542788,2d004b"]},{colorname:"RdBu",type:"div",colors:["ef8a62,67a9cf","ef8a62,f7f7f7,67a9cf","ca0020,f4a582,92c5de,0571b0","ca0020,f4a582,f7f7f7,92c5de,0571b0","b2182b,ef8a62,fddbc7,d1e5f0,67a9cf,2166ac","b2182b,ef8a62,fddbc7,f7f7f7,d1e5f0,67a9cf,2166ac","b2182b,d6604d,f4a582,fddbc7,d1e5f0,92c5de,4393c3,2166ac","b2182b,d6604d,f4a582,fddbc7,f7f7f7,d1e5f0,92c5de,4393c3,2166ac","67001f,b2182b,d6604d,f4a582,fddbc7,d1e5f0,92c5de,4393c3,2166ac,053061","67001f,b2182b,d6604d,f4a582,fddbc7,f7f7f7,d1e5f0,92c5de,4393c3,2166ac,053061"]},{colorname:"RdGy",type:"div",colors:["ef8a62,999999","ef8a62,ffffff,999999","ca0020,f4a582,bababa,404040","ca0020,f4a582,ffffff,bababa,404040","b2182b,ef8a62,fddbc7,e0e0e0,999999,4d4d4d","b2182b,ef8a62,fddbc7,ffffff,e0e0e0,999999,4d4d4d","b2182b,d6604d,f4a582,fddbc7,e0e0e0,bababa,878787,4d4d4d","b2182b,d6604d,f4a582,fddbc7,ffffff,e0e0e0,bababa,878787,4d4d4d","67001f,b2182b,d6604d,f4a582,fddbc7,e0e0e0,bababa,878787,4d4d4d,1a1a1a","67001f,b2182b,d6604d,f4a582,fddbc7,ffffff,e0e0e0,bababa,878787,4d4d4d,1a1a1a"]},{colorname:"RdYlBu",type:"div",colors:["fc8d59,91bfdb","fc8d59,ffffbf,91bfdb","d7191c,fdae61,abd9e9,2c7bb6","d7191c,fdae61,ffffbf,abd9e9,2c7bb6","d73027,fc8d59,fee090,e0f3f8,91bfdb,4575b4","d73027,fc8d59,fee090,ffffbf,e0f3f8,91bfdb,4575b4","d73027,f46d43,fdae61,fee090,e0f3f8,abd9e9,74add1,4575b4","d73027,f46d43,fdae61,fee090,ffffbf,e0f3f8,abd9e9,74add1,4575b4","a50026,d73027,f46d43,fdae61,fee090,e0f3f8,abd9e9,74add1,4575b4,313695","a50026,d73027,f46d43,fdae61,fee090,ffffbf,e0f3f8,abd9e9,74add1,4575b4,313695"]},{colorname:"RdYlGn",type:"div",colors:["fc8d59,91cf60","fc8d59,ffffbf,91cf60","d7191c,fdae61,a6d96a,1a9641","d7191c,fdae61,ffffbf,a6d96a,1a9641","d73027,fc8d59,fee08b,d9ef8b,91cf60,1a9850","d73027,fc8d59,fee08b,ffffbf,d9ef8b,91cf60,1a9850","d73027,f46d43,fdae61,fee08b,d9ef8b,a6d96a,66bd63,1a9850","d73027,f46d43,fdae61,fee08b,ffffbf,d9ef8b,a6d96a,66bd63,1a9850","a50026,d73027,f46d43,fdae61,fee08b,d9ef8b,a6d96a,66bd63,1a9850,006837","a50026,d73027,f46d43,fdae61,fee08b,ffffbf,d9ef8b,a6d96a,66bd63,1a9850,006837"]},{colorname:"Spectral",type:"div",colors:["fc8d59,99d594","fc8d59,ffffbf,99d594","d7191c,fdae61,abdda4,2b83ba","d7191c,fdae61,ffffbf,abdda4,2b83ba","d53e4f,fc8d59,fee08b,e6f598,99d594,3288bd","d53e4f,fc8d59,fee08b,ffffbf,e6f598,99d594,3288bd","d53e4f,f46d43,fdae61,fee08b,e6f598,abdda4,66c2a5,3288bd","d53e4f,f46d43,fdae61,fee08b,ffffbf,e6f598,abdda4,66c2a5,3288bd","9e0142,d53e4f,f46d43,fdae61,fee08b,e6f598,abdda4,66c2a5,3288bd,5e4fa2","9e0142,d53e4f,f46d43,fdae61,fee08b,ffffbf,e6f598,abdda4,66c2a5,3288bd,5e4fa2"]}],this.colorsets_seq=[{colorname:"Blues",type:"seq",colors:["deebf7,3182bd","deebf7,9ecae1,3182bd","eff3ff,bdd7e7,6baed6,2171b5","eff3ff,bdd7e7,6baed6,3182bd,08519c","eff3ff,c6dbef,9ecae1,6baed6,3182bd,08519c","eff3ff,c6dbef,9ecae1,6baed6,4292c6,2171b5,084594","f7fbff,deebf7,c6dbef,9ecae1,6baed6,4292c6,2171b5,084594","f7fbff,deebf7,c6dbef,9ecae1,6baed6,4292c6,2171b5,08519c,08306b"]},{colorname:"BuGn",type:"seq",colors:["e5f5f9,2ca25f","e5f5f9,99d8c9,2ca25f","edf8fb,b2e2e2,66c2a4,238b45","edf8fb,b2e2e2,66c2a4,2ca25f,006d2c","edf8fb,ccece6,99d8c9,66c2a4,2ca25f,006d2c","edf8fb,ccece6,99d8c9,66c2a4,41ae76,238b45,005824","f7fcfd,e5f5f9,ccece6,99d8c9,66c2a4,41ae76,238b45,005824","f7fcfd,e5f5f9,ccece6,99d8c9,66c2a4,41ae76,238b45,006d2c,00441b"]},{colorname:"BuPu",type:"seq",colors:["e0ecf4,8856a7","e0ecf4,9ebcda,8856a7","edf8fb,b3cde3,8c96c6,88419d","edf8fb,b3cde3,8c96c6,8856a7,810f7c","edf8fb,bfd3e6,9ebcda,8c96c6,8856a7,810f7c","edf8fb,bfd3e6,9ebcda,8c96c6,8c6bb1,88419d,6e016b","f7fcfd,e0ecf4,bfd3e6,9ebcda,8c96c6,8c6bb1,88419d,6e016b","f7fcfd,e0ecf4,bfd3e6,9ebcda,8c96c6,8c6bb1,88419d,810f7c,4d004b"]},{colorname:"GnBu",type:"seq",colors:["e0f3db,43a2ca","e0f3db,a8ddb5,43a2ca","f0f9e8,bae4bc,7bccc4,2b8cbe","f0f9e8,bae4bc,7bccc4,43a2ca,0868ac","f0f9e8,ccebc5,a8ddb5,7bccc4,43a2ca,0868ac","f0f9e8,ccebc5,a8ddb5,7bccc4,4eb3d3,2b8cbe,08589e","f7fcf0,e0f3db,ccebc5,a8ddb5,7bccc4,4eb3d3,2b8cbe,08589e","f7fcf0,e0f3db,ccebc5,a8ddb5,7bccc4,4eb3d3,2b8cbe,0868ac,084081"]},{colorname:"Greens",type:"seq",colors:["e5f5e0,31a354","e5f5e0,a1d99b,31a354","edf8e9,bae4b3,74c476,238b45","edf8e9,bae4b3,74c476,31a354,006d2c","edf8e9,c7e9c0,a1d99b,74c476,31a354,006d2c","edf8e9,c7e9c0,a1d99b,74c476,41ab5d,238b45,005a32","f7fcf5,e5f5e0,c7e9c0,a1d99b,74c476,41ab5d,238b45,005a32","f7fcf5,e5f5e0,c7e9c0,a1d99b,74c476,41ab5d,238b45,006d2c,00441b"]},{colorname:"Greys",type:"seq",colors:["f0f0f0,636363","f0f0f0,bdbdbd,636363","f7f7f7,cccccc,969696,525252","f7f7f7,cccccc,969696,636363,252525","f7f7f7,d9d9d9,bdbdbd,969696,636363,252525","f7f7f7,d9d9d9,bdbdbd,969696,737373,525252,252525","ffffff,f0f0f0,d9d9d9,bdbdbd,969696,737373,525252,252525","ffffff,f0f0f0,d9d9d9,bdbdbd,969696,737373,525252,252525,000000"]},{colorname:"Oranges",type:"seq",colors:["fee6ce,e6550d","fee6ce,fdae6b,e6550d","feedde,fdbe85,fd8d3c,d94701","feedde,fdbe85,fd8d3c,e6550d,a63603","feedde,fdd0a2,fdae6b,fd8d3c,e6550d,a63603","feedde,fdd0a2,fdae6b,fd8d3c,f16913,d94801,8c2d04","fff5eb,fee6ce,fdd0a2,fdae6b,fd8d3c,f16913,d94801,8c2d04","fff5eb,fee6ce,fdd0a2,fdae6b,fd8d3c,f16913,d94801,a63603,7f2704"]},{colorname:"OrRd",type:"seq",colors:["fee8c8,e34a33","fee8c8,fdbb84,e34a33","fef0d9,fdcc8a,fc8d59,d7301f","fef0d9,fdcc8a,fc8d59,e34a33,b30000","fef0d9,fdd49e,fdbb84,fc8d59,e34a33,b30000","fef0d9,fdd49e,fdbb84,fc8d59,ef6548,d7301f,990000","fff7ec,fee8c8,fdd49e,fdbb84,fc8d59,ef6548,d7301f,990000","fff7ec,fee8c8,fdd49e,fdbb84,fc8d59,ef6548,d7301f,b30000,7f0000"]},{colorname:"PuBu",type:"seq",colors:["ece7f2,2b8cbe","ece7f2,a6bddb,2b8cbe","f1eef6,bdc9e1,74a9cf,0570b0","f1eef6,bdc9e1,74a9cf,2b8cbe,045a8d","f1eef6,d0d1e6,a6bddb,74a9cf,2b8cbe,045a8d","f1eef6,d0d1e6,a6bddb,74a9cf,3690c0,0570b0,034e7b","fff7fb,ece7f2,d0d1e6,a6bddb,74a9cf,3690c0,0570b0,034e7b","fff7fb,ece7f2,d0d1e6,a6bddb,74a9cf,3690c0,0570b0,045a8d,023858"]},{colorname:"PuBuGn",type:"seq",colors:["ece2f0,1c9099","ece2f0,a6bddb,1c9099","f6eff7,bdc9e1,67a9cf,02818a","f6eff7,bdc9e1,67a9cf,1c9099,016c59","f6eff7,d0d1e6,a6bddb,67a9cf,1c9099,016c59","f6eff7,d0d1e6,a6bddb,67a9cf,3690c0,02818a,016450","fff7fb,ece2f0,d0d1e6,a6bddb,67a9cf,3690c0,02818a,016450","fff7fb,ece2f0,d0d1e6,a6bddb,67a9cf,3690c0,02818a,016c59,014636"]},{colorname:"PuRd",type:"seq",colors:["e7e1ef,dd1c77","e7e1ef,c994c7,dd1c77","f1eef6,d7b5d8,df65b0,ce1256","f1eef6,d7b5d8,df65b0,dd1c77,980043","f1eef6,d4b9da,c994c7,df65b0,dd1c77,980043","f1eef6,d4b9da,c994c7,df65b0,e7298a,ce1256,91003f","f7f4f9,e7e1ef,d4b9da,c994c7,df65b0,e7298a,ce1256,91003f","f7f4f9,e7e1ef,d4b9da,c994c7,df65b0,e7298a,ce1256,980043,67001f"]},{colorname:"Purples",type:"seq",colors:["efedf5,756bb1","efedf5,bcbddc,756bb1","f2f0f7,cbc9e2,9e9ac8,6a51a3","f2f0f7,cbc9e2,9e9ac8,756bb1,54278f","f2f0f7,dadaeb,bcbddc,9e9ac8,756bb1,54278f","f2f0f7,dadaeb,bcbddc,9e9ac8,807dba,6a51a3,4a1486","fcfbfd,efedf5,dadaeb,bcbddc,9e9ac8,807dba,6a51a3,4a1486","fcfbfd,efedf5,dadaeb,bcbddc,9e9ac8,807dba,6a51a3,54278f,3f007d"]},{colorname:"RdPu",type:"seq",colors:["fde0dd,c51b8a","fde0dd,fa9fb5,c51b8a","feebe2,fbb4b9,f768a1,ae017e","feebe2,fbb4b9,f768a1,c51b8a,7a0177","feebe2,fcc5c0,fa9fb5,f768a1,c51b8a,7a0177","feebe2,fcc5c0,fa9fb5,f768a1,dd3497,ae017e,7a0177","fff7f3,fde0dd,fcc5c0,fa9fb5,f768a1,dd3497,ae017e,7a0177","fff7f3,fde0dd,fcc5c0,fa9fb5,f768a1,dd3497,ae017e,7a0177,49006a"]},{colorname:"Reds",type:"seq",colors:["fee0d2,de2d26","fee0d2,fc9272,de2d26","fee5d9,fcae91,fb6a4a,cb181d","fee5d9,fcae91,fb6a4a,de2d26,a50f15","fee5d9,fcbba1,fc9272,fb6a4a,de2d26,a50f15","fee5d9,fcbba1,fc9272,fb6a4a,ef3b2c,cb181d,99000d","fff5f0,fee0d2,fcbba1,fc9272,fb6a4a,ef3b2c,cb181d,99000d","fff5f0,fee0d2,fcbba1,fc9272,fb6a4a,ef3b2c,cb181d,a50f15,67000d"]},{colorname:"YlGn",type:"seq",colors:["f7fcb9,31a354","f7fcb9,addd8e,31a354","ffffcc,c2e699,78c679,238443","ffffcc,c2e699,78c679,31a354,006837","ffffcc,d9f0a3,addd8e,78c679,31a354,006837","ffffcc,d9f0a3,addd8e,78c679,41ab5d,238443,005a32","ffffe5,f7fcb9,d9f0a3,addd8e,78c679,41ab5d,238443,005a32","ffffe5,f7fcb9,d9f0a3,addd8e,78c679,41ab5d,238443,006837,004529"]},{colorname:"YlGnBu",type:"seq",colors:["edf8b1,2c7fb8","edf8b1,7fcdbb,2c7fb8","ffffcc,a1dab4,41b6c4,225ea8","ffffcc,a1dab4,41b6c4,2c7fb8,253494","ffffcc,c7e9b4,7fcdbb,41b6c4,2c7fb8,253494","ffffcc,c7e9b4,7fcdbb,41b6c4,1d91c0,225ea8,0c2c84","ffffd9,edf8b1,c7e9b4,7fcdbb,41b6c4,1d91c0,225ea8,0c2c84","ffffd9,edf8b1,c7e9b4,7fcdbb,41b6c4,1d91c0,225ea8,253494,081d58"]},{colorname:"YlOrBr",type:"seq",colors:["fff7bc,d95f0e","fff7bc,fec44f,d95f0e","ffffd4,fed98e,fe9929,cc4c02","ffffd4,fed98e,fe9929,d95f0e,993404","ffffd4,fee391,fec44f,fe9929,d95f0e,993404","ffffd4,fee391,fec44f,fe9929,ec7014,cc4c02,8c2d04","ffffe5,fff7bc,fee391,fec44f,fe9929,ec7014,cc4c02,8c2d04","ffffe5,fff7bc,fee391,fec44f,fe9929,ec7014,cc4c02,993404,662506"]},{colorname:"YlOrRd",type:"seq",colors:["ffeda0,f03b20","ffeda0,feb24c,f03b20","ffffb2,fecc5c,fd8d3c,e31a1c","ffffb2,fecc5c,fd8d3c,f03b20,bd0026","ffffb2,fed976,feb24c,fd8d3c,f03b20,bd0026","ffffb2,fed976,feb24c,fd8d3c,fc4e2a,e31a1c,b10026","ffffcc,ffeda0,fed976,feb24c,fd8d3c,fc4e2a,e31a1c,b10026","ffffcc,ffeda0,fed976,feb24c,fd8d3c,fc4e2a,e31a1c,bd0026,800026"]}],this.colorsets_qual=[{colorname:"Accent",type:"qual",colors:["7fc97f,fdc086","7fc97f,beaed4,fdc086","7fc97f,beaed4,fdc086,ffff99","7fc97f,beaed4,fdc086,ffff99,386cb0","7fc97f,beaed4,fdc086,ffff99,386cb0,f0027f","7fc97f,beaed4,fdc086,ffff99,386cb0,f0027f,bf5b17","7fc97f,beaed4,fdc086,ffff99,386cb0,f0027f,bf5b17,666666"]},{colorname:"Dark2",type:"qual",colors:["1b9e77,7570b3","1b9e77,d95f02,7570b3","1b9e77,d95f02,7570b3,e7298a","1b9e77,d95f02,7570b3,e7298a,66a61e","1b9e77,d95f02,7570b3,e7298a,66a61e,e6ab02","1b9e77,d95f02,7570b3,e7298a,66a61e,e6ab02,a6761d","1b9e77,d95f02,7570b3,e7298a,66a61e,e6ab02,a6761d,666666"]},{colorname:"Paired",type:"qual",colors:["a6cee3,b2df8a","a6cee3,1f78b4,b2df8a","a6cee3,1f78b4,b2df8a,33a02c","a6cee3,1f78b4,b2df8a,33a02c,fb9a99","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00,cab2d6","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00,cab2d6,6a3d9a","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00,cab2d6,6a3d9a,ffff99","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00,cab2d6,6a3d9a,ffff99,b15928"]},{colorname:"Pastel1",type:"qual",colors:["bb4ae,ccebc5","bb4ae,b3cde3,ccebc5","fbb4ae,b3cde3,ccebc5,decbe4","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6,ffffcc","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6,ffffcc,e5d8bd","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6,ffffcc,e5d8bd,fddaec","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6,ffffcc,e5d8bd,fddaec,f2f2f2"]},{colorname:"Pastel2",type:"qual",colors:["b3e2cd,cbd5e8","b3e2cd,fdcdac,cbd5e8","b3e2cd,fdcdac,cbd5e8,f4cae4","b3e2cd,fdcdac,cbd5e8,f4cae4,e6f5c9","b3e2cd,fdcdac,cbd5e8,f4cae4,e6f5c9,fff2ae","b3e2cd,fdcdac,cbd5e8,f4cae4,e6f5c9,fff2ae,f1e2cc","b3e2cd,fdcdac,cbd5e8,f4cae4,e6f5c9,fff2ae,f1e2cc,cccccc"]},{colorname:"Set1",type:"qual",colors:["e41a1c,4daf4a","e41a1c,377eb8,4daf4a","e41a1c,377eb8,4daf4a,984ea3","e41a1c,377eb8,4daf4a,984ea3,ff7f00","e41a1c,377eb8,4daf4a,984ea3,ff7f00,ffff33","e41a1c,377eb8,4daf4a,984ea3,ff7f00,ffff33,a65628","e41a1c,377eb8,4daf4a,984ea3,ff7f00,ffff33,a65628,f781bf","e41a1c,377eb8,4daf4a,984ea3,ff7f00,ffff33,a65628,f781bf,999999"]},{colorname:"Set2",type:"qual",colors:["66c2a5,8da0cb","66c2a5,fc8d62,8da0cb","66c2a5,fc8d62,8da0cb,e78ac3","66c2a5,fc8d62,8da0cb,e78ac3,a6d854","66c2a5,fc8d62,8da0cb,e78ac3,a6d854,ffd92f","66c2a5,fc8d62,8da0cb,e78ac3,a6d854,ffd92f,e5c494","66c2a5,fc8d62,8da0cb,e78ac3,a6d854,ffd92f,e5c494,b3b3b3"]},{colorname:"Set3",type:"qual",colors:["8dd3c7,bebada","8dd3c7,ffffb3,bebada","8dd3c7,ffffb3,bebada,fb8072","8dd3c7,ffffb3,bebada,fb8072,80b1d3","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5,d9d9d9","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5,d9d9d9,bc80bd","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5,d9d9d9,bc80bd,ccebc5","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5,d9d9d9,bc80bd,ccebc5,ffed6f"]}]},_getColors:function(e,t,i){var a=null;return a="div"==e?this.colorsets_div[t].colors[i]:"qual"==e?this.colorsets_qual[t].colors[i]:this.colorsets_seq[t].colors[i]},_visibilityOn:function(){this.element.show()},_visibilityOff:function(){this.element.hide()},_createColorDialog:function(){var e=this;e.dialog=Oskari.clazz.create("Oskari.userinterface.component.Popup"),e.content=e.templateContent.clone();var t=jQuery('<div class="colorset_sotka"><br>'+this._locale.colorset.setselection+'<br><select id="colo_set"></select><br></div>');e.content.append(t);var i=t.find("select"),a=jQuery('<option value="seq">'+this._locale.colorset.sequential+"</option>");i.append(a);var a=jQuery('<option value="qual">'+this._locale.colorset.qualitative+"</option>");i.append(a);var a=jQuery('<option value="div">'+this._locale.colorset.divergent+"</option>");i.append(a),i.change(function(){e._colorTableChanged()}),i.attr("value",e.currentColorSet),e.content.append(i);var n=e.templateInstructions2.clone();n.append(this._locale.colorset.info2),e.content.append(n),e.content.append(e._createColorTable()),e._hiliSelectedColors();var s=e.dialog.createCloseButton(this._locale.colorset.cancel);s.addClass("primary"),e.dialog.addClass("tools_selection"),e.dialog.show(this._locale.colorset.themeselection,e.content,[s])},_createColorTable:function(){var e=this,t=jQuery('<table class="colo_table1"></table>'),i=5,a=null,n=3;"div"==e.currentColorSet?(i=this.colorsets_div.length,a=e.colorsets_div):"qual"==e.currentColorSet?(i=e.colorsets_qual.length,a=this.colorsets_qual):(i=e.colorsets_seq.length,a=e.colorsets_seq);for(var s=5,r=jQuery("<tbody></tbody>"),o=0;i>o;o++){var l=jQuery("<td></td>");l.attr("data-colorIdx",o);for(var u=a[o].colors[n],c=u.split(","),h=jQuery("<div></div>"),d=0;s>d;d++){var p=h.clone();p.css("background-color","#"+c[d]),l.append(p)}l.mouseover(function(){jQuery(this).hasClass("selected")||jQuery(this).addClass("hover")}),l.mouseout(function(){jQuery(this).removeClass("hover")}),l.click(function(){var t=jQuery(this).attr("data-colorIdx");e._selectedColors(t)}),r.append(l)}return t.append(r),t},_selectedColors:function(e){var t=this;t.colorsetIndex=e,t._hiliSelectedColors(),t.currentColorSet=t.content.find("select#colo_set").val(),t.classifyData()},_hiliSelectedColors:function(){var e=this;if(e.content){var t=0;t="div"==e.currentColorSet?e.colorsets_div.length:"qual"==e.currentColorSet?e.colorsets_qual.length:e.colorsets_seq.length,e.content.find("td").removeClass("selected"),e.content.find("td[data-colorIdx="+e.colorsetIndex.toString()+"]").addClass("selected")}},_hoverZoomColorTable:function(e){var t=e.clone();t.find("div").width("18px");var i=jQuery('<table class="table_temp"></table>'),a=jQuery("<tbody></tbody>");a.append(t),i.append(a);var n=jQuery('<div id="pop-up_06052013">  </div>');n.append(i),e.append(n),n.hide(),e.hover(function(){jQuery(this).find("div#pop-up_06052013").fadeIn("slow")},function(){jQuery(this).find("div#pop-up_06052013").fadeOut("slow")})},_colorTableChanged:function(){var e=this;if(e.content){e.currentColorSet=e.content.find("select#colo_set").val(),e.content.find(".colo_table1").remove();var t=e._createColorTable(),i=5,a=2,n=9;"div"==e.currentColorSet?(i=this.colorsets_div.length,n=11):"qual"==e.currentColorSet?(i=e.colorsets_qual.length,n=8):i=e.colorsets_seq.length,e.colorsetIndex>i&&(e.colorsetIndex=i-1);var s=Number(e.element.find(".classificationMethod").find(".classCount").find("#amount_class").val());s>n&&(s=n,e.element.find(".classificationMethod").find(".classCount").find("#amount_class").attr("value",n));var r=e.element.find(".classificationMethod").find(".classCount");r.find("#slider-range-max").remove();var o=jQuery('<div id="slider-range-max"></div>');r.append(o),r.find("#slider-range-max").slider({range:"min",min:a,max:n,value:s,slide:function(t,i){jQuery("input#amount_class").val(i.value),jQuery(this).slider("option","value",i.value),e.classifyData()}}),e.content.find(".instructions2").append(t),e._hiliSelectedColors()}},_flipCurrentColors:function(){this.colorsFlipped=this.colorsFlipped?!1:!0,this.classifyData()},_adjustClassificationSlider:function(e){var t=jQuery("#slider-range-max"),i=t.slider("option","value"),a=e<this.maxClassNum?e>2?e:3:this.maxClassNum;return a--,i=a>i?i>2?i:2:a,t.slider("option","min",2),t.slider("option","max",a),t.slider("option","value",i),3>a?t.slider("option","disabled",!0):t.slider("option","disabled",!1),jQuery("input#amount_class").val(i),t}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.plugin.ManageStatsPlugin",function(e,t){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._layer=null,this._state=null,this.element=void 0,this.statsService=null,this.indicators=[],this.selectedMunicipalities={},defaults={statistics:[{id:"avg",visible:!0},{id:"max",visible:!0},{id:"min",visible:!0},{id:"mde",visible:!0},{id:"mdn",visible:!0},{id:"std",visible:!0},{id:"sum",visible:!0}]},this.conf=jQuery.extend(!0,e,defaults),this._locale=t||{},this.templates={csvButton:'<button class="statsgrid-csv-button">csv</button>',statsgridTotalsVar:'<span class="statsgrid-variable"></span>',subHeader:'<span class="statsgrid-grid-subheader"></span>',gridHeaderMenu:'<li><input type="checkbox" /><label></label></li>',groupingHeader:'<span style="color:green"></span>',toolbarButton:'<button class="statsgrid-select-municipalities"></button>',filterPopup:'<div class="indicator-filter-popup"><p class="filter-desc"></p><div class="filter-container"></div></div>',filterRow:'<div class="filter-row"><div class="filter-label"></div><div class="filter-value"></div></div>',filterSelect:'<div><select class="filter-select"></select><div class="filter-inputs-container"></div></div>',filterOption:"<option></option>",filterInputs:'<input type="text" class="filter-input filter-input1" /><span class="filter-between" style="display:none;">-</span><input type="text" class="filter-input filter-input2" style="display:none;" />',filterLink:'<a href="javascript:void(0);"></a>'}},{__name:"ManageStatsPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},register:function(){},unregister:function(){},init:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.statsService=e.getService("Oskari.statistics.bundle.statsgrid.StatisticsService"),this._published=this.conf.published||!1,this._state=this.conf.state||{},this._layer=this.conf.layer||null,this.selectMunicipalitiesMode=!1},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this.element&&(this.element.remove(),this.element=void 0,delete this.element)},eventHandlers:{"MapStats.FeatureHighlightedEvent":function(e){this.selectMunicipalitiesMode?this._featureSelectedEvent(e):this._featureHighlightedEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},getLayer:function(){return this._layer},setLayer:function(e){this._layer=e},setState:function(e){this._state=e},createStatsOut:function(e){this.prepareIndicatorParams(e),e.on("keyup",function(e){e.stopPropagation()}),e.on("keydown",function(e){e.stopPropagation()})},prepareIndicatorParams:function(e){if(!this._published){e.find("selectors-container").remove();var t=jQuery('<div class="selectors-container"></div>');e.append(t);var i=this;if(i.conf.csvDownload){var a=jQuery(i.templates.csvButton);t.append(a),a.click(function(){if(i.dataView){var e=i.dataView.getItems();i.downloadJSON2CSV(e)}})}this.getSotkaIndicators(e)}this.getSotkaRegionData(e)},getSotkaRegionData:function(e){var t=this;t.statsService.fetchStatsData(t._sandbox.getAjaxUrl()+"action_route=GetSotkaData&action=regions&version=1.1",function(i){i?(t.createMunicipalitySlickGrid(e,i),t._state&&t.loadStateIndicators(t._state,e)):t.showMessage(t._locale.sotka.errorTitle,t._locale.sotka.regionDataError)},function(){t.showMessage(t._locale.sotka.errorTitle,t._locale.sotka.regionDataXHRError)})},createMunicipalitySlickGrid:function(e,t){var i,a=this,n=jQuery('<div id="municipalGrid" class="municipal-grid"></div>');e.find(".municipal-grid").remove(),e.append(n);var s=new Slick.CheckboxSelectColumn2({cssClass:"slick-cell-checkboxsel"});this.checkboxSelector=s;for(var r=[a.checkboxSelector.getColumnDefinition(),{id:"municipality",name:this._locale.sotka.municipality,field:"municipality",sortable:!0},{id:"code",name:this._locale.sotka.code,field:"code"}],o={enableCellNavigation:!0,enableColumnReorder:!0,multiColumnSort:!0,showHeaderRow:!0,headerRowHeight:97},l=[],u=0,c=0;c<t.length;c++){var h=t[c];"KUNTA"==h.category&&(l[u]={id:h.id,code:h.code,municipality:h.title[Oskari.getLang()],sel:"checked"},u++)}var d=new Slick.Data.GroupItemMetadataProvider;dataView=new Slick.Data.DataView({groupItemMetadataProvider:d,inlineFilters:!0}),dataView.onRowsChanged.subscribe(function(e,t){i.invalidateRows(t.rows),i.render()}),dataView.setGrouping({getter:"sel",comparer:function(e,t){return"checked"==e.groupingKey&&e.groupingKey==t.groupingKey?0:e.groupingKey<t.groupingKey?1:-1},formatter:function(e){var t=("checked"==e.groupingKey?a._locale.municipality:a._locale.not_included)+" ("+e.count+")";return"<span style='color:green'>"+t+"</span>"},aggregateCollapsed:!1}),i=new Slick.Grid(n,dataView,r,o),i.onSort.subscribe(function(e,t){var a=jQuery(e.target);if(!a.hasClass("slick-header-menubutton")){var n=t.sortCols;dataView.sort(function(e,t){for(var i=0,a=n.length;a>i;i++){var s=n[i].sortCol.field,r=n[i].sortAsc?1:-1,o=e[s],l=t[s];if(null==o)return 1;if(null==l)return-1;var u=(o==l?0:o>l?1:-1)*r;if(0!=u)return u}return 0}),i.invalidate(),i.render()}}),i.onHeaderClick.subscribe(function(e,t){return t.column.id===a._state.currentColumn?!1:(a.sendStatsData(t.column),void 0)}),i.onHeaderRowCellRendered.subscribe(function(e,t){jQuery(t.node).empty(),jQuery(a.templates.subHeader).appendTo(t.node)}),i.onColumnsReordered.subscribe(function(){a.dataView.refresh()}),i.registerPlugin(s),i.registerPlugin(d),s.onSelectRowClicked.subscribe(function(e,t){var i=t.grid.getData(),n=i.getItem(t.row),s=i.getGroups().length;if(n.sel=jQuery(e.target).is(":checked")?"checked":"empty",i.updateItem(n.id,n),groups=i.getGroups(),groups.length>1)for(var r=0;r<groups.length;r++){var o=groups[r];"empty"==o.groupingKey&&o.count<2&&1==s&&i.collapseGroup("empty")}var l=a._getColumnById(a._state.currentColumn);a.sendStatsData(l),t.grid.setColumns(t.grid.getColumns()),i.refresh()}),s.onSelectHeaderRowClicked.subscribe(function(){var e=a._getColumnById(a._state.currentColumn);a.sendStatsData(e)}),a._initHeaderPlugin(r,i),dataView.beginUpdate(),dataView.setItems(l),dataView.endUpdate(),i.invalidate(),i.render(),a.grid=i,a.dataView=dataView,a.setGridHeight();var p;jQuery(window).resize(function(){clearTimeout(p),p=setTimeout(function(){a.setGridHeight()},100)})},setGridHeight:function(){var e=jQuery("#municipalGrid"),t=e.parent(),i=t.find(".selectors-container"),a=0;i.length>0&&(a=i.outerHeight()),e.height(t.height()-a),this.grid.resizeCanvas()},getIdxByCode:function(e){var t,i=this.dataView?this.dataView.getItems():[],a=null;for(t=0;t<i.length;++t)if(i[t].code===e){a=i[t];break}if(a){var n=this.dataView.getRowById(a.id);return n?n:-1}return null},getItemByCode:function(e){var t,i=this.dataView?this.dataView.getItems():[],a=null;for(t=0;t<i.length;++t)if(i[t].code===e){a=i[t];break}return a?this.dataView.getItemById(a.id):null},getSotkaIndicators:function(e){var t=this,i=t._sandbox;t.statsService.fetchStatsData(i.getAjaxUrl()+"action_route=GetSotkaData&action=indicators&version=1.1",function(i){i?t.createIndicatorsSelect(e,i):t.showMessage(t._locale.sotka.errorTitle,t._locale.sotka.indicatorsDataError)},function(){t.showMessage(t._locale.sotka.errorTitle,t._locale.sotka.indicatorsDataXHRError)})},createIndicatorsSelect:function(e,t){for(var i=this,a=jQuery('<div class="indicator-cont"><div class="indisel selector-cont"><label for="indi">'+this._locale.indicators+'</label><select id="indi" name="indi" class="indi"><option value="" selected="selected"></option></select></div></div>'),n=a.find("select"),s=0;s<t.length;s++){var r=t[s];
for(var o in r)if("id"==o){var l=r[o],u=r.title[Oskari.getLang()],c=jQuery('<option value="'+l+'">'+u+"</option>");n.append(c),t[s].titlename=u}}n.change(function(){var t=n.find("option:selected").val();i.deleteIndicatorInfoButton(e),i.deleteDemographicsSelect(e),i.getSotkaIndicatorMeta(e,t)}),e.find(".selectors-container").append(a),n.chosen({no_results_text:this._locale.noMatch,placeholder_text:this._locale.selectIndicator}),jQuery(".chzn-drop").css("width","298px"),jQuery(".chzn-search input").css("width","263px")},getSotkaIndicatorMeta:function(e,t){var i=this,a=i._sandbox;i.statsService.fetchStatsData(a.getAjaxUrl()+"action_route=GetSotkaData&action=indicator_metadata&indicator="+t+"&version=1.1",function(t){t?(i.createIndicatorInfoButton(e,t),i.createDemographicsSelects(e,t)):i.showMessage(i._locale.sotka.errorTitle,i._locale.sotka.indicatorMetaError)},function(){i.showMessage(i._locale.sotka.errorTitle,i._locale.sotka.indicatorMetaXHRError)})},createIndicatorInfoButton:function(e,t){var i=this,a=jQuery('<div class="icon-info"></div>'),n=e.find(".indicator-cont");n.find(".icon-info").remove(),n.append(a),a.click(function(){var e=Oskari.getLang(),a='<h4 class="indicator-msg-popup">'+i._locale.sotka.descriptionTitle+"</h4><p>"+t.description[e]+'</p><br/><h4 class="indicator-msg-popup">'+i._locale.sotka.sourceTitle+"</h4><p>"+t.organization.title[e]+"</p>";i.showMessage(t.title[e],a)})},deleteIndicatorInfoButton:function(e){e.find(".indicator-cont").find(".icon-info").remove()},createDemographicsSelects:function(e,t){var i=this;this.indicators.push(t);var a=e.find(".selectors-container"),n=jQuery('<div class="parameters-cont"></div>'),s=null,r=null;null!=t.range&&(n.append(this.getYearSelectorHTML(t.range.start,t.range.end)),s=t.range.end),null!=t.classifications&&null!=t.classifications.sex&&(n.append(this.getGenderSelectorHTML(t.classifications.sex.values)),r=t.classifications.sex.values[t.classifications.sex.values.length-1]),r=null!=r?r:"total";var o=i._getIndicatorColumnId(t.id,r,s),l=this.isIndicatorInGrid(o),u=jQuery('<button class="fetch-data'+(l?" hidden":"")+'">'+this._locale.addColumn+"</button>"),c=jQuery('<button class="remove-data'+(l?"":" hidden")+'">'+this._locale.removeColumn+"</button>");n.append(u),n.append(c),a.find(".parameters-cont").remove(),a.append(n),u.click(function(a){jQuery(a.currentTarget);var n=jQuery(".statsgrid").find(".yearsel").find(".year").val(),s=jQuery(".statsgrid").find(".gendersel").find(".gender").val();s=null!=s?s:"total",i._getIndicatorColumnId(t.id,s,n),i.getSotkaIndicatorData(e,t.id,s,n)}),c.click(function(){var e=jQuery(".statsgrid").find(".yearsel").find(".year").val(),a=jQuery(".statsgrid").find(".gendersel").find(".gender").val();a=null!=a?a:"total",i._getIndicatorColumnId(t.id,a,e),i.removeIndicatorDataFromGrid(t.id,a,e)})},deleteDemographicsSelect:function(e){e.find(".parameters-cont").remove()},updateDemographicsButtons:function(e,t,i){e=e?e:jQuery(".statsgrid").find(".indisel ").find("option:selected").val(),t=t?t:jQuery(".statsgrid").find(".gendersel").find(".gender").val(),t=null!=t?t:"total",i=i?i:jQuery(".statsgrid").find(".yearsel").find(".year").val();var a="indicator"+e+i+t,n=this.isIndicatorInGrid(a);n?(jQuery(".statsgrid").find(".fetch-data").addClass("hidden"),jQuery(".statsgrid").find(".remove-data").removeClass("hidden")):(jQuery(".statsgrid").find(".fetch-data").removeClass("hidden"),jQuery(".statsgrid").find(".remove-data").addClass("hidden"))},isIndicatorInGrid:function(e){for(var t=this.grid.getColumns(),i=0,a=t.length;a>i;i++)if(e===t[i].id)return!0;return!1},getSotkaIndicatorData:function(e,t,i,a){var n=this,s=null!=i?i:"total";n.statsService.fetchStatsData(n._sandbox.getAjaxUrl()+"action_route=GetSotkaData&action=data&version=1.0&indicator="+t+"&years="+a+"&genders="+s,function(i){i?(null==n._state.indicators&&(n._state.indicators=[]),n._state.indicators.push({indicator:t,year:a,gender:s}),n.addIndicatorDataToGrid(e,t,s,a,i,n.indicators[n.indicators.length-1])):n.showMessage(n._locale.sotka.errorTitle,n._locale.sotka.indicatorDataError)},function(){n.showMessage(n._locale.sotka.errorTitle,n._locale.sotka.indicatorDataXHRError)})},_getIndicatorColumnId:function(e,t,i){var a="indicator"+e+i+t;return a},addIndicatorDataToGrid:function(e,t,i,a,n,s,r){var o=this,l=o._getIndicatorColumnId(t,i,a),u=o.grid.getColumns(),c=s.title[Oskari.getLang()],l="indicator"+t+a+i;if(o.isIndicatorInGrid(l))return!1;var h=c+"/"+a+"/"+i;u.push({id:l,name:h,field:l,toolTip:h,sortable:!0,header:{menu:{items:[{element:jQuery(o.templates.filterLink).text(o._locale.filter),command:"filter",actionType:"link"}]},icon:"icon-funnel"},groupTotalsFormatter:function(e,t){var i="";valueCount=0;for(var a=e.group.rows,n=0;n<a.length;n++){var s=a[n];null!=s[t.field]&&valueCount++}return i=valueCount+" "+o._locale.values}}),o.grid.setColumns(u);var d=0;o.dataView.beginUpdate();for(var p=0;p<n.length;p++){var f=n[p],m="",g="";for(var y in f)"region"==y?m=f[y]:"primary value"==y&&(g=f[y],g=g.replace(",","."));if(m){var v=o.dataView.getItemById(m);v&&(v[l]=Number(g),o.dataView.updateItem(v.id,v)),d++}}for(var b=o.dataView.getItems(),p=b.length-1;p>=0;p--){var v=b[p];null==v[l]&&(v[l]=null)}for(var _=[],p=0;p<u.length;p++){var k=u[p].id;_.push(new Slick.Data.Aggregators.Avg(k)),_.push(new Slick.Data.Aggregators.Std(k)),_.push(new Slick.Data.Aggregators.Mdn(k)),_.push(new Slick.Data.Aggregators.Mde(k)),_.push(new Slick.Data.Aggregators.Sum(k)),_.push(new Slick.Data.Aggregators.Max(k)),_.push(new Slick.Data.Aggregators.Min(k))}o.dataView.setAggregators(_,!0),o.dataView.setTotalsCallback(function(e){o._updateTotals(e)}),o.dataView.endUpdate(),o.dataView.refresh(),o.grid.invalidateAllRows(),o.grid.render(),1!=r&&o.sendStatsData(u[u.length-1]),o.updateDemographicsButtons(t,i,a),o.grid.setSortColumn(o._state.currentColumn,!0)},removeIndicatorDataFromGrid:function(e,t,i){var a=this._getIndicatorColumnId(e,t,i),n=this.grid.getColumns(),s=[],r=!1,o=0,l=0,u=0;for(o=0,l=n.length,u=0;l>o;o++)a===n[o].id?r=!0:(s[u]=n[o],u++);if(r&&(this.grid.setColumns(s),this.grid.render(),this.dataView.refresh()),this._state.indicators)for(o=0,l=this._state.indicators.length;l>o;o++){var c=this._state.indicators[o];if(e===c.indicator&&i===c.year&&t===c.gender){this._state.indicators.splice(o,1);break}}this.updateDemographicsButtons(e,t,i),a===this._state.currentColumn&&(this._setLayerVisibility(!1),this._state.currentColumn=null)},getYearSelectorHTML:function(e,t){for(var i=this,a=jQuery('<div class="yearsel selector-cont"><label for="year">'+this._locale.year+'</label><select name="year" class="year"></select></div>'),n=a.find("select"),s=e;t>=s;s++){var r=jQuery('<option value="'+s+'">'+s+"</option>");n.append(r)}return n.val(t),n.change(function(e){i.updateDemographicsButtons(null,null,e.target.value)}),a},getGenderSelectorHTML:function(e){for(var t=this,i=jQuery('<div class="gendersel selector-cont"><label for="gender">'+this._locale.gender+'</label><select name="gender" class="gender"></select></div>'),a=i.find("select"),n=0;n<e.length;n++){var s=jQuery('<option value="'+e[n]+'">'+this._locale.genders[e[n]]+"</option>");a.append(s)}return a.val(e[e.length-1]),a.change(function(e){t.updateDemographicsButtons(null,e.target.value,null)}),i},sendStatsData:function(e){if(!(null==e||e.field.indexOf("indicator")<0)){var t,i=this,a=[],n=[],s=i._state.municipalities=[];i._state.currentColumn=e.id;var r=this.dataView.getItems();for(t=0;t<r.length;t++){var o=r[t];"checked"==o.sel&&(s.push(o.id),o[e.field]&&(a.push(o[e.field]),n.push(o.code)))}i.statsService.sendStatsData(i._layer,{CHECKED_COUNT:this.getItemsByGroupingKey("checked").length,CUR_COL:e,VIS_NAME:i._layer.getWmsName(),VIS_ATTR:i._layer.getFilterPropertyName(),VIS_CODES:n,COL_VALUES:a}),this._setLayerVisibility(!0)}},_setLayerVisibility:function(e){if(this._layer._visible!==e){var t=this._sandbox,i=t.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest");if(i){var a=i(this._layer.getId(),e);t.request(this,a)}}},getSotkaIndicatorsMeta:function(e,t,i){var a=this,n=0;a.indicators=[];for(var s=0;s<t.length;s++){var r=t[s],o=r.indicator;a.statsService.fetchStatsData(a._sandbox.getAjaxUrl()+"action_route=GetSotkaData&action=indicator_metadata&indicator="+o+"&version=1.1",function(e){if(n++,e){for(var s=0;s<t.length;s++)t[s].indicator==e.id&&(a.indicators[s]=e);n>=t.length&&i()}else a.showMessage(a._locale.sotka.errorTitle,a._locale.sotka.indicatorDataError)},function(){a.showMessage(a._locale.sotka.errorTitle,a._locale.sotka.indicatorDataXHRError),n++})}},getSotkaIndicatorsData:function(e,t,i){for(var a=this,n=0,s={},r=0;r<t.length;r++){var o=t[r],l=o.indicator,u=o.year,c=null!=o.gender?o.gender:"total";a.statsService.fetchStatsData(a._sandbox.getAjaxUrl()+"action_route=GetSotkaData&action=data&version=1.0&indicator="+l+"&years="+u+"&genders="+c,function(r){if(n++,r){for(var o=0;o<t.length;o++){var l=t[o];if(l.indicator==r[0].indicator&&l.year==r[0].year&&l.gender==r[0].gender){var u=a._getIndicatorColumnId(l.indicator,l.gender,l.year);s[u]=r}}if(n>=t.length){for(var o=0;o<t.length;o++){var l=t[o];if(l){var u=a._getIndicatorColumnId(l.indicator,l.gender,l.year),c=s[u];a.addIndicatorDataToGrid(e,l.indicator,l.gender,l.year,c,a.indicators[o],!0)}}i()}}else a.showMessage(a._locale.sotka.errorTitle,a._locale.sotka.indicatorDataError)},function(){a.showMessage(a._locale.sotka.errorTitle,a._locale.sotka.indicatorDataXHRError),n++})}},clearDataFromGrid:function(){if(this.grid){for(var e=this.grid.getColumns(),t=[],i=0,a=0;a<e.length;a++){var n=e[a].id;("id"==n||"municipality"==n||"code"==n||"_checkbox_selector"==n)&&(t[i]=e[a],i++)}this.grid.setColumns(t),this.grid.render(),this.dataView.refresh()}},showMessage:function(e,t,i){if(!this._published){var a=this._locale,n=Oskari.clazz.create("Oskari.userinterface.component.Popup");if(i)n.show(e,t,i);else{var s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(a.buttons.ok),s.addClass("primary"),s.setHandler(function(){n.close(!0)}),n.show(e,t,[s])}}},loadStateIndicators:function(e,t){var i=this,a=this._sandbox.findRegisteredModuleInstance("MainMapModuleManageClassificationPlugin");i.clearDataFromGrid(),e.indicators&&e.indicators.length>0&&i.getSotkaIndicatorsMeta(t,e.indicators,function(){i.getSotkaIndicatorsData(t,e.indicators,function(){if(null!=e.currentColumn){if(a){if(e.colors&&(a.currentColorSet=e.colors.set,a.colorsetIndex=e.colors.index,a.colorsFlipped=e.colors.flipped),null!=e.methodId&&e.methodId>0){var t=a.element.find(".classificationMethod").find(".method");if(t.val(e.methodId),4==e.methodId&&e.manualBreaksInput){var n=a.element.find(".manualBreaks").find("input[name=breaksInput]");n.val(e.manualBreaksInput),a.element.find(".classCount").hide(),a.element.find(".manualBreaks").show()}}if(null!=e.numberOfClasses&&e.numberOfClasses>0){var s=a.rangeSlider;null!=s&&(s.slider("value",e.numberOfClasses),s.parent().find("input#amount_class").val(e.numberOfClasses))}}e.municipalities&&i._showSelectedAreas(e.municipalities);var r=i._getColumnById(e.currentColumn);i.sendStatsData(r),i.grid.setSortColumn(e.currentColumn,!0)}})})},_updateTotals:function(e){if(e)for(var t=this.grid.getColumns(),i=0;i<t.length;i++){var a=t[i],n=e[0];for(var s in e)g=e[s],"checked"==g.groupingKey&&(n=g);for(var r=n.totals,o=jQuery(this.templates.subHeader),l=0,u=0;u<this.conf.statistics.length;u++){var c=this.conf.statistics[u];c.visible&&(o.append(this._getStatistic(r,a.id,c.id)),l++)}var h=jQuery(this.grid.getHeaderRowColumn(a.id)).empty(),d=this.grid.getOptions(),p=h.css("line-height");p=p?p.split("px")[0]:12,d.headerRowHeight=l*p+7,this.grid.setOptions(d),o.appendTo(h)}},_getStatistic:function(e,t,i){var a={},n=null,s=e[i];for(indicatorId in s){if(a[indicatorId]||(a[indicatorId]={}),indicatorId.indexOf("indicator")>=0&&indicatorId==t){a[indicatorId][i]=s[indicatorId];var n=jQuery(this.templates.statsgridTotalsVar),r=a[t][i];this._isInt(r)||(r=r.toFixed(2)),n.addClass("statsgrid-"+i).text(r);break}if("municipality"==t){var n=jQuery(this.templates.statsgridTotalsVar);n.addClass("statsgrid-totals-label").text(this._locale.statistic[i]);break}}return n},_isInt:function(e){return 0===e%1},_initHeaderPlugin:function(e,t){for(var i=this,a=0;a<e.length;a++){var n=e[a];"municipality"==n.id&&(n.header={menu:{items:[]}})}var s=new Slick.Plugins.HeaderMenu2({});s.onBeforeMenuShow.subscribe(function(e,t){var a=t.menu;if("municipality"==t.column.id){a.items=[];for(var n=0;n<i.conf.statistics.length;n++){var s=i.conf.statistics[n],r=jQuery(i.templates.gridHeaderMenu).addClass("statsgrid-show-total-selects"),o=r.find("input").attr({id:"statistics_"+s.id});s.visible&&o.attr({checked:"checked"}),r.find("label").attr("for","statistics_"+s.id).text(i._locale.statistic[s.id]),a.items.push({element:r,command:s.id})}for(var l=t.grid.getColumns(),u=!1,n=0;n<l.length;n++){var c=l[n];"sel"==c.field&&(u=!0)}var h=jQuery(i.templates.gridHeaderMenu).addClass("statsgrid-show-row-selects"),o=h.find("input").attr({id:"statsgrid-show-row-selects"});u&&o.attr("checked","checked"),h.find("label").attr("for","statsgrid-show-row-selects").text(i._locale.selectRows),a.items.push({element:h,command:"selectRows"})}}),s.onCommand.subscribe(function(e,t){if("selectRows"==t.command){for(var a=t.grid.getColumns(),n=[],s=!0,r=0;r<a.length;r++){var o=a[r];"sel"!=o.field&&n.push(o),"sel"!=o.field||jQuery(e.target).is(":checked")||(s=!1)}s&&n.unshift(i.checkboxSelector.getColumnDefinition()),t.grid.setColumns(n)}else if("filter"==t.command)i._createFilterPopup(t.column,this);else{for(var r=0;r<i.conf.statistics.length;r++){var l=i.conf.statistics[r];if(l.id==t.command){l.visible=!l.visible;break}}i.dataView.refresh(),i.grid.setColumns(i.grid.getColumns()),i.dataView.refresh()}}),t.registerPlugin(s)},_createFilterPopup:function(e,t){var i=this,a=jQuery(i.templates.filterPopup);a.find(".filter-desc").text(i._locale.indicatorFilterDesc);var n=jQuery(i.templates.filterRow);n.find(".filter-label").text(i._locale.filterIndicator),n.find(".filter-value").text(e.name),a.find(".filter-container").append(n);var s=jQuery(i.templates.filterRow);s.find(".filter-label").text(i._locale.filterCondition);var r=jQuery(i.templates.filterSelect),o=r.find(".filter-select");o.append(jQuery(i.templates.filterOption).val("").text(i._locale.filterSelectCondition)),o.append(jQuery(i.templates.filterOption).val(">").text(i._locale.filterGT)),o.append(jQuery(i.templates.filterOption).val(">=").text(i._locale.filterGTOE)),o.append(jQuery(i.templates.filterOption).val("=").text(i._locale.filterE)),o.append(jQuery(i.templates.filterOption).val("<=").text(i._locale.filterLTOE)),o.append(jQuery(i.templates.filterOption).val("<").text(i._locale.filterLT)),o.append(jQuery(i.templates.filterOption).val("...").text(i._locale.filterBetween)),s.find(".filter-value").append(r),o.change(function(e){var t=jQuery(e.target),i=t.val(),a=t.parents(".filter-value");"..."==i?(a.find(".filter-between").css("display","block"),a.find(".filter-input2").css("display","block")):(a.find(".filter-input2").css("display","none"),a.find(".filter-between").css("display","none"))}),a.find(".filter-container").append(s);var l=jQuery(i.templates.filterInputs);a.find(".filter-inputs-container").append(l);var u=Oskari.clazz.create("Oskari.userinterface.component.Popup"),c=Oskari.clazz.create("Oskari.userinterface.component.Button");c.setTitle(i._locale.buttons.cancel),c.setHandler(function(){a.off(),t.hide(),u.close(!0)});var h=Oskari.clazz.create("Oskari.userinterface.component.Button");h.setTitle(i._locale.buttons.filter),h.addClass("primary"),h.setHandler(function(n){var s=[],r=jQuery(n.target).parents(".divmanazerpopup"),l=r.find(".filter-input1");if(s.push(l.val()),"..."==o.val()){var c=r.find(".filter-input2");s.push(c.val())}i.filterColumn(e,o.val(),s),a.off(),t.hide(),u.close(!0)}),u.show(i._locale.filterTitle,a,[c,h]),a.on("keydown",function(e){e.stopPropagation()})},filterColumn:function(e,t,i){for(var a=this.grid.getData(),n=a.getItems(),s=0;s<n.length;s++){var r=n[s];if("checked"==r.sel){if(null==r[e.id])r.sel="empty";else switch(t){case">":r[e.id]>i[0]||(r.sel="empty");break;case">=":r[e.id]>=i[0]||(r.sel="empty");break;case"=":r[e.id]!=i[0]&&(r.sel="empty");break;case"<=":r[e.id]<=i[0]||(r.sel="empty");break;case"<":r[e.id]<i[0]||(r.sel="empty");break;case"...":i[0]<r[e.id]&&r[e.id]<i[1]||(r.sel="empty")}a.updateItem(r.id,r)}}this.dataView.refresh(),a.collapseGroup("empty"),this.sendStatsData(e)},downloadJSON2CSV:function(e){for(var t="object"!=typeof e?JSON.parse(e):e,i="",a=0;a<t.length;a++){var n="";for(var s in t[a])n+=t[a][s]+",";n.slice(0,n.Length-1),i+=n+"\r\n"}window.open("data:text/csv;charset=utf-8,"+escape(i))},_featureHighlightedEvent:function(e){var t=e.getFeature().attributes,i=e.isHighlighted(),a=this.getIdxByCode(t.kuntakoodi),n="highlight-row-"+t.kuntakoodi,s={};this.grid&&a&&this.getItemsByGroupingKey("checked").length>0&&(this.selectedMunicipalities[t.kuntakoodi]=i,i?-1!=a&&(this.grid.scrollRowToTop(a),s[a]={municipality:"statsgrid-highlight-row"},this.grid.addCellCssStyles(n,s),this.dataView.syncGridCellCssStyles(this.grid,n)):(this.grid.removeCellCssStyles(n),this.dataView.syncGridCellCssStyles(this.grid,n)))},_featureSelectedEvent:function(e){var t=e.getFeature().attributes,i=e.isHighlighted(),a=this.getItemByCode(t.kuntakoodi);if(this.grid&&a){this.selectedMunicipalities[t.kuntakoodi]=i,a.sel=i?"checked":"empty";var n=this.grid.getData();n.updateItem(a.id,a);var s=this._getColumnById(this._state.currentColumn);this.sendStatsData(s)}},getItemsByGroupingKey:function(e){for(var t=this.grid.getData().getItems(),i=[],a=0;a<t.length;a++){var n=t[a];n.sel===e&&i.push(e)}return i},_showSelectedAreas:function(e){for(var t=this.grid.getData(),i=t.getItems(),a=0;a<i.length;a++){var n=i[a];n.sel="empty";for(var s=0;s<e.length;s++){var r=e[s];n.id==r&&(n.sel="checked")}t.updateItem(n.id,n)}t.collapseGroup("empty"),t.refresh()},unselectAllAreas:function(e){for(var t=this.grid,i=t.getData(),a=t.getData().getItems(),n=0;n<a.length;n++){var s=a[n];s.sel=e&&this.selectedMunicipalities[s.code]?"checked":"empty"}i.collapseGroup("empty");var r=this._getColumnById(this._state.currentColumn);this.sendStatsData(r),i.setItems(a),i.refresh(),t.invalidateAllRows(),t.render()},_getColumnById:function(e){for(var t=this.grid.getColumns(),i=0;i<t.length;i++){var a=t[i];if(a.id===e)return a}return null},sendTooltipData:function(e){var t=e.attributes,i=this._sandbox.getEventBuilder("MapStats.HoverTooltipContentEvent"),a=this._state.currentColumn,n=this.getItemByCode(t.kuntakoodi),s="<p>"+n.municipality;if(s+=a&&n[a]?"<br />"+n[a]:"",s+="</p>",i){var r=i(s);this._sandbox.notifyAll(r)}},toggleSelectMunicipalitiesMode:function(){return this.selectMunicipalitiesMode=!this.selectMunicipalitiesMode,this.selectMunicipalitiesMode}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.event.SotkadataChangedEvent",function(e,t){this._layer=e,this._params=t},{getName:function(){return"StatsGrid.SotkadataChangedEvent"},getLayer:function(){return this._layer},getParams:function(){return this._params}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.event.ModeChangedEvent",function(e){this._modeVisible=e},{getName:function(){return"StatsGrid.ModeChangedEvent"},isModeVisible:function(){return this._modeVisible}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.event.ClearHilightsEvent",function(){},{getName:function(){return"StatsGrid.ClearHilightsEvent"}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.event.SelectHilightsModeEvent",function(e){this._codes=e},{getName:function(){return"StatsGrid.SelectHilightsModeEvent"},getCodes:function(){return this._codes}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.request.StatsGridRequest",function(e,t){this._enable=e===!0,this._layer=t},{__name:"StatsGrid.StatsGridRequest",getName:function(){return this.__name},getLayer:function(){return this._layer},isEnabled:function(){return this._enable}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.request.StatsGridRequestHandler",function(e){this.view=e},{handleRequest:function(e,t){"StatsGrid.StatsGridRequest"==t.getName()&&this.view.prepareMode(t.isEnabled(),t.getLayer())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.request.TooltipContentRequest",function(e){this._feature=e},{__name:"StatsGrid.TooltipContentRequest",getName:function(){return this.__name},getFeature:function(){return this._feature}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.request.TooltipContentRequestHandler",function(e){this.instance=e},{handleRequest:function(e,t){"StatsGrid.TooltipContentRequest"==t.getName()&&this.instance.gridPlugin.sendTooltipData(t.getFeature())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatisticsService",function(e){this.instance=e,this.sandbox=e.sandbox},{__name:"StatsGrid.StatisticsService",__qname:"Oskari.statistics.bundle.statsgrid.StatisticsService",getQName:function(){return this.__qname},getName:function(){return this.__name},init:function(){},sendStatsData:function(e,t){var i=this,a=i.sandbox.getEventBuilder("StatsGrid.SotkadataChangedEvent");if(a){var n=a(e,t);i.sandbox.notifyAll(n)}},sendVisualizationData:function(e,t){var i=this,a=i.sandbox.getEventBuilder("MapStats.StatsVisualizationChangeEvent");if(a){var n=a(e,t);i.sandbox.notifyAll(n)}},fetchStatsData:function(e,t,i){jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:e,success:function(e){t&&t(e)},error:function(e,t){i&&0!=e.status&&i(e,t)}})}},{protocol:["Oskari.mapframework.service.Service"]}),function(e){e.fn.drag=function(t,i,a){var n="string"==typeof t?t:"",s=e.isFunction(t)?t:e.isFunction(i)?i:null;return 0!==n.indexOf("drag")&&(n="drag"+n),a=(t==s?i:a)||{},s?this.bind(n,a,s):this.trigger(n)};var t=e.event,i=t.special,a=i.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",livekey:"livedrag",add:function(i){var n=e.data(this,a.datakey),s=i.data||{};n.related+=1,!n.live&&i.selector&&(n.live=!0,t.add(this,"draginit."+a.livekey,a.delegate)),e.each(a.defaults,function(e){void 0!==s[e]&&(n[e]=s[e])})},remove:function(){e.data(this,a.datakey).related-=1},setup:function(){if(!e.data(this,a.datakey)){var i=e.extend({related:0},a.defaults);e.data(this,a.datakey,i),t.add(this,"mousedown",a.init,i),this.attachEvent&&this.attachEvent("ondragstart",a.dontstart)}},teardown:function(){e.data(this,a.datakey).related||(e.removeData(this,a.datakey),t.remove(this,"mousedown",a.init),t.remove(this,"draginit",a.delegate),a.textselect(!0),this.detachEvent&&this.detachEvent("ondragstart",a.dontstart))},init:function(n){var s,r=n.data;return r.which>0&&n.which!=r.which||e(n.target).is(r.not)||r.handle&&!e(n.target).closest(r.handle,n.currentTarget).length||(r.propagates=1,r.interactions=[a.interaction(this,r)],r.target=n.target,r.pageX=n.pageX,r.pageY=n.pageY,r.dragging=null,s=a.hijack(n,"draginit",r),!r.propagates)?void 0:((s=a.flatten(s))&&s.length&&(r.interactions=[],e.each(s,function(){r.interactions.push(a.interaction(this,r))})),r.propagates=r.interactions.length,r.drop!==!1&&i.drop&&i.drop.handler(n,r),a.textselect(!1),t.add(document,"mousemove mouseup",a.handler,r),!1)},interaction:function(t,i){return{drag:t,callback:new a.callback,droppable:[],offset:e(t)[i.relative?"position":"offset"]()||{top:0,left:0}}},handler:function(e){var n=e.data;switch(e.type){case!n.dragging&&"mousemove":if(Math.pow(e.pageX-n.pageX,2)+Math.pow(e.pageY-n.pageY,2)<Math.pow(n.distance,2))break;e.target=n.target,a.hijack(e,"dragstart",n),n.propagates&&(n.dragging=!0);case"mousemove":if(n.dragging){if(a.hijack(e,"drag",n),n.propagates){n.drop!==!1&&i.drop&&i.drop.handler(e,n);break}e.type="mouseup"}case"mouseup":t.remove(document,"mousemove mouseup",a.handler),n.dragging&&(n.drop!==!1&&i.drop&&i.drop.handler(e,n),a.hijack(e,"dragend",n)),a.textselect(!0),n.click===!1&&n.dragging&&(jQuery.event.triggered=!0,setTimeout(function(){jQuery.event.triggered=!1},20),n.dragging=!1)}},delegate:function(i){var n,s=[],r=e.data(this,"events")||{};return e.each(r.live||[],function(r,o){0===o.preType.indexOf("drag")&&(n=e(i.target).closest(o.selector,i.currentTarget)[0])&&(t.add(n,o.origType+"."+a.livekey,o.origHandler,o.data),e.inArray(n,s)<0&&s.push(n))}),s.length?e(s).bind("dragend."+a.livekey,function(){t.remove(this,"."+a.livekey)}):!1},hijack:function(i,n,s,r,o){if(s){var l,u,c,h={event:i.originalEvent,type:i.type},d=n.indexOf("drop")?"drag":"drop",p=r||0;r=isNaN(r)?s.interactions.length:r,i.type=n,i.originalEvent=null,s.results=[];do(u=s.interactions[p])&&("dragend"!==n&&u.cancelled||(c=a.properties(i,s,u),u.results=[],e(o||u[d]||s.droppable).each(function(r,o){return l=(c.target=o)?t.handle.call(o,i,c):null,l===!1?("drag"==d&&(u.cancelled=!0,s.propagates-=1),"drop"==n&&(u[d][r]=null)):"dropinit"==n&&u.droppable.push(a.element(l)||o),"dragstart"==n&&(u.proxy=e(a.element(l)||u.drag)[0]),u.results.push(l),delete i.result,"dropinit"!==n?l:void 0}),s.results[p]=a.flatten(u.results),"dropinit"==n&&(u.droppable=a.flatten(u.droppable)),"dragstart"==n&&!u.cancelled&&c.update()));while(++p<r);return i.type=h.type,i.originalEvent=h.event,a.flatten(s.results)}},properties:function(e,t,i){var n=i.callback;return n.drag=i.drag,n.proxy=i.proxy||i.drag,n.startX=t.pageX,n.startY=t.pageY,n.deltaX=e.pageX-t.pageX,n.deltaY=e.pageY-t.pageY,n.originalX=i.offset.left,n.originalY=i.offset.top,n.offsetX=e.pageX-(t.pageX-n.originalX),n.offsetY=e.pageY-(t.pageY-n.originalY),n.drop=a.flatten((i.drop||[]).slice()),n.available=a.flatten((i.droppable||[]).slice()),n},element:function(e){return e&&(e.jquery||1==e.nodeType)?e:void 0},flatten:function(t){return e.map(t,function(t){return t&&t.jquery?e.makeArray(t):t&&t.length?a.flatten(t):t})},textselect:function(t){e(document)[t?"unbind":"bind"]("selectstart",a.dontstart).attr("unselectable",t?"off":"on").css("MozUserSelect",t?"":"none")},dontstart:function(){return!1},callback:function(){}};a.callback.prototype={update:function(){i.drop&&this.available.length&&e.each(this.available,function(e){i.drop.locate(this,e)})}},i.draginit=i.dragstart=i.dragend=a}(jQuery),function(e){function t(){var e=!1,t=!1;this.stopPropagation=function(){e=!0},this.isPropagationStopped=function(){return e},this.stopImmediatePropagation=function(){t=!0},this.isImmediatePropagationStopped=function(){return t}}function i(){var e=[];this.subscribe=function(t){e.push(t)},this.unsubscribe=function(t){for(var i=e.length-1;i>=0;i--)e[i]===t&&e.splice(i,1)},this.notify=function(i,a,n){a=a||new t,n=n||this;for(var s,r=0;r<e.length&&!a.isPropagationStopped()&&!a.isImmediatePropagationStopped();r++)s=e[r].call(n,a,i);return s}}function a(){var e=[];this.subscribe=function(t,i){return e.push({event:t,handler:i}),t.subscribe(i),this},this.unsubscribe=function(t,i){for(var a=e.length;a--;)if(e[a].event===t&&e[a].handler===i)return e.splice(a,1),t.unsubscribe(i),void 0;return this},this.unsubscribeAll=function(){for(var t=e.length;t--;)e[t].event.unsubscribe(e[t].handler);return e=[],this}}function n(e,t,i,a){void 0===i&&void 0===a&&(i=e,a=t),this.fromRow=Math.min(e,i),this.fromCell=Math.min(t,a),this.toRow=Math.max(e,i),this.toCell=Math.max(t,a),this.isSingleRow=function(){return this.fromRow==this.toRow},this.isSingleCell=function(){return this.fromRow==this.toRow&&this.fromCell==this.toCell},this.contains=function(e,t){return e>=this.fromRow&&e<=this.toRow&&t>=this.fromCell&&t<=this.toCell},this.toString=function(){return this.isSingleCell()?"("+this.fromRow+":"+this.fromCell+")":"("+this.fromRow+":"+this.fromCell+" - "+this.toRow+":"+this.toCell+")"}}function s(){this.__nonDataRow=!0}function r(){this.__group=!0,this.level=0,this.count=0,this.value=null,this.title=null,this.collapsed=!1,this.totals=null,this.rows=[],this.groups=null,this.groupingKey=null}function o(){this.__groupTotals=!0,this.group=null}function l(){var e=null;this.isActive=function(t){return t?e===t:null!==e},this.activate=function(t){if(t!==e){if(null!==e)throw"SlickGrid.EditorLock.activate: an editController is still active, can't activate another editController";if(!t.commitCurrentEdit)throw"SlickGrid.EditorLock.activate: editController must implement .commitCurrentEdit()";if(!t.cancelCurrentEdit)throw"SlickGrid.EditorLock.activate: editController must implement .cancelCurrentEdit()";e=t}},this.deactivate=function(t){if(e!==t)throw"SlickGrid.EditorLock.deactivate: specified editController is not the currently active one";e=null},this.commitCurrentEdit=function(){return e?e.commitCurrentEdit():!0},this.cancelCurrentEdit=function(){return e?e.cancelCurrentEdit():!0}}e.extend(!0,window,{Slick:{Event:i,EventData:t,EventHandler:a,Range:n,NonDataRow:s,Group:r,GroupTotals:o,EditorLock:l,GlobalEditorLock:new l}}),r.prototype=new s,r.prototype.equals=function(e){return this.value===e.value&&this.count===e.count&&this.collapsed===e.collapsed},o.prototype=new s}(jQuery),function(e){function t(e,t,i){return null==i||""===i?"-":50>i?"<span style='color:red;font-weight:bold;'>"+i+"%</span>":"<span style='color:green'>"+i+"%</span>"}function i(e,t,i){if(null==i||""===i)return"";var a;return a=30>i?"red":70>i?"silver":"green","<span class='percent-complete-bar' style='background:"+a+";width:"+i+"%'></span>"}function a(e,t,i){return i?"Yes":"No"}function n(e,t,i){return i?"<img src='../images/tick.png'>":""}e.extend(!0,window,{Slick:{Formatters:{PercentComplete:t,PercentCompleteBar:i,YesNo:a,Checkmark:n}}})}(jQuery),function(e){function t(t){var i,a;this.init=function(){i=e("<INPUT type=text class='editor-text' />").appendTo(t.container).bind("keydown.nav",function(t){(t.keyCode===e.ui.keyCode.LEFT||t.keyCode===e.ui.keyCode.RIGHT)&&t.stopImmediatePropagation()}).focus().select()},this.destroy=function(){i.remove()},this.focus=function(){i.focus()},this.getValue=function(){return i.val()},this.setValue=function(e){i.val(e)},this.loadValue=function(e){a=e[t.column.field]||"",i.val(a),i[0].defaultValue=a,i.select()},this.serializeValue=function(){return i.val()},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==a)&&i.val()!=a},this.validate=function(){if(t.column.validator){var e=t.column.validator(i.val());if(!e.valid)return e}return{valid:!0,msg:null}},this.init()}function i(t){var i,a;this.init=function(){i=e("<INPUT type=text class='editor-text' />"),i.bind("keydown.nav",function(t){(t.keyCode===e.ui.keyCode.LEFT||t.keyCode===e.ui.keyCode.RIGHT)&&t.stopImmediatePropagation()}),i.appendTo(t.container),i.focus().select()},this.destroy=function(){i.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){a=e[t.column.field],i.val(a),i[0].defaultValue=a,i.select()},this.serializeValue=function(){return parseInt(i.val(),10)||0},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==a)&&i.val()!=a},this.validate=function(){return isNaN(i.val())?{valid:!1,msg:"Please enter a valid integer"}:{valid:!0,msg:null}},this.init()}function a(t){var i,a,n=!1;this.init=function(){i=e("<INPUT type=text class='editor-text' />"),i.appendTo(t.container),i.focus().select(),i.datepicker({showOn:"button",buttonImageOnly:!0,buttonImage:"../images/calendar.gif",beforeShow:function(){n=!0},onClose:function(){n=!1}}),i.width(i.width()-18)
},this.destroy=function(){e.datepicker.dpDiv.stop(!0,!0),i.datepicker("hide"),i.datepicker("destroy"),i.remove()},this.show=function(){n&&e.datepicker.dpDiv.stop(!0,!0).show()},this.hide=function(){n&&e.datepicker.dpDiv.stop(!0,!0).hide()},this.position=function(t){n&&e.datepicker.dpDiv.css("top",t.top+30).css("left",t.left)},this.focus=function(){i.focus()},this.loadValue=function(e){a=e[t.column.field],i.val(a),i[0].defaultValue=a,i.select()},this.serializeValue=function(){return i.val()},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==a)&&i.val()!=a},this.validate=function(){return{valid:!0,msg:null}},this.init()}function n(t){var i,a;this.init=function(){i=e("<SELECT tabIndex='0' class='editor-yesno'><OPTION value='yes'>Yes</OPTION><OPTION value='no'>No</OPTION></SELECT>"),i.appendTo(t.container),i.focus()},this.destroy=function(){i.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){i.val((a=e[t.column.field])?"yes":"no"),i.select()},this.serializeValue=function(){return"yes"==i.val()},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return i.val()!=a},this.validate=function(){return{valid:!0,msg:null}},this.init()}function s(t){var i,a;this.init=function(){i=e("<INPUT type=checkbox value='true' class='editor-checkbox' hideFocus>"),i.appendTo(t.container),i.focus()},this.destroy=function(){i.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){a=!!e[t.column.field],a?i.attr("checked","checked"):i.removeAttr("checked")},this.serializeValue=function(){return!!i.attr("checked")},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return this.serializeValue()!==a},this.validate=function(){return{valid:!0,msg:null}},this.init()}function r(t){var i,a,n;this.init=function(){i=e("<INPUT type=text class='editor-percentcomplete' />"),i.width(e(t.container).innerWidth()-25),i.appendTo(t.container),a=e("<div class='editor-percentcomplete-picker' />").appendTo(t.container),a.append("<div class='editor-percentcomplete-helper'><div class='editor-percentcomplete-wrapper'><div class='editor-percentcomplete-slider' /><div class='editor-percentcomplete-buttons' /></div></div>"),a.find(".editor-percentcomplete-buttons").append("<button val=0>Not started</button><br/><button val=50>In Progress</button><br/><button val=100>Complete</button>"),i.focus().select(),a.find(".editor-percentcomplete-slider").slider({orientation:"vertical",range:"min",value:n,slide:function(e,t){i.val(t.value)}}),a.find(".editor-percentcomplete-buttons button").bind("click",function(){i.val(e(this).attr("val")),a.find(".editor-percentcomplete-slider").slider("value",e(this).attr("val"))})},this.destroy=function(){i.remove(),a.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){i.val(n=e[t.column.field]),i.select()},this.serializeValue=function(){return parseInt(i.val(),10)||0},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==n)&&(parseInt(i.val(),10)||0)!=n},this.validate=function(){return isNaN(parseInt(i.val(),10))?{valid:!1,msg:"Please enter a valid positive number"}:{valid:!0,msg:null}},this.init()}function o(t){var i,a,n,s=this;this.init=function(){var n=e("body");a=e("<DIV style='z-index:10000;position:absolute;background:white;padding:5px;border:3px solid gray; -moz-border-radius:10px; border-radius:10px;'/>").appendTo(n),i=e("<TEXTAREA hidefocus rows=5 style='backround:white;width:250px;height:80px;border:0;outline:0'>").appendTo(a),e("<DIV style='text-align:right'><BUTTON>Save</BUTTON><BUTTON>Cancel</BUTTON></DIV>").appendTo(a),a.find("button:first").bind("click",this.save),a.find("button:last").bind("click",this.cancel),i.bind("keydown",this.handleKeyDown),s.position(t.position),i.focus().select()},this.handleKeyDown=function(i){i.which==e.ui.keyCode.ENTER&&i.ctrlKey?s.save():i.which==e.ui.keyCode.ESCAPE?(i.preventDefault(),s.cancel()):i.which==e.ui.keyCode.TAB&&i.shiftKey?(i.preventDefault(),t.grid.navigatePrev()):i.which==e.ui.keyCode.TAB&&(i.preventDefault(),t.grid.navigateNext())},this.save=function(){t.commitChanges()},this.cancel=function(){i.val(n),t.cancelChanges()},this.hide=function(){a.hide()},this.show=function(){a.show()},this.position=function(e){a.css("top",e.top-5).css("left",e.left-5)},this.destroy=function(){a.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){i.val(n=e[t.column.field]),i.select()},this.serializeValue=function(){return i.val()},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==n)&&i.val()!=n},this.validate=function(){return{valid:!0,msg:null}},this.init()}e.extend(!0,window,{Slick:{Editors:{Text:t,Integer:i,Date:a,YesNoSelect:n,Checkbox:s,PercentComplete:r,LongText:o}}})}(jQuery),function(e){function t(t,i){function a(a){s||(s=e("<div></div>",{css:i.selectionCss}).css("position","absolute").appendTo(t.getCanvasNode()));var n=t.getCellNodeBox(a.fromRow,a.fromCell),r=t.getCellNodeBox(a.toRow,a.toCell);return s.css({top:n.top-1,left:n.left-1,height:r.bottom-n.top-2,width:r.right-n.left-2}),s}function n(){s&&(s.remove(),s=null)}var s,r={selectionCss:{zIndex:"9999",border:"2px dashed red"}};i=e.extend(!0,{},r,i),e.extend(this,{show:a,hide:n})}e.extend(!0,window,{Slick:{CellRangeDecorator:t}})}(jQuery),function(e){function t(t){function i(i){t=e.extend(!0,{},f,t),h=new Slick.CellRangeDecorator(i,t),l=i,u=l.getCanvasNode(),p.subscribe(l.onDragInit,n).subscribe(l.onDragStart,s).subscribe(l.onDrag,r).subscribe(l.onDragEnd,o)}function a(){p.unsubscribeAll()}function n(e){e.stopImmediatePropagation()}function s(t,i){var a=l.getCellFromEvent(t);if(d.onBeforeCellRangeSelected.notify(a)!==!1&&l.canCellBeSelected(a.row,a.cell)&&(c=!0,t.stopImmediatePropagation()),c){var n=l.getCellFromPoint(i.startX-e(u).offset().left,i.startY-e(u).offset().top);return i.range={start:n,end:{}},h.show(new Slick.Range(n.row,n.cell))}}function r(t,i){if(c){t.stopImmediatePropagation();var a=l.getCellFromPoint(t.pageX-e(u).offset().left,t.pageY-e(u).offset().top);l.canCellBeSelected(a.row,a.cell)&&(i.range.end=a,h.show(new Slick.Range(i.range.start.row,i.range.start.cell,a.row,a.cell)))}}function o(e,t){c&&(c=!1,e.stopImmediatePropagation(),h.hide(),d.onCellRangeSelected.notify({range:new Slick.Range(t.range.start.row,t.range.start.cell,t.range.end.row,t.range.end.cell)}))}var l,u,c,h,d=this,p=new Slick.EventHandler,f={selectionCss:{border:"2px dashed blue"}};e.extend(this,{init:i,destroy:a,onBeforeCellRangeSelected:new Slick.Event,onCellRangeSelected:new Slick.Event})}e.extend(!0,window,{Slick:{CellRangeSelector:t}})}(jQuery),function(e){function t(t){function i(i){p=e.extend(!0,{},y,t),h=i,d=h.getCanvasNode(),h.onActiveCellChanged.subscribe(u),h.onKeyDown.subscribe(c),i.registerPlugin(g),g.onCellRangeSelected.subscribe(l),g.onBeforeCellRangeSelected.subscribe(o)}function a(){h.onActiveCellChanged.unsubscribe(u),h.onKeyDown.unsubscribe(c),g.onCellRangeSelected.unsubscribe(l),g.onBeforeCellRangeSelected.unsubscribe(o),h.unregisterPlugin(g)}function n(e){for(var t=[],i=0;i<e.length;i++){var a=e[i];h.canCellBeSelected(a.fromRow,a.fromCell)&&h.canCellBeSelected(a.toRow,a.toCell)&&t.push(a)}return t}function s(e){f=n(e),m.onSelectedRangesChanged.notify(f)}function r(){return f}function o(e){return h.getEditorLock().isActive()?(e.stopPropagation(),!1):void 0}function l(e,t){s([t.range])}function u(e,t){p.selectActiveCell&&null!=t.row&&null!=t.cell&&s([new Slick.Range(t.row,t.cell)])}function c(e){var t,i,a=h.getActiveCell();if(a&&e.shiftKey&&!e.ctrlKey&&!e.altKey&&(37==e.which||39==e.which||38==e.which||40==e.which)){t=r(),t.length||t.push(new Slick.Range(a.row,a.cell)),i=t.pop(),i.contains(a.row,a.cell)||(i=new Slick.Range(a.row,a.cell));var o=i.toRow-i.fromRow,l=i.toCell-i.fromCell,u=a.row==i.fromRow?1:-1,c=a.cell==i.fromCell?1:-1;37==e.which?l-=c:39==e.which?l+=c:38==e.which?o-=u:40==e.which&&(o+=u);var d=new Slick.Range(a.row,a.cell,a.row+u*o,a.cell+c*l);n([d]).length?(t.push(d),h.scrollRowIntoView(u>0?d.toRow:d.fromRow),h.scrollCellIntoView(d.fromRow,c>0?d.toCell:d.fromCell)):t.push(i),s(t),e.preventDefault(),e.stopPropagation()}}var h,d,p,f=[],m=this,g=new Slick.CellRangeSelector({selectionCss:{border:"2px solid black"}}),y={selectActiveCell:!0};e.extend(this,{getSelectedRanges:r,setSelectedRanges:s,init:i,destroy:a,onSelectedRangesChanged:new Slick.Event})}e.extend(!0,window,{Slick:{CellSelectionModel:t}})}(jQuery),function(e){function t(t){function i(i){t=e.extend(!0,{},m,t),c=i,f.subscribe(c.onHeaderCellRendered,r).subscribe(c.onBeforeHeaderCellDestroy,o),c.setColumns(c.getColumns())}function a(){f.unsubscribeAll(),e(document.body).unbind("mousedown",n)}function n(t){h&&h[0]!=t.target&&!e.contains(h[0],t.target)&&s()}function s(){h&&(h.remove(),h=null,d.removeClass("slick-header-column-active"))}function r(i,a){var n=a.column,s=n.header&&n.header.menu;if(s){var r=e("<div></div>").addClass("slick-header-menubutton").data("column",n).data("menu",s);t.buttonCssClass&&r.addClass(t.buttonCssClass),n.header.icon?r.append(e("<div></div>").addClass(n.header.icon)):t.buttonImage&&r.append(e("<div></div>").css({"background-image":"url("+t.buttonImage+")",width:"16px",height:"16px","background-position":"center"})),s.tooltip&&r.attr("title",s.tooltip),r.bind("click",l).appendTo(a.node)}}function o(t,i){var a=i.column;a.header&&a.header.menu&&e(i.node).find(".slick-header-menubutton").remove()}function l(t){var i=e(this),a=i.data("menu"),n=i.data("column");if(null!=d&&d.hasClass("slick-header-column-active"))return s(),void 0;if(0!=p.onBeforeMenuShow.notify({grid:c,column:n,menu:a},t,p)){h||(h=e("<div class='slick-header-menu'></div>").appendTo(document.body)),h.empty();for(var r=0;r<a.items.length;r++){var o=a.items[r],l=e("<div class='slick-header-menuitem'></div>").data("command",o.command||"").data("column",n).appendTo(h);o.actionType&&"link"==o.actionType?l.bind("click",u):l.bind("change",u),o.tooltip&&l.attr("title",o.tooltip),e(o.element).appendTo(l)}h.css("top",e(this).offset().top+e(this).height()+7).css("left",e(this).offset().left),d=i.closest(".slick-header-column"),d.addClass("slick-header-column-active")}}function u(t){var i=e(this).data("command"),a=e(this).data("column");null!=i&&""!=i&&p.onCommand.notify({grid:c,column:a,command:i},t,p),t.preventDefault(),t.stopPropagation()}var c,h,d,p=this,f=new Slick.EventHandler,m={buttonCssClass:null,buttonImage:"/Oskari/libraries/slickgrid/images/down.gif"};e.extend(this,{init:i,destroy:a,hide:s,onBeforeMenuShow:new Slick.Event,onCommand:new Slick.Event})}e.extend(!0,window,{Slick:{Plugins:{HeaderMenu2:t}}})}(jQuery),function(e){function t(t){function i(i){y=e.extend(!0,{},k,t),m=i,_.subscribe(m.onActiveCellChanged,n(d)),_.subscribe(m.onKeyDown,n(p)),_.subscribe(m.onClick,n(f))}function a(){_.unsubscribeAll()}function n(e){return function(){g||(g=!0,e.apply(this,arguments),g=!1)}}function s(e){for(var t=[],i=0;i<e.length;i++)for(var a=e[i].fromRow;a<=e[i].toRow;a++)t.push(a);return t}function r(e){for(var t=[],i=m.getColumns().length-1,a=0;a<e.length;a++)t.push(new Slick.Range(e[a],0,e[a],i));return t}function o(e,t){var i,a=[];for(i=e;t>=i;i++)a.push(i);for(i=t;e>i;i++)a.push(i);return a}function l(){return s(v)}function u(e){c(r(e))}function c(e){v=e,b.onSelectedRangesChanged.notify(v)}function h(){return v}function d(e,t){y.selectActiveRow&&null!=t.row&&c([new Slick.Range(t.row,0,t.row,m.getColumns().length-1)])}function p(e){var t=m.getActiveCell();if(t&&e.shiftKey&&!e.ctrlKey&&!e.altKey&&!e.metaKey&&(38==e.which||40==e.which)){var i=l();i.sort(function(e,t){return e-t}),i.length||(i=[t.row]);var a,n=i[0],s=i[i.length-1];a=40==e.which?t.row<s||n==s?++s:++n:t.row<s?--s:--n,a>=0&&a<m.getDataLength()&&(m.scrollRowIntoView(a),v=r(o(n,s)),c(v)),e.preventDefault(),e.stopPropagation()}}function f(t){var i=m.getCellFromEvent(t);if(!i||!m.canCellBeActive(i.row,i.cell))return!1;var a=s(v),n=e.inArray(i.row,a);if(!(t.ctrlKey||t.shiftKey||t.metaKey))return!1;if(m.getOptions().multiSelect)if(-1===n&&(t.ctrlKey||t.metaKey))a.push(i.row),m.setActiveCell(i.row,i.cell);else if(-1!==n&&(t.ctrlKey||t.metaKey))a=e.grep(a,function(e){return e!==i.row}),m.setActiveCell(i.row,i.cell);else if(a.length&&t.shiftKey){var o=a.pop(),l=Math.min(i.row,o),u=Math.max(i.row,o);a=[];for(var h=l;u>=h;h++)h!==o&&a.push(h);a.push(o),m.setActiveCell(i.row,i.cell)}return v=r(a),c(v),t.stopImmediatePropagation(),!0}var m,g,y,v=[],b=this,_=new Slick.EventHandler,k={selectActiveRow:!0};e.extend(this,{getSelectedRows:l,setSelectedRows:u,getSelectedRanges:h,setSelectedRanges:c,init:i,destroy:a,onSelectedRangesChanged:new Slick.Event})}e.extend(!0,window,{Slick:{RowSelectionModel:t}})}(jQuery),function(e){function t(t){function i(e){u=e,h.subscribe(u.onClick,s).subscribe(u.onHeaderClick,r).subscribe(u.onKeyDown,n)}function a(){h.unsubscribeAll()}function n(e,t){32==e.which&&u.getColumns()[t.cell].id===p.columnId&&((!u.getEditorLock().isActive()||u.getEditorLock().commitCurrentEdit())&&toggleRowSelection(t.row),e.preventDefault(),e.stopImmediatePropagation())}function s(t,i){if(u.getColumns()[i.cell].id===p.columnId&&e(t.target).is(":checkbox")){if(u.getEditorLock().isActive()&&!u.getEditorLock().commitCurrentEdit())return t.preventDefault(),t.stopImmediatePropagation(),void 0;c.onSelectRowClicked.notify(i,t,c);var a=u.getData(),n=a.getGroups(),s=a.getItems().length,r=!1;for(var o in n){var l=n[o];if(l.count==s&&e(t.target).is(":checked")){u.updateColumnHeader(p.columnId,"<input type='checkbox' checked='checked'>",p.toolTip),r=!0;break}}r||u.updateColumnHeader(p.columnId,"<input type='checkbox'>",p.toolTip),u.getData().refresh(),u.invalidateAllRows(),u.render(),t.stopPropagation(),t.stopImmediatePropagation()}}function r(t,i){if(i.column.id==p.columnId&&e(t.target).is(":checkbox")){if(u.getEditorLock().isActive()&&!u.getEditorLock().commitCurrentEdit())return t.preventDefault(),t.stopImmediatePropagation(),void 0;var a=u.getData().getItems();if(e(t.target).is(":checked"))for(var n=0;n<a.length;n++){var s=a[n];s.sel="checked"}else for(var n=0;n<a.length;n++){var s=a[n];s.sel="empty"}c.onSelectHeaderRowClicked.notify(i,t,c),u.getData().setItems(a),u.getData().refresh(),u.invalidateAllRows(),u.render(),t.stopPropagation(),t.stopImmediatePropagation()}}function o(){return{id:p.columnId,name:"<input type='checkbox'>",toolTip:p.toolTip,field:"sel",width:p.width,resizable:!1,sortable:!1,cssClass:p.cssClass,formatter:l}}function l(e,t,i,a,n){return n?"checked"==n.sel?"<input type='checkbox' checked='checked'>":"<input type='checkbox'>":null}var u,c=this,h=new Slick.EventHandler,d={columnId:"_checkbox_selector",cssClass:null,toolTip:"Select/Deselect All",width:30},p=e.extend(!0,{},d,t);e.extend(this,{init:i,destroy:a,onSelectRowClicked:new Slick.Event,onSelectHeaderRowClicked:new Slick.Event,getColumnDefinition:o})}e.extend(!0,window,{Slick:{CheckboxSelectColumn2:t}})}(jQuery),"undefined"==typeof jQuery)throw"SlickGrid requires jquery module to be loaded";if(!jQuery.fn.drag)throw"SlickGrid requires jquery.event.drag module to be loaded";if("undefined"==typeof Slick)throw"slick.core.js not loaded";!function($){function SlickGrid(container,data,columns,options){function init(){if($container=$(container),$container.length<1)throw new Error("SlickGrid requires a valid container, "+container+" does not exist in the DOM.");maxSupportedCssHeight=maxSupportedCssHeight||getMaxSupportedCssHeight(),scrollbarDimensions=scrollbarDimensions||measureScrollbar(),options=$.extend({},defaults,options),validateAndEnforceOptions(),columnDefaults.width=options.defaultColumnWidth,columnsById={};for(var e=0;e<columns.length;e++){var t=columns[e]=$.extend({},columnDefaults,columns[e]);columnsById[t.id]=e,t.minWidth&&t.width<t.minWidth&&(t.width=t.minWidth),t.maxWidth&&t.width>t.maxWidth&&(t.width=t.maxWidth)}if(options.enableColumnReorder&&!$.fn.sortable)throw new Error("SlickGrid's 'enableColumnReorder = true' option requires jquery-ui.sortable module to be loaded");editController={commitCurrentEdit:commitCurrentEdit,cancelCurrentEdit:cancelCurrentEdit},$container.empty().css("overflow","hidden").css("outline",0).addClass(uid).addClass("ui-widget"),/relative|absolute|fixed/.test($container.css("position"))||$container.css("position","relative"),$focusSink=$("<div tabIndex='0' hideFocus style='position:fixed;width:0;height:0;top:0;left:0;outline:0;'></div>").appendTo($container),$headerScroller=$("<div class='slick-header ui-state-default' style='overflow:hidden;position:relative;' />").appendTo($container),$headers=$("<div class='slick-header-columns' style='left:-1000px' />").appendTo($headerScroller),$headers.width(getHeadersWidth()),$headerRowScroller=$("<div class='slick-headerrow ui-state-default' style='overflow:hidden;position:relative;' />").appendTo($container),$headerRow=$("<div class='slick-headerrow-columns' />").appendTo($headerRowScroller),$headerRowSpacer=$("<div style='display:block;height:1px;position:absolute;top:0;left:0;'></div>").css("width",getCanvasWidth()+scrollbarDimensions.width+"px").appendTo($headerRowScroller),$topPanelScroller=$("<div class='slick-top-panel-scroller ui-state-default' style='overflow:hidden;position:relative;' />").appendTo($container),$topPanel=$("<div class='slick-top-panel' style='width:10000px' />").appendTo($topPanelScroller),options.showTopPanel||$topPanelScroller.hide(),options.showHeaderRow||$headerRowScroller.hide(),$viewport=$("<div class='slick-viewport' style='width:100%;overflow:auto;outline:0;position:relative;;'>").appendTo($container),$viewport.css("overflow-y",options.autoHeight?"hidden":"auto"),$canvas=$("<div class='grid-canvas' />").appendTo($viewport),$focusSink2=$focusSink.clone().appendTo($container),options.explicitInitialization||finishInitialization()}function finishInitialization(){initialized||(initialized=!0,viewportW=parseFloat($.css($container[0],"width",!0)),measureCellPaddingAndBorder(),disableSelection($headers),options.enableTextSelectionOnCells||$viewport.bind("selectstart.ui",function(e){return $(e.target).is("input,textarea")}),updateColumnCaches(),createColumnHeaders(),setupColumnSort(),createCssRules(),resizeCanvas(),bindAncestorScrollEvents(),$container.bind("resize.slickgrid",resizeCanvas),$viewport.bind("scroll",handleScroll),$headerScroller.bind("contextmenu",handleHeaderContextMenu).bind("click",handleHeaderClick).delegate(".slick-header-column","mouseenter",handleHeaderMouseEnter).delegate(".slick-header-column","mouseleave",handleHeaderMouseLeave),$headerRowScroller.bind("scroll",handleHeaderRowScroll),$focusSink.add($focusSink2).bind("keydown",handleKeyDown),$canvas.bind("keydown",handleKeyDown).bind("click",handleClick).bind("dblclick",handleDblClick).bind("contextmenu",handleContextMenu).bind("draginit",handleDragInit).bind("dragstart",{distance:3},handleDragStart).bind("drag",handleDrag).bind("dragend",handleDragEnd).delegate(".slick-cell","mouseenter",handleMouseEnter).delegate(".slick-cell","mouseleave",handleMouseLeave))}function registerPlugin(e){plugins.unshift(e),e.init(self)}function unregisterPlugin(e){for(var t=plugins.length;t>=0;t--)if(plugins[t]===e){plugins[t].destroy&&plugins[t].destroy(),plugins.splice(t,1);break}}function setSelectionModel(e){selectionModel&&(selectionModel.onSelectedRangesChanged.unsubscribe(handleSelectedRangesChanged),selectionModel.destroy&&selectionModel.destroy()),selectionModel=e,selectionModel&&(selectionModel.init(self),selectionModel.onSelectedRangesChanged.subscribe(handleSelectedRangesChanged))}function getSelectionModel(){return selectionModel}function getCanvasNode(){return $canvas[0]}function measureScrollbar(){var e=$("<div style='position:absolute; top:-10000px; left:-10000px; width:100px; height:100px; overflow:scroll;'></div>").appendTo("body"),t={width:e.width()-e[0].clientWidth,height:e.height()-e[0].clientHeight};return e.remove(),t}function getHeadersWidth(){for(var e=0,t=0,i=columns.length;i>t;t++){var a=columns[t].width;e+=a}return e+=scrollbarDimensions.width,Math.max(e,viewportW)+1e3}function getCanvasWidth(){for(var e=viewportHasVScroll?viewportW-scrollbarDimensions.width:viewportW,t=0,i=columns.length;i--;)t+=columns[i].width;return options.fullWidthRows?Math.max(t,e):t}function updateCanvasWidth(e){var t=canvasWidth;canvasWidth=getCanvasWidth(),canvasWidth!=t&&($canvas.width(canvasWidth),$headerRow.width(canvasWidth),$headers.width(getHeadersWidth()),viewportHasHScroll=canvasWidth>viewportW-scrollbarDimensions.width),$headerRowSpacer.width(canvasWidth+(viewportHasVScroll?scrollbarDimensions.width:0)),(canvasWidth!=t||e)&&applyColumnWidths()}function disableSelection(e){e&&e.jquery&&e.attr("unselectable","on").css("MozUserSelect","none").bind("selectstart.ui",function(){return!1})}function getMaxSupportedCssHeight(){for(var e=1e6,t=navigator.userAgent.toLowerCase().match(/firefox/)?6e6:1e9,i=$("<div style='display:none' />").appendTo(document.body);;){var a=2*e;if(i.css("height",a),a>t||i.height()!==a)break;e=a}return i.remove(),e}function bindAncestorScrollEvents(){for(var e=$canvas[0];(e=e.parentNode)!=document.body&&null!=e;)if(e==$viewport[0]||e.scrollWidth!=e.clientWidth||e.scrollHeight!=e.clientHeight){var t=$(e);$boundAncestors=$boundAncestors?$boundAncestors.add(t):t,t.bind("scroll."+uid,handleActiveCellPositionChange)}}function unbindAncestorScrollEvents(){$boundAncestors&&($boundAncestors.unbind("scroll."+uid),$boundAncestors=null)}function updateColumnHeader(e,t,i){if(initialized){var a=getColumnIndex(e);if(null!=a){var n=columns[a],s=$headers.children().eq(a);s&&(void 0!==t&&(columns[a].name=t),void 0!==i&&(columns[a].toolTip=i),trigger(self.onBeforeHeaderCellDestroy,{node:s[0],column:n}),s.attr("title",i||"").children().eq(0).html(t),trigger(self.onHeaderCellRendered,{node:s[0],column:n}))}}}function getHeaderRow(){return $headerRow[0]}function getHeaderRowColumn(e){var t=getColumnIndex(e),i=$headerRow.children().eq(t);return i&&i[0]}function createColumnHeaders(){function e(){$(this).addClass("ui-state-hover")}function t(){$(this).removeClass("ui-state-hover")}$headers.find(".slick-header-column").each(function(){var e=$(this).data("column");e&&trigger(self.onBeforeHeaderCellDestroy,{node:this,column:e})}),$headers.empty(),$headers.width(getHeadersWidth()),$headerRow.find(".slick-headerrow-column").each(function(){var e=$(this).data("column");e&&trigger(self.onBeforeHeaderRowCellDestroy,{node:this,column:e})}),$headerRow.empty();for(var i=0;i<columns.length;i++){var a=columns[i],n=$("<div class='ui-state-default slick-header-column' id='"+uid+a.id+"' />").html("<span class='slick-column-name'>"+a.name+"</span>").width(a.width-headerColumnWidthDiff).attr("title",a.toolTip||"").data("column",a).addClass(a.headerCssClass||"").appendTo($headers);if((options.enableColumnReorder||a.sortable)&&n.on("mouseenter",e).on("mouseleave",t),a.sortable&&(n.addClass("slick-header-sortable"),n.append("<span class='slick-sort-indicator' />")),trigger(self.onHeaderCellRendered,{node:n[0],column:a}),options.showHeaderRow){var s=$("<div class='ui-state-default slick-headerrow-column l"+i+" r"+i+"'></div>").data("column",a).appendTo($headerRow);trigger(self.onHeaderRowCellRendered,{node:s[0],column:a})}}setSortColumns(sortColumns),setupColumnResize(),options.enableColumnReorder&&setupColumnReorder()}function setupColumnSort(){$headers.click(function(e){if(e.metaKey=e.metaKey||e.ctrlKey,!$(e.target).hasClass("slick-resizable-handle")){var t=$(e.target).closest(".slick-header-column");if(t.length){var i=t.data("column");if(i.sortable){if(!getEditorLock().commitCurrentEdit())return;for(var a=null,n=0;n<sortColumns.length;n++)if(sortColumns[n].columnId==i.id){a=sortColumns[n],a.sortAsc=!a.sortAsc;break}e.metaKey&&options.multiColumnSort?a&&sortColumns.splice(n,1):((e.shiftKey||e.metaKey)&&options.multiColumnSort||(sortColumns=[]),a?0==sortColumns.length&&sortColumns.push(a):(a={columnId:i.id,sortAsc:i.defaultSortAsc},sortColumns.push(a))),setSortColumns(sortColumns),options.multiColumnSort?trigger(self.onSort,{multiColumnSort:!0,sortCols:$.map(sortColumns,function(e){return{sortCol:columns[getColumnIndex(e.columnId)],sortAsc:e.sortAsc}})},e):trigger(self.onSort,{multiColumnSort:!1,sortCol:i,sortAsc:a.sortAsc},e)}}}})}function setupColumnReorder(){$headers.filter(":ui-sortable").sortable("destroy"),$headers.sortable({containment:"parent",distance:3,axis:"x",cursor:"default",tolerance:"intersection",helper:"clone",placeholder:"slick-sortable-placeholder ui-state-default slick-header-column",forcePlaceholderSize:!0,start:function(e,t){$(t.helper).addClass("slick-header-column-active")},beforeStop:function(e,t){$(t.helper).removeClass("slick-header-column-active")},stop:function(e){if(!getEditorLock().commitCurrentEdit())return $(this).sortable("cancel"),void 0;for(var t=$headers.sortable("toArray"),i=[],a=0;a<t.length;a++)i.push(columns[getColumnIndex(t[a].replace(uid,""))]);setColumns(i),trigger(self.onColumnsReordered,{}),e.stopPropagation(),setupColumnResize()}})}function setupColumnResize(){var e,t,i,a,n,s,r,o,l;n=$headers.children(),n.find(".slick-resizable-handle").remove(),n.each(function(e){columns[e].resizable&&(void 0===o&&(o=e),l=e)}),void 0!==o&&n.each(function(u,c){o>u||options.forceFitColumns&&u>=l||(e=$(c),$("<div class='slick-resizable-handle' />").appendTo(c).bind("dragstart",function(e){if(!getEditorLock().commitCurrentEdit())return!1;a=e.pageX,$(this).parent().addClass("slick-header-column-active");var o=null,l=null;if(n.each(function(e,t){columns[e].previousWidth=$(t).outerWidth()}),options.forceFitColumns)for(o=0,l=0,t=u+1;t<n.length;t++)i=columns[t],i.resizable&&(null!==l&&(i.maxWidth?l+=i.maxWidth-i.previousWidth:l=null),o+=i.previousWidth-Math.max(i.minWidth||0,absoluteColumnMinWidth));var c=0,h=0;for(t=0;u>=t;t++)i=columns[t],i.resizable&&(null!==h&&(i.maxWidth?h+=i.maxWidth-i.previousWidth:h=null),c+=i.previousWidth-Math.max(i.minWidth||0,absoluteColumnMinWidth));null===o&&(o=1e5),null===c&&(c=1e5),null===l&&(l=1e5),null===h&&(h=1e5),r=a+Math.min(o,h),s=a-Math.min(c,l)}).bind("drag",function(e){var o,l,c=Math.min(r,Math.max(s,e.pageX))-a;if(0>c){for(l=c,t=u;t>=0;t--)i=columns[t],i.resizable&&(o=Math.max(i.minWidth||0,absoluteColumnMinWidth),l&&i.previousWidth+l<o?(l+=i.previousWidth-o,i.width=o):(i.width=i.previousWidth+l,l=0));if(options.forceFitColumns)for(l=-c,t=u+1;t<n.length;t++)i=columns[t],i.resizable&&(l&&i.maxWidth&&i.maxWidth-i.previousWidth<l?(l-=i.maxWidth-i.previousWidth,i.width=i.maxWidth):(i.width=i.previousWidth+l,l=0))}else{for(l=c,t=u;t>=0;t--)i=columns[t],i.resizable&&(l&&i.maxWidth&&i.maxWidth-i.previousWidth<l?(l-=i.maxWidth-i.previousWidth,i.width=i.maxWidth):(i.width=i.previousWidth+l,l=0));if(options.forceFitColumns)for(l=-c,t=u+1;t<n.length;t++)i=columns[t],i.resizable&&(o=Math.max(i.minWidth||0,absoluteColumnMinWidth),l&&i.previousWidth+l<o?(l+=i.previousWidth-o,i.width=o):(i.width=i.previousWidth+l,l=0))}applyColumnHeaderWidths(),options.syncColumnCellResize&&applyColumnWidths()}).bind("dragend",function(){var e;for($(this).parent().removeClass("slick-header-column-active"),t=0;t<n.length;t++)i=columns[t],e=$(n[t]).outerWidth(),i.previousWidth!==e&&i.rerenderOnResize&&invalidateAllRows();updateCanvasWidth(!0),render(),trigger(self.onColumnsResized,{})}))})}function getVBoxDelta(e){var t=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],i=0;return $.each(t,function(t,a){i+=parseFloat(e.css(a))||0}),i}function measureCellPaddingAndBorder(){var e,t=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],i=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"];e=$("<div class='ui-state-default slick-header-column' style='visibility:hidden'>-</div>").appendTo($headers),headerColumnWidthDiff=headerColumnHeightDiff=0,$.each(t,function(t,i){headerColumnWidthDiff+=parseFloat(e.css(i))||0}),$.each(i,function(t,i){headerColumnHeightDiff+=parseFloat(e.css(i))||0}),e.remove();var a=$("<div class='slick-row' />").appendTo($canvas);e=$("<div class='slick-cell' id='' style='visibility:hidden'>-</div>").appendTo(a),cellWidthDiff=cellHeightDiff=0,$.each(t,function(t,i){cellWidthDiff+=parseFloat(e.css(i))||0}),$.each(i,function(t,i){cellHeightDiff+=parseFloat(e.css(i))||0}),a.remove(),absoluteColumnMinWidth=Math.max(headerColumnWidthDiff,cellWidthDiff)}function createCssRules(){$style=$("<style type='text/css' rel='stylesheet' />").appendTo($("head"));for(var e=options.rowHeight-cellHeightDiff,t=["."+uid+" .slick-header-column { left: 1000px; }","."+uid+" .slick-top-panel { height:"+options.topPanelHeight+"px; }","."+uid+" .slick-headerrow-columns { height:"+options.headerRowHeight+"px; }","."+uid+" .slick-cell { height:"+e+"px; }","."+uid+" .slick-row { height:"+options.rowHeight+"px; }"],i=0;i<columns.length;i++)t.push("."+uid+" .l"+i+" { }"),t.push("."+uid+" .r"+i+" { }");$style[0].styleSheet?$style[0].styleSheet.cssText=t.join(" "):$style[0].appendChild(document.createTextNode(t.join(" ")))}function getColumnCssRules(e){if(!stylesheet){for(var t=document.styleSheets,i=0;i<t.length;i++)if((t[i].ownerNode||t[i].owningElement)==$style[0]){stylesheet=t[i];break}if(!stylesheet)throw new Error("Cannot find stylesheet.");columnCssRulesL=[],columnCssRulesR=[];for(var a,n,s=stylesheet.cssRules||stylesheet.rules,i=0;i<s.length;i++){var r=s[i].selectorText;(a=/\.l\d+/.exec(r))?(n=parseInt(a[0].substr(2,a[0].length-2),10),columnCssRulesL[n]=s[i]):(a=/\.r\d+/.exec(r))&&(n=parseInt(a[0].substr(2,a[0].length-2),10),columnCssRulesR[n]=s[i])}}return{left:columnCssRulesL[e],right:columnCssRulesR[e]}}function removeCssRules(){$style.remove(),stylesheet=null}function destroy(){getEditorLock().cancelCurrentEdit(),trigger(self.onBeforeDestroy,{});for(var e=plugins.length;e--;)unregisterPlugin(plugins[e]);options.enableColumnReorder&&$headers.filter(":ui-sortable").sortable("destroy"),unbindAncestorScrollEvents(),$container.unbind(".slickgrid"),removeCssRules(),$canvas.unbind("draginit dragstart dragend drag"),$container.empty().removeClass(uid)}function trigger(e,t,i){return i=i||new Slick.EventData,t=t||{},t.grid=self,e.notify(t,i,self)}function getEditorLock(){return options.editorLock}function getEditController(){return editController}function getColumnIndex(e){return columnsById[e]}function autosizeColumns(){var e,t,i,a=[],n=0,s=0,r=viewportHasVScroll?viewportW-scrollbarDimensions.width:viewportW;for(e=0;e<columns.length;e++)t=columns[e],a.push(t.width),s+=t.width,t.resizable&&(n+=t.width-Math.max(t.minWidth,absoluteColumnMinWidth));for(i=s;s>r&&n;){var o=(s-r)/n;for(e=0;e<columns.length&&s>r;e++){t=columns[e];var l=a[e];if(!(!t.resizable||l<=t.minWidth||absoluteColumnMinWidth>=l)){var u=Math.max(t.minWidth,absoluteColumnMinWidth),c=Math.floor(o*(l-u))||1;c=Math.min(c,l-u),s-=c,n-=c,a[e]-=c}}if(i==s)break;i=s}for(i=s;r>s;){var h=r/s;for(e=0;e<columns.length&&r>s;e++)if(t=columns[e],t.resizable&&!(t.maxWidth<=t.width)){var d=Math.min(Math.floor(h*t.width)-t.width,t.maxWidth-t.width||1e6)||1;s+=d,a[e]+=d}if(i==s)break;i=s}var p=!1;for(e=0;e<columns.length;e++)columns[e].rerenderOnResize&&columns[e].width!=a[e]&&(p=!0),columns[e].width=a[e];applyColumnHeaderWidths(),updateCanvasWidth(!0),p&&(invalidateAllRows(),render())}function applyColumnHeaderWidths(){if(initialized){for(var e,t=0,i=$headers.children(),a=i.length;a>t;t++)e=$(i[t]),e.width()!==columns[t].width-headerColumnWidthDiff&&e.width(columns[t].width-headerColumnWidthDiff);updateColumnCaches()}}function applyColumnWidths(){for(var e,t,i=0,a=0;a<columns.length;a++)e=columns[a].width,t=getColumnCssRules(a),t.left.style.left=i+"px",t.right.style.right=canvasWidth-i-e+"px",i+=columns[a].width}function setSortColumn(e,t){setSortColumns([{columnId:e,sortAsc:t}])}function setSortColumns(e){sortColumns=e;var t=$headers.children();t.removeClass("slick-header-column-sorted").find(".slick-sort-indicator").removeClass("slick-sort-indicator-asc slick-sort-indicator-desc"),$.each(sortColumns,function(e,i){null==i.sortAsc&&(i.sortAsc=!0);
var a=getColumnIndex(i.columnId);null!=a&&t.eq(a).addClass("slick-header-column-sorted").find(".slick-sort-indicator").addClass(i.sortAsc?"slick-sort-indicator-asc":"slick-sort-indicator-desc")})}function getSortColumns(){return sortColumns}function handleSelectedRangesChanged(e,t){selectedRows=[];for(var i={},a=0;a<t.length;a++)for(var n=t[a].fromRow;n<=t[a].toRow;n++){i[n]||(selectedRows.push(n),i[n]={});for(var s=t[a].fromCell;s<=t[a].toCell;s++)canCellBeSelected(n,s)&&(i[n][columns[s].id]=options.selectedCellCssClass)}setCellCssStyles(options.selectedCellCssClass,i),trigger(self.onSelectedRowsChanged,{rows:getSelectedRows()},e)}function getColumns(){return columns}function updateColumnCaches(){columnPosLeft=[],columnPosRight=[];for(var e=0,t=0,i=columns.length;i>t;t++)columnPosLeft[t]=e,columnPosRight[t]=e+columns[t].width,e+=columns[t].width}function setColumns(e){columns=e,columnsById={};for(var t=0;t<columns.length;t++){var i=columns[t]=$.extend({},columnDefaults,columns[t]);columnsById[i.id]=t,i.minWidth&&i.width<i.minWidth&&(i.width=i.minWidth),i.maxWidth&&i.width>i.maxWidth&&(i.width=i.maxWidth)}updateColumnCaches(),initialized&&(invalidateAllRows(),createColumnHeaders(),removeCssRules(),createCssRules(),resizeCanvas(),applyColumnWidths(),handleScroll())}function getOptions(){return options}function setOptions(e){getEditorLock().commitCurrentEdit()&&(makeActiveCellNormal(),options.enableAddRow!==e.enableAddRow&&invalidateRow(getDataLength()),options=$.extend(options,e),validateAndEnforceOptions(),$viewport.css("overflow-y",options.autoHeight?"hidden":"auto"),render())}function validateAndEnforceOptions(){options.autoHeight&&(options.leaveSpaceForNewRows=!1)}function setData(e,t){data=e,invalidateAllRows(),updateRowCount(),t&&scrollTo(0)}function getData(){return data}function getDataLength(){return data.getLength?data.getLength():data.length}function getDataItem(e){return data.getItem?data.getItem(e):data[e]}function getTopPanel(){return $topPanel[0]}function setTopPanelVisibility(e){options.showTopPanel!=e&&(options.showTopPanel=e,e?$topPanelScroller.slideDown("fast",resizeCanvas):$topPanelScroller.slideUp("fast",resizeCanvas))}function setHeaderRowVisibility(e){options.showHeaderRow!=e&&(options.showHeaderRow=e,e?$headerRowScroller.slideDown("fast",resizeCanvas):$headerRowScroller.slideUp("fast",resizeCanvas))}function getRowTop(e){return options.rowHeight*e-offset}function getRowFromPosition(e){return Math.floor((e+offset)/options.rowHeight)}function scrollTo(e){e=Math.max(e,0),e=Math.min(e,th-viewportH+(viewportHasHScroll?scrollbarDimensions.height:0));var t=offset;page=Math.min(n-1,Math.floor(e/ph)),offset=Math.round(page*cj);var i=e-offset;if(offset!=t){var a=getVisibleRange(i);cleanupRows(a),updateRowPositions()}prevScrollTop!=i&&(vScrollDir=i+offset>prevScrollTop+t?1:-1,$viewport[0].scrollTop=lastRenderedScrollTop=scrollTop=prevScrollTop=i,trigger(self.onViewportChanged,{}))}function defaultFormatter(e,t,i){return null==i?"":(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function getFormatter(e,t){var i=data.getItemMetadata&&data.getItemMetadata(e),a=i&&i.columns&&(i.columns[t.id]||i.columns[getColumnIndex(t.id)]);return a&&a.formatter||i&&i.formatter||t.formatter||options.formatterFactory&&options.formatterFactory.getFormatter(t)||options.defaultFormatter}function getEditor(e,t){var i=columns[t],a=data.getItemMetadata&&data.getItemMetadata(e),n=a&&a.columns;return n&&n[i.id]&&void 0!==n[i.id].editor?n[i.id].editor:n&&n[t]&&void 0!==n[t].editor?n[t].editor:i.editor||options.editorFactory&&options.editorFactory.getEditor(i)}function getDataItemValueForColumn(e,t){return options.dataItemColumnValueExtractor?options.dataItemColumnValueExtractor(e,t):e[t.field]}function appendRowHtml(e,t,i){var a=getDataItem(t),n=t<getDataLength()&&!a,s="slick-row"+(n?" loading":"")+(t===activeRow?" active":"")+(1==t%2?" odd":" even"),r=data.getItemMetadata&&data.getItemMetadata(t);r&&r.cssClasses&&(s+=" "+r.cssClasses),e.push("<div class='ui-widget-content "+s+"' style='top:"+getRowTop(t)+"px'>");for(var o,l,u=0,c=columns.length;c>u;u++){if(l=columns[u],o=1,r&&r.columns){var h=r.columns[l.id]||r.columns[u];o=h&&h.colspan||1,"*"===o&&(o=c-u)}if(columnPosRight[Math.min(c-1,u+o-1)]>i.leftPx){if(columnPosLeft[u]>i.rightPx)break;appendCellHtml(e,t,u,o)}o>1&&(u+=o-1)}e.push("</div>")}function appendCellHtml(e,t,i,a){var n=columns[i],s=getDataItem(t),r="slick-cell l"+i+" r"+Math.min(columns.length-1,i+a-1)+(n.cssClass?" "+n.cssClass:"");t===activeRow&&i===activeCell&&(r+=" active");for(var o in cellCssClasses)cellCssClasses[o][t]&&cellCssClasses[o][t][n.id]&&(r+=" "+cellCssClasses[o][t][n.id]);if(e.push("<div class='"+r+"'>"),s){var l=getDataItemValueForColumn(s,n);e.push(getFormatter(t,n)(t,i,l,n,s))}e.push("</div>"),rowsCache[t].cellRenderQueue.push(i),rowsCache[t].cellColSpans[i]=a}function cleanupRows(e){for(var t in rowsCache)(t=parseInt(t,10))!==activeRow&&(t<e.top||t>e.bottom)&&removeRowFromCache(t)}function invalidate(){updateRowCount(),invalidateAllRows(),render()}function invalidateAllRows(){currentEditor&&makeActiveCellNormal();for(var e in rowsCache)removeRowFromCache(e)}function removeRowFromCache(e){var t=rowsCache[e];t&&($canvas[0].removeChild(t.rowNode),delete rowsCache[e],delete postProcessedRows[e],renderedRows--,counter_rows_removed++)}function invalidateRows(e){var t,i;if(e&&e.length)for(vScrollDir=0,t=0,i=e.length;i>t;t++)currentEditor&&activeRow===e[t]&&makeActiveCellNormal(),rowsCache[e[t]]&&removeRowFromCache(e[t])}function invalidateRow(e){invalidateRows([e])}function updateCell(e,t){var i=getCellNode(e,t);if(i){var a=columns[t],n=getDataItem(e);currentEditor&&activeRow===e&&activeCell===t?currentEditor.loadValue(n):(i.innerHTML=n?getFormatter(e,a)(e,t,getDataItemValueForColumn(n,a),a,n):"",invalidatePostProcessingResults(e))}}function updateRow(e){var t=rowsCache[e];if(t){ensureCellNodesInRowsCache(e);for(var i in t.cellNodesByColumnIdx)if(t.cellNodesByColumnIdx.hasOwnProperty(i)){i=0|i;var a=columns[i],n=getDataItem(e),s=t.cellNodesByColumnIdx[i];e===activeRow&&i===activeCell&&currentEditor?currentEditor.loadValue(n):s.innerHTML=n?getFormatter(e,a)(e,i,getDataItemValueForColumn(n,a),a,n):""}invalidatePostProcessingResults(e)}}function getViewportHeight(){return parseFloat($.css($container[0],"height",!0))-parseFloat($.css($container[0],"paddingTop",!0))-parseFloat($.css($container[0],"paddingBottom",!0))-parseFloat($.css($headerScroller[0],"height"))-getVBoxDelta($headerScroller)-(options.showTopPanel?options.topPanelHeight+getVBoxDelta($topPanelScroller):0)-(options.showHeaderRow?options.headerRowHeight+getVBoxDelta($headerRowScroller):0)}function resizeCanvas(){initialized&&(viewportH=options.autoHeight?options.rowHeight*(getDataLength()+(options.enableAddRow?1:0)):getViewportHeight(),numVisibleRows=Math.ceil(viewportH/options.rowHeight),viewportW=parseFloat($.css($container[0],"width",!0)),options.autoHeight||$viewport.height(viewportH),options.forceFitColumns&&autosizeColumns(),updateRowCount(),handleScroll(),render())}function updateRowCount(){if(initialized){numberOfRows=getDataLength()+(options.enableAddRow?1:0)+(options.leaveSpaceForNewRows?numVisibleRows-1:0);var e=viewportHasVScroll;viewportHasVScroll=!options.autoHeight&&numberOfRows*options.rowHeight>viewportH;var t=options.enableAddRow?getDataLength():getDataLength()-1;for(var i in rowsCache)i>=t&&removeRowFromCache(i);activeCellNode&&activeRow>t&&resetActiveCell();var a=h;th=Math.max(options.rowHeight*numberOfRows,viewportH-scrollbarDimensions.height),maxSupportedCssHeight>th?(h=ph=th,n=1,cj=0):(h=maxSupportedCssHeight,ph=h/100,n=Math.floor(th/ph),cj=(th-h)/(n-1)),h!==a&&($canvas.css("height",h),scrollTop=$viewport[0].scrollTop);var s=th-viewportH>=scrollTop+offset;0==th||0==scrollTop?page=offset=0:s?scrollTo(scrollTop+offset):scrollTo(th-viewportH),h!=a&&options.autoHeight&&resizeCanvas(),options.forceFitColumns&&e!=viewportHasVScroll&&autosizeColumns(),updateCanvasWidth(!1)}}function getVisibleRange(e,t){return null==e&&(e=scrollTop),null==t&&(t=scrollLeft),{top:getRowFromPosition(e),bottom:getRowFromPosition(e+viewportH)+1,leftPx:t,rightPx:t+viewportW}}function getRenderedRange(e,t){var i=getVisibleRange(e,t),a=Math.round(viewportH/options.rowHeight),n=3;return-1==vScrollDir?(i.top-=a,i.bottom+=n):1==vScrollDir?(i.top-=n,i.bottom+=a):(i.top-=n,i.bottom+=n),i.top=Math.max(0,i.top),i.bottom=Math.min(options.enableAddRow?getDataLength():getDataLength()-1,i.bottom),i.leftPx-=viewportW,i.rightPx+=viewportW,i.leftPx=Math.max(0,i.leftPx),i.rightPx=Math.min(canvasWidth,i.rightPx),i}function ensureCellNodesInRowsCache(e){var t=rowsCache[e];if(t&&t.cellRenderQueue.length)for(var i=t.rowNode.lastChild;t.cellRenderQueue.length;){var a=t.cellRenderQueue.pop();t.cellNodesByColumnIdx[a]=i,i=i.previousSibling}}function cleanUpCells(e,t){var i=0,a=rowsCache[t],n=[];for(var s in a.cellNodesByColumnIdx)if(a.cellNodesByColumnIdx.hasOwnProperty(s)){s=0|s;var r=a.cellColSpans[s];(columnPosLeft[s]>e.rightPx||columnPosRight[Math.min(columns.length-1,s+r-1)]<e.leftPx)&&(t!=activeRow||s!=activeCell)&&n.push(s)}for(var o;null!=(o=n.pop());)a.rowNode.removeChild(a.cellNodesByColumnIdx[o]),delete a.cellColSpans[o],delete a.cellNodesByColumnIdx[o],postProcessedRows[t]&&delete postProcessedRows[t][o],i++}function cleanUpAndRenderCells(e){for(var t,i,a,n=[],s=[],r=0,o=e.top;o<=e.bottom;o++)if(t=rowsCache[o]){ensureCellNodesInRowsCache(o),cleanUpCells(e,o),i=0;var l=data.getItemMetadata&&data.getItemMetadata(o);l=l&&l.columns;for(var u=0,c=columns.length;c>u&&!(columnPosLeft[u]>e.rightPx);u++)if(null==(a=t.cellColSpans[u])){if(a=1,l){var h=l[columns[u].id]||l[u];a=h&&h.colspan||1,"*"===a&&(a=c-u)}columnPosRight[Math.min(c-1,u+a-1)]>e.leftPx&&(appendCellHtml(n,o,u,a),i++),u+=a>1?a-1:0}else u+=a>1?a-1:0;i&&(r+=i,s.push(o))}if(n.length){var d=document.createElement("div");d.innerHTML=n.join("");for(var p,f;null!=(p=s.pop());){t=rowsCache[p];for(var m;null!=(m=t.cellRenderQueue.pop());)f=d.lastChild,t.rowNode.appendChild(f),t.cellNodesByColumnIdx[m]=f}}}function renderRows(e){for(var t=$canvas[0],i=[],a=[],n=!1,s=e.top;s<=e.bottom;s++)rowsCache[s]||(renderedRows++,a.push(s),rowsCache[s]={rowNode:null,cellColSpans:[],cellNodesByColumnIdx:[],cellRenderQueue:[]},appendRowHtml(i,s,e),activeCellNode&&activeRow===s&&(n=!0),counter_rows_rendered++);if(a.length){var r=document.createElement("div");r.innerHTML=i.join("");for(var s=0,o=a.length;o>s;s++)rowsCache[a[s]].rowNode=t.appendChild(r.firstChild);n&&(activeCellNode=getCellNode(activeRow,activeCell))}}function startPostProcessing(){options.enableAsyncPostRender&&(clearTimeout(h_postrender),h_postrender=setTimeout(asyncPostProcessRows,options.asyncPostRenderDelay))}function invalidatePostProcessingResults(e){delete postProcessedRows[e],postProcessFromRow=Math.min(postProcessFromRow,e),postProcessToRow=Math.max(postProcessToRow,e),startPostProcessing()}function updateRowPositions(){for(var e in rowsCache)rowsCache[e].rowNode.style.top=getRowTop(e)+"px"}function render(){if(initialized){var e=getVisibleRange(),t=getRenderedRange();cleanupRows(t),lastRenderedScrollLeft!=scrollLeft&&cleanUpAndRenderCells(t),renderRows(t),postProcessFromRow=e.top,postProcessToRow=Math.min(options.enableAddRow?getDataLength():getDataLength()-1,e.bottom),startPostProcessing(),lastRenderedScrollTop=scrollTop,lastRenderedScrollLeft=scrollLeft,h_render=null}}function handleHeaderRowScroll(){var e=$headerRowScroller[0].scrollLeft;e!=$viewport[0].scrollLeft&&($viewport[0].scrollLeft=e)}function handleScroll(){scrollTop=$viewport[0].scrollTop,scrollLeft=$viewport[0].scrollLeft;var e=Math.abs(scrollTop-prevScrollTop),t=Math.abs(scrollLeft-prevScrollLeft);if(t&&(prevScrollLeft=scrollLeft,$headerScroller[0].scrollLeft=scrollLeft,$topPanelScroller[0].scrollLeft=scrollLeft,$headerRowScroller[0].scrollLeft=scrollLeft),e)if(vScrollDir=scrollTop>prevScrollTop?1:-1,prevScrollTop=scrollTop,viewportH>e)scrollTo(scrollTop+offset);else{var i=offset;page=h==viewportH?0:Math.min(n-1,Math.floor(scrollTop*((th-viewportH)/(h-viewportH))*(1/ph))),offset=Math.round(page*cj),i!=offset&&invalidateAllRows()}(t||e)&&(h_render&&clearTimeout(h_render),(Math.abs(lastRenderedScrollTop-scrollTop)>20||Math.abs(lastRenderedScrollLeft-scrollLeft)>20)&&(options.forceSyncScrolling||Math.abs(lastRenderedScrollTop-scrollTop)<viewportH&&Math.abs(lastRenderedScrollLeft-scrollLeft)<viewportW?render():h_render=setTimeout(render,50),trigger(self.onViewportChanged,{}))),trigger(self.onScroll,{scrollLeft:scrollLeft,scrollTop:scrollTop})}function asyncPostProcessRows(){for(;postProcessToRow>=postProcessFromRow;){var e=vScrollDir>=0?postProcessFromRow++:postProcessToRow--,t=rowsCache[e];if(t&&!(e>=getDataLength())){postProcessedRows[e]||(postProcessedRows[e]={}),ensureCellNodesInRowsCache(e);for(var i in t.cellNodesByColumnIdx)if(t.cellNodesByColumnIdx.hasOwnProperty(i)){i=0|i;var a=columns[i];if(a.asyncPostRender&&!postProcessedRows[e][i]){var n=t.cellNodesByColumnIdx[i];n&&a.asyncPostRender(n,e,getDataItem(e),a),postProcessedRows[e][i]=!0}}return h_postrender=setTimeout(asyncPostProcessRows,options.asyncPostRenderDelay),void 0}}}function updateCellCssStylesOnRenderedRows(e,t){var i,a,n,s;for(var r in rowsCache){if(s=t&&t[r],n=e&&e[r],s)for(a in s)n&&s[a]==n[a]||(i=getCellNode(r,getColumnIndex(a)),i&&$(i).removeClass(s[a]));if(n)for(a in n)s&&s[a]==n[a]||(i=getCellNode(r,getColumnIndex(a)),i&&$(i).addClass(n[a]))}}function addCellCssStyles(e,t){if(cellCssClasses[e])throw"addCellCssStyles: cell CSS hash with key '"+e+"' already exists.";cellCssClasses[e]=t,updateCellCssStylesOnRenderedRows(t,null),trigger(self.onCellCssStylesChanged,{key:e,hash:t})}function removeCellCssStyles(e){cellCssClasses[e]&&(updateCellCssStylesOnRenderedRows(null,cellCssClasses[e]),delete cellCssClasses[e],trigger(self.onCellCssStylesChanged,{key:e,hash:null}))}function setCellCssStyles(e,t){var i=cellCssClasses[e];cellCssClasses[e]=t,updateCellCssStylesOnRenderedRows(t,i),trigger(self.onCellCssStylesChanged,{key:e,hash:t})}function getCellCssStyles(e){return cellCssClasses[e]}function flashCell(e,t,i){function a(e){e&&setTimeout(function(){n.queue(function(){n.toggleClass(options.cellFlashingCssClass).dequeue(),a(e-1)})},i)}if(i=i||100,rowsCache[e]){var n=$(getCellNode(e,t));a(4)}}function handleDragInit(e,t){var i=getCellFromEvent(e);if(!i||!cellExists(i.row,i.cell))return!1;var a=trigger(self.onDragInit,t,e);return e.isImmediatePropagationStopped()?a:!1}function handleDragStart(e,t){var i=getCellFromEvent(e);if(!i||!cellExists(i.row,i.cell))return!1;var a=trigger(self.onDragStart,t,e);return e.isImmediatePropagationStopped()?a:!1}function handleDrag(e,t){return trigger(self.onDrag,t,e)}function handleDragEnd(e,t){trigger(self.onDragEnd,t,e)}function handleKeyDown(e){trigger(self.onKeyDown,{row:activeRow,cell:activeCell},e);var t=e.isImmediatePropagationStopped();if(!t)if(e.shiftKey||e.altKey||e.ctrlKey)9!=e.which||!e.shiftKey||e.ctrlKey||e.altKey||(t=navigatePrev());else if(27==e.which){if(!getEditorLock().isActive())return;cancelEditAndSetFocus()}else 37==e.which?t=navigateLeft():39==e.which?t=navigateRight():38==e.which?t=navigateUp():40==e.which?t=navigateDown():9==e.which?t=navigateNext():13==e.which&&(options.editable&&(currentEditor?activeRow===getDataLength()?navigateDown():commitEditAndSetFocus():getEditorLock().commitCurrentEdit()&&makeActiveCellEditable()),t=!0);if(t){e.stopPropagation(),e.preventDefault();try{e.originalEvent.keyCode=0}catch(i){}}}function handleClick(e){currentEditor||e.target!=document.activeElement&&setFocus();var t=getCellFromEvent(e);!t||null!==currentEditor&&activeRow==t.row&&activeCell==t.cell||(trigger(self.onClick,{row:t.row,cell:t.cell},e),e.isImmediatePropagationStopped()||activeCell==t.cell&&activeRow==t.row||!canCellBeActive(t.row,t.cell)||(!getEditorLock().isActive()||getEditorLock().commitCurrentEdit())&&(scrollRowIntoView(t.row,!1),setActiveCellInternal(getCellNode(t.row,t.cell),t.row===getDataLength()||options.autoEdit)))}function handleContextMenu(e){var t=$(e.target).closest(".slick-cell",$canvas);0!==t.length&&(activeCellNode!==t[0]||null===currentEditor)&&trigger(self.onContextMenu,{},e)}function handleDblClick(e){var t=getCellFromEvent(e);!t||null!==currentEditor&&activeRow==t.row&&activeCell==t.cell||(trigger(self.onDblClick,{row:t.row,cell:t.cell},e),e.isImmediatePropagationStopped()||options.editable&&gotoCell(t.row,t.cell,!0))}function handleHeaderMouseEnter(e){trigger(self.onHeaderMouseEnter,{column:$(this).data("column")},e)}function handleHeaderMouseLeave(e){trigger(self.onHeaderMouseLeave,{column:$(this).data("column")},e)}function handleHeaderContextMenu(e){var t=$(e.target).closest(".slick-header-column",".slick-header-columns"),i=t&&t.data("column");trigger(self.onHeaderContextMenu,{column:i},e)}function handleHeaderClick(e){var t=$(e.target).closest(".slick-header-column",".slick-header-columns"),i=t&&t.data("column");i&&trigger(self.onHeaderClick,{column:i},e)}function handleMouseEnter(e){trigger(self.onMouseEnter,{},e)}function handleMouseLeave(e){trigger(self.onMouseLeave,{},e)}function cellExists(e,t){return!(0>e||e>=getDataLength()||0>t||t>=columns.length)}function getCellFromPoint(e,t){for(var i=getRowFromPosition(t),a=0,n=0,s=0;s<columns.length&&e>n;s++)n+=columns[s].width,a++;return 0>a&&(a=0),{row:i,cell:a-1}}function getCellFromNode(e){var t=/l\d+/.exec(e.className);if(!t)throw"getCellFromNode: cannot get cell - "+e.className;return parseInt(t[0].substr(1,t[0].length-1),10)}function getRowFromNode(e){for(var t in rowsCache)if(rowsCache[t].rowNode===e)return 0|t;return null}function getCellFromEvent(e){var t=$(e.target).closest(".slick-cell",$canvas);if(!t.length)return null;var i=getRowFromNode(t[0].parentNode),a=getCellFromNode(t[0]);return null==i||null==a?null:{row:i,cell:a}}function getCellNodeBox(e,t){if(!cellExists(e,t))return null;for(var i=getRowTop(e),a=i+options.rowHeight-1,n=0,s=0;t>s;s++)n+=columns[s].width;var r=n+columns[t].width;return{top:i,left:n,bottom:a,right:r}}function resetActiveCell(){setActiveCellInternal(null,!1)}function setFocus(){-1==tabbingDirection?$focusSink[0].focus():$focusSink2[0].focus()}function scrollCellIntoView(e,t,i){scrollRowIntoView(e,i);var a=getColspan(e,t),n=columnPosLeft[t],s=columnPosRight[t+(a>1?a-1:0)],r=scrollLeft+viewportW;scrollLeft>n?($viewport.scrollLeft(n),handleScroll(),render()):s>r&&($viewport.scrollLeft(Math.min(n,s-$viewport[0].clientWidth)),handleScroll(),render())}function setActiveCellInternal(e,t){null!==activeCellNode&&(makeActiveCellNormal(),$(activeCellNode).removeClass("active"),rowsCache[activeRow]&&$(rowsCache[activeRow].rowNode).removeClass("active"));var i=activeCellNode!==e;activeCellNode=e,null!=activeCellNode?(activeRow=getRowFromNode(activeCellNode.parentNode),activeCell=activePosX=getCellFromNode(activeCellNode),$(activeCellNode).addClass("active"),$(rowsCache[activeRow].rowNode).addClass("active"),options.editable&&t&&isCellPotentiallyEditable(activeRow,activeCell)&&(clearTimeout(h_editorLoader),options.asyncEditorLoading?h_editorLoader=setTimeout(function(){makeActiveCellEditable()},options.asyncEditorLoadDelay):makeActiveCellEditable())):activeRow=activeCell=null,i&&trigger(self.onActiveCellChanged,getActiveCell())}function clearTextSelection(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var e=window.getSelection();e&&e.removeAllRanges&&e.removeAllRanges()}}function isCellPotentiallyEditable(e,t){return e<getDataLength()&&!getDataItem(e)?!1:columns[t].cannotTriggerInsert&&e>=getDataLength()?!1:getEditor(e,t)?!0:!1}function makeActiveCellNormal(){if(currentEditor){if(trigger(self.onBeforeCellEditorDestroy,{editor:currentEditor}),currentEditor.destroy(),currentEditor=null,activeCellNode){var e=getDataItem(activeRow);if($(activeCellNode).removeClass("editable invalid"),e){var t=columns[activeCell],i=getFormatter(activeRow,t);activeCellNode.innerHTML=i(activeRow,activeCell,getDataItemValueForColumn(e,t),t,getDataItem(activeRow)),invalidatePostProcessingResults(activeRow)}}navigator.userAgent.toLowerCase().match(/msie/)&&clearTextSelection(),getEditorLock().deactivate(editController)}}function makeActiveCellEditable(e){if(activeCellNode){if(!options.editable)throw"Grid : makeActiveCellEditable : should never get called when options.editable is false";if(clearTimeout(h_editorLoader),isCellPotentiallyEditable(activeRow,activeCell)){var t=columns[activeCell],i=getDataItem(activeRow);if(trigger(self.onBeforeEditCell,{row:activeRow,cell:activeCell,item:i,column:t})===!1)return setFocus(),void 0;getEditorLock().activate(editController),$(activeCellNode).addClass("editable"),e||(activeCellNode.innerHTML=""),currentEditor=new(e||getEditor(activeRow,activeCell))({grid:self,gridPosition:absBox($container[0]),position:absBox(activeCellNode),container:activeCellNode,column:t,item:i||{},commitChanges:commitEditAndSetFocus,cancelChanges:cancelEditAndSetFocus}),i&&currentEditor.loadValue(i),serializedEditorValue=currentEditor.serializeValue(),currentEditor.position&&handleActiveCellPositionChange()}}}function commitEditAndSetFocus(){getEditorLock().commitCurrentEdit()&&(setFocus(),options.autoEdit&&navigateDown())}function cancelEditAndSetFocus(){getEditorLock().cancelCurrentEdit()&&setFocus()}function absBox(e){var t={top:e.offsetTop,left:e.offsetLeft,bottom:0,right:0,width:$(e).outerWidth(),height:$(e).outerHeight(),visible:!0};t.bottom=t.top+t.height,t.right=t.left+t.width;for(var i=e.offsetParent;(e=e.parentNode)!=document.body;)t.visible&&e.scrollHeight!=e.offsetHeight&&"visible"!=$(e).css("overflowY")&&(t.visible=t.bottom>e.scrollTop&&t.top<e.scrollTop+e.clientHeight),t.visible&&e.scrollWidth!=e.offsetWidth&&"visible"!=$(e).css("overflowX")&&(t.visible=t.right>e.scrollLeft&&t.left<e.scrollLeft+e.clientWidth),t.left-=e.scrollLeft,t.top-=e.scrollTop,e===i&&(t.left+=e.offsetLeft,t.top+=e.offsetTop,i=e.offsetParent),t.bottom=t.top+t.height,t.right=t.left+t.width;return t}function getActiveCellPosition(){return absBox(activeCellNode)}function getGridPosition(){return absBox($container[0])}function handleActiveCellPositionChange(){if(activeCellNode&&(trigger(self.onActiveCellPositionChanged,{}),currentEditor)){var e=getActiveCellPosition();currentEditor.show&&currentEditor.hide&&(e.visible?currentEditor.show():currentEditor.hide()),currentEditor.position&&currentEditor.position(e)}}function getCellEditor(){return currentEditor}function getActiveCell(){return activeCellNode?{row:activeRow,cell:activeCell}:null}function getActiveCellNode(){return activeCellNode}function scrollRowIntoView(e,t){var i=e*options.rowHeight,a=(e+1)*options.rowHeight-viewportH+(viewportHasHScroll?scrollbarDimensions.height:0);(e+1)*options.rowHeight>scrollTop+viewportH+offset?(scrollTo(t?i:a),render()):e*options.rowHeight<scrollTop+offset&&(scrollTo(t?a:i),render())}function scrollRowToTop(e){scrollTo(e*options.rowHeight),render()}function getColspan(e,t){var i=data.getItemMetadata&&data.getItemMetadata(e);if(!i||!i.columns)return 1;var a=i.columns[columns[t].id]||i.columns[t],n=a&&a.colspan;return n="*"===n?columns.length-t:n||1}function findFirstFocusableCell(e){for(var t=0;t<columns.length;){if(canCellBeActive(e,t))return t;t+=getColspan(e,t)}return null}function findLastFocusableCell(e){for(var t=0,i=null;t<columns.length;)canCellBeActive(e,t)&&(i=t),t+=getColspan(e,t);return i}function gotoRight(e,t){if(t>=columns.length)return null;do t+=getColspan(e,t);while(t<columns.length&&!canCellBeActive(e,t));return t<columns.length?{row:e,cell:t,posX:t}:null}function gotoLeft(e,t){if(0>=t)return null;var i=findFirstFocusableCell(e);if(null===i||i>=t)return null;for(var a,n={row:e,cell:i,posX:i};;){if(a=gotoRight(n.row,n.cell,n.posX),!a)return null;if(a.cell>=t)return n;n=a}}function gotoDown(e,t,i){for(var a;;){if(++e>=getDataLength()+(options.enableAddRow?1:0))return null;for(a=t=0;i>=t;)a=t,t+=getColspan(e,t);if(canCellBeActive(e,a))return{row:e,cell:a,posX:i}}}function gotoUp(e,t,i){for(var a;;){if(--e<0)return null;for(a=t=0;i>=t;)a=t,t+=getColspan(e,t);if(canCellBeActive(e,a))return{row:e,cell:a,posX:i}}}function gotoNext(e,t,i){if(null==e&&null==t&&(e=t=i=0,canCellBeActive(e,t)))return{row:e,cell:t,posX:t};var a=gotoRight(e,t,i);if(a)return a;for(var n=null;++e<getDataLength()+(options.enableAddRow?1:0);)if(n=findFirstFocusableCell(e),null!==n)return{row:e,cell:n,posX:n};return null}function gotoPrev(e,t,i){if(null==e&&null==t&&(e=getDataLength()+(options.enableAddRow?1:0)-1,t=i=columns.length-1,canCellBeActive(e,t)))return{row:e,cell:t,posX:t};for(var a,n;!a&&!(a=gotoLeft(e,t,i));){if(--e<0)return null;t=0,n=findLastFocusableCell(e),null!==n&&(a={row:e,cell:n,posX:n})}return a}function navigateRight(){return navigate("right")}function navigateLeft(){return navigate("left")}function navigateDown(){return navigate("down")}function navigateUp(){return navigate("up")}function navigateNext(){return navigate("next")}function navigatePrev(){return navigate("prev")}function navigate(e){if(!options.enableCellNavigation)return!1;if(!activeCellNode&&"prev"!=e&&"next"!=e)return!1;if(!getEditorLock().commitCurrentEdit())return!0;setFocus();var t={up:-1,down:1,left:-1,right:1,prev:-1,next:1};tabbingDirection=t[e];var i={up:gotoUp,down:gotoDown,left:gotoLeft,right:gotoRight,prev:gotoPrev,next:gotoNext},a=i[e],n=a(activeRow,activeCell,activePosX);if(n){var s=n.row==getDataLength();return scrollCellIntoView(n.row,n.cell,!s),setActiveCellInternal(getCellNode(n.row,n.cell),s||options.autoEdit),activePosX=n.posX,!0}return setActiveCellInternal(getCellNode(activeRow,activeCell),activeRow==getDataLength()||options.autoEdit),!1}function getCellNode(e,t){return rowsCache[e]?(ensureCellNodesInRowsCache(e),rowsCache[e].cellNodesByColumnIdx[t]):null}function setActiveCell(e,t){initialized&&(e>getDataLength()||0>e||t>=columns.length||0>t||options.enableCellNavigation&&(scrollCellIntoView(e,t,!1),setActiveCellInternal(getCellNode(e,t),!1)))}function canCellBeActive(e,t){if(!options.enableCellNavigation||e>=getDataLength()+(options.enableAddRow?1:0)||0>e||t>=columns.length||0>t)return!1;var i=data.getItemMetadata&&data.getItemMetadata(e);if(i&&"boolean"==typeof i.focusable)return i.focusable;var a=i&&i.columns;return a&&a[columns[t].id]&&"boolean"==typeof a[columns[t].id].focusable?a[columns[t].id].focusable:a&&a[t]&&"boolean"==typeof a[t].focusable?a[t].focusable:columns[t].focusable}function canCellBeSelected(e,t){if(e>=getDataLength()||0>e||t>=columns.length||0>t)return!1;var i=data.getItemMetadata&&data.getItemMetadata(e);if(i&&"boolean"==typeof i.selectable)return i.selectable;var a=i&&i.columns&&(i.columns[columns[t].id]||i.columns[t]);return a&&"boolean"==typeof a.selectable?a.selectable:columns[t].selectable}function gotoCell(e,t,i){if(initialized&&canCellBeActive(e,t)&&getEditorLock().commitCurrentEdit()){scrollCellIntoView(e,t,!1);var a=getCellNode(e,t);setActiveCellInternal(a,i||e===getDataLength()||options.autoEdit),currentEditor||setFocus()}}function commitCurrentEdit(){var e=getDataItem(activeRow),t=columns[activeCell];if(currentEditor){if(currentEditor.isValueChanged()){var i=currentEditor.validate();if(i.valid){if(activeRow<getDataLength()){var a={row:activeRow,cell:activeCell,editor:currentEditor,serializedValue:currentEditor.serializeValue(),prevSerializedValue:serializedEditorValue,execute:function(){this.editor.applyValue(e,this.serializedValue),updateRow(this.row)},undo:function(){this.editor.applyValue(e,this.prevSerializedValue),updateRow(this.row)}};options.editCommandHandler?(makeActiveCellNormal(),options.editCommandHandler(e,t,a)):(a.execute(),makeActiveCellNormal()),trigger(self.onCellChange,{row:activeRow,cell:activeCell,item:e})}else{var n={};currentEditor.applyValue(n,currentEditor.serializeValue()),makeActiveCellNormal(),trigger(self.onAddNewRow,{item:n,column:t})}return!getEditorLock().isActive()}return $(activeCellNode).addClass("invalid"),$(activeCellNode).stop(!0,!0).effect("highlight",{color:"red"},300),trigger(self.onValidationError,{editor:currentEditor,cellNode:activeCellNode,validationResults:i,row:activeRow,cell:activeCell,column:t}),currentEditor.focus(),!1}makeActiveCellNormal()}return!0}function cancelCurrentEdit(){return makeActiveCellNormal(),!0}function rowsToRanges(e){for(var t=[],i=columns.length-1,a=0;a<e.length;a++)t.push(new Slick.Range(e[a],0,e[a],i));return t}function getSelectedRows(){if(!selectionModel)throw"Selection model is not set";return selectedRows}function setSelectedRows(e){if(!selectionModel)throw"Selection model is not set";selectionModel.setSelectedRanges(rowsToRanges(e))}var defaults={explicitInitialization:!1,rowHeight:25,defaultColumnWidth:80,enableAddRow:!1,leaveSpaceForNewRows:!1,editable:!1,autoEdit:!0,enableCellNavigation:!0,enableColumnReorder:!0,asyncEditorLoading:!1,asyncEditorLoadDelay:100,forceFitColumns:!1,enableAsyncPostRender:!1,asyncPostRenderDelay:50,autoHeight:!1,editorLock:Slick.GlobalEditorLock,showHeaderRow:!1,headerRowHeight:25,showTopPanel:!1,topPanelHeight:25,formatterFactory:null,editorFactory:null,cellFlashingCssClass:"flashing",selectedCellCssClass:"selected",multiSelect:!0,enableTextSelectionOnCells:!1,dataItemColumnValueExtractor:null,fullWidthRows:!1,multiColumnSort:!1,defaultFormatter:defaultFormatter,forceSyncScrolling:!1},columnDefaults={name:"",resizable:!0,sortable:!1,minWidth:30,rerenderOnResize:!1,headerCssClass:null,defaultSortAsc:!0,focusable:!0,selectable:!0},th,h,ph,n,cj,page=0,offset=0,vScrollDir=1,initialized=!1,$container,uid="slickgrid_"+Math.round(1e6*Math.random()),self=this,$focusSink,$focusSink2,$headerScroller,$headers,$headerRow,$headerRowScroller,$headerRowSpacer,$topPanelScroller,$topPanel,$viewport,$canvas,$style,$boundAncestors,stylesheet,columnCssRulesL,columnCssRulesR,viewportH,viewportW,canvasWidth,viewportHasHScroll,viewportHasVScroll,headerColumnWidthDiff=0,headerColumnHeightDiff=0,cellWidthDiff=0,cellHeightDiff=0,absoluteColumnMinWidth,numberOfRows=0,tabbingDirection=1,activePosX,activeRow,activeCell,activeCellNode=null,currentEditor=null,serializedEditorValue,editController,rowsCache={},renderedRows=0,numVisibleRows,prevScrollTop=0,scrollTop=0,lastRenderedScrollTop=0,lastRenderedScrollLeft=0,prevScrollLeft=0,scrollLeft=0,selectionModel,selectedRows=[],plugins=[],cellCssClasses={},columnsById={},sortColumns=[],columnPosLeft=[],columnPosRight=[],h_editorLoader=null,h_render=null,h_postrender=null,postProcessedRows={},postProcessToRow=null,postProcessFromRow=null,counter_rows_rendered=0,counter_rows_removed=0;this.debug=function(){var e="";e+="\ncounter_rows_rendered:  "+counter_rows_rendered,e+="\ncounter_rows_removed:  "+counter_rows_removed,e+="\nrenderedRows:  "+renderedRows,e+="\nnumVisibleRows:  "+numVisibleRows,e+="\nmaxSupportedCssHeight:  "+maxSupportedCssHeight,e+="\nn(umber of pages):  "+n,e+="\n(current) page:  "+page,e+="\npage height (ph):  "+ph,e+="\nvScrollDir:  "+vScrollDir,alert(e)},this.eval=function(expr){return eval(expr)},$.extend(this,{slickGridVersion:"2.1",onScroll:new Slick.Event,onSort:new Slick.Event,onHeaderMouseEnter:new Slick.Event,onHeaderMouseLeave:new Slick.Event,onHeaderContextMenu:new Slick.Event,onHeaderClick:new Slick.Event,onHeaderCellRendered:new Slick.Event,onBeforeHeaderCellDestroy:new Slick.Event,onHeaderRowCellRendered:new Slick.Event,onBeforeHeaderRowCellDestroy:new Slick.Event,onMouseEnter:new Slick.Event,onMouseLeave:new Slick.Event,onClick:new Slick.Event,onDblClick:new Slick.Event,onContextMenu:new Slick.Event,onKeyDown:new Slick.Event,onAddNewRow:new Slick.Event,onValidationError:new Slick.Event,onViewportChanged:new Slick.Event,onColumnsReordered:new Slick.Event,onColumnsResized:new Slick.Event,onCellChange:new Slick.Event,onBeforeEditCell:new Slick.Event,onBeforeCellEditorDestroy:new Slick.Event,onBeforeDestroy:new Slick.Event,onActiveCellChanged:new Slick.Event,onActiveCellPositionChanged:new Slick.Event,onDragInit:new Slick.Event,onDragStart:new Slick.Event,onDrag:new Slick.Event,onDragEnd:new Slick.Event,onSelectedRowsChanged:new Slick.Event,onCellCssStylesChanged:new Slick.Event,registerPlugin:registerPlugin,unregisterPlugin:unregisterPlugin,getColumns:getColumns,setColumns:setColumns,getColumnIndex:getColumnIndex,updateColumnHeader:updateColumnHeader,setSortColumn:setSortColumn,setSortColumns:setSortColumns,getSortColumns:getSortColumns,autosizeColumns:autosizeColumns,getOptions:getOptions,setOptions:setOptions,getData:getData,getDataLength:getDataLength,getDataItem:getDataItem,setData:setData,getSelectionModel:getSelectionModel,setSelectionModel:setSelectionModel,getSelectedRows:getSelectedRows,setSelectedRows:setSelectedRows,render:render,invalidate:invalidate,invalidateRow:invalidateRow,invalidateRows:invalidateRows,invalidateAllRows:invalidateAllRows,updateCell:updateCell,updateRow:updateRow,getViewport:getVisibleRange,getRenderedRange:getRenderedRange,resizeCanvas:resizeCanvas,updateRowCount:updateRowCount,scrollRowIntoView:scrollRowIntoView,scrollRowToTop:scrollRowToTop,scrollCellIntoView:scrollCellIntoView,getCanvasNode:getCanvasNode,focus:setFocus,getCellFromPoint:getCellFromPoint,getCellFromEvent:getCellFromEvent,getActiveCell:getActiveCell,setActiveCell:setActiveCell,getActiveCellNode:getActiveCellNode,getActiveCellPosition:getActiveCellPosition,resetActiveCell:resetActiveCell,editActiveCell:makeActiveCellEditable,getCellEditor:getCellEditor,getCellNode:getCellNode,getCellNodeBox:getCellNodeBox,canCellBeSelected:canCellBeSelected,canCellBeActive:canCellBeActive,navigatePrev:navigatePrev,navigateNext:navigateNext,navigateUp:navigateUp,navigateDown:navigateDown,navigateLeft:navigateLeft,navigateRight:navigateRight,gotoCell:gotoCell,getTopPanel:getTopPanel,setTopPanelVisibility:setTopPanelVisibility,setHeaderRowVisibility:setHeaderRowVisibility,getHeaderRow:getHeaderRow,getHeaderRowColumn:getHeaderRowColumn,getGridPosition:getGridPosition,flashCell:flashCell,addCellCssStyles:addCellCssStyles,setCellCssStyles:setCellCssStyles,removeCellCssStyles:removeCellCssStyles,getCellCssStyles:getCellCssStyles,init:finishInitialization,destroy:destroy,getEditorLock:getEditorLock,getEditController:getEditController}),init()
}$.extend(!0,window,{Slick:{Grid:SlickGrid}});var scrollbarDimensions,maxSupportedCssHeight}(jQuery),function(e){function t(t){function i(e,i,a,n,s){if(!t.enableExpandCollapse)return s.title;var r=15*s.level+"px";return"<span class='"+t.toggleCssClass+" "+(s.collapsed?t.toggleCollapsedCssClass:t.toggleExpandedCssClass)+"' style='margin-left:"+r+"'>"+"</span>"+"<span class='"+t.groupTitleCssClass+"' level='"+s.level+"'>"+s.title+"</span>"}function a(e,t,i,a,n){return a.groupTotalsFormatter&&a.groupTotalsFormatter(n,a)||""}function n(e){c=e,c.onClick.subscribe(r),c.onKeyDown.subscribe(o)}function s(){c&&(c.onClick.unsubscribe(r),c.onKeyDown.unsubscribe(o))}function r(i,a){var n=this.getDataItem(a.row);n&&n instanceof Slick.Group&&e(i.target).hasClass(t.toggleCssClass)&&(n.collapsed?this.getData().expandGroup(n.groupingKey):this.getData().collapseGroup(n.groupingKey),i.stopImmediatePropagation(),i.preventDefault())}function o(i){if(t.enableExpandCollapse&&i.which==e.ui.keyCode.SPACE){var a=this.getActiveCell();if(a){var n=this.getDataItem(a.row);n&&n instanceof Slick.Group&&(n.collapsed?this.getData().expandGroup(n.groupingKey):this.getData().collapseGroup(n.groupingKey),i.stopImmediatePropagation(),i.preventDefault())}}}function l(){return{selectable:!1,focusable:t.groupFocusable,cssClasses:t.groupCssClass,columns:{0:{colspan:"*",formatter:i,editor:null}}}}function u(){return{selectable:!1,focusable:t.totalsFocusable,cssClasses:t.totalsCssClass,formatter:a,editor:null}}var c,h={groupCssClass:"slick-group",groupTitleCssClass:"slick-group-title",totalsCssClass:"slick-group-totals",groupFocusable:!0,totalsFocusable:!1,toggleCssClass:"slick-group-toggle",toggleExpandedCssClass:"expanded",toggleCollapsedCssClass:"collapsed",enableExpandCollapse:!0};return t=e.extend(!0,{},h,t),{init:n,destroy:s,getGroupRowMetadata:l,getTotalsRowMetadata:u}}e.extend(!0,window,{Slick:{Data:{GroupItemMetadataProvider:t}}})}(jQuery),function(e){function t(t){function i(){bt=!0}function a(){bt=!1,tt()}function n(e){kt=e}function s(e){ot=e}function r(e){e=e||0;for(var t,i=e,a=pt.length;a>i;i++){if(t=pt[i][dt],void 0===t)throw"Each data element must implement a unique 'id' property";mt[t]=i}}function o(){for(var e,t=0,i=pt.length;i>t;t++)if(e=pt[t][dt],void 0===e||mt[e]!==t)throw"Each data element must implement a unique 'id' property"}function l(){return pt}function u(e,t){void 0!==t&&(dt=t),pt=wt=e,mt={},r(),o(),tt()}function c(e){void 0!=e.pageSize&&(Et=e.pageSize,jt=Et?Math.min(jt,Math.max(0,Math.ceil(Nt/Et)-1)):0),void 0!=e.pageNum&&(jt=Math.min(e.pageNum,Math.max(0,Math.ceil(Nt/Et)-1))),Rt.notify(h(),null,ct),tt()}function h(){var e=Et?Math.max(1,Math.ceil(Nt/Et)):1;return{pageSize:Et,pageNum:jt,totalRows:Nt,totalPages:e}}function d(e,t){_t=t,rt=e,st=null,t===!1&&pt.reverse(),pt.sort(e),t===!1&&pt.reverse(),mt={},r(),tt()}function p(e,t){_t=t,st=e,rt=null;var i=Object.prototype.toString;Object.prototype.toString="function"==typeof e?e:function(){return this[e]},t===!1&&pt.reverse(),pt.sort(),Object.prototype.toString=i,t===!1&&pt.reverse(),mt={},r(),tt()}function f(){rt?d(rt,_t):st&&p(st,_t)}function m(e){yt=e,t.inlineFilters&&(lt=K(),ut=X()),tt()}function g(){return St}function y(i){t.groupItemMetadataProvider||(t.groupItemMetadataProvider=new Slick.Data.GroupItemMetadataProvider),Ct=[],Mt=[],i=i||[],St=i instanceof Array?i:[i];for(var a=0;a<St.length;a++){var n=St[a]=e.extend(!0,{},xt,St[a]);n.getterIsAFn="function"==typeof n.getter,n.compiledAccumulators=[];for(var s=n.aggregators.length;s--;)n.compiledAccumulators[s]=Q(n.aggregators[s]);Mt[a]={}}tt()}function v(e,t,i){return null==e?(y([]),void 0):(y({getter:e,formatter:t,comparer:i}),void 0)}function b(e,t){if(!St.length)throw new Error("At least one grouping must be specified before calling setAggregators().");St[0].aggregators=e,St[0].aggregateCollapsed=t,y(St)}function _(e){return pt[e]}function k(e){return mt[e]}function L(){if(!gt){gt={};for(var e=0,t=ft.length;t>e;e++)gt[ft[e][dt]]=e}}function w(e){return L(),gt[e]}function O(e){return pt[mt[e]]}function x(e){var t=[];L();for(var i=0;i<e.length;i++){var a=gt[e[i]];null!=a&&(t[t.length]=a)}return t}function S(e){for(var t=[],i=0;i<e.length;i++)e[i]<ft.length&&(t[t.length]=ft[e[i]][dt]);return t}function C(e,t){if(void 0===mt[e]||e!==t[dt])throw"Invalid or non-matching id";pt[mt[e]]=t,vt||(vt={}),vt[e]=!0,tt()}function M(e,t){pt.splice(e,0,t),r(e),tt()}function P(e){pt.push(e),r(pt.length-1),tt()}function E(e){var t=mt[e];if(void 0===t)throw"Invalid id";delete mt[e],pt.splice(t,1),r(t),tt()}function j(){return ft.length}function N(e){return ft[e]}function T(e){var i=ft[e];return void 0===i?null:i.__group?t.groupItemMetadataProvider.getGroupRowMetadata(i):i.__groupTotals?t.groupItemMetadataProvider.getTotalsRowMetadata(i):null}function I(e,t){if(null==e)for(var i=0;i<St.length;i++)Mt[i]={},St[i].collapsed=t;else Mt[e]={},St[e].collapsed=t;tt()}function R(e){I(e,!0)}function z(e){I(e,!1)}function F(e,t,i){Mt[e][t]=St[e].collapsed^i,tt()}function A(){var e=Array.prototype.slice.call(arguments),t=e[0];1==e.length&&-1!=t.indexOf(Pt)?F(t.split(Pt).length-1,t,!0):F(e.length-1,e.join(Pt),!0)}function B(){var e=Array.prototype.slice.call(arguments),t=e[0];1==e.length&&-1!=t.indexOf(Pt)?F(t.split(Pt).length-1,t,!1):F(e.length-1,e.join(Pt),!1)}function D(){return Ct}function q(e,t){for(var i,a,n,s=[],r=[],o=t?t.level+1:0,l=St[o],u=0,c=l.predefinedValues.length;c>u;u++)a=l.predefinedValues[u],i=r[a],i||(i=new Slick.Group,i.value=a,i.level=o,i.groupingKey=(t?t.groupingKey+Pt:"")+a,s[s.length]=i,r[a]=i);for(var u=0,c=e.length;c>u;u++)n=e[u],a=l.getterIsAFn?l.getter(n):n[l.getter],i=r[a],i||(i=new Slick.Group,i.value=a,i.level=o,i.groupingKey=(t?t.groupingKey+Pt:"")+a,s[s.length]=i,r[a]=i),i.rows[i.count++]=n;if(o<St.length-1)for(var u=0;u<s.length;u++)i=s[u],i.groups=q(i.rows,i);return s.sort(St[o].comparer),s}function H(e){for(var t,i=St[e.level],a=e.level==St.length,n=new Slick.GroupTotals,s=i.aggregators.length;s--;)t=i.aggregators[s],t.init(),i.compiledAccumulators[s].call(t,!a&&i.aggregateChildGroups?e.groups:e.rows),t.storeResult(n);n.group=e,e.totals=n}function U(e,t){t=t||0;for(var i,a=St[t],n=e.length;n--;)i=e[n],(!i.collapsed||a.aggregateCollapsed)&&(i.groups&&U(i.groups,t+1),a.aggregators.length&&(a.aggregateEmpty||i.rows.length||i.groups&&i.groups.length)&&H(i))}function G(e,t){t=t||0;for(var i,a=St[t],n=a.collapsed,s=Mt[t],r=e.length;r--;)i=e[r],i.collapsed=n^s[i.groupingKey],i.title=a.formatter?a.formatter(i):i.value,i.groups&&(G(i.groups,t+1),i.rows=[])}function V(e,t){t=t||0;for(var i,a,n=St[t],s=[],r=0,o=0,l=e.length;l>o;o++){if(a=e[o],s[r++]=a,!a.collapsed){i=a.groups?V(a.groups,t+1):a.rows;for(var u=0,c=i.length;c>u;u++)s[r++]=i[u]}a.totals&&n.displayTotalsRow&&(!a.collapsed||n.aggregateCollapsed)&&(s[r++]=a.totals)}return s}function W(e){var t=/^function[^(]*\(([^)]*)\)\s*{([\s\S]*)}$/,i=e.toString().match(t);return{params:i[1].split(","),body:i[2]}}function Q(e){var t=W(e.accumulate),i=new Function("_items","for (var "+t.params[0]+", _i=0, _il=_items.length; _i<_il; _i++) {"+t.params[0]+" = _items[_i]; "+t.body+"}");return i.displayName=i.name="compiledAccumulatorLoop",i}function K(){var e=W(yt),t=e.body.replace(/return false[;}]/gi,"{ continue _coreloop; }").replace(/return true[;}]/gi,"{ _retval[_idx++] = $item$; continue _coreloop; }").replace(/return ([^;}]+?);/gi,"{ if ($1) { _retval[_idx++] = $item$; }; continue _coreloop; }"),i=["var _retval = [], _idx = 0; ","var $item$, $args$ = _args; ","_coreloop: ","for (var _i = 0, _il = _items.length; _i < _il; _i++) { ","$item$ = _items[_i]; ","$filter$; ","} ","return _retval; "].join("");i=i.replace(/\$filter\$/gi,t),i=i.replace(/\$item\$/gi,e.params[0]),i=i.replace(/\$args\$/gi,e.params[1]);var a=new Function("_items,_args",i);return a.displayName=a.name="compiledFilter",a}function X(){var e=W(yt),t=e.body.replace(/return false[;}]/gi,"{ continue _coreloop; }").replace(/return true[;}]/gi,"{ _cache[_i] = true;_retval[_idx++] = $item$; continue _coreloop; }").replace(/return ([^;}]+?);/gi,"{ if ((_cache[_i] = $1)) { _retval[_idx++] = $item$; }; continue _coreloop; }"),i=["var _retval = [], _idx = 0; ","var $item$, $args$ = _args; ","_coreloop: ","for (var _i = 0, _il = _items.length; _i < _il; _i++) { ","$item$ = _items[_i]; ","if (_cache[_i]) { ","_retval[_idx++] = $item$; ","continue _coreloop; ","} ","$filter$; ","} ","return _retval; "].join("");i=i.replace(/\$filter\$/gi,t),i=i.replace(/\$item\$/gi,e.params[0]),i=i.replace(/\$args\$/gi,e.params[1]);var a=new Function("_items,_args,_cache",i);return a.displayName=a.name="compiledFilterWithCaching",a}function $(e,t){for(var i=[],a=0,n=0,s=e.length;s>n;n++)yt(e[n],t)&&(i[a++]=e[n]);return i}function Y(e,t,i){for(var a,n=[],s=0,r=0,o=e.length;o>r;r++)a=e[r],i[r]?n[s++]=a:yt(a,t)&&(n[s++]=a,i[r]=!0);return n}function Z(e){if(yt){var i=t.inlineFilters?lt:$,a=t.inlineFilters?ut:Y;kt.isFilterNarrowing?wt=i(wt,ot):kt.isFilterExpanding?wt=a(e,ot,Ot):kt.isFilterUnchanged||(wt=i(e,ot))}else wt=Et?e:e.concat();var n;return Et?(wt.length<jt*Et&&(jt=Math.floor(wt.length/Et)),n=wt.slice(Et*jt,Et*jt+Et)):n=wt,{totalRows:wt.length,rows:n}}function J(e,t){var i,a,n,s=[],r=0,o=t.length;kt&&kt.ignoreDiffsBefore&&(r=Math.max(0,Math.min(t.length,kt.ignoreDiffsBefore))),kt&&kt.ignoreDiffsAfter&&(o=Math.min(t.length,Math.max(0,kt.ignoreDiffsAfter)));for(var l=r,u=e.length;o>l;l++)l>=u?s[s.length]=l:(i=t[l],a=e[l],(St.length&&(n=i.__nonDataRow||a.__nonDataRow)&&i.__group!==a.__group||i.__group&&!i.equals(a)||n&&(i.__groupTotals||a.__groupTotals)||i[dt]!=a[dt]||vt&&vt[i[dt]])&&(s[s.length]=l));return s}function et(e){gt=null,(kt.isFilterNarrowing!=Lt.isFilterNarrowing||kt.isFilterExpanding!=Lt.isFilterExpanding)&&(Ot=[]);var t=Z(e);Nt=t.totalRows;var i=t.rows;Ct=[],St.length&&(Ct=q(i),Ct.length&&(U(Ct),G(Ct),i=V(Ct)));var a=J(ft,i);return ft=i,a}function tt(){if(!bt){var t=ft.length,i=Nt,a=et(pt,yt);if(Et&&jt*Et>Nt&&(jt=Math.max(0,Math.ceil(Nt/Et)-1),a=et(pt,yt)),vt=null,Lt=kt,kt={},i!=Nt&&Rt.notify(h(),null,ct),t!=ft.length&&Tt.notify({previous:t,current:ft.length},null,ct),a.length>0&&It.notify({rows:a},null,ct),ct.totalsCallback){var n=e.extend(!0,{},Ct);ct.totalsCallback(n)}}}function it(e){ct.totalsCallback=e}function at(e,t){function i(){if(s.length>0){a=!0;var i=n.mapIdsToRows(s);t||(s=n.mapRowsToIds(i)),e.setSelectedRows(i),a=!1}}var a,n=this,s=n.mapRowsToIds(e.getSelectedRows());e.onSelectedRowsChanged.subscribe(function(){a||(s=n.mapRowsToIds(e.getSelectedRows()))}),this.onRowsChanged.subscribe(i),this.onRowCountChanged.subscribe(i)}function nt(e,t){function i(e){n={};for(var t in e){var i=ft[t][dt];n[i]=e[t]}}function a(){if(n){s=!0,L();var i={};for(var a in n){var r=gt[a];void 0!=r&&(i[r]=n[a])}e.setCellCssStyles(t,i),s=!1}}var n,s;i(e.getCellCssStyles(t)),e.onCellCssStylesChanged.subscribe(function(e,a){s||t==a.key&&i(a.hash)}),this.onRowsChanged.subscribe(a),this.onRowCountChanged.subscribe(a)}var st,rt,ot,lt,ut,ct=this,ht={groupItemMetadataProvider:null,inlineFilters:!1},dt="id",pt=[],ft=[],mt={},gt=null,yt=null,vt=null,bt=!1,_t=!0,kt={},Lt={},wt=[],Ot=[],xt={getter:null,formatter:null,comparer:function(e,t){return e.value-t.value},predefinedValues:[],aggregators:[],aggregateEmpty:!1,aggregateCollapsed:!1,aggregateChildGroups:!1,collapsed:!1,displayTotalsRow:!0},St=[],Ct=[],Mt=[],Pt=":|:",Et=0,jt=0,Nt=0,Tt=new Slick.Event,It=new Slick.Event,Rt=new Slick.Event;return t=e.extend(!0,{},ht,t),{beginUpdate:i,endUpdate:a,setPagingOptions:c,getPagingInfo:h,getItems:l,setItems:u,setFilter:m,sort:d,fastSort:p,reSort:f,setGrouping:y,getGrouping:g,groupBy:v,setAggregators:b,collapseAllGroups:R,expandAllGroups:z,collapseGroup:A,expandGroup:B,getGroups:D,getIdxById:k,getRowById:w,getItemById:O,getItemByIdx:_,mapRowsToIds:S,mapIdsToRows:x,setRefreshHints:n,setFilterArgs:s,refresh:tt,updateItem:C,insertItem:M,addItem:P,deleteItem:E,syncGridSelection:at,syncGridCellCssStyles:nt,setTotalsCallback:it,getLength:j,getItem:N,getItemMetadata:T,onRowCountChanged:Tt,onRowsChanged:It,onPagingInfoChanged:Rt}}function i(e){this.field_=e,this.init=function(){this.count_=0,this.nonNullCount_=0,this.sum_=0},this.accumulate=function(e){var t=e[this.field_];this.count_++,null!=t&&""!==t&&0/0!==t&&(this.nonNullCount_++,this.sum_+=parseFloat(t))},this.storeResult=function(e){e.avg||(e.avg={}),0!=this.nonNullCount_&&(e.avg[this.field_]=this.sum_/this.nonNullCount_)}}function a(e){this.field_=e,this.init=function(){this.min_=null},this.accumulate=function(e){var t=e[this.field_];null!=t&&""!==t&&0/0!==t&&(null==this.min_||t<this.min_)&&(this.min_=t)},this.storeResult=function(e){e.min||(e.min={}),e.min[this.field_]=this.min_}}function n(e){this.field_=e,this.init=function(){this.max_=null},this.accumulate=function(e){var t=e[this.field_];null!=t&&""!==t&&0/0!==t&&(null==this.max_||t>this.max_)&&(this.max_=t)},this.storeResult=function(e){e.max||(e.max={}),e.max[this.field_]=this.max_}}function s(e){this.field_=e,this.init=function(){this.sum_=null},this.accumulate=function(e){var t=e[this.field_];null!=t&&""!==t&&0/0!==t&&(this.sum_+=parseFloat(t))},this.storeResult=function(e){e.sum||(e.sum={}),e.sum[this.field_]=this.sum_}}function r(e){this.field_=e,this.init=function(){this.pairs_=[]},this.accumulate=function(e){var t=e[this.field_],i=!1;if(null!=t&&""!==t&&0/0!==t){for(var a=0;a<this.pairs_.length;a++)if(this.pairs_[a].value==t){this.pairs_[a].count++,i=!0;break}i||this.pairs_.push({value:t,count:1})}},this.storeResult=function(e){e.mde||(e.mde={});for(var t=0,i=0;i<this.pairs_.length;i++)(this.pairs_[i].count>this.pairs_[t].count||this.pairs_[i].count===this.pairs_[t].count&&this.pairs_[i].value<this.pairs_[t].value)&&(t=i);"undefined"!=typeof this.pairs_[t]&&(e.mde[this.field_]=this.pairs_[t].value)}}function o(e){this.field_=e,this.init=function(){this.sorted_=[]},this.accumulate=function(e){var t=e[this.field_],i=!1;if(null!=t&&""!==t&&0/0!==t){for(var a=0;a<this.sorted_.length;a++)if(t<this.sorted_[a]){this.sorted_.splice(a,0,t),i=!0;break}i||this.sorted_.push(t)}},this.storeResult=function(e){e.mdn||(e.mdn={});var t=this.sorted_.length;if(1==t%2)e.mdn[this.field_]=this.sorted_[(t-1)/2];else{var i=t/2;e.mdn[this.field_]=.5*(this.sorted_[i]+this.sorted_[i-1])}}}function l(e){this.field_=e,this.init=function(){this.nonNullCount_=0,this.Mk_=null,this.Qk_=0},this.accumulate=function(e){var t=e[this.field_];null!=t&&""!==t&&0/0!==t&&(this.nonNullCount_++,null!=this.Mk_?(this.Qk_=this.Qk_+(this.nonNullCount_-1)*Math.pow(t-this.Mk_,2)/this.nonNullCount_,this.Mk_=this.Mk_+(t-this.Mk_)/this.nonNullCount_):this.Mk_=t)},this.storeResult=function(e){e.std||(e.std={}),0!=this.nonNullCount_&&(e.std[this.field_]=Math.sqrt(this.Qk_/this.nonNullCount_))}}e.extend(!0,window,{Slick:{Data:{DataView:t,Aggregators:{Avg:i,Mde:r,Mdn:o,Min:a,Max:n,Sum:s,Std:l}}}})}(jQuery),function(e){function t(t,i,a){function n(){t.onPagingInfoChanged.subscribe(function(e,t){d(t)}),h(),d(t.getPagingInfo())}function s(){var e=!Slick.GlobalEditorLock.commitCurrentEdit(),i=t.getPagingInfo(),a=i.totalPages-1;return{canGotoFirst:!e&&0!=i.pageSize&&i.pageNum>0,canGotoLast:!e&&0!=i.pageSize&&i.pageNum!=a,canGotoPrev:!e&&0!=i.pageSize&&i.pageNum>0,canGotoNext:!e&&0!=i.pageSize&&i.pageNum<a,pagingInfo:i}}function r(e){t.setRefreshHints({isFilterUnchanged:!0}),t.setPagingOptions({pageSize:e})}function o(){s().canGotoFirst&&t.setPagingOptions({pageNum:0})}function l(){var e=s();e.canGotoLast&&t.setPagingOptions({pageNum:e.pagingInfo.totalPages-1})}function u(){var e=s();e.canGotoPrev&&t.setPagingOptions({pageNum:e.pagingInfo.pageNum-1})}function c(){var e=s();e.canGotoNext&&t.setPagingOptions({pageNum:e.pagingInfo.pageNum+1})}function h(){a.empty();var t=e("<span class='slick-pager-nav' />").appendTo(a),n=e("<span class='slick-pager-settings' />").appendTo(a);p=e("<span class='slick-pager-status' />").appendTo(a),n.append("<span class='slick-pager-settings-expanded' style='display:none'>Show: <a data=0>All</a><a data='-1'>Auto</a><a data=25>25</a><a data=50>50</a><a data=100>100</a></span>"),n.find("a[data]").click(function(t){var a=e(t.target).attr("data");if(void 0!=a)if(-1==a){var n=i.getViewport();r(n.bottom-n.top)}else r(parseInt(a))});var s="<span class='ui-state-default ui-corner-all ui-icon-container'><span class='ui-icon ",h="' /></span>";e(s+"ui-icon-lightbulb"+h).click(function(){e(".slick-pager-settings-expanded").toggle()}).appendTo(n),e(s+"ui-icon-seek-first"+h).click(o).appendTo(t),e(s+"ui-icon-seek-prev"+h).click(u).appendTo(t),e(s+"ui-icon-seek-next"+h).click(c).appendTo(t),e(s+"ui-icon-seek-end"+h).click(l).appendTo(t),a.find(".ui-icon-container").hover(function(){e(this).toggleClass("ui-state-hover")}),a.children().wrapAll("<div class='slick-pager' />")}function d(e){var t=s();a.find(".slick-pager-nav span").removeClass("ui-state-disabled"),t.canGotoFirst||a.find(".ui-icon-seek-first").addClass("ui-state-disabled"),t.canGotoLast||a.find(".ui-icon-seek-end").addClass("ui-state-disabled"),t.canGotoNext||a.find(".ui-icon-seek-next").addClass("ui-state-disabled"),t.canGotoPrev||a.find(".ui-icon-seek-prev").addClass("ui-state-disabled"),0==e.pageSize?p.text("Showing all "+e.totalRows+" rows"):p.text("Showing page "+(e.pageNum+1)+" of "+e.totalPages)}var p;n()}e.extend(!0,window,{Slick:{Controls:{Pager:t}}})}(jQuery),function(e){function t(t,i,a){function n(){i.onHeaderContextMenu.subscribe(s),i.onColumnsReordered.subscribe(r),a=e.extend({},h,a),u=e("<span class='slick-columnpicker' style='display:none;position:absolute;z-index:20;' />").appendTo(document.body),u.bind("mouseleave",function(){e(this).fadeOut(a.fadeSpeed)}),u.bind("click",o)}function s(n){n.preventDefault(),u.empty(),r(),c=[];for(var s,o,l=0;l<t.length;l++)s=e("<li />").appendTo(u),o=e("<input type='checkbox' />").data("column-id",t[l].id),c.push(o),null!=i.getColumnIndex(t[l].id)&&o.attr("checked","checked"),e("<label />").text(t[l].name).prepend(o).appendTo(s);e("<hr/>").appendTo(u),s=e("<li />").appendTo(u),o=e("<input type='checkbox' />").data("option","autoresize"),e("<label />").text("Force fit columns").prepend(o).appendTo(s),i.getOptions().forceFitColumns&&o.attr("checked","checked"),s=e("<li />").appendTo(u),o=e("<input type='checkbox' />").data("option","syncresize"),e("<label />").text("Synchronous resize").prepend(o).appendTo(s),i.getOptions().syncColumnCellResize&&o.attr("checked","checked"),u.css("top",n.pageY-10).css("left",n.pageX-10).fadeIn(a.fadeSpeed)}function r(){for(var e=i.getColumns().slice(0),a=new Array(t.length),n=0;n<a.length;n++)a[n]=void 0===i.getColumnIndex(t[n].id)?t[n]:e.shift();t=a}function o(a){if("autoresize"==e(a.target).data("option"))return a.target.checked?(i.setOptions({forceFitColumns:!0}),i.autosizeColumns()):i.setOptions({forceFitColumns:!1}),void 0;if("syncresize"==e(a.target).data("option"))return a.target.checked?i.setOptions({syncColumnCellResize:!0}):i.setOptions({syncColumnCellResize:!1}),void 0;if(e(a.target).is(":checkbox")){var n=[];if(e.each(c,function(i){e(this).is(":checked")&&n.push(t[i])}),!n.length)return e(a.target).attr("checked","checked"),void 0;i.setColumns(n)}}function l(){return t}var u,c,h={fadeSpeed:250};return n(),{getAllColumns:l}}e.extend(!0,window,{Slick:{Controls:{ColumnPicker:t}}})}(jQuery),function(){var e;e=function(){function e(){this.options_index=0,this.parsed=[]}return e.prototype.add_node=function(e){return"OPTGROUP"===e.nodeName.toUpperCase()?this.add_group(e):this.add_option(e)},e.prototype.add_group=function(e){var t,i,a,n,s,r;for(t=this.parsed.length,this.parsed.push({array_index:t,group:!0,label:e.label,children:0,disabled:e.disabled}),s=e.childNodes,r=[],a=0,n=s.length;n>a;a++)i=s[a],r.push(this.add_option(i,t,e.disabled));return r},e.prototype.add_option=function(e,t,i){return"OPTION"===e.nodeName.toUpperCase()?(""!==e.text?(null!=t&&(this.parsed[t].children+=1),this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:e.value,text:e.text,html:e.innerHTML,selected:e.selected,disabled:i===!0?i:e.disabled,group_array_index:t,classes:e.className,style:e.style.cssText})):this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:!0}),this.options_index+=1):void 0},e}(),e.select_to_array=function(t){var i,a,n,s,r;for(a=new e,r=t.childNodes,n=0,s=r.length;s>n;n++)i=r[n],a.add_node(i);return a.parsed},this.SelectParser=e}.call(this),function(){var e,t;t=this,e=function(){function e(e,t){this.form_field=e,this.options=null!=t?t:{},this.is_multiple=this.form_field.multiple,this.set_default_text(),this.set_default_values(),this.setup(),this.set_up_html(),this.register_observers(),this.finish_setup()}return e.prototype.set_default_values=function(){var e=this;return this.click_test_action=function(t){return e.test_active_click(t)},this.activate_action=function(t){return e.activate_field(t)},this.active_field=!1,this.mouse_on_container=!1,this.results_showing=!1,this.result_highlighted=null,this.result_single_selected=null,this.allow_single_deselect=null!=this.options.allow_single_deselect&&null!=this.form_field.options[0]&&""===this.form_field.options[0].text?this.options.allow_single_deselect:!1,this.disable_search_threshold=this.options.disable_search_threshold||0,this.disable_search=this.options.disable_search||!1,this.enable_split_word_search=null!=this.options.enable_split_word_search?this.options.enable_split_word_search:!0,this.search_contains=this.options.search_contains||!1,this.choices=0,this.single_backstroke_delete=this.options.single_backstroke_delete||!1,this.max_selected_options=this.options.max_selected_options||1/0,this.inherit_select_classes=this.options.inherit_select_classes||!1},e.prototype.set_default_text=function(){return this.default_text=this.form_field.getAttribute("data-placeholder")?this.form_field.getAttribute("data-placeholder"):this.is_multiple?this.options.placeholder_text_multiple||this.options.placeholder_text||"Select Some Options":this.options.placeholder_text_single||this.options.placeholder_text||"Select an Option",this.results_none_found=this.form_field.getAttribute("data-no_results_text")||this.options.no_results_text||"No results match"},e.prototype.mouse_enter=function(){return this.mouse_on_container=!0},e.prototype.mouse_leave=function(){return this.mouse_on_container=!1},e.prototype.input_focus=function(){var e=this;if(this.is_multiple){if(!this.active_field)return setTimeout(function(){return e.container_mousedown()},50)}else if(!this.active_field)return this.activate_field()},e.prototype.input_blur=function(){var e=this;return this.mouse_on_container?void 0:(this.active_field=!1,setTimeout(function(){return e.blur_test()},100))},e.prototype.result_add_option=function(e){var t,i;return e.disabled?"":(e.dom_id=this.container_id+"_o_"+e.array_index,t=e.selected&&this.is_multiple?[]:["active-result"],e.selected&&t.push("result-selected"),null!=e.group_array_index&&t.push("group-option"),""!==e.classes&&t.push(e.classes),i=""!==e.style.cssText?' style="'+e.style+'"':"",'<li id="'+e.dom_id+'" class="'+t.join(" ")+'"'+i+">"+e.html+"</li>")},e.prototype.results_update_field=function(){return this.set_default_text(),this.is_multiple||this.results_reset_cleanup(),this.result_clear_highlight(),this.result_single_selected=null,this.results_build()},e.prototype.results_toggle=function(){return this.results_showing?this.results_hide():this.results_show()},e.prototype.results_search=function(){return this.results_showing?this.winnow_results():this.results_show()},e.prototype.keyup_checker=function(e){var t,i;switch(t=null!=(i=e.which)?i:e.keyCode,this.search_field_scale(),t){case 8:if(this.is_multiple&&this.backstroke_length<1&&this.choices>0)return this.keydown_backstroke();if(!this.pending_backstroke)return this.result_clear_highlight(),this.results_search();break;case 13:if(e.preventDefault(),this.results_showing)return this.result_select(e);break;case 27:return this.results_showing&&this.results_hide(),!0;case 9:case 38:case 40:case 16:case 91:case 17:break;default:return this.results_search()}},e.prototype.generate_field_id=function(){var e;return e=this.generate_random_id(),this.form_field.id=e,e},e.prototype.generate_random_char=function(){var e,t,i;return e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=Math.floor(Math.random()*e.length),t=e.substring(i,i+1)},e}(),t.AbstractChosen=e}.call(this),function(){var e,t,i,a,n={}.hasOwnProperty,s=function(e,t){function i(){this.constructor=e}for(var a in t)n.call(t,a)&&(e[a]=t[a]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};a=this,e=jQuery,e.fn.extend({chosen:function(i){var a,n,s;return s=navigator.userAgent.toLowerCase(),n=/(msie) ([\w.]+)/.exec(s)||[],a={name:n[1]||"",version:n[2]||"0"},"msie"===a.name&&("6.0"===a.version||"7.0"===a.version&&7===document.documentMode)?this:this.each(function(){var a;return a=e(this),a.hasClass("chzn-done")?void 0:a.data("chosen",new t(this,i))})}}),t=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return s(n,t),n.prototype.setup=function(){return this.form_field_jq=e(this.form_field),this.current_value=this.form_field_jq.val(),this.is_rtl=this.form_field_jq.hasClass("chzn-rtl")},n.prototype.finish_setup=function(){return this.form_field_jq.addClass("chzn-done")},n.prototype.set_up_html=function(){var t,a,n,s,r,o;return this.container_id=this.form_field.id.length?this.form_field.id.replace(/[^\w]/g,"_"):this.generate_field_id(),this.container_id+="_chzn",t=["chzn-container"],t.push("chzn-container-"+(this.is_multiple?"multi":"single")),this.inherit_select_classes&&this.form_field.className&&t.push(this.form_field.className),this.is_rtl&&t.push("chzn-rtl"),this.f_width=this.form_field_jq.outerWidth(),n={id:this.container_id,"class":t.join(" "),style:"width: "+this.f_width+"px;",title:this.form_field.title},a=e("<div />",n),this.is_multiple?a.html('<ul class="chzn-choices"><li class="search-field"><input type="text" value="'+this.default_text+'" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chzn-drop" style="left:-9000px;"><ul class="chzn-results"></ul></div>'):a.html('<a href="javascript:void(0)" class="chzn-single chzn-default" tabindex="-1"><span>'+this.default_text+'</span><div><b></b></div></a><div class="chzn-drop" style="left:-9000px;"><div class="chzn-search"><input type="text" autocomplete="off" /></div><ul class="chzn-results"></ul></div>'),this.form_field_jq.hide().after(a),this.container=a,this.dropdown=this.container.find("div.chzn-drop").first(),s=this.container.height(),r=this.f_width-i(this.dropdown),this.dropdown.css({width:r+"px",top:s+"px"}),this.search_field=this.container.find("input").first(),this.search_results=this.container.find("ul.chzn-results").first(),this.search_field_scale(),this.search_no_results=this.container.find("li.no-results").first(),this.is_multiple?(this.search_choices=this.container.find("ul.chzn-choices").first(),this.search_container=this.container.find("li.search-field").first()):(this.search_container=this.container.find("div.chzn-search").first(),this.selected_item=this.container.find(".chzn-single").first(),o=r-i(this.search_container)-i(this.search_field),this.search_field.css({width:o+"px"})),this.results_build(),this.set_tab_index(),this.form_field_jq.trigger("liszt:ready",{chosen:this})},n.prototype.register_observers=function(){var e=this;return this.container.mousedown(function(t){e.container_mousedown(t)}),this.container.mouseup(function(t){e.container_mouseup(t)}),this.container.mouseenter(function(t){e.mouse_enter(t)}),this.container.mouseleave(function(t){e.mouse_leave(t)}),this.search_results.mouseup(function(t){e.search_results_mouseup(t)}),this.search_results.mouseover(function(t){e.search_results_mouseover(t)}),this.search_results.mouseout(function(t){e.search_results_mouseout(t)}),this.form_field_jq.bind("liszt:updated",function(t){e.results_update_field(t)}),this.form_field_jq.bind("liszt:activate",function(t){e.activate_field(t)}),this.form_field_jq.bind("liszt:open",function(t){e.container_mousedown(t)}),this.search_field.blur(function(t){e.input_blur(t)}),this.search_field.keyup(function(t){e.keyup_checker(t)}),this.search_field.keydown(function(t){e.keydown_checker(t)}),this.search_field.focus(function(t){e.input_focus(t)}),this.is_multiple?this.search_choices.click(function(t){e.choices_click(t)}):this.container.click(function(e){e.preventDefault()})},n.prototype.search_field_disabled=function(){return this.is_disabled=this.form_field_jq[0].disabled,this.is_disabled?(this.container.addClass("chzn-disabled"),this.search_field[0].disabled=!0,this.is_multiple||this.selected_item.unbind("focus",this.activate_action),this.close_field()):(this.container.removeClass("chzn-disabled"),this.search_field[0].disabled=!1,this.is_multiple?void 0:this.selected_item.bind("focus",this.activate_action))},n.prototype.container_mousedown=function(t){var i;return this.is_disabled?void 0:(i=null!=t?e(t.target).hasClass("search-choice-close"):!1,t&&"mousedown"===t.type&&!this.results_showing&&t.preventDefault(),this.pending_destroy_click||i?this.pending_destroy_click=!1:(this.active_field?this.is_multiple||!t||e(t.target)[0]!==this.selected_item[0]&&!e(t.target).parents("a.chzn-single").length||(t.preventDefault(),this.results_toggle()):(this.is_multiple&&this.search_field.val(""),e(document).click(this.click_test_action),this.results_show()),this.activate_field()))},n.prototype.container_mouseup=function(e){return"ABBR"!==e.target.nodeName||this.is_disabled?void 0:this.results_reset(e)},n.prototype.blur_test=function(){return!this.active_field&&this.container.hasClass("chzn-container-active")?this.close_field():void 0},n.prototype.close_field=function(){return e(document).unbind("click",this.click_test_action),this.active_field=!1,this.results_hide(),this.container.removeClass("chzn-container-active"),this.winnow_results_clear(),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()},n.prototype.activate_field=function(){return this.container.addClass("chzn-container-active"),this.active_field=!0,this.search_field.val(this.search_field.val()),this.search_field.focus()},n.prototype.test_active_click=function(t){return e(t.target).parents("#"+this.container_id).length?this.active_field=!0:this.close_field()},n.prototype.results_build=function(){var e,t,i,n,s;for(this.parsing=!0,this.results_data=a.SelectParser.select_to_array(this.form_field),this.is_multiple&&this.choices>0?(this.search_choices.find("li.search-choice").remove(),this.choices=0):this.is_multiple||(this.selected_item.addClass("chzn-default").find("span").text(this.default_text),this.disable_search||this.form_field.options.length<=this.disable_search_threshold?this.container.addClass("chzn-container-single-nosearch"):this.container.removeClass("chzn-container-single-nosearch")),e="",s=this.results_data,i=0,n=s.length;n>i;i++)t=s[i],t.group?e+=this.result_add_group(t):t.empty||(e+=this.result_add_option(t),t.selected&&this.is_multiple?this.choice_build(t):t.selected&&!this.is_multiple&&(this.selected_item.removeClass("chzn-default").find("span").text(t.text),this.allow_single_deselect&&this.single_deselect_control_build()));return this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.search_results.html(e),this.parsing=!1},n.prototype.result_add_group=function(t){return t.disabled?"":(t.dom_id=this.container_id+"_g_"+t.array_index,'<li id="'+t.dom_id+'" class="group-result">'+e("<div />").text(t.label).html()+"</li>")},n.prototype.result_do_highlight=function(e){var t,i,a,n,s;if(e.length){if(this.result_clear_highlight(),this.result_highlight=e,this.result_highlight.addClass("highlighted"),a=parseInt(this.search_results.css("maxHeight"),10),s=this.search_results.scrollTop(),n=a+s,i=this.result_highlight.position().top+this.search_results.scrollTop(),t=i+this.result_highlight.outerHeight(),t>=n)return this.search_results.scrollTop(t-a>0?t-a:0);
if(s>i)return this.search_results.scrollTop(i)}},n.prototype.result_clear_highlight=function(){return this.result_highlight&&this.result_highlight.removeClass("highlighted"),this.result_highlight=null},n.prototype.results_show=function(){var e;if(this.is_multiple){if(this.max_selected_options<=this.choices)return this.form_field_jq.trigger("liszt:maxselected",{chosen:this}),!1}else this.selected_item.addClass("chzn-single-with-drop"),this.result_single_selected&&this.result_do_highlight(this.result_single_selected);return e=this.is_multiple?this.container.height():this.container.height()-1,this.form_field_jq.trigger("liszt:showing_dropdown",{chosen:this}),this.dropdown.css({top:e+"px",left:0}),this.results_showing=!0,this.search_field.focus(),this.search_field.val(this.search_field.val()),this.winnow_results()},n.prototype.results_hide=function(){return this.is_multiple||this.selected_item.removeClass("chzn-single-with-drop"),this.result_clear_highlight(),this.form_field_jq.trigger("liszt:hiding_dropdown",{chosen:this}),this.dropdown.css({left:"-9000px"}),this.results_showing=!1},n.prototype.set_tab_index=function(){var e;return this.form_field_jq.attr("tabindex")?(e=this.form_field_jq.attr("tabindex"),this.form_field_jq.attr("tabindex",-1),this.search_field.attr("tabindex",e)):void 0},n.prototype.show_search_field_default=function(){return this.is_multiple&&this.choices<1&&!this.active_field?(this.search_field.val(this.default_text),this.search_field.addClass("default")):(this.search_field.val(""),this.search_field.removeClass("default"))},n.prototype.search_results_mouseup=function(t){var i;return i=e(t.target).hasClass("active-result")?e(t.target):e(t.target).parents(".active-result").first(),i.length?(this.result_highlight=i,this.result_select(t),this.search_field.focus()):void 0},n.prototype.search_results_mouseover=function(t){var i;return i=e(t.target).hasClass("active-result")?e(t.target):e(t.target).parents(".active-result").first(),i?this.result_do_highlight(i):void 0},n.prototype.search_results_mouseout=function(t){return e(t.target).hasClass("active-result")?this.result_clear_highlight():void 0},n.prototype.choices_click=function(t){return t.preventDefault(),!this.active_field||e(t.target).hasClass("search-choice")||this.results_showing?void 0:this.results_show()},n.prototype.choice_build=function(t){var i,a,n,s=this;return this.is_multiple&&this.max_selected_options<=this.choices?(this.form_field_jq.trigger("liszt:maxselected",{chosen:this}),!1):(i=this.container_id+"_c_"+t.array_index,this.choices+=1,a=t.disabled?'<li class="search-choice search-choice-disabled" id="'+i+'"><span>'+t.html+"</span></li>":'<li class="search-choice" id="'+i+'"><span>'+t.html+'</span><a href="javascript:void(0)" class="search-choice-close" rel="'+t.array_index+'"></a></li>',this.search_container.before(a),n=e("#"+i).find("a").first(),n.click(function(e){return s.choice_destroy_link_click(e)}))},n.prototype.choice_destroy_link_click=function(t){return t.preventDefault(),this.is_disabled?t.stopPropagation:(this.pending_destroy_click=!0,this.choice_destroy(e(t.target)))},n.prototype.choice_destroy=function(e){return this.result_deselect(e.attr("rel"))?(this.choices-=1,this.show_search_field_default(),this.is_multiple&&this.choices>0&&this.search_field.val().length<1&&this.results_hide(),e.parents("li").first().remove(),this.search_field_scale()):void 0},n.prototype.results_reset=function(){return this.form_field.options[0].selected=!0,this.selected_item.find("span").text(this.default_text),this.is_multiple||this.selected_item.addClass("chzn-default"),this.show_search_field_default(),this.results_reset_cleanup(),this.form_field_jq.trigger("change"),this.active_field?this.results_hide():void 0},n.prototype.results_reset_cleanup=function(){return this.current_value=this.form_field_jq.val(),this.selected_item.find("abbr").remove()},n.prototype.result_select=function(e){var t,i,a,n;return this.result_highlight?(t=this.result_highlight,i=t.attr("id"),this.result_clear_highlight(),this.is_multiple?this.result_deactivate(t):(this.search_results.find(".result-selected").removeClass("result-selected"),this.result_single_selected=t,this.selected_item.removeClass("chzn-default")),t.addClass("result-selected"),n=i.substr(i.lastIndexOf("_")+1),a=this.results_data[n],a.selected=!0,this.form_field.options[a.options_index].selected=!0,this.is_multiple?this.choice_build(a):(this.selected_item.find("span").first().text(a.text),this.allow_single_deselect&&this.single_deselect_control_build()),(e.metaKey||e.ctrlKey)&&this.is_multiple||this.results_hide(),this.search_field.val(""),(this.is_multiple||this.form_field_jq.val()!==this.current_value)&&this.form_field_jq.trigger("change",{selected:this.form_field.options[a.options_index].value}),this.current_value=this.form_field_jq.val(),this.search_field_scale()):void 0},n.prototype.result_activate=function(e){return e.addClass("active-result")},n.prototype.result_deactivate=function(e){return e.removeClass("active-result")},n.prototype.result_deselect=function(t){var i,a;return a=this.results_data[t],this.form_field.options[a.options_index].disabled?!1:(a.selected=!1,this.form_field.options[a.options_index].selected=!1,i=e("#"+this.container_id+"_o_"+t),i.removeClass("result-selected").addClass("active-result").show(),this.result_clear_highlight(),this.winnow_results(),this.form_field_jq.trigger("change",{deselected:this.form_field.options[a.options_index].value}),this.search_field_scale(),!0)},n.prototype.single_deselect_control_build=function(){return this.allow_single_deselect&&this.selected_item.find("abbr").length<1?this.selected_item.find("span").first().after('<abbr class="search-choice-close"></abbr>'):void 0},n.prototype.winnow_results=function(){var t,i,a,n,s,r,o,l,u,c,h,d,p,f,m,g,y,v;for(this.no_results_clear(),u=0,c=this.search_field.val()===this.default_text?"":e("<div/>").text(e.trim(this.search_field.val())).html(),r=this.search_contains?"":"^",s=new RegExp(r+c.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),p=new RegExp(c.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),v=this.results_data,f=0,g=v.length;g>f;f++)if(i=v[f],!i.disabled&&!i.empty)if(i.group)e("#"+i.dom_id).css("display","none");else if(!this.is_multiple||!i.selected){if(t=!1,l=i.dom_id,o=e("#"+l),s.test(i.html))t=!0,u+=1;else if(this.enable_split_word_search&&(i.html.indexOf(" ")>=0||0===i.html.indexOf("["))&&(n=i.html.replace(/\[|\]/g,"").split(" "),n.length))for(m=0,y=n.length;y>m;m++)a=n[m],s.test(a)&&(t=!0,u+=1);t?(c.length?(h=i.html.search(p),d=i.html.substr(0,h+c.length)+"</em>"+i.html.substr(h+c.length),d=d.substr(0,h)+"<em>"+d.substr(h)):d=i.html,o.html(d),this.result_activate(o),null!=i.group_array_index&&e("#"+this.results_data[i.group_array_index].dom_id).css("display","list-item")):(this.result_highlight&&l===this.result_highlight.attr("id")&&this.result_clear_highlight(),this.result_deactivate(o))}return 1>u&&c.length?this.no_results(c):this.winnow_results_set_highlight()},n.prototype.winnow_results_clear=function(){var t,i,a,n,s;for(this.search_field.val(""),i=this.search_results.find("li"),s=[],a=0,n=i.length;n>a;a++)t=i[a],t=e(t),t.hasClass("group-result")?s.push(t.css("display","auto")):this.is_multiple&&t.hasClass("result-selected")?s.push(void 0):s.push(this.result_activate(t));return s},n.prototype.winnow_results_set_highlight=function(){var e,t;return this.result_highlight||(t=this.is_multiple?[]:this.search_results.find(".result-selected.active-result"),e=t.length?t.first():this.search_results.find(".active-result").first(),null==e)?void 0:this.result_do_highlight(e)},n.prototype.no_results=function(t){var i;return i=e('<li class="no-results">'+this.results_none_found+' "<span></span>"</li>'),i.find("span").first().html(t),this.search_results.append(i)},n.prototype.no_results_clear=function(){return this.search_results.find(".no-results").remove()},n.prototype.keydown_arrow=function(){var t,i;return this.result_highlight?this.results_showing&&(i=this.result_highlight.nextAll("li.active-result").first(),i&&this.result_do_highlight(i)):(t=this.search_results.find("li.active-result").first(),t&&this.result_do_highlight(e(t))),this.results_showing?void 0:this.results_show()},n.prototype.keyup_arrow=function(){var e;return this.results_showing||this.is_multiple?this.result_highlight?(e=this.result_highlight.prevAll("li.active-result"),e.length?this.result_do_highlight(e.first()):(this.choices>0&&this.results_hide(),this.result_clear_highlight())):void 0:this.results_show()},n.prototype.keydown_backstroke=function(){var e;return this.pending_backstroke?(this.choice_destroy(this.pending_backstroke.find("a").first()),this.clear_backstroke()):(e=this.search_container.siblings("li.search-choice").last(),e.length&&!e.hasClass("search-choice-disabled")?(this.pending_backstroke=e,this.single_backstroke_delete?this.keydown_backstroke():this.pending_backstroke.addClass("search-choice-focus")):void 0)},n.prototype.clear_backstroke=function(){return this.pending_backstroke&&this.pending_backstroke.removeClass("search-choice-focus"),this.pending_backstroke=null},n.prototype.keydown_checker=function(e){var t,i;switch(t=null!=(i=e.which)?i:e.keyCode,this.search_field_scale(),8!==t&&this.pending_backstroke&&this.clear_backstroke(),t){case 8:this.backstroke_length=this.search_field.val().length;break;case 9:this.results_showing&&!this.is_multiple&&this.result_select(e),this.mouse_on_container=!1;break;case 13:e.preventDefault();break;case 38:e.preventDefault(),this.keyup_arrow();break;case 40:this.keydown_arrow()}},n.prototype.search_field_scale=function(){var t,i,a,n,s,r,o,l,u;if(this.is_multiple){for(a=0,o=0,s="position:absolute; left: -1000px; top: -1000px; display:none;",r=["font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"],l=0,u=r.length;u>l;l++)n=r[l],s+=n+":"+this.search_field.css(n)+";";return i=e("<div />",{style:s}),i.text(this.search_field.val()),e("body").append(i),o=i.width()+25,i.remove(),o>this.f_width-10&&(o=this.f_width-10),this.search_field.css({width:o+"px"}),t=this.container.height(),this.dropdown.css({top:t+"px"})}},n.prototype.generate_random_id=function(){var t;for(t="sel"+this.generate_random_char()+this.generate_random_char()+this.generate_random_char();e("#"+t).length>0;)t+=this.generate_random_char();return t},n}(AbstractChosen),a.Chosen=t,i=function(e){var t;return t=e.outerWidth()-e.width()},a.get_side_border_padding=i}.call(this),function(){Oskari.clazz.define("Oskari.libraries.bundle.geostats.GeostatsBundle",function(){},{create:function(){return this},update:function(){},start:function(){},stop:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance"],source:{scripts:[{type:"text/javascript",src:"../../../../libraries/geostats/geostats-0.6.min.js"},{type:"text/javascript",src:"../../../../libraries/geostats/jenks.util.js"}]}}),Oskari.bundle_manager.installBundleClass("geostats","Oskari.libraries.bundle.geostats.GeostatsBundle")}();var _t=function(e){return e},inArray=function(e,t){for(var i=0;i<t.length;i++)if(t[i]==e)return!0;return!1},geostats=function(e){this.legendSeparator=this.separator=" - ",this.method="",this.roundlength=2,this.is_uniqueValues=!1,this.bounds=[],this.ranges=[],this.colors=[],this.counter=[],this.stat_cov=this.stat_stddev=this.stat_variance=this.stat_pop=this.stat_min=this.stat_max=this.stat_sum=this.stat_median=this.stat_mean=this.stat_sorted=null,this.serie="undefined"!=typeof e&&0<e.length?e:[],this.setSerie=function(e){this.serie=[],this.serie=e},this.setColors=function(e){this.colors=e},this.doCount=function(){if(!this._nodata()){var e=this.sorted();for(i=0;i<this.bounds.length;i++)this.counter[i]=0;for(j=0;j<e.length;j++){var t=this.getClass(e[j]);this.counter[t]++}}},this.setRanges=function(){for(this.ranges=[],i=0;i<this.bounds.length-1;i++)this.ranges[i]=this.bounds[i]+this.separator+this.bounds[i+1]},this.min=function(){if(!this._nodata()){if(null==this.stat_min)for(this.stat_min=this.serie[0],i=0;i<this.pop();i++)this.serie[i]<this.stat_min&&(this.stat_min=this.serie[i]);return this.stat_min}},this.max=function(){if(!this._nodata()){if(null==this.stat_max)for(this.stat_max=this.serie[0],i=0;i<this.pop();i++)this.serie[i]>this.stat_max&&(this.stat_max=this.serie[i]);return this.stat_max}},this.sum=function(){if(!this._nodata()){if(null==this.stat_sum)for(i=this.stat_sum=0;i<this.pop();i++)this.stat_sum+=this.serie[i];return this.stat_sum}},this.pop=function(){return this._nodata()?void 0:(null==this.stat_pop&&(this.stat_pop=this.serie.length),this.stat_pop)},this.mean=function(){return this._nodata()?void 0:(null==this.stat_mean&&(this.stat_mean=this.sum()/this.pop()),this.stat_mean)},this.median=function(){if(!this._nodata()){if(null==this.stat_median){this.stat_median=0;var e=this.sorted();this.stat_median=e.length%2?e[Math.ceil(e.length/2)-1]:(e[e.length/2-1]+e[e.length/2])/2}return this.stat_median}},this.variance=function(){if(round="undefined"==typeof round?!0:!1,!this._nodata()){if(null==this.stat_variance){for(var e=0,t=0;t<this.pop();t++)e+=Math.pow(this.serie[t]-this.mean(),2);this.stat_variance=e/this.pop(),1==round&&(this.stat_variance=Math.round(this.stat_variance*Math.pow(10,this.roundlength))/Math.pow(10,this.roundlength))}return this.stat_variance}},this.stddev=function(e){return e="undefined"==typeof e?!0:!1,this._nodata()?void 0:(null==this.stat_stddev&&(this.stat_stddev=Math.sqrt(this.variance()),1==e&&(this.stat_stddev=Math.round(this.stat_stddev*Math.pow(10,this.roundlength))/Math.pow(10,this.roundlength))),this.stat_stddev)},this.cov=function(e){return e="undefined"==typeof e?!0:!1,this._nodata()?void 0:(null==this.stat_cov&&(this.stat_cov=this.stddev()/this.mean(),1==e&&(this.stat_cov=Math.round(this.stat_cov*Math.pow(10,this.roundlength))/Math.pow(10,this.roundlength))),this.stat_cov)},this._nodata=function(){return 0==this.serie.length?(alert("Error. You should first enter a serie!"),1):0},this.sorted=function(){return null==this.stat_sorted&&(this.stat_sorted=0==this.is_uniqueValues?this.serie.sort(function(e,t){return e-t}):this.serie.sort(function(e,t){var i=e.toLowerCase(),a=t.toLowerCase();return a>i?-1:i>a?1:0})),this.stat_sorted},this.info=function(){if(!this._nodata()){var e;return e=""+(_t("Population")+" : "+this.pop()+" - ["+_t("Min")+" : "+this.min()+" | "+_t("Max")+" : "+this.max()+"]\n"),e+=_t("Mean")+" : "+this.mean()+" - "+_t("Median")+" : "+this.median()+"\n",e+=_t("Variance")+" : "+this.variance()+" - "+_t("Standard deviation")+" : "+this.stddev()+" - "+_t("Coefficient of variation")+" : "+this.cov()+"\n"}},this.getEqInterval=function(e){if(!this._nodata()){this.method=_t("eq. intervals")+" ("+e+" "+_t("classes")+")";var t=[],a=this.min(),n=(this.max()-this.min())/e;for(i=0;e>=i;i++)t[i]=a,a+=n;return this.bounds=t,this.setRanges(),t}},this.getQuantile=function(e){if(!this._nodata()){this.method=_t("quantile")+" ("+e+" "+_t("classes")+")";var t=[],i=this.sorted(),a=Math.round(this.pop()/e),n=a,s=0;for(t[0]=i[0],s=1;e>s;s++)t[s]=i[n],n+=a;return t.push(i[i.length-1]),this.bounds=t,this.setRanges(),t}},this.getJenks=function(e){if(!this._nodata()){this.method=_t("Jenks")+" ("+e+" "+_t("classes")+")",dataList=this.sorted();for(var t=[],i=0,a=dataList.length+1;a>i;i++){for(var n=[],s=0,r=e+1;r>s;s++)n.push(0);t.push(n)}for(i=[],a=0,n=dataList.length+1;n>a;a++){for(var s=[],r=0,o=e+1;o>r;r++)s.push(0);i.push(s)}for(a=1,n=e+1;n>a;a++){t[0][a]=1,i[0][a]=0;for(var l=1,s=dataList.length+1;s>l;l++)i[l][a]=1/0;l=0}for(a=2,n=dataList.length+1;n>a;a++){for(var o=r=s=0,u=1,c=a+1;c>u;u++){var h=a-u+1,l=parseFloat(dataList[h-1]),r=r+l*l,s=s+l,o=o+1,l=r-s*s/o,d=h-1;if(0!=d)for(var p=2,f=e+1;f>p;p++)i[a][p]>=l+i[d][p-1]&&(t[a][p]=h,i[a][p]=l+i[d][p-1])}t[a][1]=1,i[a][1]=l}for(l=dataList.length,i=[],a=0,n=e+1;n>a;a++)i.push(0);for(i[e]=parseFloat(dataList[dataList.length-1]),i[0]=parseFloat(dataList[0]);e>=2;)a=parseInt(t[l][e]-2),i[e-1]=dataList[a],l=parseInt(t[l][e]-1),e-=1;return i[0]==i[1]&&(i[0]=0),this.bounds=i,this.setRanges(),i}},this.getUniqueValues=function(){if(!this._nodata()){this.method=_t("unique values"),this.is_uniqueValues=!0;var e=this.sorted(),t=[];for(i=0;i<this.pop();i++)inArray(e[i],t)||t.push(e[i]);return this.bounds=t}},this.getClass=function(e){for(i=0;i<this.bounds.length;i++)if(1==this.is_uniqueValues){if(e==this.bounds[i])return i}else if(e<=this.bounds[i+1])return i;return _t("Unable to get value's class.")},this.getRanges=function(){return this.ranges},this.getRangeNum=function(e){var t,i;for(i=0;i<this.ranges.length;i++)if(t=this.ranges[i].split(/ - /),e<=parseFloat(t[1]))return i},this.getHtmlLegend=function(e,t,a,n){var s="";if(ccolors=null!=e?e:this.colors,lg=null!=t?t:"Legend",null!=a?(this.doCount(),getcounter=!0):getcounter=!1,fn=null!=n?n:function(e){return e},!(ccolors.length<this.ranges.length)){if(e='<div class="geostats-legend"><div class="geostats-legend-title">'+_t(lg)+"</div>",0==this.is_uniqueValues)for(i=0;i<this.ranges.length;i++)!0===getcounter&&(s=' <span class="geostats-legend-counter">('+this.counter[i]+")</span>"),-1!=this.ranges[i].indexOf(this.separator)?(t=this.ranges[i].split(this.separator),t=fn(t[0])+this.legendSeparator+fn(t[1])):t=fn(this.ranges[i]),e+='<div><div class="geostats-legend-block" style="background-color:'+ccolors[i]+'"></div> '+t+s+"</div>";else for(i=0;i<this.bounds.length;i++)!0===getcounter&&(s=' <span class="geostats-legend-counter">('+this.counter[i]+")</span>"),t=fn(this.bounds[i]),e+='<div><div class="geostats-legend-block" style="background-color:'+ccolors[i]+'"></div> '+t+s+"</div>";return e+"</div>"}alert(_t("The number of colors should fit the number of ranges. Exit!"))},this.getSortedlist=function(){return this.sorted().join(", ")}};

