function phi4z(e,t,i,n,s,a,r,o,l){var u,c,h,d,p,f,m,g,y;for(l=a,y=1;15>=y;y++)if(u=Math.sin(l),tanphi=Math.tan(l),o=tanphi*Math.sqrt(1-e*u*u),c=Math.sin(2*l),h=t*l-i*c+n*Math.sin(4*l)-s*Math.sin(6*l),d=t-2*i*Math.cos(2*l)+4*n*Math.cos(4*l)-6*s*Math.cos(6*l),p=2*h+o*(h*h+r)-2*a*(o*h+1),f=e*c*(h*h+r-2*a*h)/(2*o),m=2*(a-h)*(o*d-2/c)-2*d,g=p/(f+m),l+=g,Math.abs(g)<=1e-10)return l;return Proj4js.reportError("phi4z: No convergence"),null}function e4fn(e){var t,i;return t=1+e,i=1-e,Math.sqrt(Math.pow(t,t)*Math.pow(i,i))}function min(e){var t=e[0];for(i=1;i<e.length;i++)e[i]<t&&(t=e[i]);return t}function mean(e){for(var t=0,i=0;i<e.length;i++)t+=e[i];return t/e.length}function array_search(e,t,i){var n=!!i,s="";for(s in t)if(n&&t[s]===e||!n&&t[s]==e)return s;return!1}function determineClass(e,t,n){var s,a=0,r=n[0]-1;for(i=0;t>i;i++)e>=a&&r>=e&&(s=i),a+=n[i],r=a+n[i+1]-1;return s}function extractBounds(e,t){var i=e.length,n=t.length;e.sort(function(e,t){return e-t});var s=[],a=0;for(indClass=0;n>indClass;indClass++)s[indClass]=e[a],a+=t[indClass];return s[n]=e[i-1],s}Oskari.clazz.define("Oskari.mapframework.openlayers.theme.default.Bundle",function(){},{create:function(){return this},update:function(){},start:function(){var e=this.mediator.manager.stateForBundleDefinitions["openlayers-default-theme"].bundlePath;OpenLayers.ImgPath=e+"/img/"},stop:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance"],source:{scripts:[{type:"text/css",src:"../../../../resources/openlayers/theme/default/style.css"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"openlayers-default-theme","Bundle-Name":"mapframework.openlayers-default-theme.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:[{Part:"OpenLayers","License-Name":"BSD","License-Online-Resource":"http://svn.openlayers.org/trunk/openlayers/license.txt"},{Part:"Proj4JS","License-Name":"LGPL/BSD","License-Online-Resource":""}]}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.core.Bundle",Title:" mapframework.core.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("openlayers-default-theme","Oskari.mapframework.openlayers.theme.default.Bundle"),function(){Oskari.clazz.define("Oskari.openlayers.bundle.openlayers-full-map.OpenLayersBundle",function(){},{create:function(){return this},update:function(){},start:function(){},stop:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance"],source:{scripts:[{type:"text/javascript",src:"../../../../libraries/proj4js-1.0.1/proj4js-compressed.js"},{type:"text/javascript",src:"../../../../libraries/OpenLayers/OpenLayers.full-map.js"}]},bundle:{manifest:{"Bundle-Identifier":"openlayers-map-full","Bundle-Name":"mapframework.openlayers.mapfull.Bundle","Bundle-Author":[{Name:"ah",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:[{Part:"OpenLayers","License-Name":"BSD","License-Online-Resource":"http://svn.openlayers.org/trunk/openlayers/license.txt"},{Part:"Proj4JS","License-Name":"LGPL/BSD","License-Online-Resource":""}]}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("openlayers-full-map","Oskari.openlayers.bundle.openlayers-full-map.OpenLayersBundle")}(),Proj4js={defaultDatum:"WGS84",transform:function(e,t,i){if(!e.readyToUse||!t.readyToUse)return this.reportError("Proj4js initialization for "+e.srsCode+" not yet complete"),i;if("900913"==e.srsProjNumber&&"WGS84"!=t.datumCode||"900913"==t.srsProjNumber&&"WGS84"!=e.datumCode){var n=Proj4js.WGS84;this.transform(e,n,i),e=n}return"longlat"==e.projName?(i.x*=Proj4js.common.D2R,i.y*=Proj4js.common.D2R):(e.to_meter&&(i.x*=e.to_meter,i.y*=e.to_meter),e.inverse(i)),e.from_greenwich&&(i.x+=e.from_greenwich),i=this.datum_transform(e.datum,t.datum,i),t.from_greenwich&&(i.x-=t.from_greenwich),"longlat"==t.projName?(i.x*=Proj4js.common.R2D,i.y*=Proj4js.common.R2D):(t.forward(i),t.to_meter&&(i.x/=t.to_meter,i.y/=t.to_meter)),i},datum_transform:function(e,t,i){return e.compare_datums(t)?i:e.datum_type==Proj4js.common.PJD_NODATUM||t.datum_type==Proj4js.common.PJD_NODATUM?i:(e.datum_type==Proj4js.common.PJD_GRIDSHIFT&&alert("ERROR: Grid shift transformations are not implemented yet."),t.datum_type==Proj4js.common.PJD_GRIDSHIFT&&alert("ERROR: Grid shift transformations are not implemented yet."),(e.es!=t.es||e.a!=t.a||e.datum_type==Proj4js.common.PJD_3PARAM||e.datum_type==Proj4js.common.PJD_7PARAM||t.datum_type==Proj4js.common.PJD_3PARAM||t.datum_type==Proj4js.common.PJD_7PARAM)&&(e.geodetic_to_geocentric(i),(e.datum_type==Proj4js.common.PJD_3PARAM||e.datum_type==Proj4js.common.PJD_7PARAM)&&e.geocentric_to_wgs84(i),(t.datum_type==Proj4js.common.PJD_3PARAM||t.datum_type==Proj4js.common.PJD_7PARAM)&&t.geocentric_from_wgs84(i),t.geocentric_to_geodetic(i)),t.datum_type==Proj4js.common.PJD_GRIDSHIFT&&alert("ERROR: Grid shift transformations are not implemented yet."),i)},reportError:function(){},extend:function(e,t){if(e=e||{},t)for(var i in t){var n=t[i];void 0!==n&&(e[i]=n)}return e},Class:function(){for(var e,t=function(){this.initialize.apply(this,arguments)},i={},n=0;n<arguments.length;++n)e="function"==typeof arguments[n]?arguments[n].prototype:arguments[n],Proj4js.extend(i,e);return t.prototype=i,t},bind:function(e,t){var i=Array.prototype.slice.apply(arguments,[2]);return function(){var n=i.concat(Array.prototype.slice.apply(arguments,[0]));return e.apply(t,n)}},scriptName:"proj4js-compressed.js",defsLookupService:"http://spatialreference.org/ref",libPath:null,getScriptLocation:function(){if(this.libPath)return this.libPath;for(var e=this.scriptName,t=e.length,i=document.getElementsByTagName("script"),n=0;n<i.length;n++){var s=i[n].getAttribute("src");if(s){var a=s.lastIndexOf(e);if(a>-1&&a+t==s.length){this.libPath=s.slice(0,-t);break}}}return this.libPath||""},loadScript:function(e,t,i,n){var s=document.createElement("script");s.defer=!1,s.type="text/javascript",s.id=e,s.src=e,s.onload=t,s.onerror=i,s.loadCheck=n,/MSIE/.test(navigator.userAgent)&&(s.onreadystatechange=this.checkReadyState),document.getElementsByTagName("head")[0].appendChild(s)},checkReadyState:function(){"loaded"==this.readyState&&(this.loadCheck()?this.onload():this.onerror())}},Proj4js.Proj=Proj4js.Class({readyToUse:!1,title:null,projName:null,units:null,datum:null,x0:0,y0:0,initialize:function(e){if(this.srsCodeInput=e,0==e.indexOf("urn:")){var t=e.split(":");"ogc"!=t[1]&&"x-ogc"!=t[1]||"def"!=t[2]||"crs"!=t[3]||(e=t[4]+":"+t[t.length-1])}else if(0==e.indexOf("http://")){var i=e.split("#");i[0].match(/epsg.org/)?e="EPSG:"+i[1]:i[0].match(/RIG.xml/)&&(e="IGNF:"+i[1])}this.srsCode=e.toUpperCase(),0==this.srsCode.indexOf("EPSG")?(this.srsCode=this.srsCode,this.srsAuth="epsg",this.srsProjNumber=this.srsCode.substring(5)):0==this.srsCode.indexOf("IGNF")?(this.srsCode=this.srsCode,this.srsAuth="IGNF",this.srsProjNumber=this.srsCode.substring(5)):0==this.srsCode.indexOf("CRS")?(this.srsCode=this.srsCode,this.srsAuth="CRS",this.srsProjNumber=this.srsCode.substring(4)):(this.srsAuth="",this.srsProjNumber=this.srsCode),this.loadProjDefinition()},loadProjDefinition:function(){if(Proj4js.defs[this.srsCode])return this.defsLoaded(),void 0;var e=Proj4js.getScriptLocation()+"defs/"+this.srsAuth.toUpperCase()+this.srsProjNumber+".js";Proj4js.loadScript(e,Proj4js.bind(this.defsLoaded,this),Proj4js.bind(this.loadFromService,this),Proj4js.bind(this.checkDefsLoaded,this))},loadFromService:function(){var e=Proj4js.defsLookupService+"/"+this.srsAuth+"/"+this.srsProjNumber+"/proj4js/";Proj4js.loadScript(e,Proj4js.bind(this.defsLoaded,this),Proj4js.bind(this.defsFailed,this),Proj4js.bind(this.checkDefsLoaded,this))},defsLoaded:function(){this.parseDefs(),this.loadProjCode(this.projName)},checkDefsLoaded:function(){return Proj4js.defs[this.srsCode]?!0:!1},defsFailed:function(){Proj4js.reportError("failed to load projection definition for: "+this.srsCode),Proj4js.defs[this.srsCode]=Proj4js.defs.WGS84,this.defsLoaded()},loadProjCode:function(e){if(Proj4js.Proj[e])return this.initTransforms(),void 0;var t=Proj4js.getScriptLocation()+"projCode/"+e+".js";Proj4js.loadScript(t,Proj4js.bind(this.loadProjCodeSuccess,this,e),Proj4js.bind(this.loadProjCodeFailure,this,e),Proj4js.bind(this.checkCodeLoaded,this,e))},loadProjCodeSuccess:function(e){Proj4js.Proj[e].dependsOn?this.loadProjCode(Proj4js.Proj[e].dependsOn):this.initTransforms()},loadProjCodeFailure:function(e){Proj4js.reportError("failed to find projection file for: "+e)},checkCodeLoaded:function(e){return Proj4js.Proj[e]?!0:!1},initTransforms:function(){Proj4js.extend(this,Proj4js.Proj[this.projName]),this.init(),this.readyToUse=!0},parseDefs:function(){this.defData=Proj4js.defs[this.srsCode];var e,t;if(this.defData){for(var i=this.defData.split("+"),n=0;n<i.length;n++){var s=i[n].split("=");switch(e=s[0].toLowerCase(),t=s[1],e.replace(/\s/gi,"")){case"":break;case"title":this.title=t;break;case"proj":this.projName=t.replace(/\s/gi,"");break;case"units":this.units=t.replace(/\s/gi,"");break;case"datum":this.datumCode=t.replace(/\s/gi,"");break;case"nadgrids":this.nagrids=t.replace(/\s/gi,"");break;case"ellps":this.ellps=t.replace(/\s/gi,"");break;case"a":this.a=parseFloat(t);break;case"b":this.b=parseFloat(t);break;case"rf":this.rf=parseFloat(t);break;case"lat_0":this.lat0=t*Proj4js.common.D2R;break;case"lat_1":this.lat1=t*Proj4js.common.D2R;break;case"lat_2":this.lat2=t*Proj4js.common.D2R;break;case"lat_ts":this.lat_ts=t*Proj4js.common.D2R;break;case"lon_0":this.long0=t*Proj4js.common.D2R;break;case"alpha":this.alpha=parseFloat(t)*Proj4js.common.D2R;break;case"lonc":this.longc=t*Proj4js.common.D2R;break;case"x_0":this.x0=parseFloat(t);break;case"y_0":this.y0=parseFloat(t);break;case"k_0":this.k0=parseFloat(t);break;case"k":this.k0=parseFloat(t);break;case"r_a":this.R_A=!0;break;case"zone":this.zone=parseInt(t);break;case"south":this.utmSouth=!0;break;case"towgs84":this.datum_params=t.split(",");break;case"to_meter":this.to_meter=parseFloat(t);break;case"from_greenwich":this.from_greenwich=t*Proj4js.common.D2R;break;case"pm":t=t.replace(/\s/gi,""),this.from_greenwich=Proj4js.PrimeMeridian[t]?Proj4js.PrimeMeridian[t]:parseFloat(t),this.from_greenwich*=Proj4js.common.D2R;break;case"no_defs":}}this.deriveConstants()}},deriveConstants:function(){if("@null"==this.nagrids&&(this.datumCode="none"),this.datumCode&&"none"!=this.datumCode){var e=Proj4js.Datum[this.datumCode];e&&(this.datum_params=e.towgs84?e.towgs84.split(","):null,this.ellps=e.ellipse,this.datumName=e.datumName?e.datumName:this.datumCode)}if(!this.a){var t=Proj4js.Ellipsoid[this.ellps]?Proj4js.Ellipsoid[this.ellps]:Proj4js.Ellipsoid.WGS84;Proj4js.extend(this,t)}this.rf&&!this.b&&(this.b=(1-1/this.rf)*this.a),Math.abs(this.a-this.b)<Proj4js.common.EPSLN&&(this.sphere=!0,this.b=this.a),this.a2=this.a*this.a,this.b2=this.b*this.b,this.es=(this.a2-this.b2)/this.a2,this.e=Math.sqrt(this.es),this.R_A&&(this.a*=1-this.es*(Proj4js.common.SIXTH+this.es*(Proj4js.common.RA4+this.es*Proj4js.common.RA6)),this.a2=this.a*this.a,this.b2=this.b*this.b,this.es=0),this.ep2=(this.a2-this.b2)/this.b2,this.k0||(this.k0=1),this.datum=new Proj4js.datum(this)}}),Proj4js.Proj.longlat={init:function(){},forward:function(e){return e},inverse:function(e){return e}},Proj4js.defs={WGS84:"+title=long/lat:WGS84 +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees","EPSG:4326":"+title=long/lat:WGS84 +proj=longlat +a=6378137.0 +b=6356752.31424518 +ellps=WGS84 +datum=WGS84 +units=degrees","EPSG:4269":"+title=long/lat:NAD83 +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees","EPSG:3785":"+title= Google Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"},Proj4js.defs.GOOGLE=Proj4js.defs["EPSG:3785"],Proj4js.defs["EPSG:900913"]=Proj4js.defs["EPSG:3785"],Proj4js.defs["EPSG:102113"]=Proj4js.defs["EPSG:3785"],Proj4js.common={PI:3.141592653589793,HALF_PI:1.5707963267948966,TWO_PI:6.283185307179586,FORTPI:.7853981633974483,R2D:57.29577951308232,D2R:.017453292519943295,SEC_TO_RAD:484813681109536e-20,EPSLN:1e-10,MAX_ITER:20,COS_67P5:.3826834323650898,AD_C:1.0026,PJD_UNKNOWN:0,PJD_3PARAM:1,PJD_7PARAM:2,PJD_GRIDSHIFT:3,PJD_WGS84:4,PJD_NODATUM:5,SRS_WGS84_SEMIMAJOR:6378137,SIXTH:.16666666666666666,RA4:.04722222222222222,RA6:.022156084656084655,RV4:.06944444444444445,RV6:.04243827160493827,msfnz:function(e,t,i){var n=e*t;return i/Math.sqrt(1-n*n)},tsfnz:function(e,t,i){var n=e*i,s=.5*e;return n=Math.pow((1-n)/(1+n),s),Math.tan(.5*(this.HALF_PI-t))/n},phi2z:function(e,t){var n,s,a=.5*e,r=this.HALF_PI-2*Math.atan(t);for(i=0;15>=i;i++)if(n=e*Math.sin(r),s=this.HALF_PI-2*Math.atan(t*Math.pow((1-n)/(1+n),a))-r,r+=s,Math.abs(s)<=1e-10)return r;return alert("phi2z has NoConvergence"),-9999},qsfnz:function(e,t){var i;return e>1e-7?(i=e*t,(1-e*e)*(t/(1-i*i)-.5/e*Math.log((1-i)/(1+i)))):2*t},asinz:function(e){return Math.abs(e)>1&&(e=e>1?1:-1),Math.asin(e)},e0fn:function(e){return 1-.25*e*(1+e/16*(3+1.25*e))},e1fn:function(e){return.375*e*(1+.25*e*(1+.46875*e))},e2fn:function(e){return.05859375*e*e*(1+.75*e)},e3fn:function(e){return e*e*e*(35/3072)},mlfn:function(e,t,i,n,s){return e*s-t*Math.sin(2*s)+i*Math.sin(4*s)-n*Math.sin(6*s)},srat:function(e,t){return Math.pow((1-e)/(1+e),t)},sign:function(e){return 0>e?-1:1},adjust_lon:function(e){return e=Math.abs(e)<this.PI?e:e-this.sign(e)*this.TWO_PI},adjust_lat:function(e){return e=Math.abs(e)<this.HALF_PI?e:e-this.sign(e)*this.PI},latiso:function(e,t,i){if(Math.abs(t)>this.HALF_PI)return+Number.NaN;if(t==this.HALF_PI)return Number.POSITIVE_INFINITY;if(t==-1*this.HALF_PI)return-1*Number.POSITIVE_INFINITY;var n=e*i;return Math.log(Math.tan((this.HALF_PI+t)/2))+e*Math.log((1-n)/(1+n))/2},fL:function(e,t){return 2*Math.atan(e*Math.exp(t))-this.HALF_PI},invlatiso:function(e,t){var i=this.fL(1,t),n=0,s=0;do n=i,s=e*Math.sin(n),i=this.fL(Math.exp(e*Math.log((1+s)/(1-s))/2),t);while(Math.abs(i-n)>1e-12);return i},sinh:function(e){var t=Math.exp(e);return t=(t-1/t)/2},cosh:function(e){var t=Math.exp(e);return t=(t+1/t)/2},tanh:function(e){var t=Math.exp(e);return t=(t-1/t)/(t+1/t)},asinh:function(e){var t=e>=0?1:-1;return t*Math.log(Math.abs(e)+Math.sqrt(e*e+1))},acosh:function(e){return 2*Math.log(Math.sqrt((e+1)/2)+Math.sqrt((e-1)/2))},atanh:function(e){return Math.log((e-1)/(e+1))/2},gN:function(e,t,i){var n=t*i;return e/Math.sqrt(1-n*n)}},Proj4js.datum=Proj4js.Class({initialize:function(e){if(this.datum_type=Proj4js.common.PJD_WGS84,e.datumCode&&"none"==e.datumCode&&(this.datum_type=Proj4js.common.PJD_NODATUM),e&&e.datum_params){for(var t=0;t<e.datum_params.length;t++)e.datum_params[t]=parseFloat(e.datum_params[t]);(0!=e.datum_params[0]||0!=e.datum_params[1]||0!=e.datum_params[2])&&(this.datum_type=Proj4js.common.PJD_3PARAM),e.datum_params.length>3&&(0!=e.datum_params[3]||0!=e.datum_params[4]||0!=e.datum_params[5]||0!=e.datum_params[6])&&(this.datum_type=Proj4js.common.PJD_7PARAM,e.datum_params[3]*=Proj4js.common.SEC_TO_RAD,e.datum_params[4]*=Proj4js.common.SEC_TO_RAD,e.datum_params[5]*=Proj4js.common.SEC_TO_RAD,e.datum_params[6]=e.datum_params[6]/1e6+1)}e&&(this.a=e.a,this.b=e.b,this.es=e.es,this.ep2=e.ep2,this.datum_params=e.datum_params)},compare_datums:function(e){return this.datum_type!=e.datum_type?!1:this.a!=e.a||Math.abs(this.es-e.es)>5e-11?!1:this.datum_type==Proj4js.common.PJD_3PARAM?this.datum_params[0]==e.datum_params[0]&&this.datum_params[1]==e.datum_params[1]&&this.datum_params[2]==e.datum_params[2]:this.datum_type==Proj4js.common.PJD_7PARAM?this.datum_params[0]==e.datum_params[0]&&this.datum_params[1]==e.datum_params[1]&&this.datum_params[2]==e.datum_params[2]&&this.datum_params[3]==e.datum_params[3]&&this.datum_params[4]==e.datum_params[4]&&this.datum_params[5]==e.datum_params[5]&&this.datum_params[6]==e.datum_params[6]:this.datum_type==Proj4js.common.PJD_GRIDSHIFT?0==strcmp(pj_param(this.params,"snadgrids").s,pj_param(e.params,"snadgrids").s):!0},geodetic_to_geocentric:function(e){var t,i,n,s,a,r,o,l=e.x,u=e.y,c=e.z?e.z:0,h=0;if(u<-Proj4js.common.HALF_PI&&u>-1.001*Proj4js.common.HALF_PI)u=-Proj4js.common.HALF_PI;else if(u>Proj4js.common.HALF_PI&&u<1.001*Proj4js.common.HALF_PI)u=Proj4js.common.HALF_PI;else if(u<-Proj4js.common.HALF_PI||u>Proj4js.common.HALF_PI)return Proj4js.reportError("geocent:lat out of range:"+u),null;return l>Proj4js.common.PI&&(l-=2*Proj4js.common.PI),a=Math.sin(u),o=Math.cos(u),r=a*a,s=this.a/Math.sqrt(1-this.es*r),t=(s+c)*o*Math.cos(l),i=(s+c)*o*Math.sin(l),n=(s*(1-this.es)+c)*a,e.x=t,e.y=i,e.z=n,h},geocentric_to_geodetic:function(e){var t,i,n,s,a,r,o,l,u,c,h,d,p,f,m,g,y,v=1e-12,b=v*v,_=30,w=e.x,L=e.y,k=e.z?e.z:0;if(p=!1,t=Math.sqrt(w*w+L*L),i=Math.sqrt(w*w+L*L+k*k),t/this.a<v){if(p=!0,m=0,i/this.a<v)return g=Proj4js.common.HALF_PI,y=-this.b,void 0}else m=Math.atan2(L,w);n=k/i,s=t/i,a=1/Math.sqrt(1-this.es*(2-this.es)*s*s),l=s*(1-this.es)*a,u=n*a,f=0;do f++,o=this.a/Math.sqrt(1-this.es*u*u),y=t*l+k*u-o*(1-this.es*u*u),r=this.es*o/(o+y),a=1/Math.sqrt(1-r*(2-r)*s*s),c=s*(1-r)*a,h=n*a,d=h*l-c*u,l=c,u=h;while(d*d>b&&_>f);return g=Math.atan(h/Math.abs(c)),e.x=m,e.y=g,e.z=y,e},geocentric_to_geodetic_noniter:function(e){var t,i,n,s,a,r,o,l,u,c,h,d,p,f,m,g,y,v=e.x,b=e.y,_=e.z?e.z:0;if(v=parseFloat(v),b=parseFloat(b),_=parseFloat(_),y=!1,0!=v)t=Math.atan2(b,v);else if(b>0)t=Proj4js.common.HALF_PI;else if(0>b)t=-Proj4js.common.HALF_PI;else if(y=!0,t=0,_>0)i=Proj4js.common.HALF_PI;else{if(!(0>_))return i=Proj4js.common.HALF_PI,n=-this.b,void 0;i=-Proj4js.common.HALF_PI}return a=v*v+b*b,s=Math.sqrt(a),r=_*Proj4js.common.AD_C,l=Math.sqrt(r*r+a),c=r/l,d=s/l,h=c*c*c,o=_+this.b*this.ep2*h,g=s-this.a*this.es*d*d*d,u=Math.sqrt(o*o+g*g),p=o/u,f=g/u,m=this.a/Math.sqrt(1-this.es*p*p),n=f>=Proj4js.common.COS_67P5?s/f-m:f<=-Proj4js.common.COS_67P5?s/-f-m:_/p+m*(this.es-1),0==y&&(i=Math.atan(p/f)),e.x=t,e.y=i,e.z=n,e},geocentric_to_wgs84:function(e){if(this.datum_type==Proj4js.common.PJD_3PARAM)e.x+=this.datum_params[0],e.y+=this.datum_params[1],e.z+=this.datum_params[2];else if(this.datum_type==Proj4js.common.PJD_7PARAM){var t=this.datum_params[0],i=this.datum_params[1],n=this.datum_params[2],s=this.datum_params[3],a=this.datum_params[4],r=this.datum_params[5],o=this.datum_params[6],l=o*(e.x-r*e.y+a*e.z)+t,u=o*(r*e.x+e.y-s*e.z)+i,c=o*(-a*e.x+s*e.y+e.z)+n;e.x=l,e.y=u,e.z=c}},geocentric_from_wgs84:function(e){if(this.datum_type==Proj4js.common.PJD_3PARAM)e.x-=this.datum_params[0],e.y-=this.datum_params[1],e.z-=this.datum_params[2];else if(this.datum_type==Proj4js.common.PJD_7PARAM){var t=this.datum_params[0],i=this.datum_params[1],n=this.datum_params[2],s=this.datum_params[3],a=this.datum_params[4],r=this.datum_params[5],o=this.datum_params[6],l=(e.x-t)/o,u=(e.y-i)/o,c=(e.z-n)/o;e.x=l+r*u-a*c,e.y=-r*l+u+s*c,e.z=a*l-s*u+c}}}),Proj4js.Point=Proj4js.Class({initialize:function(e,t,i){if("object"==typeof e)this.x=e[0],this.y=e[1],this.z=e[2]||0;else if("string"==typeof e){var n=e.split(",");this.x=parseFloat(n[0]),this.y=parseFloat(n[1]),this.z=parseFloat(n[2])||0}else this.x=e,this.y=t,this.z=i||0},clone:function(){return new Proj4js.Point(this.x,this.y,this.z)},toString:function(){return"x="+this.x+",y="+this.y},toShortString:function(){return this.x+", "+this.y}}),Proj4js.PrimeMeridian={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},Proj4js.Ellipsoid={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},"APL4.":{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS72:{a:6378135,rf:298.26,ellipseName:"WGS 72"},WGS84:{a:6378137,rf:298.257223563,ellipseName:"WGS 84"},sphere:{a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"}},Proj4js.Datum={WGS84:{towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},GGRS87:{towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},NAD83:{towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},NAD27:{nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},potsdam:{towgs84:"606.0,23.0,413.0",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},carthage:{towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},hermannskogel:{towgs84:"653.0,-212.0,449.0",ellipse:"bessel",datumName:"Hermannskogel"},ire65:{towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},nzgd49:{towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},OSGB36:{towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"}},Proj4js.WGS84=new Proj4js.Proj("WGS84"),Proj4js.Datum.OSB36=Proj4js.Datum.OSGB36,Proj4js.Proj.aea={init:function(){return Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN?(Proj4js.reportError("aeaInitEqualLatitudes"),void 0):(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=Proj4js.common.msfnz(this.e3,this.sin_po,this.cos_po),this.qs1=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=Proj4js.common.msfnz(this.e3,this.sin_po,this.cos_po),this.qs2=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.ns0=Math.abs(this.lat1-this.lat2)>Proj4js.common.EPSLN?(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0,void 0)},forward:function(e){var t=e.x,i=e.y;this.sin_phi=Math.sin(i),this.cos_phi=Math.cos(i);var n=Proj4js.common.qsfnz(this.e3,this.sin_phi,this.cos_phi),s=this.a*Math.sqrt(this.c-this.ns0*n)/this.ns0,a=this.ns0*Proj4js.common.adjust_lon(t-this.long0),r=s*Math.sin(a)+this.x0,o=this.rh-s*Math.cos(a)+this.y0;return e.x=r,e.y=o,e},inverse:function(e){var t,i,n,s,a,r;return e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns0>=0?(t=Math.sqrt(e.x*e.x+e.y*e.y),n=1):(t=-Math.sqrt(e.x*e.x+e.y*e.y),n=-1),s=0,0!=t&&(s=Math.atan2(n*e.x,n*e.y)),n=t*this.ns0/this.a,i=(this.c-n*n)/this.ns0,this.e3>=1e-10?(n=1-.5*(1-this.es)*Math.log((1-this.e3)/(1+this.e3))/this.e3,r=Math.abs(Math.abs(n)-Math.abs(i))>1e-10?this.phi1z(this.e3,i):i>=0?.5*PI:-.5*PI):r=this.phi1z(e3,i),a=Proj4js.common.adjust_lon(s/this.ns0+this.long0),e.x=a,e.y=r,e},phi1z:function(e,t){var i,n,s,a=Proj4js.common.asinz(.5*t);if(e<Proj4js.common.EPSLN)return a;for(var r=e*e,o=1;25>=o;o++)if(sinphi=Math.sin(a),cosphi=Math.cos(a),i=e*sinphi,n=1-i*i,s=.5*n*n/cosphi*(t/(1-r)-sinphi/n+.5/e*Math.log((1-i)/(1+i))),a+=s,Math.abs(s)<=1e-7)return a;return Proj4js.reportError("aea:phi1z:Convergence error"),null}},Proj4js.Proj.sterea={dependsOn:"gauss",init:function(){return Proj4js.Proj.gauss.init.apply(this),this.rc?(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"),void 0):(Proj4js.reportError("sterea:init:E_ERROR_0"),void 0)},forward:function(e){return e.x=Proj4js.common.adjust_lon(e.x-this.long0),Proj4js.Proj.gauss.forward.apply(this,[e]),sinc=Math.sin(e.y),cosc=Math.cos(e.y),cosl=Math.cos(e.x),k=this.k0*this.R2/(1+this.sinc0*sinc+this.cosc0*cosc*cosl),e.x=k*cosc*Math.sin(e.x),e.y=k*(this.cosc0*sinc-this.sinc0*cosc*cosl),e.x=this.a*e.x+this.x0,e.y=this.a*e.y+this.y0,e},inverse:function(e){var t,i;return e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,(rho=Math.sqrt(e.x*e.x+e.y*e.y))?(c=2*Math.atan2(rho,this.R2),sinc=Math.sin(c),cosc=Math.cos(c),i=Math.asin(cosc*this.sinc0+e.y*sinc*this.cosc0/rho),t=Math.atan2(e.x*sinc,rho*this.cosc0*cosc-e.y*this.sinc0*sinc)):(i=this.phic0,t=0),e.x=t,e.y=i,Proj4js.Proj.gauss.inverse.apply(this,[e]),e.x=Proj4js.common.adjust_lon(e.x+this.long0),e}},Proj4js.Proj.poly={init:function(){(this.lat0=0)&&(this.lat0=90),this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.ml0=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,i,n,s,a,r,o,l=e.x,u=e.y;return n=Proj4js.common.adjust_lon(l-this.long0),Math.abs(u)<=1e-7?(r=this.x0+this.a*n,o=this.y0-this.a*this.ml0):(t=Math.sin(u),i=Math.cos(u),s=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,u),a=Proj4js.common.msfnz(this.e,t,i),n=t,r=this.x0+this.a*a*Math.sin(n)/t,o=this.y0+this.a*(s-this.ml0+a*(1-Math.cos(n))/t)),e.x=r,e.y=o,e},inverse:function(e){var t,i,n,s,a,r;if(e.x-=this.x0,e.y-=this.y0,t=this.ml0+e.y/this.a,s=0,Math.abs(t)<=1e-7)a=e.x/this.a+this.long0,r=0;else{if(i=t*t+e.x/this.a*(e.x/this.a),s=phi4z(this.es,this.e0,this.e1,this.e2,this.e3,this.al,i,n,r),1!=s)return s;a=Proj4js.common.adjust_lon(Proj4js.common.asinz(e.x*n/this.a)/Math.sin(r)+this.long0)}return e.x=a,e.y=r,e}},Proj4js.Proj.equi={init:function(){this.x0||(this.x0=0),this.y0||(this.y0=0),this.lat0||(this.lat0=0),this.long0||(this.long0=0)},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),s=this.x0+this.a*n*Math.cos(this.lat0),a=this.y0+this.a*i;return this.t1=s,this.t2=Math.cos(this.lat0),e.x=s,e.y=a,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=e.y/this.a;Math.abs(t)>Proj4js.common.HALF_PI&&Proj4js.reportError("equi:Inv:DataError");var i=Proj4js.common.adjust_lon(this.long0+e.x/(this.a*Math.cos(this.lat0)));e.x=i,e.y=t}},Proj4js.Proj.merc={init:function(){this.lat_ts&&(this.k0=this.sphere?Math.cos(this.lat_ts):Proj4js.common.msfnz(this.es,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(e){var t=e.x,i=e.y;if(i*Proj4js.common.R2D>90&&i*Proj4js.common.R2D<-90&&t*Proj4js.common.R2D>180&&t*Proj4js.common.R2D<-180)return Proj4js.reportError("merc:forward: llInputOutOfRange: "+t+" : "+i),null;var n,s;if(Math.abs(Math.abs(i)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN)return Proj4js.reportError("merc:forward: ll2mAtPoles"),null;if(this.sphere)n=this.x0+this.a*this.k0*Proj4js.common.adjust_lon(t-this.long0),s=this.y0+this.a*this.k0*Math.log(Math.tan(Proj4js.common.FORTPI+.5*i));else{var a=Math.sin(i),r=Proj4js.common.tsfnz(this.e,i,a);n=this.x0+this.a*this.k0*Proj4js.common.adjust_lon(t-this.long0),s=this.y0-this.a*this.k0*Math.log(r)}return e.x=n,e.y=s,e},inverse:function(e){var t,i,n=e.x-this.x0,s=e.y-this.y0;if(this.sphere)i=Proj4js.common.HALF_PI-2*Math.atan(Math.exp(-s/this.a*this.k0));else{var a=Math.exp(-s/(this.a*this.k0));if(i=Proj4js.common.phi2z(this.e,a),-9999==i)return Proj4js.reportError("merc:inverse: lat = -9999"),null}return t=Proj4js.common.adjust_lon(this.long0+n/(this.a*this.k0)),e.x=t,e.y=i,e}},Proj4js.Proj.utm={dependsOn:"tmerc",init:function(){return this.zone?(this.lat0=0,this.long0=(6*Math.abs(this.zone)-183)*Proj4js.common.D2R,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,Proj4js.Proj.tmerc.init.apply(this),this.forward=Proj4js.Proj.tmerc.forward,this.inverse=Proj4js.Proj.tmerc.inverse,void 0):(Proj4js.reportError("utm:init: zone must be specified for UTM"),void 0)}},Proj4js.Proj.eqdc={init:function(){this.mode||(this.mode=0),this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=Proj4js.common.msfnz(this.e,this.sinphi,this.cosphi),this.ml1=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat1),0!=this.mode?(Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN&&Proj4js.reportError("eqdc:Init:EqualLatitudes"),this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=Proj4js.common.msfnz(this.e,this.sinphi,this.cosphi),this.ml2=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=Math.abs(this.lat1-this.lat2)>=Proj4js.common.EPSLN?(this.ms1-this.ms2)/(this.ml2-this.ml1):this.sinphi):this.ns=this.sinphi,this.g=this.ml1+this.ms1/this.ns,this.ml0=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0)},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,i),s=this.a*(this.g-n),a=this.ns*Proj4js.common.adjust_lon(t-this.long0),r=this.x0+s*Math.sin(a),o=this.y0+this.rh-s*Math.cos(a);return e.x=r,e.y=o,e},inverse:function(e){e.x-=this.x0,e.y=this.rh-e.y+this.y0;var t,i;if(this.ns>=0)var i=Math.sqrt(e.x*e.x+e.y*e.y),t=1;else i=-Math.sqrt(e.x*e.x+e.y*e.y),t=-1;var n=0;0!=i&&(n=Math.atan2(t*e.x,t*e.y)),this.g-i/this.a;var s=this.phi3z(this.ml,this.e0,this.e1,this.e2,this.e3),a=Proj4js.common.adjust_lon(this.long0+n/this.ns);return e.x=a,e.y=s,e},phi3z:function(e,t,i,n,s){var a,r;a=e;for(var o=0;15>o;o++)if(r=(e+i*Math.sin(2*a)-n*Math.sin(4*a)+s*Math.sin(6*a))/t-a,a+=r,Math.abs(r)<=1e-10)return a;return Proj4js.reportError("PHI3Z-CONV:Latitude failed to converge after 15 iterations"),null
}},Proj4js.Proj.tmerc={init:function(){this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.ml0=this.a*Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,i,n,s=e.x,a=e.y,r=Proj4js.common.adjust_lon(s-this.long0),o=Math.sin(a),l=Math.cos(a);if(this.sphere){var u=l*Math.sin(r);if(Math.abs(Math.abs(u)-1)<1e-10)return Proj4js.reportError("tmerc:forward: Point projects into infinity"),93;i=.5*this.a*this.k0*Math.log((1+u)/(1-u)),t=Math.acos(l*Math.cos(r)/Math.sqrt(1-u*u)),0>a&&(t=-t),n=this.a*this.k0*(t-this.lat0)}else{var c=l*r,h=Math.pow(c,2),d=this.ep2*Math.pow(l,2),p=Math.tan(a),f=Math.pow(p,2);t=1-this.es*Math.pow(o,2);var m=this.a/Math.sqrt(t),g=this.a*Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,a);i=this.k0*m*c*(1+h/6*(1-f+d+h/20*(5-18*f+Math.pow(f,2)+72*d-58*this.ep2)))+this.x0,n=this.k0*(g-this.ml0+m*p*h*(.5+h/24*(5-f+9*d+4*Math.pow(d,2)+h/30*(61-58*f+Math.pow(f,2)+600*d-330*this.ep2))))+this.y0}return e.x=i,e.y=n,e},inverse:function(e){var t,i,n,s,a,r,o=6;if(this.sphere){var l=Math.exp(e.x/(this.a*this.k0)),u=.5*(l-1/l),c=this.lat0+e.y/(this.a*this.k0),h=Math.cos(c);t=Math.sqrt((1-h*h)/(1+u*u)),a=Proj4js.common.asinz(t),0>c&&(a=-a),r=0==u&&0==h?this.long0:Proj4js.common.adjust_lon(Math.atan2(u,h)+this.long0)}else{var d=e.x-this.x0,p=e.y-this.y0;for(t=(this.ml0+p/this.k0)/this.a,i=t,s=0;!0&&(n=(t+this.e1*Math.sin(2*i)-this.e2*Math.sin(4*i)+this.e3*Math.sin(6*i))/this.e0-i,i+=n,!(Math.abs(n)<=Proj4js.common.EPSLN));s++)if(s>=o)return Proj4js.reportError("tmerc:inverse: Latitude failed to converge"),95;if(Math.abs(i)<Proj4js.common.HALF_PI){var f=Math.sin(i),m=Math.cos(i),g=Math.tan(i),y=this.ep2*Math.pow(m,2),v=Math.pow(y,2),b=Math.pow(g,2),_=Math.pow(b,2);t=1-this.es*Math.pow(f,2);var w=this.a/Math.sqrt(t),L=w*(1-this.es)/t,k=d/(w*this.k0),O=Math.pow(k,2);a=i-w*g*O/L*(.5-O/24*(5+3*b+10*y-4*v-9*this.ep2-O/30*(61+90*b+298*y+45*_-252*this.ep2-3*v))),r=Proj4js.common.adjust_lon(this.long0+k*(1-O/6*(1+2*b+y-O/20*(5-2*y+28*b-3*v+8*this.ep2+24*_)))/m)}else a=Proj4js.common.HALF_PI*Proj4js.common.sign(p),r=this.long0}return e.x=r,e.y=a,e}},Proj4js.defs.GOOGLE="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",Proj4js.defs["EPSG:900913"]=Proj4js.defs.GOOGLE,Proj4js.Proj.gstmerc={init:function(){var e=this.b/this.a;this.e=Math.sqrt(1-e*e),this.lc=this.long0,this.rs=Math.sqrt(1+this.e*this.e*Math.pow(Math.cos(this.lat0),4)/(1-this.e*this.e));var t=Math.sin(this.lat0),i=Math.asin(t/this.rs),n=Math.sin(i);this.cp=Proj4js.common.latiso(0,i,n)-this.rs*Proj4js.common.latiso(this.e,this.lat0,t),this.n2=this.k0*this.a*Math.sqrt(1-this.e*this.e)/(1-this.e*this.e*t*t),this.xs=this.x0,this.ys=this.y0-this.n2*i,this.title||(this.title="Gauss Schreiber transverse mercator")},forward:function(e){var t=e.x,i=e.y,n=this.rs*(t-this.lc),s=this.cp+this.rs*Proj4js.common.latiso(this.e,i,Math.sin(i)),a=Math.asin(Math.sin(n)/Proj4js.common.cosh(s)),r=Proj4js.common.latiso(0,a,Math.sin(a));return e.x=this.xs+this.n2*r,e.y=this.ys+this.n2*Math.atan(Proj4js.common.sinh(s)/Math.cos(n)),e},inverse:function(e){var t=e.x,i=e.y,n=Math.atan(Proj4js.common.sinh((t-this.xs)/this.n2)/Math.cos((i-this.ys)/this.n2)),s=Math.asin(Math.sin((i-this.ys)/this.n2)/Proj4js.common.cosh((t-this.xs)/this.n2)),a=Proj4js.common.latiso(0,s,Math.sin(s));return e.x=this.lc+n/this.rs,e.y=Proj4js.common.invlatiso(this.e,(a-this.cp)/this.rs),e}},Proj4js.Proj.ortho={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(e){var t,i,n,s,a,r,o=e.x,l=e.y;if(n=Proj4js.common.adjust_lon(o-this.long0),t=Math.sin(l),i=Math.cos(l),s=Math.cos(n),r=this.sin_p14*t+this.cos_p14*i*s,a=1,r>0||Math.abs(r)<=Proj4js.common.EPSLN)var u=this.a*a*i*Math.sin(n),c=this.y0+this.a*a*(this.cos_p14*t-this.sin_p14*i*s);else Proj4js.reportError("orthoFwdPointError");return e.x=u,e.y=c,e},inverse:function(e){var t,i,n,s,a,r,o;return e.x-=this.x0,e.y-=this.y0,t=Math.sqrt(e.x*e.x+e.y*e.y),t>this.a+1e-7&&Proj4js.reportError("orthoInvDataError"),i=Proj4js.common.asinz(t/this.a),n=Math.sin(i),s=Math.cos(i),r=this.long0,Math.abs(t)<=Proj4js.common.EPSLN&&(o=this.lat0),o=Proj4js.common.asinz(s*this.sin_p14+e.y*n*this.cos_p14/t),a=Math.abs(lat0)-Proj4js.common.HALF_PI,Math.abs(a)<=Proj4js.common.EPSLN&&(r=this.lat0>=0?Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x,-e.y)):Proj4js.common.adjust_lon(this.long0-Math.atan2(-e.x,e.y))),a=s-this.sin_p14*Math.sin(o),(Math.abs(a)>=Proj4js.common.EPSLN||Math.abs(x)>=Proj4js.common.EPSLN)&&(r=Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x*n*this.cos_p14,a*t))),e.x=r,e.y=o,e}},Proj4js.Proj.somerc={init:function(){var e=this.lat0;this.lambda0=this.long0;var t=Math.sin(e),i=this.a,n=this.rf,s=1/n,a=2*s-Math.pow(s,2),r=this.e=Math.sqrt(a);this.R=i*Math.sqrt(1-a)/(1-a*Math.pow(t,2)),this.alpha=Math.sqrt(1+a/(1-a)*Math.pow(Math.cos(e),4)),this.b0=Math.asin(t/this.alpha),this.K=Math.log(Math.tan(Math.PI/4+this.b0/2))-this.alpha*Math.log(Math.tan(Math.PI/4+e/2))+this.alpha*r/2*Math.log((1+r*t)/(1-r*t))},forward:function(e){var t=Math.log(Math.tan(Math.PI/4-e.y/2)),i=this.e/2*Math.log((1+this.e*Math.sin(e.y))/(1-this.e*Math.sin(e.y))),n=-this.alpha*(t+i)+this.K,s=2*(Math.atan(Math.exp(n))-Math.PI/4),a=this.alpha*(e.x-this.lambda0),r=Math.atan(Math.sin(a)/(Math.sin(this.b0)*Math.tan(s)+Math.cos(this.b0)*Math.cos(a))),o=Math.asin(Math.cos(this.b0)*Math.sin(s)-Math.sin(this.b0)*Math.cos(s)*Math.cos(a));return e.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0,e.x=this.R*r+this.x0,e},inverse:function(e){for(var t=e.x-this.x0,i=e.y-this.y0,n=t/this.R,s=2*(Math.atan(Math.exp(i/this.R))-Math.PI/4),a=Math.asin(Math.cos(this.b0)*Math.sin(s)+Math.sin(this.b0)*Math.cos(s)*Math.cos(n)),r=Math.atan(Math.sin(n)/(Math.cos(this.b0)*Math.cos(n)-Math.sin(this.b0)*Math.tan(s))),o=this.lambda0+r/this.alpha,l=0,u=a,c=-1e3,h=0;Math.abs(u-c)>1e-7;){if(++h>20)return Proj4js.reportError("omercFwdInfinity"),void 0;l=1/this.alpha*(Math.log(Math.tan(Math.PI/4+a/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(u))/2)),c=u,u=2*Math.atan(Math.exp(l))-Math.PI/2}return e.x=o,e.y=u,e}},Proj4js.Proj.stere={ssfn_:function(e,t,i){return t*=i,Math.tan(.5*(Proj4js.common.HALF_PI+e))*Math.pow((1-t)/(1+t),.5*i)},TOL:1e-8,NITER:8,CONV:1e-10,S_POLE:0,N_POLE:1,OBLIQ:2,EQUIT:3,init:function(){this.phits=this.lat_ts?this.lat_ts:Proj4js.common.HALF_PI;var e=Math.abs(this.lat0);if(this.mode=Math.abs(e)-Proj4js.common.HALF_PI<Proj4js.common.EPSLN?this.lat0<0?this.S_POLE:this.N_POLE:e>Proj4js.common.EPSLN?this.OBLIQ:this.EQUIT,this.phits=Math.abs(this.phits),this.es){var t;switch(this.mode){case this.N_POLE:case this.S_POLE:Math.abs(this.phits-Proj4js.common.HALF_PI)<Proj4js.common.EPSLN?this.akm1=2*this.k0/Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)):(e=Math.sin(this.phits),this.akm1=Math.cos(this.phits)/Proj4js.common.tsfnz(this.e,this.phits,e),e*=this.e,this.akm1/=Math.sqrt(1-e*e));break;case this.EQUIT:this.akm1=2*this.k0;break;case this.OBLIQ:e=Math.sin(this.lat0),t=2*Math.atan(this.ssfn_(this.lat0,e,this.e))-Proj4js.common.HALF_PI,e*=this.e,this.akm1=2*this.k0*Math.cos(this.lat0)/Math.sqrt(1-e*e),this.sinX1=Math.sin(t),this.cosX1=Math.cos(t)}}else switch(this.mode){case this.OBLIQ:this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0);case this.EQUIT:this.akm1=2*this.k0;break;case this.S_POLE:case this.N_POLE:this.akm1=Math.abs(this.phits-Proj4js.common.HALF_PI)>=Proj4js.common.EPSLN?Math.cos(this.phits)/Math.tan(Proj4js.common.FORTPI-.5*this.phits):2*this.k0}},forward:function(e){var t=e.x;t=Proj4js.common.adjust_lon(t-this.long0);var i,n,s=e.y;if(this.sphere){var a,r,o,l;switch(a=Math.sin(s),r=Math.cos(s),o=Math.cos(t),l=Math.sin(t),this.mode){case this.EQUIT:n=1+r*o,n<=Proj4js.common.EPSLN,n=this.akm1/n,i=n*r*l,n*=a;break;case this.OBLIQ:n=1+this.sinph0*a+this.cosph0*r*o,n<=Proj4js.common.EPSLN,n=this.akm1/n,i=n*r*l,n*=this.cosph0*a-this.sinph0*r*o;break;case this.N_POLE:o=-o,s=-s;case this.S_POLE:Math.abs(s-Proj4js.common.HALF_PI)<this.TOL,n=this.akm1*Math.tan(Proj4js.common.FORTPI+.5*s),i=l*n,n*=o}}else{switch(o=Math.cos(t),l=Math.sin(t),a=Math.sin(s),(this.mode==this.OBLIQ||this.mode==this.EQUIT)&&(X=2*Math.atan(this.ssfn_(s,a,this.e)),sinX=Math.sin(X-Proj4js.common.HALF_PI),cosX=Math.cos(X)),this.mode){case this.OBLIQ:A=this.akm1/(this.cosX1*(1+this.sinX1*sinX+this.cosX1*cosX*o)),n=A*(this.cosX1*sinX-this.sinX1*cosX*o),i=A*cosX;break;case this.EQUIT:A=2*this.akm1/(1+cosX*o),n=A*sinX,i=A*cosX;break;case this.S_POLE:s=-s,o=-o,a=-a;case this.N_POLE:i=this.akm1*Proj4js.common.tsfnz(this.e,s,a),n=-i*o}i*=l}return e.x=i*this.a+this.x0,e.y=n*this.a+this.y0,e},inverse:function(e){var t,i,n,s,a,r,o=(e.x-this.x0)/this.a,l=(e.y-this.y0)/this.a,u=0,c=0,h=0,d=0;if(this.sphere){var p,f,m,g;switch(f=Math.sqrt(o*o+l*l),p=2*Math.atan(f/this.akm1),m=Math.sin(p),g=Math.cos(p),t=0,this.mode){case this.EQUIT:i=Math.abs(f)<=Proj4js.common.EPSLN?0:Math.asin(l*m/f),(0!=g||0!=o)&&(t=Math.atan2(o*m,g*f));break;case this.OBLIQ:i=Math.abs(f)<=Proj4js.common.EPSLN?this.phi0:Math.asin(g*sinph0+l*m*cosph0/f),p=g-sinph0*Math.sin(i),(0!=p||0!=o)&&(t=Math.atan2(o*m*cosph0,p*f));break;case this.N_POLE:l=-l;case this.S_POLE:i=Math.abs(f)<=Proj4js.common.EPSLN?this.phi0:Math.asin(this.mode==this.S_POLE?-g:g),t=0==o&&0==l?0:Math.atan2(o,l)}}else{switch(a=Math.sqrt(o*o+l*l),this.mode){case this.OBLIQ:case this.EQUIT:u=2*Math.atan2(a*this.cosX1,this.akm1),n=Math.cos(u),s=Math.sin(u),c=0==a?Math.asin(n*this.sinX1):Math.asin(n*this.sinX1+l*s*this.cosX1/a),u=Math.tan(.5*(Proj4js.common.HALF_PI+c)),o*=s,l=a*this.cosX1*n-l*this.sinX1*s,d=Proj4js.common.HALF_PI,h=.5*this.e;break;case this.N_POLE:l=-l;case this.S_POLE:u=-a/this.akm1,c=Proj4js.common.HALF_PI-2*Math.atan(u),d=-Proj4js.common.HALF_PI,h=-.5*this.e}for(r=this.NITER;r--;c=i)if(s=this.e*Math.sin(c),i=2*Math.atan(u*Math.pow((1+s)/(1-s),h))-d,Math.abs(c-i)<this.CONV)return this.mode==this.S_POLE&&(i=-i),t=0==o&&0==l?0:Math.atan2(o,l),e.x=Proj4js.common.adjust_lon(t+this.long0),e.y=i,e}}},Proj4js.Proj.nzmg={iterations:1,init:function(){this.A=new Array,this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=new Array,this.B_im=new Array,this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=new Array,this.C_im=new Array,this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=new Array,this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(e){var t=e.x,i=e.y,s=i-this.lat0,a=t-this.long0,r=1e-5*(s/Proj4js.common.SEC_TO_RAD),o=a,l=1,u=0;for(n=1;10>=n;n++)l*=r,u+=this.A[n]*l;var c,h,d=u,p=o,f=1,m=0,g=0,v=0;for(n=1;6>=n;n++)c=f*d-m*p,h=m*d+f*p,f=c,m=h,g=g+this.B_re[n]*f-this.B_im[n]*m,v=v+this.B_im[n]*f+this.B_re[n]*m;return x=v*this.a+this.x0,y=g*this.a+this.y0,e.x=x,e.y=y,e},inverse:function(e){var t,s,a=e.x,r=e.y,o=a-this.x0,l=r-this.y0,u=l/this.a,c=o/this.a,h=1,d=0,p=0,f=0;for(n=1;6>=n;n++)t=h*u-d*c,s=d*u+h*c,h=t,d=s,p=p+this.C_re[n]*h-this.C_im[n]*d,f=f+this.C_im[n]*h+this.C_re[n]*d;for(i=0;i<this.iterations;i++){var m,g,y=p,v=f,b=u,_=c;for(n=2;6>=n;n++)m=y*p-v*f,g=v*p+y*f,y=m,v=g,b+=(n-1)*(this.B_re[n]*y-this.B_im[n]*v),_+=(n-1)*(this.B_im[n]*y+this.B_re[n]*v);y=1,v=0;var w=this.B_re[1],L=this.B_im[1];for(n=2;6>=n;n++)m=y*p-v*f,g=v*p+y*f,y=m,v=g,w+=n*(this.B_re[n]*y-this.B_im[n]*v),L+=n*(this.B_im[n]*y+this.B_re[n]*v);var k=w*w+L*L;p=(b*w+_*L)/k,f=(_*w-b*L)/k}var O=p,x=f,S=1,C=0;for(n=1;9>=n;n++)S*=O,C+=this.D[n]*S;var M=this.lat0+1e5*C*Proj4js.common.SEC_TO_RAD,P=this.long0+x;return e.x=P,e.y=M,e}},Proj4js.Proj.mill={init:function(){},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),s=this.x0+this.a*n,a=this.y0+1.25*this.a*Math.log(Math.tan(Proj4js.common.PI/4+i/2.5));return e.x=s,e.y=a,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=Proj4js.common.adjust_lon(this.long0+e.x/this.a),i=2.5*(Math.atan(Math.exp(.8*e.y/this.a))-Proj4js.common.PI/4);return e.x=t,e.y=i,e}},Proj4js.Proj.gnom={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a},forward:function(e){var t,i,n,s,a,r,o=e.x,l=e.y;return n=Proj4js.common.adjust_lon(o-this.long0),t=Math.sin(l),i=Math.cos(l),s=Math.cos(n),r=this.sin_p14*t+this.cos_p14*i*s,a=1,r>0||Math.abs(r)<=Proj4js.common.EPSLN?(x=this.x0+this.a*a*i*Math.sin(n)/r,y=this.y0+this.a*a*(this.cos_p14*t-this.sin_p14*i*s)/r):(Proj4js.reportError("orthoFwdPointError"),x=this.x0+this.infinity_dist*i*Math.sin(n),y=this.y0+this.infinity_dist*(this.cos_p14*t-this.sin_p14*i*s)),e.x=x,e.y=y,e},inverse:function(e){var t,i,n,s,a,r;return e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,(t=Math.sqrt(e.x*e.x+e.y*e.y))?(s=Math.atan2(t,this.rc),i=Math.sin(s),n=Math.cos(s),r=Proj4js.common.asinz(n*this.sin_p14+e.y*i*this.cos_p14/t),a=Math.atan2(e.x*i,t*this.cos_p14*n-e.y*this.sin_p14*i),a=Proj4js.common.adjust_lon(this.long0+a)):(r=this.phic0,a=0),e.x=a,e.y=r,e}},Proj4js.Proj.sinu={init:function(){this.R=6370997},forward:function(e){var t,i,n,s=e.x,a=e.y;return n=Proj4js.common.adjust_lon(s-this.long0),t=this.R*n*Math.cos(a)+this.x0,i=this.R*a+this.y0,e.x=t,e.y=i,e},inverse:function(e){var t,i,n;return e.x-=this.x0,e.y-=this.y0,t=e.y/this.R,Math.abs(t)>Proj4js.common.HALF_PI&&Proj4js.reportError("sinu:Inv:DataError"),i=Math.abs(t)-Proj4js.common.HALF_PI,Math.abs(i)>Proj4js.common.EPSLN?(i=this.long0+e.x/(this.R*Math.cos(t)),n=Proj4js.common.adjust_lon(i)):n=this.long0,e.x=n,e.y=t,e}},Proj4js.Proj.vandg={init:function(){this.R=6370997},forward:function(e){var t,i,n=e.x,s=e.y,a=Proj4js.common.adjust_lon(n-this.long0);Math.abs(s)<=Proj4js.common.EPSLN&&(t=this.x0+this.R*a,i=this.y0);var r=Proj4js.common.asinz(2*Math.abs(s/Proj4js.common.PI));(Math.abs(a)<=Proj4js.common.EPSLN||Math.abs(Math.abs(s)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN)&&(t=this.x0,i=s>=0?this.y0+Proj4js.common.PI*this.R*Math.tan(.5*r):this.y0+Proj4js.common.PI*this.R*-Math.tan(.5*r));var o=.5*Math.abs(Proj4js.common.PI/a-a/Proj4js.common.PI),l=o*o,u=Math.sin(r),c=Math.cos(r),h=c/(u+c-1),d=h*h,p=h*(2/u-1),f=p*p,m=Proj4js.common.PI*this.R*(o*(h-f)+Math.sqrt(l*(h-f)*(h-f)-(f+l)*(d-f)))/(f+l);return 0>a&&(m=-m),t=this.x0+m,m=Math.abs(m/(Proj4js.common.PI*this.R)),i=s>=0?this.y0+Proj4js.common.PI*this.R*Math.sqrt(1-m*m-2*o*m):this.y0-Proj4js.common.PI*this.R*Math.sqrt(1-m*m-2*o*m),e.x=t,e.y=i,e},inverse:function(e){var t,i,n,s,a,r,o,l,u,c,h;return e.x-=this.x0,e.y-=this.y0,u=Proj4js.common.PI*this.R,t=e.x/u,i=e.y/u,n=t*t+i*i,s=-Math.abs(i)*(1+n),a=s-2*i*i+t*t,r=-2*s+1+2*i*i+n*n,h=i*i/r+(2*a*a*a/r/r/r-9*s*a/r/r)/27,o=(s-a*a/3/r)/r,l=2*Math.sqrt(-o/3),u=3*h/o/l,Math.abs(u)>1&&(u=u>=0?1:-1),c=Math.acos(u)/3,lat=e.y>=0?(-l*Math.cos(c+Proj4js.common.PI/3)-a/3/r)*Proj4js.common.PI:-(-l*Math.cos(c+PI/3)-a/3/r)*Proj4js.common.PI,Math.abs(t)<Proj4js.common.EPSLN&&(lon=this.long0),lon=Proj4js.common.adjust_lon(this.long0+Proj4js.common.PI*(n-1+Math.sqrt(1+2*(t*t-i*i)+n*n))/2/t),e.x=lon,e.y=lat,e}},Proj4js.Proj.cea={init:function(){},forward:function(e){var t=e.x,i=e.y;dlon=Proj4js.common.adjust_lon(t-this.long0);var n=this.x0+this.a*dlon*Math.cos(this.lat_ts),s=this.y0+this.a*Math.sin(i)/Math.cos(this.lat_ts);return e.x=n,e.y=s,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=Proj4js.common.adjust_lon(this.long0+e.x/this.a/Math.cos(this.lat_ts)),i=Math.asin(e.y/this.a*Math.cos(this.lat_ts));return e.x=t,e.y=i,e}},Proj4js.Proj.eqc={init:function(){this.x0||(this.x0=0),this.y0||(this.y0=0),this.lat0||(this.lat0=0),this.long0||(this.long0=0),this.lat_ts||(this.lat_ts=0),this.title||(this.title="Equidistant Cylindrical (Plate Carre)"),this.rc=Math.cos(this.lat_ts)},forward:function(e){var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),s=Proj4js.common.adjust_lat(i-this.lat0);return e.x=this.x0+this.a*n*this.rc,e.y=this.y0+this.a*s,e},inverse:function(e){var t=e.x,i=e.y;return e.x=Proj4js.common.adjust_lon(this.long0+(t-this.x0)/(this.a*this.rc)),e.y=Proj4js.common.adjust_lat(this.lat0+(i-this.y0)/this.a),e}},Proj4js.Proj.cass={init:function(){this.sphere||(this.en=this.pj_enfn(this.es),this.m0=this.pj_mlfn(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},C1:.16666666666666666,C2:.008333333333333333,C3:.041666666666666664,C4:.3333333333333333,C5:.06666666666666667,forward:function(e){var t,i,n=e.x,s=e.y;return n=Proj4js.common.adjust_lon(n-this.long0),this.sphere?(t=Math.asin(Math.cos(s)*Math.sin(n)),i=Math.atan2(Math.tan(s),Math.cos(n))-this.phi0):(this.n=Math.sin(s),this.c=Math.cos(s),i=this.pj_mlfn(s,this.n,this.c,this.en),this.n=1/Math.sqrt(1-this.es*this.n*this.n),this.tn=Math.tan(s),this.t=this.tn*this.tn,this.a1=n*this.c,this.c*=this.es*this.c/(1-this.es),this.a2=this.a1*this.a1,t=this.n*this.a1*(1-this.a2*this.t*(this.C1-(8-this.t+8*this.c)*this.a2*this.C2)),i-=this.m0-this.n*this.tn*this.a2*(.5+(5-this.t+6*this.c)*this.a2*this.C3)),e.x=this.a*t+this.x0,e.y=this.a*i+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=e.x/this.a,i=e.y/this.a;return this.sphere?(this.dd=i+this.lat0,phi=Math.asin(Math.sin(this.dd)*Math.cos(t)),lam=Math.atan2(Math.tan(t),Math.cos(this.dd))):(ph1=this.pj_inv_mlfn(this.m0+i,this.es,this.en),this.tn=Math.tan(ph1),this.t=this.tn*this.tn,this.n=Math.sin(ph1),this.r=1/(1-this.es*this.n*this.n),this.n=Math.sqrt(this.r),this.r*=(1-this.es)*this.n,this.dd=t/this.n,this.d2=this.dd*this.dd,phi=ph1-this.n*this.tn/this.r*this.d2*(.5-(1+3*this.t)*this.d2*this.C3),lam=this.dd*(1+this.t*this.d2*(-this.C4+(1+3*this.t)*this.d2*this.C5))/Math.cos(ph1)),e.x=Proj4js.common.adjust_lon(this.long0+lam),e.y=phi,e},pj_enfn:function(e){en=new Array,en[0]=this.C00-e*(this.C02+e*(this.C04+e*(this.C06+e*this.C08))),en[1]=e*(this.C22-e*(this.C04+e*(this.C06+e*this.C08)));var t=e*e;return en[2]=t*(this.C44-e*(this.C46+e*this.C48)),t*=e,en[3]=t*(this.C66-e*this.C68),en[4]=t*e*this.C88,en},pj_mlfn:function(e,t,i,n){return i*=t,t*=t,n[0]*e-i*(n[1]+t*(n[2]+t*(n[3]+t*n[4])))},pj_inv_mlfn:function(e,n,a){for(k=1/(1-n),phi=e,i=Proj4js.common.MAX_ITER;i;--i)if(s=Math.sin(phi),t=1-n*s*s,t=(this.pj_mlfn(phi,s,Math.cos(phi),a)-e)*t*Math.sqrt(t)*k,phi-=t,Math.abs(t)<Proj4js.common.EPSLN)return phi;return Proj4js.reportError("cass:pj_inv_mlfn: Convergence error"),phi},C00:1,C02:.25,C04:.046875,C06:.01953125,C08:.01068115234375,C22:.75,C44:.46875,C46:.013020833333333334,C48:.007120768229166667,C66:.3645833333333333,C68:.005696614583333333,C88:.3076171875},Proj4js.Proj.gauss={init:function(){sphi=Math.sin(this.lat0),cphi=Math.cos(this.lat0),cphi*=cphi,this.rc=Math.sqrt(1-this.es)/(1-this.es*sphi*sphi),this.C=Math.sqrt(1+this.es*cphi*cphi/(1-this.es)),this.phic0=Math.asin(sphi/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+Proj4js.common.FORTPI)/(Math.pow(Math.tan(.5*this.lat0+Proj4js.common.FORTPI),this.C)*Proj4js.common.srat(this.e*sphi,this.ratexp))},forward:function(e){var t=e.x,i=e.y;return e.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*i+Proj4js.common.FORTPI),this.C)*Proj4js.common.srat(this.e*Math.sin(i),this.ratexp))-Proj4js.common.HALF_PI,e.x=this.C*t,e},inverse:function(e){var t=1e-14,i=e.x/this.C,n=e.y;num=Math.pow(Math.tan(.5*n+Proj4js.common.FORTPI)/this.K,1/this.C);for(var s=Proj4js.common.MAX_ITER;s>0&&(n=2*Math.atan(num*Proj4js.common.srat(this.e*Math.sin(e.y),-.5*this.e))-Proj4js.common.HALF_PI,!(Math.abs(n-e.y)<t));--s)e.y=n;return s?(e.x=i,e.y=n,e):(Proj4js.reportError("gauss:inverse:convergence failed"),null)}},Proj4js.Proj.omerc={init:function(){this.mode||(this.mode=0),this.lon1||(this.lon1=0,this.mode=1),this.lon2||(this.lon2=0),this.lat2||(this.lat2=0);var e=this.b/this.a,t=1-Math.pow(e,2);Math.sqrt(t),this.sin_p20=Math.sin(this.lat0),this.cos_p20=Math.cos(this.lat0),this.con=1-this.es*this.sin_p20*this.sin_p20,this.com=Math.sqrt(1-t),this.bl=Math.sqrt(1+this.es*Math.pow(this.cos_p20,4)/(1-t)),this.al=this.a*this.bl*this.k0*this.com/this.con,Math.abs(this.lat0)<Proj4js.common.EPSLN?(this.ts=1,this.d=1,this.el=1):(this.ts=Proj4js.common.tsfnz(this.e,this.lat0,this.sin_p20),this.con=Math.sqrt(this.con),this.d=this.bl*this.com/(this.cos_p20*this.con),this.f=this.d*this.d-1>0?this.lat0>=0?this.d+Math.sqrt(this.d*this.d-1):this.d-Math.sqrt(this.d*this.d-1):this.d,this.el=this.f*Math.pow(this.ts,this.bl)),0!=this.mode?(this.g=.5*(this.f-1/this.f),this.gama=Proj4js.common.asinz(Math.sin(this.alpha)/this.d),this.longc=this.longc-Proj4js.common.asinz(this.g*Math.tan(this.gama))/this.bl,this.con=Math.abs(this.lat0),this.con>Proj4js.common.EPSLN&&Math.abs(this.con-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN?(this.singam=Math.sin(this.gama),this.cosgam=Math.cos(this.gama),this.sinaz=Math.sin(this.alpha),this.cosaz=Math.cos(this.alpha),this.u=this.lat0>=0?this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz):-(this.al/this.bl)*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz)):Proj4js.reportError("omerc:Init:DataError")):(this.sinphi=Math.sin(this.at1),this.ts1=Proj4js.common.tsfnz(this.e,this.lat1,this.sinphi),this.sinphi=Math.sin(this.lat2),this.ts2=Proj4js.common.tsfnz(this.e,this.lat2,this.sinphi),this.h=Math.pow(this.ts1,this.bl),this.l=Math.pow(this.ts2,this.bl),this.f=this.el/this.h,this.g=.5*(this.f-1/this.f),this.j=(this.el*this.el-this.l*this.h)/(this.el*this.el+this.l*this.h),this.p=(this.l-this.h)/(this.l+this.h),this.dlon=this.lon1-this.lon2,this.dlon<-Proj4js.common.PI&&(this.lon2=this.lon2-2*Proj4js.common.PI),this.dlon>Proj4js.common.PI&&(this.lon2=this.lon2+2*Proj4js.common.PI),this.dlon=this.lon1-this.lon2,this.longc=.5*(this.lon1+this.lon2)-Math.atan(this.j*Math.tan(.5*this.bl*this.dlon)/this.p)/this.bl,this.dlon=Proj4js.common.adjust_lon(this.lon1-this.longc),this.gama=Math.atan(Math.sin(this.bl*this.dlon)/this.g),this.alpha=Proj4js.common.asinz(this.d*Math.sin(this.gama)),Math.abs(this.lat1-this.lat2)<=Proj4js.common.EPSLN?Proj4js.reportError("omercInitDataError"):this.con=Math.abs(this.lat1),this.con<=Proj4js.common.EPSLN||Math.abs(this.con-HALF_PI)<=Proj4js.common.EPSLN?Proj4js.reportError("omercInitDataError"):Math.abs(Math.abs(this.lat0)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN&&Proj4js.reportError("omercInitDataError"),this.singam=Math.sin(this.gam),this.cosgam=Math.cos(this.gam),this.sinaz=Math.sin(this.alpha),this.cosaz=Math.cos(this.alpha),this.u=this.lat0>=0?this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz):-(this.al/this.bl)*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz))},forward:function(e){var t,i,n,s,a,r,o,l,u,c,h,d=e.x,p=e.y;t=Math.sin(p),c=Proj4js.common.adjust_lon(d-this.longc),r=Math.sin(this.bl*c),Math.abs(Math.abs(p)-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN?(h=Proj4js.common.tsfnz(this.e,p,t),s=this.el/Math.pow(h,this.bl),u=.5*(s-1/s),i=.5*(s+1/s),o=(u*this.singam-r*this.cosgam)/i,n=Math.cos(this.bl*c),Math.abs(n)<1e-7?a=this.al*this.bl*c:(a=this.al*Math.atan((u*this.cosgam+r*this.singam)/n)/this.bl,0>n&&(a+=Proj4js.common.PI*this.al/this.bl))):(o=p>=0?this.singam:-this.singam,a=this.al*p/this.bl),Math.abs(Math.abs(o)-1)<=Proj4js.common.EPSLN&&Proj4js.reportError("omercFwdInfinity"),l=.5*this.al*Math.log((1-o)/(1+o))/this.bl,a-=this.u;var f=this.x0+l*this.cosaz+a*this.sinaz,m=this.y0+a*this.cosaz-l*this.sinaz;return e.x=f,e.y=m,e},inverse:function(e){var t,i,n,s,a,r,o,l,u,c,h;return e.x-=this.x0,e.y-=this.y0,h=0,s=e.x*this.cosaz-e.y*this.sinaz,a=e.y*this.cosaz+e.x*this.sinaz,a+=this.u,r=Math.exp(-this.bl*s/this.al),o=.5*(r-1/r),i=.5*(r+1/r),u=Math.sin(this.bl*a/this.al),c=(u*this.cosgam+o*this.singam)/i,Math.abs(Math.abs(c)-1)<=Proj4js.common.EPSLN?(lon=this.longc,lat=c>=0?Proj4js.common.HALF_PI:-Proj4js.common.HALF_PI):(n=1/this.bl,l=Math.pow(this.el/Math.sqrt((1+c)/(1-c)),n),lat=Proj4js.common.phi2z(this.e,l),t=this.longc-Math.atan2(o*this.cosgam-u*this.singam,n)/this.bl,lon=Proj4js.common.adjust_lon(t)),e.x=lon,e.y=lat,e}},Proj4js.Proj.lcc={init:function(){if(this.lat2||(this.lat2=this.lat0),this.k0||(this.k0=1),Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN)return Proj4js.reportError("lcc:init: Equal Latitudes"),void 0;var e=this.b/this.a;this.e=Math.sqrt(1-e*e);var t=Math.sin(this.lat1),i=Math.cos(this.lat1),n=Proj4js.common.msfnz(this.e,t,i),s=Proj4js.common.tsfnz(this.e,this.lat1,t),a=Math.sin(this.lat2),r=Math.cos(this.lat2),o=Proj4js.common.msfnz(this.e,a,r),l=Proj4js.common.tsfnz(this.e,this.lat2,a),u=Proj4js.common.tsfnz(this.e,this.lat0,Math.sin(this.lat0));this.ns=Math.abs(this.lat1-this.lat2)>Proj4js.common.EPSLN?Math.log(n/o)/Math.log(s/l):t,this.f0=n/(this.ns*Math.pow(s,this.ns)),this.rh=this.a*this.f0*Math.pow(u,this.ns),this.title||(this.title="Lambert Conformal Conic")},forward:function(e){var t=e.x,i=e.y;if(!(90>=i&&i>=-90&&180>=t&&t>=-180))return Proj4js.reportError("lcc:forward: llInputOutOfRange: "+t+" : "+i),null;var n,s,a=Math.abs(Math.abs(i)-Proj4js.common.HALF_PI);if(a>Proj4js.common.EPSLN)n=Proj4js.common.tsfnz(this.e,i,Math.sin(i)),s=this.a*this.f0*Math.pow(n,this.ns);else{if(a=i*this.ns,0>=a)return Proj4js.reportError("lcc:forward: No Projection"),null;s=0}var r=this.ns*Proj4js.common.adjust_lon(t-this.long0);return e.x=this.k0*s*Math.sin(r)+this.x0,e.y=this.k0*(this.rh-s*Math.cos(r))+this.y0,e},inverse:function(e){var t,i,n,s,a;x=(e.x-this.x0)/this.k0,y=this.rh-(e.y-this.y0)/this.k0,this.ns>0?(t=Math.sqrt(x*x+y*y),i=1):(t=-Math.sqrt(x*x+y*y),i=-1);var r=0;if(0!=t&&(r=Math.atan2(i*x,i*y)),0!=t||this.ns>0){if(i=1/this.ns,n=Math.pow(t/(this.a*this.f0),i),s=Proj4js.common.phi2z(this.e,n),-9999==s)return null}else s=-Proj4js.common.HALF_PI;return a=Proj4js.common.adjust_lon(r/this.ns+this.long0),e.x=a,e.y=s,e}},Proj4js.Proj.laea={S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4,init:function(){var e=Math.abs(this.lat0);if(this.mode=Math.abs(e-Proj4js.common.HALF_PI)<Proj4js.common.EPSLN?this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(e)<Proj4js.common.EPSLN?this.EQUIT:this.OBLIQ,this.es>0){var t;switch(this.qp=Proj4js.common.qsfnz(this.e,1),this.mmf=.5/(1-this.es),this.apa=this.authset(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),t=Math.sin(this.lat0),this.sinb1=Proj4js.common.qsfnz(this.e,t)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*t*t)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}}else this.mode==this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(e){var t,i,n=e.x,s=e.y;if(n=Proj4js.common.adjust_lon(n-this.long0),this.sphere){var a,r,o;switch(o=Math.sin(s),r=Math.cos(s),a=Math.cos(n),this.mode){case this.EQUIT:if(i=this.mode==this.EQUIT?1+r*a:1+this.sinph0*o+this.cosph0*r*a,i<=Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:y less than eps"),null;i=Math.sqrt(2/i),t=i*r*Math.sin(n),i*=this.mode==this.EQUIT?o:this.cosph0*o-this.sinph0*r*a;break;case this.N_POLE:a=-a;case this.S_POLE:if(Math.abs(s+this.phi0)<Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:phi < eps"),null;i=Proj4js.common.FORTPI-.5*s,i=2*(this.mode==this.S_POLE?Math.cos(i):Math.sin(i)),t=i*Math.sin(n),i*=a}}else{var a,l,o,u,c=0,h=0,d=0;switch(a=Math.cos(n),l=Math.sin(n),o=Math.sin(s),u=Proj4js.common.qsfnz(this.e,o),(this.mode==this.OBLIQ||this.mode==this.EQUIT)&&(c=u/this.qp,h=Math.sqrt(1-c*c)),this.mode){case this.OBLIQ:d=1+this.sinb1*c+this.cosb1*h*a;break;case this.EQUIT:d=1+h*a;break;case this.N_POLE:d=Proj4js.common.HALF_PI+s,u=this.qp-u;break;case this.S_POLE:d=s-Proj4js.common.HALF_PI,u=this.qp+u}if(Math.abs(d)<Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:b < eps"),null;switch(this.mode){case this.OBLIQ:case this.EQUIT:d=Math.sqrt(2/d),i=this.mode==this.OBLIQ?this.ymf*d*(this.cosb1*c-this.sinb1*h*a):(d=Math.sqrt(2/(1+h*a)))*c*this.ymf,t=this.xmf*d*h*l;break;case this.N_POLE:case this.S_POLE:u>=0?(t=(d=Math.sqrt(u))*l,i=a*(this.mode==this.S_POLE?d:-d)):t=i=0}}return e.x=this.a*t+this.x0,e.y=this.a*i+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=e.x/this.a,i=e.y/this.a;if(this.sphere){var n,s=0,a=0;n=Math.sqrt(t*t+i*i);var r=.5*n;if(r>1)return Proj4js.reportError("laea:Inv:DataError"),null;switch(r=2*Math.asin(r),(this.mode==this.OBLIQ||this.mode==this.EQUIT)&&(a=Math.sin(r),s=Math.cos(r)),this.mode){case this.EQUIT:r=Math.abs(n)<=Proj4js.common.EPSLN?0:Math.asin(i*a/n),t*=a,i=s*n;break;case this.OBLIQ:r=Math.abs(n)<=Proj4js.common.EPSLN?this.phi0:Math.asin(s*sinph0+i*a*cosph0/n),t*=a*cosph0,i=(s-Math.sin(r)*sinph0)*n;break;case this.N_POLE:i=-i,r=Proj4js.common.HALF_PI-r;break;case this.S_POLE:r-=Proj4js.common.HALF_PI}lam=0!=i||this.mode!=this.EQUIT&&this.mode!=this.OBLIQ?Math.atan2(t,i):0}else{var o,l,u,c,h=0;switch(this.mode){case this.EQUIT:case this.OBLIQ:if(t/=this.dd,i*=this.dd,c=Math.sqrt(t*t+i*i),c<Proj4js.common.EPSLN)return e.x=0,e.y=this.phi0,e;l=2*Math.asin(.5*c/this.rq),o=Math.cos(l),t*=l=Math.sin(l),this.mode==this.OBLIQ?(h=o*this.sinb1+i*l*this.cosb1/c,u=this.qp*h,i=c*this.cosb1*o-i*this.sinb1*l):(h=i*l/c,u=this.qp*h,i=c*o);break;case this.N_POLE:i=-i;case this.S_POLE:if(u=t*t+i*i,!u)return e.x=0,e.y=this.phi0,e;h=1-u/this.qp,this.mode==this.S_POLE&&(h=-h)}lam=Math.atan2(t,i),r=this.authlat(Math.asin(h),this.apa)}return e.x=Proj4js.common.adjust_lon(this.long0+lam),e.y=r,e},P00:.3333333333333333,P01:.17222222222222222,P02:.10257936507936508,P10:.06388888888888888,P11:.0664021164021164,P20:.016415012942191543,authset:function(e){var t,i=new Array;return i[0]=e*this.P00,t=e*e,i[0]+=t*this.P01,i[1]=t*this.P10,t*=e,i[0]+=t*this.P02,i[1]+=t*this.P11,i[2]=t*this.P20,i},authlat:function(e,t){var i=e+e;return e+t[0]*Math.sin(i)+t[1]*Math.sin(i+i)+t[2]*Math.sin(i+i+i)}},Proj4js.Proj.aeqd={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(e){var t=e.x;e.y;var i,n=Math.sin(e.y),s=Math.cos(e.y),a=Proj4js.common.adjust_lon(t-this.long0),r=Math.cos(a),o=this.sin_p12*n+this.cos_p12*s*r;if(Math.abs(Math.abs(o)-1)<Proj4js.common.EPSLN){if(i=1,0>o)return Proj4js.reportError("aeqd:Fwd:PointError"),void 0}else{var l=Math.acos(o);i=l/Math.sin(l)}return e.x=this.x0+this.a*i*s*Math.sin(a),e.y=this.y0+this.a*i*(this.cos_p12*n-this.sin_p12*s*r),e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=Math.sqrt(e.x*e.x+e.y*e.y);if(t>2*Proj4js.common.HALF_PI*this.a)return Proj4js.reportError("aeqdInvDataError"),void 0;var i,n=t/this.a,s=Math.sin(n),a=Math.cos(n),r=this.long0;if(Math.abs(t)<=Proj4js.common.EPSLN)i=this.lat0;else{i=Proj4js.common.asinz(a*this.sin_p12+e.y*s*this.cos_p12/t);var o=Math.abs(this.lat0)-Proj4js.common.HALF_PI;Math.abs(o)<=Proj4js.common.EPSLN?r=lat0>=0?Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x,-e.y)):Proj4js.common.adjust_lon(this.long0-Math.atan2(-e.x,e.y)):(o=a-this.sin_p12*Math.sin(i),Math.abs(o)<Proj4js.common.EPSLN&&Math.abs(e.x)<Proj4js.common.EPSLN||(Math.atan2(e.x*s*this.cos_p12,o*t),r=Proj4js.common.adjust_lon(this.long0+Math.atan2(e.x*s*this.cos_p12,o*t))))}return e.x=r,e.y=i,e}},Proj4js.Proj.moll={init:function(){},forward:function(e){for(var t=e.x,i=e.y,n=Proj4js.common.adjust_lon(t-this.long0),s=i,a=Proj4js.common.PI*Math.sin(i),r=0;!0;r++){var o=-(s+Math.sin(s)-a)/(1+Math.cos(s));
if(s+=o,Math.abs(o)<Proj4js.common.EPSLN)break;r>=50&&Proj4js.reportError("moll:Fwd:IterationError")}s/=2,Proj4js.common.PI/2-Math.abs(i)<Proj4js.common.EPSLN&&(n=0);var l=.900316316158*this.a*n*Math.cos(s)+this.x0,u=1.4142135623731*this.a*Math.sin(s)+this.y0;return e.x=l,e.y=u,e},inverse:function(e){var t,i;e.x-=this.x0;var i=e.y/(1.4142135623731*this.a);Math.abs(i)>.999999999999&&(i=.999999999999);var t=Math.asin(i),n=Proj4js.common.adjust_lon(this.long0+e.x/(.900316316158*this.a*Math.cos(t)));n<-Proj4js.common.PI&&(n=-Proj4js.common.PI),n>Proj4js.common.PI&&(n=Proj4js.common.PI),i=(2*t+Math.sin(2*t))/Proj4js.common.PI,Math.abs(i)>1&&(i=1);var s=Math.asin(i);return e.x=n,e.y=s,e}},OpenLayers.Class=function(){var e=arguments.length,t=arguments[0],i=arguments[e-1],n="function"==typeof i.initialize?i.initialize:function(){t.prototype.initialize.apply(this,arguments)};if(e>1){var s=[n,t].concat(Array.prototype.slice.call(arguments).slice(1,e-1),i);OpenLayers.inherit.apply(null,s)}else n.prototype=i;return n},OpenLayers.inherit=function(e,t){var i=function(){};i.prototype=t.prototype,e.prototype=new i;var n,s,a;for(n=2,s=arguments.length;s>n;n++)a=arguments[n],"function"==typeof a&&(a=a.prototype),OpenLayers.Util.extend(e.prototype,a)},OpenLayers.Util=OpenLayers.Util||{},OpenLayers.Util.extend=function(e,t){if(e=e||{},t){for(var i in t){var n=t[i];void 0!==n&&(e[i]=n)}var s="function"==typeof window.Event&&t instanceof window.Event;!s&&t.hasOwnProperty&&t.hasOwnProperty("toString")&&(e.toString=t.toString)}return e},OpenLayers.Util=OpenLayers.Util||{},OpenLayers.Util.getElement=function(){for(var e=[],t=0,i=arguments.length;i>t;t++){var n=arguments[t];if("string"==typeof n&&(n=document.getElementById(n)),1==arguments.length)return n;e.push(n)}return e},OpenLayers.Util.isElement=function(e){return!(!e||1!==e.nodeType)},OpenLayers.Util.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},"undefined"==typeof window.$&&(window.$=OpenLayers.Util.getElement),OpenLayers.Util.removeItem=function(e,t){for(var i=e.length-1;i>=0;i--)e[i]==t&&e.splice(i,1);return e},OpenLayers.Util.indexOf=function(e,t){if("function"==typeof e.indexOf)return e.indexOf(t);for(var i=0,n=e.length;n>i;i++)if(e[i]==t)return i;return-1},OpenLayers.Util.modifyDOMElement=function(e,t,i,n,s,a,r,o){t&&(e.id=t),i&&(e.style.left=i.x+"px",e.style.top=i.y+"px"),n&&(e.style.width=n.w+"px",e.style.height=n.h+"px"),s&&(e.style.position=s),a&&(e.style.border=a),r&&(e.style.overflow=r),parseFloat(o)>=0&&parseFloat(o)<1?(e.style.filter="alpha(opacity="+100*o+")",e.style.opacity=o):1==parseFloat(o)&&(e.style.filter="",e.style.opacity="")},OpenLayers.Util.createDiv=function(e,t,i,n,s,a,r,o){var l=document.createElement("div");return n&&(l.style.backgroundImage="url("+n+")"),e||(e=OpenLayers.Util.createUniqueID("OpenLayersDiv")),s||(s="absolute"),OpenLayers.Util.modifyDOMElement(l,e,t,i,s,a,r,o),l},OpenLayers.Util.createImage=function(e,t,i,n,s,a,r,o){function l(){u.style.display="",OpenLayers.Event.stopObservingElement(u)}var u=document.createElement("img");return e||(e=OpenLayers.Util.createUniqueID("OpenLayersDiv")),s||(s="relative"),OpenLayers.Util.modifyDOMElement(u,e,t,i,s,a,null,r),o&&(u.style.display="none",OpenLayers.Event.observe(u,"load",l),OpenLayers.Event.observe(u,"error",l)),u.style.alt=e,u.galleryImg="no",n&&(u.src=n),u},OpenLayers.IMAGE_RELOAD_ATTEMPTS=0,OpenLayers.Util.alphaHackNeeded=null,OpenLayers.Util.alphaHack=function(){if(null==OpenLayers.Util.alphaHackNeeded){var e=navigator.appVersion.split("MSIE"),t=parseFloat(e[1]),i=!1;try{i=!!document.body.filters}catch(n){}OpenLayers.Util.alphaHackNeeded=i&&t>=5.5&&7>t}return OpenLayers.Util.alphaHackNeeded},OpenLayers.Util.modifyAlphaImageDiv=function(e,t,i,n,s,a,r,o,l){OpenLayers.Util.modifyDOMElement(e,t,i,n,a,null,null,l);var u=e.childNodes[0];s&&(u.src=s),OpenLayers.Util.modifyDOMElement(u,e.id+"_innerImage",null,n,"relative",r),OpenLayers.Util.alphaHack()&&("none"!=e.style.display&&(e.style.display="inline-block"),null==o&&(o="scale"),e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+u.src+"', "+"sizingMethod='"+o+"')",parseFloat(e.style.opacity)>=0&&parseFloat(e.style.opacity)<1&&(e.style.filter+=" alpha(opacity="+100*e.style.opacity+")"),u.style.filter="alpha(opacity=0)")},OpenLayers.Util.createAlphaImageDiv=function(e,t,i,n,s,a,r,o,l){var u=OpenLayers.Util.createDiv(),c=OpenLayers.Util.createImage(null,null,null,null,null,null,null,l);return c.className="olAlphaImg",u.appendChild(c),OpenLayers.Util.modifyAlphaImageDiv(u,e,t,i,n,s,a,r,o),u},OpenLayers.Util.upperCaseObject=function(e){var t={};for(var i in e)t[i.toUpperCase()]=e[i];return t},OpenLayers.Util.applyDefaults=function(e,t){e=e||{};var i="function"==typeof window.Event&&t instanceof window.Event;for(var n in t)(void 0===e[n]||!i&&t.hasOwnProperty&&t.hasOwnProperty(n)&&!e.hasOwnProperty(n))&&(e[n]=t[n]);return!i&&t&&t.hasOwnProperty&&t.hasOwnProperty("toString")&&!e.hasOwnProperty("toString")&&(e.toString=t.toString),e},OpenLayers.Util.getParameterString=function(e){var t=[];for(var i in e){var n=e[i];if(null!=n&&"function"!=typeof n){var s;if("object"==typeof n&&n.constructor==Array){for(var a,r=[],o=0,l=n.length;l>o;o++)a=n[o],r.push(encodeURIComponent(null===a||void 0===a?"":a));s=r.join(",")}else s=encodeURIComponent(n);t.push(encodeURIComponent(i)+"="+s)}}return t.join("&")},OpenLayers.Util.urlAppend=function(e,t){var i=e;if(t){var n=(e+" ").split(/[?&]/);i+=" "===n.pop()?t:n.length?"&"+t:"?"+t}return i},OpenLayers.Util.getImagesLocation=function(){return OpenLayers.ImgPath||OpenLayers._getScriptLocation()+"img/"},OpenLayers.Util.getImageLocation=function(e){return OpenLayers.Util.getImagesLocation()+e},OpenLayers.Util.Try=function(){for(var e=null,t=0,i=arguments.length;i>t;t++){var n=arguments[t];try{e=n();break}catch(s){}}return e},OpenLayers.Util.getXmlNodeValue=function(e){var t=null;return OpenLayers.Util.Try(function(){t=e.text,t||(t=e.textContent),t||(t=e.firstChild.nodeValue)},function(){t=e.textContent}),t},OpenLayers.Util.mouseLeft=function(e,t){for(var i=e.relatedTarget?e.relatedTarget:e.toElement;i!=t&&null!=i;)i=i.parentNode;return i!=t},OpenLayers.Util.DEFAULT_PRECISION=14,OpenLayers.Util.toFloat=function(e,t){return null==t&&(t=OpenLayers.Util.DEFAULT_PRECISION),"number"!=typeof e&&(e=parseFloat(e)),0===t?e:parseFloat(e.toPrecision(t))},OpenLayers.Util.rad=function(e){return e*Math.PI/180},OpenLayers.Util.deg=function(e){return 180*e/Math.PI},OpenLayers.Util.VincentyConstants={a:6378137,b:6356752.3142,f:1/298.257223563},OpenLayers.Util.distVincenty=function(e,t){for(var i=OpenLayers.Util.VincentyConstants,n=i.a,s=i.b,a=i.f,r=OpenLayers.Util.rad(t.lon-e.lon),o=Math.atan((1-a)*Math.tan(OpenLayers.Util.rad(e.lat))),l=Math.atan((1-a)*Math.tan(OpenLayers.Util.rad(t.lat))),u=Math.sin(o),c=Math.cos(o),h=Math.sin(l),d=Math.cos(l),p=r,f=2*Math.PI,m=20;Math.abs(p-f)>1e-12&&--m>0;){var g=Math.sin(p),y=Math.cos(p),v=Math.sqrt(d*g*d*g+(c*h-u*d*y)*(c*h-u*d*y));if(0==v)return 0;var b=u*h+c*d*y,_=Math.atan2(v,b),w=Math.asin(c*d*g/v),L=Math.cos(w)*Math.cos(w),k=b-2*u*h/L,O=a/16*L*(4+a*(4-3*L));f=p,p=r+(1-O)*a*Math.sin(w)*(_+O*v*(k+O*b*(-1+2*k*k)))}if(0==m)return 0/0;var x=L*(n*n-s*s)/(s*s),S=1+x/16384*(4096+x*(-768+x*(320-175*x))),C=x/1024*(256+x*(-128+x*(74-47*x))),M=C*v*(k+C/4*(b*(-1+2*k*k)-C/6*k*(-3+4*v*v)*(-3+4*k*k))),P=s*S*(_-M),E=P.toFixed(3)/1e3;return E},OpenLayers.Util.destinationVincenty=function(e,t,i){for(var n=OpenLayers.Util,s=n.VincentyConstants,a=s.a,r=s.b,o=s.f,l=e.lon,u=e.lat,c=i,h=n.rad(t),d=Math.sin(h),p=Math.cos(h),f=(1-o)*Math.tan(n.rad(u)),m=1/Math.sqrt(1+f*f),g=f*m,y=Math.atan2(f,p),v=m*d,b=1-v*v,_=b*(a*a-r*r)/(r*r),w=1+_/16384*(4096+_*(-768+_*(320-175*_))),L=_/1024*(256+_*(-128+_*(74-47*_))),k=c/(r*w),O=2*Math.PI;Math.abs(k-O)>1e-12;){var x=Math.cos(2*y+k),S=Math.sin(k),C=Math.cos(k),M=L*S*(x+L/4*(C*(-1+2*x*x)-L/6*x*(-3+4*S*S)*(-3+4*x*x)));O=k,k=c/(r*w)+M}var P=g*S-m*C*p,E=Math.atan2(g*C+m*S*p,(1-o)*Math.sqrt(v*v+P*P)),j=Math.atan2(S*d,m*C-g*S*p),N=o/16*b*(4+o*(4-3*b)),z=j-(1-N)*o*v*(k+N*S*(x+N*C*(-1+2*x*x)));return Math.atan2(v,-P),new OpenLayers.LonLat(l+n.deg(z),n.deg(E))},OpenLayers.Util.getParameters=function(e){e=null===e||void 0===e?window.location.href:e;var t="";if(OpenLayers.String.contains(e,"?")){var i=e.indexOf("?")+1,n=OpenLayers.String.contains(e,"#")?e.indexOf("#"):e.length;t=e.substring(i,n)}for(var s={},a=t.split(/[&;]/),r=0,o=a.length;o>r;++r){var l=a[r].split("=");if(l[0]){var u=l[0];try{u=decodeURIComponent(u)}catch(c){u=unescape(u)}var h=(l[1]||"").replace(/\+/g," ");try{h=decodeURIComponent(h)}catch(c){h=unescape(h)}h=h.split(","),1==h.length&&(h=h[0]),s[u]=h}}return s},OpenLayers.Util.lastSeqID=0,OpenLayers.Util.createUniqueID=function(e){return null==e&&(e="id_"),OpenLayers.Util.lastSeqID+=1,e+OpenLayers.Util.lastSeqID},OpenLayers.INCHES_PER_UNIT={inches:1,ft:12,mi:63360,m:39.3701,km:39370.1,dd:4374754,yd:36},OpenLayers.INCHES_PER_UNIT["in"]=OpenLayers.INCHES_PER_UNIT.inches,OpenLayers.INCHES_PER_UNIT.degrees=OpenLayers.INCHES_PER_UNIT.dd,OpenLayers.INCHES_PER_UNIT.nmi=1852*OpenLayers.INCHES_PER_UNIT.m,OpenLayers.METERS_PER_INCH=.0254000508001016,OpenLayers.Util.extend(OpenLayers.INCHES_PER_UNIT,{Inch:OpenLayers.INCHES_PER_UNIT.inches,Meter:1/OpenLayers.METERS_PER_INCH,Foot:.3048006096012192/OpenLayers.METERS_PER_INCH,IFoot:.3048/OpenLayers.METERS_PER_INCH,ClarkeFoot:.3047972651151/OpenLayers.METERS_PER_INCH,SearsFoot:.30479947153867626/OpenLayers.METERS_PER_INCH,GoldCoastFoot:.3047997101815088/OpenLayers.METERS_PER_INCH,IInch:.0254/OpenLayers.METERS_PER_INCH,MicroInch:254e-7/OpenLayers.METERS_PER_INCH,Mil:2.54e-8/OpenLayers.METERS_PER_INCH,Centimeter:.01/OpenLayers.METERS_PER_INCH,Kilometer:1e3/OpenLayers.METERS_PER_INCH,Yard:.9144018288036576/OpenLayers.METERS_PER_INCH,SearsYard:.914398414616029/OpenLayers.METERS_PER_INCH,IndianYard:.9143985307444408/OpenLayers.METERS_PER_INCH,IndianYd37:.91439523/OpenLayers.METERS_PER_INCH,IndianYd62:.9143988/OpenLayers.METERS_PER_INCH,IndianYd75:.9143985/OpenLayers.METERS_PER_INCH,IndianFoot:.30479951/OpenLayers.METERS_PER_INCH,IndianFt37:.30479841/OpenLayers.METERS_PER_INCH,IndianFt62:.3047996/OpenLayers.METERS_PER_INCH,IndianFt75:.3047995/OpenLayers.METERS_PER_INCH,Mile:1609.3472186944373/OpenLayers.METERS_PER_INCH,IYard:.9144/OpenLayers.METERS_PER_INCH,IMile:1609.344/OpenLayers.METERS_PER_INCH,NautM:1852/OpenLayers.METERS_PER_INCH,"Lat-66":110943.31648893273/OpenLayers.METERS_PER_INCH,"Lat-83":110946.25736872235/OpenLayers.METERS_PER_INCH,Decimeter:.1/OpenLayers.METERS_PER_INCH,Millimeter:.001/OpenLayers.METERS_PER_INCH,Dekameter:10/OpenLayers.METERS_PER_INCH,Decameter:10/OpenLayers.METERS_PER_INCH,Hectometer:100/OpenLayers.METERS_PER_INCH,GermanMeter:1.0000135965/OpenLayers.METERS_PER_INCH,CaGrid:.999738/OpenLayers.METERS_PER_INCH,ClarkeChain:20.1166194976/OpenLayers.METERS_PER_INCH,GunterChain:20.11684023368047/OpenLayers.METERS_PER_INCH,BenoitChain:20.116782494375872/OpenLayers.METERS_PER_INCH,SearsChain:20.11676512155/OpenLayers.METERS_PER_INCH,ClarkeLink:.201166194976/OpenLayers.METERS_PER_INCH,GunterLink:.2011684023368047/OpenLayers.METERS_PER_INCH,BenoitLink:.20116782494375873/OpenLayers.METERS_PER_INCH,SearsLink:.2011676512155/OpenLayers.METERS_PER_INCH,Rod:5.02921005842012/OpenLayers.METERS_PER_INCH,IntnlChain:20.1168/OpenLayers.METERS_PER_INCH,IntnlLink:.201168/OpenLayers.METERS_PER_INCH,Perch:5.02921005842012/OpenLayers.METERS_PER_INCH,Pole:5.02921005842012/OpenLayers.METERS_PER_INCH,Furlong:201.1684023368046/OpenLayers.METERS_PER_INCH,Rood:3.778266898/OpenLayers.METERS_PER_INCH,CapeFoot:.3047972615/OpenLayers.METERS_PER_INCH,Brealey:375/OpenLayers.METERS_PER_INCH,ModAmFt:.304812252984506/OpenLayers.METERS_PER_INCH,Fathom:1.8288/OpenLayers.METERS_PER_INCH,"NautM-UK":1853.184/OpenLayers.METERS_PER_INCH,"50kilometers":5e4/OpenLayers.METERS_PER_INCH,"150kilometers":15e4/OpenLayers.METERS_PER_INCH}),OpenLayers.Util.extend(OpenLayers.INCHES_PER_UNIT,{mm:OpenLayers.INCHES_PER_UNIT.Meter/1e3,cm:OpenLayers.INCHES_PER_UNIT.Meter/100,dm:100*OpenLayers.INCHES_PER_UNIT.Meter,km:1e3*OpenLayers.INCHES_PER_UNIT.Meter,kmi:OpenLayers.INCHES_PER_UNIT.nmi,fath:OpenLayers.INCHES_PER_UNIT.Fathom,ch:OpenLayers.INCHES_PER_UNIT.IntnlChain,link:OpenLayers.INCHES_PER_UNIT.IntnlLink,"us-in":OpenLayers.INCHES_PER_UNIT.inches,"us-ft":OpenLayers.INCHES_PER_UNIT.Foot,"us-yd":OpenLayers.INCHES_PER_UNIT.Yard,"us-ch":OpenLayers.INCHES_PER_UNIT.GunterChain,"us-mi":OpenLayers.INCHES_PER_UNIT.Mile,"ind-yd":OpenLayers.INCHES_PER_UNIT.IndianYd37,"ind-ft":OpenLayers.INCHES_PER_UNIT.IndianFt37,"ind-ch":20.11669506/OpenLayers.METERS_PER_INCH}),OpenLayers.DOTS_PER_INCH=72,OpenLayers.Util.normalizeScale=function(e){var t=e>1?1/e:e;return t},OpenLayers.Util.getResolutionFromScale=function(e,t){var i;if(e){null==t&&(t="degrees");var n=OpenLayers.Util.normalizeScale(e);i=1/(n*OpenLayers.INCHES_PER_UNIT[t]*OpenLayers.DOTS_PER_INCH)}return i},OpenLayers.Util.getScaleFromResolution=function(e,t){null==t&&(t="degrees");var i=e*OpenLayers.INCHES_PER_UNIT[t]*OpenLayers.DOTS_PER_INCH;return i},OpenLayers.Util.pagePosition=function(e){var t=[0,0],i=OpenLayers.Util.getViewportElement();if(!e||e==window||e==i)return t;var n,s=OpenLayers.IS_GECKO&&document.getBoxObjectFor&&"absolute"==OpenLayers.Element.getStyle(e,"position")&&(""==e.style.top||""==e.style.left),a=null;if(e.getBoundingClientRect){n=e.getBoundingClientRect();var r=i.scrollTop,o=i.scrollLeft;t[0]=n.left+o,t[1]=n.top+r}else if(document.getBoxObjectFor&&!s){n=document.getBoxObjectFor(e);var l=document.getBoxObjectFor(i);t[0]=n.screenX-l.screenX,t[1]=n.screenY-l.screenY}else{if(t[0]=e.offsetLeft,t[1]=e.offsetTop,a=e.offsetParent,a!=e)for(;a;)t[0]+=a.offsetLeft,t[1]+=a.offsetTop,a=a.offsetParent;var u=OpenLayers.BROWSER_NAME;for(("opera"==u||"safari"==u&&"absolute"==OpenLayers.Element.getStyle(e,"position"))&&(t[1]-=document.body.offsetTop),a=e.offsetParent;a&&a!=document.body;)t[0]-=a.scrollLeft,("opera"!=u||"TR"!=a.tagName)&&(t[1]-=a.scrollTop),a=a.offsetParent}return t},OpenLayers.Util.getViewportElement=function(){var e=arguments.callee.viewportElement;return void 0==e&&(e="msie"==OpenLayers.BROWSER_NAME&&"CSS1Compat"!=document.compatMode?document.body:document.documentElement,arguments.callee.viewportElement=e),e},OpenLayers.Util.isEquivalentUrl=function(e,t,i){i=i||{},OpenLayers.Util.applyDefaults(i,{ignoreCase:!0,ignorePort80:!0,ignoreHash:!0});var n=OpenLayers.Util.createUrlObject(e,i),s=OpenLayers.Util.createUrlObject(t,i);for(var a in n)if("args"!==a&&n[a]!=s[a])return!1;for(var a in n.args){if(n.args[a]!=s.args[a])return!1;delete s.args[a]}for(var a in s.args)return!1;return!0},OpenLayers.Util.createUrlObject=function(e,t){if(t=t||{},!/^\w+:\/\//.test(e)){var i=window.location,n=i.port?":"+i.port:"",s=i.protocol+"//"+i.host.split(":").shift()+n;if(0===e.indexOf("/"))e=s+e;else{var a=i.pathname.split("/");a.pop(),e=s+a.join("/")+"/"+e}}t.ignoreCase&&(e=e.toLowerCase());var r=document.createElement("a");r.href=e;var o={};o.host=r.host.split(":").shift(),o.protocol=r.protocol,o.port=t.ignorePort80?"80"==r.port||"0"==r.port?"":r.port:""==r.port||"0"==r.port?"80":r.port,o.hash=t.ignoreHash||"#"===r.hash?"":r.hash;var l=r.search;if(!l){var u=e.indexOf("?");l=-1!=u?e.substr(u):""}return o.args=OpenLayers.Util.getParameters(l),o.pathname="/"==r.pathname.charAt(0)?r.pathname:"/"+r.pathname,o},OpenLayers.Util.removeTail=function(e){var t=null,i=e.indexOf("?"),n=e.indexOf("#");return t=-1==i?-1!=n?e.substr(0,n):e:-1!=n?e.substr(0,Math.min(i,n)):e.substr(0,i)},OpenLayers.IS_GECKO=function(){var e=navigator.userAgent.toLowerCase();return-1==e.indexOf("webkit")&&-1!=e.indexOf("gecko")}(),OpenLayers.CANVAS_SUPPORTED=function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}(),OpenLayers.BROWSER_NAME=function(){var e="",t=navigator.userAgent.toLowerCase();return-1!=t.indexOf("opera")?e="opera":-1!=t.indexOf("msie")?e="msie":-1!=t.indexOf("safari")?e="safari":-1!=t.indexOf("mozilla")&&(e=-1!=t.indexOf("firefox")?"firefox":"mozilla"),e}(),OpenLayers.Util.getBrowserName=function(){return OpenLayers.BROWSER_NAME},OpenLayers.Util.getRenderedDimensions=function(e,t,i){var n,s,a=document.createElement("div");a.style.visibility="hidden";for(var r=i&&i.containerElement?i.containerElement:document.body,o=!1,l=null,u=r;u&&"body"!=u.tagName.toLowerCase();){var c=OpenLayers.Element.getStyle(u,"position");if("absolute"==c){o=!0;break}if(c&&"static"!=c)break;u=u.parentNode}!o||0!==r.clientHeight&&0!==r.clientWidth||(l=document.createElement("div"),l.style.visibility="hidden",l.style.position="absolute",l.style.overflow="visible",l.style.width=document.body.clientWidth+"px",l.style.height=document.body.clientHeight+"px",l.appendChild(a)),a.style.position="absolute",t&&(t.w?(n=t.w,a.style.width=n+"px"):t.h&&(s=t.h,a.style.height=s+"px")),i&&i.displayClass&&(a.className=i.displayClass);var h=document.createElement("div");if(h.innerHTML=e,h.style.overflow="visible",h.childNodes)for(var d=0,p=h.childNodes.length;p>d;d++)h.childNodes[d].style&&(h.childNodes[d].style.overflow="visible");return a.appendChild(h),l?r.appendChild(l):r.appendChild(a),n||(n=parseInt(h.scrollWidth),a.style.width=n+"px"),s||(s=parseInt(h.scrollHeight)),a.removeChild(h),l?(l.removeChild(a),r.removeChild(l)):r.removeChild(a),new OpenLayers.Size(n,s)},OpenLayers.Util.getScrollbarWidth=function(){var e=OpenLayers.Util._scrollbarWidth;if(null==e){var t=null,i=null,n=0,s=0;t=document.createElement("div"),t.style.position="absolute",t.style.top="-1000px",t.style.left="-1000px",t.style.width="100px",t.style.height="50px",t.style.overflow="hidden",i=document.createElement("div"),i.style.width="100%",i.style.height="200px",t.appendChild(i),document.body.appendChild(t),n=i.offsetWidth,t.style.overflow="scroll",s=i.offsetWidth,document.body.removeChild(document.body.lastChild),OpenLayers.Util._scrollbarWidth=n-s,e=OpenLayers.Util._scrollbarWidth}return e},OpenLayers.Util.getFormattedLonLat=function(e,t,i){i||(i="dms"),e=(e+540)%360-180;var n=Math.abs(e),s=Math.floor(n),a=(n-s)/(1/60),r=a;a=Math.floor(a);var o=(r-a)/(1/60);o=Math.round(10*o),o/=10,o>=60&&(o-=60,a+=1,a>=60&&(a-=60,s+=1)),10>s&&(s="0"+s);var l=s+"°";return i.indexOf("dm")>=0&&(10>a&&(a="0"+a),l+=a+"'",i.indexOf("dms")>=0&&(10>o&&(o="0"+o),l+=o+'"')),l+="lon"==t?0>e?OpenLayers.i18n("W"):OpenLayers.i18n("E"):0>e?OpenLayers.i18n("S"):OpenLayers.i18n("N")},OpenLayers.Animation=function(e){function t(e,t,i){t=t>0?t:Number.POSITIVE_INFINITY;var n=++a,o=+new Date;return r[n]=function(){r[n]&&+new Date-o<=t?(e(),r[n]&&s(r[n],i)):delete r[n]},s(r[n],i),n}function i(e){delete r[e]}var n=!!(e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame),s=function(){var t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(t){e.setTimeout(t,16)};return function(i,n){t.apply(e,[i,n])}}(),a=0,r={};return{isNative:n,requestFrame:s,start:t,stop:i}}(window),OpenLayers.String={startsWith:function(e,t){return 0==e.indexOf(t)},contains:function(e,t){return-1!=e.indexOf(t)},trim:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},camelize:function(e){for(var t=e.split("-"),i=t[0],n=1,s=t.length;s>n;n++){var a=t[n];i+=a.charAt(0).toUpperCase()+a.substring(1)}return i},format:function(e,t,i){t||(t=window);var n=function(e,n){for(var s,a=n.split(/\.+/),r=0;r<a.length;r++)0==r&&(s=t),s=s[a[r]];return"function"==typeof s&&(s=i?s.apply(null,i):s()),"undefined"==typeof s?"undefined":s};return e.replace(OpenLayers.String.tokenRegEx,n)},tokenRegEx:/\$\{([\w.]+?)\}/g,numberRegEx:/^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/,isNumeric:function(e){return OpenLayers.String.numberRegEx.test(e)},numericIf:function(e){return OpenLayers.String.isNumeric(e)?parseFloat(e):e}},OpenLayers.Number={decimalSeparator:".",thousandsSeparator:",",limitSigDigs:function(e,t){var i=0;return t>0&&(i=parseFloat(e.toPrecision(t))),i},format:function(e,t,i,n){t="undefined"!=typeof t?t:0,i="undefined"!=typeof i?i:OpenLayers.Number.thousandsSeparator,n="undefined"!=typeof n?n:OpenLayers.Number.decimalSeparator,null!=t&&(e=parseFloat(e.toFixed(t)));var s=e.toString().split(".");1==s.length&&null==t&&(t=0);var a=s[0];if(i)for(var r=/(-?[0-9]+)([0-9]{3})/;r.test(a);)a=a.replace(r,"$1"+i+"$2");var o;if(0==t)o=a;else{var l=s.length>1?s[1]:"0";null!=t&&(l+=new Array(t-l.length+1).join("0")),o=a+n+l}return o}},OpenLayers.Function={bind:function(e,t){var i=Array.prototype.slice.apply(arguments,[2]);return function(){var n=i.concat(Array.prototype.slice.apply(arguments,[0]));return e.apply(t,n)}},bindAsEventListener:function(e,t){return function(i){return e.call(t,i||window.event)}},False:function(){return!1},True:function(){return!0},Void:function(){}},OpenLayers.Array={filter:function(e,t,i){var n=[];if(Array.prototype.filter)n=e.filter(t,i);else{var s=e.length;if("function"!=typeof t)throw new TypeError;for(var a=0;s>a;a++)if(a in e){var r=e[a];t.call(i,r,a,e)&&n.push(r)}}return n}},OpenLayers.Bounds=OpenLayers.Class({left:null,bottom:null,right:null,top:null,centerLonLat:null,initialize:function(e,t,i,n){OpenLayers.Util.isArray(e)&&(n=e[3],i=e[2],t=e[1],e=e[0]),null!=e&&(this.left=OpenLayers.Util.toFloat(e)),null!=t&&(this.bottom=OpenLayers.Util.toFloat(t)),null!=i&&(this.right=OpenLayers.Util.toFloat(i)),null!=n&&(this.top=OpenLayers.Util.toFloat(n))},clone:function(){return new OpenLayers.Bounds(this.left,this.bottom,this.right,this.top)},equals:function(e){var t=!1;return null!=e&&(t=this.left==e.left&&this.right==e.right&&this.top==e.top&&this.bottom==e.bottom),t},toString:function(){return[this.left,this.bottom,this.right,this.top].join(",")},toArray:function(e){return e===!0?[this.bottom,this.left,this.top,this.right]:[this.left,this.bottom,this.right,this.top]},toBBOX:function(e,t){null==e&&(e=6);var i=Math.pow(10,e),n=Math.round(this.left*i)/i,s=Math.round(this.bottom*i)/i,a=Math.round(this.right*i)/i,r=Math.round(this.top*i)/i;return t===!0?s+","+n+","+r+","+a:n+","+s+","+a+","+r},toGeometry:function(){return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(this.left,this.bottom),new OpenLayers.Geometry.Point(this.right,this.bottom),new OpenLayers.Geometry.Point(this.right,this.top),new OpenLayers.Geometry.Point(this.left,this.top)])])},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},getSize:function(){return new OpenLayers.Size(this.getWidth(),this.getHeight())},getCenterPixel:function(){return new OpenLayers.Pixel((this.left+this.right)/2,(this.bottom+this.top)/2)},getCenterLonLat:function(){return this.centerLonLat||(this.centerLonLat=new OpenLayers.LonLat((this.left+this.right)/2,(this.bottom+this.top)/2)),this.centerLonLat},scale:function(e,t){null==t&&(t=this.getCenterLonLat());var i,n;"OpenLayers.LonLat"==t.CLASS_NAME?(i=t.lon,n=t.lat):(i=t.x,n=t.y);var s=(this.left-i)*e+i,a=(this.bottom-n)*e+n,r=(this.right-i)*e+i,o=(this.top-n)*e+n;return new OpenLayers.Bounds(s,a,r,o)},add:function(e,t){if(null==e||null==t)throw new TypeError("Bounds.add cannot receive null values");return new OpenLayers.Bounds(this.left+e,this.bottom+t,this.right+e,this.top+t)},extend:function(e){var t=null;if(e){switch(e.CLASS_NAME){case"OpenLayers.LonLat":t=new OpenLayers.Bounds(e.lon,e.lat,e.lon,e.lat);break;case"OpenLayers.Geometry.Point":t=new OpenLayers.Bounds(e.x,e.y,e.x,e.y);break;case"OpenLayers.Bounds":t=e}t&&(this.centerLonLat=null,(null==this.left||t.left<this.left)&&(this.left=t.left),(null==this.bottom||t.bottom<this.bottom)&&(this.bottom=t.bottom),(null==this.right||t.right>this.right)&&(this.right=t.right),(null==this.top||t.top>this.top)&&(this.top=t.top))}},containsLonLat:function(e,t){"boolean"==typeof t&&(t={inclusive:t}),t=t||{};var i=this.contains(e.lon,e.lat,t.inclusive),n=t.worldBounds;if(n&&!i){var s=n.getWidth(),a=(n.left+n.right)/2,r=Math.round((e.lon-a)/s);i=this.containsLonLat({lon:e.lon-r*s,lat:e.lat},{inclusive:t.inclusive})}return i},containsPixel:function(e,t){return this.contains(e.x,e.y,t)},contains:function(e,t,i){if(null==i&&(i=!0),null==e||null==t)return!1;e=OpenLayers.Util.toFloat(e),t=OpenLayers.Util.toFloat(t);var n=!1;return n=i?e>=this.left&&e<=this.right&&t>=this.bottom&&t<=this.top:e>this.left&&e<this.right&&t>this.bottom&&t<this.top},intersectsBounds:function(e,t){if("boolean"==typeof t&&(t={inclusive:t}),t=t||{},t.worldBounds){var i=this.wrapDateLine(t.worldBounds);e=e.wrapDateLine(t.worldBounds)}else i=this;null==t.inclusive&&(t.inclusive=!0);var n=!1,s=i.left==e.right||i.right==e.left||i.top==e.bottom||i.bottom==e.top;if(t.inclusive||!s){var a=e.bottom>=i.bottom&&e.bottom<=i.top||i.bottom>=e.bottom&&i.bottom<=e.top,r=e.top>=i.bottom&&e.top<=i.top||i.top>e.bottom&&i.top<e.top,o=e.left>=i.left&&e.left<=i.right||i.left>=e.left&&i.left<=e.right,l=e.right>=i.left&&e.right<=i.right||i.right>=e.left&&i.right<=e.right;n=(a||r)&&(o||l)}if(t.worldBounds&&!n){var u=t.worldBounds,c=u.getWidth(),h=!u.containsBounds(i),d=!u.containsBounds(e);h&&!d?(e=e.add(-c,0),n=i.intersectsBounds(e,{inclusive:t.inclusive})):d&&!h&&(i=i.add(-c,0),n=e.intersectsBounds(i,{inclusive:t.inclusive}))}return n},containsBounds:function(e,t,i){null==t&&(t=!1),null==i&&(i=!0);var n=this.contains(e.left,e.bottom,i),s=this.contains(e.right,e.bottom,i),a=this.contains(e.left,e.top,i),r=this.contains(e.right,e.top,i);return t?n||s||a||r:n&&s&&a&&r},determineQuadrant:function(e){var t="",i=this.getCenterLonLat();return t+=e.lat<i.lat?"b":"t",t+=e.lon<i.lon?"l":"r"},transform:function(e,t){this.centerLonLat=null;var i=OpenLayers.Projection.transform({x:this.left,y:this.bottom},e,t),n=OpenLayers.Projection.transform({x:this.right,y:this.bottom},e,t),s=OpenLayers.Projection.transform({x:this.left,y:this.top},e,t),a=OpenLayers.Projection.transform({x:this.right,y:this.top},e,t);return this.left=Math.min(i.x,s.x),this.bottom=Math.min(i.y,n.y),this.right=Math.max(n.x,a.x),this.top=Math.max(s.y,a.y),this},wrapDateLine:function(e,t){t=t||{};var i=t.leftTolerance||0,n=t.rightTolerance||0,s=this.clone();if(e){for(var a=e.getWidth();s.left<e.left&&s.right-n<=e.left;)s=s.add(a,0);for(;s.left+i>=e.right&&s.right>e.right;)s=s.add(-a,0);var r=s.left+i;r<e.right&&r>e.left&&s.right-n>e.right&&(s=s.add(-a,0))}return s},CLASS_NAME:"OpenLayers.Bounds"}),OpenLayers.Bounds.fromString=function(e,t){var i=e.split(",");return OpenLayers.Bounds.fromArray(i,t)},OpenLayers.Bounds.fromArray=function(e,t){return t===!0?new OpenLayers.Bounds(e[1],e[0],e[3],e[2]):new OpenLayers.Bounds(e[0],e[1],e[2],e[3])},OpenLayers.Bounds.fromSize=function(e){return new OpenLayers.Bounds(0,e.h,e.w,0)},OpenLayers.Bounds.oppositeQuadrant=function(e){var t="";return t+="t"==e.charAt(0)?"b":"t",t+="l"==e.charAt(1)?"r":"l"},OpenLayers.Element={visible:function(e){return"none"!=OpenLayers.Util.getElement(e).style.display},toggle:function(){for(var e=0,t=arguments.length;t>e;e++){var i=OpenLayers.Util.getElement(arguments[e]),n=OpenLayers.Element.visible(i)?"none":"";i.style.display=n}},remove:function(e){e=OpenLayers.Util.getElement(e),e.parentNode.removeChild(e)},getHeight:function(e){return e=OpenLayers.Util.getElement(e),e.offsetHeight},hasClass:function(e,t){var i=e.className;return!!i&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(i)},addClass:function(e,t){return OpenLayers.Element.hasClass(e,t)||(e.className+=(e.className?" ":"")+t),e},removeClass:function(e,t){var i=e.className;return i&&(e.className=OpenLayers.String.trim(i.replace(new RegExp("(^|\\s+)"+t+"(\\s+|$)")," "))),e},toggleClass:function(e,t){return OpenLayers.Element.hasClass(e,t)?OpenLayers.Element.removeClass(e,t):OpenLayers.Element.addClass(e,t),e},getStyle:function(e,t){e=OpenLayers.Util.getElement(e);var i=null;if(e&&e.style){if(i=e.style[OpenLayers.String.camelize(t)],!i)if(document.defaultView&&document.defaultView.getComputedStyle){var n=document.defaultView.getComputedStyle(e,null);i=n?n.getPropertyValue(t):null}else e.currentStyle&&(i=e.currentStyle[OpenLayers.String.camelize(t)]);var s=["left","top","right","bottom"];window.opera&&-1!=OpenLayers.Util.indexOf(s,t)&&"static"==OpenLayers.Element.getStyle(e,"position")&&(i="auto")}return"auto"==i?null:i}},OpenLayers.LonLat=OpenLayers.Class({lon:0,lat:0,initialize:function(e,t){OpenLayers.Util.isArray(e)&&(t=e[1],e=e[0]),this.lon=OpenLayers.Util.toFloat(e),this.lat=OpenLayers.Util.toFloat(t)},toString:function(){return"lon="+this.lon+",lat="+this.lat},toShortString:function(){return this.lon+", "+this.lat},clone:function(){return new OpenLayers.LonLat(this.lon,this.lat)},add:function(e,t){if(null==e||null==t)throw new TypeError("LonLat.add cannot receive null values");return new OpenLayers.LonLat(this.lon+OpenLayers.Util.toFloat(e),this.lat+OpenLayers.Util.toFloat(t))},equals:function(e){var t=!1;return null!=e&&(t=this.lon==e.lon&&this.lat==e.lat||isNaN(this.lon)&&isNaN(this.lat)&&isNaN(e.lon)&&isNaN(e.lat)),t},transform:function(e,t){var i=OpenLayers.Projection.transform({x:this.lon,y:this.lat},e,t);return this.lon=i.x,this.lat=i.y,this},wrapDateLine:function(e){var t=this.clone();if(e){for(;t.lon<e.left;)t.lon+=e.getWidth();for(;t.lon>e.right;)t.lon-=e.getWidth()}return t},CLASS_NAME:"OpenLayers.LonLat"}),OpenLayers.LonLat.fromString=function(e){var t=e.split(",");return new OpenLayers.LonLat(t[0],t[1])},OpenLayers.LonLat.fromArray=function(e){var t=OpenLayers.Util.isArray(e),i=t&&e[0],n=t&&e[1];return new OpenLayers.LonLat(i,n)},OpenLayers.Pixel=OpenLayers.Class({x:0,y:0,initialize:function(e,t){this.x=parseFloat(e),this.y=parseFloat(t)},toString:function(){return"x="+this.x+",y="+this.y},clone:function(){return new OpenLayers.Pixel(this.x,this.y)},equals:function(e){var t=!1;return null!=e&&(t=this.x==e.x&&this.y==e.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(e.x)&&isNaN(e.y)),t},distanceTo:function(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))},add:function(e,t){if(null==e||null==t)throw new TypeError("Pixel.add cannot receive null values");return new OpenLayers.Pixel(this.x+e,this.y+t)},offset:function(e){var t=this.clone();return e&&(t=this.add(e.x,e.y)),t},CLASS_NAME:"OpenLayers.Pixel"}),OpenLayers.Size=OpenLayers.Class({w:0,h:0,initialize:function(e,t){this.w=parseFloat(e),this.h=parseFloat(t)},toString:function(){return"w="+this.w+",h="+this.h},clone:function(){return new OpenLayers.Size(this.w,this.h)},equals:function(e){var t=!1;return null!=e&&(t=this.w==e.w&&this.h==e.h||isNaN(this.w)&&isNaN(this.h)&&isNaN(e.w)&&isNaN(e.h)),t},CLASS_NAME:"OpenLayers.Size"}),OpenLayers.Console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},userError:function(e){alert(e)},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){},CLASS_NAME:"OpenLayers.Console"},function(){for(var e=document.getElementsByTagName("script"),t=0,i=e.length;i>t;++t)if(-1!=e[t].src.indexOf("firebug.js")&&console){OpenLayers.Util.extend(OpenLayers.Console,console);break}}(),OpenLayers.Tween=OpenLayers.Class({easing:null,begin:null,finish:null,duration:null,callbacks:null,time:null,animationId:null,playing:!1,initialize:function(e){this.easing=e?e:OpenLayers.Easing.Expo.easeOut},start:function(e,t,i,n){this.playing=!0,this.begin=e,this.finish=t,this.duration=i,this.callbacks=n.callbacks,this.time=0,OpenLayers.Animation.stop(this.animationId),this.animationId=null,this.callbacks&&this.callbacks.start&&this.callbacks.start.call(this,this.begin),this.animationId=OpenLayers.Animation.start(OpenLayers.Function.bind(this.play,this))},stop:function(){this.playing&&(this.callbacks&&this.callbacks.done&&this.callbacks.done.call(this,this.finish),OpenLayers.Animation.stop(this.animationId),this.animationId=null,this.playing=!1)
},play:function(){var e={};for(var t in this.begin){var i=this.begin[t],n=this.finish[t];if(null==i||null==n||isNaN(i)||isNaN(n))throw new TypeError("invalid value for Tween");var s=n-i;e[t]=this.easing.apply(this,[this.time,i,s,this.duration])}this.time++,this.callbacks&&this.callbacks.eachStep&&this.callbacks.eachStep.call(this,e),this.time>this.duration&&this.stop()},CLASS_NAME:"OpenLayers.Tween"}),OpenLayers.Easing={CLASS_NAME:"OpenLayers.Easing"},OpenLayers.Easing.Linear={easeIn:function(e,t,i,n){return i*e/n+t},easeOut:function(e,t,i,n){return i*e/n+t},easeInOut:function(e,t,i,n){return i*e/n+t},CLASS_NAME:"OpenLayers.Easing.Linear"},OpenLayers.Easing.Expo={easeIn:function(e,t,i,n){return 0==e?t:i*Math.pow(2,10*(e/n-1))+t},easeOut:function(e,t,i,n){return e==n?t+i:i*(-Math.pow(2,-10*e/n)+1)+t},easeInOut:function(e,t,i,n){return 0==e?t:e==n?t+i:(e/=n/2)<1?i/2*Math.pow(2,10*(e-1))+t:i/2*(-Math.pow(2,-10*--e)+2)+t},CLASS_NAME:"OpenLayers.Easing.Expo"},OpenLayers.Easing.Quad={easeIn:function(e,t,i,n){return i*(e/=n)*e+t},easeOut:function(e,t,i,n){return-i*(e/=n)*(e-2)+t},easeInOut:function(e,t,i,n){return(e/=n/2)<1?i/2*e*e+t:-i/2*(--e*(e-2)-1)+t},CLASS_NAME:"OpenLayers.Easing.Quad"},OpenLayers.Kinetic=OpenLayers.Class({threshold:0,deceleration:.0035,nbPoints:100,delay:200,points:void 0,timerId:void 0,initialize:function(e){OpenLayers.Util.extend(this,e)},begin:function(){OpenLayers.Animation.stop(this.timerId),this.timerId=void 0,this.points=[]},update:function(e){this.points.unshift({xy:e,tick:(new Date).getTime()}),this.points.length>this.nbPoints&&this.points.pop()},end:function(e){for(var t,i,n=(new Date).getTime(),s=0,a=this.points.length;a>s&&(i=this.points[s],!(n-i.tick>this.delay));s++)t=i;if(t){var r=(new Date).getTime()-t.tick,o=Math.sqrt(Math.pow(e.x-t.xy.x,2)+Math.pow(e.y-t.xy.y,2)),l=o/r;if(!(0==l||l<this.threshold)){var u=Math.asin((e.y-t.xy.y)/o);return t.xy.x<=e.x&&(u=Math.PI-u),{speed:l,theta:u}}}},move:function(e,t){var i=e.speed,n=Math.cos(e.theta),s=-Math.sin(e.theta),a=(new Date).getTime(),r=0,o=0,l=function(){if(null!=this.timerId){var e=(new Date).getTime()-a,l=-this.deceleration*Math.pow(e,2)/2+i*e,u=l*n,c=l*s,h={};h.end=!1;var d=-this.deceleration*e+i;0>=d&&(OpenLayers.Animation.stop(this.timerId),this.timerId=null,h.end=!0),h.x=u-r,h.y=c-o,r=u,o=c,t(h.x,h.y,h.end)}};this.timerId=OpenLayers.Animation.start(OpenLayers.Function.bind(l,this))},CLASS_NAME:"OpenLayers.Kinetic"}),OpenLayers.Event={observers:!1,KEY_SPACE:32,KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,element:function(e){return e.target||e.srcElement},isSingleTouch:function(e){return e.touches&&1==e.touches.length},isMultiTouch:function(e){return e.touches&&e.touches.length>1},isLeftClick:function(e){return e.which&&1==e.which||e.button&&1==e.button},isRightClick:function(e){return e.which&&3==e.which||e.button&&2==e.button},stop:function(e,t){t||(e.preventDefault?e.preventDefault():e.returnValue=!1),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},findElement:function(e,t){for(var i=OpenLayers.Event.element(e);i.parentNode&&(!i.tagName||i.tagName.toUpperCase()!=t.toUpperCase());)i=i.parentNode;return i},observe:function(e,t,i,n){var s=OpenLayers.Util.getElement(e);if(n=n||!1,"keypress"==t&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||s.attachEvent)&&(t="keydown"),this.observers||(this.observers={}),!s._eventCacheID){var a="eventCacheID_";s.id&&(a=s.id+"_"+a),s._eventCacheID=OpenLayers.Util.createUniqueID(a)}var r=s._eventCacheID;this.observers[r]||(this.observers[r]=[]),this.observers[r].push({element:s,name:t,observer:i,useCapture:n}),s.addEventListener?s.addEventListener(t,i,n):s.attachEvent&&s.attachEvent("on"+t,i)},stopObservingElement:function(e){var t=OpenLayers.Util.getElement(e),i=t._eventCacheID;this._removeElementObservers(OpenLayers.Event.observers[i])},_removeElementObservers:function(e){if(e)for(var t=e.length-1;t>=0;t--){var i=e[t],n=new Array(i.element,i.name,i.observer,i.useCapture);OpenLayers.Event.stopObserving.apply(this,n)}},stopObserving:function(e,t,i,n){n=n||!1;var s=OpenLayers.Util.getElement(e),a=s._eventCacheID;"keypress"==t&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||s.detachEvent)&&(t="keydown");var r=!1,o=OpenLayers.Event.observers[a];if(o)for(var l=0;!r&&l<o.length;){var u=o[l];if(u.name==t&&u.observer==i&&u.useCapture==n){o.splice(l,1),0==o.length&&delete OpenLayers.Event.observers[a],r=!0;break}l++}return r&&(s.removeEventListener?s.removeEventListener(t,i,n):s&&s.detachEvent&&s.detachEvent("on"+t,i)),r},unloadCache:function(){if(OpenLayers.Event&&OpenLayers.Event.observers){for(var e in OpenLayers.Event.observers){var t=OpenLayers.Event.observers[e];OpenLayers.Event._removeElementObservers.apply(this,[t])}OpenLayers.Event.observers=!1}},CLASS_NAME:"OpenLayers.Event"},OpenLayers.Event.observe(window,"unload",OpenLayers.Event.unloadCache,!1),OpenLayers.Events=OpenLayers.Class({BROWSER_EVENTS:["mouseover","mouseout","mousedown","mouseup","mousemove","click","dblclick","rightclick","dblrightclick","resize","focus","blur","touchstart","touchmove","touchend","keydown"],listeners:null,object:null,element:null,eventHandler:null,fallThrough:null,includeXY:!1,extensions:null,extensionCount:null,clearMouseListener:null,initialize:function(e,t,i,n,s){OpenLayers.Util.extend(this,s),this.object=e,this.fallThrough=n,this.listeners={},this.extensions={},this.extensionCount={},null!=t&&this.attachToElement(t)},destroy:function(){for(var e in this.extensions)"boolean"!=typeof this.extensions[e]&&this.extensions[e].destroy();this.extensions=null,this.element&&(OpenLayers.Event.stopObservingElement(this.element),this.element.hasScrollEvent&&OpenLayers.Event.stopObserving(window,"scroll",this.clearMouseListener)),this.element=null,this.listeners=null,this.object=null,this.fallThrough=null,this.eventHandler=null},addEventType:function(){},attachToElement:function(e){this.element?OpenLayers.Event.stopObservingElement(this.element):(this.eventHandler=OpenLayers.Function.bindAsEventListener(this.handleBrowserEvent,this),this.clearMouseListener=OpenLayers.Function.bind(this.clearMouseCache,this)),this.element=e;for(var t=0,i=this.BROWSER_EVENTS.length;i>t;t++)OpenLayers.Event.observe(e,this.BROWSER_EVENTS[t],this.eventHandler);OpenLayers.Event.observe(e,"dragstart",OpenLayers.Event.stop)},on:function(e){for(var t in e)"scope"!=t&&e.hasOwnProperty(t)&&this.register(t,e.scope,e[t])},register:function(e,t,i,n){if(e in OpenLayers.Events&&!this.extensions[e]&&(this.extensions[e]=new OpenLayers.Events[e](this)),null!=i){null==t&&(t=this.object);var s=this.listeners[e];s||(s=[],this.listeners[e]=s,this.extensionCount[e]=0);var a={obj:t,func:i};n?(s.splice(this.extensionCount[e],0,a),"object"==typeof n&&n.extension&&this.extensionCount[e]++):s.push(a)}},registerPriority:function(e,t,i){this.register(e,t,i,!0)},un:function(e){for(var t in e)"scope"!=t&&e.hasOwnProperty(t)&&this.unregister(t,e.scope,e[t])},unregister:function(e,t,i){null==t&&(t=this.object);var n=this.listeners[e];if(null!=n)for(var s=0,a=n.length;a>s;s++)if(n[s].obj==t&&n[s].func==i){n.splice(s,1);break}},remove:function(e){null!=this.listeners[e]&&(this.listeners[e]=[])},triggerEvent:function(e,t){var i=this.listeners[e];if(!i||0==i.length)return void 0;null==t&&(t={}),t.object=this.object,t.element=this.element,t.type||(t.type=e),i=i.slice();for(var n,s=0,a=i.length;a>s;s++){var r=i[s];if(n=r.func.apply(r.obj,[t]),void 0!=n&&0==n)break}return this.fallThrough||OpenLayers.Event.stop(t,!0),n},handleBrowserEvent:function(e){var t=e.type,i=this.listeners[t];if(i&&0!=i.length){var n=e.touches;if(n&&n[0]){for(var s,a=0,r=0,o=n.length,l=0;o>l;++l)s=n[l],a+=s.clientX,r+=s.clientY;e.clientX=a/o,e.clientY=r/o}this.includeXY&&(e.xy=this.getMousePosition(e)),this.triggerEvent(t,e)}},clearMouseCache:function(){this.element.scrolls=null,this.element.lefttop=null;var e=document.body;e&&(0==e.scrollTop&&0==e.scrollLeft||!navigator.userAgent.match(/iPhone/i))&&(this.element.offsets=null)},getMousePosition:function(e){if(this.includeXY?this.element.hasScrollEvent||(OpenLayers.Event.observe(window,"scroll",this.clearMouseListener),this.element.hasScrollEvent=!0):this.clearMouseCache(),!this.element.scrolls){var t=OpenLayers.Util.getViewportElement();this.element.scrolls=[t.scrollLeft,t.scrollTop]}return this.element.lefttop||(this.element.lefttop=[document.documentElement.clientLeft||0,document.documentElement.clientTop||0]),this.element.offsets||(this.element.offsets=OpenLayers.Util.pagePosition(this.element)),new OpenLayers.Pixel(e.clientX+this.element.scrolls[0]-this.element.offsets[0]-this.element.lefttop[0],e.clientY+this.element.scrolls[1]-this.element.offsets[1]-this.element.lefttop[1])},CLASS_NAME:"OpenLayers.Events"}),OpenLayers.Events.buttonclick=OpenLayers.Class({target:null,events:["mousedown","mouseup","click","dblclick","touchstart","touchmove","touchend","keydown"],startRegEx:/^mousedown|touchstart$/,cancelRegEx:/^touchmove$/,completeRegEx:/^mouseup|touchend$/,initialize:function(e){this.target=e;for(var t=this.events.length-1;t>=0;--t)this.target.register(this.events[t],this,this.buttonClick,{extension:!0})},destroy:function(){for(var e=this.events.length-1;e>=0;--e)this.target.unregister(this.events[e],this,this.buttonClick);delete this.target},getPressedButton:function(e){var t,i=3;do{if(OpenLayers.Element.hasClass(e,"olButton")){t=e;break}e=e.parentNode}while(--i>0&&e);return t},buttonClick:function(e){var t=!0,i=OpenLayers.Event.element(e);if(i&&(OpenLayers.Event.isLeftClick(e)||!~e.type.indexOf("mouse"))){var n=this.getPressedButton(i);if(n){if("keydown"===e.type)switch(e.keyCode){case OpenLayers.Event.KEY_RETURN:case OpenLayers.Event.KEY_SPACE:this.target.triggerEvent("buttonclick",{buttonElement:n}),OpenLayers.Event.stop(e),t=!1}else if(this.startEvt){if(this.completeRegEx.test(e.type)){var s=OpenLayers.Util.pagePosition(n);this.target.triggerEvent("buttonclick",{buttonElement:n,buttonXY:{x:this.startEvt.clientX-s[0],y:this.startEvt.clientY-s[1]}})}this.cancelRegEx.test(e.type)&&delete this.startEvt,OpenLayers.Event.stop(e),t=!1}this.startRegEx.test(e.type)&&(this.startEvt=e,OpenLayers.Event.stop(e),t=!1)}else delete this.startEvt}return t}}),OpenLayers.ProxyHost="",OpenLayers.Request={DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:void 0,password:void 0,params:null,proxy:OpenLayers.ProxyHost,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},URL_SPLIT_REGEX:/([^:]*:)\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,events:new OpenLayers.Events(this),makeSameOrigin:function(e,t){var i=0!==e.indexOf("http"),n=!i&&e.match(this.URL_SPLIT_REGEX);if(n){var s=window.location;i=n[1]==s.protocol&&n[3]==s.hostname;var a=n[4],r=s.port;(80!=a&&""!=a||"80"!=r&&""!=r)&&(i=i&&a==r)}return i||(t?e="function"==typeof t?t(e):t+encodeURIComponent(e):OpenLayers.Console.warn(OpenLayers.i18n("proxyNeeded"),{url:e})),e},issue:function(e){var t=OpenLayers.Util.extend(this.DEFAULT_CONFIG,{proxy:OpenLayers.ProxyHost});e=OpenLayers.Util.applyDefaults(e,t);var i,n=!1;for(i in e.headers)e.headers.hasOwnProperty(i)&&"x-requested-with"===i.toLowerCase()&&(n=!0);n===!1&&(e.headers["X-Requested-With"]="XMLHttpRequest");var s=new OpenLayers.Request.XMLHttpRequest,a=OpenLayers.Util.urlAppend(e.url,OpenLayers.Util.getParameterString(e.params||{}));a=OpenLayers.Request.makeSameOrigin(a,e.proxy),s.open(e.method,a,e.async,e.user,e.password);for(var r in e.headers)s.setRequestHeader(r,e.headers[r]);var o=this.events,l=this;return s.onreadystatechange=function(){if(s.readyState==OpenLayers.Request.XMLHttpRequest.DONE){var t=o.triggerEvent("complete",{request:s,config:e,requestUrl:a});t!==!1&&l.runCallbacks({request:s,config:e,requestUrl:a})}},e.async===!1?s.send(e.data):window.setTimeout(function(){0!==s.readyState&&s.send(e.data)},0),s},runCallbacks:function(e){var t,i=e.request,n=e.config,s=n.scope?OpenLayers.Function.bind(n.callback,n.scope):n.callback;n.success&&(t=n.scope?OpenLayers.Function.bind(n.success,n.scope):n.success);var a;n.failure&&(a=n.scope?OpenLayers.Function.bind(n.failure,n.scope):n.failure),"file:"==OpenLayers.Util.createUrlObject(n.url).protocol&&i.responseText&&(i.status=200),s(i),(!i.status||i.status>=200&&i.status<300)&&(this.events.triggerEvent("success",e),t&&t(i)),i.status&&(i.status<200||i.status>=300)&&(this.events.triggerEvent("failure",e),a&&a(i))},GET:function(e){return e=OpenLayers.Util.extend(e,{method:"GET"}),OpenLayers.Request.issue(e)},POST:function(e){return e=OpenLayers.Util.extend(e,{method:"POST"}),e.headers=e.headers?e.headers:{},"CONTENT-TYPE"in OpenLayers.Util.upperCaseObject(e.headers)||(e.headers["Content-Type"]="application/xml"),OpenLayers.Request.issue(e)},PUT:function(e){return e=OpenLayers.Util.extend(e,{method:"PUT"}),e.headers=e.headers?e.headers:{},"CONTENT-TYPE"in OpenLayers.Util.upperCaseObject(e.headers)||(e.headers["Content-Type"]="application/xml"),OpenLayers.Request.issue(e)},DELETE:function(e){return e=OpenLayers.Util.extend(e,{method:"DELETE"}),OpenLayers.Request.issue(e)},HEAD:function(e){return e=OpenLayers.Util.extend(e,{method:"HEAD"}),OpenLayers.Request.issue(e)},OPTIONS:function(e){return e=OpenLayers.Util.extend(e,{method:"OPTIONS"}),OpenLayers.Request.issue(e)}},function(){function e(){this._object=o&&!c?new o:new window.ActiveXObject("Microsoft.XMLHTTP"),this._listeners=[]}function t(){return new e}function i(e){if(e._object.send(e._data),l&&!e._async)for(e.readyState=t.OPENED,a(e);e.readyState<t.DONE;)if(e.readyState++,n(e),e._aborted)return}function n(e){t.onreadystatechange&&t.onreadystatechange.apply(e),e.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function s(e){var t=e.responseXML,i=e.responseText;return u&&i&&t&&!t.documentElement&&e.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)&&(t=new window.ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.validateOnParse=!1,t.loadXML(i)),t&&(u&&0!=t.parseError||!t.documentElement||t.documentElement&&"parsererror"==t.documentElement.tagName)?null:t}function a(e){try{e.responseText=e._object.responseText}catch(t){}try{e.responseXML=s(e._object)}catch(t){}try{e.status=e._object.status}catch(t){}try{e.statusText=e._object.statusText}catch(t){}}function r(e){e._object.onreadystatechange=new window.Function}var o=window.XMLHttpRequest,l=!!window.controllers,u=window.document.all&&!window.opera,c=u&&window.navigator.userAgent.match(/MSIE 7.0/);t.prototype=e.prototype,l&&o.wrapped&&(t.wrapped=o.wrapped),t.UNSENT=0,t.OPENED=1,t.HEADERS_RECEIVED=2,t.LOADING=3,t.DONE=4,t.prototype.readyState=t.UNSENT,t.prototype.responseText="",t.prototype.responseXML=null,t.prototype.status=0,t.prototype.statusText="",t.prototype.priority="NORMAL",t.prototype.onreadystatechange=null,t.onreadystatechange=null,t.onopen=null,t.onsend=null,t.onabort=null,t.prototype.open=function(e,i,s,o,c){delete this._headers,arguments.length<3&&(s=!0),this._async=s;var h,d=this,p=this.readyState;u&&s&&(h=function(){p!=t.DONE&&(r(d),d.abort())},window.attachEvent("onunload",h)),t.onopen&&t.onopen.apply(this,arguments),arguments.length>4?this._object.open(e,i,s,o,c):arguments.length>3?this._object.open(e,i,s,o):this._object.open(e,i,s),this.readyState=t.OPENED,n(this),this._object.onreadystatechange=function(){if(!l||s){if(d.readyState=d._object.readyState,a(d),d._aborted)return d.readyState=t.UNSENT,void 0;d.readyState==t.DONE&&(delete d._data,r(d),u&&s&&window.detachEvent("onunload",h)),p!=d.readyState&&n(d),p=d.readyState}}},t.prototype.send=function(e){t.onsend&&t.onsend.apply(this,arguments),arguments.length||(e=null),e&&e.nodeType&&(e=window.XMLSerializer?(new window.XMLSerializer).serializeToString(e):e.xml,this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml")),this._data=e,i(this)},t.prototype.abort=function(){t.onabort&&t.onabort.apply(this,arguments),this.readyState>t.UNSENT&&(this._aborted=!0),this._object.abort(),r(this),this.readyState=t.UNSENT,delete this._data},t.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()},t.prototype.getResponseHeader=function(e){return this._object.getResponseHeader(e)},t.prototype.setRequestHeader=function(e,t){return this._headers||(this._headers={}),this._headers[e]=t,this._object.setRequestHeader(e,t)},t.prototype.addEventListener=function(e,t,i){for(var n,s=0;n=this._listeners[s];s++)if(n[0]==e&&n[1]==t&&n[2]==i)return;this._listeners.push([e,t,i])},t.prototype.removeEventListener=function(e,t,i){for(var n,s=0;(n=this._listeners[s])&&(n[0]!=e||n[1]!=t||n[2]!=i);s++);n&&this._listeners.splice(s,1)},t.prototype.dispatchEvent=function(e){var t={type:e.type,target:this,currentTarget:this,eventPhase:2,bubbles:e.bubbles,cancelable:e.cancelable,timeStamp:e.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};"readystatechange"==t.type&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[t]);for(var i,n=0;i=this._listeners[n];n++)i[0]!=t.type||i[2]||(i[1].handleEvent||i[1]).apply(this,[t])},t.prototype.toString=function(){return"[object XMLHttpRequest]"},t.toString=function(){return"[XMLHttpRequest]"},window.Function.prototype.apply||(window.Function.prototype.apply=function(e,t){t||(t=[]),e.__func=this,e.__func(t[0],t[1],t[2],t[3],t[4]),delete e.__func}),OpenLayers.Request.XMLHttpRequest=t}(),OpenLayers.Projection=OpenLayers.Class({proj:null,projCode:null,titleRegEx:/\+title=[^\+]*/,initialize:function(e,t){OpenLayers.Util.extend(this,t),this.projCode=e,window.Proj4js&&(this.proj=new Proj4js.Proj(e))},getCode:function(){return this.proj?this.proj.srsCode:this.projCode},getUnits:function(){return this.proj?this.proj.units:null},toString:function(){return this.getCode()},equals:function(e){var t=e,i=!1;if(t)if(t instanceof OpenLayers.Projection||(t=new OpenLayers.Projection(t)),window.Proj4js&&this.proj.defData&&t.proj.defData)i=this.proj.defData.replace(this.titleRegEx,"")==t.proj.defData.replace(this.titleRegEx,"");else if(t.getCode){var n=this.getCode(),s=t.getCode();i=n==s||!!OpenLayers.Projection.transforms[n]&&OpenLayers.Projection.transforms[n][s]===OpenLayers.Projection.nullTransform}return i},destroy:function(){delete this.proj,delete this.projCode},CLASS_NAME:"OpenLayers.Projection"}),OpenLayers.Projection.transforms={},OpenLayers.Projection.defaults={"EPSG:4326":{units:"degrees",maxExtent:[-180,-90,180,90],yx:!0},"CRS:84":{units:"degrees",maxExtent:[-180,-90,180,90]},"EPSG:900913":{units:"m",maxExtent:[-20037508.34,-20037508.34,20037508.34,20037508.34]}},OpenLayers.Projection.addTransform=function(e,t,i){if(i===OpenLayers.Projection.nullTransform){var n=OpenLayers.Projection.defaults[e];n&&!OpenLayers.Projection.defaults[t]&&(OpenLayers.Projection.defaults[t]=n)}OpenLayers.Projection.transforms[e]||(OpenLayers.Projection.transforms[e]={}),OpenLayers.Projection.transforms[e][t]=i},OpenLayers.Projection.transform=function(e,t,i){if(t&&i)if(t instanceof OpenLayers.Projection||(t=new OpenLayers.Projection(t)),i instanceof OpenLayers.Projection||(i=new OpenLayers.Projection(i)),t.proj&&i.proj)e=Proj4js.transform(t.proj,i.proj,e);else{var n=t.getCode(),s=i.getCode(),a=OpenLayers.Projection.transforms;a[n]&&a[n][s]&&a[n][s](e)}return e},OpenLayers.Projection.nullTransform=function(e){return e},function(){function e(e){return e.x=180*e.x/s,e.y=180/Math.PI*(2*Math.atan(Math.exp(e.y/s*Math.PI))-Math.PI/2),e}function t(e){return e.x=e.x*s/180,e.y=Math.log(Math.tan((90+e.y)*Math.PI/360))/Math.PI*s,e}function i(i,n){var s,a,r,o,l,u=OpenLayers.Projection.addTransform,c=OpenLayers.Projection.nullTransform;for(s=0,a=n.length;a>s;++s)for(r=n[s],u(i,r,t),u(r,i,e),l=s+1;a>l;++l)o=n[l],u(r,o,c),u(o,r,c)}var n,s=20037508.34,a=["EPSG:900913","EPSG:3857","EPSG:102113","EPSG:102100"],r=["CRS:84","urn:ogc:def:crs:EPSG:6.6:4326","EPSG:4326"];for(n=a.length-1;n>=0;--n)i(a[n],r);for(n=r.length-1;n>=0;--n)i(r[n],a)}(),OpenLayers.Map=OpenLayers.Class({Z_INDEX_BASE:{BaseLayer:100,Overlay:325,Feature:725,Popup:750,Control:1e3},id:null,fractionalZoom:!1,events:null,allOverlays:!1,div:null,dragging:!1,size:null,viewPortDiv:null,layerContainerOrigin:null,layerContainerDiv:null,layers:null,controls:null,popups:null,baseLayer:null,center:null,resolution:null,zoom:0,panRatio:1.5,options:null,tileSize:null,projection:"EPSG:4326",units:null,resolutions:null,maxResolution:null,minResolution:null,maxScale:null,minScale:null,maxExtent:null,minExtent:null,restrictedExtent:null,numZoomLevels:16,theme:null,displayProjection:null,fallThrough:!0,panTween:null,eventListeners:null,panMethod:OpenLayers.Easing.Expo.easeOut,panDuration:50,paddingForPopups:null,minPx:null,maxPx:null,initialize:function(e,t){1===arguments.length&&"object"==typeof e&&(t=e,e=t&&t.div),this.tileSize=new OpenLayers.Size(OpenLayers.Map.TILE_WIDTH,OpenLayers.Map.TILE_HEIGHT),this.paddingForPopups=new OpenLayers.Bounds(15,15,15,15),this.theme=OpenLayers._getScriptLocation()+"theme/default/style.css",this.options=OpenLayers.Util.extend({},t),OpenLayers.Util.extend(this,t);var i=this.projection instanceof OpenLayers.Projection?this.projection.projCode:this.projection;OpenLayers.Util.applyDefaults(this,OpenLayers.Projection.defaults[i]),!this.maxExtent||this.maxExtent instanceof OpenLayers.Bounds||(this.maxExtent=new OpenLayers.Bounds(this.maxExtent)),!this.minExtent||this.minExtent instanceof OpenLayers.Bounds||(this.minExtent=new OpenLayers.Bounds(this.minExtent)),!this.restrictedExtent||this.restrictedExtent instanceof OpenLayers.Bounds||(this.restrictedExtent=new OpenLayers.Bounds(this.restrictedExtent)),!this.center||this.center instanceof OpenLayers.LonLat||(this.center=new OpenLayers.LonLat(this.center)),this.layers=[],this.id=OpenLayers.Util.createUniqueID("OpenLayers.Map_"),this.div=OpenLayers.Util.getElement(e),this.div||(this.div=document.createElement("div"),this.div.style.height="1px",this.div.style.width="1px"),OpenLayers.Element.addClass(this.div,"olMap");var n=this.id+"_OpenLayers_ViewPort";if(this.viewPortDiv=OpenLayers.Util.createDiv(n,null,null,null,"relative",null,"hidden"),this.viewPortDiv.style.width="100%",this.viewPortDiv.style.height="100%",this.viewPortDiv.className="olMapViewport",this.div.appendChild(this.viewPortDiv),this.events=new OpenLayers.Events(this,this.viewPortDiv,null,this.fallThrough,{includeXY:!0}),n=this.id+"_OpenLayers_Container",this.layerContainerDiv=OpenLayers.Util.createDiv(n),this.layerContainerDiv.style.width="100px",this.layerContainerDiv.style.height="100px",this.layerContainerDiv.style.zIndex=this.Z_INDEX_BASE.Popup-1,this.viewPortDiv.appendChild(this.layerContainerDiv),this.updateSize(),this.eventListeners instanceof Object&&this.events.on(this.eventListeners),parseFloat(navigator.appVersion.split("MSIE")[1])<9?this.events.register("resize",this,this.updateSize):(this.updateSizeDestroy=OpenLayers.Function.bind(this.updateSize,this),OpenLayers.Event.observe(window,"resize",this.updateSizeDestroy)),this.theme){for(var s=!0,a=document.getElementsByTagName("link"),r=0,o=a.length;o>r;++r)if(OpenLayers.Util.isEquivalentUrl(a.item(r).href,this.theme)){s=!1;break}if(s){var l=document.createElement("link");l.setAttribute("rel","stylesheet"),l.setAttribute("type","text/css"),l.setAttribute("href",this.theme),document.getElementsByTagName("head")[0].appendChild(l)}}null==this.controls&&(this.controls=[],null!=OpenLayers.Control&&(OpenLayers.Control.Navigation?this.controls.push(new OpenLayers.Control.Navigation):OpenLayers.Control.TouchNavigation&&this.controls.push(new OpenLayers.Control.TouchNavigation),OpenLayers.Control.Zoom?this.controls.push(new OpenLayers.Control.Zoom):OpenLayers.Control.PanZoom&&this.controls.push(new OpenLayers.Control.PanZoom),OpenLayers.Control.ArgParser&&this.controls.push(new OpenLayers.Control.ArgParser),OpenLayers.Control.Attribution&&this.controls.push(new OpenLayers.Control.Attribution)));for(var r=0,o=this.controls.length;o>r;r++)this.addControlToMap(this.controls[r]);this.popups=[],this.unloadDestroy=OpenLayers.Function.bind(this.destroy,this),OpenLayers.Event.observe(window,"unload",this.unloadDestroy),t&&t.layers&&(delete this.center,this.addLayers(t.layers),t.center&&!this.getCenter()&&this.setCenter(t.center,t.zoom))},getViewport:function(){return this.viewPortDiv},render:function(e){this.div=OpenLayers.Util.getElement(e),OpenLayers.Element.addClass(this.div,"olMap"),this.viewPortDiv.parentNode.removeChild(this.viewPortDiv),this.div.appendChild(this.viewPortDiv),this.updateSize()},unloadDestroy:null,updateSizeDestroy:null,destroy:function(){if(!this.unloadDestroy)return!1;if(this.panTween&&(this.panTween.stop(),this.panTween=null),OpenLayers.Event.stopObserving(window,"unload",this.unloadDestroy),this.unloadDestroy=null,this.updateSizeDestroy?OpenLayers.Event.stopObserving(window,"resize",this.updateSizeDestroy):this.events.unregister("resize",this,this.updateSize),this.paddingForPopups=null,null!=this.controls){for(var e=this.controls.length-1;e>=0;--e)this.controls[e].destroy();this.controls=null}if(null!=this.layers){for(var e=this.layers.length-1;e>=0;--e)this.layers[e].destroy(!1);this.layers=null}this.viewPortDiv&&this.div.removeChild(this.viewPortDiv),this.viewPortDiv=null,this.eventListeners&&(this.events.un(this.eventListeners),this.eventListeners=null),this.events.destroy(),this.events=null,this.options=null},setOptions:function(e){var t=this.minPx&&e.restrictedExtent!=this.restrictedExtent;OpenLayers.Util.extend(this,e),t&&this.moveTo(this.getCachedCenter(),this.zoom,{forceZoomChange:!0})},getTileSize:function(){return this.tileSize},getBy:function(e,t,i){var n="function"==typeof i.test,s=OpenLayers.Array.filter(this[e],function(e){return e[t]==i||n&&i.test(e[t])});return s},getLayersBy:function(e,t){return this.getBy("layers",e,t)},getLayersByName:function(e){return this.getLayersBy("name",e)},getLayersByClass:function(e){return this.getLayersBy("CLASS_NAME",e)},getControlsBy:function(e,t){return this.getBy("controls",e,t)},getControlsByClass:function(e){return this.getControlsBy("CLASS_NAME",e)},getLayer:function(e){for(var t=null,i=0,n=this.layers.length;n>i;i++){var s=this.layers[i];if(s.id==e){t=s;break}}return t},setLayerZIndex:function(e,t){e.setZIndex(this.Z_INDEX_BASE[e.isBaseLayer?"BaseLayer":"Overlay"]+5*t)},resetLayersZIndex:function(){for(var e=0,t=this.layers.length;t>e;e++){var i=this.layers[e];this.setLayerZIndex(i,e)}},addLayer:function(e){for(var t=0,i=this.layers.length;i>t;t++)if(this.layers[t]==e)return!1;return this.events.triggerEvent("preaddlayer",{layer:e})===!1?!1:(this.allOverlays&&(e.isBaseLayer=!1),e.div.className="olLayerDiv",e.div.style.overflow="",this.setLayerZIndex(e,this.layers.length),e.isFixed?this.viewPortDiv.appendChild(e.div):this.layerContainerDiv.appendChild(e.div),this.layers.push(e),e.setMap(this),e.isBaseLayer||this.allOverlays&&!this.baseLayer?null==this.baseLayer?this.setBaseLayer(e):e.setVisibility(!1):e.redraw(),this.events.triggerEvent("addlayer",{layer:e}),e.events.triggerEvent("added",{map:this,layer:e}),e.afterAdd(),!0)},addLayers:function(e){for(var t=0,i=e.length;i>t;t++)this.addLayer(e[t])},removeLayer:function(e,t){if(this.events.triggerEvent("preremovelayer",{layer:e})!==!1){if(null==t&&(t=!0),e.isFixed?this.viewPortDiv.removeChild(e.div):this.layerContainerDiv.removeChild(e.div),OpenLayers.Util.removeItem(this.layers,e),e.removeMap(this),e.map=null,this.baseLayer==e&&(this.baseLayer=null,t))for(var i=0,n=this.layers.length;n>i;i++){var s=this.layers[i];if(s.isBaseLayer||this.allOverlays){this.setBaseLayer(s);break}}this.resetLayersZIndex(),this.events.triggerEvent("removelayer",{layer:e}),e.events.triggerEvent("removed",{map:this,layer:e})}},getNumLayers:function(){return this.layers.length},getLayerIndex:function(e){return OpenLayers.Util.indexOf(this.layers,e)},setLayerIndex:function(e,t){var i=this.getLayerIndex(e);if(0>t?t=0:t>this.layers.length&&(t=this.layers.length),i!=t){this.layers.splice(i,1),this.layers.splice(t,0,e);for(var n=0,s=this.layers.length;s>n;n++)this.setLayerZIndex(this.layers[n],n);this.events.triggerEvent("changelayer",{layer:e,property:"order"}),this.allOverlays&&(0===t?this.setBaseLayer(e):this.baseLayer!==this.layers[0]&&this.setBaseLayer(this.layers[0]))}},raiseLayer:function(e,t){var i=this.getLayerIndex(e)+t;this.setLayerIndex(e,i)},setBaseLayer:function(e){if(e!=this.baseLayer&&-1!=OpenLayers.Util.indexOf(this.layers,e)){var t=this.getCachedCenter(),i=OpenLayers.Util.getResolutionFromScale(this.getScale(),e.units);if(null==this.baseLayer||this.allOverlays||this.baseLayer.setVisibility(!1),this.baseLayer=e,(!this.allOverlays||this.baseLayer.visibility)&&(this.baseLayer.setVisibility(!0),this.baseLayer.inRange===!1&&this.baseLayer.redraw()),null!=t){var n=this.getZoomForResolution(i||this.resolution,!0);this.setCenter(t,n,!1,!0)}this.events.triggerEvent("changebaselayer",{layer:this.baseLayer})}},addControl:function(e,t){this.controls.push(e),this.addControlToMap(e,t)},addControls:function(e,t){for(var i=1===arguments.length?[]:t,n=0,s=e.length;s>n;n++){var a=e[n],r=i[n]?i[n]:null;this.addControl(a,r)}},addControlToMap:function(e,t){e.outsideViewport=null!=e.div,this.displayProjection&&!e.displayProjection&&(e.displayProjection=this.displayProjection),e.setMap(this);var i=e.draw(t);i&&(e.outsideViewport||(i.style.zIndex=this.Z_INDEX_BASE.Control+this.controls.length,this.viewPortDiv.appendChild(i))),e.autoActivate&&e.activate()},getControl:function(e){for(var t=null,i=0,n=this.controls.length;n>i;i++){var s=this.controls[i];if(s.id==e){t=s;break}}return t},removeControl:function(e){e&&e==this.getControl(e.id)&&(e.div&&e.div.parentNode==this.viewPortDiv&&this.viewPortDiv.removeChild(e.div),OpenLayers.Util.removeItem(this.controls,e))},addPopup:function(e,t){if(t)for(var i=this.popups.length-1;i>=0;--i)this.removePopup(this.popups[i]);e.map=this,this.popups.push(e);var n=e.draw();n&&(n.style.zIndex=this.Z_INDEX_BASE.Popup+this.popups.length,this.layerContainerDiv.appendChild(n))},removePopup:function(e){if(OpenLayers.Util.removeItem(this.popups,e),e.div)try{this.layerContainerDiv.removeChild(e.div)}catch(t){}e.map=null},getSize:function(){var e=null;return null!=this.size&&(e=this.size.clone()),e},updateSize:function(){var e=this.getCurrentSize();if(e&&!isNaN(e.h)&&!isNaN(e.w)){this.events.clearMouseCache();var t=this.getSize();if(null==t&&(this.size=t=e),!e.equals(t)){this.size=e;for(var i=0,n=this.layers.length;n>i;i++)this.layers[i].onMapResize();var s=this.getCachedCenter();if(null!=this.baseLayer&&null!=s){var a=this.getZoom();this.zoom=null,this.setCenter(s,a)}}}},getCurrentSize:function(){var e=new OpenLayers.Size(this.div.clientWidth,this.div.clientHeight);return(0==e.w&&0==e.h||isNaN(e.w)&&isNaN(e.h))&&(e.w=this.div.offsetWidth,e.h=this.div.offsetHeight),(0==e.w&&0==e.h||isNaN(e.w)&&isNaN(e.h))&&(e.w=parseInt(this.div.style.width),e.h=parseInt(this.div.style.height)),e},calculateBounds:function(e,t){var i=null;if(null==e&&(e=this.getCachedCenter()),null==t&&(t=this.getResolution()),null!=e&&null!=t){var n=this.size.w*t/2,s=this.size.h*t/2;i=new OpenLayers.Bounds(e.lon-n,e.lat-s,e.lon+n,e.lat+s)}return i},getCenter:function(){var e=null,t=this.getCachedCenter();return t&&(e=t.clone()),e},getCachedCenter:function(){return!this.center&&this.size&&(this.center=this.getLonLatFromViewPortPx({x:this.size.w/2,y:this.size.h/2})),this.center},getZoom:function(){return this.zoom},pan:function(e,t,i){if(i=OpenLayers.Util.applyDefaults(i,{animate:!0,dragging:!1}),i.dragging)(0!=e||0!=t)&&this.moveByPx(e,t);else{var n=this.getViewPortPxFromLonLat(this.getCachedCenter()),s=n.add(e,t);if(this.dragging||!s.equals(n)){var a=this.getLonLatFromViewPortPx(s);i.animate?this.panTo(a):(this.moveTo(a),this.dragging&&(this.dragging=!1,this.events.triggerEvent("moveend")))}}},panTo:function(e){if(this.panMethod&&this.getExtent().scale(this.panRatio).containsLonLat(e)){this.panTween||(this.panTween=new OpenLayers.Tween(this.panMethod));
var t=this.getCachedCenter();if(e.equals(t))return;var i=this.getPixelFromLonLat(t),n=this.getPixelFromLonLat(e),s={x:n.x-i.x,y:n.y-i.y},a={x:0,y:0};this.panTween.start({x:0,y:0},s,this.panDuration,{callbacks:{eachStep:OpenLayers.Function.bind(function(e){var t=e.x-a.x,i=e.y-a.y;this.moveByPx(t,i),a.x=Math.round(e.x),a.y=Math.round(e.y)},this),done:OpenLayers.Function.bind(function(){this.moveTo(e),this.dragging=!1,this.events.triggerEvent("moveend")},this)}})}else this.setCenter(e)},setCenter:function(e,t,i,n){this.panTween&&this.panTween.stop(),this.moveTo(e,t,{dragging:i,forceZoomChange:n})},moveByPx:function(e,t){var i=this.size.w/2,n=this.size.h/2,s=i+e,a=n+t,r=this.baseLayer.wrapDateLine,o=0,l=0;if(this.restrictedExtent&&(o=i,l=n,r=!1),e=r||s<=this.maxPx.x-o&&s>=this.minPx.x+o?Math.round(e):0,t=a<=this.maxPx.y-l&&a>=this.minPx.y+l?Math.round(t):0,e||t){this.dragging||(this.dragging=!0,this.events.triggerEvent("movestart")),this.center=null,e&&(this.layerContainerDiv.style.left=parseInt(this.layerContainerDiv.style.left)-e+"px",this.minPx.x-=e,this.maxPx.x-=e),t&&(this.layerContainerDiv.style.top=parseInt(this.layerContainerDiv.style.top)-t+"px",this.minPx.y-=t,this.maxPx.y-=t);var u,c,h;for(c=0,h=this.layers.length;h>c;++c)u=this.layers[c],u.visibility&&(u===this.baseLayer||u.inRange)&&(u.moveByPx(e,t),u.events.triggerEvent("move"));this.events.triggerEvent("move")}},adjustZoom:function(e){var t=this.baseLayer.resolutions,i=this.getMaxExtent().getWidth()/this.size.w;if(this.getResolutionForZoom(e)>i)for(var n=0|e,s=t.length;s>n;++n)if(t[n]<=i){e=n;break}return e},moveTo:function(e,t,i){if(null==e||e instanceof OpenLayers.LonLat||(e=new OpenLayers.LonLat(e)),i||(i={}),null!=t&&(t=parseFloat(t),this.fractionalZoom||(t=Math.round(t))),this.baseLayer.wrapDateLine){var n=t;t=this.adjustZoom(t),t!==n&&(e=this.getCenter())}var s=i.dragging||this.dragging,a=i.forceZoomChange;if(this.getCachedCenter()||this.isValidLonLat(e)||(e=this.maxExtent.getCenterLonLat(),this.center=e.clone()),null!=this.restrictedExtent){null==e&&(e=this.center),null==t&&(t=this.getZoom());var r=this.getResolutionForZoom(t),o=this.calculateBounds(e,r);if(!this.restrictedExtent.containsBounds(o)){var l=this.restrictedExtent.getCenterLonLat();o.getWidth()>this.restrictedExtent.getWidth()?e=new OpenLayers.LonLat(l.lon,e.lat):o.left<this.restrictedExtent.left?e=e.add(this.restrictedExtent.left-o.left,0):o.right>this.restrictedExtent.right&&(e=e.add(this.restrictedExtent.right-o.right,0)),o.getHeight()>this.restrictedExtent.getHeight()?e=new OpenLayers.LonLat(e.lon,l.lat):o.bottom<this.restrictedExtent.bottom?e=e.add(0,this.restrictedExtent.bottom-o.bottom):o.top>this.restrictedExtent.top&&(e=e.add(0,this.restrictedExtent.top-o.top))}}var u=a||this.isValidZoomLevel(t)&&t!=this.getZoom(),c=this.isValidLonLat(e)&&!e.equals(this.center);if(u||c||s){s||this.events.triggerEvent("movestart"),c&&(!u&&this.center&&this.centerLayerContainer(e),this.center=e.clone());var h=u?this.getResolutionForZoom(t):this.getResolution();if(u||null==this.layerContainerOrigin){this.layerContainerOrigin=this.getCachedCenter(),this.layerContainerDiv.style.left="0px",this.layerContainerDiv.style.top="0px";var d=this.getMaxExtent({restricted:!0}),p=d.getCenterLonLat(),f=this.center.lon-p.lon,m=p.lat-this.center.lat,g=Math.round(d.getWidth()/h),y=Math.round(d.getHeight()/h);this.minPx={x:(this.size.w-g)/2-f/h,y:(this.size.h-y)/2-m/h},this.maxPx={x:this.minPx.x+Math.round(d.getWidth()/h),y:this.minPx.y+Math.round(d.getHeight()/h)}}u&&(this.zoom=t,this.resolution=h);var v=this.getExtent();this.baseLayer.visibility&&(this.baseLayer.moveTo(v,u,i.dragging),i.dragging||this.baseLayer.events.triggerEvent("moveend",{zoomChanged:u})),v=this.baseLayer.getExtent();for(var b=this.layers.length-1;b>=0;--b){var _=this.layers[b];if(_!==this.baseLayer&&!_.isBaseLayer){var w=_.calculateInRange();_.inRange!=w&&(_.inRange=w,w||_.display(!1),this.events.triggerEvent("changelayer",{layer:_,property:"visibility"})),w&&_.visibility&&(_.moveTo(v,u,i.dragging),i.dragging||_.events.triggerEvent("moveend",{zoomChanged:u}))}}if(this.events.triggerEvent("move"),s||this.events.triggerEvent("moveend"),u){for(var b=0,L=this.popups.length;L>b;b++)this.popups[b].updatePosition();this.events.triggerEvent("zoomend")}}},centerLayerContainer:function(e){var t=this.getViewPortPxFromLonLat(this.layerContainerOrigin),i=this.getViewPortPxFromLonLat(e);if(null!=t&&null!=i){var n=parseInt(this.layerContainerDiv.style.left),s=parseInt(this.layerContainerDiv.style.top),a=Math.round(t.x-i.x),r=Math.round(t.y-i.y);this.layerContainerDiv.style.left=a+"px",this.layerContainerDiv.style.top=r+"px";var o=n-a,l=s-r;this.minPx.x-=o,this.maxPx.x-=o,this.minPx.y-=l,this.maxPx.y-=l}},isValidZoomLevel:function(e){return null!=e&&e>=0&&e<this.getNumZoomLevels()},isValidLonLat:function(e){var t=!1;if(null!=e){var i=this.getMaxExtent(),n=this.baseLayer.wrapDateLine&&i;t=i.containsLonLat(e,{worldBounds:n})}return t},getProjection:function(){var e=this.getProjectionObject();return e?e.getCode():null},getProjectionObject:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.projection),e},getMaxResolution:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.maxResolution),e},getMaxExtent:function(e){var t=null;return e&&e.restricted&&this.restrictedExtent?t=this.restrictedExtent:null!=this.baseLayer&&(t=this.baseLayer.maxExtent),t},getNumZoomLevels:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.numZoomLevels),e},getExtent:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.getExtent()),e},getResolution:function(){var e=null;return null!=this.baseLayer?e=this.baseLayer.getResolution():this.allOverlays===!0&&this.layers.length>0&&(e=this.layers[0].getResolution()),e},getUnits:function(){var e=null;return null!=this.baseLayer&&(e=this.baseLayer.units),e},getScale:function(){var e=null;if(null!=this.baseLayer){var t=this.getResolution(),i=this.baseLayer.units;e=OpenLayers.Util.getScaleFromResolution(t,i)}return e},getZoomForExtent:function(e,t){var i=null;return null!=this.baseLayer&&(i=this.baseLayer.getZoomForExtent(e,t)),i},getResolutionForZoom:function(e){var t=null;return this.baseLayer&&(t=this.baseLayer.getResolutionForZoom(e)),t},getZoomForResolution:function(e,t){var i=null;return null!=this.baseLayer&&(i=this.baseLayer.getZoomForResolution(e,t)),i},zoomTo:function(e){this.isValidZoomLevel(e)&&this.setCenter(null,e)},zoomIn:function(){this.zoomTo(this.getZoom()+1)},zoomOut:function(){this.zoomTo(this.getZoom()-1)},zoomToExtent:function(e,t){e instanceof OpenLayers.Bounds||(e=new OpenLayers.Bounds(e));var i=e.getCenterLonLat();if(this.baseLayer.wrapDateLine){var n=this.getMaxExtent();for(e=e.clone();e.right<e.left;)e.right+=n.getWidth();i=e.getCenterLonLat().wrapDateLine(n)}this.setCenter(i,this.getZoomForExtent(e,t))},zoomToMaxExtent:function(e){var t=e?e.restricted:!0,i=this.getMaxExtent({restricted:t});this.zoomToExtent(i)},zoomToScale:function(e,t){var i=OpenLayers.Util.getResolutionFromScale(e,this.baseLayer.units),n=this.size.w*i/2,s=this.size.h*i/2,a=this.getCachedCenter(),r=new OpenLayers.Bounds(a.lon-n,a.lat-s,a.lon+n,a.lat+s);this.zoomToExtent(r,t)},getLonLatFromViewPortPx:function(e){var t=null;return null!=this.baseLayer&&(t=this.baseLayer.getLonLatFromViewPortPx(e)),t},getViewPortPxFromLonLat:function(e){var t=null;return null!=this.baseLayer&&(t=this.baseLayer.getViewPortPxFromLonLat(e)),t},getLonLatFromPixel:function(e){return this.getLonLatFromViewPortPx(e)},getPixelFromLonLat:function(e){var t=this.getViewPortPxFromLonLat(e);return t.x=Math.round(t.x),t.y=Math.round(t.y),t},getGeodesicPixelSize:function(e){var t=e?this.getLonLatFromPixel(e):this.getCachedCenter()||new OpenLayers.LonLat(0,0),i=this.getResolution(),n=t.add(-i/2,0),s=t.add(i/2,0),a=t.add(0,-i/2),r=t.add(0,i/2),o=new OpenLayers.Projection("EPSG:4326"),l=this.getProjectionObject()||o;return l.equals(o)||(n.transform(l,o),s.transform(l,o),a.transform(l,o),r.transform(l,o)),new OpenLayers.Size(OpenLayers.Util.distVincenty(n,s),OpenLayers.Util.distVincenty(a,r))},getViewPortPxFromLayerPx:function(e){var t=null;if(null!=e){var i=parseInt(this.layerContainerDiv.style.left),n=parseInt(this.layerContainerDiv.style.top);t=e.add(i,n)}return t},getLayerPxFromViewPortPx:function(e){var t=null;if(null!=e){var i=-parseInt(this.layerContainerDiv.style.left),n=-parseInt(this.layerContainerDiv.style.top);t=e.add(i,n),(isNaN(t.x)||isNaN(t.y))&&(t=null)}return t},getLonLatFromLayerPx:function(e){return e=this.getViewPortPxFromLayerPx(e),this.getLonLatFromViewPortPx(e)},getLayerPxFromLonLat:function(e){var t=this.getPixelFromLonLat(e);return this.getLayerPxFromViewPortPx(t)},CLASS_NAME:"OpenLayers.Map"}),OpenLayers.Map.TILE_WIDTH=256,OpenLayers.Map.TILE_HEIGHT=256,OpenLayers.Layer=OpenLayers.Class({id:null,name:null,div:null,opacity:1,alwaysInRange:null,RESOLUTION_PROPERTIES:["scales","resolutions","maxScale","minScale","maxResolution","minResolution","numZoomLevels","maxZoomLevel"],events:null,map:null,isBaseLayer:!1,alpha:!1,displayInLayerSwitcher:!0,visibility:!0,attribution:null,inRange:!1,imageSize:null,options:null,eventListeners:null,gutter:0,projection:null,units:null,scales:null,resolutions:null,maxExtent:null,minExtent:null,maxResolution:null,minResolution:null,numZoomLevels:null,minScale:null,maxScale:null,displayOutsideMaxExtent:!1,wrapDateLine:!1,metadata:null,initialize:function(e,t){this.metadata={},this.addOptions(t),this.name=e,null==this.id&&(this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"),this.div=OpenLayers.Util.createDiv(this.id),this.div.style.width="100%",this.div.style.height="100%",this.div.dir="ltr",this.events=new OpenLayers.Events(this,this.div),this.eventListeners instanceof Object&&this.events.on(this.eventListeners))},destroy:function(e){null==e&&(e=!0),null!=this.map&&this.map.removeLayer(this,e),this.projection=null,this.map=null,this.name=null,this.div=null,this.options=null,this.events&&(this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy()),this.eventListeners=null,this.events=null},clone:function(e){return null==e&&(e=new OpenLayers.Layer(this.name,this.getOptions())),OpenLayers.Util.applyDefaults(e,this),e.map=null,e},getOptions:function(){var e={};for(var t in this.options)e[t]=this[t];return e},setName:function(e){e!=this.name&&(this.name=e,null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"name"}))},addOptions:function(e,t){if(null==this.options&&(this.options={}),e&&("string"==typeof e.projection&&(e.projection=new OpenLayers.Projection(e.projection)),e.projection&&OpenLayers.Util.applyDefaults(e,OpenLayers.Projection.defaults[e.projection.getCode()]),!e.maxExtent||e.maxExtent instanceof OpenLayers.Bounds||(e.maxExtent=new OpenLayers.Bounds(e.maxExtent)),!e.minExtent||e.minExtent instanceof OpenLayers.Bounds||(e.minExtent=new OpenLayers.Bounds(e.minExtent))),OpenLayers.Util.extend(this.options,e),OpenLayers.Util.extend(this,e),this.projection&&this.projection.getUnits()&&(this.units=this.projection.getUnits()),this.map){var i=this.map.getResolution(),n=this.RESOLUTION_PROPERTIES.concat(["projection","units","minExtent","maxExtent"]);for(var s in e)if(e.hasOwnProperty(s)&&OpenLayers.Util.indexOf(n,s)>=0){this.initResolutions(),t&&this.map.baseLayer===this&&(this.map.setCenter(this.map.getCenter(),this.map.getZoomForResolution(i),!1,!0),this.map.events.triggerEvent("changebaselayer",{layer:this}));break}}},onMapResize:function(){},redraw:function(){var e=!1;if(this.map){this.inRange=this.calculateInRange();var t=this.getExtent();if(t&&this.inRange&&this.visibility){var i=!0;this.moveTo(t,i,!1),this.events.triggerEvent("moveend",{zoomChanged:i}),e=!0}}return e},moveTo:function(){var e=this.visibility;this.isBaseLayer||(e=e&&this.inRange),this.display(e)},moveByPx:function(){},setMap:function(e){if(null==this.map){if(this.map=e,this.maxExtent=this.maxExtent||this.map.maxExtent,this.minExtent=this.minExtent||this.map.minExtent,this.projection=this.projection||this.map.projection,"string"==typeof this.projection&&(this.projection=new OpenLayers.Projection(this.projection)),this.units=this.projection.getUnits()||this.units||this.map.units,this.initResolutions(),!this.isBaseLayer){this.inRange=this.calculateInRange();var t=this.visibility&&this.inRange;this.div.style.display=t?"":"none"}this.setTileSize()}},afterAdd:function(){},removeMap:function(){},getImageSize:function(){return this.imageSize||this.tileSize},setTileSize:function(e){var t=e?e:this.tileSize?this.tileSize:this.map.getTileSize();this.tileSize=t,this.gutter&&(this.imageSize=new OpenLayers.Size(t.w+2*this.gutter,t.h+2*this.gutter))},getVisibility:function(){return this.visibility},setVisibility:function(e){e!=this.visibility&&(this.visibility=e,this.display(e),this.redraw(),null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"visibility"}),this.events.triggerEvent("visibilitychanged"))},display:function(e){e!=("none"!=this.div.style.display)&&(this.div.style.display=e&&this.calculateInRange()?"block":"none")},calculateInRange:function(){var e=!1;if(this.alwaysInRange)e=!0;else if(this.map){var t=this.map.getResolution();e=t>=this.minResolution&&t<=this.maxResolution}return e},setIsBaseLayer:function(e){e!=this.isBaseLayer&&(this.isBaseLayer=e,null!=this.map&&this.map.events.triggerEvent("changebaselayer",{layer:this}))},initResolutions:function(){var e,t,i,n={},s=!0;for(e=0,t=this.RESOLUTION_PROPERTIES.length;t>e;e++)i=this.RESOLUTION_PROPERTIES[e],n[i]=this.options[i],s&&this.options[i]&&(s=!1);if(null==this.alwaysInRange&&(this.alwaysInRange=s),null==n.resolutions&&(n.resolutions=this.resolutionsFromScales(n.scales)),null==n.resolutions&&(n.resolutions=this.calculateResolutions(n)),null==n.resolutions){for(e=0,t=this.RESOLUTION_PROPERTIES.length;t>e;e++)i=this.RESOLUTION_PROPERTIES[e],n[i]=null!=this.options[i]?this.options[i]:this.map[i];null==n.resolutions&&(n.resolutions=this.resolutionsFromScales(n.scales)),null==n.resolutions&&(n.resolutions=this.calculateResolutions(n))}var a;this.options.maxResolution&&"auto"!==this.options.maxResolution&&(a=this.options.maxResolution),this.options.minScale&&(a=OpenLayers.Util.getResolutionFromScale(this.options.minScale,this.units));var r;if(this.options.minResolution&&"auto"!==this.options.minResolution&&(r=this.options.minResolution),this.options.maxScale&&(r=OpenLayers.Util.getResolutionFromScale(this.options.maxScale,this.units)),n.resolutions&&(n.resolutions.sort(function(e,t){return t-e}),a||(a=n.resolutions[0]),!r)){var o=n.resolutions.length-1;r=n.resolutions[o]}if(this.resolutions=n.resolutions,this.resolutions){for(t=this.resolutions.length,this.scales=new Array(t),e=0;t>e;e++)this.scales[e]=OpenLayers.Util.getScaleFromResolution(this.resolutions[e],this.units);this.numZoomLevels=t}this.minResolution=r,r&&(this.maxScale=OpenLayers.Util.getScaleFromResolution(r,this.units)),this.maxResolution=a,a&&(this.minScale=OpenLayers.Util.getScaleFromResolution(a,this.units))},resolutionsFromScales:function(e){if(null!=e){var t,i,n;for(n=e.length,t=new Array(n),i=0;n>i;i++)t[i]=OpenLayers.Util.getResolutionFromScale(e[i],this.units);return t}},calculateResolutions:function(e){var t,i,n,s=e.maxResolution;null!=e.minScale?s=OpenLayers.Util.getResolutionFromScale(e.minScale,this.units):"auto"==s&&null!=this.maxExtent&&(t=this.map.getSize(),i=this.maxExtent.getWidth()/t.w,n=this.maxExtent.getHeight()/t.h,s=Math.max(i,n));var a=e.minResolution;if(null!=e.maxScale?a=OpenLayers.Util.getResolutionFromScale(e.maxScale,this.units):"auto"==e.minResolution&&null!=this.minExtent&&(t=this.map.getSize(),i=this.minExtent.getWidth()/t.w,n=this.minExtent.getHeight()/t.h,a=Math.max(i,n)),"number"!=typeof s&&"number"!=typeof a&&null!=this.maxExtent){var r=this.map.getTileSize();s=Math.max(this.maxExtent.getWidth()/r.w,this.maxExtent.getHeight()/r.h)}var o=e.maxZoomLevel,l=e.numZoomLevels;if("number"==typeof a&&"number"==typeof s&&void 0===l){var u=s/a;l=Math.floor(Math.log(u)/Math.log(2))+1}else void 0===l&&null!=o&&(l=o+1);if(!("number"!=typeof l||0>=l||"number"!=typeof s&&"number"!=typeof a)){var c=new Array(l),h=2;"number"==typeof a&&"number"==typeof s&&(h=Math.pow(s/a,1/(l-1)));var d;if("number"==typeof s)for(d=0;l>d;d++)c[d]=s/Math.pow(h,d);else for(d=0;l>d;d++)c[l-1-d]=a*Math.pow(h,d);return c}},getResolution:function(){var e=this.map.getZoom();return this.getResolutionForZoom(e)},getExtent:function(){return this.map.calculateBounds()},getZoomForExtent:function(e,t){var i=this.map.getSize(),n=Math.max(e.getWidth()/i.w,e.getHeight()/i.h);return this.getZoomForResolution(n,t)},getDataExtent:function(){},getResolutionForZoom:function(e){e=Math.max(0,Math.min(e,this.resolutions.length-1));var t;if(this.map.fractionalZoom){var i=Math.floor(e),n=Math.ceil(e);t=this.resolutions[i]-(e-i)*(this.resolutions[i]-this.resolutions[n])}else t=this.resolutions[Math.round(e)];return t},getZoomForResolution:function(e,t){var i,n,s;if(this.map.fractionalZoom){var a,r=0,o=this.resolutions.length-1,l=this.resolutions[r],u=this.resolutions[o];for(n=0,s=this.resolutions.length;s>n;++n)if(a=this.resolutions[n],a>=e&&(l=a,r=n),e>=a){u=a,o=n;break}var c=l-u;i=c>0?r+(l-e)/c:r}else{var h,d=Number.POSITIVE_INFINITY;for(n=0,s=this.resolutions.length;s>n;n++)if(t){if(h=Math.abs(this.resolutions[n]-e),h>d)break;d=h}else if(this.resolutions[n]<e)break;i=Math.max(0,n-1)}return i},getLonLatFromViewPortPx:function(e){var t=null,i=this.map;if(null!=e&&i.minPx){var n=i.getResolution(),s=i.getMaxExtent({restricted:!0}),a=(e.x-i.minPx.x)*n+s.left,r=(i.minPx.y-e.y)*n+s.top;t=new OpenLayers.LonLat(a,r),this.wrapDateLine&&(t=t.wrapDateLine(this.maxExtent))}return t},getViewPortPxFromLonLat:function(e,t){var i=null;if(null!=e){t=t||this.map.getResolution();var n=this.map.calculateBounds(null,t);i=new OpenLayers.Pixel(1/t*(e.lon-n.left),1/t*(n.top-e.lat))}return i},setOpacity:function(e){if(e!=this.opacity){this.opacity=e;for(var t=this.div.childNodes,i=0,n=t.length;n>i;++i){var s=t[i].firstChild||t[i],a=t[i].lastChild;a&&"iframe"===a.nodeName.toLowerCase()&&(s=a.parentNode),OpenLayers.Util.modifyDOMElement(s,null,null,null,null,null,null,e)}null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"opacity"})}},getZIndex:function(){return this.div.style.zIndex},setZIndex:function(e){this.div.style.zIndex=e},adjustBounds:function(e){if(this.gutter){var t=this.gutter*this.map.getResolution();e=new OpenLayers.Bounds(e.left-t,e.bottom-t,e.right+t,e.top+t)}if(this.wrapDateLine){var i={rightTolerance:this.getResolution(),leftTolerance:this.getResolution()};e=e.wrapDateLine(this.maxExtent,i)}return e},CLASS_NAME:"OpenLayers.Layer"}),OpenLayers.Icon=OpenLayers.Class({url:null,size:null,offset:null,calculateOffset:null,imageDiv:null,px:null,initialize:function(e,t,i,n){this.url=e,this.size=t||{w:20,h:20},this.offset=i||{x:-(this.size.w/2),y:-(this.size.h/2)},this.calculateOffset=n;var s=OpenLayers.Util.createUniqueID("OL_Icon_");this.imageDiv=OpenLayers.Util.createAlphaImageDiv(s)},destroy:function(){this.erase(),OpenLayers.Event.stopObservingElement(this.imageDiv.firstChild),this.imageDiv.innerHTML="",this.imageDiv=null},clone:function(){return new OpenLayers.Icon(this.url,this.size,this.offset,this.calculateOffset)},setSize:function(e){null!=e&&(this.size=e),this.draw()},setUrl:function(e){null!=e&&(this.url=e),this.draw()},draw:function(e){return OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,null,this.size,this.url,"absolute"),this.moveTo(e),this.imageDiv},erase:function(){null!=this.imageDiv&&null!=this.imageDiv.parentNode&&OpenLayers.Element.remove(this.imageDiv)},setOpacity:function(e){OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,null,null,null,null,null,null,e)},moveTo:function(e){null!=e&&(this.px=e),null!=this.imageDiv&&(null==this.px?this.display(!1):(this.calculateOffset&&(this.offset=this.calculateOffset(this.size)),OpenLayers.Util.modifyAlphaImageDiv(this.imageDiv,null,{x:this.px.x+this.offset.x,y:this.px.y+this.offset.y})))},display:function(e){this.imageDiv.style.display=e?"":"none"},isDrawn:function(){var e=this.imageDiv&&this.imageDiv.parentNode&&11!=this.imageDiv.parentNode.nodeType;return e},CLASS_NAME:"OpenLayers.Icon"}),OpenLayers.Marker=OpenLayers.Class({icon:null,lonlat:null,events:null,map:null,initialize:function(e,t){this.lonlat=e;var i=t?t:OpenLayers.Marker.defaultIcon();null==this.icon?this.icon=i:(this.icon.url=i.url,this.icon.size=i.size,this.icon.offset=i.offset,this.icon.calculateOffset=i.calculateOffset),this.events=new OpenLayers.Events(this,this.icon.imageDiv)},destroy:function(){this.erase(),this.map=null,this.events.destroy(),this.events=null,null!=this.icon&&(this.icon.destroy(),this.icon=null)},draw:function(e){return this.icon.draw(e)},erase:function(){null!=this.icon&&this.icon.erase()},moveTo:function(e){null!=e&&null!=this.icon&&this.icon.moveTo(e),this.lonlat=this.map.getLonLatFromLayerPx(e)},isDrawn:function(){var e=this.icon&&this.icon.isDrawn();return e},onScreen:function(){var e=!1;if(this.map){var t=this.map.getExtent();e=t.containsLonLat(this.lonlat)}return e},inflate:function(e){this.icon&&this.icon.setSize({w:this.icon.size.w*e,h:this.icon.size.h*e})},setOpacity:function(e){this.icon.setOpacity(e)},setUrl:function(e){this.icon.setUrl(e)},display:function(e){this.icon.display(e)},CLASS_NAME:"OpenLayers.Marker"}),OpenLayers.Marker.defaultIcon=function(){return new OpenLayers.Icon(OpenLayers.Util.getImageLocation("marker.png"),{w:21,h:25},{x:-10.5,y:-25})},OpenLayers.Popup=OpenLayers.Class({events:null,id:"",lonlat:null,div:null,contentSize:null,size:null,contentHTML:null,backgroundColor:"",opacity:"",border:"",contentDiv:null,groupDiv:null,closeDiv:null,autoSize:!1,minSize:null,maxSize:null,displayClass:"olPopup",contentDisplayClass:"olPopupContent",padding:0,disableFirefoxOverflowHack:!1,fixPadding:function(){"number"==typeof this.padding&&(this.padding=new OpenLayers.Bounds(this.padding,this.padding,this.padding,this.padding))},panMapIfOutOfView:!1,keepInMap:!1,closeOnMove:!1,map:null,initialize:function(e,t,i,n,s,a){null==e&&(e=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")),this.id=e,this.lonlat=t,this.contentSize=null!=i?i:new OpenLayers.Size(OpenLayers.Popup.WIDTH,OpenLayers.Popup.HEIGHT),null!=n&&(this.contentHTML=n),this.backgroundColor=OpenLayers.Popup.COLOR,this.opacity=OpenLayers.Popup.OPACITY,this.border=OpenLayers.Popup.BORDER,this.div=OpenLayers.Util.createDiv(this.id,null,null,null,null,null,"hidden"),this.div.className=this.displayClass;var r=this.id+"_GroupDiv";this.groupDiv=OpenLayers.Util.createDiv(r,null,null,null,"relative",null,"hidden");var e=this.div.id+"_contentDiv";this.contentDiv=OpenLayers.Util.createDiv(e,null,this.contentSize.clone(),null,"relative"),this.contentDiv.className=this.contentDisplayClass,this.groupDiv.appendChild(this.contentDiv),this.div.appendChild(this.groupDiv),s&&this.addCloseBox(a),this.registerEvents()},destroy:function(){this.id=null,this.lonlat=null,this.size=null,this.contentHTML=null,this.backgroundColor=null,this.opacity=null,this.border=null,this.closeOnMove&&this.map&&this.map.events.unregister("movestart",this,this.hide),this.events.destroy(),this.events=null,this.closeDiv&&(OpenLayers.Event.stopObservingElement(this.closeDiv),this.groupDiv.removeChild(this.closeDiv)),this.closeDiv=null,this.div.removeChild(this.groupDiv),this.groupDiv=null,null!=this.map&&this.map.removePopup(this),this.map=null,this.div=null,this.autoSize=null,this.minSize=null,this.maxSize=null,this.padding=null,this.panMapIfOutOfView=null},draw:function(e){return null==e&&null!=this.lonlat&&null!=this.map&&(e=this.map.getLayerPxFromLonLat(this.lonlat)),this.closeOnMove&&this.map.events.register("movestart",this,this.hide),this.disableFirefoxOverflowHack||"firefox"!=OpenLayers.BROWSER_NAME||(this.map.events.register("movestart",this,function(){var e=document.defaultView.getComputedStyle(this.contentDiv,null),t=e.getPropertyValue("overflow");"hidden"!=t&&(this.contentDiv._oldOverflow=t,this.contentDiv.style.overflow="hidden")}),this.map.events.register("moveend",this,function(){var e=this.contentDiv._oldOverflow;e&&(this.contentDiv.style.overflow=e,this.contentDiv._oldOverflow=null)})),this.moveTo(e),this.autoSize||this.size||this.setSize(this.contentSize),this.setBackgroundColor(),this.setOpacity(),this.setBorder(),this.setContentHTML(),this.panMapIfOutOfView&&this.panIntoView(),this.div},updatePosition:function(){if(this.lonlat&&this.map){var e=this.map.getLayerPxFromLonLat(this.lonlat);e&&this.moveTo(e)}},moveTo:function(e){null!=e&&null!=this.div&&(this.div.style.left=e.x+"px",this.div.style.top=e.y+"px")},visible:function(){return OpenLayers.Element.visible(this.div)},toggle:function(){this.visible()?this.hide():this.show()},show:function(){this.div.style.display="",this.panMapIfOutOfView&&this.panIntoView()},hide:function(){this.div.style.display="none"},setSize:function(e){this.size=e.clone();var t=this.getContentDivPadding(),i=t.left+t.right,n=t.top+t.bottom;if(this.fixPadding(),i+=this.padding.left+this.padding.right,n+=this.padding.top+this.padding.bottom,this.closeDiv){var s=parseInt(this.closeDiv.style.width);i+=s+t.right}this.size.w+=i,this.size.h+=n,"msie"==OpenLayers.BROWSER_NAME&&(this.contentSize.w+=t.left+t.right,this.contentSize.h+=t.bottom+t.top),null!=this.div&&(this.div.style.width=this.size.w+"px",this.div.style.height=this.size.h+"px"),null!=this.contentDiv&&(this.contentDiv.style.width=e.w+"px",this.contentDiv.style.height=e.h+"px")},updateSize:function(){var e="<div class='"+this.contentDisplayClass+"'>"+this.contentDiv.innerHTML+"</div>",t=this.map?this.map.div:document.body,i=OpenLayers.Util.getRenderedDimensions(e,null,{displayClass:this.displayClass,containerElement:t}),n=this.getSafeContentSize(i),s=null;if(n.equals(i))s=i;else{var a={w:n.w<i.w?n.w:null,h:n.h<i.h?n.h:null};if(a.w&&a.h)s=n;else{var r=OpenLayers.Util.getRenderedDimensions(e,a,{displayClass:this.contentDisplayClass,containerElement:t}),o=OpenLayers.Element.getStyle(this.contentDiv,"overflow");if("hidden"!=o&&r.equals(n)){var l=OpenLayers.Util.getScrollbarWidth();a.w?r.h+=l:r.w+=l}s=this.getSafeContentSize(r)}}this.setSize(s)},setBackgroundColor:function(e){void 0!=e&&(this.backgroundColor=e),null!=this.div&&(this.div.style.backgroundColor=this.backgroundColor)},setOpacity:function(e){void 0!=e&&(this.opacity=e),null!=this.div&&(this.div.style.opacity=this.opacity,this.div.style.filter="alpha(opacity="+100*this.opacity+")")},setBorder:function(e){void 0!=e&&(this.border=e),null!=this.div&&(this.div.style.border=this.border)},setContentHTML:function(e){null!=e&&(this.contentHTML=e),null!=this.contentDiv&&null!=this.contentHTML&&this.contentHTML!=this.contentDiv.innerHTML&&(this.contentDiv.innerHTML=this.contentHTML,this.autoSize&&(this.registerImageListeners(),this.updateSize()))},registerImageListeners:function(){for(var e=function(){null!==this.popup.id&&(this.popup.updateSize(),this.popup.visible()&&this.popup.panMapIfOutOfView&&this.popup.panIntoView(),OpenLayers.Event.stopObserving(this.img,"load",this.img._onImageLoad))},t=this.contentDiv.getElementsByTagName("img"),i=0,n=t.length;n>i;i++){var s=t[i];if(0==s.width||0==s.height){var a={popup:this,img:s};s._onImgLoad=OpenLayers.Function.bind(e,a),OpenLayers.Event.observe(s,"load",s._onImgLoad)}}},getSafeContentSize:function(e){var t=e.clone(),i=this.getContentDivPadding(),n=i.left+i.right,s=i.top+i.bottom;if(this.fixPadding(),n+=this.padding.left+this.padding.right,s+=this.padding.top+this.padding.bottom,this.closeDiv){var a=parseInt(this.closeDiv.style.width);n+=a+i.right}if(this.minSize&&(t.w=Math.max(t.w,this.minSize.w-n),t.h=Math.max(t.h,this.minSize.h-s)),this.maxSize&&(t.w=Math.min(t.w,this.maxSize.w-n),t.h=Math.min(t.h,this.maxSize.h-s)),this.map&&this.map.size){var r=0,o=0;if(this.keepInMap&&!this.panMapIfOutOfView){var l=this.map.getPixelFromLonLat(this.lonlat);switch(this.relativePosition){case"tr":r=l.x,o=this.map.size.h-l.y;break;case"tl":r=this.map.size.w-l.x,o=this.map.size.h-l.y;break;case"bl":r=this.map.size.w-l.x,o=l.y;break;case"br":r=l.x,o=l.y;break;default:r=l.x,o=this.map.size.h-l.y}}var u=this.map.size.h-this.map.paddingForPopups.top-this.map.paddingForPopups.bottom-s-o,c=this.map.size.w-this.map.paddingForPopups.left-this.map.paddingForPopups.right-n-r;t.w=Math.min(t.w,c),t.h=Math.min(t.h,u)}return t},getContentDivPadding:function(){var e=this._contentDivPadding;return e||(null==this.div.parentNode&&(this.div.style.display="none",document.body.appendChild(this.div)),e=new OpenLayers.Bounds(OpenLayers.Element.getStyle(this.contentDiv,"padding-left"),OpenLayers.Element.getStyle(this.contentDiv,"padding-bottom"),OpenLayers.Element.getStyle(this.contentDiv,"padding-right"),OpenLayers.Element.getStyle(this.contentDiv,"padding-top")),this._contentDivPadding=e,this.div.parentNode==document.body&&(document.body.removeChild(this.div),this.div.style.display="")),e},addCloseBox:function(e){this.closeDiv=OpenLayers.Util.createDiv(this.id+"_close",null,{w:17,h:17}),this.closeDiv.className="olPopupCloseBox";var t=this.getContentDivPadding();this.closeDiv.style.right=t.right+"px",this.closeDiv.style.top=t.top+"px",this.groupDiv.appendChild(this.closeDiv);var i=e||function(e){this.hide(),OpenLayers.Event.stop(e)};OpenLayers.Event.observe(this.closeDiv,"touchend",OpenLayers.Function.bindAsEventListener(i,this)),OpenLayers.Event.observe(this.closeDiv,"click",OpenLayers.Function.bindAsEventListener(i,this))},panIntoView:function(){var e=this.map.getSize(),t=this.map.getViewPortPxFromLayerPx(new OpenLayers.Pixel(parseInt(this.div.style.left),parseInt(this.div.style.top))),i=t.clone();t.x<this.map.paddingForPopups.left?i.x=this.map.paddingForPopups.left:t.x+this.size.w>e.w-this.map.paddingForPopups.right&&(i.x=e.w-this.map.paddingForPopups.right-this.size.w),t.y<this.map.paddingForPopups.top?i.y=this.map.paddingForPopups.top:t.y+this.size.h>e.h-this.map.paddingForPopups.bottom&&(i.y=e.h-this.map.paddingForPopups.bottom-this.size.h);var n=t.x-i.x,s=t.y-i.y;this.map.pan(n,s)},registerEvents:function(){function e(e){OpenLayers.Event.stop(e,!0)}this.events=new OpenLayers.Events(this,this.div,null,!0),this.events.on({mousedown:this.onmousedown,mousemove:this.onmousemove,mouseup:this.onmouseup,click:this.onclick,mouseout:this.onmouseout,dblclick:this.ondblclick,touchstart:e,scope:this})},onmousedown:function(e){this.mousedown=!0,OpenLayers.Event.stop(e,!0)},onmousemove:function(e){this.mousedown&&OpenLayers.Event.stop(e,!0)},onmouseup:function(e){this.mousedown&&(this.mousedown=!1,OpenLayers.Event.stop(e,!0))},onclick:function(e){OpenLayers.Event.stop(e,!0)},onmouseout:function(){this.mousedown=!1},ondblclick:function(e){OpenLayers.Event.stop(e,!0)},CLASS_NAME:"OpenLayers.Popup"}),OpenLayers.Popup.WIDTH=200,OpenLayers.Popup.HEIGHT=200,OpenLayers.Popup.COLOR="white",OpenLayers.Popup.OPACITY=1,OpenLayers.Popup.BORDER="0px",OpenLayers.Tile=OpenLayers.Class({events:null,eventListeners:null,id:null,layer:null,url:null,bounds:null,size:null,position:null,isLoading:!1,initialize:function(e,t,i,n,s,a){this.layer=e,this.position=t.clone(),this.setBounds(i),this.url=n,s&&(this.size=s.clone()),this.id=OpenLayers.Util.createUniqueID("Tile_"),OpenLayers.Util.extend(this,a),this.events=new OpenLayers.Events(this),this.eventListeners instanceof Object&&this.events.on(this.eventListeners)},unload:function(){this.isLoading&&(this.isLoading=!1,this.events.triggerEvent("unload"))},destroy:function(){this.layer=null,this.bounds=null,this.size=null,this.position=null,this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy(),this.eventListeners=null,this.events=null},draw:function(e){e||this.clear();var t=this.shouldDraw();return t&&!e&&(t=this.events.triggerEvent("beforedraw")!==!1),t},shouldDraw:function(){var e=!1,t=this.layer.maxExtent;if(t){var i=this.layer.map,n=i.baseLayer.wrapDateLine&&i.getMaxExtent();
this.bounds.intersectsBounds(t,{inclusive:!1,worldBounds:n})&&(e=!0)}return e||this.layer.displayOutsideMaxExtent},setBounds:function(e){if(e=e.clone(),this.layer.map.baseLayer.wrapDateLine){var t=this.layer.map.getMaxExtent(),i=this.layer.map.getResolution();e=e.wrapDateLine(t,{leftTolerance:i,rightTolerance:i})}this.bounds=e},moveTo:function(e,t,i){null==i&&(i=!0),this.setBounds(e),this.position=t.clone(),i&&this.draw()},clear:function(){},CLASS_NAME:"OpenLayers.Tile"}),OpenLayers.Tile.Image=OpenLayers.Class(OpenLayers.Tile,{url:null,imgDiv:null,frame:null,imageReloadAttempts:null,layerAlphaHack:null,asyncRequestId:null,blankImageUrl:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7",maxGetUrlLength:null,canvasContext:null,crossOriginKeyword:null,initialize:function(e,t,i,n){OpenLayers.Tile.prototype.initialize.apply(this,arguments),this.url=n,this.layerAlphaHack=this.layer.alpha&&OpenLayers.Util.alphaHack(),(null!=this.maxGetUrlLength||this.layer.gutter||this.layerAlphaHack)&&(this.frame=document.createElement("div"),this.frame.style.position="absolute",this.frame.style.overflow="hidden"),null!=this.maxGetUrlLength&&OpenLayers.Util.extend(this,OpenLayers.Tile.Image.IFrame)},destroy:function(){this.imgDiv&&(this.clear(),this.imgDiv=null,this.frame=null),this.asyncRequestId=null,OpenLayers.Tile.prototype.destroy.apply(this,arguments)},draw:function(){var e=OpenLayers.Tile.prototype.draw.apply(this,arguments);return e?(this.layer!=this.layer.map.baseLayer&&this.layer.reproject&&(this.bounds=this.getBoundsFromBaseLayer(this.position)),this.isLoading?this._loadEvent="reload":(this.isLoading=!0,this._loadEvent="loadstart"),this.positionTile(),this.renderTile()):this.unload(),e},renderTile:function(){if(this.layer.div.appendChild(this.getTile()),this.layer.async){var e=this.asyncRequestId=(this.asyncRequestId||0)+1;this.layer.getURLasync(this.bounds,function(t){e==this.asyncRequestId&&(this.url=t,this.initImage())},this)}else this.url=this.layer.getURL(this.bounds),this.initImage()},positionTile:function(){var e=this.getTile().style,t=this.frame?this.size:this.layer.getImageSize(this.bounds);e.left=this.position.x+"%",e.top=this.position.y+"%",e.width=t.w+"%",e.height=t.h+"%"},clear:function(){OpenLayers.Tile.prototype.clear.apply(this,arguments);var e=this.imgDiv;if(e){OpenLayers.Event.stopObservingElement(e);var t=this.getTile();t.parentNode===this.layer.div&&this.layer.div.removeChild(t),this.setImgSrc(),this.layerAlphaHack===!0&&(e.style.filter=""),OpenLayers.Element.removeClass(e,"olImageLoadError")}this.canvasContext=null},getImage:function(){if(!this.imgDiv){this.imgDiv=document.createElement("img"),this.imgDiv.className="olTileImage",this.imgDiv.galleryImg="no";var e=this.imgDiv.style;if(this.frame){var t=0,i=0;this.layer.gutter&&(t=100*(this.layer.gutter/this.layer.tileSize.w),i=100*(this.layer.gutter/this.layer.tileSize.h)),e.left=-t+"%",e.top=-i+"%",e.width=2*t+100+"%",e.height=2*i+100+"%"}e.visibility="hidden",e.opacity=0,this.layer.opacity<1&&(e.filter="alpha(opacity="+100*this.layer.opacity+")"),e.position="absolute",this.layerAlphaHack&&(e.paddingTop=e.height,e.height="0",e.width="100%"),this.frame&&this.frame.appendChild(this.imgDiv)}return this.imgDiv},initImage:function(){this.events.triggerEvent(this._loadEvent);var e=this.getImage();if(this.url&&e.getAttribute("src")==this.url)this.onImageLoad();else{var t=OpenLayers.Function.bind(function(){OpenLayers.Event.stopObservingElement(e),OpenLayers.Event.observe(e,"load",OpenLayers.Function.bind(this.onImageLoad,this)),OpenLayers.Event.observe(e,"error",OpenLayers.Function.bind(this.onImageError,this)),this.imageReloadAttempts=0,this.setImgSrc(this.url)},this);e.getAttribute("src")==this.blankImageUrl?t():(OpenLayers.Event.observe(e,"load",t),OpenLayers.Event.observe(e,"error",t),this.crossOriginKeyword&&e.removeAttribute("crossorigin"),e.src=this.blankImageUrl)}},setImgSrc:function(e){var t=this.imgDiv;t.style.visibility="hidden",t.style.opacity=0,e&&(this.crossOriginKeyword&&("data:"!==e.substr(0,5)?t.setAttribute("crossorigin",this.crossOriginKeyword):t.removeAttribute("crossorigin")),t.src=e)},getTile:function(){return this.frame?this.frame:this.getImage()},createBackBuffer:function(){if(this.imgDiv&&!this.isLoading){var e;return this.frame?(e=this.frame.cloneNode(!1),e.appendChild(this.imgDiv)):e=this.imgDiv,this.imgDiv=null,e}},onImageLoad:function(){var e=this.imgDiv;if(OpenLayers.Event.stopObservingElement(e),e.style.visibility="inherit",e.style.opacity=this.layer.opacity,this.isLoading=!1,this.canvasContext=null,this.events.triggerEvent("loadend"),parseFloat(navigator.appVersion.split("MSIE")[1])<7&&this.layer&&this.layer.div){var t=document.createElement("span");t.style.display="none";var i=this.layer.div;i.appendChild(t),window.setTimeout(function(){t.parentNode===i&&t.parentNode.removeChild(t)},0)}this.layerAlphaHack===!0&&(e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+e.src+"', sizingMethod='scale')")},onImageError:function(){var e=this.imgDiv;null!=e.src&&(this.imageReloadAttempts++,this.imageReloadAttempts<=OpenLayers.IMAGE_RELOAD_ATTEMPTS?this.setImgSrc(this.layer.getURL(this.bounds)):(OpenLayers.Element.addClass(e,"olImageLoadError"),this.events.triggerEvent("loaderror"),this.onImageLoad()))},getCanvasContext:function(){if(OpenLayers.CANVAS_SUPPORTED&&this.imgDiv&&!this.isLoading){if(!this.canvasContext){var e=document.createElement("canvas");e.width=this.size.w,e.height=this.size.h,this.canvasContext=e.getContext("2d"),this.canvasContext.drawImage(this.imgDiv,0,0)}return this.canvasContext}},CLASS_NAME:"OpenLayers.Tile.Image"}),OpenLayers.Layer.Image=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!0,url:null,extent:null,size:null,tile:null,aspectRatio:null,initialize:function(e,t,i,n,s){this.url=t,this.extent=i,this.maxExtent=i,this.size=n,OpenLayers.Layer.prototype.initialize.apply(this,[e,s]),this.aspectRatio=this.extent.getHeight()/this.size.h/(this.extent.getWidth()/this.size.w)},destroy:function(){this.tile&&(this.removeTileMonitoringHooks(this.tile),this.tile.destroy(),this.tile=null),OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.Image(this.name,this.url,this.extent,this.size,this.getOptions())),e=OpenLayers.Layer.prototype.clone.apply(this,[e])},setMap:function(){null==this.options.maxResolution&&(this.options.maxResolution=this.aspectRatio*this.extent.getWidth()/this.size.w),OpenLayers.Layer.prototype.setMap.apply(this,arguments)},moveTo:function(e,t){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var i=null==this.tile;if(t||i){this.setTileSize();var n=this.map.getLayerPxFromLonLat({lon:this.extent.left,lat:this.extent.top});i?(this.tile=new OpenLayers.Tile.Image(this,n,this.extent,null,this.tileSize),this.addTileMonitoringHooks(this.tile)):(this.tile.size=this.tileSize.clone(),this.tile.position=n.clone()),this.tile.draw()}},setTileSize:function(){var e=this.extent.getWidth()/this.map.getResolution(),t=this.extent.getHeight()/this.map.getResolution();this.tileSize=new OpenLayers.Size(e,t)},addTileMonitoringHooks:function(e){e.onLoadStart=function(){this.events.triggerEvent("loadstart")},e.events.register("loadstart",this,e.onLoadStart),e.onLoadEnd=function(){this.events.triggerEvent("loadend")},e.events.register("loadend",this,e.onLoadEnd),e.events.register("unload",this,e.onLoadEnd)},removeTileMonitoringHooks:function(e){e.unload(),e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,scope:this})},setUrl:function(e){this.url=e,this.tile.draw()},getURL:function(){return this.url},CLASS_NAME:"OpenLayers.Layer.Image"}),OpenLayers.Layer.HTTPRequest=OpenLayers.Class(OpenLayers.Layer,{URL_HASH_FACTOR:(Math.sqrt(5)-1)/2,url:null,params:null,reproject:!1,initialize:function(e,t,i,n){OpenLayers.Layer.prototype.initialize.apply(this,[e,n]),this.url=t,this.params||(this.params=OpenLayers.Util.extend({},i))},destroy:function(){this.url=null,this.params=null,OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.HTTPRequest(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.prototype.clone.apply(this,[e])},setUrl:function(e){this.url=e},mergeNewParams:function(e){this.params=OpenLayers.Util.extend(this.params,e);var t=this.redraw();return null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"params"}),t},redraw:function(e){return e?this.mergeNewParams({_olSalt:Math.random()}):OpenLayers.Layer.prototype.redraw.apply(this,[])},selectUrl:function(e,t){for(var i=1,n=0,s=e.length;s>n;n++)i*=e.charCodeAt(n)*this.URL_HASH_FACTOR,i-=Math.floor(i);return t[Math.floor(i*t.length)]},getFullRequestString:function(e,t){var i=t||this.url,n=OpenLayers.Util.extend({},this.params);n=OpenLayers.Util.extend(n,e);var s=OpenLayers.Util.getParameterString(n);OpenLayers.Util.isArray(i)&&(i=this.selectUrl(s,i));var a=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(i));for(var r in n)r.toUpperCase()in a&&delete n[r];return s=OpenLayers.Util.getParameterString(n),OpenLayers.Util.urlAppend(i,s)},CLASS_NAME:"OpenLayers.Layer.HTTPRequest"}),OpenLayers.Layer.Grid=OpenLayers.Class(OpenLayers.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,tileClass:OpenLayers.Tile.Image,grid:null,singleTile:!1,ratio:1.5,buffer:0,transitionEffect:null,numLoadingTiles:0,tileLoadingDelay:85,serverResolutions:null,moveTimerId:null,deferMoveGriddedTiles:null,tileQueueId:null,tileQueue:null,loading:!1,backBuffer:null,gridResolution:null,backBufferResolution:null,backBufferLonLat:null,backBufferTimerId:null,removeBackBufferDelay:null,className:null,initialize:function(){OpenLayers.Layer.HTTPRequest.prototype.initialize.apply(this,arguments),this.grid=[],this.tileQueue=[],null===this.removeBackBufferDelay&&(this.removeBackBufferDelay=this.singleTile?0:2500),null===this.className&&(this.className=this.singleTile?"olLayerGridSingleTile":"olLayerGrid"),OpenLayers.Animation.isNative||(this.deferMoveGriddedTiles=OpenLayers.Function.bind(function(){this.moveGriddedTiles(!0),this.moveTimerId=null},this))},setMap:function(e){OpenLayers.Layer.HTTPRequest.prototype.setMap.call(this,e),OpenLayers.Element.addClass(this.div,this.className)},removeMap:function(){null!==this.moveTimerId&&(window.clearTimeout(this.moveTimerId),this.moveTimerId=null),this.clearTileQueue(),null!==this.backBufferTimerId&&(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null)},destroy:function(){this.removeBackBuffer(),this.clearGrid(),this.grid=null,this.tileSize=null,OpenLayers.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.clearTileQueue(),this.grid){for(var e=0,t=this.grid.length;t>e;e++)for(var i=this.grid[e],n=0,s=i.length;s>n;n++){var a=i[n];this.destroyTile(a)}this.grid=[],this.gridResolution=null}},clone:function(e){return null==e&&(e=new OpenLayers.Layer.Grid(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[e]),null!=this.tileSize&&(e.tileSize=this.tileSize.clone()),e.grid=[],e.gridResolution=null,e.backBuffer=null,e.backBufferTimerId=null,e.tileQueue=[],e.tileQueueId=null,e.loading=!1,e.moveTimerId=null,e},moveTo:function(e,t,i){if(OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments),e=e||this.map.getExtent(),null!=e){var n=!this.grid.length||t,s=this.getTilesBounds(),a=this.map.getResolution(),r=this.getServerResolution(a);if(this.singleTile)(n||!i&&!s.containsBounds(e))&&(t&&"resize"!==this.transitionEffect&&this.removeBackBuffer(),t&&"resize"!==this.transitionEffect||this.applyBackBuffer(r),this.initSingleTile(e));else{if(n=n||!s.intersectsBounds(e,{worldBounds:this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent()}),a!==r){if(e=this.map.calculateBounds(null,r),n){var o=r/a;this.transformDiv(o)}}else this.div.style.width="100%",this.div.style.height="100%",this.div.style.left="0%",this.div.style.top="0%";n?(t&&"resize"===this.transitionEffect&&this.applyBackBuffer(r),this.initGriddedTiles(e)):this.moveGriddedTiles()}}},getTileData:function(e){var t=null,i=e.lon,n=e.lat,s=this.grid.length;if(this.map&&s){var a=this.map.getResolution(),r=this.tileSize.w,o=this.tileSize.h,l=this.grid[0][0].bounds,u=l.left,c=l.top;if(u>i&&this.map.baseLayer.wrapDateLine){var h=this.map.getMaxExtent().getWidth(),d=Math.ceil((u-i)/h);i+=h*d}var p=(i-u)/(a*r),f=(c-n)/(a*o),m=Math.floor(p),g=Math.floor(f);if(g>=0&&s>g){var y=this.grid[g][m];y&&(t={tile:y,i:Math.floor((p-m)*r),j:Math.floor((f-g)*o)})}}return t},queueTileDraw:function(e){var t=e.object;return~OpenLayers.Util.indexOf(this.tileQueue,t)||this.tileQueue.push(t),this.tileQueueId||(this.tileQueueId=OpenLayers.Animation.start(OpenLayers.Function.bind(this.drawTileFromQueue,this),null,this.div)),!1},drawTileFromQueue:function(){0===this.tileQueue.length?this.clearTileQueue():this.tileQueue.shift().draw(!0)},clearTileQueue:function(){OpenLayers.Animation.stop(this.tileQueueId),this.tileQueueId=null,this.tileQueue=[]},destroyTile:function(e){this.removeTileMonitoringHooks(e),e.destroy()},getServerResolution:function(e){if(e=e||this.map.getResolution(),this.serverResolutions&&-1===OpenLayers.Util.indexOf(this.serverResolutions,e)){var t,i;for(t=this.serverResolutions.length-1;t>=0;t--)if(i=this.serverResolutions[t],i>e){e=i;break}if(-1===t)throw"no appropriate resolution in serverResolutions"}return e},getServerZoom:function(){var e=this.getServerResolution();return this.serverResolutions?OpenLayers.Util.indexOf(this.serverResolutions,e):this.map.getZoomForResolution(e)+(this.zoomOffset||0)},transformDiv:function(e){this.div.style.width=100*e+"%",this.div.style.height=100*e+"%";var t=this.map.getSize(),i=parseInt(this.map.layerContainerDiv.style.left,10),n=parseInt(this.map.layerContainerDiv.style.top,10),s=(i-t.w/2)*(e-1),a=(n-t.h/2)*(e-1);this.div.style.left=s+"%",this.div.style.top=a+"%"},getResolutionScale:function(){return parseInt(this.div.style.width,10)/100},applyBackBuffer:function(e){null!==this.backBufferTimerId&&this.removeBackBuffer();var t=this.backBuffer;if(!t){if(t=this.createBackBuffer(),!t)return;this.div.insertBefore(t,this.div.firstChild),this.backBuffer=t;var i=this.grid[0][0].bounds;this.backBufferLonLat={lon:i.left,lat:i.top},this.backBufferResolution=this.gridResolution}var n=t.style,s=this.backBufferResolution/e;n.width=100*s+"%",n.height=100*s+"%";var a=this.getViewPortPxFromLonLat(this.backBufferLonLat,e),r=parseInt(this.map.layerContainerDiv.style.left,10),o=parseInt(this.map.layerContainerDiv.style.top,10);t.style.left=Math.round(a.x-r)+"%",t.style.top=Math.round(a.y-o)+"%"},createBackBuffer:function(){var e;if(this.grid.length>0){e=document.createElement("div"),e.id=this.div.id+"_bb",e.className="olBackBuffer",e.style.position="absolute",e.style.width="100%",e.style.height="100%";for(var t=0,i=this.grid.length;i>t;t++)for(var n=0,s=this.grid[t].length;s>n;n++){var a=this.grid[t][n].createBackBuffer();a&&(a.style.top=t*this.tileSize.h+"%",a.style.left=n*this.tileSize.w+"%",e.appendChild(a))}}return e},removeBackBuffer:function(){this.backBuffer&&(this.div.removeChild(this.backBuffer),this.backBuffer=null,this.backBufferResolution=null,null!==this.backBufferTimerId&&(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null))},moveByPx:function(){this.singleTile||this.moveGriddedTiles()},setTileSize:function(e){this.singleTile&&(e=this.map.getSize(),e.h=parseInt(e.h*this.ratio),e.w=parseInt(e.w*this.ratio)),OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this,[e])},getTilesBounds:function(){var e=null,t=this.grid.length;if(t){var i=this.grid[t-1][0].bounds,n=this.grid[0].length*i.getWidth(),s=this.grid.length*i.getHeight();e=new OpenLayers.Bounds(i.left,i.bottom,i.left+n,i.bottom+s)}return e},initSingleTile:function(e){this.clearTileQueue();var t=e.getCenterLonLat(),i=e.getWidth()*this.ratio,n=e.getHeight()*this.ratio,s=new OpenLayers.Bounds(t.lon-i/2,t.lat-n/2,t.lon+i/2,t.lat+n/2),a=this.map.getLayerPxFromLonLat({lon:s.left,lat:s.top});this.grid.length||(this.grid[0]=[]);var r=this.grid[0][0];r?r.moveTo(s,a):(r=this.addTile(s,a),this.addTileMonitoringHooks(r),r.draw(),this.grid[0][0]=r),this.removeExcessTiles(1,1),this.gridResolution=this.getServerResolution()},calculateGridLayout:function(e,t,i){var n=i*this.tileSize.w,s=i*this.tileSize.h,a=e.left-t.lon,r=Math.floor(a/n)-this.buffer,o=a/n-r,l=-o*this.tileSize.w,u=t.lon+r*n,c=e.top-(t.lat+s),h=Math.ceil(c/s)+this.buffer,d=h-c/s,p=-d*this.tileSize.h,f=t.lat+h*s;return{tilelon:n,tilelat:s,tileoffsetlon:u,tileoffsetlat:f,tileoffsetx:l,tileoffsety:p}},getTileOrigin:function(){var e=this.tileOrigin;if(!e){var t=this.getMaxExtent(),i={tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]}[this.tileOriginCorner];e=new OpenLayers.LonLat(t[i[0]],t[i[1]])}return e},initGriddedTiles:function(e){this.clearTileQueue();var t=this.map.getSize(),i=Math.ceil(t.h/this.tileSize.h)+Math.max(1,2*this.buffer),n=Math.ceil(t.w/this.tileSize.w)+Math.max(1,2*this.buffer),s=this.getTileOrigin(),a=this.getServerResolution(),r=this.calculateGridLayout(e,s,a),o=Math.round(r.tileoffsetx),l=Math.round(r.tileoffsety),u=r.tileoffsetlon,c=r.tileoffsetlat,h=r.tilelon,d=r.tilelat,p=o,f=u,m=0,g=parseInt(this.map.layerContainerDiv.style.left),y=parseInt(this.map.layerContainerDiv.style.top),v=[],b=this.map.getCenter();do{var _=this.grid[m++];_||(_=[],this.grid.push(_)),u=f,o=p;var w=0;do{var L=new OpenLayers.Bounds(u,c,u+h,c+d),k=o;k-=g;var O=l;O-=y;var x=new OpenLayers.Pixel(k,O),S=_[w++];S?S.moveTo(L,x,!1):(S=this.addTile(L,x),this.addTileMonitoringHooks(S),_.push(S));var C=L.getCenterLonLat();v.push({tile:S,distance:Math.pow(C.lon-b.lon,2)+Math.pow(C.lat-b.lat,2)}),u+=h,o+=this.tileSize.w}while(u<=e.right+h*this.buffer||n>w);c-=d,l+=this.tileSize.h}while(c>=e.bottom-d*this.buffer||i>m);this.removeExcessTiles(m,w),this.gridResolution=this.getServerResolution(),v.sort(function(e,t){return e.distance-t.distance});for(var M=0,P=v.length;P>M;++M)v[M].tile.draw()},getMaxExtent:function(){return this.maxExtent},addTile:function(e,t){var i=new this.tileClass(this,t,e,null,this.tileSize,this.tileOptions);return i.events.register("beforedraw",this,this.queueTileDraw),i},addTileMonitoringHooks:function(e){e.onLoadStart=function(){this.loading===!1&&(this.loading=!0,this.events.triggerEvent("loadstart")),this.events.triggerEvent("tileloadstart",{tile:e}),this.numLoadingTiles++},e.onLoadEnd=function(){this.numLoadingTiles--,this.events.triggerEvent("tileloaded",{tile:e}),0===this.tileQueue.length&&0===this.numLoadingTiles&&(this.loading=!1,this.events.triggerEvent("loadend"),this.backBuffer&&(this.backBufferTimerId=window.setTimeout(OpenLayers.Function.bind(this.removeBackBuffer,this),this.removeBackBufferDelay)))},e.onLoadError=function(){this.events.triggerEvent("tileerror",{tile:e})},e.events.on({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},removeTileMonitoringHooks:function(e){e.unload(),e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},moveGriddedTiles:function(e){if(!e&&!OpenLayers.Animation.isNative)return null!=this.moveTimerId&&window.clearTimeout(this.moveTimerId),this.moveTimerId=window.setTimeout(this.deferMoveGriddedTiles,this.tileLoadingDelay),void 0;for(var t=this.buffer||1,i=this.getResolutionScale();;){var n={x:this.grid[0][0].position.x*i+parseInt(this.div.style.left,10)+parseInt(this.map.layerContainerDiv.style.left),y:this.grid[0][0].position.y*i+parseInt(this.div.style.top,10)+parseInt(this.map.layerContainerDiv.style.top)},s={w:this.tileSize.w*i,h:this.tileSize.h*i};if(n.x>-s.w*(t-1))this.shiftColumn(!0);else if(n.x<-s.w*t)this.shiftColumn(!1);else if(n.y>-s.h*(t-1))this.shiftRow(!0);else{if(!(n.y<-s.h*t))break;this.shiftRow(!1)}}},shiftRow:function(e){for(var t=e?0:this.grid.length-1,i=this.grid,n=i[t],s=this.getServerResolution(),a=e?-this.tileSize.h:this.tileSize.h,r=s*-a,o=e?i.pop():i.shift(),l=0,u=n.length;u>l;l++){var c=n[l],h=c.bounds.clone(),d=c.position.clone();h.bottom=h.bottom+r,h.top=h.top+r,d.y=d.y+a,o[l].moveTo(h,d)}e?i.unshift(o):i.push(o)},shiftColumn:function(e){for(var t=e?-this.tileSize.w:this.tileSize.w,i=this.getServerResolution(),n=i*t,s=0,a=this.grid.length;a>s;s++){var r=this.grid[s],o=e?0:r.length-1,l=r[o],u=l.bounds.clone(),c=l.position.clone();u.left=u.left+n,u.right=u.right+n,c.x=c.x+t;var h=e?this.grid[s].pop():this.grid[s].shift();h.moveTo(u,c),e?r.unshift(h):r.push(h)}},removeExcessTiles:function(e,t){for(var i,n;this.grid.length>e;){var s=this.grid.pop();for(i=0,n=s.length;n>i;i++){var a=s[i];this.destroyTile(a)}}for(i=0,n=this.grid.length;n>i;i++)for(;this.grid[i].length>t;){var s=this.grid[i],a=s.pop();this.destroyTile(a)}},onMapResize:function(){this.singleTile&&(this.clearGrid(),this.setTileSize())},getTileBounds:function(e){var t=this.maxExtent,i=this.getResolution(),n=i*this.tileSize.w,s=i*this.tileSize.h,a=this.getLonLatFromViewPortPx(e),r=t.left+n*Math.floor((a.lon-t.left)/n),o=t.bottom+s*Math.floor((a.lat-t.bottom)/s);return new OpenLayers.Bounds(r,o,r+n,o+s)},CLASS_NAME:"OpenLayers.Layer.Grid"}),OpenLayers.Layer.Markers=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,markers:null,drawn:!1,initialize:function(){OpenLayers.Layer.prototype.initialize.apply(this,arguments),this.markers=[]},destroy:function(){this.clearMarkers(),this.markers=null,OpenLayers.Layer.prototype.destroy.apply(this,arguments)},setOpacity:function(e){if(e!=this.opacity){this.opacity=e;for(var t=0,i=this.markers.length;i>t;t++)this.markers[t].setOpacity(this.opacity)}},moveTo:function(e,t){if(OpenLayers.Layer.prototype.moveTo.apply(this,arguments),t||!this.drawn){for(var i=0,n=this.markers.length;n>i;i++)this.drawMarker(this.markers[i]);this.drawn=!0}},addMarker:function(e){this.markers.push(e),this.opacity<1&&e.setOpacity(this.opacity),this.map&&this.map.getExtent()&&(e.map=this.map,this.drawMarker(e))},removeMarker:function(e){this.markers&&this.markers.length&&(OpenLayers.Util.removeItem(this.markers,e),e.erase())},clearMarkers:function(){if(null!=this.markers)for(;this.markers.length>0;)this.removeMarker(this.markers[0])},drawMarker:function(e){var t=this.map.getLayerPxFromLonLat(e.lonlat);if(null==t)e.display(!1);else if(e.isDrawn())e.icon&&e.icon.moveTo(t);else{var i=e.draw(t);this.div.appendChild(i)}},getDataExtent:function(){var e=null;if(this.markers&&this.markers.length>0)for(var e=new OpenLayers.Bounds,t=0,i=this.markers.length;i>t;t++){var n=this.markers[t];e.extend(n.lonlat)}return e},CLASS_NAME:"OpenLayers.Layer.Markers"}),OpenLayers.Layer.WMS=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{service:"WMS",version:"1.1.1",request:"GetMap",styles:"",format:"image/jpeg"},isBaseLayer:!0,encodeBBOX:!1,noMagic:!1,yx:{},initialize:function(e,t,i,n){var s=[];i=OpenLayers.Util.upperCaseObject(i),parseFloat(i.VERSION)>=1.3&&!i.EXCEPTIONS&&(i.EXCEPTIONS="INIMAGE"),s.push(e,t,i,n),OpenLayers.Layer.Grid.prototype.initialize.apply(this,s),OpenLayers.Util.applyDefaults(this.params,OpenLayers.Util.upperCaseObject(this.DEFAULT_PARAMS)),!this.noMagic&&this.params.TRANSPARENT&&"true"==this.params.TRANSPARENT.toString().toLowerCase()&&(null!=n&&n.isBaseLayer||(this.isBaseLayer=!1),"image/jpeg"==this.params.FORMAT&&(this.params.FORMAT=OpenLayers.Util.alphaHack()?"image/gif":"image/png"))},clone:function(e){return null==e&&(e=new OpenLayers.Layer.WMS(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},reverseAxisOrder:function(){var e=this.projection.getCode();return parseFloat(this.params.VERSION)>=1.3&&!(!this.yx[e]&&!OpenLayers.Projection.defaults[e].yx)},getURL:function(e){e=this.adjustBounds(e);var t=this.getImageSize(),i={},n=this.reverseAxisOrder();i.BBOX=this.encodeBBOX?e.toBBOX(null,n):e.toArray(n),i.WIDTH=t.w,i.HEIGHT=t.h;var s=this.getFullRequestString(i);return s},mergeNewParams:function(e){var t=OpenLayers.Util.upperCaseObject(e),i=[t];return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,i)},getFullRequestString:function(e){var t=this.map.getProjectionObject(),i=this.projection&&this.projection.equals(t)?this.projection.getCode():t.getCode(),n="none"==i?null:i;return parseFloat(this.params.VERSION)>=1.3?this.params.CRS=n:this.params.SRS=n,"boolean"==typeof this.params.TRANSPARENT&&(e.TRANSPARENT=this.params.TRANSPARENT?"TRUE":"FALSE"),OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,arguments)},CLASS_NAME:"OpenLayers.Layer.WMS"}),OpenLayers.Layer.WMTS=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,serverResolutions:null,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(e){var t={url:!0,layer:!0,style:!0,matrixSet:!0};for(var i in t)if(!(i in e))throw new Error("Missing property '"+i+"' in layer configuration.");e.params=OpenLayers.Util.upperCaseObject(e.params);var n=[e.name,e.url,e.params,e];if(OpenLayers.Layer.Grid.prototype.initialize.apply(this,n),this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop()),this.matrixIds){var s=this.matrixIds.length;if(s&&"string"==typeof this.matrixIds[0]){var a=this.matrixIds;this.matrixIds=new Array(s);for(var r=0;s>r;++r)this.matrixIds[r]={identifier:a[r]}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.updateMatrixProperties()},updateMatrixProperties:function(){this.matrix=this.getMatrix(),this.matrix&&(this.matrix.topLeftCorner&&(this.tileOrigin=this.matrix.topLeftCorner),this.matrix.tileWidth&&this.matrix.tileHeight&&(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)),this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)),this.tileFullExtent||(this.tileFullExtent=this.maxExtent))},moveTo:function(e,t){return(t||!this.matrix)&&this.updateMatrixProperties(),OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.WMTS(this.options)),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},getIdentifier:function(){return this.getServerZoom()},getMatrix:function(){var e;if(this.matrixIds&&0!==this.matrixIds.length)if("scaleDenominator"in this.matrixIds[0])for(var t,i=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.getServerResolution()/28e-5,n=Number.POSITIVE_INFINITY,s=0,a=this.matrixIds.length;a>s;++s)t=Math.abs(1-this.matrixIds[s].scaleDenominator/i),n>t&&(n=t,e=this.matrixIds[s]);else e=this.matrixIds[this.getIdentifier()];else e={identifier:this.getIdentifier()};return e},getTileInfo:function(e){var t=this.getServerResolution(),i=(e.lon-this.tileOrigin.lon)/(t*this.tileSize.w),n=(this.tileOrigin.lat-e.lat)/(t*this.tileSize.h),s=Math.floor(i),a=Math.floor(n);return{col:s,row:a,i:Math.floor((i-s)*this.tileSize.w),j:Math.floor((n-a)*this.tileSize.h)}},getURL:function(e){e=this.adjustBounds(e);var t="";if(!this.tileFullExtent||this.tileFullExtent.intersectsBounds(e)){var i=e.getCenterLonLat(),n=this.getTileInfo(i);this.matrix.identifier;var s,a=this.dimensions;if("REST"===this.requestEncoding.toUpperCase())if(s=this.params,"string"==typeof this.url&&-1!==this.url.indexOf("{")){var r=this.url.replace(/\{/g,"${"),o={style:this.style,Style:this.style,TileMatrixSet:this.matrixSet,TileMatrix:this.matrix.identifier,TileRow:n.row,TileCol:n.col};if(a){var l,u;for(u=a.length-1;u>=0;--u)l=a[u],o[l]=s[l.toUpperCase()]}t=OpenLayers.String.format(r,o)}else{var c=this.version+"/"+this.layer+"/"+this.style+"/";if(a)for(var u=0;u<a.length;u++)s[a[u]]&&(c=c+s[a[u]]+"/");c=c+this.matrixSet+"/"+this.matrix.identifier+"/"+n.row+"/"+n.col+"."+this.formatSuffix,t=OpenLayers.Util.isArray(this.url)?this.selectUrl(c,this.url):this.url,t.match(/\/$/)||(t+="/"),t+=c}else"KVP"===this.requestEncoding.toUpperCase()&&(s={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:n.row,TILECOL:n.col,FORMAT:this.format},t=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[s]))}return t},mergeNewParams:function(e){return"KVP"===this.requestEncoding.toUpperCase()?OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(e)]):void 0},CLASS_NAME:"OpenLayers.Layer.WMTS"}),OpenLayers.Feature=OpenLayers.Class({layer:null,id:null,lonlat:null,data:null,marker:null,popupClass:null,popup:null,initialize:function(e,t,i){this.layer=e,this.lonlat=t,this.data=null!=i?i:{},this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){null!=this.layer&&null!=this.layer.map&&null!=this.popup&&this.layer.map.removePopup(this.popup),null!=this.layer&&null!=this.marker&&this.layer.removeMarker(this.marker),this.layer=null,this.id=null,this.lonlat=null,this.data=null,null!=this.marker&&(this.destroyMarker(this.marker),this.marker=null),null!=this.popup&&(this.destroyPopup(this.popup),this.popup=null)},onScreen:function(){var e=!1;if(null!=this.layer&&null!=this.layer.map){var t=this.layer.map.getExtent();e=t.containsLonLat(this.lonlat)}return e},createMarker:function(){return null!=this.lonlat&&(this.marker=new OpenLayers.Marker(this.lonlat,this.data.icon)),this.marker},destroyMarker:function(){this.marker.destroy()},createPopup:function(e){if(null!=this.lonlat){if(!this.popup){var t=this.marker?this.marker.icon:null,i=this.popupClass?this.popupClass:OpenLayers.Popup.Anchored;this.popup=new i(this.id+"_popup",this.lonlat,this.data.popupSize,this.data.popupContentHTML,t,e)}null!=this.data.overflow&&(this.popup.contentDiv.style.overflow=this.data.overflow),this.popup.feature=this}return this.popup},destroyPopup:function(){this.popup&&(this.popup.feature=null,this.popup.destroy(),this.popup=null)},CLASS_NAME:"OpenLayers.Feature"}),OpenLayers.State={UNKNOWN:"Unknown",INSERT:"Insert",UPDATE:"Update",DELETE:"Delete"},OpenLayers.Feature.Vector=OpenLayers.Class(OpenLayers.Feature,{fid:null,geometry:null,attributes:null,bounds:null,state:null,style:null,url:null,renderIntent:"default",modified:null,initialize:function(e,t,i){OpenLayers.Feature.prototype.initialize.apply(this,[null,null,t]),this.lonlat=null,this.geometry=e?e:null,this.state=null,this.attributes={},t&&(this.attributes=OpenLayers.Util.extend(this.attributes,t)),this.style=i?i:null},destroy:function(){this.layer&&(this.layer.removeFeatures(this),this.layer=null),this.geometry=null,this.modified=null,OpenLayers.Feature.prototype.destroy.apply(this,arguments)},clone:function(){return new OpenLayers.Feature.Vector(this.geometry?this.geometry.clone():null,this.attributes,this.style)},onScreen:function(e){var t=!1;if(this.layer&&this.layer.map){var i=this.layer.map.getExtent();if(e){var n=this.geometry.getBounds();t=i.intersectsBounds(n)}else{var s=i.toGeometry();t=s.intersects(this.geometry)}}return t},getVisibility:function(){return!(this.style&&"none"==this.style.display||!this.layer||this.layer&&this.layer.styleMap&&"none"==this.layer.styleMap.createSymbolizer(this,this.renderIntent).display||this.layer&&!this.layer.getVisibility())},createMarker:function(){return null},destroyMarker:function(){},createPopup:function(){return null},atPoint:function(e,t,i){var n=!1;return this.geometry&&(n=this.geometry.atPoint(e,t,i)),n},destroyPopup:function(){},move:function(e){if(!this.layer||!this.geometry.move)return void 0;var t;t="OpenLayers.LonLat"==e.CLASS_NAME?this.layer.getViewPortPxFromLonLat(e):e;
var i=this.layer.getViewPortPxFromLonLat(this.geometry.getBounds().getCenterLonLat()),n=this.layer.map.getResolution();return this.geometry.move(n*(t.x-i.x),n*(i.y-t.y)),this.layer.drawFeature(this),i},toState:function(e){if(e==OpenLayers.State.UPDATE)switch(this.state){case OpenLayers.State.UNKNOWN:case OpenLayers.State.DELETE:this.state=e;break;case OpenLayers.State.UPDATE:case OpenLayers.State.INSERT:}else if(e==OpenLayers.State.INSERT)switch(this.state){case OpenLayers.State.UNKNOWN:break;default:this.state=e}else if(e==OpenLayers.State.DELETE)switch(this.state){case OpenLayers.State.INSERT:break;case OpenLayers.State.DELETE:break;case OpenLayers.State.UNKNOWN:case OpenLayers.State.UPDATE:this.state=e}else e==OpenLayers.State.UNKNOWN&&(this.state=e)},CLASS_NAME:"OpenLayers.Feature.Vector"}),OpenLayers.Feature.Vector.style={"default":{fillColor:"#ee9900",fillOpacity:.4,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},select:{fillColor:"blue",fillOpacity:.4,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"blue",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"pointer",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},temporary:{fillColor:"#66cccc",fillOpacity:.2,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#66cccc",strokeOpacity:1,strokeLinecap:"round",strokeWidth:2,strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},"delete":{display:"none"}},OpenLayers.Handler=OpenLayers.Class({id:null,control:null,map:null,keyMask:null,active:!1,evt:null,initialize:function(e,t,i){OpenLayers.Util.extend(this,i),this.control=e,this.callbacks=t;var n=this.map||e.map;n&&this.setMap(n),this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},setMap:function(e){this.map=e},checkModifiers:function(e){if(null==this.keyMask)return!0;var t=(e.shiftKey?OpenLayers.Handler.MOD_SHIFT:0)|(e.ctrlKey?OpenLayers.Handler.MOD_CTRL:0)|(e.altKey?OpenLayers.Handler.MOD_ALT:0);return t==this.keyMask},activate:function(){if(this.active)return!1;for(var e=OpenLayers.Events.prototype.BROWSER_EVENTS,t=0,i=e.length;i>t;t++)this[e[t]]&&this.register(e[t],this[e[t]]);return this.active=!0,!0},deactivate:function(){if(!this.active)return!1;for(var e=OpenLayers.Events.prototype.BROWSER_EVENTS,t=0,i=e.length;i>t;t++)this[e[t]]&&this.unregister(e[t],this[e[t]]);return this.active=!1,!0},callback:function(e,t){e&&this.callbacks[e]&&this.callbacks[e].apply(this.control,t)},register:function(e,t){this.map.events.registerPriority(e,this,t),this.map.events.registerPriority(e,this,this.setEvent)},unregister:function(e,t){this.map.events.unregister(e,this,t),this.map.events.unregister(e,this,this.setEvent)},setEvent:function(e){return this.evt=e,!0},destroy:function(){this.deactivate(),this.control=this.map=null},CLASS_NAME:"OpenLayers.Handler"}),OpenLayers.Handler.MOD_NONE=0,OpenLayers.Handler.MOD_SHIFT=1,OpenLayers.Handler.MOD_CTRL=2,OpenLayers.Handler.MOD_ALT=4,OpenLayers.Handler.Click=OpenLayers.Class(OpenLayers.Handler,{delay:300,single:!0,"double":!1,pixelTolerance:0,dblclickTolerance:13,stopSingle:!1,stopDouble:!1,timerId:null,touch:!1,down:null,last:null,first:null,rightclickTimerId:null,touchstart:function(e){return this.touch||(this.unregisterMouseListeners(),this.touch=!0),this.down=this.getEventInfo(e),this.last=this.getEventInfo(e),!0},touchmove:function(e){return this.last=this.getEventInfo(e),!0},touchend:function(e){return this.down&&(e.xy=this.last.xy,e.lastTouches=this.last.touches,this.handleSingle(e),this.down=null),!0},unregisterMouseListeners:function(){this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,click:this.click,dblclick:this.dblclick,scope:this})},mousedown:function(e){return this.down=this.getEventInfo(e),this.last=this.getEventInfo(e),!0},mouseup:function(e){var t=!0;return this.checkModifiers(e)&&this.control.handleRightClicks&&OpenLayers.Event.isRightClick(e)&&(t=this.rightclick(e)),t},rightclick:function(e){if(this.passesTolerance(e)){if(null!=this.rightclickTimerId)return this.clearTimer(),this.callback("dblrightclick",[e]),!this.stopDouble;var t=this["double"]?OpenLayers.Util.extend({},e):this.callback("rightclick",[e]),i=OpenLayers.Function.bind(this.delayedRightCall,this,t);this.rightclickTimerId=window.setTimeout(i,this.delay)}return!this.stopSingle},delayedRightCall:function(e){this.rightclickTimerId=null,e&&this.callback("rightclick",[e])},click:function(e){return this.last||(this.last=this.getEventInfo(e)),this.handleSingle(e),!this.stopSingle},dblclick:function(e){return this.handleDouble(e),!this.stopDouble},handleDouble:function(e){this.passesDblclickTolerance(e)&&(this["double"]&&this.callback("dblclick",[e]),this.clearTimer())},handleSingle:function(e){if(this.passesTolerance(e))if(null!=this.timerId)this.last.touches&&1===this.last.touches.length&&(this["double"]&&OpenLayers.Event.stop(e),this.handleDouble(e)),this.last.touches&&2===this.last.touches.length||this.clearTimer();else{this.first=this.getEventInfo(e);var t=this.single?OpenLayers.Util.extend({},e):null;this.queuePotentialClick(t)}},queuePotentialClick:function(e){this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall,this,e),this.delay)},passesTolerance:function(e){var t=!0;if(null!=this.pixelTolerance&&this.down&&this.down.xy&&(t=this.pixelTolerance>=this.down.xy.distanceTo(e.xy),t&&this.touch&&this.down.touches.length===this.last.touches.length))for(var i=0,n=this.down.touches.length;n>i;++i)if(this.getTouchDistance(this.down.touches[i],this.last.touches[i])>this.pixelTolerance){t=!1;break}return t},getTouchDistance:function(e,t){return Math.sqrt(Math.pow(e.clientX-t.clientX,2)+Math.pow(e.clientY-t.clientY,2))},passesDblclickTolerance:function(){var e=!0;return this.down&&this.first&&(e=this.down.xy.distanceTo(this.first.xy)<=this.dblclickTolerance),e},clearTimer:function(){null!=this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null),null!=this.rightclickTimerId&&(window.clearTimeout(this.rightclickTimerId),this.rightclickTimerId=null)},delayedCall:function(e){this.timerId=null,e&&this.callback("click",[e])},getEventInfo:function(e){var t;if(e.touches){var i=e.touches.length;t=new Array(i);for(var n,s=0;i>s;s++)n=e.touches[s],t[s]={clientX:n.clientX,clientY:n.clientY}}return{xy:e.xy,touches:t}},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.clearTimer(),this.down=null,this.first=null,this.last=null,this.touch=!1,e=!0),e},CLASS_NAME:"OpenLayers.Handler.Click"}),OpenLayers.Handler.Hover=OpenLayers.Class(OpenLayers.Handler,{delay:500,pixelTolerance:null,stopMove:!1,px:null,timerId:null,mousemove:function(e){return this.passesTolerance(e.xy)&&(this.clearTimer(),this.callback("move",[e]),this.px=e.xy,e=OpenLayers.Util.extend({},e),this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall,this,e),this.delay)),!this.stopMove},mouseout:function(e){return OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv)&&(this.clearTimer(),this.callback("move",[e])),!0},passesTolerance:function(e){var t=!0;if(this.pixelTolerance&&this.px){var i=Math.sqrt(Math.pow(this.px.x-e.x,2)+Math.pow(this.px.y-e.y,2));i<this.pixelTolerance&&(t=!1)}return t},clearTimer:function(){null!=this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null)},delayedCall:function(e){this.callback("pause",[e])},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.clearTimer(),e=!0),e},CLASS_NAME:"OpenLayers.Handler.Hover"}),OpenLayers.Handler.Point=OpenLayers.Class(OpenLayers.Handler,{point:null,layer:null,multi:!1,citeCompliant:!1,mouseDown:!1,stoppedDown:null,lastDown:null,lastUp:null,persist:!1,stopDown:!1,stopUp:!1,layerOptions:null,pixelTolerance:5,touch:!1,lastTouchPx:null,initialize:function(e,t,i){i&&i.layerOptions&&i.layerOptions.styleMap||(this.style=OpenLayers.Util.extend(OpenLayers.Feature.Vector.style["default"],{})),OpenLayers.Handler.prototype.initialize.apply(this,arguments)},activate:function(){if(!OpenLayers.Handler.prototype.activate.apply(this,arguments))return!1;var e=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions);return this.layer=new OpenLayers.Layer.Vector(this.CLASS_NAME,e),this.map.addLayer(this.layer),!0},createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i),this.callback("create",[this.point.geometry,this.point]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.point],{silent:!0})},deactivate:function(){return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)?(this.cancel(),null!=this.layer.map&&(this.destroyFeature(!0),this.layer.destroy(!1)),this.layer=null,this.touch=!1,!0):!1},destroyFeature:function(e){!this.layer||!e&&this.persist||this.layer.destroyFeatures(),this.point=null},destroyPersistedFeature:function(){var e=this.layer;e&&e.features.length>1&&this.layer.features[0].destroy()},finalize:function(e){var t=e?"cancel":"done";this.mouseDown=!1,this.lastDown=null,this.lastUp=null,this.lastTouchPx=null,this.callback(t,[this.geometryClone()]),this.destroyFeature(e)},cancel:function(){this.finalize(!0)},click:function(e){return OpenLayers.Event.stop(e),!1},dblclick:function(e){return OpenLayers.Event.stop(e),!1},modifyFeature:function(e){this.point||this.createFeature(e);var t=this.layer.getLonLatFromViewPortPx(e);this.point.geometry.x=t.lon,this.point.geometry.y=t.lat,this.callback("modify",[this.point.geometry,this.point,!1]),this.point.geometry.clearBounds(),this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.point,this.style)},getGeometry:function(){var e=this.point&&this.point.geometry;return e&&this.multi&&(e=new OpenLayers.Geometry.MultiPoint([e])),e},geometryClone:function(){var e=this.getGeometry();return e&&e.clone()},mousedown:function(e){return this.down(e)},touchstart:function(e){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,dblclick:this.dblclick,scope:this})),this.lastTouchPx=e.xy,this.down(e)},mousemove:function(e){return this.move(e)},touchmove:function(e){return this.lastTouchPx=e.xy,this.move(e)},mouseup:function(e){return this.up(e)},touchend:function(e){return e.xy=this.lastTouchPx,this.up(e)},down:function(e){return this.mouseDown=!0,this.lastDown=e.xy,this.touch||this.modifyFeature(e.xy),this.stoppedDown=this.stopDown,!this.stopDown},move:function(e){return this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(e.xy),!0},up:function(e){return this.mouseDown=!1,this.stoppedDown=this.stopDown,this.checkModifiers(e)?this.lastUp&&this.lastUp.equals(e.xy)?!0:this.lastDown&&this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)?(this.touch&&this.modifyFeature(e.xy),this.persist&&this.destroyPersistedFeature(),this.lastUp=e.xy,this.finalize(),!this.stopUp):!0:!0},mouseout:function(e){OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv)&&(this.stoppedDown=this.stopDown,this.mouseDown=!1)},passesTolerance:function(e,t,i){var n=!0;if(null!=i&&e&&t){var s=e.distanceTo(t);s>i&&(n=!1)}return n},CLASS_NAME:"OpenLayers.Handler.Point"}),OpenLayers.Handler.Path=OpenLayers.Class(OpenLayers.Handler.Point,{line:null,maxVertices:null,doubleTouchTolerance:20,freehand:!1,freehandToggle:"shiftKey",timerId:null,redoStack:null,createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i),this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([this.point.geometry])),this.callback("create",[this.point.geometry,this.getSketch()]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.line,this.point],{silent:!0})},destroyFeature:function(e){OpenLayers.Handler.Point.prototype.destroyFeature.call(this,e),this.line=null},destroyPersistedFeature:function(){var e=this.layer;e&&e.features.length>2&&this.layer.features[0].destroy()},removePoint:function(){this.point&&this.layer.removeFeatures([this.point])},addPoint:function(e){this.layer.removeFeatures([this.point]);var t=this.layer.getLonLatFromViewPortPx(e);this.point=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(t.lon,t.lat)),this.line.geometry.addComponent(this.point.geometry,this.line.geometry.components.length),this.layer.addFeatures([this.point]),this.callback("point",[this.point.geometry,this.getGeometry()]),this.callback("modify",[this.point.geometry,this.getSketch()]),this.drawFeature(),delete this.redoStack},insertXY:function(e,t){this.line.geometry.addComponent(new OpenLayers.Geometry.Point(e,t),this.getCurrentPointIndex()),this.drawFeature(),delete this.redoStack},insertDeltaXY:function(e,t){var i=this.getCurrentPointIndex()-1,n=this.line.geometry.components[i];!n||isNaN(n.x)||isNaN(n.y)||this.insertXY(n.x+e,n.y+t)},insertDirectionLength:function(e,t){e*=Math.PI/180;var i=t*Math.cos(e),n=t*Math.sin(e);this.insertDeltaXY(i,n)},insertDeflectionLength:function(e,t){var i=this.getCurrentPointIndex()-1;if(i>0){var n=this.line.geometry.components[i],s=this.line.geometry.components[i-1],a=Math.atan2(n.y-s.y,n.x-s.x);this.insertDirectionLength(180*a/Math.PI+e,t)}},getCurrentPointIndex:function(){return this.line.geometry.components.length-1},undo:function(){var e=this.line.geometry,t=e.components,i=this.getCurrentPointIndex()-1,n=t[i],s=e.removeComponent(n);return s&&(this.redoStack||(this.redoStack=[]),this.redoStack.push(n),this.drawFeature()),s},redo:function(){var e=this.redoStack&&this.redoStack.pop();return e&&(this.line.geometry.addComponent(e,this.getCurrentPointIndex()),this.drawFeature()),!!e},freehandMode:function(e){return this.freehandToggle&&e[this.freehandToggle]?!this.freehand:this.freehand},modifyFeature:function(e,t){this.line||this.createFeature(e);var i=this.layer.getLonLatFromViewPortPx(e);this.point.geometry.x=i.lon,this.point.geometry.y=i.lat,this.callback("modify",[this.point.geometry,this.getSketch(),t]),this.point.geometry.clearBounds(),this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.line,this.style),this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.line},getGeometry:function(){var e=this.line&&this.line.geometry;return e&&this.multi&&(e=new OpenLayers.Geometry.MultiLineString([e])),e},touchstart:function(e){return this.timerId&&this.passesTolerance(this.lastTouchPx,e.xy,this.doubleTouchTolerance)?(this.finishGeometry(),window.clearTimeout(this.timerId),this.timerId=null,!1):(this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null),this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){this.timerId=null},this),300),OpenLayers.Handler.Point.prototype.touchstart.call(this,e))},down:function(e){var t=this.stopDown;return this.freehandMode(e)&&(t=!0,this.touch&&(this.modifyFeature(e.xy,!!this.lastUp),OpenLayers.Event.stop(e))),this.touch||this.lastDown&&this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)||this.modifyFeature(e.xy,!!this.lastUp),this.mouseDown=!0,this.lastDown=e.xy,this.stoppedDown=t,!t},move:function(e){return this.stoppedDown&&this.freehandMode(e)?(this.persist&&this.destroyPersistedFeature(),this.maxVertices&&this.line&&this.line.geometry.components.length===this.maxVertices?(this.removePoint(),this.finalize()):this.addPoint(e.xy),!1):(this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(e.xy,!!this.lastUp),!0)},up:function(e){return!this.mouseDown||this.lastUp&&this.lastUp.equals(e.xy)||(this.stoppedDown&&this.freehandMode(e)?(this.persist&&this.destroyPersistedFeature(),this.removePoint(),this.finalize()):this.passesTolerance(this.lastDown,e.xy,this.pixelTolerance)&&(this.touch&&this.modifyFeature(e.xy),null==this.lastUp&&this.persist&&this.destroyPersistedFeature(),this.addPoint(e.xy),this.lastUp=e.xy,this.line.geometry.components.length===this.maxVertices+1&&this.finishGeometry())),this.stoppedDown=this.stopDown,this.mouseDown=!1,!this.stopUp},finishGeometry:function(){var e=this.line.geometry.components.length-1;this.line.geometry.removeComponent(this.line.geometry.components[e]),this.removePoint(),this.finalize()},dblclick:function(e){return this.freehandMode(e)||this.finishGeometry(),!1},CLASS_NAME:"OpenLayers.Handler.Path"}),OpenLayers.Handler.Polygon=OpenLayers.Class(OpenLayers.Handler.Path,{holeModifier:null,drawingHole:!1,polygon:null,createFeature:function(e){var t=this.layer.getLonLatFromViewPortPx(e),i=new OpenLayers.Geometry.Point(t.lon,t.lat);this.point=new OpenLayers.Feature.Vector(i),this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LinearRing([this.point.geometry])),this.polygon=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([this.line.geometry])),this.callback("create",[this.point.geometry,this.getSketch()]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.polygon,this.point],{silent:!0})},addPoint:function(){if(!this.drawingHole&&this.holeModifier&&this.evt&&this.evt[this.holeModifier])for(var e,t,i=this.point.geometry,n=this.control.layer.features,s=n.length-1;s>=0;--s)if(e=n[s].geometry,(e instanceof OpenLayers.Geometry.Polygon||e instanceof OpenLayers.Geometry.MultiPolygon)&&e.intersects(i)){t=n[s],this.control.layer.removeFeatures([t],{silent:!0}),this.control.layer.events.registerPriority("sketchcomplete",this,this.finalizeInteriorRing),this.control.layer.events.registerPriority("sketchmodified",this,this.enforceTopology),t.geometry.addComponent(this.line.geometry),this.polygon=t,this.drawingHole=!0;break}OpenLayers.Handler.Path.prototype.addPoint.apply(this,arguments)},getCurrentPointIndex:function(){return this.line.geometry.components.length-2},enforceTopology:function(e){var t=e.vertex,i=this.line.geometry.components;if(!this.polygon.geometry.intersects(t)){var n=i[i.length-3];t.x=n.x,t.y=n.y}},finishGeometry:function(){var e=this.line.geometry.components.length-2;this.line.geometry.removeComponent(this.line.geometry.components[e]),this.removePoint(),this.finalize()},finalizeInteriorRing:function(){var e=this.line.geometry,t=0!==e.getArea();if(t){for(var i=this.polygon.geometry.components,n=i.length-2;n>=0;--n)if(e.intersects(i[n])){t=!1;break}if(t)e:for(var n=i.length-2;n>0;--n)for(var s=i[n].components,a=0,r=s.length;r>a;++a)if(e.containsPoint(s[a])){t=!1;break e}}return t?this.polygon.state!==OpenLayers.State.INSERT&&(this.polygon.state=OpenLayers.State.UPDATE):this.polygon.geometry.removeComponent(e),this.restoreFeature(),!1},cancel:function(){return this.drawingHole&&(this.polygon.geometry.removeComponent(this.line.geometry),this.restoreFeature(!0)),OpenLayers.Handler.Path.prototype.cancel.apply(this,arguments)},restoreFeature:function(e){this.control.layer.events.unregister("sketchcomplete",this,this.finalizeInteriorRing),this.control.layer.events.unregister("sketchmodified",this,this.enforceTopology),this.layer.removeFeatures([this.polygon],{silent:!0}),this.control.layer.addFeatures([this.polygon],{silent:!0}),this.drawingHole=!1,e||this.control.layer.events.triggerEvent("sketchcomplete",{feature:this.polygon})},destroyFeature:function(e){OpenLayers.Handler.Path.prototype.destroyFeature.call(this,e),this.polygon=null},drawFeature:function(){this.layer.drawFeature(this.polygon,this.style),this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.polygon},getGeometry:function(){var e=this.polygon&&this.polygon.geometry;return e&&this.multi&&(e=new OpenLayers.Geometry.MultiPolygon([e])),e},CLASS_NAME:"OpenLayers.Handler.Polygon"}),OpenLayers.Handler.Feature=OpenLayers.Class(OpenLayers.Handler,{EVENTMAP:{click:{"in":"click",out:"clickout"},mousemove:{"in":"over",out:"out"},dblclick:{"in":"dblclick",out:null},mousedown:{"in":null,out:null},mouseup:{"in":null,out:null},touchstart:{"in":"click",out:"clickout"}},feature:null,lastFeature:null,down:null,up:null,touch:!1,clickTolerance:4,geometryTypes:null,stopClick:!0,stopDown:!0,stopUp:!1,initialize:function(e,t,i,n){OpenLayers.Handler.prototype.initialize.apply(this,[e,i,n]),this.layer=t},touchstart:function(e){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,dblclick:this.dblclick,scope:this})),OpenLayers.Event.isMultiTouch(e)?!0:this.mousedown(e)},touchmove:function(e){OpenLayers.Event.stop(e)},mousedown:function(e){return(OpenLayers.Event.isLeftClick(e)||OpenLayers.Event.isSingleTouch(e))&&(this.down=e.xy),this.handle(e)?!this.stopDown:!0},mouseup:function(e){return this.up=e.xy,this.handle(e)?!this.stopUp:!0},click:function(e){return this.handle(e)?!this.stopClick:!0},mousemove:function(e){return this.callbacks.over||this.callbacks.out?(this.handle(e),!0):!0},dblclick:function(e){return!this.handle(e)},geometryTypeMatches:function(e){return null==this.geometryTypes||OpenLayers.Util.indexOf(this.geometryTypes,e.geometry.CLASS_NAME)>-1},handle:function(e){this.feature&&!this.feature.layer&&(this.feature=null);var t=e.type,i=!1,n=!!this.feature,s="click"==t||"dblclick"==t||"touchstart"==t;if(this.feature=this.layer.getFeatureFromEvent(e),this.feature&&!this.feature.layer&&(this.feature=null),this.lastFeature&&!this.lastFeature.layer&&(this.lastFeature=null),this.feature){"touchstart"===t&&OpenLayers.Event.stop(e);var a=this.feature!=this.lastFeature;this.geometryTypeMatches(this.feature)?(n&&a?(this.lastFeature&&this.triggerCallback(t,"out",[this.lastFeature]),this.triggerCallback(t,"in",[this.feature])):(!n||s)&&this.triggerCallback(t,"in",[this.feature]),this.lastFeature=this.feature,i=!0):(this.lastFeature&&(n&&a||s)&&this.triggerCallback(t,"out",[this.lastFeature]),this.feature=null)}else this.lastFeature&&(n||s)&&this.triggerCallback(t,"out",[this.lastFeature]);return i},triggerCallback:function(e,t,i){var n=this.EVENTMAP[e][t];if(n)if("click"==e&&this.up&&this.down){var s=Math.sqrt(Math.pow(this.up.x-this.down.x,2)+Math.pow(this.up.y-this.down.y,2));s<=this.clickTolerance&&this.callback(n,i)}else this.callback(n,i)},activate:function(){var e=!1;return OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.moveLayerToTop(),this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.moveLayerBack(),this.feature=null,this.lastFeature=null,this.down=null,this.up=null,this.touch=!1,this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),e=!0),e},handleMapEvents:function(e){("removelayer"==e.type||"order"==e.property)&&this.moveLayerToTop()},moveLayerToTop:function(){var e=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(e)},moveLayerBack:function(){var e=this.layer.getZIndex()-1;e>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(e):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Handler.Feature"}),OpenLayers.Handler.Drag=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!0,dragging:!1,touch:!1,last:null,start:null,lastMoveEvt:null,oldOnselectstart:null,interval:0,timeoutId:null,documentDrag:!1,documentEvents:null,initialize:function(){if(OpenLayers.Handler.prototype.initialize.apply(this,arguments),this.documentDrag===!0){var e=this;this._docMove=function(t){e.mousemove({xy:{x:t.clientX,y:t.clientY},element:document})},this._docUp=function(t){e.mouseup({xy:{x:t.clientX,y:t.clientY}})}}},dragstart:function(e){var t=!0;return this.dragging=!1,this.checkModifiers(e)&&(OpenLayers.Event.isLeftClick(e)||OpenLayers.Event.isSingleTouch(e))?(this.started=!0,this.start=e.xy,this.last=e.xy,OpenLayers.Element.addClass(this.map.viewPortDiv,"olDragDown"),this.down(e),this.callback("down",[e.xy]),OpenLayers.Event.stop(e),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart?document.onselectstart:OpenLayers.Function.True),document.onselectstart=OpenLayers.Function.False,t=!this.stopDown):(this.started=!1,this.start=null,this.last=null),t},dragmove:function(e){return this.lastMoveEvt=e,!this.started||this.timeoutId||e.xy.x==this.last.x&&e.xy.y==this.last.y||(this.documentDrag===!0&&this.documentEvents&&(e.element===document?(this.adjustXY(e),this.setEvent(e)):this.removeDocumentEvents()),this.interval>0&&(this.timeoutId=setTimeout(OpenLayers.Function.bind(this.removeTimeout,this),this.interval)),this.dragging=!0,this.move(e),this.callback("move",[e.xy]),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart,document.onselectstart=OpenLayers.Function.False),this.last=e.xy),!0},dragend:function(e){if(this.started){this.documentDrag===!0&&this.documentEvents&&(this.adjustXY(e),this.removeDocumentEvents());var t=this.start!=this.last;this.started=!1,this.dragging=!1,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown"),this.up(e),this.callback("up",[e.xy]),t&&this.callback("done",[e.xy]),document.onselectstart=this.oldOnselectstart}return!0},down:function(){},move:function(){},up:function(){},out:function(){},mousedown:function(e){return this.dragstart(e)},touchstart:function(e){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,scope:this})),this.dragstart(e)},mousemove:function(e){return this.dragmove(e)},touchmove:function(e){return this.dragmove(e)},removeTimeout:function(){this.timeoutId=null,this.dragging&&this.mousemove(this.lastMoveEvt)},mouseup:function(e){return this.dragend(e)},touchend:function(e){return e.xy=this.last,this.dragend(e)},mouseout:function(e){if(this.started&&OpenLayers.Util.mouseLeft(e,this.map.viewPortDiv))if(this.documentDrag===!0)this.addDocumentEvents();else{var t=this.start!=this.last;this.started=!1,this.dragging=!1,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown"),this.out(e),this.callback("out",[]),t&&this.callback("done",[e.xy]),document.onselectstart&&(document.onselectstart=this.oldOnselectstart)}return!0},click:function(){return this.start==this.last},activate:function(){var e=!1;return OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.dragging=!1,e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.touch=!1,this.started=!1,this.dragging=!1,this.start=null,this.last=null,e=!0,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDragDown")),e},adjustXY:function(e){var t=OpenLayers.Util.pagePosition(this.map.viewPortDiv);e.xy.x-=t[0],e.xy.y-=t[1]},addDocumentEvents:function(){OpenLayers.Element.addClass(document.body,"olDragDown"),this.documentEvents=!0,OpenLayers.Event.observe(document,"mousemove",this._docMove),OpenLayers.Event.observe(document,"mouseup",this._docUp)},removeDocumentEvents:function(){OpenLayers.Element.removeClass(document.body,"olDragDown"),this.documentEvents=!1,OpenLayers.Event.stopObserving(document,"mousemove",this._docMove),OpenLayers.Event.stopObserving(document,"mouseup",this._docUp)},CLASS_NAME:"OpenLayers.Handler.Drag"}),OpenLayers.Handler.Pinch=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!1,pinching:!1,last:null,start:null,touchstart:function(e){var t=!0;return this.pinching=!1,OpenLayers.Event.isMultiTouch(e)?(this.started=!0,this.last=this.start={distance:this.getDistance(e.touches),delta:0,scale:1},this.callback("start",[e,this.start]),t=!this.stopDown):(this.started=!1,this.start=null,this.last=null),OpenLayers.Event.stop(e),t},touchmove:function(e){if(this.started&&OpenLayers.Event.isMultiTouch(e)){this.pinching=!0;var t=this.getPinchData(e);this.callback("move",[e,t]),this.last=t,OpenLayers.Event.stop(e)}return!0},touchend:function(e){return this.started&&(this.started=!1,this.pinching=!1,this.callback("done",[e,this.start,this.last]),this.start=null,this.last=null),!0},activate:function(){var e=!1;return OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.pinching=!1,e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.started=!1,this.pinching=!1,this.start=null,this.last=null,e=!0),e},getDistance:function(e){var t=e[0],i=e[1];return Math.sqrt(Math.pow(t.clientX-i.clientX,2)+Math.pow(t.clientY-i.clientY,2))},getPinchData:function(e){var t=this.getDistance(e.touches),i=t/this.start.distance;return{distance:t,delta:this.last.distance-t,scale:i}},CLASS_NAME:"OpenLayers.Handler.Pinch"}),OpenLayers.Handler.RegularPolygon=OpenLayers.Class(OpenLayers.Handler.Drag,{sides:4,radius:null,snapAngle:null,snapToggle:"shiftKey",layerOptions:null,persist:!1,irregular:!1,citeCompliant:!1,angle:null,fixedRadius:!1,feature:null,layer:null,origin:null,initialize:function(e,t,i){i&&i.layerOptions&&i.layerOptions.styleMap||(this.style=OpenLayers.Util.extend(OpenLayers.Feature.Vector.style["default"],{})),OpenLayers.Handler.Drag.prototype.initialize.apply(this,[e,t,i]),this.options=i?i:{}},setOptions:function(e){OpenLayers.Util.extend(this.options,e),OpenLayers.Util.extend(this,e)},activate:function(){var e=!1;if(OpenLayers.Handler.Drag.prototype.activate.apply(this,arguments)){var t=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions);this.layer=new OpenLayers.Layer.Vector(this.CLASS_NAME,t),this.map.addLayer(this.layer),e=!0}return e},deactivate:function(){var e=!1;return OpenLayers.Handler.Drag.prototype.deactivate.apply(this,arguments)&&(this.dragging&&this.cancel(),null!=this.layer.map&&(this.layer.destroy(!1),this.feature&&this.feature.destroy()),this.layer=null,this.feature=null,e=!0),e},down:function(e){this.fixedRadius=!!this.radius;var t=this.layer.getLonLatFromViewPortPx(e.xy);this.origin=new OpenLayers.Geometry.Point(t.lon,t.lat),(!this.fixedRadius||this.irregular)&&(this.radius=this.map.getResolution()),this.persist&&this.clear(),this.feature=new OpenLayers.Feature.Vector,this.createGeometry(),this.callback("create",[this.origin,this.feature]),this.layer.addFeatures([this.feature],{silent:!0}),this.layer.drawFeature(this.feature,this.style)},move:function(e){var t=this.layer.getLonLatFromViewPortPx(e.xy),i=new OpenLayers.Geometry.Point(t.lon,t.lat);if(this.irregular){var n=Math.sqrt(2)*Math.abs(i.y-this.origin.y)/2;this.radius=Math.max(this.map.getResolution()/2,n)}else this.fixedRadius?this.origin=i:(this.calculateAngle(i,e),this.radius=Math.max(this.map.getResolution()/2,i.distanceTo(this.origin)));if(this.modifyGeometry(),this.irregular){var s,a=i.x-this.origin.x,r=i.y-this.origin.y;s=0==r?a/(this.radius*Math.sqrt(2)):a/r,this.feature.geometry.resize(1,this.origin,s),this.feature.geometry.move(a/2,r/2)}this.layer.drawFeature(this.feature,this.style)},up:function(e){this.finalize(),this.start==this.last&&this.callback("done",[e.xy])},out:function(){this.finalize()},createGeometry:function(){this.angle=Math.PI*(1/this.sides-.5),this.snapAngle&&(this.angle+=this.snapAngle*(Math.PI/180)),this.feature.geometry=OpenLayers.Geometry.Polygon.createRegularPolygon(this.origin,this.radius,this.sides,this.snapAngle)},modifyGeometry:function(){var e,t,i=this.feature.geometry.components[0];
i.components.length!=this.sides+1&&(this.createGeometry(),i=this.feature.geometry.components[0]);for(var n=0;n<this.sides;++n)t=i.components[n],e=this.angle+2*n*Math.PI/this.sides,t.x=this.origin.x+this.radius*Math.cos(e),t.y=this.origin.y+this.radius*Math.sin(e),t.clearBounds()},calculateAngle:function(e,t){var i=Math.atan2(e.y-this.origin.y,e.x-this.origin.x);if(this.snapAngle&&this.snapToggle&&!t[this.snapToggle]){var n=Math.PI/180*this.snapAngle;this.angle=Math.round(i/n)*n}else this.angle=i},cancel:function(){this.callback("cancel",null),this.finalize()},finalize:function(){this.origin=null,this.radius=this.options.radius},clear:function(){this.layer&&(this.layer.renderer.clear(),this.layer.destroyFeatures())},callback:function(e){this.callbacks[e]&&this.callbacks[e].apply(this.control,[this.feature.geometry.clone()]),this.persist||"done"!=e&&"cancel"!=e||this.clear()},CLASS_NAME:"OpenLayers.Handler.RegularPolygon"}),OpenLayers.Handler.Box=OpenLayers.Class(OpenLayers.Handler,{dragHandler:null,boxDivClassName:"olHandlerBoxZoomBox",boxOffsets:null,initialize:function(){OpenLayers.Handler.prototype.initialize.apply(this,arguments),this.dragHandler=new OpenLayers.Handler.Drag(this,{down:this.startBox,move:this.moveBox,out:this.removeBox,up:this.endBox},{keyMask:this.keyMask})},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments),this.dragHandler&&(this.dragHandler.destroy(),this.dragHandler=null)},setMap:function(e){OpenLayers.Handler.prototype.setMap.apply(this,arguments),this.dragHandler&&this.dragHandler.setMap(e)},startBox:function(){this.callback("start",[]),this.zoomBox=OpenLayers.Util.createDiv("zoomBox",{x:-9999,y:-9999}),this.zoomBox.className=this.boxDivClassName,this.zoomBox.style.zIndex=this.map.Z_INDEX_BASE.Popup-1,this.map.viewPortDiv.appendChild(this.zoomBox),OpenLayers.Element.addClass(this.map.viewPortDiv,"olDrawBox")},moveBox:function(e){var t=this.dragHandler.start.x,i=this.dragHandler.start.y,n=Math.abs(t-e.x),s=Math.abs(i-e.y),a=this.getBoxOffsets();this.zoomBox.style.width=n+a.width+1+"px",this.zoomBox.style.height=s+a.height+1+"px",this.zoomBox.style.left=(e.x<t?t-n-a.left:t-a.left)+"px",this.zoomBox.style.top=(e.y<i?i-s-a.top:i-a.top)+"px"},endBox:function(e){var t;if(Math.abs(this.dragHandler.start.x-e.x)>5||Math.abs(this.dragHandler.start.y-e.y)>5){var i=this.dragHandler.start,n=Math.min(i.y,e.y),s=Math.max(i.y,e.y),a=Math.min(i.x,e.x),r=Math.max(i.x,e.x);t=new OpenLayers.Bounds(a,s,r,n)}else t=this.dragHandler.start.clone();this.removeBox(),this.callback("done",[t])},removeBox:function(){this.map.viewPortDiv.removeChild(this.zoomBox),this.zoomBox=null,this.boxOffsets=null,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olDrawBox")},activate:function(){return OpenLayers.Handler.prototype.activate.apply(this,arguments)?(this.dragHandler.activate(),!0):!1},deactivate:function(){return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)?(this.dragHandler.deactivate()&&this.zoomBox&&this.removeBox(),!0):!1},getBoxOffsets:function(){if(!this.boxOffsets){var e=document.createElement("div");e.style.position="absolute",e.style.border="1px solid black",e.style.width="3px",document.body.appendChild(e);var t=3==e.clientWidth;document.body.removeChild(e);var i=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-left-width")),n=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-right-width")),s=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-top-width")),a=parseInt(OpenLayers.Element.getStyle(this.zoomBox,"border-bottom-width"));this.boxOffsets={left:i,right:n,top:s,bottom:a,width:t===!1?i+n:0,height:t===!1?s+a:0}}return this.boxOffsets},CLASS_NAME:"OpenLayers.Handler.Box"}),OpenLayers.Handler.MouseWheel=OpenLayers.Class(OpenLayers.Handler,{wheelListener:null,mousePosition:null,interval:0,delta:0,cumulative:!0,initialize:function(){OpenLayers.Handler.prototype.initialize.apply(this,arguments),this.wheelListener=OpenLayers.Function.bindAsEventListener(this.onWheelEvent,this)},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments),this.wheelListener=null},onWheelEvent:function(e){if(this.map&&this.checkModifiers(e)){for(var t=!1,i=!1,n=!1,s=OpenLayers.Event.element(e);null!=s&&!n&&!t;){if(!t)try{if(s.currentStyle)r=s.currentStyle.overflow;else var a=document.defaultView.getComputedStyle(s,null),r=a.getPropertyValue("overflow");t=r&&"auto"==r||"scroll"==r}catch(o){}if(!i)for(var l=0,u=this.map.layers.length;u>l;l++)if(s==this.map.layers[l].div||s==this.map.layers[l].pane){i=!0;break}n=s==this.map.div,s=s.parentNode}if(!t&&n){if(i){var c=0;e||(e=window.event),e.wheelDelta?(c=e.wheelDelta/120,window.opera&&window.opera.version()<9.2&&(c=-c)):e.detail&&(c=-e.detail/3),this.delta=this.delta+c,this.interval?(window.clearTimeout(this._timeoutId),this._timeoutId=window.setTimeout(OpenLayers.Function.bind(function(){this.wheelZoom(e)},this),this.interval)):this.wheelZoom(e)}OpenLayers.Event.stop(e)}}},wheelZoom:function(e){var t=this.delta;this.delta=0,t&&(this.mousePosition&&(e.xy=this.mousePosition),e.xy||(e.xy=this.map.getPixelFromLonLat(this.map.getCenter())),0>t?this.callback("down",[e,this.cumulative?t:-1]):this.callback("up",[e,this.cumulative?t:1]))},mousemove:function(e){this.mousePosition=e.xy},activate:function(){if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){var e=this.wheelListener;return OpenLayers.Event.observe(window,"DOMMouseScroll",e),OpenLayers.Event.observe(window,"mousewheel",e),OpenLayers.Event.observe(document,"mousewheel",e),!0}return!1},deactivate:function(){if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){var e=this.wheelListener;return OpenLayers.Event.stopObserving(window,"DOMMouseScroll",e),OpenLayers.Event.stopObserving(window,"mousewheel",e),OpenLayers.Event.stopObserving(document,"mousewheel",e),!0}return!1},CLASS_NAME:"OpenLayers.Handler.MouseWheel"}),OpenLayers.Handler.Keyboard=OpenLayers.Class(OpenLayers.Handler,{KEY_EVENTS:["keydown","keyup"],eventListener:null,observeElement:null,initialize:function(){OpenLayers.Handler.prototype.initialize.apply(this,arguments),this.eventListener=OpenLayers.Function.bindAsEventListener(this.handleKeyEvent,this)},destroy:function(){this.deactivate(),this.eventListener=null,OpenLayers.Handler.prototype.destroy.apply(this,arguments)},activate:function(){if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){this.observeElement=this.observeElement||document;for(var e=0,t=this.KEY_EVENTS.length;t>e;e++)OpenLayers.Event.observe(this.observeElement,this.KEY_EVENTS[e],this.eventListener);return!0}return!1},deactivate:function(){var e=!1;if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){for(var t=0,i=this.KEY_EVENTS.length;i>t;t++)OpenLayers.Event.stopObserving(this.observeElement,this.KEY_EVENTS[t],this.eventListener);e=!0}return e},handleKeyEvent:function(e){this.checkModifiers(e)&&this.callback(e.type,[e])},CLASS_NAME:"OpenLayers.Handler.Keyboard"}),OpenLayers.Control=OpenLayers.Class({id:null,map:null,div:null,type:null,allowSelection:!1,displayClass:"",title:"",autoActivate:!1,active:null,handler:null,eventListeners:null,events:null,initialize:function(e){this.displayClass=this.CLASS_NAME.replace("OpenLayers.","ol").replace(/\./g,""),OpenLayers.Util.extend(this,e),this.events=new OpenLayers.Events(this),this.eventListeners instanceof Object&&this.events.on(this.eventListeners),null==this.id&&(this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"))},destroy:function(){if(this.events&&(this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy(),this.events=null),this.eventListeners=null,this.handler&&(this.handler.destroy(),this.handler=null),this.handlers){for(var e in this.handlers)this.handlers.hasOwnProperty(e)&&"function"==typeof this.handlers[e].destroy&&this.handlers[e].destroy();this.handlers=null}this.map&&(this.map.removeControl(this),this.map=null),this.div=null},setMap:function(e){this.map=e,this.handler&&this.handler.setMap(e)},draw:function(e){return null==this.div&&(this.div=OpenLayers.Util.createDiv(this.id),this.div.className=this.displayClass,this.allowSelection||(this.div.className+=" olControlNoSelect",this.div.setAttribute("unselectable","on",0),this.div.onselectstart=OpenLayers.Function.False),""!=this.title&&(this.div.title=this.title)),null!=e&&(this.position=e.clone()),this.moveTo(this.position),this.div},moveTo:function(e){null!=e&&null!=this.div&&(this.div.style.left=e.x+"px",this.div.style.top=e.y+"px")},activate:function(){return this.active?!1:(this.handler&&this.handler.activate(),this.active=!0,this.map&&OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active"),this.events.triggerEvent("activate"),!0)},deactivate:function(){return this.active?(this.handler&&this.handler.deactivate(),this.active=!1,this.map&&OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active"),this.events.triggerEvent("deactivate"),!0):!1},CLASS_NAME:"OpenLayers.Control"}),OpenLayers.Control.TYPE_BUTTON=1,OpenLayers.Control.TYPE_TOGGLE=2,OpenLayers.Control.TYPE_TOOL=3,OpenLayers.Control.Button=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){},CLASS_NAME:"OpenLayers.Control.Button"}),OpenLayers.Control.ZoomBox=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,out:!1,keyMask:null,alwaysZoom:!1,draw:function(){this.handler=new OpenLayers.Handler.Box(this,{done:this.zoomBox},{keyMask:this.keyMask})},zoomBox:function(e){if(e instanceof OpenLayers.Bounds){var t;if(this.out){var i=Math.abs(e.right-e.left),n=Math.abs(e.top-e.bottom),s=Math.min(this.map.size.h/n,this.map.size.w/i),a=this.map.getExtent(),r=this.map.getLonLatFromPixel(e.getCenterPixel()),o=r.lon-a.getWidth()/2*s,l=r.lon+a.getWidth()/2*s,u=r.lat-a.getHeight()/2*s,c=r.lat+a.getHeight()/2*s;t=new OpenLayers.Bounds(o,u,l,c)}else{var h=this.map.getLonLatFromPixel({x:e.left,y:e.bottom}),d=this.map.getLonLatFromPixel({x:e.right,y:e.top});t=new OpenLayers.Bounds(h.lon,h.lat,d.lon,d.lat)}var p=this.map.getZoom();this.map.zoomToExtent(t),p==this.map.getZoom()&&1==this.alwaysZoom&&this.map.zoomTo(p+(this.out?-1:1))}else this.out?this.map.setCenter(this.map.getLonLatFromPixel(e),this.map.getZoom()-1):this.map.setCenter(this.map.getLonLatFromPixel(e),this.map.getZoom()+1)},CLASS_NAME:"OpenLayers.Control.ZoomBox"}),OpenLayers.Control.DragPan=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,panned:!1,interval:1,documentDrag:!1,kinetic:null,enableKinetic:!1,kineticInterval:10,draw:function(){if(this.enableKinetic){var e={interval:this.kineticInterval};"object"==typeof this.enableKinetic&&(e=OpenLayers.Util.extend(e,this.enableKinetic)),this.kinetic=new OpenLayers.Kinetic(e)}this.handler=new OpenLayers.Handler.Drag(this,{move:this.panMap,done:this.panMapDone,down:this.panMapStart},{interval:this.interval,documentDrag:this.documentDrag})},panMapStart:function(){this.kinetic&&this.kinetic.begin()},panMap:function(e){this.kinetic&&this.kinetic.update(e),this.panned=!0,this.map.pan(this.handler.last.x-e.x,this.handler.last.y-e.y,{dragging:!0,animate:!1})},panMapDone:function(e){if(this.panned){var t=null;if(this.kinetic&&(t=this.kinetic.end(e)),this.map.pan(this.handler.last.x-e.x,this.handler.last.y-e.y,{dragging:!!t,animate:!1}),t){var i=this;this.kinetic.move(t,function(e,t,n){i.map.pan(e,t,{dragging:!n,animate:!1})})}this.panned=!1}},CLASS_NAME:"OpenLayers.Control.DragPan"}),OpenLayers.Control.PinchZoom=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,containerCenter:null,pinchOrigin:null,currentCenter:null,autoActivate:!0,initialize:function(){OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Pinch(this,{start:this.pinchStart,move:this.pinchMove,done:this.pinchDone},this.handlerOptions)},activate:function(){var e=OpenLayers.Control.prototype.activate.apply(this,arguments);return e&&(this.map.events.on({moveend:this.updateContainerCenter,scope:this}),this.updateContainerCenter()),e},deactivate:function(){var e=OpenLayers.Control.prototype.deactivate.apply(this,arguments);return this.map&&this.map.events&&this.map.events.un({moveend:this.updateContainerCenter,scope:this}),e},updateContainerCenter:function(){var e=this.map.layerContainerDiv;this.containerCenter={x:parseInt(e.style.left,10)+50,y:parseInt(e.style.top,10)+50}},pinchStart:function(e){this.pinchOrigin=e.xy,this.currentCenter=e.xy},pinchMove:function(e,t){var i=t.scale,n=this.containerCenter,s=this.pinchOrigin,a=e.xy,r=Math.round(a.x-s.x+(i-1)*(n.x-s.x)),o=Math.round(a.y-s.y+(i-1)*(n.y-s.y));this.applyTransform("translate("+r+"px, "+o+"px) scale("+i+")"),this.currentCenter=a},applyTransform:function(e){var t=this.map.layerContainerDiv.style;t["-webkit-transform"]=e,t["-moz-transform"]=e},pinchDone:function(e,t,i){this.applyTransform("");var n=this.map.getZoomForResolution(this.map.getResolution()/i.scale,!0);if(n!==this.map.getZoom()||!this.currentCenter.equals(this.pinchOrigin)){var s=this.map.getResolutionForZoom(n),a=this.map.getLonLatFromPixel(this.pinchOrigin),r=this.currentCenter,o=this.map.getSize();a.lon+=s*(o.w/2-r.x),a.lat-=s*(o.h/2-r.y),this.map.div.clientWidth=this.map.div.clientWidth,this.map.setCenter(a,n)}},CLASS_NAME:"OpenLayers.Control.PinchZoom"}),OpenLayers.Control.OverviewMap=OpenLayers.Class(OpenLayers.Control,{element:null,ovmap:null,size:{w:180,h:90},layers:null,minRectSize:15,minRectDisplayClass:"RectReplacement",minRatio:8,maxRatio:32,mapOptions:null,autoPan:!1,handlers:null,resolutionFactor:1,maximized:!1,initialize:function(e){this.layers=[],this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,[e])},destroy:function(){this.mapDiv&&(this.handlers.click&&this.handlers.click.destroy(),this.handlers.drag&&this.handlers.drag.destroy(),this.ovmap&&this.ovmap.viewPortDiv.removeChild(this.extentRectangle),this.extentRectangle=null,this.rectEvents&&(this.rectEvents.destroy(),this.rectEvents=null),this.ovmap&&(this.ovmap.destroy(),this.ovmap=null),this.element.removeChild(this.mapDiv),this.mapDiv=null,this.div.removeChild(this.element),this.element=null,this.maximizeDiv&&(this.div.removeChild(this.maximizeDiv),this.maximizeDiv=null),this.minimizeDiv&&(this.div.removeChild(this.minimizeDiv),this.minimizeDiv=null),this.map.events.un({buttonclick:this.onButtonClick,moveend:this.update,changebaselayer:this.baseLayerDraw,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments))},draw:function(){if(OpenLayers.Control.prototype.draw.apply(this,arguments),0===this.layers.length){if(!this.map.baseLayer)return this.map.events.register("changebaselayer",this,this.baseLayerDraw),this.div;var e=this.map.baseLayer.clone();this.layers=[e]}if(this.element=document.createElement("div"),this.element.className=this.displayClass+"Element",this.element.style.display="none",this.mapDiv=document.createElement("div"),this.mapDiv.style.width=this.size.w+"px",this.mapDiv.style.height=this.size.h+"px",this.mapDiv.style.position="relative",this.mapDiv.style.overflow="hidden",this.mapDiv.id=OpenLayers.Util.createUniqueID("overviewMap"),this.extentRectangle=document.createElement("div"),this.extentRectangle.style.position="absolute",this.extentRectangle.style.zIndex=1e3,this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.element.appendChild(this.mapDiv),this.div.appendChild(this.element),this.outsideViewport)this.element.style.display="";else{this.div.className+=" "+this.displayClass+"Container";var t=OpenLayers.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv(this.displayClass+"MaximizeButton",null,null,t,"absolute"),this.maximizeDiv.style.display="none",this.maximizeDiv.className=this.displayClass+"MaximizeButton olButton",this.div.appendChild(this.maximizeDiv);var t=OpenLayers.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_minimizeDiv",null,null,t,"absolute"),this.minimizeDiv.style.display="none",this.minimizeDiv.className=this.displayClass+"MinimizeButton olButton",this.div.appendChild(this.minimizeDiv),this.minimizeControl()}return this.map.getExtent()&&this.update(),this.map.events.on({buttonclick:this.onButtonClick,moveend:this.update,scope:this}),this.maximized&&this.maximizeControl(),this.div},baseLayerDraw:function(){this.draw(),this.map.events.unregister("changebaselayer",this,this.baseLayerDraw)},rectDrag:function(e){var t=this.handlers.drag.last.x-e.x,i=this.handlers.drag.last.y-e.y;if(0!=t||0!=i){var n=this.rectPxBounds.top,s=this.rectPxBounds.left,a=Math.abs(this.rectPxBounds.getHeight()),r=this.rectPxBounds.getWidth(),o=Math.max(0,n-i);o=Math.min(o,this.ovmap.size.h-this.hComp-a);var l=Math.max(0,s-t);l=Math.min(l,this.ovmap.size.w-this.wComp-r),this.setRectPxBounds(new OpenLayers.Bounds(l,o+a,l+r,o))}},mapDivClick:function(e){var t=this.rectPxBounds.getCenterPixel(),i=e.xy.x-t.x,n=e.xy.y-t.y,s=this.rectPxBounds.top,a=this.rectPxBounds.left,r=Math.abs(this.rectPxBounds.getHeight()),o=this.rectPxBounds.getWidth(),l=Math.max(0,s+n);l=Math.min(l,this.ovmap.size.h-r);var u=Math.max(0,a+i);u=Math.min(u,this.ovmap.size.w-o),this.setRectPxBounds(new OpenLayers.Bounds(u,l+r,u+o,l)),this.updateMapToRect()},onButtonClick:function(e){e.buttonElement===this.minimizeDiv?this.minimizeControl():e.buttonElement===this.maximizeDiv&&this.maximizeControl()},maximizeControl:function(e){this.element.style.display="",this.showToggle(!1),null!=e&&OpenLayers.Event.stop(e)},minimizeControl:function(e){this.element.style.display="none",this.showToggle(!0),null!=e&&OpenLayers.Event.stop(e)},showToggle:function(e){this.maximizeDiv.style.display=e?"":"none",this.minimizeDiv.style.display=e?"none":""},update:function(){null==this.ovmap&&this.createMap(),(this.autoPan||!this.isSuitableOverview())&&this.updateOverview(),this.updateRectToMap()},isSuitableOverview:function(){var e=this.map.getExtent(),t=this.map.maxExtent,i=new OpenLayers.Bounds(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom),Math.min(e.right,t.right),Math.min(e.top,t.top));this.ovmap.getProjection()!=this.map.getProjection()&&(i=i.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()));var n=this.ovmap.getResolution()/this.map.getResolution();return n>this.minRatio&&n<=this.maxRatio&&this.ovmap.getExtent().containsBounds(i)},updateOverview:function(){var e=this.map.getResolution(),t=this.ovmap.getResolution(),i=t/e;i>this.maxRatio?t=this.minRatio*e:i<=this.minRatio&&(t=this.maxRatio*e);var n;this.ovmap.getProjection()!=this.map.getProjection()?(n=this.map.center.clone(),n.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject())):n=this.map.center,this.ovmap.setCenter(n,this.ovmap.getZoomForResolution(t*this.resolutionFactor)),this.updateRectToMap()},createMap:function(){var e=OpenLayers.Util.extend({controls:[],maxResolution:"auto",fallThrough:!1},this.mapOptions);if(this.ovmap=new OpenLayers.Map(this.mapDiv,e),this.ovmap.viewPortDiv.appendChild(this.extentRectangle),OpenLayers.Event.stopObserving(window,"unload",this.ovmap.unloadDestroy),this.ovmap.addLayers(this.layers),this.ovmap.zoomToMaxExtent(),this.wComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-left-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-right-width")),this.wComp=this.wComp?this.wComp:2,this.hComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-top-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-bottom-width")),this.hComp=this.hComp?this.hComp:2,this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.rectDrag,done:this.updateMapToRect},{map:this.ovmap}),this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.mapDivClick},{single:!0,"double":!1,stopSingle:!0,stopDouble:!0,pixelTolerance:1,map:this.ovmap}),this.handlers.click.activate(),this.rectEvents=new OpenLayers.Events(this,this.extentRectangle,null,!0),this.rectEvents.register("mouseover",this,function(){this.handlers.drag.active||this.map.dragging||this.handlers.drag.activate()}),this.rectEvents.register("mouseout",this,function(){this.handlers.drag.dragging||this.handlers.drag.deactivate()}),this.ovmap.getProjection()!=this.map.getProjection()){var t=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,i=this.ovmap.getProjectionObject().getUnits()||this.ovmap.units||this.ovmap.baseLayer.units;this.resolutionFactor=t&&i?OpenLayers.INCHES_PER_UNIT[t]/OpenLayers.INCHES_PER_UNIT[i]:1}},updateRectToMap:function(){var e;e=this.ovmap.getProjection()!=this.map.getProjection()?this.map.getExtent().transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):this.map.getExtent();var t=this.getRectBoundsFromMapBounds(e);t&&this.setRectPxBounds(t)},updateMapToRect:function(){var e=this.getMapBoundsFromRectBounds(this.rectPxBounds);this.ovmap.getProjection()!=this.map.getProjection()&&(e=e.transform(this.ovmap.getProjectionObject(),this.map.getProjectionObject())),this.map.panTo(e.getCenterLonLat())},setRectPxBounds:function(e){var t=Math.max(e.top,0),i=Math.max(e.left,0),n=Math.min(e.top+Math.abs(e.getHeight()),this.ovmap.size.h-this.hComp),s=Math.min(e.left+e.getWidth(),this.ovmap.size.w-this.wComp),a=Math.max(s-i,0),r=Math.max(n-t,0);if(a<this.minRectSize||r<this.minRectSize){this.extentRectangle.className=this.displayClass+this.minRectDisplayClass;var o=i+a/2-this.minRectSize/2,l=t+r/2-this.minRectSize/2;this.extentRectangle.style.top=Math.round(l)+"px",this.extentRectangle.style.left=Math.round(o)+"px",this.extentRectangle.style.height=this.minRectSize+"px",this.extentRectangle.style.width=this.minRectSize+"px"}else this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.extentRectangle.style.top=Math.round(t)+"px",this.extentRectangle.style.left=Math.round(i)+"px",this.extentRectangle.style.height=Math.round(r)+"px",this.extentRectangle.style.width=Math.round(a)+"px";this.rectPxBounds=new OpenLayers.Bounds(Math.round(i),Math.round(n),Math.round(s),Math.round(t))},getRectBoundsFromMapBounds:function(e){var t=this.getOverviewPxFromLonLat({lon:e.left,lat:e.bottom}),i=this.getOverviewPxFromLonLat({lon:e.right,lat:e.top}),n=null;return t&&i&&(n=new OpenLayers.Bounds(t.x,t.y,i.x,i.y)),n},getMapBoundsFromRectBounds:function(e){var t=this.getLonLatFromOverviewPx({x:e.left,y:e.bottom}),i=this.getLonLatFromOverviewPx({x:e.right,y:e.top});return new OpenLayers.Bounds(t.lon,t.lat,i.lon,i.lat)},getLonLatFromOverviewPx:function(e){var t=this.ovmap.size,i=this.ovmap.getResolution(),n=this.ovmap.getExtent().getCenterLonLat(),s=e.x-t.w/2,a=e.y-t.h/2;return{lon:n.lon+s*i,lat:n.lat-a*i}},getOverviewPxFromLonLat:function(e){var t=this.ovmap.getResolution(),i=this.ovmap.getExtent();return i?{x:Math.round(1/t*(e.lon-i.left)),y:Math.round(1/t*(i.top-e.lat))}:void 0},CLASS_NAME:"OpenLayers.Control.OverviewMap"}),OpenLayers.Control.DrawFeature=OpenLayers.Class(OpenLayers.Control,{layer:null,callbacks:null,multi:!1,featureAdded:function(){},handlerOptions:null,initialize:function(e,t,i){OpenLayers.Control.prototype.initialize.apply(this,[i]),this.callbacks=OpenLayers.Util.extend({done:this.drawFeature,modify:function(e,t){this.layer.events.triggerEvent("sketchmodified",{vertex:e,feature:t})},create:function(e,t){this.layer.events.triggerEvent("sketchstarted",{vertex:e,feature:t})}},this.callbacks),this.layer=e,this.handlerOptions=this.handlerOptions||{},this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{renderers:e.renderers,rendererOptions:e.rendererOptions}),"multi"in this.handlerOptions||(this.handlerOptions.multi=this.multi);var n=this.layer.styleMap&&this.layer.styleMap.styles.temporary;n&&(this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({"default":n})})),this.handler=new t(this,this.callbacks,this.handlerOptions)},drawFeature:function(e){var t=new OpenLayers.Feature.Vector(e),i=this.layer.events.triggerEvent("sketchcomplete",{feature:t});i!==!1&&(t.state=OpenLayers.State.INSERT,this.layer.addFeatures([t]),this.featureAdded(t),this.events.triggerEvent("featureadded",{feature:t}))},insertXY:function(e,t){this.handler&&this.handler.line&&this.handler.insertXY(e,t)},insertDeltaXY:function(e,t){this.handler&&this.handler.line&&this.handler.insertDeltaXY(e,t)},insertDirectionLength:function(e,t){this.handler&&this.handler.line&&this.handler.insertDirectionLength(e,t)},insertDeflectionLength:function(e,t){this.handler&&this.handler.line&&this.handler.insertDeflectionLength(e,t)},undo:function(){return this.handler.undo&&this.handler.undo()},redo:function(){return this.handler.redo&&this.handler.redo()},finishSketch:function(){this.handler.finishGeometry()},cancel:function(){this.handler.cancel()},CLASS_NAME:"OpenLayers.Control.DrawFeature"}),OpenLayers.Control.DragFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,onStart:function(){},onDrag:function(){},onComplete:function(){},onEnter:function(){},onLeave:function(){},documentDrag:!1,layer:null,feature:null,dragCallbacks:{},featureCallbacks:{},lastPixel:null,initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]),this.layer=e,this.handlers={drag:new OpenLayers.Handler.Drag(this,OpenLayers.Util.extend({down:this.downFeature,move:this.moveFeature,up:this.upFeature,out:this.cancel,done:this.doneDragging},this.dragCallbacks),{documentDrag:this.documentDrag}),feature:new OpenLayers.Handler.Feature(this,this.layer,OpenLayers.Util.extend({click:this.clickFeature,clickout:this.clickoutFeature,over:this.overFeature,out:this.outFeature},this.featureCallbacks),{geometryTypes:this.geometryTypes})}},clickFeature:function(e){this.handlers.feature.touch&&!this.over&&this.overFeature(e)&&(this.handlers.drag.dragstart(this.handlers.feature.evt),this.handlers.drag.stopDown=!1)},clickoutFeature:function(e){this.handlers.feature.touch&&this.over&&(this.outFeature(e),this.handlers.drag.stopDown=!0)},destroy:function(){this.layer=null,OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return this.handlers.feature.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.handlers.drag.deactivate(),this.handlers.feature.deactivate(),this.feature=null,this.dragging=!1,this.lastPixel=null,OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over"),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},overFeature:function(e){var t=!1;return this.handlers.drag.dragging?this.over=this.feature.id==e.id?!0:!1:(this.feature=e,this.handlers.drag.activate(),t=!0,this.over=!0,OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass+"Over"),this.onEnter(e)),t},downFeature:function(e){this.lastPixel=e,this.onStart(this.feature,e)},moveFeature:function(e){var t=this.map.getResolution();this.feature.geometry.move(t*(e.x-this.lastPixel.x),t*(this.lastPixel.y-e.y)),this.layer.drawFeature(this.feature),this.lastPixel=e,this.onDrag(this.feature,e)},upFeature:function(){this.over||this.handlers.drag.deactivate()},doneDragging:function(e){this.onComplete(this.feature,e)},outFeature:function(e){this.handlers.drag.dragging?this.feature.id==e.id&&(this.over=!1):(this.over=!1,this.handlers.drag.deactivate(),OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over"),this.onLeave(e),this.feature=null)},cancel:function(){this.handlers.drag.deactivate(),this.over=!1},setMap:function(e){this.handlers.drag.setMap(e),this.handlers.feature.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.DragFeature"}),OpenLayers.Control.ModifyFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,clickout:!0,toggle:!0,standalone:!1,layer:null,feature:null,vertices:null,virtualVertices:null,selectControl:null,dragControl:null,handlers:null,deleteCodes:null,virtualStyle:null,vertexRenderIntent:null,mode:null,createVertices:!0,modified:!1,radiusHandle:null,dragHandle:null,onModificationStart:function(){},onModification:function(){},onModificationEnd:function(){},initialize:function(e,t){t=t||{},this.layer=e,this.vertices=[],this.virtualVertices=[],this.virtualStyle=OpenLayers.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer(null,t.vertexRenderIntent)),this.virtualStyle.fillOpacity=.3,this.virtualStyle.strokeOpacity=.3,this.deleteCodes=[46,68],this.mode=OpenLayers.Control.ModifyFeature.RESHAPE,OpenLayers.Control.prototype.initialize.apply(this,[t]),OpenLayers.Util.isArray(this.deleteCodes)||(this.deleteCodes=[this.deleteCodes]);var i=this,n={geometryTypes:this.geometryTypes,clickout:this.clickout,toggle:this.toggle,onBeforeSelect:this.beforeSelectFeature,onSelect:this.selectFeature,onUnselect:this.unselectFeature,scope:this};this.standalone===!1&&(this.selectControl=new OpenLayers.Control.SelectFeature(e,n));var s={geometryTypes:["OpenLayers.Geometry.Point"],onStart:function(e,t){i.dragStart.apply(i,[e,t])},onDrag:function(e,t){i.dragVertex.apply(i,[e,t])},onComplete:function(e){i.dragComplete.apply(i,[e])},featureCallbacks:{over:function(e){(i.standalone!==!0||e._sketch||i.feature===e)&&i.dragControl.overFeature.apply(i.dragControl,[e])}}};this.dragControl=new OpenLayers.Control.DragFeature(e,s);var a={keydown:this.handleKeypress};this.handlers={keyboard:new OpenLayers.Handler.Keyboard(this,a)}},destroy:function(){this.layer=null,this.standalone||this.selectControl.destroy(),this.dragControl.destroy(),OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return(this.standalone||this.selectControl.activate())&&this.handlers.keyboard.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){var e=!1;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){this.layer.removeFeatures(this.vertices,{silent:!0}),this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.vertices=[],this.dragControl.deactivate();var t=this.feature,i=t&&t.geometry&&t.layer;this.standalone===!1?(i&&this.selectControl.unselect.apply(this.selectControl,[t]),this.selectControl.deactivate()):i&&this.unselectFeature(t),this.handlers.keyboard.deactivate(),e=!0}return e},beforeSelectFeature:function(e){return this.layer.events.triggerEvent("beforefeaturemodified",{feature:e})},selectFeature:function(e){this.standalone&&this.beforeSelectFeature(e)===!1||(this.feature=e,this.modified=!1,this.resetVertices(),this.dragControl.activate(),this.onModificationStart(this.feature));var t=e.modified;!e.geometry||t&&t.geometry||(this._originalGeometry=e.geometry.clone())},unselectFeature:function(e){this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[],this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),delete this.dragHandle),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),delete this.radiusHandle),this.feature=null,this.dragControl.deactivate(),this.onModificationEnd(e),this.layer.events.triggerEvent("afterfeaturemodified",{feature:e,modified:this.modified}),this.modified=!1},dragStart:function(e,t){e==this.feature||e.geometry.parent||e==this.dragHandle||e==this.radiusHandle||(this.standalone===!1&&this.feature&&this.selectControl.clickFeature.apply(this.selectControl,[this.feature]),(null==this.geometryTypes||-1!=OpenLayers.Util.indexOf(this.geometryTypes,e.geometry.CLASS_NAME))&&(this.standalone||this.selectControl.clickFeature.apply(this.selectControl,[e]),this.dragControl.overFeature.apply(this.dragControl,[e]),this.dragControl.lastPixel=t,this.dragControl.handlers.drag.started=!0,this.dragControl.handlers.drag.start=t,this.dragControl.handlers.drag.last=t))},dragVertex:function(e,t){this.modified=!0,"OpenLayers.Geometry.Point"==this.feature.geometry.CLASS_NAME?(this.feature!=e&&(this.feature=e),this.layer.events.triggerEvent("vertexmodified",{vertex:e.geometry,feature:this.feature,pixel:t})):(e._index?(e.geometry.parent.addComponent(e.geometry,e._index),delete e._index,OpenLayers.Util.removeItem(this.virtualVertices,e),this.vertices.push(e)):e==this.dragHandle?(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null)):e!==this.radiusHandle&&this.layer.events.triggerEvent("vertexmodified",{vertex:e.geometry,feature:this.feature,pixel:t}),this.virtualVertices.length>0&&(this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.layer.drawFeature(this.feature,this.standalone?void 0:this.selectControl.renderIntent)),this.layer.drawFeature(e)
},dragComplete:function(){this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature})},setFeatureState:function(){if(this.feature.state!=OpenLayers.State.INSERT&&this.feature.state!=OpenLayers.State.DELETE&&(this.feature.state=OpenLayers.State.UPDATE,this.modified&&this._originalGeometry)){var e=this.feature;e.modified=OpenLayers.Util.extend(e.modified,{geometry:this._originalGeometry}),delete this._originalGeometry}},resetVertices:function(){this.dragControl.feature&&this.dragControl.outFeature(this.dragControl.feature),this.vertices.length>0&&(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[]),this.virtualVertices.length>0&&(this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),this.dragHandle=null),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null),this.feature&&"OpenLayers.Geometry.Point"!=this.feature.geometry.CLASS_NAME&&(this.mode&OpenLayers.Control.ModifyFeature.DRAG&&this.collectDragHandle(),this.mode&(OpenLayers.Control.ModifyFeature.ROTATE|OpenLayers.Control.ModifyFeature.RESIZE)&&this.collectRadiusHandle(),this.mode&OpenLayers.Control.ModifyFeature.RESHAPE&&(this.mode&OpenLayers.Control.ModifyFeature.RESIZE||this.collectVertices()))},handleKeypress:function(e){var t=e.keyCode;if(this.feature&&-1!=OpenLayers.Util.indexOf(this.deleteCodes,t)){var i=this.dragControl.feature;i&&-1!=OpenLayers.Util.indexOf(this.vertices,i)&&!this.dragControl.handlers.drag.dragging&&i.geometry.parent&&(i.geometry.parent.removeComponent(i.geometry),this.layer.events.triggerEvent("vertexremoved",{vertex:i.geometry,feature:this.feature,pixel:e.xy}),this.layer.drawFeature(this.feature,this.standalone?void 0:this.selectControl.renderIntent),this.modified=!0,this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature}))}},collectVertices:function(){function e(i){var n,s,a,r;if("OpenLayers.Geometry.Point"==i.CLASS_NAME)s=new OpenLayers.Feature.Vector(i),s._sketch=!0,s.renderIntent=t.vertexRenderIntent,t.vertices.push(s);else{var o=i.components.length;for("OpenLayers.Geometry.LinearRing"==i.CLASS_NAME&&(o-=1),n=0;o>n;++n)a=i.components[n],"OpenLayers.Geometry.Point"==a.CLASS_NAME?(s=new OpenLayers.Feature.Vector(a),s._sketch=!0,s.renderIntent=t.vertexRenderIntent,t.vertices.push(s)):e(a);if(t.createVertices&&"OpenLayers.Geometry.MultiPoint"!=i.CLASS_NAME)for(n=0,r=i.components.length;r-1>n;++n){var l=i.components[n],u=i.components[n+1];if("OpenLayers.Geometry.Point"==l.CLASS_NAME&&"OpenLayers.Geometry.Point"==u.CLASS_NAME){var c=(l.x+u.x)/2,h=(l.y+u.y)/2,d=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(c,h),null,t.virtualStyle);d.geometry.parent=i,d._index=n+1,d._sketch=!0,t.virtualVertices.push(d)}}}}this.vertices=[],this.virtualVertices=[];var t=this;e.call(this,this.feature.geometry),this.layer.addFeatures(this.virtualVertices,{silent:!0}),this.layer.addFeatures(this.vertices,{silent:!0})},collectDragHandle:function(){var e=this.feature.geometry,t=e.getBounds().getCenterLonLat(),i=new OpenLayers.Geometry.Point(t.lon,t.lat),n=new OpenLayers.Feature.Vector(i);i.move=function(t,i){OpenLayers.Geometry.Point.prototype.move.call(this,t,i),e.move(t,i)},n._sketch=!0,this.dragHandle=n,this.dragHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.dragHandle],{silent:!0})},collectRadiusHandle:function(){var e=this.feature.geometry,t=e.getBounds(),i=t.getCenterLonLat(),n=new OpenLayers.Geometry.Point(i.lon,i.lat),s=new OpenLayers.Geometry.Point(t.right,t.bottom),a=new OpenLayers.Feature.Vector(s),r=this.mode&OpenLayers.Control.ModifyFeature.RESIZE,o=this.mode&OpenLayers.Control.ModifyFeature.RESHAPE,l=this.mode&OpenLayers.Control.ModifyFeature.ROTATE;s.move=function(t,i){OpenLayers.Geometry.Point.prototype.move.call(this,t,i);var s=this.x-n.x,a=this.y-n.y,u=s-t,c=a-i;if(l){var h=Math.atan2(c,u),d=Math.atan2(a,s),p=d-h;p*=180/Math.PI,e.rotate(p,n)}if(r){var f,m;if(o)f=a/c,m=s/u/f;else{var g=Math.sqrt(u*u+c*c),y=Math.sqrt(s*s+a*a);f=y/g}e.resize(f,n,m)}},a._sketch=!0,this.radiusHandle=a,this.radiusHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.radiusHandle],{silent:!0})},setMap:function(e){this.standalone||this.selectControl.setMap(e),this.dragControl.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.ModifyFeature"}),OpenLayers.Control.ModifyFeature.RESHAPE=1,OpenLayers.Control.ModifyFeature.RESIZE=2,OpenLayers.Control.ModifyFeature.ROTATE=4,OpenLayers.Control.ModifyFeature.DRAG=8,OpenLayers.Control.SelectFeature=OpenLayers.Class(OpenLayers.Control,{multipleKey:null,toggleKey:null,multiple:!1,clickout:!0,toggle:!1,hover:!1,highlightOnly:!1,box:!1,onBeforeSelect:function(){},onSelect:function(){},onUnselect:function(){},scope:null,geometryTypes:null,layer:null,layers:null,callbacks:null,selectStyle:null,renderIntent:"select",handlers:null,initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]),null===this.scope&&(this.scope=this),this.initLayer(e);var i={click:this.clickFeature,clickout:this.clickoutFeature};this.hover&&(i.over=this.overFeature,i.out=this.outFeature),this.callbacks=OpenLayers.Util.extend(i,this.callbacks),this.handlers={feature:new OpenLayers.Handler.Feature(this,this.layer,this.callbacks,{geometryTypes:this.geometryTypes})},this.box&&(this.handlers.box=new OpenLayers.Handler.Box(this,{done:this.selectBox},{boxDivClassName:"olHandlerBoxSelectFeature"}))},initLayer:function(e){OpenLayers.Util.isArray(e)?(this.layers=e,this.layer=new OpenLayers.Layer.Vector.RootContainer(this.id+"_container",{layers:e})):this.layer=e},destroy:function(){this.active&&this.layers&&this.map.removeLayer(this.layer),OpenLayers.Control.prototype.destroy.apply(this,arguments),this.layers&&this.layer.destroy()},activate:function(){return this.active||(this.layers&&this.map.addLayer(this.layer),this.handlers.feature.activate(),this.box&&this.handlers.box&&this.handlers.box.activate()),OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.active&&(this.handlers.feature.deactivate(),this.handlers.box&&this.handlers.box.deactivate(),this.layers&&this.map.removeLayer(this.layer)),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},unselectAll:function(e){for(var t,i,n=this.layers||[this.layer],s=0;s<n.length;++s){t=n[s];for(var a=t.selectedFeatures.length-1;a>=0;--a)i=t.selectedFeatures[a],e&&e.except==i||this.unselect(i)}},clickFeature:function(e){if(!this.hover){var t=OpenLayers.Util.indexOf(e.layer.selectedFeatures,e)>-1;t?this.toggleSelect()?this.unselect(e):this.multipleSelect()||this.unselectAll({except:e}):(this.multipleSelect()||this.unselectAll({except:e}),this.select(e))}},multipleSelect:function(){return this.multiple||this.handlers.feature.evt&&this.handlers.feature.evt[this.multipleKey]},toggleSelect:function(){return this.toggle||this.handlers.feature.evt&&this.handlers.feature.evt[this.toggleKey]},clickoutFeature:function(){!this.hover&&this.clickout&&this.unselectAll()},overFeature:function(e){var t=e.layer;this.hover&&(this.highlightOnly?this.highlight(e):-1==OpenLayers.Util.indexOf(t.selectedFeatures,e)&&this.select(e))},outFeature:function(e){if(this.hover)if(this.highlightOnly){if(e._lastHighlighter==this.id)if(e._prevHighlighter&&e._prevHighlighter!=this.id){delete e._lastHighlighter;var t=this.map.getControl(e._prevHighlighter);t&&t.highlight(e)}else this.unhighlight(e)}else this.unselect(e)},highlight:function(e){var t=e.layer,i=this.events.triggerEvent("beforefeaturehighlighted",{feature:e});if(i!==!1){e._prevHighlighter=e._lastHighlighter,e._lastHighlighter=this.id;var n=this.selectStyle||this.renderIntent;t.drawFeature(e,n),this.events.triggerEvent("featurehighlighted",{feature:e})}},unhighlight:function(e){var t=e.layer;void 0==e._prevHighlighter?delete e._lastHighlighter:e._prevHighlighter==this.id?delete e._prevHighlighter:(e._lastHighlighter=e._prevHighlighter,delete e._prevHighlighter),t.drawFeature(e,e.style||e.layer.style||"default"),this.events.triggerEvent("featureunhighlighted",{feature:e})},select:function(e){var t=this.onBeforeSelect.call(this.scope,e),i=e.layer;t!==!1&&(t=i.events.triggerEvent("beforefeatureselected",{feature:e}),t!==!1&&(i.selectedFeatures.push(e),this.highlight(e),this.handlers.feature.lastFeature||(this.handlers.feature.lastFeature=i.selectedFeatures[0]),i.events.triggerEvent("featureselected",{feature:e}),this.onSelect.call(this.scope,e)))},unselect:function(e){var t=e.layer;this.unhighlight(e),OpenLayers.Util.removeItem(t.selectedFeatures,e),t.events.triggerEvent("featureunselected",{feature:e}),this.onUnselect.call(this.scope,e)},selectBox:function(e){if(e instanceof OpenLayers.Bounds){var t=this.map.getLonLatFromPixel({x:e.left,y:e.bottom}),i=this.map.getLonLatFromPixel({x:e.right,y:e.top}),n=new OpenLayers.Bounds(t.lon,t.lat,i.lon,i.lat);this.multipleSelect()||this.unselectAll();var s=this.multiple;this.multiple=!0;var a=this.layers||[this.layer];this.events.triggerEvent("boxselectionstart",{layers:a});for(var r,o=0;o<a.length;++o){r=a[o];for(var l=0,u=r.features.length;u>l;++l){var c=r.features[l];c.getVisibility()&&(null==this.geometryTypes||OpenLayers.Util.indexOf(this.geometryTypes,c.geometry.CLASS_NAME)>-1)&&n.toGeometry().intersects(c.geometry)&&-1==OpenLayers.Util.indexOf(r.selectedFeatures,c)&&this.select(c)}}this.multiple=s,this.events.triggerEvent("boxselectionend",{layers:a})}},setMap:function(e){this.handlers.feature.setMap(e),this.box&&this.handlers.box.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},setLayer:function(e){var t=this.active;this.unselectAll(),this.deactivate(),this.layers&&(this.layer.destroy(),this.layers=null),this.initLayer(e),this.handlers.feature.layer=this.layer,t&&this.activate()},CLASS_NAME:"OpenLayers.Control.SelectFeature"}),OpenLayers.Control.ScaleLine=OpenLayers.Class(OpenLayers.Control,{maxWidth:100,topOutUnits:"km",topInUnits:"m",bottomOutUnits:"mi",bottomInUnits:"ft",eTop:null,eBottom:null,geodesic:!1,draw:function(){return OpenLayers.Control.prototype.draw.apply(this,arguments),this.eTop||(this.eTop=document.createElement("div"),this.eTop.className=this.displayClass+"Top",this.topInUnits.length,this.div.appendChild(this.eTop),this.eTop.style.visibility=""==this.topOutUnits||""==this.topInUnits?"hidden":"visible",this.eBottom=document.createElement("div"),this.eBottom.className=this.displayClass+"Bottom",this.div.appendChild(this.eBottom),this.eBottom.style.visibility=""==this.bottomOutUnits||""==this.bottomInUnits?"hidden":"visible"),this.map.events.register("moveend",this,this.update),this.update(),this.div},getBarLen:function(e){var t,i=parseInt(Math.log(e)/Math.log(10)),n=Math.pow(10,i),s=parseInt(e/n);return t=s>5?5:s>2?2:1,t*n},update:function(){var e=this.map.getResolution();if(e){var t=this.map.getUnits(),i=OpenLayers.INCHES_PER_UNIT,n=this.maxWidth*e*i[t],s=1;if(this.geodesic===!0){var a=(this.map.getGeodesicPixelSize().w||1e-6)*this.maxWidth,r=n/i.km;s=a/r,n*=s}var o,l;n>1e5?(o=this.topOutUnits,l=this.bottomOutUnits):(o=this.topInUnits,l=this.bottomInUnits);var u=n/i[o],c=n/i[l],h=this.getBarLen(u),d=this.getBarLen(c);u=h/i[t]*i[o],c=d/i[t]*i[l];var p=u/e/s,f=c/e/s;"visible"==this.eBottom.style.visibility&&(this.eBottom.style.width=Math.round(f)+"px",this.eBottom.innerHTML=d+" "+l),"visible"==this.eTop.style.visibility&&(this.eTop.style.width=Math.round(p)+"px",this.eTop.innerHTML=h+" "+o)}},CLASS_NAME:"OpenLayers.Control.ScaleLine"}),OpenLayers.Control.Navigation=OpenLayers.Class(OpenLayers.Control,{dragPan:null,dragPanOptions:null,pinchZoom:null,pinchZoomOptions:null,documentDrag:!1,zoomBox:null,zoomBoxEnabled:!0,zoomWheelEnabled:!0,mouseWheelOptions:null,handleRightClicks:!1,zoomBoxKeyMask:OpenLayers.Handler.MOD_SHIFT,autoActivate:!0,initialize:function(){this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate(),this.dragPan&&this.dragPan.destroy(),this.dragPan=null,this.zoomBox&&this.zoomBox.destroy(),this.zoomBox=null,this.pinchZoom&&this.pinchZoom.destroy(),this.pinchZoom=null,OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){return this.dragPan.activate(),this.zoomWheelEnabled&&this.handlers.wheel.activate(),this.handlers.click.activate(),this.zoomBoxEnabled&&this.zoomBox.activate(),this.pinchZoom&&this.pinchZoom.activate(),OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.pinchZoom&&this.pinchZoom.deactivate(),this.zoomBox.deactivate(),this.dragPan.deactivate(),this.handlers.click.deactivate(),this.handlers.wheel.deactivate(),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},draw:function(){this.handleRightClicks&&(this.map.viewPortDiv.oncontextmenu=OpenLayers.Function.False);var e={click:this.defaultClick,dblclick:this.defaultDblClick,dblrightclick:this.defaultDblRightClick},t={"double":!0,stopDouble:!0};this.handlers.click=new OpenLayers.Handler.Click(this,e,t),this.dragPan=new OpenLayers.Control.DragPan(OpenLayers.Util.extend({map:this.map,documentDrag:this.documentDrag},this.dragPanOptions)),this.zoomBox=new OpenLayers.Control.ZoomBox({map:this.map,keyMask:this.zoomBoxKeyMask}),this.dragPan.draw(),this.zoomBox.draw(),this.handlers.wheel=new OpenLayers.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown},this.mouseWheelOptions),OpenLayers.Control.PinchZoom&&(this.pinchZoom=new OpenLayers.Control.PinchZoom(OpenLayers.Util.extend({map:this.map},this.pinchZoomOptions)))},defaultClick:function(e){e.lastTouches&&2==e.lastTouches.length&&this.map.zoomOut()},defaultDblClick:function(e){var t=this.map.getLonLatFromViewPortPx(e.xy);this.map.setCenter(t,this.map.zoom+1)},defaultDblRightClick:function(e){var t=this.map.getLonLatFromViewPortPx(e.xy);this.map.setCenter(t,this.map.zoom-1)},wheelChange:function(e,t){var i=this.map.getZoom(),n=this.map.getZoom()+Math.round(t);if(n=Math.max(n,0),n=Math.min(n,this.map.getNumZoomLevels()),n!==i){var s=this.map.getSize(),a=s.w/2-e.xy.x,r=e.xy.y-s.h/2,o=this.map.baseLayer.getResolutionForZoom(n),l=this.map.getLonLatFromPixel(e.xy),u=new OpenLayers.LonLat(l.lon+a*o,l.lat+r*o);this.map.setCenter(u,n)}},wheelUp:function(e,t){this.wheelChange(e,t||1)},wheelDown:function(e,t){this.wheelChange(e,t||-1)},disableZoomBox:function(){this.zoomBoxEnabled=!1,this.zoomBox.deactivate()},enableZoomBox:function(){this.zoomBoxEnabled=!0,this.active&&this.zoomBox.activate()},disableZoomWheel:function(){this.zoomWheelEnabled=!1,this.handlers.wheel.deactivate()},enableZoomWheel:function(){this.zoomWheelEnabled=!0,this.active&&this.handlers.wheel.activate()},CLASS_NAME:"OpenLayers.Control.Navigation"}),OpenLayers.Control.NavigationHistory=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOGGLE,previous:null,previousOptions:null,next:null,nextOptions:null,limit:50,autoActivate:!0,clearOnDeactivate:!1,registry:null,nextStack:null,previousStack:null,listeners:null,restoring:!1,initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,[e]),this.registry=OpenLayers.Util.extend({moveend:this.getState},this.registry);var t={trigger:OpenLayers.Function.bind(this.previousTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Previous"};OpenLayers.Util.extend(t,this.previousOptions),this.previous=new OpenLayers.Control.Button(t);var i={trigger:OpenLayers.Function.bind(this.nextTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Next"};OpenLayers.Util.extend(i,this.nextOptions),this.next=new OpenLayers.Control.Button(i),this.clear()},onPreviousChange:function(e){e&&!this.previous.active?this.previous.activate():!e&&this.previous.active&&this.previous.deactivate()},onNextChange:function(e){e&&!this.next.active?this.next.activate():!e&&this.next.active&&this.next.deactivate()},destroy:function(){OpenLayers.Control.prototype.destroy.apply(this),this.previous.destroy(),this.next.destroy(),this.deactivate();for(var e in this)this[e]=null},setMap:function(e){this.map=e,this.next.setMap(e),this.previous.setMap(e)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments),this.next.draw(),this.previous.draw()},previousTrigger:function(){var e=this.previousStack.shift(),t=this.previousStack.shift();return void 0!=t?(this.nextStack.unshift(e),this.previousStack.unshift(t),this.restoring=!0,this.restore(t),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)):this.previousStack.unshift(e),t},nextTrigger:function(){var e=this.nextStack.shift();return void 0!=e&&(this.previousStack.unshift(e),this.restoring=!0,this.restore(e),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)),e},clear:function(){this.previousStack=[],this.previous.deactivate(),this.nextStack=[],this.next.deactivate()},getState:function(){return{center:this.map.getCenter(),resolution:this.map.getResolution(),projection:this.map.getProjectionObject(),units:this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units}},restore:function(e){var t,i;if(this.map.getProjectionObject()==e.projection)i=this.map.getZoomForResolution(e.resolution),t=e.center;else{t=e.center.clone(),t.transform(e.projection,this.map.getProjectionObject());var n=e.units,s=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,a=n&&s?OpenLayers.INCHES_PER_UNIT[n]/OpenLayers.INCHES_PER_UNIT[s]:1;i=this.map.getZoomForResolution(a*e.resolution)}this.map.setCenter(t,i)},setListeners:function(){this.listeners={};for(var e in this.registry)this.listeners[e]=OpenLayers.Function.bind(function(){if(!this.restoring){var t=this.registry[e].apply(this,arguments);this.previousStack.unshift(t),this.previousStack.length>1&&this.onPreviousChange(this.previousStack[1],this.previousStack.length-1),this.previousStack.length>this.limit+1&&this.previousStack.pop(),this.nextStack.length>0&&(this.nextStack=[],this.onNextChange(null,0))}return!0},this)},activate:function(){var e=!1;if(this.map&&OpenLayers.Control.prototype.activate.apply(this)){null==this.listeners&&this.setListeners();for(var t in this.listeners)this.map.events.register(t,this,this.listeners[t]);e=!0,0==this.previousStack.length&&this.initStack()}return e},initStack:function(){this.map.getCenter()&&this.listeners.moveend()},deactivate:function(){var e=!1;if(this.map&&OpenLayers.Control.prototype.deactivate.apply(this)){for(var t in this.listeners)this.map.events.unregister(t,this,this.listeners[t]);this.clearOnDeactivate&&this.clear(),e=!0}return e},CLASS_NAME:"OpenLayers.Control.NavigationHistory"}),OpenLayers.Control.Measure=OpenLayers.Class(OpenLayers.Control,{handlerOptions:null,callbacks:null,displaySystem:"metric",geodesic:!1,displaySystemUnits:{geographic:["dd"],english:["mi","ft","in"],metric:["km","m"]},partialDelay:300,delayedTrigger:null,persist:!1,immediate:!1,initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]);var i={done:this.measureComplete,point:this.measurePartial};this.immediate&&(i.modify=this.measureImmediate),this.callbacks=OpenLayers.Util.extend(i,this.callbacks),this.handlerOptions=OpenLayers.Util.extend({persist:this.persist},this.handlerOptions),this.handler=new e(this,this.callbacks,this.handlerOptions)},deactivate:function(){return this.cancelDelay(),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},cancel:function(){this.cancelDelay(),this.handler.cancel()},setImmediate:function(e){this.immediate=e,this.immediate?this.callbacks.modify=this.measureImmediate:delete this.callbacks.modify},updateHandler:function(e,t){var i=this.active;i&&this.deactivate(),this.handler=new e(this,this.callbacks,t),i&&this.activate()},measureComplete:function(e){this.cancelDelay(),this.measure(e,"measure")},measurePartial:function(e,t){this.cancelDelay(),t=t.clone(),this.handler.freehandMode(this.handler.evt)?this.measure(t,"measurepartial"):this.delayedTrigger=window.setTimeout(OpenLayers.Function.bind(function(){this.delayedTrigger=null,this.measure(t,"measurepartial")},this),this.partialDelay)},measureImmediate:function(e,t,i){i&&!this.handler.freehandMode(this.handler.evt)&&(this.cancelDelay(),this.measure(t.geometry,"measurepartial"))},cancelDelay:function(){null!==this.delayedTrigger&&(window.clearTimeout(this.delayedTrigger),this.delayedTrigger=null)},measure:function(e,t){var i,n;e.CLASS_NAME.indexOf("LineString")>-1?(i=this.getBestLength(e),n=1):(i=this.getBestArea(e),n=2),this.events.triggerEvent(t,{measure:i[0],units:i[1],order:n,geometry:e})},getBestArea:function(e){for(var t,i,n=this.displaySystemUnits[this.displaySystem],s=0,a=n.length;a>s&&(t=n[s],i=this.getArea(e,t),!(i>1));++s);return[i,t]},getArea:function(e,t){var i,n;this.geodesic?(i=e.getGeodesicArea(this.map.getProjectionObject()),n="m"):(i=e.getArea(),n=this.map.getUnits());var s=OpenLayers.INCHES_PER_UNIT[t];if(s){var a=OpenLayers.INCHES_PER_UNIT[n];i*=Math.pow(a/s,2)}return i},getBestLength:function(e){for(var t,i,n=this.displaySystemUnits[this.displaySystem],s=0,a=n.length;a>s&&(t=n[s],i=this.getLength(e,t),!(i>1));++s);return[i,t]},getLength:function(e,t){var i,n;this.geodesic?(i=e.getGeodesicLength(this.map.getProjectionObject()),n="m"):(i=e.getLength(),n=this.map.getUnits());var s=OpenLayers.INCHES_PER_UNIT[t];if(s){var a=OpenLayers.INCHES_PER_UNIT[n];i*=a/s}return i},CLASS_NAME:"OpenLayers.Control.Measure"}),OpenLayers.Control.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,drillDown:!1,maxFeatures:10,clickCallback:"click",output:"features",layers:null,queryVisible:!1,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handlerOptions:null,handler:null,hoverRequest:null,initialize:function(e){if(e=e||{},e.handlerOptions=e.handlerOptions||{},OpenLayers.Control.prototype.initialize.apply(this,[e]),this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(e.formatOptions)),this.drillDown===!0&&(this.hover=!1),this.hover)this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var t={};t[this.clickCallback]=this.getInfoForClick,this.handler=new OpenLayers.Handler.Click(this,t,this.handlerOptions.click||{})}},getInfoForClick:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy}),OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait"),this.request(e.xy,{})},getInfoForHover:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy}),this.request(e.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&&(this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var e,t,i=this.layers||this.map.layers,n=[],s=i.length-1;s>=0;--s)e=i[s],e instanceof OpenLayers.Layer.WMS&&(!this.queryVisible||e.getVisibility())&&(t=OpenLayers.Util.isArray(e.url)?e.url[0]:e.url,this.drillDown!==!1||this.url||(this.url=t),(this.drillDown===!0||this.urlMatches(t))&&n.push(e));return n},urlMatches:function(e){var t=OpenLayers.Util.isEquivalentUrl(this.url,e);if(!t&&this.layerUrls)for(var i=0,n=this.layerUrls.length;n>i;++i)if(OpenLayers.Util.isEquivalentUrl(this.layerUrls[i],e)){t=!0;break}return t},buildWMSOptions:function(e,t,i,n){for(var s=[],a=[],r=0,o=t.length;o>r;r++)null!=t[r].params.LAYERS&&(s=s.concat(t[r].params.LAYERS),a=a.concat(this.getStyleNames(t[r])));var l=t[0],u=this.map.getProjection(),c=l.projection;c&&c.equals(this.map.getProjectionObject())&&(u=c.getCode());var h=OpenLayers.Util.extend({service:"WMS",version:l.params.VERSION,request:"GetFeatureInfo",exceptions:l.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,l.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:n,info_format:l.params.INFO_FORMAT||this.infoFormat},parseFloat(l.params.VERSION)>=1.3?{crs:u,i:parseInt(i.x),j:parseInt(i.y)}:{srs:u,x:parseInt(i.x),y:parseInt(i.y)});return 0!=s.length&&(h=OpenLayers.Util.extend({layers:s,query_layers:s,styles:a},h)),OpenLayers.Util.applyDefaults(h,this.vendorParams),{url:e,params:OpenLayers.Util.upperCaseObject(h),callback:function(t){this.handleResponse(i,t,e)},scope:this}},getStyleNames:function(e){var t;return t=e.params.STYLES?e.params.STYLES:OpenLayers.Util.isArray(e.params.LAYERS)?new Array(e.params.LAYERS.length):e.params.LAYERS.replace(/[^,]/g,"")},request:function(e,t){var i=this.findLayers();if(0==i.length)return this.events.triggerEvent("nogetfeatureinfo"),OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),void 0;if(t=t||{},this.drillDown===!1){var n=this.buildWMSOptions(this.url,i,e,i[0].params.FORMAT),s=OpenLayers.Request.GET(n);t.hover===!0&&(this.hoverRequest=s)}else{this._requestCount=0,this._numRequests=0,this.features=[];for(var a,r={},o=0,l=i.length;l>o;o++){var u=i[o];a=OpenLayers.Util.isArray(u.url)?u.url[0]:u.url,a in r?r[a].push(u):(this._numRequests++,r[a]=[u])}var i;for(var a in r){i=r[a];var n=this.buildWMSOptions(a,i,e,i[0].params.FORMAT);OpenLayers.Request.GET(n)}}},triggerGetFeatureInfo:function(e,t,i){this.events.triggerEvent("getfeatureinfo",{text:e.responseText,features:i,request:e,xy:t}),OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},handleResponse:function(e,t,i){var n=t.responseXML;n&&n.documentElement||(n=t.responseText);var s=this.format.read(n);this.drillDown===!1?this.triggerGetFeatureInfo(t,e,s):(this._requestCount++,this._features="object"===this.output?(this._features||[]).concat({url:i,features:s}):(this._features||[]).concat(s),this._requestCount===this._numRequests&&(this.triggerGetFeatureInfo(t,e,this._features.concat()),delete this._features,delete this._requestCount,delete this._numRequests))},CLASS_NAME:"OpenLayers.Control.WMSGetFeatureInfo"}),OpenLayers.Geometry=OpenLayers.Class({id:null,parent:null,bounds:null,initialize:function(){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){this.id=null,this.bounds=null},clone:function(){return new OpenLayers.Geometry},setBounds:function(e){e&&(this.bounds=e.clone())},clearBounds:function(){this.bounds=null,this.parent&&this.parent.clearBounds()},extendBounds:function(e){var t=this.getBounds();t?this.bounds.extend(e):this.setBounds(e)},getBounds:function(){return null==this.bounds&&this.calculateBounds(),this.bounds},calculateBounds:function(){},distanceTo:function(){},getVertices:function(){},atPoint:function(e,t,i){var n=!1,s=this.getBounds();if(null!=s&&null!=e){var a=null!=t?t:0,r=null!=i?i:0,o=new OpenLayers.Bounds(this.bounds.left-a,this.bounds.bottom-r,this.bounds.right+a,this.bounds.top+r);n=o.containsLonLat(e)}return n},getLength:function(){return 0},getArea:function(){return 0},getCentroid:function(){return null},toString:function(){var e;return e=OpenLayers.Format&&OpenLayers.Format.WKT?OpenLayers.Format.WKT.prototype.write(new OpenLayers.Feature.Vector(this)):Object.prototype.toString.call(this)},CLASS_NAME:"OpenLayers.Geometry"}),OpenLayers.Geometry.fromWKT=function(e){var t;if(OpenLayers.Format&&OpenLayers.Format.WKT){var i=OpenLayers.Geometry.fromWKT.format;i||(i=new OpenLayers.Format.WKT,OpenLayers.Geometry.fromWKT.format=i);var n=i.read(e);if(n instanceof OpenLayers.Feature.Vector)t=n.geometry;else if(OpenLayers.Util.isArray(n)){for(var s=n.length,a=new Array(s),r=0;s>r;++r)a[r]=n[r].geometry;t=new OpenLayers.Geometry.Collection(a)}}return t},OpenLayers.Geometry.segmentsIntersect=function(e,t,i){var n=i&&i.point,s=i&&i.tolerance,a=!1,r=e.x1-t.x1,o=e.y1-t.y1,l=e.x2-e.x1,u=e.y2-e.y1,c=t.y2-t.y1,h=t.x2-t.x1,d=c*l-h*u,p=h*o-c*r,f=l*o-u*r;if(0==d)0==p&&0==f&&(a=!0);else{var m=p/d,g=f/d;if(m>=0&&1>=m&&g>=0&&1>=g)if(n){var y=e.x1+m*l,v=e.y1+m*u;a=new OpenLayers.Geometry.Point(y,v)}else a=!0}if(s){var b;if(a){if(n){var _,y,v,w=[e,t];e:for(var L=0;2>L;++L){_=w[L];for(var k=1;3>k;++k)if(y=_["x"+k],v=_["y"+k],b=Math.sqrt(Math.pow(y-a.x,2)+Math.pow(v-a.y,2)),s>b){a.x=y,a.y=v;break e}}}}else{var O,x,y,v,S,C,w=[e,t];e:for(var L=0;2>L;++L){O=w[L],x=w[(L+1)%2];for(var k=1;3>k;++k)if(S={x:O["x"+k],y:O["y"+k]},C=OpenLayers.Geometry.distanceToSegment(S,x),C.distance<s){a=n?new OpenLayers.Geometry.Point(S.x,S.y):!0;break e}}}}return a},OpenLayers.Geometry.distanceToSegment=function(e,t){var i,n,s=e.x,a=e.y,r=t.x1,o=t.y1,l=t.x2,u=t.y2,c=l-r,h=u-o,d=(c*(s-r)+h*(a-o))/(Math.pow(c,2)+Math.pow(h,2));return 0>=d?(i=r,n=o):d>=1?(i=l,n=u):(i=r+d*c,n=o+d*h),{distance:Math.sqrt(Math.pow(i-s,2)+Math.pow(n-a,2)),x:i,y:n}},OpenLayers.Geometry.Collection=OpenLayers.Class(OpenLayers.Geometry,{components:null,componentTypes:null,initialize:function(e){OpenLayers.Geometry.prototype.initialize.apply(this,arguments),this.components=[],null!=e&&this.addComponents(e)},destroy:function(){this.components.length=0,this.components=null,OpenLayers.Geometry.prototype.destroy.apply(this,arguments)},clone:function(){for(var geometry=eval("new "+this.CLASS_NAME+"()"),i=0,len=this.components.length;len>i;i++)geometry.addComponent(this.components[i].clone());return OpenLayers.Util.applyDefaults(geometry,this),geometry},getComponentsString:function(){for(var e=[],t=0,i=this.components.length;i>t;t++)e.push(this.components[t].toShortString());return e.join(",")},calculateBounds:function(){this.bounds=null;var e=new OpenLayers.Bounds,t=this.components;if(t)for(var i=0,n=t.length;n>i;i++)e.extend(t[i].getBounds());null!=e.left&&null!=e.bottom&&null!=e.right&&null!=e.top&&this.setBounds(e)},addComponents:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0,i=e.length;i>t;t++)this.addComponent(e[t])},addComponent:function(e,t){var i=!1;if(e&&(null==this.componentTypes||OpenLayers.Util.indexOf(this.componentTypes,e.CLASS_NAME)>-1)){if(null!=t&&t<this.components.length){var n=this.components.slice(0,t),s=this.components.slice(t,this.components.length);n.push(e),this.components=n.concat(s)}else this.components.push(e);e.parent=this,this.clearBounds(),i=!0}return i},removeComponents:function(e){var t=!1;OpenLayers.Util.isArray(e)||(e=[e]);for(var i=e.length-1;i>=0;--i)t=this.removeComponent(e[i])||t;return t},removeComponent:function(e){return OpenLayers.Util.removeItem(this.components,e),this.clearBounds(),!0},getLength:function(){for(var e=0,t=0,i=this.components.length;i>t;t++)e+=this.components[t].getLength();return e},getArea:function(){for(var e=0,t=0,i=this.components.length;i>t;t++)e+=this.components[t].getArea();return e},getGeodesicArea:function(e){for(var t=0,i=0,n=this.components.length;n>i;i++)t+=this.components[i].getGeodesicArea(e);return t},getCentroid:function(e){if(!e)return this.components.length&&this.components[0].getCentroid();var t=this.components.length;if(!t)return!1;for(var i,n=[],s=[],a=0,r=Number.MAX_VALUE,o=0;t>o;++o){i=this.components[o];var l=i.getArea(),u=i.getCentroid(!0);isNaN(l)||isNaN(u.x)||isNaN(u.y)||(n.push(l),a+=l,r=r>l&&l>0?l:r,s.push(u))}if(t=n.length,0===a){for(var o=0;t>o;++o)n[o]=1;a=n.length}else{for(var o=0;t>o;++o)n[o]/=r;a/=r}for(var u,l,c=0,h=0,o=0;t>o;++o)u=s[o],l=n[o],c+=u.x*l,h+=u.y*l;return new OpenLayers.Geometry.Point(c/a,h/a)},getGeodesicLength:function(e){for(var t=0,i=0,n=this.components.length;n>i;i++)t+=this.components[i].getGeodesicLength(e);return t},move:function(e,t){for(var i=0,n=this.components.length;n>i;i++)this.components[i].move(e,t)},rotate:function(e,t){for(var i=0,n=this.components.length;n>i;++i)this.components[i].rotate(e,t)},resize:function(e,t,i){for(var n=0;n<this.components.length;++n)this.components[n].resize(e,t,i);return this},distanceTo:function(e,t){for(var i,n,s,a=!(t&&t.edge===!1),r=a&&t&&t.details,o=Number.POSITIVE_INFINITY,l=0,u=this.components.length;u>l&&(i=this.components[l].distanceTo(e,t),s=r?i.distance:i,!(o>s&&(o=s,n=i,0==o)));++l);return n
},equals:function(e){var t=!0;if(e&&e.CLASS_NAME&&this.CLASS_NAME==e.CLASS_NAME)if(OpenLayers.Util.isArray(e.components)&&e.components.length==this.components.length){for(var i=0,n=this.components.length;n>i;++i)if(!this.components[i].equals(e.components[i])){t=!1;break}}else t=!1;else t=!1;return t},transform:function(e,t){if(e&&t){for(var i=0,n=this.components.length;n>i;i++){var s=this.components[i];s.transform(e,t)}this.bounds=null}return this},intersects:function(e){for(var t=!1,i=0,n=this.components.length;n>i&&!(t=e.intersects(this.components[i]));++i);return t},getVertices:function(e){for(var t=[],i=0,n=this.components.length;n>i;++i)Array.prototype.push.apply(t,this.components[i].getVertices(e));return t},CLASS_NAME:"OpenLayers.Geometry.Collection"}),OpenLayers.Geometry.Point=OpenLayers.Class(OpenLayers.Geometry,{x:null,y:null,initialize:function(e,t){OpenLayers.Geometry.prototype.initialize.apply(this,arguments),this.x=parseFloat(e),this.y=parseFloat(t)},clone:function(e){return null==e&&(e=new OpenLayers.Geometry.Point(this.x,this.y)),OpenLayers.Util.applyDefaults(e,this),e},calculateBounds:function(){this.bounds=new OpenLayers.Bounds(this.x,this.y,this.x,this.y)},distanceTo:function(e,t){var i,n,s,a,r,o,l=!(t&&t.edge===!1),u=l&&t&&t.details;return e instanceof OpenLayers.Geometry.Point?(n=this.x,s=this.y,a=e.x,r=e.y,i=Math.sqrt(Math.pow(n-a,2)+Math.pow(s-r,2)),o=u?{x0:n,y0:s,x1:a,y1:r,distance:i}:i):(o=e.distanceTo(this,t),u&&(o={x0:o.x1,y0:o.y1,x1:o.x0,y1:o.y0,distance:o.distance})),o},equals:function(e){var t=!1;return null!=e&&(t=this.x==e.x&&this.y==e.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(e.x)&&isNaN(e.y)),t},toShortString:function(){return this.x+", "+this.y},move:function(e,t){this.x=this.x+e,this.y=this.y+t,this.clearBounds()},rotate:function(e,t){e*=Math.PI/180;var i=this.distanceTo(t),n=e+Math.atan2(this.y-t.y,this.x-t.x);this.x=t.x+i*Math.cos(n),this.y=t.y+i*Math.sin(n),this.clearBounds()},getCentroid:function(){return new OpenLayers.Geometry.Point(this.x,this.y)},resize:function(e,t,i){return i=void 0==i?1:i,this.x=t.x+e*i*(this.x-t.x),this.y=t.y+e*(this.y-t.y),this.clearBounds(),this},intersects:function(e){var t=!1;return t="OpenLayers.Geometry.Point"==e.CLASS_NAME?this.equals(e):e.intersects(this)},transform:function(e,t){return e&&t&&(OpenLayers.Projection.transform(this,e,t),this.bounds=null),this},getVertices:function(){return[this]},CLASS_NAME:"OpenLayers.Geometry.Point"}),OpenLayers.Geometry.MultiPoint=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.Point"],addPoint:function(e,t){this.addComponent(e,t)},removePoint:function(e){this.removeComponent(e)},CLASS_NAME:"OpenLayers.Geometry.MultiPoint"}),OpenLayers.Geometry.Curve=OpenLayers.Class(OpenLayers.Geometry.MultiPoint,{componentTypes:["OpenLayers.Geometry.Point"],getLength:function(){var e=0;if(this.components&&this.components.length>1)for(var t=1,i=this.components.length;i>t;t++)e+=this.components[t-1].distanceTo(this.components[t]);return e},getGeodesicLength:function(e){var t=this;if(e){var i=new OpenLayers.Projection("EPSG:4326");i.equals(e)||(t=this.clone().transform(e,i))}var n=0;if(t.components&&t.components.length>1)for(var s,a,r=1,o=t.components.length;o>r;r++)s=t.components[r-1],a=t.components[r],n+=OpenLayers.Util.distVincenty({lon:s.x,lat:s.y},{lon:a.x,lat:a.y});return 1e3*n},CLASS_NAME:"OpenLayers.Geometry.Curve"}),OpenLayers.Geometry.LineString=OpenLayers.Class(OpenLayers.Geometry.Curve,{removeComponent:function(){var e=this.components&&this.components.length>2;return e&&OpenLayers.Geometry.Collection.prototype.removeComponent.apply(this,arguments),e},intersects:function(e){var t=!1,i=e.CLASS_NAME;if("OpenLayers.Geometry.LineString"==i||"OpenLayers.Geometry.LinearRing"==i||"OpenLayers.Geometry.Point"==i){var n,s=this.getSortedSegments();n="OpenLayers.Geometry.Point"==i?[{x1:e.x,y1:e.y,x2:e.x,y2:e.y}]:e.getSortedSegments();var a,r,o,l,u,c,h,d;e:for(var p=0,f=s.length;f>p;++p){a=s[p],r=a.x1,o=a.x2,l=a.y1,u=a.y2;for(var m=0,g=n.length;g>m&&(c=n[m],!(c.x1>o));++m)if(!(c.x2<r||(h=c.y1,d=c.y2,Math.min(h,d)>Math.max(l,u)||Math.max(h,d)<Math.min(l,u)||!OpenLayers.Geometry.segmentsIntersect(a,c)))){t=!0;break e}}}else t=e.intersects(this);return t},getSortedSegments:function(){function e(e,t){return e.x1-t.x1}for(var t,i,n=this.components.length-1,s=new Array(n),a=0;n>a;++a)t=this.components[a],i=this.components[a+1],s[a]=t.x<i.x?{x1:t.x,y1:t.y,x2:i.x,y2:i.y}:{x1:i.x,y1:i.y,x2:t.x,y2:t.y};return s.sort(e)},splitWithSegment:function(e,t){for(var i,n,s,a,r,o=!(t&&t.edge===!1),l=t&&t.tolerance,u=[],c=this.getVertices(),h=[],d=[],p=!1,f={point:!0,tolerance:l},m=null,g=0,y=c.length-2;y>=g;++g)if(i=c[g],h.push(i.clone()),n=c[g+1],r={x1:i.x,y1:i.y,x2:n.x,y2:n.y},s=OpenLayers.Geometry.segmentsIntersect(e,r,f),s instanceof OpenLayers.Geometry.Point&&(a=s.x===e.x1&&s.y===e.y1||s.x===e.x2&&s.y===e.y2||s.equals(i)||s.equals(n)?!0:!1,a||o)){if(s.equals(d[d.length-1])||d.push(s.clone()),0===g&&s.equals(i))continue;if(s.equals(n))continue;p=!0,s.equals(i)||h.push(s),u.push(new OpenLayers.Geometry.LineString(h)),h=[s.clone()]}if(p&&(h.push(n.clone()),u.push(new OpenLayers.Geometry.LineString(h))),d.length>0){var v=e.x1<e.x2?1:-1,b=e.y1<e.y2?1:-1;m={lines:u,points:d.sort(function(e,t){return v*e.x-v*t.x||b*e.y-b*t.y})}}return m},split:function(e,t){var i,n,s,a,r=null,o=t&&t.mutual;if(e instanceof OpenLayers.Geometry.LineString){var l,u,c,h,d,p,f=this.getVertices(),m=[];s=[];for(var g=0,y=f.length-2;y>=g;++g){l=f[g],u=f[g+1],c={x1:l.x,y1:l.y,x2:u.x,y2:u.y},a=a||[e],o&&m.push(l.clone());for(var v=0;v<a.length;++v)if(h=a[v].splitWithSegment(c,t),h&&(d=h.lines,d.length>0&&(d.unshift(v,1),Array.prototype.splice.apply(a,d),v+=d.length-2),o))for(var b=0,_=h.points.length;_>b;++b)p=h.points[b],p.equals(l)||(m.push(p),s.push(new OpenLayers.Geometry.LineString(m)),m=p.equals(u)?[]:[p.clone()])}o&&s.length>0&&m.length>0&&(m.push(u.clone()),s.push(new OpenLayers.Geometry.LineString(m)))}else r=e.splitWith(this,t);return a&&a.length>1?n=!0:a=[],s&&s.length>1?i=!0:s=[],(n||i)&&(r=o?[s,a]:a),r},splitWith:function(e,t){return e.split(this,t)},getVertices:function(e){var t;return t=e===!0?[this.components[0],this.components[this.components.length-1]]:e===!1?this.components.slice(1,this.components.length-1):this.components.slice()},distanceTo:function(e,t){var i,n=!(t&&t.edge===!1),s=n&&t&&t.details,a={},r=Number.POSITIVE_INFINITY;if(e instanceof OpenLayers.Geometry.Point){for(var o,l=this.getSortedSegments(),u=e.x,c=e.y,h=0,d=l.length;d>h;++h)if(o=l[h],i=OpenLayers.Geometry.distanceToSegment(e,o),i.distance<r){if(r=i.distance,a=i,0===r)break}else if(o.x2>u&&(c>o.y1&&c<o.y2||c<o.y1&&c>o.y2))break;a=s?{distance:a.distance,x0:a.x,y0:a.y,x1:u,y1:c}:a.distance}else if(e instanceof OpenLayers.Geometry.LineString){var p,f,m,g,y,v=this.getSortedSegments(),b=e.getSortedSegments(),_=b.length,w={point:!0};e:for(var h=0,d=v.length;d>h;++h){p=v[h],g=p.x1,y=p.y1;for(var L=0;_>L;++L){if(f=b[L],m=OpenLayers.Geometry.segmentsIntersect(p,f,w)){r=0,a={distance:0,x0:m.x,y0:m.y,x1:m.x,y1:m.y};break e}i=OpenLayers.Geometry.distanceToSegment({x:g,y:y},f),i.distance<r&&(r=i.distance,a={distance:r,x0:g,y0:y,x1:i.x,y1:i.y})}}if(s||(a=a.distance),0!==r&&p){i=e.distanceTo(new OpenLayers.Geometry.Point(p.x2,p.y2),t);var k=s?i.distance:i;r>k&&(a=s?{distance:r,x0:i.x1,y0:i.y1,x1:i.x0,y1:i.y0}:k)}}else a=e.distanceTo(this,t),s&&(a={distance:a.distance,x0:a.x1,y0:a.y1,x1:a.x0,y1:a.y0});return a},simplify:function(e){if(this&&null!==this){var t=this.getVertices();if(t.length<3)return this;var i=function(e,t){return e-t},n=function(e,t,i,a){for(var r,l=0,u=0,c=t;i>c;c++)r=s(e[t],e[i],e[c]),r>l&&(l=r,u=c);l>a&&u!=t&&(o.push(u),n(e,t,u,a),n(e,u,i,a))},s=function(e,t,i){var n=Math.abs(.5*(e.x*t.y+t.x*i.y+i.x*e.y-t.x*e.y-i.x*t.y-e.x*i.y)),s=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),a=2*(n/s);return a},a=0,r=t.length-1,o=[];for(o.push(a),o.push(r);t[a].equals(t[r]);)r--,o.push(r);n(t,a,r,e);var l=[];o.sort(i);for(var u=0;u<o.length;u++)l.push(t[o[u]]);return new OpenLayers.Geometry.LineString(l)}return this},CLASS_NAME:"OpenLayers.Geometry.LineString"}),OpenLayers.Geometry.LinearRing=OpenLayers.Class(OpenLayers.Geometry.LineString,{componentTypes:["OpenLayers.Geometry.Point"],addComponent:function(e,t){var i=!1,n=this.components.pop();null==t&&e.equals(n)||(i=OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,arguments));var s=this.components[0];return OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,[s]),i},removeComponent:function(){var e=this.components&&this.components.length>3;if(e){this.components.pop(),OpenLayers.Geometry.Collection.prototype.removeComponent.apply(this,arguments);var t=this.components[0];OpenLayers.Geometry.Collection.prototype.addComponent.apply(this,[t])}return e},move:function(e,t){for(var i=0,n=this.components.length;n-1>i;i++)this.components[i].move(e,t)},rotate:function(e,t){for(var i=0,n=this.components.length;n-1>i;++i)this.components[i].rotate(e,t)},resize:function(e,t,i){for(var n=0,s=this.components.length;s-1>n;++n)this.components[n].resize(e,t,i);return this},transform:function(e,t){if(e&&t){for(var i=0,n=this.components.length;n-1>i;i++){var s=this.components[i];s.transform(e,t)}this.bounds=null}return this},getCentroid:function(){if(this.components&&this.components.length>2){for(var e=0,t=0,i=0;i<this.components.length-1;i++){var n=this.components[i],s=this.components[i+1];e+=(n.x+s.x)*(n.x*s.y-s.x*n.y),t+=(n.y+s.y)*(n.x*s.y-s.x*n.y)}var a=-1*this.getArea(),r=e/(6*a),o=t/(6*a);return new OpenLayers.Geometry.Point(r,o)}return null},getArea:function(){var e=0;if(this.components&&this.components.length>2){for(var t=0,i=0,n=this.components.length;n-1>i;i++){var s=this.components[i],a=this.components[i+1];t+=(s.x+a.x)*(a.y-s.y)}e=-t/2}return e},getGeodesicArea:function(e){var t=this;if(e){var i=new OpenLayers.Projection("EPSG:4326");i.equals(e)||(t=this.clone().transform(e,i))}var n=0,s=t.components&&t.components.length;if(s>2){for(var a,r,o=0;s-1>o;o++)a=t.components[o],r=t.components[o+1],n+=OpenLayers.Util.rad(r.x-a.x)*(2+Math.sin(OpenLayers.Util.rad(a.y))+Math.sin(OpenLayers.Util.rad(r.y)));n=6378137*6378137*n/2}return n},containsPoint:function(e){function t(e,t,i,n,s){return(e-s)*((n-t)/(s-i))+n}for(var i,n,s,a,r,o,l,u=OpenLayers.Number.limitSigDigs,c=14,h=u(e.x,c),d=u(e.y,c),p=this.components.length-1,f=0,m=0;p>m;++m)if(i=this.components[m],s=u(i.x,c),a=u(i.y,c),n=this.components[m+1],r=u(n.x,c),o=u(n.y,c),a!=o){if(l=u(t(d,s,a,r,o),c),l==h&&(o>a&&d>=a&&o>=d||a>o&&a>=d&&d>=o)){f=-1;break}h>=l||s!=r&&(l<Math.min(s,r)||l>Math.max(s,r))||(o>a&&d>=a&&o>d||a>o&&a>d&&d>=o)&&++f}else if(d==a&&(r>=s&&h>=s&&r>=h||s>=r&&s>=h&&h>=r)){f=-1;break}var g=-1==f?1:!!(1&f);return g},intersects:function(e){var t=!1;if("OpenLayers.Geometry.Point"==e.CLASS_NAME)t=this.containsPoint(e);else if("OpenLayers.Geometry.LineString"==e.CLASS_NAME)t=e.intersects(this);else if("OpenLayers.Geometry.LinearRing"==e.CLASS_NAME)t=OpenLayers.Geometry.LineString.prototype.intersects.apply(this,[e]);else for(var i=0,n=e.components.length;n>i&&!(t=e.components[i].intersects(this));++i);return t},getVertices:function(e){return e===!0?[]:this.components.slice(0,this.components.length-1)},CLASS_NAME:"OpenLayers.Geometry.LinearRing"}),OpenLayers.Geometry.Polygon=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.LinearRing"],getArea:function(){var e=0;if(this.components&&this.components.length>0){e+=Math.abs(this.components[0].getArea());for(var t=1,i=this.components.length;i>t;t++)e-=Math.abs(this.components[t].getArea())}return e},getGeodesicArea:function(e){var t=0;if(this.components&&this.components.length>0){t+=Math.abs(this.components[0].getGeodesicArea(e));for(var i=1,n=this.components.length;n>i;i++)t-=Math.abs(this.components[i].getGeodesicArea(e))}return t},containsPoint:function(e){var t=this.components.length,i=!1;if(t>0&&(i=this.components[0].containsPoint(e),1!==i&&i&&t>1))for(var n,s=1;t>s;++s)if(n=this.components[s].containsPoint(e)){i=1===n?1:!1;break}return i},intersects:function(e){var t,i,n=!1;if("OpenLayers.Geometry.Point"==e.CLASS_NAME)n=this.containsPoint(e);else if("OpenLayers.Geometry.LineString"==e.CLASS_NAME||"OpenLayers.Geometry.LinearRing"==e.CLASS_NAME){for(t=0,i=this.components.length;i>t&&!(n=e.intersects(this.components[t]));++t);if(!n)for(t=0,i=e.components.length;i>t&&!(n=this.containsPoint(e.components[t]));++t);}else for(t=0,i=e.components.length;i>t&&!(n=this.intersects(e.components[t]));++t);if(!n&&"OpenLayers.Geometry.Polygon"==e.CLASS_NAME){var s=this.components[0];for(t=0,i=s.components.length;i>t&&!(n=e.containsPoint(s.components[t]));++t);}return n},distanceTo:function(e,t){var i,n=!(t&&t.edge===!1);return i=!n&&this.intersects(e)?0:OpenLayers.Geometry.Collection.prototype.distanceTo.apply(this,[e,t])},CLASS_NAME:"OpenLayers.Geometry.Polygon"}),OpenLayers.Geometry.Polygon.createRegularPolygon=function(e,t,i,n){var s=Math.PI*(1/i-.5);n&&(s+=n/180*Math.PI);for(var a,r,o,l=[],u=0;i>u;++u)a=s+2*u*Math.PI/i,r=e.x+t*Math.cos(a),o=e.y+t*Math.sin(a),l.push(new OpenLayers.Geometry.Point(r,o));var c=new OpenLayers.Geometry.LinearRing(l);return new OpenLayers.Geometry.Polygon([c])},OpenLayers.Geometry.MultiLineString=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.LineString"],split:function(e,t){for(var i,n,s,a,r,o=null,l=t&&t.mutual,u=[],c=[e],h=0,d=this.components.length;d>h;++h){n=this.components[h],a=!1;for(var p=0;p<c.length;++p)if(i=n.split(c[p],t)){if(l){s=i[0];for(var f=0,m=s.length;m>f;++f)0===f&&u.length?u[u.length-1].addComponent(s[f]):u.push(new OpenLayers.Geometry.MultiLineString([s[f]]));a=!0,i=i[1]}if(i.length){i.unshift(p,1),Array.prototype.splice.apply(c,i);break}}a||(u.length?u[u.length-1].addComponent(n.clone()):u=[new OpenLayers.Geometry.MultiLineString(n.clone())])}return u&&u.length>1?a=!0:u=[],c&&c.length>1?r=!0:c=[],(a||r)&&(o=l?[u,c]:c),o},splitWith:function(e,t){var i,n,s,a,r,o,l,u=null,c=t&&t.mutual;if(e instanceof OpenLayers.Geometry.LineString){l=[],o=[e];for(var h=0,d=this.components.length;d>h;++h){r=!1,n=this.components[h];for(var p=0;p<o.length;++p)if(i=o[p].split(n,t)){c&&(s=i[0],s.length&&(s.unshift(p,1),Array.prototype.splice.apply(o,s),p+=s.length-2),i=i[1],0===i.length&&(i=[n.clone()]));for(var f=0,m=i.length;m>f;++f)0===f&&l.length?l[l.length-1].addComponent(i[f]):l.push(new OpenLayers.Geometry.MultiLineString([i[f]]));r=!0}r||(l.length?l[l.length-1].addComponent(n.clone()):l=[new OpenLayers.Geometry.MultiLineString([n.clone()])])}}else u=e.split(this);return o&&o.length>1?a=!0:o=[],l&&l.length>1?r=!0:l=[],(a||r)&&(u=c?[o,l]:l),u},CLASS_NAME:"OpenLayers.Geometry.MultiLineString"}),OpenLayers.Geometry.MultiPolygon=OpenLayers.Class(OpenLayers.Geometry.Collection,{componentTypes:["OpenLayers.Geometry.Polygon"],CLASS_NAME:"OpenLayers.Geometry.MultiPolygon"}),OpenLayers.Renderer=OpenLayers.Class({container:null,root:null,extent:null,locked:!1,size:null,resolution:null,map:null,featureDx:0,initialize:function(e,t){this.container=OpenLayers.Util.getElement(e),OpenLayers.Util.extend(this,t)},destroy:function(){this.container=null,this.extent=null,this.size=null,this.resolution=null,this.map=null},supported:function(){return!1},setExtent:function(e,t){if(this.extent=e.clone(),this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var i=e.getWidth()/this.map.getExtent().getWidth(),e=e.scale(1/i);this.extent=e.wrapDateLine(this.map.getMaxExtent()).scale(i)}return t&&(this.resolution=null),!0},setSize:function(e){this.size=e.clone(),this.resolution=null},getResolution:function(){return this.resolution=this.resolution||this.map.getResolution(),this.resolution},drawFeature:function(e,t){if(null==t&&(t=e.style),e.geometry){var i=e.geometry.getBounds();if(i){var n;this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(n=this.map.getMaxExtent()),i.intersectsBounds(this.extent,{worldBounds:n})?this.calculateFeatureDx(i,n):t={display:"none"};var s=this.drawGeometry(e.geometry,t,e.id);if("none"!=t.display&&t.label&&s!==!1){var a=e.geometry.getCentroid();if(t.labelXOffset||t.labelYOffset){var r=isNaN(t.labelXOffset)?0:t.labelXOffset,o=isNaN(t.labelYOffset)?0:t.labelYOffset,l=this.getResolution();a.move(r*l,o*l)}this.drawText(e.id,t,a)}else this.removeText(e.id);return s}}},calculateFeatureDx:function(e,t){if(this.featureDx=0,t){var i=t.getWidth(),n=(this.extent.left+this.extent.right)/2,s=(e.left+e.right)/2,a=Math.round((s-n)/i);this.featureDx=a*i}},drawGeometry:function(){},drawText:function(){},removeText:function(){},clear:function(){},getFeatureIdFromEvent:function(){},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0,i=e.length;i>t;++t){var n=e[t];this.eraseGeometry(n.geometry,n.id),this.removeText(n.id)}},eraseGeometry:function(){},moveRoot:function(){},getRenderLayerId:function(){return this.container.id},applyDefaultSymbolizer:function(e){var t=OpenLayers.Util.extend({},OpenLayers.Renderer.defaultSymbolizer);return e.stroke===!1&&(delete t.strokeWidth,delete t.strokeColor),e.fill===!1&&delete t.fillColor,OpenLayers.Util.extend(t,e),t},CLASS_NAME:"OpenLayers.Renderer"}),OpenLayers.Renderer.defaultSymbolizer={fillColor:"#000000",strokeColor:"#000000",strokeWidth:2,fillOpacity:1,strokeOpacity:1,pointRadius:0,labelAlign:"cm"},OpenLayers.Renderer.symbol={star:[350,75,379,161,469,161,397,215,423,301,350,250,277,301,303,215,231,161,321,161,350,75],cross:[4,0,6,0,6,4,10,4,10,6,6,6,6,10,4,10,4,6,0,6,0,4,4,4,4,0],x:[0,0,25,0,50,35,75,0,100,0,65,50,100,100,75,100,50,65,25,100,0,100,35,50,0,0],square:[0,0,0,1,1,1,1,0,0,0],triangle:[0,10,10,10,5,0,0,10]},OpenLayers.ElementsIndexer=OpenLayers.Class({maxZIndex:null,order:null,indices:null,compare:null,initialize:function(e){this.compare=e?OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER_Y_ORDER:OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER_DRAWING_ORDER,this.clear()},insert:function(e){this.exists(e)&&this.remove(e);var t=e.id;this.determineZIndex(e);for(var i,n=-1,s=this.order.length;s-n>1;){i=parseInt((n+s)/2);var a=this.compare(this,e,OpenLayers.Util.getElement(this.order[i]));a>0?n=i:s=i}return this.order.splice(s,0,t),this.indices[t]=this.getZIndex(e),this.getNextElement(s)},remove:function(e){var t=e.id,i=OpenLayers.Util.indexOf(this.order,t);if(i>=0)if(this.order.splice(i,1),delete this.indices[t],this.order.length>0){var n=this.order[this.order.length-1];this.maxZIndex=this.indices[n]}else this.maxZIndex=0},clear:function(){this.order=[],this.indices={},this.maxZIndex=0},exists:function(e){return null!=this.indices[e.id]},getZIndex:function(e){return e._style.graphicZIndex},determineZIndex:function(e){var t=e._style.graphicZIndex;null==t?(t=this.maxZIndex,e._style.graphicZIndex=t):t>this.maxZIndex&&(this.maxZIndex=t)},getNextElement:function(e){var t=e+1;if(t<this.order.length){var i=OpenLayers.Util.getElement(this.order[t]);return void 0==i&&(i=this.getNextElement(t)),i}return null},CLASS_NAME:"OpenLayers.ElementsIndexer"}),OpenLayers.ElementsIndexer.IndexingMethods={Z_ORDER:function(e,t,i){var n=e.getZIndex(t),s=0;if(i){var a=e.getZIndex(i);s=n-a}return s},Z_ORDER_DRAWING_ORDER:function(e,t,i){var n=OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER(e,t,i);return i&&0==n&&(n=1),n},Z_ORDER_Y_ORDER:function(e,t,i){var n=OpenLayers.ElementsIndexer.IndexingMethods.Z_ORDER(e,t,i);if(i&&0===n){var s=i._boundsBottom-t._boundsBottom;n=0===s?1:s}return n}},OpenLayers.Renderer.Elements=OpenLayers.Class(OpenLayers.Renderer,{rendererRoot:null,root:null,vectorRoot:null,textRoot:null,xmlns:null,xOffset:0,indexer:null,BACKGROUND_ID_SUFFIX:"_background",LABEL_ID_SUFFIX:"_label",LABEL_OUTLINE_SUFFIX:"_outline",initialize:function(e,t){OpenLayers.Renderer.prototype.initialize.apply(this,arguments),this.rendererRoot=this.createRenderRoot(),this.root=this.createRoot("_root"),this.vectorRoot=this.createRoot("_vroot"),this.textRoot=this.createRoot("_troot"),this.root.appendChild(this.vectorRoot),this.root.appendChild(this.textRoot),this.rendererRoot.appendChild(this.root),this.container.appendChild(this.rendererRoot),t&&(t.zIndexing||t.yOrdering)&&(this.indexer=new OpenLayers.ElementsIndexer(t.yOrdering))},destroy:function(){this.clear(),this.rendererRoot=null,this.root=null,this.xmlns=null,OpenLayers.Renderer.prototype.destroy.apply(this,arguments)},clear:function(){var e,t=this.vectorRoot;if(t)for(;e=t.firstChild;)t.removeChild(e);if(t=this.textRoot)for(;e=t.firstChild;)t.removeChild(e);this.indexer&&this.indexer.clear()},setExtent:function(e,t){var i=OpenLayers.Renderer.prototype.setExtent.apply(this,arguments),n=this.getResolution();if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var s,a=e.getWidth()/this.map.getExtent().getWidth(),e=e.scale(1/a),r=this.map.getMaxExtent();r.right>e.left&&r.right<e.right?s=!0:r.left>e.left&&r.left<e.right&&(s=!1),(s!==this.rightOfDateLine||t)&&(i=!1,this.xOffset=s===!0?r.getWidth()/n:0),this.rightOfDateLine=s}return i},getNodeType:function(){},drawGeometry:function(e,t,i){var n=e.CLASS_NAME,s=!0;if("OpenLayers.Geometry.Collection"==n||"OpenLayers.Geometry.MultiPoint"==n||"OpenLayers.Geometry.MultiLineString"==n||"OpenLayers.Geometry.MultiPolygon"==n){for(var a=0,r=e.components.length;r>a;a++)s=this.drawGeometry(e.components[a],t,i)&&s;return s}s=!1;var o=!1;if("none"!=t.display&&(t.backgroundGraphic?this.redrawBackgroundNode(e.id,e,t,i):o=!0,s=this.redrawNode(e.id,e,t,i)),0==s){var l=document.getElementById(e.id);l&&(l._style.backgroundGraphic&&(o=!0),l.parentNode.removeChild(l))}if(o){var l=document.getElementById(e.id+this.BACKGROUND_ID_SUFFIX);l&&l.parentNode.removeChild(l)}return s},redrawNode:function(e,t,i,n){i=this.applyDefaultSymbolizer(i);var s=this.nodeFactory(e,this.getNodeType(t,i));s._featureId=n,s._boundsBottom=t.getBounds().bottom,s._geometryClass=t.CLASS_NAME,s._style=i;var a=this.drawGeometryNode(s,t,i);if(a===!1)return!1;if(s=a.node,this.indexer){var r=this.indexer.insert(s);r?this.vectorRoot.insertBefore(s,r):this.vectorRoot.appendChild(s)}else s.parentNode!==this.vectorRoot&&this.vectorRoot.appendChild(s);return this.postDraw(s),a.complete},redrawBackgroundNode:function(e,t,i){var n=OpenLayers.Util.extend({},i);return n.externalGraphic=n.backgroundGraphic,n.graphicXOffset=n.backgroundXOffset,n.graphicYOffset=n.backgroundYOffset,n.graphicZIndex=n.backgroundGraphicZIndex,n.graphicWidth=n.backgroundWidth||n.graphicWidth,n.graphicHeight=n.backgroundHeight||n.graphicHeight,n.backgroundGraphic=null,n.backgroundXOffset=null,n.backgroundYOffset=null,n.backgroundGraphicZIndex=null,this.redrawNode(e+this.BACKGROUND_ID_SUFFIX,t,n,null)},drawGeometryNode:function(e,t,i){i=i||e._style;var n,s={isFilled:void 0===i.fill?!0:i.fill,isStroked:void 0===i.stroke?!!i.strokeWidth:i.stroke};switch(t.CLASS_NAME){case"OpenLayers.Geometry.Point":i.graphic===!1&&(s.isFilled=!1,s.isStroked=!1),n=this.drawPoint(e,t);break;case"OpenLayers.Geometry.LineString":s.isFilled=!1,n=this.drawLineString(e,t);break;case"OpenLayers.Geometry.LinearRing":n=this.drawLinearRing(e,t);break;case"OpenLayers.Geometry.Polygon":n=this.drawPolygon(e,t);break;case"OpenLayers.Geometry.Rectangle":n=this.drawRectangle(e,t)}return e._options=s,0!=n?{node:this.setStyle(e,i,s,t),complete:n}:!1},postDraw:function(){},drawPoint:function(){},drawLineString:function(){},drawLinearRing:function(){},drawPolygon:function(){},drawRectangle:function(){},drawCircle:function(){},removeText:function(e){var t=document.getElementById(e+this.LABEL_ID_SUFFIX);t&&this.textRoot.removeChild(t);var i=document.getElementById(e+this.LABEL_OUTLINE_SUFFIX);i&&this.textRoot.removeChild(i)},getFeatureIdFromEvent:function(e){var t=e.target,i=t&&t.correspondingUseElement,n=i?i:t||e.srcElement;return n._featureId},eraseGeometry:function(e,t){if("OpenLayers.Geometry.MultiPoint"==e.CLASS_NAME||"OpenLayers.Geometry.MultiLineString"==e.CLASS_NAME||"OpenLayers.Geometry.MultiPolygon"==e.CLASS_NAME||"OpenLayers.Geometry.Collection"==e.CLASS_NAME)for(var i=0,n=e.components.length;n>i;i++)this.eraseGeometry(e.components[i],t);else{var s=OpenLayers.Util.getElement(e.id);if(s&&s.parentNode&&(s.geometry&&(s.geometry.destroy(),s.geometry=null),s.parentNode.removeChild(s),this.indexer&&this.indexer.remove(s),s._style.backgroundGraphic)){var a=e.id+this.BACKGROUND_ID_SUFFIX,r=OpenLayers.Util.getElement(a);r&&r.parentNode&&r.parentNode.removeChild(r)}}},nodeFactory:function(e,t){var i=OpenLayers.Util.getElement(e);return i?this.nodeTypeCompare(i,t)||(i.parentNode.removeChild(i),i=this.nodeFactory(e,t)):i=this.createNode(t,e),i},nodeTypeCompare:function(){},createNode:function(){},moveRoot:function(e){var t=this.root;e.root.parentNode==this.rendererRoot&&(t=e.root),t.parentNode.removeChild(t),e.rendererRoot.appendChild(t)},getRenderLayerId:function(){return this.root.parentNode.parentNode.id},isComplexSymbol:function(e){return"circle"!=e&&!!e},CLASS_NAME:"OpenLayers.Renderer.Elements"}),OpenLayers.Renderer.SVG=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15e3,translationParameters:null,symbolMetrics:null,initialize:function(){this.supported()&&(OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments),this.translationParameters={x:0,y:0},this.symbolMetrics={})},supported:function(){var e="http://www.w3.org/TR/SVG11/feature#";return document.implementation&&(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature(e+"SVG","1.1")||document.implementation.hasFeature(e+"BasicStructure","1.1"))},inValidRange:function(e,t,i){var n=e+(i?0:this.translationParameters.x),s=t+(i?0:this.translationParameters.y);return n>=-this.MAX_PIXEL&&n<=this.MAX_PIXEL&&s>=-this.MAX_PIXEL&&s<=this.MAX_PIXEL},setExtent:function(e,t){var i=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),n=this.getResolution(),s=-e.left/n,a=e.top/n;if(t){this.left=s,this.top=a;var r="0 0 "+this.size.w+" "+this.size.h;return this.rendererRoot.setAttributeNS(null,"viewBox",r),this.translate(this.xOffset,0),!0}var o=this.translate(s-this.left+this.xOffset,a-this.top);return o||this.setExtent(e,!0),i&&o},translate:function(e,t){if(this.inValidRange(e,t,!0)){var i="";return(e||t)&&(i="translate("+e+","+t+")"),this.root.setAttributeNS(null,"transform",i),this.translationParameters={x:e,y:t},!0}return!1},setSize:function(){OpenLayers.Renderer.prototype.setSize.apply(this,arguments),this.rendererRoot.setAttributeNS(null,"width",this.size.w),this.rendererRoot.setAttributeNS(null,"height",this.size.h)},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"image":this.isComplexSymbol(t.graphicName)?"svg":"circle";break;case"OpenLayers.Geometry.Rectangle":i="rect";break;case"OpenLayers.Geometry.LineString":i="polyline";break;case"OpenLayers.Geometry.LinearRing":i="polygon";break;case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":i="path"}return i},setStyle:function(e,t,i){t=t||e._style,i=i||e._options;var n,s=parseFloat(e.getAttributeNS(null,"r")),a=1;if("OpenLayers.Geometry.Point"==e._geometryClass&&s){if(e.style.visibility="",t.graphic===!1)e.style.visibility="hidden";else if(t.externalGraphic){if(n=this.getPosition(e),t.graphicTitle){e.setAttributeNS(null,"title",t.graphicTitle);var r=e.getElementsByTagName("title");if(r.length>0)r[0].firstChild.textContent=t.graphicTitle;else{var o=this.nodeFactory(null,"title");o.textContent=t.graphicTitle,e.appendChild(o)}}t.graphicWidth&&t.graphicHeight&&e.setAttributeNS(null,"preserveAspectRatio","none");var l=t.graphicWidth||t.graphicHeight,u=t.graphicHeight||t.graphicWidth;l=l?l:2*t.pointRadius,u=u?u:2*t.pointRadius;var c=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*l),h=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*u),d=t.graphicOpacity||t.fillOpacity;e.setAttributeNS(null,"x",(n.x+c).toFixed()),e.setAttributeNS(null,"y",(n.y+h).toFixed()),e.setAttributeNS(null,"width",l),e.setAttributeNS(null,"height",u),e.setAttributeNS(this.xlinkns,"href",t.externalGraphic),e.setAttributeNS(null,"style","opacity: "+d),e.onclick=OpenLayers.Renderer.SVG.preventDefault}else if(this.isComplexSymbol(t.graphicName)){var p=3*t.pointRadius,f=2*p,m=this.importSymbol(t.graphicName);n=this.getPosition(e),a=3*this.symbolMetrics[m.id][0]/f;var g=e.parentNode,y=e.nextSibling;g&&g.removeChild(e),e.firstChild&&e.removeChild(e.firstChild),e.appendChild(m.firstChild.cloneNode(!0)),e.setAttributeNS(null,"viewBox",m.getAttributeNS(null,"viewBox")),e.setAttributeNS(null,"width",f),e.setAttributeNS(null,"height",f),e.setAttributeNS(null,"x",n.x-p),e.setAttributeNS(null,"y",n.y-p),y?g.insertBefore(e,y):g&&g.appendChild(e)}else e.setAttributeNS(null,"r",t.pointRadius);var v=t.rotation;if((void 0!==v||void 0!==e._rotation)&&n)if(e._rotation=v,v|=0,"svg"!==e.nodeName)e.setAttributeNS(null,"transform","rotate("+v+" "+n.x+" "+n.y+")");else{var b=this.symbolMetrics[m.id];e.firstChild.setAttributeNS(null,"transform","rotate("+v+" "+b[1]+" "+b[2]+")")}}return i.isFilled?(e.setAttributeNS(null,"fill",t.fillColor),e.setAttributeNS(null,"fill-opacity",t.fillOpacity)):e.setAttributeNS(null,"fill","none"),i.isStroked?(e.setAttributeNS(null,"stroke",t.strokeColor),e.setAttributeNS(null,"stroke-opacity",t.strokeOpacity),e.setAttributeNS(null,"stroke-width",t.strokeWidth*a),e.setAttributeNS(null,"stroke-linecap",t.strokeLinecap||"round"),e.setAttributeNS(null,"stroke-linejoin","round"),t.strokeDashstyle&&e.setAttributeNS(null,"stroke-dasharray",this.dashStyle(t,a))):e.setAttributeNS(null,"stroke","none"),t.pointerEvents&&e.setAttributeNS(null,"pointer-events",t.pointerEvents),null!=t.cursor&&e.setAttributeNS(null,"cursor",t.cursor),e},dashStyle:function(e,t){var i=e.strokeWidth*t,n=e.strokeDashstyle;switch(n){case"solid":return"none";case"dot":return[1,4*i].join();case"dash":return[4*i,4*i].join();case"dashdot":return[4*i,4*i,1,4*i].join();case"longdash":return[8*i,4*i].join();case"longdashdot":return[8*i,4*i,1,4*i].join();default:return OpenLayers.String.trim(n).replace(/\s+/g,",")}},createNode:function(e,t){var i=document.createElementNS(this.xmlns,e);return t&&i.setAttributeNS(null,"id",t),i},nodeTypeCompare:function(e,t){return t==e.nodeName},createRenderRoot:function(){var e=this.nodeFactory(this.container.id+"_svgRoot","svg");return e.style.display="block",e},createRoot:function(e){return this.nodeFactory(this.container.id+e,"g")},createDefs:function(){var e=this.nodeFactory(this.container.id+"_defs","defs");return this.rendererRoot.appendChild(e),e},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){var n=this.getResolution(),s=(t.x-this.featureDx)/n+this.left,a=this.top-t.y/n;return this.inValidRange(s,a)?(e.setAttributeNS(null,"cx",s),e.setAttributeNS(null,"cy",a),e.setAttributeNS(null,"r",i),e):!1},drawLineString:function(e,t){var i=this.getComponentsString(t.components);return i.path?(e.setAttributeNS(null,"points",i.path),i.complete?e:null):!1},drawLinearRing:function(e,t){var i=this.getComponentsString(t.components);return i.path?(e.setAttributeNS(null,"points",i.path),i.complete?e:null):!1},drawPolygon:function(e,t){for(var i,n,s="",a=!0,r=!0,o=0,l=t.components.length;l>o;o++)s+=" M",i=this.getComponentsString(t.components[o].components," "),n=i.path,n?(s+=" "+n,r=i.complete&&r):a=!1;return s+=" z",a?(e.setAttributeNS(null,"d",s),e.setAttributeNS(null,"fill-rule","evenodd"),r?e:null):!1},drawRectangle:function(e,t){var i=this.getResolution(),n=(t.x-this.featureDx)/i+this.left,s=this.top-t.y/i;return this.inValidRange(n,s)?(e.setAttributeNS(null,"x",n),e.setAttributeNS(null,"y",s),e.setAttributeNS(null,"width",t.width/i),e.setAttributeNS(null,"height",t.height/i),e):!1},drawText:function(e,t,i){var n=!!t.labelOutlineWidth;if(n){var s=OpenLayers.Util.extend({},t);s.fontColor=s.labelOutlineColor,s.fontStrokeColor=s.labelOutlineColor,s.fontStrokeWidth=t.labelOutlineWidth,delete s.labelOutlineWidth,this.drawText(e,s,i)
}var a=this.getResolution(),r=(i.x-this.featureDx)/a+this.left,o=i.y/a-this.top,l=n?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,u=this.nodeFactory(e+l,"text");u.setAttributeNS(null,"x",r),u.setAttributeNS(null,"y",-o),t.fontColor&&u.setAttributeNS(null,"fill",t.fontColor),t.fontStrokeColor&&u.setAttributeNS(null,"stroke",t.fontStrokeColor),t.fontStrokeWidth&&u.setAttributeNS(null,"stroke-width",t.fontStrokeWidth),t.fontOpacity&&u.setAttributeNS(null,"opacity",t.fontOpacity),t.fontFamily&&u.setAttributeNS(null,"font-family",t.fontFamily),t.fontSize&&u.setAttributeNS(null,"font-size",t.fontSize),t.fontWeight&&u.setAttributeNS(null,"font-weight",t.fontWeight),t.fontStyle&&u.setAttributeNS(null,"font-style",t.fontStyle),t.labelSelect===!0?(u.setAttributeNS(null,"pointer-events","visible"),u._featureId=e):u.setAttributeNS(null,"pointer-events","none");var c=t.labelAlign||OpenLayers.Renderer.defaultSymbolizer.labelAlign;u.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[c[0]]||"middle"),OpenLayers.IS_GECKO===!0&&u.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG.LABEL_ALIGN[c[1]]||"central");for(var h=t.label.split("\n"),d=h.length;u.childNodes.length>d;)u.removeChild(u.lastChild);for(var p=0;d>p;p++){var f=this.nodeFactory(e+l+"_tspan_"+p,"tspan");if(t.labelSelect===!0&&(f._featureId=e,f._geometry=i,f._geometryClass=i.CLASS_NAME),OpenLayers.IS_GECKO===!1&&f.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[c[1]]||"-35%"),f.setAttribute("x",r),0==p){var m=OpenLayers.Renderer.SVG.LABEL_VFACTOR[c[1]];null==m&&(m=-.5),f.setAttribute("dy",m*(d-1)+"em")}else f.setAttribute("dy","1em");f.textContent=""===h[p]?" ":h[p],f.parentNode||u.appendChild(f)}u.parentNode||this.textRoot.appendChild(u)},getComponentsString:function(e,t){for(var i,n,s=[],a=!0,r=e.length,o=[],l=0;r>l;l++)n=e[l],s.push(n),i=this.getShortString(n),i?o.push(i):(l>0&&this.getShortString(e[l-1])&&o.push(this.clipLine(e[l],e[l-1])),r-1>l&&this.getShortString(e[l+1])&&o.push(this.clipLine(e[l],e[l+1])),a=!1);return{path:o.join(t||","),complete:a}},clipLine:function(e,t){if(t.equals(e))return"";var i,n=this.getResolution(),s=this.MAX_PIXEL-this.translationParameters.x,a=this.MAX_PIXEL-this.translationParameters.y,r=(t.x-this.featureDx)/n+this.left,o=this.top-t.y/n,l=(e.x-this.featureDx)/n+this.left,u=this.top-e.y/n;return(-s>l||l>s)&&(i=(u-o)/(l-r),l=0>l?-s:s,u=o+(l-r)*i),(-a>u||u>a)&&(i=(l-r)/(u-o),u=0>u?-a:a,l=r+(u-o)*i),l+","+u},getShortString:function(e){var t=this.getResolution(),i=(e.x-this.featureDx)/t+this.left,n=this.top-e.y/t;return this.inValidRange(i,n)?i+","+n:!1},getPosition:function(e){return{x:parseFloat(e.getAttributeNS(null,"cx")),y:parseFloat(e.getAttributeNS(null,"cy"))}},importSymbol:function(e){this.defs||(this.defs=this.createDefs());var t=this.container.id+"-"+e,i=document.getElementById(t);if(null!=i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw new Error(e+" is not a valid symbol name");var s=this.nodeFactory(t,"symbol"),a=this.nodeFactory(null,"polygon");s.appendChild(a);for(var r,o,l=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),u=[],c=0;c<n.length;c+=2)r=n[c],o=n[c+1],l.left=Math.min(l.left,r),l.bottom=Math.min(l.bottom,o),l.right=Math.max(l.right,r),l.top=Math.max(l.top,o),u.push(r,",",o);a.setAttributeNS(null,"points",u.join(" "));var h=l.getWidth(),d=l.getHeight(),p=[l.left-h,l.bottom-d,3*h,3*d];return s.setAttributeNS(null,"viewBox",p.join(" ")),this.symbolMetrics[t]=[Math.max(h,d),l.getCenterLonLat().lon,l.getCenterLonLat().lat],this.defs.appendChild(s),s},getFeatureIdFromEvent:function(e){var t=OpenLayers.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this,arguments);if(!t){var i=e.target;t=i.parentNode&&i!=this.rendererRoot?i.parentNode._featureId:void 0}return t},CLASS_NAME:"OpenLayers.Renderer.SVG"}),OpenLayers.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"},OpenLayers.Renderer.SVG.LABEL_VSHIFT={t:"-70%",b:"0"},OpenLayers.Renderer.SVG.LABEL_VFACTOR={t:0,b:-1},OpenLayers.Renderer.SVG.preventDefault=function(e){e.preventDefault&&e.preventDefault()},OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,cachedSymbolBounds:{},initialize:function(){OpenLayers.Renderer.prototype.initialize.apply(this,arguments),this.root=document.createElement("canvas"),this.container.appendChild(this.root),this.canvas=this.root.getContext("2d"),this.features={},this.hitDetection&&(this.hitCanvas=document.createElement("canvas"),this.hitContext=this.hitCanvas.getContext("2d"))},setExtent:function(){return OpenLayers.Renderer.prototype.setExtent.apply(this,arguments),!1},eraseGeometry:function(e,t){this.eraseFeatures(this.features[t][0])},supported:function(){return OpenLayers.CANVAS_SUPPORTED},setSize:function(e){this.size=e.clone();var t=this.root;if(t.style.width=e.w+"px",t.style.height=e.h+"px",t.width=e.w,t.height=e.h,this.resolution=null,this.hitDetection){var i=this.hitCanvas;i.style.width=e.w+"px",i.style.height=e.h+"px",i.width=e.w,i.height=e.h}},drawFeature:function(e,t){var i;if(e.geometry){t=this.applyDefaultSymbolizer(t||e.style);var n,s=e.geometry.getBounds();this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(n=this.map.getMaxExtent());var a=s&&s.intersectsBounds(this.extent,{worldBounds:n});i="none"!==t.display&&!!s&&a,i?this.features[e.id]=[e,t]:delete this.features[e.id],this.pendingRedraw=!0}return this.pendingRedraw&&!this.locked&&(this.redraw(),this.pendingRedraw=!1),i},drawGeometry:function(e,t,i){var n=e.CLASS_NAME;if("OpenLayers.Geometry.Collection"!=n&&"OpenLayers.Geometry.MultiPoint"!=n&&"OpenLayers.Geometry.MultiLineString"!=n&&"OpenLayers.Geometry.MultiPolygon"!=n)switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":this.drawPoint(e,t,i);break;case"OpenLayers.Geometry.LineString":this.drawLineString(e,t,i);break;case"OpenLayers.Geometry.LinearRing":this.drawLinearRing(e,t,i);break;case"OpenLayers.Geometry.Polygon":this.drawPolygon(e,t,i)}else for(var s=0;s<e.components.length;s++)this.drawGeometry(e.components[s],t,i)},drawExternalGraphic:function(e,t,i){var n=new Image;t.graphicTitle&&(n.title=t.graphicTitle);var s=t.graphicWidth||t.graphicHeight,a=t.graphicHeight||t.graphicWidth;s=s?s:2*t.pointRadius,a=a?a:2*t.pointRadius;var r=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*s),o=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*a),l=t.graphicOpacity||t.fillOpacity,u=function(){if(this.features[i]){var t=this.getLocalXY(e),u=t[0],c=t[1];if(!isNaN(u)&&!isNaN(c)){var h=0|u+r,d=0|c+o,p=this.canvas;p.globalAlpha=l;var f=OpenLayers.Renderer.Canvas.drawImageScaleFactor||(OpenLayers.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);p.drawImage(n,h*f,d*f,s*f,a*f),this.hitDetection&&(this.setHitContextStyle("fill",i),this.hitContext.fillRect(h,d,s,a))}}};n.onload=OpenLayers.Function.bind(u,this),n.src=t.externalGraphic},drawNamedSymbol:function(e,t,i){var n,s,a,r,o,l,u,c,h,d=Math.PI/180,p=OpenLayers.Renderer.symbol[t.graphicName];if(!p)throw new Error(t.graphicName+" is not a valid symbol name");if(p.length&&!(p.length<2)){var f=this.getLocalXY(e),m=f[0],g=f[1];if(!isNaN(m)&&!isNaN(g)){if(this.canvas.lineCap="round",this.canvas.lineJoin="round",this.hitDetection&&(this.hitContext.lineCap="round",this.hitContext.lineJoin="round"),t.graphicName in this.cachedSymbolBounds)l=this.cachedSymbolBounds[t.graphicName];else{for(l=new OpenLayers.Bounds,o=0;o<p.length;o+=2)l.extend(new OpenLayers.LonLat(p[o],p[o+1]));this.cachedSymbolBounds[t.graphicName]=l}if(this.canvas.save(),this.hitDetection&&this.hitContext.save(),this.canvas.translate(m,g),this.hitDetection&&this.hitContext.translate(m,g),c=d*t.rotation,isNaN(c)||(this.canvas.rotate(c),this.hitDetection&&this.hitContext.rotate(c)),u=2*t.pointRadius/Math.max(l.getWidth(),l.getHeight()),this.canvas.scale(u,u),this.hitDetection&&this.hitContext.scale(u,u),a=l.getCenterLonLat().lon,r=l.getCenterLonLat().lat,this.canvas.translate(-a,-r),this.hitDetection&&this.hitContext.translate(-a,-r),h=t.strokeWidth,t.strokeWidth=h/u,t.fill!==!1){for(this.setCanvasStyle("fill",t),this.canvas.beginPath(),o=0;o<p.length;o+=2)n=p[o],s=p[o+1],0==o&&this.canvas.moveTo(n,s),this.canvas.lineTo(n,s);if(this.canvas.closePath(),this.canvas.fill(),this.hitDetection){for(this.setHitContextStyle("fill",i,t),this.hitContext.beginPath(),o=0;o<p.length;o+=2)n=p[o],s=p[o+1],0==o&&this.canvas.moveTo(n,s),this.hitContext.lineTo(n,s);this.hitContext.closePath(),this.hitContext.fill()}}if(t.stroke!==!1){for(this.setCanvasStyle("stroke",t),this.canvas.beginPath(),o=0;o<p.length;o+=2)n=p[o],s=p[o+1],0==o&&this.canvas.moveTo(n,s),this.canvas.lineTo(n,s);if(this.canvas.closePath(),this.canvas.stroke(),this.hitDetection){for(this.setHitContextStyle("stroke",i,t,u),this.hitContext.beginPath(),o=0;o<p.length;o+=2)n=p[o],s=p[o+1],0==o&&this.hitContext.moveTo(n,s),this.hitContext.lineTo(n,s);this.hitContext.closePath(),this.hitContext.stroke()}}t.strokeWidth=h,this.canvas.restore(),this.hitDetection&&this.hitContext.restore(),this.setCanvasStyle("reset")}}},setCanvasStyle:function(e,t){"fill"===e?(this.canvas.globalAlpha=t.fillOpacity,this.canvas.fillStyle=t.fillColor):"stroke"===e?(this.canvas.globalAlpha=t.strokeOpacity,this.canvas.strokeStyle=t.strokeColor,this.canvas.lineWidth=t.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},featureIdToHex:function(e){var t=Number(e.split("_").pop())+1;t>=16777216&&(this.hitOverflow=t-16777215,t=t%16777216+1);var i="000000"+t.toString(16),n=i.length;return i="#"+i.substring(n-6,n)},setHitContextStyle:function(e,t,i,n){var s=this.featureIdToHex(t);"fill"==e?(this.hitContext.globalAlpha=1,this.hitContext.fillStyle=s):"stroke"==e?(this.hitContext.globalAlpha=1,this.hitContext.strokeStyle=s,"undefined"==typeof n?this.hitContext.lineWidth=i.strokeWidth+2:isNaN(n)||(this.hitContext.lineWidth=i.strokeWidth+2/n)):(this.hitContext.globalAlpha=0,this.hitContext.lineWidth=1)},drawPoint:function(e,t,i){if(t.graphic!==!1)if(t.externalGraphic)this.drawExternalGraphic(e,t,i);else if(t.graphicName&&"circle"!=t.graphicName)this.drawNamedSymbol(e,t,i);else{var n=this.getLocalXY(e),s=n[0],a=n[1];if(!isNaN(s)&&!isNaN(a)){var r=2*Math.PI,o=t.pointRadius;t.fill!==!1&&(this.setCanvasStyle("fill",t),this.canvas.beginPath(),this.canvas.arc(s,a,o,0,r,!0),this.canvas.fill(),this.hitDetection&&(this.setHitContextStyle("fill",i,t),this.hitContext.beginPath(),this.hitContext.arc(s,a,o,0,r,!0),this.hitContext.fill())),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.canvas.beginPath(),this.canvas.arc(s,a,o,0,r,!0),this.canvas.stroke(),this.hitDetection&&(this.setHitContextStyle("stroke",i,t),this.hitContext.beginPath(),this.hitContext.arc(s,a,o,0,r,!0),this.hitContext.stroke()),this.setCanvasStyle("reset"))}}},drawLineString:function(e,t,i){t=OpenLayers.Util.applyDefaults({fill:!1},t),this.drawLinearRing(e,t,i)},drawLinearRing:function(e,t,i){t.fill!==!1&&(this.setCanvasStyle("fill",t),this.renderPath(this.canvas,e,t,i,"fill"),this.hitDetection&&(this.setHitContextStyle("fill",i,t),this.renderPath(this.hitContext,e,t,i,"fill"))),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.renderPath(this.canvas,e,t,i,"stroke"),this.hitDetection&&(this.setHitContextStyle("stroke",i,t),this.renderPath(this.hitContext,e,t,i,"stroke"))),this.setCanvasStyle("reset")},renderPath:function(e,t,i,n,s){var a=t.components,r=a.length;e.beginPath();var o=this.getLocalXY(a[0]),l=o[0],u=o[1];if(!isNaN(l)&&!isNaN(u)){e.moveTo(o[0],o[1]);for(var c=1;r>c;++c){var h=this.getLocalXY(a[c]);e.lineTo(h[0],h[1])}"fill"===s?e.fill():e.stroke()}},drawPolygon:function(e,t,i){var n=e.components,s=n.length;this.drawLinearRing(n[0],t,i);for(var a=1;s>a;++a)this.canvas.globalCompositeOperation="destination-out",this.hitDetection&&(this.hitContext.globalCompositeOperation="destination-out"),this.drawLinearRing(n[a],OpenLayers.Util.applyDefaults({stroke:!1,fillOpacity:1},t),i),this.canvas.globalCompositeOperation="source-over",this.hitDetection&&(this.hitContext.globalCompositeOperation="source-over"),this.drawLinearRing(n[a],OpenLayers.Util.applyDefaults({fill:!1},t),i)},drawText:function(e,t){var i=this.getLocalXY(e);this.setCanvasStyle("reset"),this.canvas.fillStyle=t.fontColor,this.canvas.globalAlpha=t.fontOpacity||1;var n=[t.fontStyle?t.fontStyle:"normal","normal",t.fontWeight?t.fontWeight:"normal",t.fontSize?t.fontSize:"1em",t.fontFamily?t.fontFamily:"sans-serif"].join(" "),s=t.label.split("\n"),a=s.length;if(this.canvas.fillText){this.canvas.font=n,this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[0]]||"center",this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[1]]||"middle";var r=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];null==r&&(r=-.5);var o=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;i[1]+=o*r*(a-1);for(var l=0;a>l;l++)t.labelOutlineWidth&&(this.canvas.save(),this.canvas.strokeStyle=t.labelOutlineColor,this.canvas.lineWidth=t.labelOutlineWidth,this.canvas.strokeText(s[l],i[0],i[1]+o*l+1),this.canvas.restore()),this.canvas.fillText(s[l],i[0],i[1]+o*l)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=n;var u=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[0]];null==u&&(u=-.5);var r=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];null==r&&(r=-.5);var o=this.canvas.mozMeasureText("xx");i[1]+=o*(1+r*a);for(var l=0;a>l;l++){var c=i[0]+u*this.canvas.mozMeasureText(s[l]),h=i[1]+l*o;this.canvas.translate(c,h),this.canvas.mozDrawText(s[l]),this.canvas.translate(-c,-h)}}this.setCanvasStyle("reset")},getLocalXY:function(e){var t=this.getResolution(),i=this.extent,n=(e.x-this.featureDx)/t+-i.left/t,s=i.top/t-e.y/t;return[n,s]},clear:function(){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.features={},this.hitDetection&&this.hitContext.clearRect(0,0,t,e)},getFeatureIdFromEvent:function(e){var t,i;if(this.hitDetection&&"none"!==this.root.style.display&&!this.map.dragging){var n=e.xy,s=0|n.x,a=0|n.y,r=this.hitContext.getImageData(s,a,1,1).data;if(255===r[3]){var o=r[2]+256*(r[1]+256*r[0]);if(o){t="OpenLayers.Feature.Vector_"+(o-1+this.hitOverflow);try{i=this.features[t][0]}catch(l){}}}}return i},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0;t<e.length;++t)delete this.features[e[t].id];this.redraw()},redraw:function(){if(!this.locked){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.hitDetection&&this.hitContext.clearRect(0,0,t,e);var i,n,s,a=[],r=this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent();for(var o in this.features)this.features.hasOwnProperty(o)&&(i=this.features[o][0],n=i.geometry,this.calculateFeatureDx(n.getBounds(),r),s=this.features[o][1],this.drawGeometry(n,s,i.id),s.label&&a.push([i,s]));for(var l,u=0,c=a.length;c>u;++u)l=a[u],this.drawText(l[0].geometry.getCentroid(),l[1])}},CLASS_NAME:"OpenLayers.Renderer.Canvas"}),OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"},OpenLayers.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1},OpenLayers.Renderer.Canvas.drawImageScaleFactor=null,OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var e=document.createStyleSheet(),t=["shape","rect","oval","fill","stroke","imagedata","group","textbox"],i=0,n=t.length;n>i;i++)e.addRule("olv\\:"+t[i],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments)}},supported:function(){return!!document.namespaces},setExtent:function(e,t){var i=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),n=this.getResolution(),s=0|e.left/n,a=0|e.top/n-this.size.h;t||!this.offset?(this.offset={x:s,y:a},s=0,a=0):(s-=this.offset.x,a-=this.offset.y);var r=s-this.xOffset+" "+a;this.root.coordorigin=r;for(var o,l=[this.root,this.vectorRoot,this.textRoot],u=0,c=l.length;c>u;++u){o=l[u];var h=this.size.w+" "+this.size.h;o.coordsize=h}return this.root.style.flip="y",i},setSize:function(){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);for(var e,t=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],i=this.size.w+"px",n=this.size.h+"px",s=0,a=t.length;a>s;++s)e=t[s],e.style.width=i,e.style.height=n},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"olv:rect":this.isComplexSymbol(t.graphicName)?"olv:shape":"olv:oval";break;case"OpenLayers.Geometry.Rectangle":i="olv:rect";break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.LinearRing":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":i="olv:shape"}return i},setStyle:function(e,t,i,n){t=t||e._style,i=i||e._options;var s=t.fillColor;if("OpenLayers.Geometry.Point"===e._geometryClass)if(t.externalGraphic){i.isFilled=!0,t.graphicTitle&&(e.title=t.graphicTitle);var a=t.graphicWidth||t.graphicHeight,r=t.graphicHeight||t.graphicWidth;a=a?a:2*t.pointRadius,r=r?r:2*t.pointRadius;var o=this.getResolution(),l=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*a),u=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*r);e.style.left=(0|(n.x-this.featureDx)/o-this.offset.x+l)+"px",e.style.top=(0|n.y/o-this.offset.y-(u+r))+"px",e.style.width=a+"px",e.style.height=r+"px",e.style.flip="y",s="none",i.isStroked=!1}else if(this.isComplexSymbol(t.graphicName)){var c=this.importSymbol(t.graphicName);e.path=c.path,e.coordorigin=c.left+","+c.bottom;var h=c.size;e.coordsize=h+","+h,this.drawCircle(e,n,t.pointRadius),e.style.flip="y"}else this.drawCircle(e,n,t.pointRadius);i.isFilled?e.fillcolor=s:e.filled="false";var d=e.getElementsByTagName("fill"),p=0==d.length?null:d[0];i.isFilled?(p||(p=this.createNode("olv:fill",e.id+"_fill")),p.opacity=t.fillOpacity,"OpenLayers.Geometry.Point"===e._geometryClass&&t.externalGraphic&&(t.graphicOpacity&&(p.opacity=t.graphicOpacity),p.src=t.externalGraphic,p.type="frame",t.graphicWidth&&t.graphicHeight||(p.aspect="atmost")),p.parentNode!=e&&e.appendChild(p)):p&&e.removeChild(p);var f=t.rotation;(void 0!==f||void 0!==e._rotation)&&(e._rotation=f,t.externalGraphic?(this.graphicRotate(e,l,u,t),p.opacity=0):"OpenLayers.Geometry.Point"===e._geometryClass&&(e.style.rotation=f||0));var m=e.getElementsByTagName("stroke"),g=0==m.length?null:m[0];return i.isStroked?(g||(g=this.createNode("olv:stroke",e.id+"_stroke"),e.appendChild(g)),g.on=!0,g.color=t.strokeColor,g.weight=t.strokeWidth+"px",g.opacity=t.strokeOpacity,g.endcap="butt"==t.strokeLinecap?"flat":t.strokeLinecap||"round",t.strokeDashstyle&&(g.dashstyle=this.dashStyle(t))):(e.stroked=!1,g&&(g.on=!1)),"inherit"!=t.cursor&&null!=t.cursor&&(e.style.cursor=t.cursor),e},graphicRotate:function(e,t,i,n){var s,a,n=n||e._style,r=n.rotation||0;if(!n.graphicWidth||!n.graphicHeight){var o=new Image;return o.onreadystatechange=OpenLayers.Function.bind(function(){("complete"==o.readyState||"interactive"==o.readyState)&&(s=o.width/o.height,a=Math.max(2*n.pointRadius,n.graphicWidth||0,n.graphicHeight||0),t*=s,n.graphicWidth=a*s,n.graphicHeight=a,this.graphicRotate(e,t,i,n))},this),o.src=n.externalGraphic,void 0}a=Math.max(n.graphicWidth,n.graphicHeight),s=n.graphicWidth/n.graphicHeight;var l=Math.round(n.graphicWidth||a*s),u=Math.round(n.graphicHeight||a);e.style.width=l+"px",e.style.height=u+"px";var c=document.getElementById(e.id+"_image");c||(c=this.createNode("olv:imagedata",e.id+"_image"),e.appendChild(c)),c.style.width=l+"px",c.style.height=u+"px",c.src=n.externalGraphic,c.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var h=r*Math.PI/180,d=Math.sin(h),p=Math.cos(h),f="progid:DXImageTransform.Microsoft.Matrix(M11="+p+",M12="+-d+",M21="+d+",M22="+p+",SizingMethod='auto expand')\n",m=n.graphicOpacity||n.fillOpacity;m&&1!=m&&(f+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+m+")\n"),e.style.filter=f;var g=new OpenLayers.Geometry.Point(-t,-i),y=new OpenLayers.Bounds(0,0,l,u).toGeometry();y.rotate(n.rotation,g);var v=y.getBounds();e.style.left=Math.round(parseInt(e.style.left)+v.left)+"px",e.style.top=Math.round(parseInt(e.style.top)-v.bottom)+"px"},postDraw:function(e){e.style.visibility="visible";var t=e._style.fillColor,i=e._style.strokeColor;"none"==t&&e.fillcolor!=t&&(e.fillcolor=t),"none"==i&&e.strokecolor!=i&&(e.strokecolor=i)},setNodeDimension:function(e,t){var i=t.getBounds();if(i){var n=this.getResolution(),s=new OpenLayers.Bounds(0|(i.left-this.featureDx)/n-this.offset.x,0|i.bottom/n-this.offset.y,0|(i.right-this.featureDx)/n-this.offset.x,0|i.top/n-this.offset.y);e.style.left=s.left+"px",e.style.top=s.top+"px",e.style.width=s.getWidth()+"px",e.style.height=s.getHeight()+"px",e.coordorigin=s.left+" "+s.top,e.coordsize=s.getWidth()+" "+s.getHeight()}},dashStyle:function(e){var t=e.strokeDashstyle;switch(t){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return t;default:var i=t.split(/[ ,]/);return 2==i.length?1*i[0]>=2*i[1]?"longdash":1==i[0]||1==i[1]?"dot":"dash":4==i.length?1*i[0]>=2*i[1]?"longdashdot":"dashdot":"solid"}},createNode:function(e,t){var i=document.createElement(e);return t&&(i.id=t),i.unselectable="on",i.onselectstart=OpenLayers.Function.False,i},nodeTypeCompare:function(e,t){var i=t,n=i.indexOf(":");-1!=n&&(i=i.substr(n+1));var s=e.nodeName;return n=s.indexOf(":"),-1!=n&&(s=s.substr(n+1)),i==s},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(e){return this.nodeFactory(this.container.id+e,"olv:group")},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){if(!isNaN(t.x)&&!isNaN(t.y)){var n=this.getResolution();e.style.left=(0|(t.x-this.featureDx)/n-this.offset.x)-i+"px",e.style.top=(0|t.y/n-this.offset.y)-i+"px";var s=2*i;return e.style.width=s+"px",e.style.height=s+"px",e}return!1},drawLineString:function(e,t){return this.drawLine(e,t,!1)},drawLinearRing:function(e,t){return this.drawLine(e,t,!0)},drawLine:function(e,t,i){this.setNodeDimension(e,t);for(var n,s,a,r=this.getResolution(),o=t.components.length,l=new Array(o),u=0;o>u;u++)n=t.components[u],s=0|(n.x-this.featureDx)/r-this.offset.x,a=0|n.y/r-this.offset.y,l[u]=" "+s+","+a+" l ";var c=i?" x e":" e";return e.path="m"+l.join("")+c,e},drawPolygon:function(e,t){this.setNodeDimension(e,t);var i,n,s,a,r,o,l,u,c,h,d,p,f=this.getResolution(),m=[];for(i=0,n=t.components.length;n>i;i++){for(m.push("m"),s=t.components[i].components,a=0===i,r=null,o=null,l=0,u=s.length;u>l;l++)c=s[l],d=0|(c.x-this.featureDx)/f-this.offset.x,p=0|c.y/f-this.offset.y,h=" "+d+","+p,m.push(h),0==l&&m.push(" l"),a||(r?r!=h&&(o?o!=h&&(a=!0):o=h):r=h);m.push(a?" x ":" ")}return m.push("e"),e.path=m.join(""),e},drawRectangle:function(e,t){var i=this.getResolution();return e.style.left=(0|(t.x-this.featureDx)/i-this.offset.x)+"px",e.style.top=(0|t.y/i-this.offset.y)+"px",e.style.width=(0|t.width/i)+"px",e.style.height=(0|t.height/i)+"px",e},drawText:function(e,t,i){var n=this.nodeFactory(e+this.LABEL_ID_SUFFIX,"olv:rect"),s=this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),a=this.getResolution();n.style.left=(0|(i.x-this.featureDx)/a-this.offset.x)+"px",n.style.top=(0|i.y/a-this.offset.y)+"px",n.style.flip="y",s.innerText=t.label,"inherit"!=t.cursor&&null!=t.cursor&&(s.style.cursor=t.cursor),t.fontColor&&(s.style.color=t.fontColor),t.fontOpacity&&(s.style.filter="alpha(opacity="+100*t.fontOpacity+")"),t.fontFamily&&(s.style.fontFamily=t.fontFamily),t.fontSize&&(s.style.fontSize=t.fontSize),t.fontWeight&&(s.style.fontWeight=t.fontWeight),t.fontStyle&&(s.style.fontStyle=t.fontStyle),t.labelSelect===!0&&(n._featureId=e,s._featureId=e,s._geometry=i,s._geometryClass=i.CLASS_NAME),s.style.whiteSpace="nowrap",s.inset="1px,0px,0px,0px",n.parentNode||(n.appendChild(s),this.textRoot.appendChild(n));var r=t.labelAlign||"cm";1==r.length&&(r+="m");var o=s.clientWidth*OpenLayers.Renderer.VML.LABEL_SHIFT[r.substr(0,1)],l=s.clientHeight*OpenLayers.Renderer.VML.LABEL_SHIFT[r.substr(1,1)];n.style.left=parseInt(n.style.left)-o-1+"px",n.style.top=parseInt(n.style.top)+l+"px"},moveRoot:function(e){var t=this.map.getLayer(e.container.id);t instanceof OpenLayers.Layer.Vector.RootContainer&&(t=this.map.getLayer(this.container.id)),t&&t.renderer.clear(),OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments),t&&t.redraw()},importSymbol:function(e){var t=this.container.id+"-"+e,i=this.symbolCache[t];if(i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw new Error(e+" is not a valid symbol name");for(var s=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),a=["m"],r=0;r<n.length;r+=2){var o=n[r],l=n[r+1];s.left=Math.min(s.left,o),s.bottom=Math.min(s.bottom,l),s.right=Math.max(s.right,o),s.top=Math.max(s.top,l),a.push(o),a.push(l),0==r&&a.push("l")}a.push("x e");var u=a.join(" "),c=(s.getWidth()-s.getHeight())/2;return c>0?(s.bottom=s.bottom-c,s.top=s.top+c):(s.left=s.left+c,s.right=s.right-c),i={path:u,size:s.getWidth(),left:s.left,bottom:s.bottom},this.symbolCache[t]=i,i},CLASS_NAME:"OpenLayers.Renderer.VML"}),OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:.5,r:1,t:0,m:.5,b:1},OpenLayers.Layer.Vector=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,isFixed:!1,features:null,filter:null,selectedFeatures:null,unrenderedFeatures:null,reportError:!0,style:null,styleMap:null,strategies:null,protocol:null,renderers:["SVG","VML","Canvas"],renderer:null,rendererOptions:null,geometryType:null,drawn:!1,ratio:1,initialize:function(){if(OpenLayers.Layer.prototype.initialize.apply(this,arguments),this.renderer&&this.renderer.supported()||this.assignRenderer(),this.renderer&&this.renderer.supported()||(this.renderer=null,this.displayError()),this.styleMap||(this.styleMap=new OpenLayers.StyleMap),this.features=[],this.selectedFeatures=[],this.unrenderedFeatures={},this.strategies)for(var e=0,t=this.strategies.length;t>e;e++)this.strategies[e].setLayer(this)},destroy:function(){if(this.strategies){var e,t,i;for(t=0,i=this.strategies.length;i>t;t++)e=this.strategies[t],e.autoDestroy&&e.destroy();this.strategies=null}this.protocol&&(this.protocol.autoDestroy&&this.protocol.destroy(),this.protocol=null),this.destroyFeatures(),this.features=null,this.selectedFeatures=null,this.unrenderedFeatures=null,this.renderer&&this.renderer.destroy(),this.renderer=null,this.geometryType=null,this.drawn=null,OpenLayers.Layer.prototype.destroy.apply(this,arguments)},clone:function(e){null==e&&(e=new OpenLayers.Layer.Vector(this.name,this.getOptions())),e=OpenLayers.Layer.prototype.clone.apply(this,[e]);for(var t=this.features,i=t.length,n=new Array(i),s=0;i>s;++s)n[s]=t[s].clone();return e.features=n,e},refresh:function(e){this.calculateInRange()&&this.visibility&&this.events.triggerEvent("refresh",e)},assignRenderer:function(){for(var e=0,t=this.renderers.length;t>e;e++){var i=this.renderers[e],n="function"==typeof i?i:OpenLayers.Renderer[i];if(n&&n.prototype.supported()){this.renderer=new n(this.div,this.rendererOptions);break}}},displayError:function(){this.reportError&&OpenLayers.Console.userError(OpenLayers.i18n("browserNotSupported",{renderers:this.renderers.join("\n")}))},setMap:function(){if(OpenLayers.Layer.prototype.setMap.apply(this,arguments),this.renderer){this.renderer.map=this.map;var e=this.map.getSize();e.w=e.w*this.ratio,e.h=e.h*this.ratio,this.renderer.setSize(e)}else this.map.removeLayer(this)},afterAdd:function(){if(this.strategies){var e,t,i;for(t=0,i=this.strategies.length;i>t;t++)e=this.strategies[t],e.autoActivate&&e.activate()}},removeMap:function(){if(this.drawn=!1,this.strategies){var e,t,i;for(t=0,i=this.strategies.length;i>t;t++)e=this.strategies[t],e.autoActivate&&e.deactivate()}},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.apply(this,arguments);var e=this.map.getSize();e.w=e.w*this.ratio,e.h=e.h*this.ratio,this.renderer.setSize(e)},moveTo:function(e,t,i){OpenLayers.Layer.prototype.moveTo.apply(this,arguments);var n=!0;if(!i){this.renderer.root.style.visibility="hidden";var s=this.map.getSize(),a=s.w,r=s.h,o=a/2*this.ratio-a/2,l=r/2*this.ratio-r/2;o+=parseInt(this.map.layerContainerDiv.style.left,10),o=-Math.round(o),l+=parseInt(this.map.layerContainerDiv.style.top,10),l=-Math.round(l),this.div.style.left=o+"px",this.div.style.top=l+"px";var u=this.map.getExtent().scale(this.ratio);if(n=this.renderer.setExtent(u,t),this.renderer.root.style.visibility="visible",OpenLayers.IS_GECKO===!0&&(this.div.scrollLeft=this.div.scrollLeft),!t&&n)for(var c in this.unrenderedFeatures){var h=this.unrenderedFeatures[c];this.drawFeature(h)}}if(!this.drawn||t||!n){this.drawn=!0;for(var h,c=0,d=this.features.length;d>c;c++)this.renderer.locked=c!==d-1,h=this.features[c],this.drawFeature(h)}},display:function(){OpenLayers.Layer.prototype.display.apply(this,arguments);var e=this.div.style.display;e!=this.renderer.root.style.display&&(this.renderer.root.style.display=e)},addFeatures:function(e,t){OpenLayers.Util.isArray(e)||(e=[e]);var i=!t||!t.silent;if(i){var n={features:e},s=this.events.triggerEvent("beforefeaturesadded",n);if(s===!1)return;e=n.features}for(var a=[],r=0,o=e.length;o>r;r++){this.renderer.locked=r!=e.length-1?!0:!1;var l=e[r];if(this.geometryType&&!(l.geometry instanceof this.geometryType))throw new TypeError("addFeatures: component should be an "+this.geometryType.prototype.CLASS_NAME);if(l.layer=this,!l.style&&this.style&&(l.style=OpenLayers.Util.extend({},this.style)),i){if(this.events.triggerEvent("beforefeatureadded",{feature:l})===!1)continue;this.preFeatureInsert(l)}a.push(l),this.features.push(l),this.drawFeature(l),i&&(this.events.triggerEvent("featureadded",{feature:l}),this.onFeatureInsert(l))}i&&this.events.triggerEvent("featuresadded",{features:a})},removeFeatures:function(e,t){if(e&&0!==e.length){if(e===this.features)return this.removeAllFeatures(t);OpenLayers.Util.isArray(e)||(e=[e]),e===this.selectedFeatures&&(e=e.slice());var i=!t||!t.silent;i&&this.events.triggerEvent("beforefeaturesremoved",{features:e});for(var n=e.length-1;n>=0;n--){this.renderer.locked=0!=n&&e[n-1].geometry?!0:!1;var s=e[n];delete this.unrenderedFeatures[s.id],i&&this.events.triggerEvent("beforefeatureremoved",{feature:s}),this.features=OpenLayers.Util.removeItem(this.features,s),s.layer=null,s.geometry&&this.renderer.eraseFeatures(s),-1!=OpenLayers.Util.indexOf(this.selectedFeatures,s)&&OpenLayers.Util.removeItem(this.selectedFeatures,s),i&&this.events.triggerEvent("featureremoved",{feature:s})}i&&this.events.triggerEvent("featuresremoved",{features:e})}},removeAllFeatures:function(e){var t=!e||!e.silent,i=this.features;t&&this.events.triggerEvent("beforefeaturesremoved",{features:i});for(var n,s=i.length-1;s>=0;s--)n=i[s],t&&this.events.triggerEvent("beforefeatureremoved",{feature:n}),n.layer=null,t&&this.events.triggerEvent("featureremoved",{feature:n});this.renderer.clear(),this.features=[],this.unrenderedFeatures={},this.selectedFeatures=[],t&&this.events.triggerEvent("featuresremoved",{features:i})},destroyFeatures:function(e,t){var i=void 0==e;if(i&&(e=this.features),e){this.removeFeatures(e,t);for(var n=e.length-1;n>=0;n--)e[n].destroy()}},drawFeature:function(e,t){if(this.drawn){if("object"!=typeof t){t||e.state!==OpenLayers.State.DELETE||(t="delete");var i=t||e.renderIntent;t=e.style||this.style,t||(t=this.styleMap.createSymbolizer(e,i))}var n=this.renderer.drawFeature(e,t);n===!1||null===n?this.unrenderedFeatures[e.id]=e:delete this.unrenderedFeatures[e.id]}},eraseFeatures:function(e){this.renderer.eraseFeatures(e)},getFeatureFromEvent:function(e){if(!this.renderer)throw new Error("getFeatureFromEvent called on layer with no renderer. This usually means you destroyed a layer, but not some handler which is associated with it.");
var t=null,i=this.renderer.getFeatureIdFromEvent(e);return i&&(t="string"==typeof i?this.getFeatureById(i):i),t},getFeatureBy:function(e,t){for(var i=null,n=0,s=this.features.length;s>n;++n)if(this.features[n][e]==t){i=this.features[n];break}return i},getFeatureById:function(e){return this.getFeatureBy("id",e)},getFeatureByFid:function(e){return this.getFeatureBy("fid",e)},getFeaturesByAttribute:function(e,t){var i,n,s=this.features.length,a=[];for(i=0;s>i;i++)n=this.features[i],n&&n.attributes&&n.attributes[e]===t&&a.push(n);return a},onFeatureInsert:function(){},preFeatureInsert:function(){},getDataExtent:function(){var e=null,t=this.features;if(t&&t.length>0)for(var i=null,n=0,s=t.length;s>n;n++)i=t[n].geometry,i&&(null===e&&(e=new OpenLayers.Bounds),e.extend(i.getBounds()));return e},CLASS_NAME:"OpenLayers.Layer.Vector"}),OpenLayers.Layer.Vector.RootContainer=OpenLayers.Class(OpenLayers.Layer.Vector,{displayInLayerSwitcher:!1,layers:null,display:function(){},getFeatureFromEvent:function(e){for(var t,i=this.layers,n=0;n<i.length;n++)if(t=i[n].getFeatureFromEvent(e))return t},setMap:function(e){OpenLayers.Layer.Vector.prototype.setMap.apply(this,arguments),this.collectRoots(),e.events.register("changelayer",this,this.handleChangeLayer)},removeMap:function(e){e.events.unregister("changelayer",this,this.handleChangeLayer),this.resetRoots(),OpenLayers.Layer.Vector.prototype.removeMap.apply(this,arguments)},collectRoots:function(){for(var e,t=0;t<this.map.layers.length;++t)e=this.map.layers[t],-1!=OpenLayers.Util.indexOf(this.layers,e)&&e.renderer.moveRoot(this.renderer)},resetRoots:function(){for(var e,t=0;t<this.layers.length;++t)e=this.layers[t],this.renderer&&e.renderer.getRenderLayerId()==this.id&&this.renderer.moveRoot(e.renderer)},handleChangeLayer:function(e){var t=e.layer;"order"==e.property&&-1!=OpenLayers.Util.indexOf(this.layers,t)&&(this.resetRoots(),this.collectRoots())},CLASS_NAME:"OpenLayers.Layer.Vector.RootContainer"}),OpenLayers.Strategy=OpenLayers.Class({layer:null,options:null,active:null,autoActivate:!0,autoDestroy:!0,initialize:function(e){OpenLayers.Util.extend(this,e),this.options=e,this.active=!1},destroy:function(){this.deactivate(),this.layer=null,this.options=null},setLayer:function(e){this.layer=e},activate:function(){return this.active?!1:(this.active=!0,!0)},deactivate:function(){return this.active?(this.active=!1,!0):!1},CLASS_NAME:"OpenLayers.Strategy"}),OpenLayers.Filter=OpenLayers.Class({initialize:function(e){OpenLayers.Util.extend(this,e)},destroy:function(){},evaluate:function(){return!0},clone:function(){return null},toString:function(){var e;return e=OpenLayers.Format&&OpenLayers.Format.CQL?OpenLayers.Format.CQL.prototype.write(this):Object.prototype.toString.call(this)},CLASS_NAME:"OpenLayers.Filter"}),OpenLayers.Filter.FeatureId=OpenLayers.Class(OpenLayers.Filter,{fids:null,type:"FID",initialize:function(e){this.fids=[],OpenLayers.Filter.prototype.initialize.apply(this,[e])},evaluate:function(e){for(var t=0,i=this.fids.length;i>t;t++){var n=e.fid||e.id;if(n==this.fids[t])return!0}return!1},clone:function(){var e=new OpenLayers.Filter.FeatureId;return OpenLayers.Util.extend(e,this),e.fids=this.fids.slice(),e},CLASS_NAME:"OpenLayers.Filter.FeatureId"}),OpenLayers.Filter.Logical=OpenLayers.Class(OpenLayers.Filter,{filters:null,type:null,initialize:function(e){this.filters=[],OpenLayers.Filter.prototype.initialize.apply(this,[e])},destroy:function(){this.filters=null,OpenLayers.Filter.prototype.destroy.apply(this)},evaluate:function(e){var t,i;switch(this.type){case OpenLayers.Filter.Logical.AND:for(t=0,i=this.filters.length;i>t;t++)if(0==this.filters[t].evaluate(e))return!1;return!0;case OpenLayers.Filter.Logical.OR:for(t=0,i=this.filters.length;i>t;t++)if(1==this.filters[t].evaluate(e))return!0;return!1;case OpenLayers.Filter.Logical.NOT:return!this.filters[0].evaluate(e)}return void 0},clone:function(){for(var e=[],t=0,i=this.filters.length;i>t;++t)e.push(this.filters[t].clone());return new OpenLayers.Filter.Logical({type:this.type,filters:e})},CLASS_NAME:"OpenLayers.Filter.Logical"}),OpenLayers.Filter.Logical.AND="&&",OpenLayers.Filter.Logical.OR="||",OpenLayers.Filter.Logical.NOT="!",OpenLayers.Filter.Comparison=OpenLayers.Class(OpenLayers.Filter,{type:null,property:null,value:null,matchCase:!0,lowerBoundary:null,upperBoundary:null,initialize:function(e){OpenLayers.Filter.prototype.initialize.apply(this,[e]),this.type===OpenLayers.Filter.Comparison.LIKE&&void 0===e.matchCase&&(this.matchCase=null)},evaluate:function(e){e instanceof OpenLayers.Feature.Vector&&(e=e.attributes);var t,i=!1,n=e[this.property];switch(this.type){case OpenLayers.Filter.Comparison.EQUAL_TO:t=this.value,i=this.matchCase||"string"!=typeof n||"string"!=typeof t?n==t:n.toUpperCase()==t.toUpperCase();break;case OpenLayers.Filter.Comparison.NOT_EQUAL_TO:t=this.value,i=this.matchCase||"string"!=typeof n||"string"!=typeof t?n!=t:n.toUpperCase()!=t.toUpperCase();break;case OpenLayers.Filter.Comparison.LESS_THAN:i=n<this.value;break;case OpenLayers.Filter.Comparison.GREATER_THAN:i=n>this.value;break;case OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO:i=n<=this.value;break;case OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO:i=n>=this.value;break;case OpenLayers.Filter.Comparison.BETWEEN:i=n>=this.lowerBoundary&&n<=this.upperBoundary;break;case OpenLayers.Filter.Comparison.LIKE:var s=new RegExp(this.value,"gi");i=s.test(n)}return i},value2regex:function(e,t,i){if("."==e)throw new Error("'.' is an unsupported wildCard character for OpenLayers.Filter.Comparison");return e=e?e:"*",t=t?t:".",i=i?i:"!",this.value=this.value.replace(new RegExp("\\"+i+"(.|$)","g"),"\\$1"),this.value=this.value.replace(new RegExp("\\"+t,"g"),"."),this.value=this.value.replace(new RegExp("\\"+e,"g"),".*"),this.value=this.value.replace(new RegExp("\\\\.\\*","g"),"\\"+e),this.value=this.value.replace(new RegExp("\\\\\\.","g"),"\\"+t),this.value},regex2value:function(){var e=this.value;return e=e.replace(/!/g,"!!"),e=e.replace(/(\\)?\\\./g,function(e,t){return t?e:"!."}),e=e.replace(/(\\)?\\\*/g,function(e,t){return t?e:"!*"}),e=e.replace(/\\\\/g,"\\"),e=e.replace(/\.\*/g,"*")},clone:function(){return OpenLayers.Util.extend(new OpenLayers.Filter.Comparison,this)},CLASS_NAME:"OpenLayers.Filter.Comparison"}),OpenLayers.Filter.Comparison.EQUAL_TO="==",OpenLayers.Filter.Comparison.NOT_EQUAL_TO="!=",OpenLayers.Filter.Comparison.LESS_THAN="<",OpenLayers.Filter.Comparison.GREATER_THAN=">",OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO="<=",OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO=">=",OpenLayers.Filter.Comparison.BETWEEN="..",OpenLayers.Filter.Comparison.LIKE="~",OpenLayers.Filter.Spatial=OpenLayers.Class(OpenLayers.Filter,{type:null,property:null,value:null,distance:null,distanceUnits:null,evaluate:function(e){var t=!1;switch(this.type){case OpenLayers.Filter.Spatial.BBOX:case OpenLayers.Filter.Spatial.INTERSECTS:if(e.geometry){var i=this.value;"OpenLayers.Bounds"==this.value.CLASS_NAME&&(i=this.value.toGeometry()),e.geometry.intersects(i)&&(t=!0)}break;default:throw new Error("evaluate is not implemented for this filter type.")}return t},clone:function(){var e=OpenLayers.Util.applyDefaults({value:this.value&&this.value.clone&&this.value.clone()},this);return new OpenLayers.Filter.Spatial(e)},CLASS_NAME:"OpenLayers.Filter.Spatial"}),OpenLayers.Filter.Spatial.BBOX="BBOX",OpenLayers.Filter.Spatial.INTERSECTS="INTERSECTS",OpenLayers.Filter.Spatial.DWITHIN="DWITHIN",OpenLayers.Filter.Spatial.WITHIN="WITHIN",OpenLayers.Filter.Spatial.CONTAINS="CONTAINS",OpenLayers.Filter.Function=OpenLayers.Class(OpenLayers.Filter,{name:null,params:null,CLASS_NAME:"OpenLayers.Filter.Function"}),OpenLayers.Protocol=OpenLayers.Class({format:null,options:null,autoDestroy:!0,defaultFilter:null,initialize:function(e){e=e||{},OpenLayers.Util.extend(this,e),this.options=e},mergeWithDefaultFilter:function(e){var t;return t=e&&this.defaultFilter?new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[this.defaultFilter,e]}):e||this.defaultFilter||void 0},destroy:function(){this.options=null,this.format=null},read:function(e){e=e||{},e.filter=this.mergeWithDefaultFilter(e.filter)},create:function(){},update:function(){},"delete":function(){},commit:function(){},abort:function(){},createCallback:function(e,t,i){return OpenLayers.Function.bind(function(){e.apply(this,[t,i])},this)},CLASS_NAME:"OpenLayers.Protocol"}),OpenLayers.Protocol.Response=OpenLayers.Class({code:null,requestType:null,last:!0,features:null,data:null,reqFeatures:null,priv:null,error:null,initialize:function(e){OpenLayers.Util.extend(this,e)},success:function(){return this.code>0},CLASS_NAME:"OpenLayers.Protocol.Response"}),OpenLayers.Protocol.Response.SUCCESS=1,OpenLayers.Protocol.Response.FAILURE=0,OpenLayers.Protocol.WFS=function(e){e=OpenLayers.Util.applyDefaults(e,OpenLayers.Protocol.WFS.DEFAULTS);var t=OpenLayers.Protocol.WFS["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported WFS version: "+e.version;return new t(e)},OpenLayers.Protocol.WFS.fromWMSLayer=function(e,t){var i,n,s=e.params.LAYERS,a=(OpenLayers.Util.isArray(s)?s[0]:s).split(":");a.length>1&&(n=a[0]),i=a.pop();var r={url:e.url,featureType:i,featurePrefix:n,srsName:e.projection&&e.projection.getCode()||e.map&&e.map.getProjectionObject().getCode(),version:"1.1.0"};return new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults(t,r))},OpenLayers.Protocol.WFS.DEFAULTS={version:"1.0.0"},OpenLayers.Protocol.WFS.v1=OpenLayers.Class(OpenLayers.Protocol,{version:null,srsName:"EPSG:4326",featureType:null,featureNS:null,geometryName:"the_geom",schema:null,featurePrefix:"feature",formatOptions:null,readFormat:null,readOptions:null,initialize:function(e){OpenLayers.Protocol.prototype.initialize.apply(this,[e]),e.format||(this.format=OpenLayers.Format.WFST(OpenLayers.Util.extend({version:this.version,featureType:this.featureType,featureNS:this.featureNS,featurePrefix:this.featurePrefix,geometryName:this.geometryName,srsName:this.srsName,schema:this.schema},this.formatOptions))),!e.geometryName&&parseFloat(this.format.version)>1&&this.setGeometryName(null)},destroy:function(){this.options&&!this.options.format&&this.format.destroy(),this.format=null,OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(e){OpenLayers.Protocol.prototype.read.apply(this,arguments),e=OpenLayers.Util.extend({},e),OpenLayers.Util.applyDefaults(e,this.options||{});var t=new OpenLayers.Protocol.Response({requestType:"read"}),i=OpenLayers.Format.XML.prototype.write.apply(this.format,[this.format.writeNode("wfs:GetFeature",e)]);return t.priv=OpenLayers.Request.POST({url:e.url,callback:this.createCallback(this.handleRead,t,e),params:e.params,headers:e.headers,data:i}),t},setFeatureType:function(e){this.featureType=e,this.format.featureType=e},setGeometryName:function(e){this.geometryName=e,this.format.geometryName=e},handleRead:function(e,t){if(t=OpenLayers.Util.extend({},t),OpenLayers.Util.applyDefaults(t,this.options),t.callback){var i=e.priv;if(i.status>=200&&i.status<300){var n=this.parseResponse(i,t.readOptions);n&&n.success!==!1?(t.readOptions&&"object"==t.readOptions.output?OpenLayers.Util.extend(e,n):e.features=n,e.code=OpenLayers.Protocol.Response.SUCCESS):(e.code=OpenLayers.Protocol.Response.FAILURE,e.error=n)}else e.code=OpenLayers.Protocol.Response.FAILURE;t.callback.call(t.scope,e)}},parseResponse:function(e,t){var i=e.responseXML;if(i&&i.documentElement||(i=e.responseText),!i||i.length<=0)return null;var n=null!==this.readFormat?this.readFormat.read(i):this.format.read(i,t);if(!this.featureNS){var s=this.readFormat||this.format;this.featureNS=s.featureNS,s.autoConfig=!1,this.geometryName||this.setGeometryName(s.geometryName)}return n},commit:function(e,t){t=OpenLayers.Util.extend({},t),OpenLayers.Util.applyDefaults(t,this.options);var i=new OpenLayers.Protocol.Response({requestType:"commit",reqFeatures:e});return i.priv=OpenLayers.Request.POST({url:t.url,headers:t.headers,data:this.format.write(e,t),callback:this.createCallback(this.handleCommit,i,t)}),i},handleCommit:function(e,t){if(t.callback){var i=e.priv,n=i.responseXML;n&&n.documentElement||(n=i.responseText);var s=this.format.read(n)||{};e.insertIds=s.insertIds||[],s.success?e.code=OpenLayers.Protocol.Response.SUCCESS:(e.code=OpenLayers.Protocol.Response.FAILURE,e.error=s),t.callback.call(t.scope,e)}},filterDelete:function(e,t){t=OpenLayers.Util.extend({},t),OpenLayers.Util.applyDefaults(t,this.options),new OpenLayers.Protocol.Response({requestType:"commit"});var i=this.format.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version}}),n=this.format.createElementNSPlus("wfs:Delete",{attributes:{typeName:(t.featureNS?this.featurePrefix+":":"")+t.featureType}});t.featureNS&&n.setAttribute("xmlns:"+this.featurePrefix,t.featureNS);var s=this.format.writeNode("ogc:Filter",e);n.appendChild(s),i.appendChild(n);var a=OpenLayers.Format.XML.prototype.write.apply(this.format,[i]);return OpenLayers.Request.POST({url:this.url,callback:t.callback||function(){},data:a})},abort:function(e){e&&e.priv.abort()},CLASS_NAME:"OpenLayers.Protocol.WFS.v1"}),OpenLayers.Protocol.WFS.v1_1_0=OpenLayers.Class(OpenLayers.Protocol.WFS.v1,{version:"1.1.0",initialize:function(){OpenLayers.Protocol.WFS.v1.prototype.initialize.apply(this,arguments),this.outputFormat&&!this.readFormat&&("gml2"==this.outputFormat.toLowerCase()?this.readFormat=new OpenLayers.Format.GML.v2({featureType:this.featureType,featureNS:this.featureNS,geometryName:this.geometryName}):"json"==this.outputFormat.toLowerCase()&&(this.readFormat=new OpenLayers.Format.GeoJSON))},CLASS_NAME:"OpenLayers.Protocol.WFS.v1_1_0"}),OpenLayers.Style=OpenLayers.Class({id:null,name:null,title:null,description:null,layerName:null,isDefault:!1,rules:null,context:null,defaultStyle:null,defaultsPerSymbolizer:!1,propertyStyles:null,initialize:function(e,t){OpenLayers.Util.extend(this,t),this.rules=[],t&&t.rules&&this.addRules(t.rules),this.setDefaultStyle(e||OpenLayers.Feature.Vector.style["default"]),this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var e=0,t=this.rules.length;t>e;e++)this.rules[e].destroy(),this.rules[e]=null;this.rules=null,this.defaultStyle=null},createSymbolizer:function(e){for(var t,i=this.defaultsPerSymbolizer?{}:this.createLiterals(OpenLayers.Util.extend({},this.defaultStyle),e),n=this.rules,s=[],a=!1,r=0,o=n.length;o>r;r++){t=n[r];var l=t.evaluate(e);l&&(t instanceof OpenLayers.Rule&&t.elseFilter?s.push(t):(a=!0,this.applySymbolizer(t,i,e)))}if(0==a&&s.length>0){a=!0;for(var r=0,o=s.length;o>r;r++)this.applySymbolizer(s[r],i,e)}return n.length>0&&0==a&&(i.display="none"),null!=i.label&&"string"!=typeof i.label&&(i.label=String(i.label)),i},applySymbolizer:function(e,t,i){var n=i.geometry?this.getSymbolizerPrefix(i.geometry):OpenLayers.Style.SYMBOLIZER_PREFIXES[0],s=e.symbolizer[n]||e.symbolizer;if(this.defaultsPerSymbolizer===!0){var a=this.defaultStyle;OpenLayers.Util.applyDefaults(s,{pointRadius:a.pointRadius}),(s.stroke===!0||s.graphic===!0)&&OpenLayers.Util.applyDefaults(s,{strokeWidth:a.strokeWidth,strokeColor:a.strokeColor,strokeOpacity:a.strokeOpacity,strokeDashstyle:a.strokeDashstyle,strokeLinecap:a.strokeLinecap}),(s.fill===!0||s.graphic===!0)&&OpenLayers.Util.applyDefaults(s,{fillColor:a.fillColor,fillOpacity:a.fillOpacity}),s.graphic===!0&&OpenLayers.Util.applyDefaults(s,{pointRadius:this.defaultStyle.pointRadius,externalGraphic:this.defaultStyle.externalGraphic,graphicName:this.defaultStyle.graphicName,graphicOpacity:this.defaultStyle.graphicOpacity,graphicWidth:this.defaultStyle.graphicWidth,graphicHeight:this.defaultStyle.graphicHeight,graphicXOffset:this.defaultStyle.graphicXOffset,graphicYOffset:this.defaultStyle.graphicYOffset})}return this.createLiterals(OpenLayers.Util.extend(t,s),i)},createLiterals:function(e,t){var i=OpenLayers.Util.extend({},t.attributes||t.data);OpenLayers.Util.extend(i,this.context);for(var n in this.propertyStyles)e[n]=OpenLayers.Style.createLiteral(e[n],i,t,n);return e},findPropertyStyles:function(){var e={},t=this.defaultStyle;this.addPropertyStyles(e,t);for(var i,n,s=this.rules,a=0,r=s.length;r>a;a++){i=s[a].symbolizer;for(var o in i){if(n=i[o],"object"!=typeof n){this.addPropertyStyles(e,i);break}this.addPropertyStyles(e,n)}}return e},addPropertyStyles:function(e,t){var i;for(var n in t)i=t[n],"string"==typeof i&&i.match(/\$\{\w+\}/)&&(e[n]=!0);return e},addRules:function(e){Array.prototype.push.apply(this.rules,e),this.propertyStyles=this.findPropertyStyles()},setDefaultStyle:function(e){this.defaultStyle=e,this.propertyStyles=this.findPropertyStyles()},getSymbolizerPrefix:function(e){for(var t=OpenLayers.Style.SYMBOLIZER_PREFIXES,i=0,n=t.length;n>i;i++)if(-1!=e.CLASS_NAME.indexOf(t[i]))return t[i]},clone:function(){var e=OpenLayers.Util.extend({},this);if(this.rules){e.rules=[];for(var t=0,i=this.rules.length;i>t;++t)e.rules.push(this.rules[t].clone())}e.context=this.context&&OpenLayers.Util.extend({},this.context);var n=OpenLayers.Util.extend({},this.defaultStyle);return new OpenLayers.Style(n,e)},CLASS_NAME:"OpenLayers.Style"}),OpenLayers.Style.createLiteral=function(e,t,i,n){return"string"==typeof e&&-1!=e.indexOf("${")&&(e=OpenLayers.String.format(e,t,[i,n]),e=isNaN(e)||!e?e:parseFloat(e)),e},OpenLayers.Style.SYMBOLIZER_PREFIXES=["Point","Line","Polygon","Text","Raster"],OpenLayers.StyleMap=OpenLayers.Class({styles:null,extendDefault:!0,initialize:function(e,t){if(this.styles={"default":new OpenLayers.Style(OpenLayers.Feature.Vector.style["default"]),select:new OpenLayers.Style(OpenLayers.Feature.Vector.style.select),temporary:new OpenLayers.Style(OpenLayers.Feature.Vector.style.temporary),"delete":new OpenLayers.Style(OpenLayers.Feature.Vector.style["delete"])},e instanceof OpenLayers.Style)this.styles["default"]=e,this.styles.select=e,this.styles.temporary=e,this.styles["delete"]=e;else if("object"==typeof e)for(var i in e)if(e[i]instanceof OpenLayers.Style)this.styles[i]=e[i];else{if("object"!=typeof e[i]){this.styles["default"]=new OpenLayers.Style(e),this.styles.select=new OpenLayers.Style(e),this.styles.temporary=new OpenLayers.Style(e),this.styles["delete"]=new OpenLayers.Style(e);break}this.styles[i]=new OpenLayers.Style(e[i])}OpenLayers.Util.extend(this,t)},destroy:function(){for(var e in this.styles)this.styles[e].destroy();this.styles=null},createSymbolizer:function(e,t){e||(e=new OpenLayers.Feature.Vector),this.styles[t]||(t="default"),e.renderIntent=t;var i={};return this.extendDefault&&"default"!=t&&(i=this.styles["default"].createSymbolizer(e)),OpenLayers.Util.extend(i,this.styles[t].createSymbolizer(e))},addUniqueValueRules:function(e,t,i,n){var s=[];for(var a in i)s.push(new OpenLayers.Rule({symbolizer:i[a],context:n,filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:t,value:a})}));this.styles[e].addRules(s)},CLASS_NAME:"OpenLayers.StyleMap"}),OpenLayers.Rule=OpenLayers.Class({id:null,name:null,title:null,description:null,context:null,filter:null,elseFilter:!1,symbolizer:null,symbolizers:null,minScaleDenominator:null,maxScaleDenominator:null,initialize:function(e){this.symbolizer={},OpenLayers.Util.extend(this,e),this.symbolizers&&delete this.symbolizer,this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var e in this.symbolizer)this.symbolizer[e]=null;this.symbolizer=null,delete this.symbolizers},evaluate:function(e){var t=this.getContext(e),i=!0;if(this.minScaleDenominator||this.maxScaleDenominator)var n=e.layer.map.getScale();return this.minScaleDenominator&&(i=n>=OpenLayers.Style.createLiteral(this.minScaleDenominator,t)),i&&this.maxScaleDenominator&&(i=n<OpenLayers.Style.createLiteral(this.maxScaleDenominator,t)),i&&this.filter&&(i="OpenLayers.Filter.FeatureId"==this.filter.CLASS_NAME?this.filter.evaluate(e):this.filter.evaluate(t)),i},getContext:function(e){var t=this.context;return t||(t=e.attributes||e.data),"function"==typeof this.context&&(t=this.context(e)),t},clone:function(){var e=OpenLayers.Util.extend({},this);if(this.symbolizers){var t=this.symbolizers.length;e.symbolizers=new Array(t);for(var i=0;t>i;++i)e.symbolizers[i]=this.symbolizers[i].clone()}else{e.symbolizer={};var n,s;for(var a in this.symbolizer)n=this.symbolizer[a],s=typeof n,"object"===s?e.symbolizer[a]=OpenLayers.Util.extend({},n):"string"===s&&(e.symbolizer[a]=n)}return e.filter=this.filter&&this.filter.clone(),e.context=this.context&&OpenLayers.Util.extend({},this.context),new OpenLayers.Rule(e)},CLASS_NAME:"OpenLayers.Rule"}),OpenLayers.Format=OpenLayers.Class({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(e){OpenLayers.Util.extend(this,e),this.options=e},destroy:function(){},read:function(){throw new Error("Read not implemented.")},write:function(){throw new Error("Write not implemented.")},CLASS_NAME:"OpenLayers.Format"}),OpenLayers.Format.XML=OpenLayers.Class(OpenLayers.Format,{namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(e){window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM")),OpenLayers.Format.prototype.initialize.apply(this,[e]),this.namespaces=OpenLayers.Util.extend({},this.namespaces),this.namespaceAlias={};for(var t in this.namespaces)this.namespaceAlias[this.namespaces[t]]=t},destroy:function(){this.xmldom=null,OpenLayers.Format.prototype.destroy.apply(this,arguments)},setNamespace:function(e,t){this.namespaces[e]=t,this.namespaceAlias[t]=e},read:function(e){var t=e.indexOf("<");t>0&&(e=e.substring(t));var i=OpenLayers.Util.Try(OpenLayers.Function.bind(function(){var t;return t=window.ActiveXObject&&!this.xmldom?new ActiveXObject("Microsoft.XMLDOM"):this.xmldom,t.loadXML(e),t},this),function(){return(new DOMParser).parseFromString(e,"text/xml")},function(){var t=new XMLHttpRequest;return t.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(e),!1),t.overrideMimeType&&t.overrideMimeType("text/xml"),t.send(null),t.responseXML});return this.keepData&&(this.data=i),i},write:function(e){var t;if(this.xmldom)t=e.xml;else{var i=new XMLSerializer;if(1==e.nodeType){var n=document.implementation.createDocument("","",null);n.importNode&&(e=n.importNode(e,!0)),n.appendChild(e),t=i.serializeToString(n)}else t=i.serializeToString(e)}return t},createElementNS:function(e,t){var i;return i=this.xmldom?"string"==typeof e?this.xmldom.createNode(1,t,e):this.xmldom.createNode(1,t,""):document.createElementNS(e,t)},createTextNode:function(e){var t;return"string"!=typeof e&&(e=String(e)),t=this.xmldom?this.xmldom.createTextNode(e):document.createTextNode(e)},getElementsByTagNameNS:function(e,t,i){var n=[];if(e.getElementsByTagNameNS)n=e.getElementsByTagNameNS(t,i);else for(var s,a,r=e.getElementsByTagName("*"),o=0,l=r.length;l>o;++o)s=r[o],a=s.prefix?s.prefix+":"+i:i,("*"==i||a==s.nodeName)&&("*"==t||t==s.namespaceURI)&&n.push(s);return n},getAttributeNodeNS:function(e,t,i){var n=null;if(e.getAttributeNodeNS)n=e.getAttributeNodeNS(t,i);else for(var s,a,r=e.attributes,o=0,l=r.length;l>o;++o)if(s=r[o],s.namespaceURI==t&&(a=s.prefix?s.prefix+":"+i:i,a==s.nodeName)){n=s;break}return n},getAttributeNS:function(e,t,i){var n="";if(e.getAttributeNS)n=e.getAttributeNS(t,i)||"";else{var s=this.getAttributeNodeNS(e,t,i);s&&(n=s.nodeValue)}return n},getChildValue:function(e,t){var i=t||"";if(e)for(var n=e.firstChild;n;n=n.nextSibling)switch(n.nodeType){case 3:case 4:i+=n.nodeValue}return i},isSimpleContent:function(e){for(var t=!0,i=e.firstChild;i;i=i.nextSibling)if(1===i.nodeType){t=!1;break}return t},contentType:function(e){for(var t=!1,i=!1,n=OpenLayers.Format.XML.CONTENT_TYPE.EMPTY,s=e.firstChild;s;s=s.nextSibling){switch(s.nodeType){case 1:i=!0;break;case 8:break;default:t=!0}if(i&&t)break}if(i&&t)n=OpenLayers.Format.XML.CONTENT_TYPE.MIXED;else{if(i)return OpenLayers.Format.XML.CONTENT_TYPE.COMPLEX;if(t)return OpenLayers.Format.XML.CONTENT_TYPE.SIMPLE}return n},hasAttributeNS:function(e,t,i){var n=!1;return n=e.hasAttributeNS?e.hasAttributeNS(t,i):!!this.getAttributeNodeNS(e,t,i)},setAttributeNS:function(e,t,i,n){if(e.setAttributeNS)e.setAttributeNS(t,i,n);else{if(!this.xmldom)throw"setAttributeNS not implemented";if(t){var s=e.ownerDocument.createNode(2,i,t);s.nodeValue=n,e.setAttributeNode(s)}else e.setAttribute(i,n)}},createElementNSPlus:function(e,t){t=t||{};var i=t.uri||this.namespaces[t.prefix];if(!i){var n=e.indexOf(":");i=this.namespaces[e.substring(0,n)]}i||(i=this.namespaces[this.defaultPrefix]);var s=this.createElementNS(i,e);t.attributes&&this.setAttributes(s,t.attributes);var a=t.value;return null!=a&&s.appendChild(this.createTextNode(a)),s},setAttributes:function(e,t){var i,n;for(var s in t)null!=t[s]&&t[s].toString&&(i=t[s].toString(),n=this.namespaces[s.substring(0,s.indexOf(":"))]||null,this.setAttributeNS(e,n,s,i))},readNode:function(e,t){t||(t={});var i=this.readers[e.namespaceURI?this.namespaceAlias[e.namespaceURI]:this.defaultPrefix];if(i){var n=e.localName||e.nodeName.split(":").pop(),s=i[n]||i["*"];s&&s.apply(this,[e,t])}return t},readChildNodes:function(e,t){t||(t={});for(var i,n=e.childNodes,s=0,a=n.length;a>s;++s)i=n[s],1==i.nodeType&&this.readNode(i,t);return t},writeNode:function(e,t,i){var n,s,a=e.indexOf(":");a>0?(n=e.substring(0,a),s=e.substring(a+1)):(n=i?this.namespaceAlias[i.namespaceURI]:this.defaultPrefix,s=e);var r=this.writers[n][s].apply(this,[t]);return i&&i.appendChild(r),r},getChildEl:function(e,t,i){return e&&this.getThisOrNextEl(e.firstChild,t,i)},getNextEl:function(e,t,i){return e&&this.getThisOrNextEl(e.nextSibling,t,i)},getThisOrNextEl:function(e,t,i){e:for(var n=e;n;n=n.nextSibling)switch(n.nodeType){case 1:if(!(t&&t!==(n.localName||n.nodeName.split(":").pop())||i&&i!==n.namespaceURI))break e;n=null;break e;case 3:if(/^\s*$/.test(n.nodeValue))break;case 4:case 6:case 12:case 10:case 11:n=null;break e}return n||null},lookupNamespaceURI:function(e,t){var i=null;if(e)if(e.lookupNamespaceURI)i=e.lookupNamespaceURI(t);else e:switch(e.nodeType){case 1:if(null!==e.namespaceURI&&e.prefix===t){i=e.namespaceURI;break e}var n=e.attributes.length;if(n)for(var s,a=0;n>a;++a){if(s=e.attributes[a],"xmlns"===s.prefix&&s.name==="xmlns:"+t){i=s.value||null;break e}if("xmlns"===s.name&&null===t){i=s.value||null;break e}}i=this.lookupNamespaceURI(e.parentNode,t);break e;case 2:i=this.lookupNamespaceURI(e.ownerElement,t);break e;case 9:i=this.lookupNamespaceURI(e.documentElement,t);break e;case 6:case 12:case 10:case 11:break e;default:i=this.lookupNamespaceURI(e.parentNode,t)}return i},getXMLDoc:function(){return OpenLayers.Format.XML.document||this.xmldom||(document.implementation&&document.implementation.createDocument?OpenLayers.Format.XML.document=document.implementation.createDocument("","",null):!this.xmldom&&window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM"))),OpenLayers.Format.XML.document||this.xmldom},CLASS_NAME:"OpenLayers.Format.XML"}),OpenLayers.Format.XML.CONTENT_TYPE={EMPTY:0,SIMPLE:1,COMPLEX:2,MIXED:3},OpenLayers.Format.XML.lookupNamespaceURI=OpenLayers.Function.bind(OpenLayers.Format.XML.prototype.lookupNamespaceURI,OpenLayers.Format.XML.prototype),OpenLayers.Format.XML.document=null,OpenLayers.Format.XML.VersionedOGC=OpenLayers.Class(OpenLayers.Format.XML,{defaultVersion:null,version:null,profile:null,errorProperty:null,name:null,stringifyOutput:!1,parser:null,initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]);var t=this.CLASS_NAME;this.name=t.substring(t.lastIndexOf(".")+1)},getVersion:function(e,t){var i;return e?(i=this.version,i||(i=e.getAttribute("version"),i||(i=this.defaultVersion))):i=t&&t.version||this.version||this.defaultVersion,i},getParser:function(e){e=e||this.defaultVersion;var t=this.profile?"_"+this.profile:"";if(!this.parser||this.parser.VERSION!=e){var i=OpenLayers.Format[this.name]["v"+e.replace(/\./g,"_")+t];if(!i)throw"Can't find a "+this.name+" parser for version "+e+t;this.parser=new i(this.options)}return this.parser},write:function(e,t){var i=this.getVersion(null,t);this.parser=this.getParser(i);var n=this.parser.write(e,t);return this.stringifyOutput===!1?n:OpenLayers.Format.XML.prototype.write.apply(this,[n])},read:function(e,t){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var i=e.documentElement,n=this.getVersion(i);this.parser=this.getParser(n);var s=this.parser.read(e,t);if(null!==this.errorProperty&&void 0===s[this.errorProperty]){var a=new OpenLayers.Format.OGCExceptionReport;s.error=a.read(e)}return s.version=n,s},CLASS_NAME:"OpenLayers.Format.XML.VersionedOGC"}),OpenLayers.Format.GML=OpenLayers.Class(OpenLayers.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var t=this.getElementsByTagNameNS(e.documentElement,this.gmlns,this.featureName),i=[],n=0;n<t.length;n++){var s=this.parseFeature(t[n]);s&&i.push(s)}return i},parseFeature:function(e){for(var t,i,n,s,a=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],r=0;r<a.length;++r)if(t=a[r],i=this.getElementsByTagNameNS(e,this.gmlns,t),i.length>0){if(s=this.parseGeometry[t.toLowerCase()],!s)throw new TypeError("Unsupported geometry type: "+t);n=s.apply(this,[i[0]]),this.internalProjection&&this.externalProjection&&n.transform(this.externalProjection,this.internalProjection);break}var o,l=this.getElementsByTagNameNS(e,this.gmlns,"Box");for(r=0;r<l.length;++r){var u=l[r],c=this.parseGeometry.box.apply(this,[u]),h=u.parentNode,d=h.localName||h.nodeName.split(":").pop();"boundedBy"===d?o=c:n=c.toGeometry()}var p;this.extractAttributes&&(p=this.parseAttributes(e));var f=new OpenLayers.Feature.Vector(n,p);f.bounds=o,f.gml={featureType:e.firstChild.nodeName.split(":")[1],featureNS:e.firstChild.namespaceURI,featureNSPrefix:e.firstChild.prefix};for(var m,g=e.firstChild;g&&(1!=g.nodeType||!(m=g.getAttribute("fid")||g.getAttribute("id")));)g=g.nextSibling;return f.fid=m,f},parseGeometry:{point:function(e){var t,i,n=[],t=this.getElementsByTagNameNS(e,this.gmlns,"pos");if(t.length>0&&(i=t[0].firstChild.nodeValue,i=i.replace(this.regExes.trimSpace,""),n=i.split(this.regExes.splitSpace)),0==n.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),t.length>0&&(i=t[0].firstChild.nodeValue,i=i.replace(this.regExes.removeSpace,""),n=i.split(","))),0==n.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coord"),t.length>0)){var s=this.getElementsByTagNameNS(t[0],this.gmlns,"X"),a=this.getElementsByTagNameNS(t[0],this.gmlns,"Y");s.length>0&&a.length>0&&(n=[s[0].firstChild.nodeValue,a[0].firstChild.nodeValue])}return 2==n.length&&(n[2]=null),this.xy?new OpenLayers.Geometry.Point(n[0],n[1],n[2]):new OpenLayers.Geometry.Point(n[1],n[0],n[2])},multipoint:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Point"),i=[];if(t.length>0)for(var n,s=0;s<t.length;++s)n=this.parseGeometry.point.apply(this,[t[s]]),n&&i.push(n);return new OpenLayers.Geometry.MultiPoint(i)},linestring:function(e,t){var i,n,s=[],a=[];if(i=this.getElementsByTagNameNS(e,this.gmlns,"posList"),i.length>0){n=this.getChildValue(i[0]),n=n.replace(this.regExes.trimSpace,""),s=n.split(this.regExes.splitSpace);for(var r,o,l,u,c=parseInt(i[0].getAttribute("dimension")),h=0;h<s.length/c;++h)r=h*c,o=s[r],l=s[r+1],u=2==c?null:s[r+2],this.xy?a.push(new OpenLayers.Geometry.Point(o,l,u)):a.push(new OpenLayers.Geometry.Point(l,o,u))}if(0==s.length&&(i=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),i.length>0)){n=this.getChildValue(i[0]),n=n.replace(this.regExes.trimSpace,""),n=n.replace(this.regExes.trimComma,",");
for(var d=n.split(this.regExes.splitSpace),h=0;h<d.length;++h)s=d[h].split(","),2==s.length&&(s[2]=null),this.xy?a.push(new OpenLayers.Geometry.Point(s[0],s[1],s[2])):a.push(new OpenLayers.Geometry.Point(s[1],s[0],s[2]))}var p=null;return 0!=a.length&&(p=t?new OpenLayers.Geometry.LinearRing(a):new OpenLayers.Geometry.LineString(a)),p},multilinestring:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LineString"),i=[];if(t.length>0)for(var n,s=0;s<t.length;++s)n=this.parseGeometry.linestring.apply(this,[t[s]]),n&&i.push(n);return new OpenLayers.Geometry.MultiLineString(i)},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LinearRing"),i=[];if(t.length>0)for(var n,s=0;s<t.length;++s)n=this.parseGeometry.linestring.apply(this,[t[s],!0]),n&&i.push(n);return new OpenLayers.Geometry.Polygon(i)},multipolygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Polygon"),i=[];if(t.length>0)for(var n,s=0;s<t.length;++s)n=this.parseGeometry.polygon.apply(this,[t[s]]),n&&i.push(n);return new OpenLayers.Geometry.MultiPolygon(i)},envelope:function(e){var t,i,n=[],s=this.getElementsByTagNameNS(e,this.gmlns,"lowerCorner");if(s.length>0){var a=[];if(s.length>0&&(t=s[0].firstChild.nodeValue,t=t.replace(this.regExes.trimSpace,""),a=t.split(this.regExes.splitSpace)),2==a.length&&(a[2]=null),this.xy)var r=new OpenLayers.Geometry.Point(a[0],a[1],a[2]);else var r=new OpenLayers.Geometry.Point(a[1],a[0],a[2])}var o=this.getElementsByTagNameNS(e,this.gmlns,"upperCorner");if(o.length>0){var a=[];if(o.length>0&&(t=o[0].firstChild.nodeValue,t=t.replace(this.regExes.trimSpace,""),a=t.split(this.regExes.splitSpace)),2==a.length&&(a[2]=null),this.xy)var l=new OpenLayers.Geometry.Point(a[0],a[1],a[2]);else var l=new OpenLayers.Geometry.Point(a[1],a[0],a[2])}if(r&&l){n.push(new OpenLayers.Geometry.Point(r.x,r.y)),n.push(new OpenLayers.Geometry.Point(l.x,r.y)),n.push(new OpenLayers.Geometry.Point(l.x,l.y)),n.push(new OpenLayers.Geometry.Point(r.x,l.y)),n.push(new OpenLayers.Geometry.Point(r.x,r.y));var u=new OpenLayers.Geometry.LinearRing(n);i=new OpenLayers.Geometry.Polygon([u])}return i},box:function(e){var t,i,n=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),s=null,a=null;return n.length>0&&(t=n[0].firstChild.nodeValue,i=t.split(" "),2==i.length&&(s=i[0].split(","),a=i[1].split(","))),null!==s&&null!==a?new OpenLayers.Bounds(parseFloat(s[0]),parseFloat(s[1]),parseFloat(a[0]),parseFloat(a[1])):void 0}},parseAttributes:function(e){for(var t,i,n,s,a,r,o,l={},u=e.firstChild;u;){if(1==u.nodeType){for(t=u.childNodes,i=0;i<t.length;++i)n=t[i],1==n.nodeType&&(s=n.childNodes,1==s.length?(a=s[0],(3==a.nodeType||4==a.nodeType)&&(r=n.prefix?n.nodeName.split(":")[1]:n.nodeName,o=a.nodeValue.replace(this.regExes.trimSpace,""),l[r]=o)):l[n.nodeName.split(":").pop()]=null);break}u=u.nextSibling}return l},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),i=0;i<e.length;i++)t.appendChild(this.createFeatureXML(e[i]));return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureXML:function(e){var t=e.geometry,i=this.buildGeometryNode(t),n=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);n.appendChild(i);var s=this.createElementNS(this.gmlns,"gml:"+this.featureName),a=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName),r=e.fid||e.id;a.setAttribute("fid",r),a.appendChild(n);for(var o in e.attributes){var l=this.createTextNode(e.attributes[o]),u=o.substring(o.lastIndexOf(":")+1),c=this.createElementNS(this.featureNS,this.featurePrefix+":"+u);c.appendChild(l),a.appendChild(c)}return s.appendChild(a),s},buildGeometryNode:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var t=e.CLASS_NAME,i=t.substring(t.lastIndexOf(".")+1),n=this.buildGeometry[i.toLowerCase()];return n.apply(this,[e])},buildGeometry:{point:function(e){var t=this.createElementNS(this.gmlns,"gml:Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiPoint"),s=e.components,a=0;a<s.length;a++)t=this.createElementNS(this.gmlns,"gml:pointMember"),i=this.buildGeometry.point.apply(this,[s[a]]),t.appendChild(i),n.appendChild(t);return n},linestring:function(e){var t=this.createElementNS(this.gmlns,"gml:LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiLineString"),s=e.components,a=0;a<s.length;++a)t=this.createElementNS(this.gmlns,"gml:lineStringMember"),i=this.buildGeometry.linestring.apply(this,[s[a]]),t.appendChild(i),n.appendChild(t);return n},linearring:function(e){var t=this.createElementNS(this.gmlns,"gml:LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){for(var t,i,n,s=this.createElementNS(this.gmlns,"gml:Polygon"),a=e.components,r=0;r<a.length;++r)n=0==r?"outerBoundaryIs":"innerBoundaryIs",t=this.createElementNS(this.gmlns,"gml:"+n),i=this.buildGeometry.linearring.apply(this,[a[r]]),t.appendChild(i),s.appendChild(t);return s},multipolygon:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiPolygon"),s=e.components,a=0;a<s.length;++a)t=this.createElementNS(this.gmlns,"gml:polygonMember"),i=this.buildGeometry.polygon.apply(this,[s[a]]),t.appendChild(i),n.appendChild(t);return n},bounds:function(e){var t=this.createElementNS(this.gmlns,"gml:Box");return t.appendChild(this.buildCoordinatesNode(e)),t}},buildCoordinatesNode:function(e){var t=this.createElementNS(this.gmlns,"gml:coordinates");t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," ");var i=[];if(e instanceof OpenLayers.Bounds)i.push(e.left+","+e.bottom),i.push(e.right+","+e.top);else for(var n=e.components?e.components:[e],s=0;s<n.length;s++)i.push(n[s].x+","+n[s].y);var a=this.createTextNode(i.join(" "));return t.appendChild(a),t},CLASS_NAME:"OpenLayers.Format.GML"}),OpenLayers.Format.GML||(OpenLayers.Format.GML={}),OpenLayers.Format.GML.Base=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},defaultPrefix:"gml",schemaLocation:null,featureType:null,featureNS:null,geometryName:"geometry",extractAttributes:!0,srsName:null,xy:!0,geometryTypes:null,singleFeatureType:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,featureMember:/^(.*:)?featureMembers?$/},initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]),this.setGeometryTypes(),e&&e.featureNS&&this.setNamespace("feature",e.featureNS),this.singleFeatureType=!e||"string"==typeof e.featureType},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var t=[];if(this.readNode(e,{features:t},!0),0==t.length){var i=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMember");if(i.length)for(var n=0,s=i.length;s>n;++n)this.readNode(i[n],{features:t},!0);else{var i=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMembers");i.length&&this.readNode(i[0],{features:t},!0)}}return t},readNode:function(e,t,i){return i===!0&&this.autoConfig===!0&&(this.featureType=null,delete this.namespaceAlias[this.featureNS],delete this.namespaces.feature,this.featureNS=null),this.featureNS||e.prefix in this.namespaces||e.parentNode.namespaceURI!=this.namespaces.gml||!this.regExes.featureMember.test(e.parentNode.nodeName)||(this.featureType=e.nodeName.split(":").pop(),this.setNamespace("feature",e.namespaceURI),this.featureNS=e.namespaceURI,this.autoConfig=!0),OpenLayers.Format.XML.prototype.readNode.apply(this,[e,t])},readers:{gml:{featureMember:function(e,t){this.readChildNodes(e,t)},featureMembers:function(e,t){this.readChildNodes(e,t)},name:function(e,t){t.name=this.getChildValue(e)},boundedBy:function(e,t){var i={};this.readChildNodes(e,i),i.components&&i.components.length>0&&(t.bounds=i.components[0])},Point:function(e,t){var i={points:[]};this.readChildNodes(e,i),t.components||(t.components=[]),t.components.push(i.points[0])},coordinates:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,"");i=i.replace(this.regExes.trimComma,",");for(var n,s=i.split(this.regExes.splitSpace),a=s.length,r=new Array(a),o=0;a>o;++o)n=s[o].split(","),r[o]=this.xy?new OpenLayers.Geometry.Point(n[0],n[1],n[2]):new OpenLayers.Geometry.Point(n[1],n[0],n[2]);t.points=r},coord:function(e,t){var i={};this.readChildNodes(e,i),t.points||(t.points=[]),t.points.push(new OpenLayers.Geometry.Point(i.x,i.y,i.z))},X:function(e,t){t.x=this.getChildValue(e)},Y:function(e,t){t.y=this.getChildValue(e)},Z:function(e,t){t.z=this.getChildValue(e)},MultiPoint:function(e,t){var i={components:[]};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.MultiPoint(i.components)]},pointMember:function(e,t){this.readChildNodes(e,t)},LineString:function(e,t){var i={};this.readChildNodes(e,i),t.components||(t.components=[]),t.components.push(new OpenLayers.Geometry.LineString(i.points))},MultiLineString:function(e,t){var i={components:[]};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.MultiLineString(i.components)]},lineStringMember:function(e,t){this.readChildNodes(e,t)},Polygon:function(e,t){var i={outer:null,inner:[]};this.readChildNodes(e,i),i.inner.unshift(i.outer),t.components||(t.components=[]),t.components.push(new OpenLayers.Geometry.Polygon(i.inner))},LinearRing:function(e,t){var i={};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.LinearRing(i.points)]},MultiPolygon:function(e,t){var i={components:[]};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.MultiPolygon(i.components)]},polygonMember:function(e,t){this.readChildNodes(e,t)},GeometryCollection:function(e,t){var i={components:[]};this.readChildNodes(e,i),t.components=[new OpenLayers.Geometry.Collection(i.components)]},geometryMember:function(e,t){this.readChildNodes(e,t)}},feature:{"*":function(e,t){var i,n=e.localName||e.nodeName.split(":").pop();t.features?this.singleFeatureType||-1===OpenLayers.Util.indexOf(this.featureType,n)?n===this.featureType&&(i="_typeName"):i="_typeName":0==e.childNodes.length||1==e.childNodes.length&&3==e.firstChild.nodeType?this.extractAttributes&&(i="_attribute"):i="_geometry",i&&this.readers.feature[i].apply(this,[e,t])},_typeName:function(e,t){var i={components:[],attributes:{}};this.readChildNodes(e,i),i.name&&(i.attributes.name=i.name);var n=new OpenLayers.Feature.Vector(i.components[0],i.attributes);this.singleFeatureType||(n.type=e.nodeName.split(":").pop(),n.namespace=e.namespaceURI);var s=e.getAttribute("fid")||this.getAttributeNS(e,this.namespaces.gml,"id");s&&(n.fid=s),this.internalProjection&&this.externalProjection&&n.geometry&&n.geometry.transform(this.externalProjection,this.internalProjection),i.bounds&&(n.bounds=i.bounds),t.features.push(n)},_geometry:function(e,t){this.geometryName||(this.geometryName=e.nodeName.split(":").pop()),this.readChildNodes(e,t)},_attribute:function(e,t){var i=e.localName||e.nodeName.split(":").pop(),n=this.getChildValue(e);t.attributes[i]=n}},wfs:{FeatureCollection:function(e,t){this.readChildNodes(e,t)}}},write:function(e){var t;t=OpenLayers.Util.isArray(e)?"featureMembers":"featureMember";var i=this.writeNode("gml:"+t,e);return this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{gml:{featureMember:function(e){var t=this.createElementNSPlus("gml:featureMember");return this.writeNode("feature:_typeName",e,t),t},MultiPoint:function(e){for(var t=this.createElementNSPlus("gml:MultiPoint"),i=e.components||[e],n=0,s=i.length;s>n;++n)this.writeNode("pointMember",i[n],t);return t},pointMember:function(e){var t=this.createElementNSPlus("gml:pointMember");return this.writeNode("Point",e,t),t},MultiLineString:function(e){for(var t=this.createElementNSPlus("gml:MultiLineString"),i=e.components||[e],n=0,s=i.length;s>n;++n)this.writeNode("lineStringMember",i[n],t);return t},lineStringMember:function(e){var t=this.createElementNSPlus("gml:lineStringMember");return this.writeNode("LineString",e,t),t},MultiPolygon:function(e){for(var t=this.createElementNSPlus("gml:MultiPolygon"),i=e.components||[e],n=0,s=i.length;s>n;++n)this.writeNode("polygonMember",i[n],t);return t},polygonMember:function(e){var t=this.createElementNSPlus("gml:polygonMember");return this.writeNode("Polygon",e,t),t},GeometryCollection:function(e){for(var t=this.createElementNSPlus("gml:GeometryCollection"),i=0,n=e.components.length;n>i;++i)this.writeNode("geometryMember",e.components[i],t);return t},geometryMember:function(e){var t=this.createElementNSPlus("gml:geometryMember"),i=this.writeNode("feature:_geometry",e);return t.appendChild(i.firstChild),t}},feature:{_typeName:function(e){var t=this.createElementNSPlus("feature:"+this.featureType,{attributes:{fid:e.fid}});e.geometry&&this.writeNode("feature:_geometry",e.geometry,t);for(var i in e.attributes){var n=e.attributes[i];null!=n&&this.writeNode("feature:_attribute",{name:i,value:n},t)}return t},_geometry:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone().transform(this.internalProjection,this.externalProjection));var t=this.createElementNSPlus("feature:"+this.geometryName),i=this.geometryTypes[e.CLASS_NAME],n=this.writeNode("gml:"+i,e,t);return this.srsName&&n.setAttribute("srsName",this.srsName),t},_attribute:function(e){return this.createElementNSPlus("feature:"+e.name,{value:e.value})}},wfs:{FeatureCollection:function(e){for(var t=this.createElementNSPlus("wfs:FeatureCollection"),i=0,n=e.length;n>i;++i)this.writeNode("gml:featureMember",e[i],t);return t}}},setGeometryTypes:function(){this.geometryTypes={"OpenLayers.Geometry.Point":"Point","OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":"LineString","OpenLayers.Geometry.MultiLineString":"MultiLineString","OpenLayers.Geometry.Polygon":"Polygon","OpenLayers.Geometry.MultiPolygon":"MultiPolygon","OpenLayers.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"OpenLayers.Format.GML.Base"}),OpenLayers.Format.GML.v3=OpenLayers.Class(OpenLayers.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",curve:!1,multiCurve:!0,surface:!1,multiSurface:!0,initialize:function(e){OpenLayers.Format.GML.Base.prototype.initialize.apply(this,[e])},readers:{gml:OpenLayers.Util.applyDefaults({featureMembers:function(e,t){this.readChildNodes(e,t)},Curve:function(e,t){var i={points:[]};this.readChildNodes(e,i),t.components||(t.components=[]),t.components.push(new OpenLayers.Geometry.LineString(i.points))},segments:function(e,t){this.readChildNodes(e,t)},LineStringSegment:function(e,t){var i={};this.readChildNodes(e,i),i.points&&Array.prototype.push.apply(t.points,i.points)},pos:function(e,t){var i,n=this.getChildValue(e).replace(this.regExes.trimSpace,""),s=n.split(this.regExes.splitSpace);i=this.xy?new OpenLayers.Geometry.Point(s[0],s[1],s[2]):new OpenLayers.Geometry.Point(s[1],s[0],s[2]),t.points=[i]},posList:function(e,t){for(var i,n,s,a=this.getChildValue(e).replace(this.regExes.trimSpace,""),r=a.split(this.regExes.splitSpace),o=parseInt(e.getAttribute("dimension"))||2,l=r.length/o,u=new Array(l),c=0,h=r.length;h>c;c+=o)i=r[c],n=r[c+1],s=2==o?void 0:r[c+2],u[c/o]=this.xy?new OpenLayers.Geometry.Point(i,n,s):new OpenLayers.Geometry.Point(n,i,s);t.points=u},Surface:function(e,t){this.readChildNodes(e,t)},patches:function(e,t){this.readChildNodes(e,t)},PolygonPatch:function(e,t){this.readers.gml.Polygon.apply(this,[e,t])},exterior:function(e,t){var i={};this.readChildNodes(e,i),t.outer=i.components[0]},interior:function(e,t){var i={};this.readChildNodes(e,i),t.inner.push(i.components[0])},MultiCurve:function(e,t){var i={components:[]};this.readChildNodes(e,i),i.components.length>0&&(t.components=[new OpenLayers.Geometry.MultiLineString(i.components)])},curveMember:function(e,t){this.readChildNodes(e,t)},MultiSurface:function(e,t){var i={components:[]};this.readChildNodes(e,i),i.components.length>0&&(t.components=[new OpenLayers.Geometry.MultiPolygon(i.components)])},surfaceMember:function(e,t){this.readChildNodes(e,t)},surfaceMembers:function(e,t){this.readChildNodes(e,t)},pointMembers:function(e,t){this.readChildNodes(e,t)},lineStringMembers:function(e,t){this.readChildNodes(e,t)},polygonMembers:function(e,t){this.readChildNodes(e,t)},geometryMembers:function(e,t){this.readChildNodes(e,t)},Envelope:function(e,t){var i={points:new Array(2)};this.readChildNodes(e,i),t.components||(t.components=[]);var n=i.points[0],s=i.points[1];t.components.push(new OpenLayers.Bounds(n.x,n.y,s.x,s.y))},lowerCorner:function(e,t){var i={};this.readers.gml.pos.apply(this,[e,i]),t.points[0]=i.points[0]},upperCorner:function(e,t){var i={};this.readers.gml.pos.apply(this,[e,i]),t.points[1]=i.points[0]}},OpenLayers.Format.GML.Base.prototype.readers.gml),feature:OpenLayers.Format.GML.Base.prototype.readers.feature,wfs:OpenLayers.Format.GML.Base.prototype.readers.wfs},write:function(e){var t;t=OpenLayers.Util.isArray(e)?"featureMembers":"featureMember";var i=this.writeNode("gml:"+t,e);return this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{gml:OpenLayers.Util.applyDefaults({featureMembers:function(e){for(var t=this.createElementNSPlus("gml:featureMembers"),i=0,n=e.length;n>i;++i)this.writeNode("feature:_typeName",e[i],t);return t},Point:function(e){var t=this.createElementNSPlus("gml:Point");return this.writeNode("pos",e,t),t},pos:function(e){var t=this.xy?e.x+" "+e.y:e.y+" "+e.x;return this.createElementNSPlus("gml:pos",{value:t})},LineString:function(e){var t=this.createElementNSPlus("gml:LineString");return this.writeNode("posList",e.components,t),t},Curve:function(e){var t=this.createElementNSPlus("gml:Curve");return this.writeNode("segments",e,t),t},segments:function(e){var t=this.createElementNSPlus("gml:segments");return this.writeNode("LineStringSegment",e,t),t},LineStringSegment:function(e){var t=this.createElementNSPlus("gml:LineStringSegment");return this.writeNode("posList",e.components,t),t},posList:function(e){for(var t,i=e.length,n=new Array(i),s=0;i>s;++s)t=e[s],n[s]=this.xy?t.x+" "+t.y:t.y+" "+t.x;return this.createElementNSPlus("gml:posList",{value:n.join(" ")})},Surface:function(e){var t=this.createElementNSPlus("gml:Surface");return this.writeNode("patches",e,t),t},patches:function(e){var t=this.createElementNSPlus("gml:patches");return this.writeNode("PolygonPatch",e,t),t},PolygonPatch:function(e){var t=this.createElementNSPlus("gml:PolygonPatch",{attributes:{interpolation:"planar"}});this.writeNode("exterior",e.components[0],t);for(var i=1,n=e.components.length;n>i;++i)this.writeNode("interior",e.components[i],t);return t},Polygon:function(e){var t=this.createElementNSPlus("gml:Polygon");this.writeNode("exterior",e.components[0],t);for(var i=1,n=e.components.length;n>i;++i)this.writeNode("interior",e.components[i],t);return t},exterior:function(e){var t=this.createElementNSPlus("gml:exterior");return this.writeNode("LinearRing",e,t),t},interior:function(e){var t=this.createElementNSPlus("gml:interior");return this.writeNode("LinearRing",e,t),t},LinearRing:function(e){var t=this.createElementNSPlus("gml:LinearRing");return this.writeNode("posList",e.components,t),t},MultiCurve:function(e){for(var t=this.createElementNSPlus("gml:MultiCurve"),i=e.components||[e],n=0,s=i.length;s>n;++n)this.writeNode("curveMember",i[n],t);return t},curveMember:function(e){var t=this.createElementNSPlus("gml:curveMember");return this.curve?this.writeNode("Curve",e,t):this.writeNode("LineString",e,t),t},MultiSurface:function(e){for(var t=this.createElementNSPlus("gml:MultiSurface"),i=e.components||[e],n=0,s=i.length;s>n;++n)this.writeNode("surfaceMember",i[n],t);return t},surfaceMember:function(e){var t=this.createElementNSPlus("gml:surfaceMember");return this.surface?this.writeNode("Surface",e,t):this.writeNode("Polygon",e,t),t},Envelope:function(e){var t=this.createElementNSPlus("gml:Envelope");return this.writeNode("lowerCorner",e,t),this.writeNode("upperCorner",e,t),this.srsName&&t.setAttribute("srsName",this.srsName),t},lowerCorner:function(e){var t=this.xy?e.left+" "+e.bottom:e.bottom+" "+e.left;return this.createElementNSPlus("gml:lowerCorner",{value:t})},upperCorner:function(e){var t=this.xy?e.right+" "+e.top:e.top+" "+e.right;return this.createElementNSPlus("gml:upperCorner",{value:t})}},OpenLayers.Format.GML.Base.prototype.writers.gml),feature:OpenLayers.Format.GML.Base.prototype.writers.feature,wfs:OpenLayers.Format.GML.Base.prototype.writers.wfs},setGeometryTypes:function(){this.geometryTypes={"OpenLayers.Geometry.Point":"Point","OpenLayers.Geometry.MultiPoint":"MultiPoint","OpenLayers.Geometry.LineString":this.curve===!0?"Curve":"LineString","OpenLayers.Geometry.MultiLineString":this.multiCurve===!1?"MultiLineString":"MultiCurve","OpenLayers.Geometry.Polygon":this.surface===!0?"Surface":"Polygon","OpenLayers.Geometry.MultiPolygon":this.multiSurface===!1?"MultiPolygon":"MultiSurface","OpenLayers.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"OpenLayers.Format.GML.v3"}),OpenLayers.Format.SLD=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{profile:null,defaultVersion:"1.0.0",stringifyOutput:!0,namedLayersAsArray:!1,CLASS_NAME:"OpenLayers.Format.SLD"}),OpenLayers.Format.JSON=OpenLayers.Class(OpenLayers.Format,{indent:"    ",space:" ",newline:"\n",level:0,pretty:!1,nativeJSON:function(){return!(!window.JSON||"function"!=typeof JSON.parse||"function"!=typeof JSON.stringify)}(),read:function(json,filter){function walk(e,t){if(t&&"object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&(t[i]=walk(i,t[i]));return filter(e,t)}var object;if(this.nativeJSON)object=JSON.parse(json,filter);else try{/^[\],:{}\s]*$/.test(json.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))&&(object=eval("("+json+")"),"function"==typeof filter&&(object=walk("",object)))}catch(e){}return this.keepData&&(this.data=object),object},write:function(e,t){this.pretty=!!t;var i=null,n=typeof e;if(this.serialize[n])try{i=!this.pretty&&this.nativeJSON?JSON.stringify(e):this.serialize[n].apply(this,[e])}catch(s){OpenLayers.Console.error("Trouble serializing: "+s)}return i},writeIndent:function(){var e=[];if(this.pretty)for(var t=0;t<this.level;++t)e.push(this.indent);return e.join("")},writeNewline:function(){return this.pretty?this.newline:""},writeSpace:function(){return this.pretty?this.space:""},serialize:{object:function(e){if(null==e)return"null";if(e.constructor==Date)return this.serialize.date.apply(this,[e]);if(e.constructor==Array)return this.serialize.array.apply(this,[e]);var t=["{"];this.level+=1;var i,n,s,a=!1;for(i in e)e.hasOwnProperty(i)&&(n=OpenLayers.Format.JSON.prototype.write.apply(this,[i,this.pretty]),s=OpenLayers.Format.JSON.prototype.write.apply(this,[e[i],this.pretty]),null!=n&&null!=s&&(a&&t.push(","),t.push(this.writeNewline(),this.writeIndent(),n,":",this.writeSpace(),s),a=!0));return this.level-=1,t.push(this.writeNewline(),this.writeIndent(),"}"),t.join("")},array:function(e){var t,i=["["];this.level+=1;for(var n=0,s=e.length;s>n;++n)t=OpenLayers.Format.JSON.prototype.write.apply(this,[e[n],this.pretty]),null!=t&&(n>0&&i.push(","),i.push(this.writeNewline(),this.writeIndent(),t));return this.level-=1,i.push(this.writeNewline(),this.writeIndent(),"]"),i.join("")},string:function(e){var t={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return/["\\\x00-\x1f]/.test(e)?'"'+e.replace(/([\x00-\x1f\\"])/g,function(e,i){var n=t[i];return n?n:(n=i.charCodeAt(),"\\u00"+Math.floor(n/16).toString(16)+(n%16).toString(16))})+'"':'"'+e+'"'},number:function(e){return isFinite(e)?String(e):"null"},"boolean":function(e){return String(e)},date:function(e){function t(e){return 10>e?"0"+e:e}return'"'+e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+"T"+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+'"'}},CLASS_NAME:"OpenLayers.Format.JSON"}),OpenLayers.Format.GeoJSON=OpenLayers.Class(OpenLayers.Format.JSON,{ignoreExtraDims:!1,read:function(e,t,i){t=t?t:"FeatureCollection";var n=null,s=null;if(s="string"==typeof e?OpenLayers.Format.JSON.prototype.read.apply(this,[e,i]):e){if("string"!=typeof s.type)OpenLayers.Console.error("Bad GeoJSON - no type: "+e);else if(this.isValidType(s,t))switch(t){case"Geometry":try{n=this.parseGeometry(s)}catch(a){OpenLayers.Console.error(a)}break;case"Feature":try{n=this.parseFeature(s),n.type="Feature"}catch(a){OpenLayers.Console.error(a)}break;case"FeatureCollection":switch(n=[],s.type){case"Feature":try{n.push(this.parseFeature(s))}catch(a){n=null,OpenLayers.Console.error(a)}break;case"FeatureCollection":for(var r=0,o=s.features.length;o>r;++r)try{n.push(this.parseFeature(s.features[r]))}catch(a){n=null,OpenLayers.Console.error(a)}break;default:try{var l=this.parseGeometry(s);n.push(new OpenLayers.Feature.Vector(l))}catch(a){n=null,OpenLayers.Console.error(a)}}}}else OpenLayers.Console.error("Bad JSON: "+e);return n},isValidType:function(e,t){var i=!1;switch(t){case"Geometry":-1==OpenLayers.Util.indexOf(["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","Box","GeometryCollection"],e.type)?OpenLayers.Console.error("Unsupported geometry type: "+e.type):i=!0;break;case"FeatureCollection":i=!0;break;default:e.type==t?i=!0:OpenLayers.Console.error("Cannot convert types from "+e.type+" to "+t)}return i},parseFeature:function(e){var t,i,n,s;n=e.properties?e.properties:{},s=e.geometry&&e.geometry.bbox||e.bbox;try{i=this.parseGeometry(e.geometry)}catch(a){throw a}return t=new OpenLayers.Feature.Vector(i,n),s&&(t.bounds=OpenLayers.Bounds.fromArray(s)),e.id&&(t.fid=e.id),t},parseGeometry:function(e){if(null==e)return null;var t,i=!1;if("GeometryCollection"==e.type){if(!OpenLayers.Util.isArray(e.geometries))throw"GeometryCollection must have geometries array: "+e;for(var n=e.geometries.length,s=new Array(n),a=0;n>a;++a)s[a]=this.parseGeometry.apply(this,[e.geometries[a]]);t=new OpenLayers.Geometry.Collection(s),i=!0}else{if(!OpenLayers.Util.isArray(e.coordinates))throw"Geometry must have coordinates array: "+e;if(!this.parseCoords[e.type.toLowerCase()])throw"Unsupported geometry type: "+e.type;try{t=this.parseCoords[e.type.toLowerCase()].apply(this,[e.coordinates])}catch(r){throw r}}return this.internalProjection&&this.externalProjection&&!i&&t.transform(this.externalProjection,this.internalProjection),t},parseCoords:{point:function(e){if(0==this.ignoreExtraDims&&2!=e.length)throw"Only 2D points are supported: "+e;return new OpenLayers.Geometry.Point(e[0],e[1])},multipoint:function(e){for(var t=[],i=null,n=0,s=e.length;s>n;++n){try{i=this.parseCoords.point.apply(this,[e[n]])}catch(a){throw a}t.push(i)}return new OpenLayers.Geometry.MultiPoint(t)},linestring:function(e){for(var t=[],i=null,n=0,s=e.length;s>n;++n){try{i=this.parseCoords.point.apply(this,[e[n]])}catch(a){throw a}t.push(i)}return new OpenLayers.Geometry.LineString(t)},multilinestring:function(e){for(var t=[],i=null,n=0,s=e.length;s>n;++n){try{i=this.parseCoords.linestring.apply(this,[e[n]])}catch(a){throw a}t.push(i)}return new OpenLayers.Geometry.MultiLineString(t)},polygon:function(e){for(var t,i,n=[],s=0,a=e.length;a>s;++s){try{i=this.parseCoords.linestring.apply(this,[e[s]])}catch(r){throw r}t=new OpenLayers.Geometry.LinearRing(i.components),n.push(t)}return new OpenLayers.Geometry.Polygon(n)},multipolygon:function(e){for(var t=[],i=null,n=0,s=e.length;s>n;++n){try{i=this.parseCoords.polygon.apply(this,[e[n]])}catch(a){throw a}t.push(i)}return new OpenLayers.Geometry.MultiPolygon(t)},box:function(e){if(2!=e.length)throw"GeoJSON box coordinates must have 2 elements";return new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(e[0][0],e[0][1]),new OpenLayers.Geometry.Point(e[1][0],e[0][1]),new OpenLayers.Geometry.Point(e[1][0],e[1][1]),new OpenLayers.Geometry.Point(e[0][0],e[1][1]),new OpenLayers.Geometry.Point(e[0][0],e[0][1])])])}},write:function(e,t){var i={type:null};if(OpenLayers.Util.isArray(e)){i.type="FeatureCollection";var n=e.length;i.features=new Array(n);for(var s=0;n>s;++s){var a=e[s];if(!a instanceof OpenLayers.Feature.Vector){var r="FeatureCollection only supports collections of features: "+a;throw r}i.features[s]=this.extract.feature.apply(this,[a])}}else 0==e.CLASS_NAME.indexOf("OpenLayers.Geometry")?i=this.extract.geometry.apply(this,[e]):e instanceof OpenLayers.Feature.Vector&&(i=this.extract.feature.apply(this,[e]),e.layer&&e.layer.projection&&(i.crs=this.createCRSObject(e)));return OpenLayers.Format.JSON.prototype.write.apply(this,[i,t])},createCRSObject:function(e){var t=e.layer.projection.toString(),i={};if(t.match(/epsg:/i)){var n=parseInt(t.substring(t.indexOf(":")+1));i=4326==n?{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}}:{type:"name",properties:{name:"EPSG:"+n}}}return i},extract:{feature:function(e){var t=this.extract.geometry.apply(this,[e.geometry]),i={type:"Feature",properties:e.attributes,geometry:t};return null!=e.fid&&(i.id=e.fid),i},geometry:function(e){if(null==e)return null;this.internalProjection&&this.externalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var t,i=e.CLASS_NAME.split(".")[2],n=this.extract[i.toLowerCase()].apply(this,[e]);return t="Collection"==i?{type:"GeometryCollection",geometries:n}:{type:i,coordinates:n}},point:function(e){return[e.x,e.y]},multipoint:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push(this.extract.point.apply(this,[e.components[i]]));return t},linestring:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push(this.extract.point.apply(this,[e.components[i]]));return t},multilinestring:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push(this.extract.linestring.apply(this,[e.components[i]]));return t},polygon:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push(this.extract.linestring.apply(this,[e.components[i]]));return t},multipolygon:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push(this.extract.polygon.apply(this,[e.components[i]]));return t},collection:function(e){for(var t=e.components.length,i=new Array(t),n=0;t>n;++n)i[n]=this.extract.geometry.apply(this,[e.components[n]]);return i}},CLASS_NAME:"OpenLayers.Format.GeoJSON"}),OpenLayers.Format.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Format.XML,{layerIdentifier:"_layer",featureIdentifier:"_feature",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},gmlFormat:null,read:function(e){var t;"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var i=e.documentElement;if(i){var n=this["read_"+i.nodeName];t=n?n.call(this,i):new OpenLayers.Format.GML(this.options?this.options:{}).read(e)}else t=e;return t},read_msGMLOutput:function(e){var t=[],i=this.getSiblingNodesByTagCriteria(e,this.layerIdentifier);if(i)for(var n=0,s=i.length;s>n;++n){var a=i[n],r=a.nodeName;a.prefix&&(r=r.split(":")[1]);var r=r.replace(this.layerIdentifier,""),o=this.getSiblingNodesByTagCriteria(a,this.featureIdentifier);if(o)for(var l=0;l<o.length;l++){var u=o[l],c=this.parseGeometry(u),h=this.parseAttributes(u),d=new OpenLayers.Feature.Vector(c.geometry,h,null);d.bounds=c.bounds,d.type=r,t.push(d)}}return t},read_FeatureInfoResponse:function(e){for(var t=[],i=this.getElementsByTagNameNS(e,"*","FIELDS"),n=0,s=i.length;s>n;n++){var a,r=i[n],o=null,l={},u=r.attributes.length;
if(u>0)for(a=0;u>a;a++){var c=r.attributes[a];l[c.nodeName]=c.nodeValue}else{var h=r.childNodes;for(a=0,u=h.length;u>a;++a){var d=h[a];3!=d.nodeType&&(l[d.getAttribute("name")]=d.getAttribute("value"))}}t.push(new OpenLayers.Feature.Vector(o,l,null))}return t},getSiblingNodesByTagCriteria:function(e,t){var i,n,s,a,r,o=[];if(e&&e.hasChildNodes()){i=e.childNodes,s=i.length;for(var l=0;s>l;l++){for(r=i[l];r&&1!=r.nodeType;)r=r.nextSibling,l++;n=r?r.nodeName:"",n.length>0&&n.indexOf(t)>-1?o.push(r):(a=this.getSiblingNodesByTagCriteria(r,t),a.length>0&&(0==o.length?o=a:o.push(a)))}}return o},parseAttributes:function(e){var t={};if(1==e.nodeType)for(var i=e.childNodes,n=i.length,s=0;n>s;++s){var a=i[s];if(1==a.nodeType){var r=a.childNodes,o=a.prefix?a.nodeName.split(":")[1]:a.nodeName;if(0==r.length)t[o]=null;else if(1==r.length){var l=r[0];if(3==l.nodeType||4==l.nodeType){var u=l.nodeValue.replace(this.regExes.trimSpace,"");t[o]=u}}}}return t},parseGeometry:function(e){this.gmlFormat||(this.gmlFormat=new OpenLayers.Format.GML);var t,i=this.gmlFormat.parseFeature(e),n=null;return i&&(t=i.geometry&&i.geometry.clone(),n=i.bounds&&i.bounds.clone(),i.destroy()),{geometry:t,bounds:n}},CLASS_NAME:"OpenLayers.Format.WMSGetFeatureInfo"}),OpenLayers.Format.OWSCommon=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",getVersion:function(e){var t=this.version;if(!t){var i=e.getAttribute("xmlns:ows");i&&"1.1"===i.substring(i.lastIndexOf("/")+1)&&(t="1.1.0"),t||(t=this.defaultVersion)}return t},CLASS_NAME:"OpenLayers.Format.OWSCommon"}),OpenLayers.Format.OWSCommon.v1=OpenLayers.Class(OpenLayers.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},read:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i={};return this.readChildNodes(e,i),i},readers:{ows:{Exception:function(e,t){var i={code:e.getAttribute("exceptionCode"),locator:e.getAttribute("locator"),texts:[]};t.exceptions.push(i),this.readChildNodes(e,i)},ExceptionText:function(e,t){var i=this.getChildValue(e);t.texts.push(i)},ServiceIdentification:function(e,t){t.serviceIdentification={},this.readChildNodes(e,t.serviceIdentification)},Title:function(e,t){t.title=this.getChildValue(e)},Abstract:function(e,t){t["abstract"]=this.getChildValue(e)},Keywords:function(e,t){t.keywords={},this.readChildNodes(e,t.keywords)},Keyword:function(e,t){t[this.getChildValue(e)]=!0},ServiceType:function(e,t){t.serviceType={codeSpace:e.getAttribute("codeSpace"),value:this.getChildValue(e)}},ServiceTypeVersion:function(e,t){t.serviceTypeVersion=this.getChildValue(e)},Fees:function(e,t){t.fees=this.getChildValue(e)},AccessConstraints:function(e,t){t.accessConstraints=this.getChildValue(e)},ServiceProvider:function(e,t){t.serviceProvider={},this.readChildNodes(e,t.serviceProvider)},ProviderName:function(e,t){t.providerName=this.getChildValue(e)},ProviderSite:function(e,t){t.providerSite=this.getAttributeNS(e,this.namespaces.xlink,"href")},ServiceContact:function(e,t){t.serviceContact={},this.readChildNodes(e,t.serviceContact)},IndividualName:function(e,t){t.individualName=this.getChildValue(e)},PositionName:function(e,t){t.positionName=this.getChildValue(e)},ContactInfo:function(e,t){t.contactInfo={},this.readChildNodes(e,t.contactInfo)},Phone:function(e,t){t.phone={},this.readChildNodes(e,t.phone)},Voice:function(e,t){t.voice=this.getChildValue(e)},Address:function(e,t){t.address={},this.readChildNodes(e,t.address)},DeliveryPoint:function(e,t){t.deliveryPoint=this.getChildValue(e)},City:function(e,t){t.city=this.getChildValue(e)},AdministrativeArea:function(e,t){t.administrativeArea=this.getChildValue(e)},PostalCode:function(e,t){t.postalCode=this.getChildValue(e)},Country:function(e,t){t.country=this.getChildValue(e)},ElectronicMailAddress:function(e,t){t.electronicMailAddress=this.getChildValue(e)},Role:function(e,t){t.role=this.getChildValue(e)},OperationsMetadata:function(e,t){t.operationsMetadata={},this.readChildNodes(e,t.operationsMetadata)},Operation:function(e,t){var i=e.getAttribute("name");t[i]={},this.readChildNodes(e,t[i])},DCP:function(e,t){t.dcp={},this.readChildNodes(e,t.dcp)},HTTP:function(e,t){t.http={},this.readChildNodes(e,t.http)},Get:function(e,t){t.get||(t.get=[]);var i={url:this.getAttributeNS(e,this.namespaces.xlink,"href")};this.readChildNodes(e,i),t.get.push(i)},Post:function(e,t){t.post||(t.post=[]);var i={url:this.getAttributeNS(e,this.namespaces.xlink,"href")};this.readChildNodes(e,i),t.post.push(i)},Parameter:function(e,t){t.parameters||(t.parameters={});var i=e.getAttribute("name");t.parameters[i]={},this.readChildNodes(e,t.parameters[i])},Constraint:function(e,t){t.constraints||(t.constraints={});var i=e.getAttribute("name");t.constraints[i]={},this.readChildNodes(e,t.constraints[i])},Value:function(e,t){t[this.getChildValue(e)]=!0},OutputFormat:function(e,t){t.formats.push({value:this.getChildValue(e)}),this.readChildNodes(e,t)},WGS84BoundingBox:function(e,t){var i={};i.crs=e.getAttribute("crs"),t.BoundingBox?t.BoundingBox.push(i):(t.projection=i.crs,i=t),this.readChildNodes(e,i)},BoundingBox:function(e,t){this.readers.ows.WGS84BoundingBox.apply(this,[e,t])},LowerCorner:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,"");i=i.replace(this.regExes.trimComma,",");var n=i.split(this.regExes.splitSpace);t.left=n[0],t.bottom=n[1]},UpperCorner:function(e,t){var i=this.getChildValue(e).replace(this.regExes.trimSpace,"");i=i.replace(this.regExes.trimComma,",");var n=i.split(this.regExes.splitSpace);t.right=n[0],t.top=n[1],t.bounds=new OpenLayers.Bounds(t.left,t.bottom,t.right,t.top),delete t.left,delete t.bottom,delete t.right,delete t.top},Language:function(e,t){t.language=this.getChildValue(e)}}},writers:{ows:{BoundingBox:function(e){var t=this.createElementNSPlus("ows:BoundingBox",{attributes:{crs:e.projection}});return this.writeNode("ows:LowerCorner",e,t),this.writeNode("ows:UpperCorner",e,t),t},LowerCorner:function(e){var t=this.createElementNSPlus("ows:LowerCorner",{value:e.bounds.left+" "+e.bounds.bottom});return t},UpperCorner:function(e){var t=this.createElementNSPlus("ows:UpperCorner",{value:e.bounds.right+" "+e.bounds.top});return t},Identifier:function(e){var t=this.createElementNSPlus("ows:Identifier",{value:e});return t},Title:function(e){var t=this.createElementNSPlus("ows:Title",{value:e});return t},Abstract:function(e){var t=this.createElementNSPlus("ows:Abstract",{value:e});return t},OutputFormat:function(e){var t=this.createElementNSPlus("ows:OutputFormat",{value:e});return t}}},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1"}),OpenLayers.Format.OWSCommon.v1_0_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:OpenLayers.Util.applyDefaults({ExceptionReport:function(e,t){t.success=!1,t.exceptionReport={version:e.getAttribute("version"),language:e.getAttribute("language"),exceptions:[]},this.readChildNodes(e,t.exceptionReport)}},OpenLayers.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:OpenLayers.Format.OWSCommon.v1.prototype.writers.ows},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1_0_0"}),OpenLayers.Format.OWSCommon.v1_1_0=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows/1.1",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:OpenLayers.Util.applyDefaults({ExceptionReport:function(e,t){t.exceptionReport={version:e.getAttribute("version"),language:e.getAttribute("xml:lang"),exceptions:[]},this.readChildNodes(e,t.exceptionReport)},AllowedValues:function(e,t){t.allowedValues={},this.readChildNodes(e,t.allowedValues)},AnyValue:function(e,t){t.anyValue=!0},DataType:function(e,t){t.dataType=this.getChildValue(e)},Range:function(e,t){t.range={},this.readChildNodes(e,t.range)},MinimumValue:function(e,t){t.minValue=this.getChildValue(e)},MaximumValue:function(e,t){t.maxValue=this.getChildValue(e)},Identifier:function(e,t){t.identifier=this.getChildValue(e)},SupportedCRS:function(e,t){t.supportedCRS=this.getChildValue(e)}},OpenLayers.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:OpenLayers.Util.applyDefaults({Range:function(e){var t=this.createElementNSPlus("ows:Range",{attributes:{"ows:rangeClosure":e.closure}});return this.writeNode("ows:MinimumValue",e.minValue,t),this.writeNode("ows:MaximumValue",e.maxValue,t),t},MinimumValue:function(e){var t=this.createElementNSPlus("ows:MinimumValue",{value:e});return t},MaximumValue:function(e){var t=this.createElementNSPlus("ows:MaximumValue",{value:e});return t},Value:function(e){var t=this.createElementNSPlus("ows:Value",{value:e});return t}},OpenLayers.Format.OWSCommon.v1.prototype.writers.ows)},CLASS_NAME:"OpenLayers.Format.OWSCommon.v1_1_0"}),OpenLayers.Format.WMTSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(e,t){var i,n={layer:!0,matrixSet:!0};for(var s in n)if(!(s in t))throw new Error("Missing property '"+s+"' in layer configuration.");var a=e.contents,r=a.tileMatrixSets[t.matrixSet];a.layers;for(var o,l=0,u=a.layers.length;u>l;++l)if(a.layers[l].identifier===t.layer){o=a.layers[l];break}if(o&&r){for(var c,l=0,u=o.styles.length;u>l&&(c=o.styles[l],!c.isDefault);++l);i=new OpenLayers.Layer.WMTS(OpenLayers.Util.applyDefaults(t,{url:"REST"===t.requestEncoding&&o.resourceUrl?o.resourceUrl.tile.template:e.operationsMetadata.GetTile.dcp.http.get[0].url,name:o.title,style:c.identifier,matrixIds:r.matrixIds,tileFullExtent:r.bounds}))}return i},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities"}),OpenLayers.Format.WKT=OpenLayers.Class(OpenLayers.Format,{initialize:function(e){this.regExes={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/},OpenLayers.Format.prototype.initialize.apply(this,[e])},read:function(e){var t,i,n;e=e.replace(/[\n\r]/g," ");var s=this.regExes.typeStr.exec(e);if(s&&(i=s[1].toLowerCase(),n=s[2],this.parse[i]&&(t=this.parse[i].apply(this,[n])),this.internalProjection&&this.externalProjection))if(t&&"OpenLayers.Feature.Vector"==t.CLASS_NAME)t.geometry.transform(this.externalProjection,this.internalProjection);else if(t&&"geometrycollection"!=i&&"object"==typeof t)for(var a=0,r=t.length;r>a;a++){var o=t[a];o.geometry.transform(this.externalProjection,this.internalProjection)}return t},write:function(e){var t,i,n;e.constructor==Array?(t=e,n=!0):(t=[e],n=!1);var s=[];n&&s.push("GEOMETRYCOLLECTION(");for(var a=0,r=t.length;r>a;++a)n&&a>0&&s.push(","),i=t[a].geometry,s.push(this.extractGeometry(i));return n&&s.push(")"),s.join("")},extractGeometry:function(e){var t=e.CLASS_NAME.split(".")[2].toLowerCase();if(!this.extract[t])return null;this.internalProjection&&this.externalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var i="collection"==t?"GEOMETRYCOLLECTION":t.toUpperCase(),n=i+"("+this.extract[t].apply(this,[e])+")";return n},extract:{point:function(e){return e.x+" "+e.y},multipoint:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push("("+this.extract.point.apply(this,[e.components[i]])+")");return t.join(",")},linestring:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push(this.extract.point.apply(this,[e.components[i]]));return t.join(",")},multilinestring:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push("("+this.extract.linestring.apply(this,[e.components[i]])+")");return t.join(",")},polygon:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push("("+this.extract.linestring.apply(this,[e.components[i]])+")");return t.join(",")},multipolygon:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push("("+this.extract.polygon.apply(this,[e.components[i]])+")");return t.join(",")},collection:function(e){for(var t=[],i=0,n=e.components.length;n>i;++i)t.push(this.extractGeometry.apply(this,[e.components[i]]));return t.join(",")}},parse:{point:function(e){var t=OpenLayers.String.trim(e).split(this.regExes.spaces);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(t[0],t[1]))},multipoint:function(e){for(var t,i=OpenLayers.String.trim(e).split(","),n=[],s=0,a=i.length;a>s;++s)t=i[s].replace(this.regExes.trimParens,"$1"),n.push(this.parse.point.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPoint(n))},linestring:function(e){for(var t=OpenLayers.String.trim(e).split(","),i=[],n=0,s=t.length;s>n;++n)i.push(this.parse.point.apply(this,[t[n]]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(i))},multilinestring:function(e){for(var t,i=OpenLayers.String.trim(e).split(this.regExes.parenComma),n=[],s=0,a=i.length;a>s;++s)t=i[s].replace(this.regExes.trimParens,"$1"),n.push(this.parse.linestring.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiLineString(n))},polygon:function(e){for(var t,i,n,s=OpenLayers.String.trim(e).split(this.regExes.parenComma),a=[],r=0,o=s.length;o>r;++r)t=s[r].replace(this.regExes.trimParens,"$1"),i=this.parse.linestring.apply(this,[t]).geometry,n=new OpenLayers.Geometry.LinearRing(i.components),a.push(n);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon(a))},multipolygon:function(e){for(var t,i=OpenLayers.String.trim(e).split(this.regExes.doubleParenComma),n=[],s=0,a=i.length;a>s;++s)t=i[s].replace(this.regExes.trimParens,"$1"),n.push(this.parse.polygon.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon(n))},geometrycollection:function(e){e=e.replace(/,\s*([A-Za-z])/g,"|$1");for(var t=OpenLayers.String.trim(e).split("|"),i=[],n=0,s=t.length;s>n;++n)i.push(OpenLayers.Format.WKT.prototype.read.apply(this,[t[n]]));return i}},CLASS_NAME:"OpenLayers.Format.WKT"}),OpenLayers.Format.Filter=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"OpenLayers.Format.Filter"}),OpenLayers.Format.Filter.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"ogc",schemaLocation:null,initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){var t={};return this.readers.ogc.Filter.apply(this,[e,t]),t.filter},readers:{ogc:{_expression:function(e){for(var t,i="",n=e.firstChild;n;n=n.nextSibling)switch(n.nodeType){case 1:t=this.readNode(n),t.property?i+="${"+t.property+"}":void 0!==t.value&&(i+=t.value);break;case 3:case 4:i+=n.nodeValue}return i},Filter:function(e,t){var i={fids:[],filters:[]};this.readChildNodes(e,i),i.fids.length>0?t.filter=new OpenLayers.Filter.FeatureId({fids:i.fids}):i.filters.length>0&&(t.filter=i.filters[0])},FeatureId:function(e,t){var i=e.getAttribute("fid");i&&t.fids.push(i)},And:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND});this.readChildNodes(e,i),t.filters.push(i)},Or:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR});this.readChildNodes(e,i),t.filters.push(i)},Not:function(e,t){var i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.NOT});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsLessThan:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsGreaterThan:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsLessThanOrEqualTo:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsGreaterThanOrEqualTo:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO});this.readChildNodes(e,i),t.filters.push(i)},PropertyIsBetween:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN});this.readChildNodes(e,i),t.filters.push(i)},Literal:function(e,t){t.value=OpenLayers.String.numericIf(this.getChildValue(e))},PropertyName:function(e,t){t.property=this.getChildValue(e)},LowerBoundary:function(e,t){t.lowerBoundary=OpenLayers.String.numericIf(this.readers.ogc._expression.call(this,e))},UpperBoundary:function(e,t){t.upperBoundary=OpenLayers.String.numericIf(this.readers.ogc._expression.call(this,e))},Intersects:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.INTERSECTS)},Within:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.WITHIN)},Contains:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.CONTAINS)},DWithin:function(e,t){this.readSpatial(e,t,OpenLayers.Filter.Spatial.DWITHIN)},Distance:function(e,t){t.distance=parseInt(this.getChildValue(e)),t.distanceUnits=e.getAttribute("units")},Function:function(){}}},readSpatial:function(e,t,i){var n=new OpenLayers.Filter.Spatial({type:i});this.readChildNodes(e,n),n.value=n.components[0],delete n.components,t.filters.push(n)},writeOgcExpression:function(e,t){if(e instanceof OpenLayers.Filter.Function){var i=this.writeNode("Function",e,t);t.appendChild(i)}else this.writeNode("Literal",e,t);return t},write:function(e){return this.writers.ogc.Filter.apply(this,[e])},writeFeatureIdNodes:function(e,t){for(var i=0,n=e.fids.length;n>i;++i)this.writeNode("FeatureId",e.fids[i],t)},writers:{ogc:{Filter:function(e){var t=this.createElementNSPlus("ogc:Filter");return"FID"===e.type?OpenLayers.Format.Filter.v1.prototype.writeFeatureIdNodes.call(this,e,t):this.writeNode(this.getFilterType(e),e,t),t},FeatureId:function(e){return this.createElementNSPlus("ogc:FeatureId",{attributes:{fid:e}})},And:function(e){for(var t,i=this.createElementNSPlus("ogc:And"),n=0,s=e.filters.length;s>n;++n)t=e.filters[n],"FID"===t.type?OpenLayers.Format.Filter.v1.prototype.writeFeatureIdNodes.call(this,t,i):this.writeNode(this.getFilterType(t),t,i);return i},Or:function(e){for(var t,i=this.createElementNSPlus("ogc:Or"),n=0,s=e.filters.length;s>n;++n)t=e.filters[n],"FID"===t.type?OpenLayers.Format.Filter.v1.prototype.writeFeatureIdNodes.call(this,t,i):this.writeNode(this.getFilterType(t),t,i);return i},Not:function(e){var t=this.createElementNSPlus("ogc:Not"),i=e.filters[0];return"FID"===i.type?OpenLayers.Format.Filter.v1.prototype.writeFeatureIdNodes.call(this,i,t):this.writeNode(this.getFilterType(i),i,t),t},PropertyIsLessThan:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLessThan");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsGreaterThan:function(e){var t=this.createElementNSPlus("ogc:PropertyIsGreaterThan");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsLessThanOrEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLessThanOrEqualTo");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsGreaterThanOrEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsGreaterThanOrEqualTo");return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsBetween:function(e){var t=this.createElementNSPlus("ogc:PropertyIsBetween");return this.writeNode("PropertyName",e,t),this.writeNode("LowerBoundary",e,t),this.writeNode("UpperBoundary",e,t),t},PropertyName:function(e){return this.createElementNSPlus("ogc:PropertyName",{value:e.property})},Literal:function(e){return this.createElementNSPlus("ogc:Literal",{value:e})},LowerBoundary:function(e){var t=this.createElementNSPlus("ogc:LowerBoundary");return this.writeOgcExpression(e.lowerBoundary,t),t},UpperBoundary:function(e){var t=this.createElementNSPlus("ogc:UpperBoundary");return this.writeNode("Literal",e.upperBoundary,t),t},INTERSECTS:function(e){return this.writeSpatial(e,"Intersects")},WITHIN:function(e){return this.writeSpatial(e,"Within")},CONTAINS:function(e){return this.writeSpatial(e,"Contains")},DWITHIN:function(e){var t=this.writeSpatial(e,"DWithin");return this.writeNode("Distance",e,t),t},Distance:function(e){return this.createElementNSPlus("ogc:Distance",{attributes:{units:e.distanceUnits},value:e.distance})},Function:function(e){for(var t=this.createElementNSPlus("ogc:Function",{attributes:{name:e.name}}),i=e.params,n=0,s=i.length;s>n;n++)this.writeOgcExpression(i[n],t);return t}}},getFilterType:function(e){var t=this.filterMap[e.type];if(!t)throw"Filter writing not supported for rule type: "+e.type;return t},filterMap:{"&&":"And","||":"Or","!":"Not","==":"PropertyIsEqualTo","!=":"PropertyIsNotEqualTo","<":"PropertyIsLessThan",">":"PropertyIsGreaterThan","<=":"PropertyIsLessThanOrEqualTo",">=":"PropertyIsGreaterThanOrEqualTo","..":"PropertyIsBetween","~":"PropertyIsLike",BBOX:"BBOX",DWITHIN:"DWITHIN",WITHIN:"WITHIN",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS",FID:"FeatureId"},CLASS_NAME:"OpenLayers.Format.Filter.v1"}),OpenLayers.Format.Filter.v1_1_0=OpenLayers.Class(OpenLayers.Format.GML.v3,OpenLayers.Format.Filter.v1,{VERSION:"1.1.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.1.0/filter.xsd",initialize:function(e){OpenLayers.Format.GML.v3.prototype.initialize.apply(this,[e])},readers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(e,t){var i=e.getAttribute("matchCase"),n=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,matchCase:!("false"===i||"0"===i)});this.readChildNodes(e,n),t.filters.push(n)},PropertyIsNotEqualTo:function(e,t){var i=e.getAttribute("matchCase"),n=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.NOT_EQUAL_TO,matchCase:!("false"===i||"0"===i)});this.readChildNodes(e,n),t.filters.push(n)},PropertyIsLike:function(e,t){var i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE});this.readChildNodes(e,i);var n=e.getAttribute("wildCard"),s=e.getAttribute("singleChar"),a=e.getAttribute("escapeChar");i.value2regex(n,s,a),t.filters.push(i)}},OpenLayers.Format.Filter.v1.prototype.readers.ogc),gml:OpenLayers.Format.GML.v3.prototype.readers.gml,feature:OpenLayers.Format.GML.v3.prototype.readers.feature},writers:{ogc:OpenLayers.Util.applyDefaults({PropertyIsEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsEqualTo",{attributes:{matchCase:e.matchCase}});return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsNotEqualTo:function(e){var t=this.createElementNSPlus("ogc:PropertyIsNotEqualTo",{attributes:{matchCase:e.matchCase}});return this.writeNode("PropertyName",e,t),this.writeOgcExpression(e.value,t),t},PropertyIsLike:function(e){var t=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{matchCase:e.matchCase,wildCard:"*",singleChar:".",escapeChar:"!"}});return this.writeNode("PropertyName",e,t),this.writeNode("Literal",e.regex2value(),t),t},BBOX:function(e){var t=this.createElementNSPlus("ogc:BBOX");e.property&&this.writeNode("PropertyName",e,t);var i=this.writeNode("gml:Envelope",e.value);return e.projection&&i.setAttribute("srsName",e.projection),t.appendChild(i),t},SortBy:function(e){for(var t=this.createElementNSPlus("ogc:SortBy"),i=0,n=e.length;n>i;i++)this.writeNode("ogc:SortProperty",e[i],t);return t},SortProperty:function(e){var t=this.createElementNSPlus("ogc:SortProperty");return this.writeNode("ogc:PropertyName",e,t),this.writeNode("ogc:SortOrder","DESC"==e.order?"DESC":"ASC",t),t},SortOrder:function(e){var t=this.createElementNSPlus("ogc:SortOrder",{value:e});return t}},OpenLayers.Format.Filter.v1.prototype.writers.ogc),gml:OpenLayers.Format.GML.v3.prototype.writers.gml,feature:OpenLayers.Format.GML.v3.prototype.writers.feature},writeSpatial:function(e,t){var i=this.createElementNSPlus("ogc:"+t);if(this.writeNode("PropertyName",e,i),e.value instanceof OpenLayers.Filter.Function)this.writeNode("Function",e.value,i);else{var n;n=e.value instanceof OpenLayers.Geometry?this.writeNode("feature:_geometry",e.value).firstChild:this.writeNode("gml:Envelope",e.value),e.projection&&n.setAttribute("srsName",e.projection),i.appendChild(n)}return i},CLASS_NAME:"OpenLayers.Format.Filter.v1_1_0"}),OpenLayers.Format.WFST=function(e){e=OpenLayers.Util.applyDefaults(e,OpenLayers.Format.WFST.DEFAULTS);var t=OpenLayers.Format.WFST["v"+e.version.replace(/\./g,"_")];if(!t)throw"Unsupported WFST version: "+e.version;return new t(e)},OpenLayers.Format.WFST.DEFAULTS={version:"1.0.0"},OpenLayers.Format.WFST.v1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},defaultPrefix:"wfs",version:null,schemaLocations:null,srsName:null,extractAttributes:!0,xy:!0,stateName:null,initialize:function(e){this.stateName={},this.stateName[OpenLayers.State.INSERT]="wfs:Insert",this.stateName[OpenLayers.State.UPDATE]="wfs:Update",this.stateName[OpenLayers.State.DELETE]="wfs:Delete",OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},getSrsName:function(e,t){var i=t&&t.srsName;return i||(i=e&&e.layer?e.layer.projection.getCode():this.srsName),i},read:function(e,t){t=t||{},OpenLayers.Util.applyDefaults(t,{output:"features"}),"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),e&&9==e.nodeType&&(e=e.documentElement);var i={};return e&&this.readNode(e,i,!0),i.features&&"features"===t.output&&(i=i.features),i},readers:{wfs:{FeatureCollection:function(e,t){t.features=[],this.readChildNodes(e,t)}}},write:function(e,t){var i=this.writeNode("wfs:Transaction",{features:e,options:t}),n=this.schemaLocationAttr();return n&&this.setAttributeNS(i,this.namespaces.xsi,"xsi:schemaLocation",n),OpenLayers.Format.XML.prototype.write.apply(this,[i])},writers:{wfs:{GetFeature:function(e){var t=this.createElementNSPlus("wfs:GetFeature",{attributes:{service:"WFS",version:this.version,handle:e&&e.handle,outputFormat:e&&e.outputFormat,maxFeatures:e&&e.maxFeatures,"xsi:schemaLocation":this.schemaLocationAttr(e)}});if("string"==typeof this.featureType)this.writeNode("Query",e,t);else for(var i=0,n=this.featureType.length;n>i;i++)e.featureType=this.featureType[i],this.writeNode("Query",e,t);return t},Transaction:function(e){e=e||{};var t,i,n=e.options||{},s=this.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version,handle:n.handle}}),a=e.features;if(a){n.multi===!0&&OpenLayers.Util.extend(this.geometryTypes,{"OpenLayers.Geometry.Point":"MultiPoint","OpenLayers.Geometry.LineString":this.multiCurve===!0?"MultiCurve":"MultiLineString","OpenLayers.Geometry.Polygon":this.multiSurface===!0?"MultiSurface":"MultiPolygon"});var r,o;for(t=0,i=a.length;i>t;++t)o=a[t],r=this.stateName[o.state],r&&this.writeNode(r,{feature:o,options:n},s);n.multi===!0&&this.setGeometryTypes()}if(n.nativeElements)for(t=0,i=n.nativeElements.length;i>t;++t)this.writeNode("wfs:Native",n.nativeElements[t],s);return s},Native:function(e){var t=this.createElementNSPlus("wfs:Native",{attributes:{vendorId:e.vendorId,safeToIgnore:e.safeToIgnore},value:e.value});return t},Insert:function(e){var t=e.feature,i=e.options,n=this.createElementNSPlus("wfs:Insert",{attributes:{handle:i&&i.handle}});return this.srsName=this.getSrsName(t),this.writeNode("feature:_typeName",t,n),n},Update:function(e){var t=e.feature,i=e.options,n=this.createElementNSPlus("wfs:Update",{attributes:{handle:i&&i.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});this.featureNS&&n.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);var s=t.modified;null===this.geometryName||s&&void 0===s.geometry||(this.srsName=this.getSrsName(t),this.writeNode("Property",{name:this.geometryName,value:t.geometry},n));for(var a in t.attributes)void 0===t.attributes[a]||s&&s.attributes&&(!s.attributes||void 0===s.attributes[a])||this.writeNode("Property",{name:a,value:t.attributes[a]},n);return this.writeNode("ogc:Filter",new OpenLayers.Filter.FeatureId({fids:[t.fid]}),n),n},Property:function(e){var t=this.createElementNSPlus("wfs:Property");return this.writeNode("Name",e.name,t),null!==e.value&&this.writeNode("Value",e.value,t),t},Name:function(e){return this.createElementNSPlus("wfs:Name",{value:e})},Value:function(e){var t;if(e instanceof OpenLayers.Geometry){t=this.createElementNSPlus("wfs:Value");var i=this.writeNode("feature:_geometry",e).firstChild;t.appendChild(i)}else t=this.createElementNSPlus("wfs:Value",{value:e});return t},Delete:function(e){var t=e.feature,i=e.options,n=this.createElementNSPlus("wfs:Delete",{attributes:{handle:i&&i.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});return this.featureNS&&n.setAttribute("xmlns:"+this.featurePrefix,this.featureNS),this.writeNode("ogc:Filter",new OpenLayers.Filter.FeatureId({fids:[t.fid]}),n),n}}},schemaLocationAttr:function(e){e=OpenLayers.Util.extend({featurePrefix:this.featurePrefix,schema:this.schema},e);var t=OpenLayers.Util.extend({},this.schemaLocations);e.schema&&(t[e.featurePrefix]=e.schema);var i,n=[];for(var s in t)i=this.namespaces[s],i&&n.push(i+" "+t[s]);var a=n.join(" ")||void 0;return a},setFilterProperty:function(e){if(e.filters)for(var t=0,i=e.filters.length;i>t;++t)OpenLayers.Format.WFST.v1.prototype.setFilterProperty.call(this,e.filters[t]);else e instanceof OpenLayers.Filter.Spatial&&!e.property&&(e.property=this.geometryName)},CLASS_NAME:"OpenLayers.Format.WFST.v1"}),OpenLayers.Format.WFST.v1_1_0=OpenLayers.Class(OpenLayers.Format.Filter.v1_1_0,OpenLayers.Format.WFST.v1,{version:"1.1.0",schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"},initialize:function(e){OpenLayers.Format.Filter.v1_1_0.prototype.initialize.apply(this,[e]),OpenLayers.Format.WFST.v1.prototype.initialize.apply(this,[e])},readNode:function(e,t){return OpenLayers.Format.GML.v3.prototype.readNode.apply(this,[e,t])},readers:{wfs:OpenLayers.Util.applyDefaults({FeatureCollection:function(e,t){t.numberOfFeatures=parseInt(e.getAttribute("numberOfFeatures")),OpenLayers.Format.WFST.v1.prototype.readers.wfs.FeatureCollection.apply(this,arguments)},TransactionResponse:function(e,t){t.insertIds=[],t.success=!1,this.readChildNodes(e,t)},TransactionSummary:function(e,t){t.success=!0},InsertResults:function(e,t){this.readChildNodes(e,t)},Feature:function(e,t){var i={fids:[]};this.readChildNodes(e,i),t.insertIds.push(i.fids[0])}},OpenLayers.Format.WFST.v1.prototype.readers.wfs),gml:OpenLayers.Format.GML.v3.prototype.readers.gml,feature:OpenLayers.Format.GML.v3.prototype.readers.feature,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.readers.ogc,ows:OpenLayers.Format.OWSCommon.v1_0_0.prototype.readers.ows},writers:{wfs:OpenLayers.Util.applyDefaults({GetFeature:function(e){var t=OpenLayers.Format.WFST.v1.prototype.writers.wfs.GetFeature.apply(this,arguments);return e&&this.setAttributes(t,{resultType:e.resultType,startIndex:e.startIndex,count:e.count}),t},Query:function(e){e=OpenLayers.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName},e);var t=e.featurePrefix,i=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(t?t+":":"")+e.featureType,srsName:e.srsName}});if(e.featureNS&&i.setAttribute("xmlns:"+t,e.featureNS),e.propertyNames)for(var n=0,s=e.propertyNames.length;s>n;n++)this.writeNode("wfs:PropertyName",{property:e.propertyNames[n]},i);return e.filter&&(OpenLayers.Format.WFST.v1_1_0.prototype.setFilterProperty.call(this,e.filter),this.writeNode("ogc:Filter",e.filter,i)),i},PropertyName:function(e){return this.createElementNSPlus("wfs:PropertyName",{value:e.property})}},OpenLayers.Format.WFST.v1.prototype.writers.wfs),gml:OpenLayers.Format.GML.v3.prototype.writers.gml,feature:OpenLayers.Format.GML.v3.prototype.writers.feature,ogc:OpenLayers.Format.Filter.v1_1_0.prototype.writers.ogc},CLASS_NAME:"OpenLayers.Format.WFST.v1_1_0"}),OpenLayers.Lang={code:null,defaultCode:"en",getCode:function(){return OpenLayers.Lang.code||OpenLayers.Lang.setCode(),OpenLayers.Lang.code
},setCode:function(e){var t;e||(e="msie"==OpenLayers.BROWSER_NAME?navigator.userLanguage:navigator.language);var i=e.split("-");if(i[0]=i[0].toLowerCase(),"object"==typeof OpenLayers.Lang[i[0]]&&(t=i[0]),i[1]){var n=i[0]+"-"+i[1].toUpperCase();"object"==typeof OpenLayers.Lang[n]&&(t=n)}t||(OpenLayers.Console.warn("Failed to find OpenLayers.Lang."+i.join("-")+" dictionary, falling back to default language"),t=OpenLayers.Lang.defaultCode),OpenLayers.Lang.code=t},translate:function(e,t){var i=OpenLayers.Lang[OpenLayers.Lang.getCode()],n=i&&i[e];return n||(n=e),t&&(n=OpenLayers.String.format(n,t)),n}},OpenLayers.i18n=OpenLayers.Lang.translate,Oskari.clazz.define("Oskari.mapframework.bundle.MapWmtsBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.MapWmtsBundleInstance")},update:function(e,t,i,n){e.alert("RECEIVED update notification "+n)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/plugin/wmtslayer/WmtsLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/domain/WmtsLayer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/service/WmtsLayerService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/service/WmtsLayerModelBuilder.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwmts/instance.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"mapwmts","Bundle-Name":"mapwmts","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"WMTS",Title:"WMTS"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","Ext"]}}}),Oskari.bundle_manager.installBundleClass("mapwmts","Oskari.mapframework.bundle.MapWmtsBundle"),Oskari.clazz.define("Oskari.mapframework.wmts.mapmodule.plugin.WmtsLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this.config=e},{__name:"WmtsLayerPlugin",getName:function(){return this.pluginName},getMap:function(){return this._map},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},register:function(){this.getMapModule().setLayerPlugin("WmtsLayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("WmtsLayer",null)},init:function(e){var t=(this.config?this.config.sandbox:null)||"sandbox",e=Oskari.getSandbox(t),i=e.getService("Oskari.mapframework.service.MapLayerService");if(i){i.registerLayerModel("wmtslayer","Oskari.mapframework.wmts.domain.WmtsLayer");var n=Oskari.clazz.create("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder");i.registerLayerModelBuilder("wmtslayer",n)}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this.afterMapLayerRemoveEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this.afterChangeMapLayerOpacityEvent(e)},AfterChangeMapLayerStyleEvent:function(e){this.afterChangeMapLayerStyleEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var n=e[i],s=n.getId();n.isLayerOfType("WMTS")&&(t.printDebug("preselecting "+s),this.addMapLayerToMap(n,!0,n.isBaseLayer()))}},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},addMapLayerToMap:function(e){if(e.isLayerOfType("WMTS")){var t=this,i=t.getMap(),n=e.getWmtsMatrixSet().matrixIds,s=e.getWmtsLayerDef(),a=null;a=e.isBaseLayer()||e.isGroupLayer()?"basemap_"+e.getId():"layer_"+e.getId();var r=this._sandbox,o="image/png",l="KVP",u=s.resourceUrl?s.resourceUrl.tile?s.resourceUrl.tile.template:void 0:void 0;u?l="REST":u=e.getWmtsUrls()[0][0].url;for(var c=e.getWmtsMatrixSet(),n=[],h=[],d=[],p=0;p<c.matrixIds.length;p++){n.push(c.matrixIds[p]);var f=c.matrixIds[p].scaleDenominator,m=f/90.71446714322*OpenLayers.METERS_PER_INCH;h.push(m),d.push(m)}var g={name:a.split(".").join(""),url:u,requestEncoding:l,layer:e.getWmtsName(),matrixSet:c.identifier,format:o,style:e.getCurrentStyle().getName(),visibility:!0,isBaseLayer:!1,transparent:!0,style:e.getCurrentStyle().getName(),matrixIds:n,isBaseLayer:e.isBaseLayer(),buffer:0,serverResolutions:d,layerDef:s};r.printDebug("[WmtsLayerPlugin] creating WMTS Layer "+c.identifier+" / "+g.id+"/"+g.layer+"/"+g.url);var y=new OpenLayers.Layer.WMTS(g);y.opacity=e.getOpacity()/100,r.printDebug("[WmtsLayerPlugin] created WMTS layer "+y),i.addLayers([y])}},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.removeMapLayerFromMap(t)},removeMapLayerFromMap:function(e){if(e.isLayerOfType("WMTS"))if(e.isBaseLayer()||e.isGroupLayer())if(e.getSubLayers().length>0)for(var t=0;t<e.getSubLayers().length;t++){var i=this._map.getLayersByName("basemap_"+e.getSubLayers()[t].getId());i[0].destroy()}else{var i=this._map.getLayersByName("layer_"+e.getId());i[0].destroy()}else{var i=this._map.getLayersByName("layer_"+e.getId());i[0].destroy()}},getOLMapLayers:function(e){if(!e.isLayerOfType("WMTS"))return null;if(!e.isBaseLayer()&&!e.isGroupLayer())return this._map.getLayersByName("layer_"+e.getId());if(!(e.getSubLayers().length>0))return this._map.getLayersByName("layer_"+e.getId());for(var t=0;t<e.getSubLayers().length;t++)return this._map.getLayersByName("basemap_"+e.getSubLayers()[t].getId());return null},afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WMTS"))if(t.isBaseLayer()||t.isGroupLayer())if(t.getSubLayers().length>0)for(var i=0;i<t.getSubLayers().length;i++){var n=this._map.getLayersByName("basemap_"+t.getSubLayers()[i].getId());n[0].setOpacity(t.getOpacity()/100)}else{var n=this._map.getLayersByName("layer_"+t.getId());null!=n[0]&&n[0].setOpacity(t.getOpacity()/100)}else{this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var n=this._map.getLayersByName("layer_"+t.getId());null!=n[0]&&n[0].setOpacity(t.getOpacity()/100)}},afterChangeMapLayerStyleEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WMTS")&&!t.isBaseLayer()){var i=this._map.getLayersByName("layer_"+t.getId());null!=i&&i[0].mergeNewParams({styles:t.getCurrentStyle().getName()})}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.wmts.domain.WmtsLayer",function(){this._WmtsLayerName=null,this._WmtsMatrixSet=null,this._WmtsUrls=[],this._layerType="WMTS"},{setWmtsName:function(e){this._WmtsName=e},getWmtsName:function(){return this._WmtsName},setWmtsMatrixSet:function(e){this._WmtsMatrixSet=e},getWmtsMatrixSet:function(){return this._WmtsMatrixSet},setWmtsLayerDef:function(e){this._WmtsLayerDef=e},getWmtsLayerDef:function(){return this._WmtsLayerDef},addWmtsUrl:function(e){this._WmtsUrls.push(e)},getWmtsUrls:function(){return this._WmtsUrls}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.wmts.service.WMTSLayerService",function(e){this.mapLayerService=e,this.capabilities={}},{setCapabilities:function(e,t){this.capabilities[e]=t},getCapabilities:function(e){return this.capabilities[e]},readWMTSCapabilites:function(e,t,i,n){var s=this,a=new OpenLayers.Format.WMTSCapabilities;OpenLayers.Request.GET({url:t,params:{SERVICE:"WMTS",VERSION:"1.0.0",REQUEST:"GetCapabilities"},success:function(t){var r=t.responseXML;r&&r.documentElement||(r=t.responseText);var o=a.read(r);s.setCapabilities(e,o);var l=s.parseCapabilitiesToLayers(e,o,i);n&&n(l,o)},failure:function(){alert("Trouble getting capabilities doc"),OpenLayers.Console.error.apply(OpenLayers.Console,arguments)}})},parseCapabilitiesToLayers:function(e,t,i){var n=this.mapLayerService,s=null;s=t.operationsMetadata.GetTile.dcp.http.getArray?t.operationsMetadata.GetTile.dcp.http.getArray:t.operationsMetadata.GetTile.dcp.http.get;for(var a=t.contents.layers,r=t.contents,i=r.tileMatrixSets[i],o=[],l=0;l<a.length;l++){var u=a[l],c=u.identifier;u.identifier;var h={wmtsName:c,descriptionLink:"",orgName:e,type:"wmtslayer",legendImage:"",formats:{value:"text/html"},isQueryable:!0,style:"",dataUrl:"",name:c,opacity:100,inspire:e,maxScale:1},d=Oskari.clazz.create("Oskari.mapframework.wmts.domain.WmtsLayer");d.setAsNormalLayer(),d.setId(c.split(".").join("_")),d.setName(h.name),d.setWmtsName(h.wmtsName),d.setOpacity(h.opacity),d.setMaxScale(h.maxScale),d.setMinScale(h.minScale),d.setDescription(h.info),d.setDataUrl(h.dataUrl),d.setOrganizationName(h.orgName),d.setInspireName(h.inspire),d.setWmtsMatrixSet(i),d.setWmtsLayerDef(u),d.setVisible(!0),d.addWmtsUrl(s);for(var p,f=Oskari.clazz.builder("Oskari.mapframework.domain.Style"),m=0,g=u.styles.length;g>m;++m){p=u.styles[m];var y=f();if(y.setName(p.identifier),y.setTitle(p.identifier),d.addStyle(y),p.isDefault){d.selectStyle(p.identifier);break}}n.addLayer(d,!1),o.push(d)}return o}}),Oskari.clazz.define("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder",function(){},{parseLayerData:function(e,t){if(e.setWmtsName(t.wmsName),t.wmsUrl)for(var i=t.wmsUrl.split(","),n=0;n<i.length;n++)e.addWmtsUrl(i[n]);for(var s,a=Oskari.clazz.builder("Oskari.mapframework.domain.Style"),n=0,r=t.styles.length;r>n;++n){s=t.styles[n];var o=a();if(o.setName(s.identifier),o.setTitle(s.identifier),e.addStyle(o),s.isDefault){e.selectStyle(s.identifier);break}}if(e.setFeatureInfoEnabled(!0),t.tileMatrixSetData&&t.tileLayerData)e.setWmtsMatrixSet(t.tileMatrixSetData),e.setWmtsLayerDef(t.tileLayerData);else if(t.tileMatrixSetData&&t.tileMatrixSetId){var l=t.tileMatrixSetId;if(t.tileMatrixSetData.contents&&t.tileMatrixSetData.contents.tileMatrixSets){var u=t.tileMatrixSetData.contents.tileMatrixSets[l];e.setWmtsMatrixSet(u)}for(var c=e.getWmtsName(),h=t.tileMatrixSetData.contents.layers,d=0;d<h.length;d++)if(h[d].identifier==c){e.setWmtsLayerDef(h[d]);break}}}}),Oskari.clazz.define("Oskari.mapframework.bundle.MapWmtsBundleInstance",function(){this.name="MapWmts",this.mediator=null,this.sandbox=null,this.service=null,this.ui=null},{start:function(){if("started"!=this.mediator.getState()){var e=this,t=e.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);this.sandbox=n;var s=n.getService("Oskari.mapframework.service.MapLayerService");s.registerLayerModel("wmtslayer","Oskari.mapframework.wmts.domain.WmtsLayer");var a=Oskari.clazz.create("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder");s.registerLayerModelBuilder("wmtslayer",a);var r=Oskari.clazz.create("Oskari.mapframework.wmts.service.WMTSLayerService",s);return this.service=r,this.mediator.setState("started"),this}},update:function(e,t,i,n){e.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+n)},stop:function(){return this.mediator.setState("stopped"),this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.MapWmtsBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.MapWfsBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs.MapWfsBundleInstance")},update:function(e,t,i,n){e.alert("RECEIVED update notification "+n)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/WfsLayer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/WfsLayerModelBuilder.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/QueuedTile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/TileQueue.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/domain/WfsTileRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/event/WFSFeaturesSelectedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/service/WfsTileService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/plugin/wfslayer/QueuedTilesGrid.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/plugin/wfslayer/QueuedTilesStrategy.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/plugin/wfslayer/WfsLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/instance.js"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapwfs/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"mapwfs","Bundle-Name":"mapwfs","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"WFS",Title:"WFS"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","Ext"]}}}),Oskari.bundle_manager.installBundleClass("mapwfs","Oskari.mapframework.bundle.mapwfs.MapWfsBundle"),Oskari.clazz.define("Oskari.mapframework.domain.WfsLayer",function(){this._layerType="WFS"},{},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.domain.WfsLayerModelBuilder",function(e){this.sandbox=e,this.localization=Oskari.getLocalization("MapWfs")},{parseLayerData:function(e){var t=this,i=this.localization["object-data"],n=Oskari.clazz.builder("Oskari.mapframework.domain.Tool"),s=n();s.setName("objectData"),s.setTitle(i),s.setTooltip(i),s.setCallback(function(){t.sandbox.postRequestByName("ShowFeatureDataRequest",[e.getId()])}),e.addTool(s)}}),Oskari.clazz.define("Oskari.mapframework.gridcalc.QueuedTile",function(e){for(p in e)this[p]=e[p]},{getBounds:function(){return this.bounds}}),Oskari.clazz.define("Oskari.mapframework.gridcalc.TileQueue",function(){this.queue=[]},{getQueue:function(){return this.queue},getLength:function(){return this.queue.length},popJob:function(){var e=this.queue,t=e.length;if(0===t)return null;if(4>t)return e.shift(-1);var i=null,n=Math.floor(t/2);return i=e[n],this.queue=e.slice(0,n).concat(e.slice(n+1)),i},pushJob:function(e){this.queue.push(e)},flushQueue:function(){this.queue=[]}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.domain.WfsTileRequest",function(e,t,i,n,s,a){this._bbox=t,this._mapWidth=i,this._mapHeight=n,this._mapLayer=e,this._creator=s,this._sequenceNumber=a},{getMapLayer:function(){return this._mapLayer},getBbox:function(){return this._bbox},getMapWidth:function(){return this._mapWidth},getMapHeight:function(){return this._mapHeight},getSequenceNumber:function(){return this._sequenceNumber}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.event.WFSFeaturesSelectedEvent",function(e,t,i){this._wfsFeatureIds=e,this._addToSelection=i,this._mapLayer=t},{__name:"WFSFeaturesSelectedEvent",getName:function(){return this.__name},getWfsFeatureIds:function(){return this._wfsFeatureIds},isKeepSelection:function(){return this._addToSelection?this._addToSelection:!1},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.service.WfsTileService",function(e){this.plugin=e,this._TILE_SIZE_IN_PIXELS=256,this._componentName="WfsRequestTiler",this._mapPollingInterval=100,this._simultaneousPngRequest=4,this._wfsMapUpdateRequests={},this._WFSFeaturesSelectedEvent=null,this._tileCount=16,this._doMapLayerReArrange=!1,this.sandbox=e._sandbox,this.pngUrl=this.sandbox.getAjaxUrl()},{__qname:"Oskari.mapframework.bundle.mapwfs.service.WfsTileService",getQName:function(){return this.__qname},__name:"WfsTileService",getName:function(){return this.__name},scheduleMapLayerRearrangeAfterWfsMapTilesAreReady:function(){this._doMapLayerReArrange=!0},removeWFsLayerRequests:function(e){var t=e.getId();null!==this._wfsMapUpdateRequests[t]&&(this._wfsMapUpdateRequests[t]=null,delete this._wfsMapUpdateRequests[t])},removeWFSMapHighlightRequest:function(){this._WFSFeaturesSelectedEvent=null},scheduleWFSMapLayerUpdate:function(e,t,i,n,s){var a=e.getId(),r=this._wfsMapUpdateRequests[a];null!==r&&(this._wfsMapUpdateRequests[a]=null,delete this._wfsMapUpdateRequests[a]),this._wfsMapUpdateRequests[a]=[];var o=this.splitBbox(t,i,n,this._TILE_SIZE_IN_PIXELS);this._tileCount=o.length;for(var l=Oskari.clazz.builder("Oskari.mapframework.bundle.mapwfs.domain.WfsTileRequest"),u=0;u<o.length;u++){var c=l(e,o[u],i,n,s,u);this._wfsMapUpdateRequests[a].push(c)}this._doMapLayerReArrange=!0},scheduleWFSMapHighlightUpdate:function(e){this._WFSFeaturesSelectedEvent=e,this.processHighlightQueue()},splitBbox:function(){var e=this.sandbox.getMap(),t=[];if(e){var i=this.plugin.getTileQueue();i&&(t=i.getQueue())}return t},processMapQueue:function(){var e=this;this.sandbox.printDebug("[WfsTileService.processMapQueue] Looping this._wfsMapUpdateRequests...");for(var t in this._wfsMapUpdateRequests){var i=this._wfsMapUpdateRequests[t];if(null!==i&&i.length>0){this.sandbox.printDebug("[WfsTileService.processMapQueue] Got requestArray of size "+i.length+" for id "+t);var n=i[0];this.sandbox.printDebug("[WfsTileService.processMapQueue] Creating request for '"+n.getMapLayer().getName()+"'");var s=n.getBbox(),a=this.sandbox.getMap().getZoom(),r=this.pngUrl+"&flow_pm_wfsLayerId="+n.getMapLayer().getId()+"&flow_pm_bbox_min_x="+s.bounds.left+"&flow_pm_bbox_min_y="+s.bounds.bottom+"&flow_pm_bbox_max_x="+s.bounds.right+"&flow_pm_bbox_max_y="+s.bounds.top+"&flow_pm_map_width="+this._TILE_SIZE_IN_PIXELS+"&flow_pm_map_height="+this._TILE_SIZE_IN_PIXELS+"&flow_pm_zoom_level="+a+"&srs="+this.sandbox.getMap().getSrsName()+"&action_route=GET_PNG_MAP",o="WFS_LAYER_IMAGE_"+n.getMapLayer().getId()+"_"+n.getSequenceNumber();return e.plugin.drawImageTile(n.getMapLayer(),r,s,o),this.sandbox.printDebug("[WfsTileService.processMapQueue] removing handled element"),i.splice(0,1),0===i.length&&(delete this._wfsMapUpdateRequests[t],this.sandbox.printDebug("[WfsTileService.processMapQueue] deleting empty requestArray")),void 0}}if(this.sandbox.printDebug("[WfsTileService.processMapQueue] _doMapLayerReArrange is "+this._doMapLayerReArrange),this._doMapLayerReArrange){var l=this.sandbox.getRequestBuilder("RearrangeSelectedMapLayerRequest"),u=l();this.sandbox.request(this.plugin,u),this._doMapLayerReArrange=!1}},processHighlightQueue:function(){var e=this._WFSFeaturesSelectedEvent;if(e)try{var t=e.getMapLayer();if(!t.isLayerOfType("WFS"))throw"Trying to highlight feature from layer that is not WFS layer!";var i=e.getWfsFeatureIds();if(!i||0==i.length)return e.isKeepSelection()||this.plugin.removeHighlightOnMapLayer(t.getId()),void 0;for(var n=this.sandbox.getMap(),s=n.getBbox(),a=n.getWidth(),r=n.getHeight(),o=this,l=o.pngUrl+"&flow_pm_wfsLayerId="+t.getId()+"&flow_pm_bbox_min_x="+s.left+"&flow_pm_bbox_min_y="+s.bottom+"&flow_pm_bbox_max_x="+s.right+"&flow_pm_bbox_max_y="+s.top+"&flow_pm_map_width="+a+"&flow_pm_map_height="+r+"&action_route=GET_HIGHLIGHT_WFS_FEATURE_IMAGE",u=function(n){o.plugin.drawImageTile(t,l+"&wfsFeatureId="+n,s,"HIGHLIGHTED_FEATURE",e.isKeepSelection()||i.length>1)},c=0;c<i.length;++c)u(i[c])}finally{}},startPollers:function(){for(i=0;i<this._tileCount;i++)this.processMapQueue()}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.gridcalc.QueuedTilesGrid",function(e){this.grid=[],this.map=null,this.tileSize=null,this.maxExtent=null,this.buffer=0,this.numLoadingTiles=0;for(p in e)this[p]=e[p]},{destroy:function(){this.clearGrid(),this.grid=null,this.tileSize=null},clearGrid:function(){if(this.grid){for(var e=0,t=this.grid.length;t>e;e++)for(var i=this.grid[e],n=0,s=i.length;s>n;n++){var a=i[n];a.destroy()}this.grid=[]}},moveTo:function(e,t){if(e=e||this.map.getExtent(),null!=e){var i=!this.grid.length||t,n=this.getTilesBounds();i||!n.containsBounds(e,!0)?this.initGriddedTiles(e):this.moveGriddedTiles(e)}},setTileSize:function(){},getTilesBounds:function(){var e=null;if(this.grid.length){var t=this.grid.length-1,i=this.grid[t][0],n=this.grid[0].length-1,s=this.grid[0][n];e=new OpenLayers.Bounds(i.bounds.left,i.bounds.bottom,s.bounds.right,s.bounds.top)}return e},calculateGridLayout:function(e,t,i){var n=i*this.tileSize.w,s=i*this.tileSize.h,a=e.left-t.left,r=Math.floor(a/n)-this.buffer,o=a/n-r,l=-o*this.tileSize.w,u=t.left+r*n,c=e.top-(t.bottom+s),h=Math.ceil(c/s)+this.buffer,d=h-c/s,p=-d*this.tileSize.h,f=t.bottom+h*s;return{tilelon:n,tilelat:s,tileoffsetlon:u,tileoffsetlat:f,tileoffsetx:l,tileoffsety:p}},initGriddedTiles:function(e){var t=this.map.getSize(),i=Math.ceil(t.h/this.tileSize.h)+Math.max(1,2*this.buffer),n=Math.ceil(t.w/this.tileSize.w)+Math.max(1,2*this.buffer),s=this.maxExtent,a=this.map.getResolution(),r=this.calculateGridLayout(e,s,a),o=Math.round(r.tileoffsetx),l=Math.round(r.tileoffsety),u=r.tileoffsetlon,c=r.tileoffsetlat,h=r.tilelon,d=r.tilelat;this.origin=new OpenLayers.Pixel(o,l);var p=o,f=u,m=0,g=parseInt(this.map.layerContainerDiv.style.left),y=parseInt(this.map.layerContainerDiv.style.top);do{var v=this.grid[m++];v||(v=[],this.grid.push(v)),u=f,o=p;var b=0;do{var _=new OpenLayers.Bounds(u,c,u+h,c+d),w=o;w-=g;var L=l;L-=y;var k=new OpenLayers.Pixel(w,L),O=v[b++];O?O.moveTo(_,k,!1):(O=this.addTile(_,k),v.push(O)),u+=h,o+=this.tileSize.w}while(u<=e.right+h*this.buffer||n>b);c-=d,l+=this.tileSize.h}while(c>=e.bottom-d*this.buffer||i>m);this.removeExcessTiles(m,b)},addTile:function(e,t){return new OpenLayers.Tile(this.layer,e,t,"",this.tileSize)},moveGriddedTiles:function(){for(var e=this.buffer||1;;){var t=this.grid[0][0].position,i=this.map.getViewPortPxFromLayerPx(t);if(i.x>-this.tileSize.w*(e-1))this.shiftColumn(!0);else if(i.x<-this.tileSize.w*e)this.shiftColumn(!1);else if(i.y>-this.tileSize.h*(e-1))this.shiftRow(!0);else{if(!(i.y<-this.tileSize.h*e))break;this.shiftRow(!1)}}},shiftRow:function(e){for(var t=e?0:this.grid.length-1,i=this.grid,n=i[t],s=this.map.getResolution(),a=e?-this.tileSize.h:this.tileSize.h,r=s*-a,o=e?i.pop():i.shift(),l=0,u=n.length;u>l;l++){var c=n[l],h=c.bounds.clone(),d=c.position.clone();h.bottom=h.bottom+r,h.top=h.top+r,d.y=d.y+a,o[l].moveTo(h,d)}e?i.unshift(o):i.push(o)},shiftColumn:function(e){for(var t=e?-this.tileSize.w:this.tileSize.w,i=this.map.getResolution(),n=i*t,s=0,a=this.grid.length;a>s;s++){var r=this.grid[s],o=e?0:r.length-1,l=r[o],u=l.bounds.clone(),c=l.position.clone();u.left=u.left+n,u.right=u.right+n,c.x=c.x+t;var h=e?this.grid[s].pop():this.grid[s].shift();h.moveTo(u,c),e?r.unshift(h):r.push(h)}},removeExcessTiles:function(e,t){for(;this.grid.length>e;)for(var i=this.grid.pop(),n=0,s=i.length;s>n;n++){var a=i[n];a.destroy()}for(;this.grid[0].length>t;)for(var n=0,s=this.grid.length;s>n;n++){var i=this.grid[n],a=i.pop();a.destroy()}},onMapResize:function(){},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTilesGrid"}),Oskari.clazz.define("Oskari.mapframework.gridcalc.QueuedTilesStrategy",function(e){this.debugGridFeatures=!0,this.options=e,this.tileQueue=e.tileQueue,this.autoActivate=!0,this.autoDestroy=!1,this.grid=null,this.bounds=null;for(p in e)this[p]=e[p];this.active=!1},{setLayer:function(e){this.layer=e},flushTileQueue:function(){for(var e=this.tileQueue.queue,t=[],i=0;i<e.length;i++)null!=e[i].tileFeature&&(t.push(e[i].tileFeature),e[i].tileFeature=null);t.length>0&&this.layer.destroyFeatures(t),this.tileQueue.flushQueue()},unloadOutOfViewFeatures:function(){},ratio:1,activate:function(){return this.active?!1:(this.active=!0,this.grid=Oskari.clazz.create("Oskari.mapframework.gridcalc.QueuedTilesGrid",{map:this.layer.map,layer:this.layer,maxExtent:this.layer.map.getMaxExtent(),tileSize:this.layer.map.getTileSize()}),this.layer.events.on({refresh:this.updateRefresh,scope:this}),!0)},deactivate:function(){return this.active?(this.layer.events.un({refresh:this.update,scope:this}),this.grid.destroy(),this.grid=null,!0):!1},updateRefresh:function(){this.update()},updateMoveEnd:function(){this.update()},update:function(){var e=this.layer.map.getExtent();this.grid.moveTo(e,!0),this.flushTileQueue();var t=this.layer.map.getZoom();t<this.minZoom||this.triggerRead()},invalidBounds:function(e){return e||(e=this.layer.map.getExtent()),!this.bounds||!this.bounds.containsBounds(e)},triggerUnload:function(){this.layer.destroyFeatures()},triggerRead:function(){for(var e=this.grid.grid,t=[],i=this.debugGridFeatures,n=0;n<e.length;n++)for(var s=0;s<e[n].length;s++){var a=e[n][s].bounds.clone(),r={left:a.left,top:a.top,right:a.right,bottom:a.bottom},o=null;if(i){var l=new OpenLayers.Geometry.Point(a.left,a.bottom),u=new OpenLayers.Geometry.Point(a.right,a.top),c=new OpenLayers.Geometry.Point(a.left,a.top),h=new OpenLayers.Geometry.Point(a.right,a.bottom),d=new OpenLayers.Geometry.LineString([l,h,u,c,l]),o=new OpenLayers.Feature.Vector(d,{featureClassName:this.CLASS_NAME,description:""});o.renderIntent="tile",t.push(o)}var p=Oskari.clazz.create("Oskari.mapframework.gridcalc.QueuedTile",{bounds:r,tileFeature:o});this.tileQueue.pushJob(p)}i&&this.layer.addFeatures(t)},merge:function(e){var t=e.features;t&&t.length>0&&this.layer.addFeatures(t)},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTilesStrategy"}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.plugin.wfslayer.WfsLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this.service=null,this.config=e},{__name:"WfsLayerPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},init:function(){var e=(this.config?this.config.sandbox:null)||"sandbox",t=Oskari.getSandbox(e),i=t.getService("Oskari.mapframework.service.MapLayerService");if(i){i.registerLayerModel("wfslayer","Oskari.mapframework.domain.WfsLayer");var n=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs.domain.WfsLayerModelBuilder",t);i.registerLayerModelBuilder("wfslayer",n)}},register:function(){this.getMapModule().setLayerPlugin("wfslayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("wfslayer",null)},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this.createTilesGrid(),this.service=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs.service.WfsTileService",this),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapMoveEvent:function(e){var t=this._sandbox.getObjectCreator(e);this._sandbox.printDebug("[WfsLayerPlugin] got AfterMapMoveEvent from "+t),this.afterAfterMapMoveEvent()},AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();t.isLayerOfType("WFS")&&this.afterMapLayerRemoveEvent(e)},AfterHighlightWFSFeatureRowEvent:function(e){this.handleAfterHighlightWFSFeatureRowEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this.afterChangeMapLayerOpacityEvent(e)},AfterDimMapLayerEvent:function(e){this.handleAfterDimMapLayerEvent(e)},MapClickedEvent:function(e){if(!this._sandbox.getMap().isMoving()){var t=e.getLonLat(),i=e.getMouseX(),n=e.getMouseY();this._getFeatureIds(t,i,n)}},WFSFeaturesSelectedEvent:function(e){this.service.scheduleWFSMapHighlightUpdate(e)},MapLayerVisibilityChangedEvent:function(e){e.getMapLayer().isVisible()&&this.afterAfterMapMoveEvent()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var n=e[i],s=n.getId();n.isLayerOfType("WFS")&&(t.printDebug("[WfsLayerPlugin] preselecting "+s),this.addMapLayerToMap(n,!0,n.isBaseLayer()))}},afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WFS"))for(var i=this.getOLMapLayers(t),n=0;n<i.length;n++)i[n].setOpacity(t.getOpacity()/100)},handleAfterDimMapLayerEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WFS"))for(var i=new RegExp("wfs_layer_"+t.getId()+"_HIGHLIGHTED_FEATURE*","i"),n=this._map.getLayersByName(i),s=0;s<n.length;s++)n[s].destroy()},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap()),this.afterAfterMapMoveEvent()},addMapLayerToMap:function(){},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.service.removeWFsLayerRequests(t),this.removeMapLayerFromMap(t)},removeMapLayerFromMap:function(e){for(var t=this.getOLMapLayers(e),i=0;i<t.length;i++)t[i].destroy()},getOLMapLayers:function(e){if(!e||e.isLayerOfType("WFS")){var t="";e&&(t="_"+e.getId());var i=new RegExp("wfs_layer"+t+"_*","i");return this._map.getLayersByName(i)}},drawImageTile:function(e,t,i,n,s){var a="wfs_layer_"+e.getId()+"_"+n,r=null;if(i.bounds&&i.bounds.left&&i.bounds.right&&i.bounds.top&&i.bounds.bottom?r=new OpenLayers.Bounds(i.bounds.left,i.bounds.bottom,i.bounds.right,i.bounds.top):i.left&&i.right&&i.top&&i.bottom&&(r=new OpenLayers.Bounds(i.left,i.bottom,i.right,i.top)),t&&e&&r){var o=this.mapModule.calculateLayerScales(e.getMaxScale(),e.getMinScale()),l=null;if(!s)for(var u=this._map.getLayersByName(a),c=0;c<u.length;c++)l=this._map.getLayerIndex(u[c]),u[c].destroy();var h=new OpenLayers.Size(256,256),d=new OpenLayers.Layer.Image(a,t,r,h,{scales:o,transparent:!0,format:"image/png",isBaseLayer:!1,displayInLayerSwitcher:!0,visibility:!0,buffer:0});d.opacity=e.getOpacity()/100,this._map.addLayer(d),d.setVisibility(!0),d.redraw(!0);var p=this._map.layers.length,f=this._map.getLayersByName("Markers");f.length>0&&(this._map.setLayerIndex(f[0],p),p--),null!==l&&null!==d&&this._map.setLayerIndex(d,l);var m=new RegExp("wfs_layer_"+e.getId()+"_WFS_LAYER_IMAGE*","i"),g=this._map.getLayersByName(m);if(g.length>0){var y=this._map.getLayerIndex(g[g.length-1]),v=this._map.getLayersByName(a);v.length>0&&this._map.setLayerIndex(v[0],y)}}},handleAfterHighlightWFSFeatureRowEvent:function(e){var t=e.getWfsFeatureIds();if(0==t.length&&!e.isKeepSelection()){var i=e.getMapLayer();this.removeHighlightOnMapLayer(i.getId())}},removeHighlightOnMapLayer:function(e){var t="";e&&(t="wfs_layer_"+e);for(var i=new RegExp(t+"_HIGHLIGHTED_FEATURE*","i"),n=this._map.getLayersByName(i),s=0;s<n.length;s++)n[s].destroy()},updateWfsImages:function(){for(var e=Oskari.$().sandbox.findAllSelectedMapLayers(),t=0;t<e.length;t++)e[t].isInScale()&&e[t].isVisible()&&e[t].isLayerOfType("WFS")&&this.doWfsLayerRelatedQueries(e[t])},doWfsLayerRelatedQueries:function(e){if(e.isInScale()){var t=this._sandbox.getMap(),i=t.getBbox(),n=t.getWidth(),s=t.getHeight();this.service.scheduleWFSMapLayerUpdate(e,i,n,s,this.getName()),this.service.startPollers()}},afterAfterMapMoveEvent:function(){this.tileStrategy.update(),this._tilesLayer.redraw(),this.updateWfsImages(this.getName()),this.service.processHighlightQueue()},createTilesGrid:function(){var e=this;e._sandbox;var t=Oskari.clazz.create("Oskari.mapframework.gridcalc.TileQueue"),i=Oskari.clazz.create("Oskari.mapframework.gridcalc.QueuedTilesStrategy",{tileQueue:t});
i.debugGridFeatures=!1,this.tileQueue=t,this.tileStrategy=i;var n=new OpenLayers.StyleMap({"default":new OpenLayers.Style({pointRadius:3,strokeColor:"red",strokeWidth:2,fillColor:"#800000"}),tile:new OpenLayers.Style({strokeColor:"#008080",strokeWidth:5,fillColor:"#ffcc66",fillOpacity:.5}),select:new OpenLayers.Style({fillColor:"#66ccff",strokeColor:"#3399ff"})});this._tilesLayer=new OpenLayers.Layer.Vector("Tiles Layer",{strategies:[i],styleMap:n,visibility:!0}),this._map.addLayer(this._tilesLayer),this._tilesLayer.setOpacity(.3)},getTileQueue:function(){return this.tileQueue},_getFeatureIds:function(e){var t=this,i=this._sandbox,n=i.findAllHighlightedLayers();if(0!=n.length&&n[0]&&n[0].isLayerOfType("WFS")){if(1!=n.length)return i.printDebug("Trying to highlight WFS feature but there is either too many or none selected WFS layers. Size: "+n.length),void 0;var s=n[0];if(!s.isInScale())return i.printDebug("Trying to hightlight WFS feature from wfs layer that is not in scale!"),void 0;var a=i.getMap(),r=this._map.getExtent(),o="&flow_pm_wfsLayerId="+s.getId()+"&flow_pm_point_x="+e.lon+"&flow_pm_point_y="+e.lat+"&flow_pm_bbox_min_x="+r.left+"&flow_pm_bbox_min_y="+r.bottom+"&flow_pm_bbox_max_x="+r.right+"&flow_pm_bbox_max_y="+r.top+"&flow_pm_zoom_level="+a.getZoom()+"&flow_pm_map_width="+a.getWidth()+"&flow_pm_map_height="+a.getHeight()+"&srs="+a.getSrsName()+"&action_route=GET_HIGHLIGHT_WFS_FEATURE_IMAGE_BY_POINT",l=i.isCtrlKeyDown();jQuery.ajax({dataType:"json",type:"POST",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:i.getAjaxUrl()+o,data:o,success:function(e){t._handleGetFeatureIdsResponse(e,s,l)}})}},_handleGetFeatureIdsResponse:function(response,layer,keepCollection){var sandbox=this._sandbox;if(!response||"true"==response.error)return sandbox.printWarn("Couldn't get feature id for selected map point."),void 0;var selectedFeatures=eval("("+response.selectedFeatures+")"),featureIds=[];null!=selectedFeatures&&null!=selectedFeatures.id&&featureIds.push(selectedFeatures.id);var builder=sandbox.getEventBuilder("WFSFeaturesSelectedEvent"),event=builder(featureIds,layer,keepCollection);sandbox.notifyAll(event)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapwfs.MapWfsBundleInstance",function(){this._localization=null,this._pluginInstances={}},{__name:"MapWFS",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p)}},update:function(){},stop:function(){var e=this.sandbox;for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);this.sandbox.unregister(this),this.started=!1},init:function(){return null},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{MapClickedEvent:function(e){if(!this.sandbox.getMap().isMoving()){var t=e.getLonLat(),i=e.getMouseX(),n=e.getMouseY();this._getFeatureIds(t,i,n)}}},_getFeatureIds:function(e){var t=this,i=this.sandbox,n=i.findAllHighlightedLayers();if(0!=n.length&&n[0]&&n[0].isLayerOfType("WFS")){if(1!=n.length)throw"Trying to highlight WFS feature but there is either too many or none selected WFS layers. Size: "+n.length;var s=n[0];if(!s.isInScale())return core.printDebug("Trying to hightlight WFS feature from wfs layer that is not in scale!"),void 0;var a=i.getMap(),r=this._map.getExtent(),o="&flow_pm_wfsLayerId="+s.getId()+"&flow_pm_point_x="+e.lon+"&flow_pm_point_y="+e.lat+"&flow_pm_bbox_min_x="+r.left+"&flow_pm_bbox_min_y="+r.bottom+"&flow_pm_bbox_max_x="+r.right+"&flow_pm_bbox_max_y="+r.top+"&flow_pm_zoom_level="+a.getZoom()+"&flow_pm_map_width="+a.getWidth()+"&flow_pm_map_height="+a.getHeight()+"&srs="+a.getSrsName()+"&actionKey=GET_HIGHLIGHT_WFS_FEATURE_IMAGE_BY_POINT",l=i.isCtrlKeyDown();jQuery.ajax({dataType:"json",type:"POST",url:this.endpointUrl+o,data:o,success:function(e){t._handleGetFeatureIdsResponse(e,s,l)}})}},_handleGetFeatureIdsResponse:function(response,layer,keepCollection){var sandbox=this.sandbox;"true"==response.error&&sandbox.printWarn("Couldn't get feature id for selected map point.");var selectedFeatures=eval("("+response.selectedFeatures+")"),featureIds=[];null!=selectedFeatures&&null!=selectedFeatures.id&&(featureIds=selectedFeatures.id);var builder=sandbox.getEventBuilder("WFSFeaturesSelectedEvent"),event=builder(featureIds,layer,keepCollection);sandbox.notifyAll(event)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.MapStatsBundle",function(){},{create:function(){return null},update:function(e,t,i,n){e.alert("RECEIVED update notification "+n)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/plugin/StatsLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/domain/StatsLayer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/domain/StatsLayerModelBuilder.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/event/StatsVisualizationChangeEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/event/FeatureHighlightedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/event/HoverTooltipContentEvent.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapstats/css/mapstats.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapstats/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"mapstats","Bundle-Name":"mapstats","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"Stats",Title:"Stats"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"]}}}),Oskari.bundle_manager.installBundleClass("mapstats","Oskari.mapframework.bundle.mapstats.MapStatsBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.plugin.StatsLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this._statsDrawLayer=null,this._highlightCtrl=null,this._navCtrl=null,this._getFeatureControlHover=null,this._getFeatureControlSelect=null,this._modeVisible=!1,this.config=e,this.ajaxUrl=null,e&&e.ajaxUrl&&(this.ajaxUrl=e.ajaxUrl),e&&e.published&&(this._modeVisible=e.published)},{__name:"StatsLayerPlugin",_layerType:"STATS",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("statslayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("statslayer",null)},init:function(e){var t=(this.config?this.config.sandbox:null)||"sandbox",e=Oskari.getSandbox(t),i=e.getService("Oskari.mapframework.service.MapLayerService");if(i){i.registerLayerModel("statslayer","Oskari.mapframework.bundle.mapstats.domain.StatsLayer");var n=Oskari.clazz.create("Oskari.mapframework.bundle.mapstats.domain.StatsLayerModelBuilder",e);i.registerLayerModelBuilder("statslayer",n)}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.ajaxUrl||(this.ajaxUrl=e.getAjaxUrl()+"action_route=GetStatsTile")},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this._afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)},MapLayerVisibilityChangedEvent:function(e){this._mapLayerVisibilityChangedEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this._afterChangeMapLayerOpacityEvent(e)},AfterChangeMapLayerStyleEvent:function(){},"MapStats.StatsVisualizationChangeEvent":function(e){this._afterStatsVisualizationChangeEvent(e)},"StatsGrid.ModeChangedEvent":function(e){this._afterModeChangedEvent(e)},"StatsGrid.SelectHilightsModeEvent":function(e){this._hilightFeatures(e)},"StatsGrid.ClearHilightsEvent":function(e){this._clearHilights(e)},"MapStats.HoverTooltipContentEvent":function(e){this._afterHoverTooltipContentEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var n=e[i],s=n.getId();n.isLayerOfType(this._layerType)&&(t.printDebug("preselecting "+s),this._addMapLayerToMap(n,!0,n.isBaseLayer()))}},activateControls:function(){this._getFeatureControlHover.activate(),this._getFeatureControlSelect.activate()},deactivateControls:function(){this._getFeatureControlHover.deactivate(),this._getFeatureControlSelect.deactivate()},_afterMapLayerAddEvent:function(e){this._addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},_addMapLayerToMap:function(e,t){var i,n=this,s=n._sandbox.getEventBuilder("MapStats.FeatureHighlightedEvent");if(e.isLayerOfType(this._layerType)){var a=this._map.getLayersByName("Markers");if(a)for(var r=0;r<a.length;r++)a[r]&&this._map.removeLayer(a[r],!1);var o=this.getMapModule().calculateLayerScales(e.getMaxScale(),e.getMinScale()),l=new OpenLayers.Layer.WMS("layer_"+e.getId(),this.ajaxUrl+"&LAYERID="+e.getId(),{layers:e.getWmsName(),transparent:!0,format:"image/png"},{scales:o,isBaseLayer:!1,displayInLayerSwitcher:!1,visibility:!0,singleTile:!0,buffer:0});this._statsDrawLayer=new OpenLayers.Layer.Vector("Stats Draw Layer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillOpacity:0,strokeOpacity:0}),temporary:new OpenLayers.Style({strokeColor:"#ff6666",strokeOpacity:1,strokeWidth:3,fillColor:"#ff0000",fillOpacity:0,graphicZIndex:2,cursor:"pointer"}),select:new OpenLayers.Style({})})}),this._map.addLayers([this._statsDrawLayer]),this._statsDrawLayer.events.register("moveend",this._statsDrawLayer,function(){n.mapModule.notifyMoveEnd()}),this._highlightCtrl=new OpenLayers.Control.SelectFeature(this._statsDrawLayer,{hover:!0,highlightOnly:!0,renderIntent:"temporary"}),this._map.addControl(this._highlightCtrl),this._highlightCtrl.activate(),this._navCtrl=new OpenLayers.Control.Navigation,this._map.addControl(this._navCtrl);var u=[l];if(this._getFeatureControlHover=new OpenLayers.Control.WMSGetFeatureInfo({drillDown:!1,hover:!0,handlerOptions:{hover:{delay:0},stopSingle:!1},infoFormat:"application/vnd.ogc.gml",layers:u,eventListeners:{getfeatureinfo:function(e){var t=n._map.getLayersByName("Stats Draw Layer")[0];if("undefined"!=typeof t){if(0===e.features.length){for(var i=0;i<t.features.length;i++)t.features[i].selected||t.removeFeatures([t.features[i]]);return n._removePopup(),void 0}for(var s=!1,a="kuntakoodi",i=0;i<t.features.length;i++)t.features[i].attributes[a]===e.features[0].attributes[a]?s=!0:t.features[i].selected||t.removeFeatures([t.features[i]]);s||(t.addFeatures([e.features[0]]),n._highlightCtrl.highlight(e.features[0]),n._removePopup(),n._addPopup(e)),t.redraw()}},beforegetfeatureinfo:function(){},nogetfeatureinfo:function(){}}}),this._map.addControl(this._getFeatureControlHover),this._modeVisible&&this._getFeatureControlHover.activate(),this._getFeatureControlSelect=new OpenLayers.Control.WMSGetFeatureInfo({drillDown:!0,hover:!1,handlerOptions:{click:{delay:0},pixelTolerance:5},infoFormat:"application/vnd.ogc.gml",layers:u,eventListeners:{getfeatureinfo:function(e){if(0!==e.features.length){var t=e.features[0],a=n._map.getLayersByName("Stats Draw Layer")[0];if("undefined"!=typeof a){for(var r=-1,o="kuntakoodi",l=0;l<a.features.length;l++)if(a.features[l].attributes[o]===e.features[0].attributes[o]){r=l;break}var u=OpenLayers.Util.applyDefaults(u,OpenLayers.Feature.Vector.style["default"]);u.fillColor="#ff0000",u.strokeColor="#ff3333",u.strokeWidth=3,u.fillOpacity=.2,r>=0?(a.features[l].selected=!a.features[l].selected,a.features[l].selected?a.features[l].style=u:(a.features[l].style=null,n._highlightCtrl.highlight(a.features[l])),s&&(i=s(a.features[l],a.features[l].selected,"click"))):(a.addFeatures([t]),t.selected=!0,t.style=u,s&&(i=s(t,t.selected,"click"))),a.redraw(),i&&n._sandbox.notifyAll(i)}}},beforegetfeatureinfo:function(){},nogetfeatureinfo:function(){}}}),this._map.addControl(this._getFeatureControlSelect),this._modeVisible&&this._getFeatureControlSelect.activate(),l.opacity=e.getOpacity()/100,this._map.addLayer(l),this._sandbox.printDebug("#!#! CREATED OPENLAYER.LAYER.WMS for StatsLayer "+e.getId()),t?this._map.setLayerIndex(l,this._map.layers.length):this._map.setLayerIndex(l,0),a)for(var r=0;r<a.length;r++)a[r]&&this._map.addLayer(a[r])}},_afterModeChangedEvent:function(e){this._modeVisible=e.isModeVisible();var t=this._map.getLayersByName("Stats Draw Layer")[0];this._modeVisible?this.activateControls():(this.deactivateControls(),t&&t.removeAllFeatures(),this._removePopup())},_clearHilights:function(){var e=this._map.getLayersByName("Stats Draw Layer")[0];if(e)for(var t=0;t<e.features.length;t++)e.features[t].style=null,this._highlightCtrl.highlight(e.features[t]);e.redraw(),this._removePopup()},_hilightFeatures:function(e){var t=e.getCodes(),i=this._map.getLayersByName("Stats Draw Layer")[0];if("undefined"!=typeof i){var n="kuntakoodi",s=OpenLayers.Util.applyDefaults(s,OpenLayers.Feature.Vector.style["default"]);s.fillColor="#ff0000",s.strokeColor="#ff3333",s.strokeWidth=3,s.fillOpacity=.2;for(var a in t)for(var r=0;r<i.features.length;r++)if(i.features[r].attributes[n]===a&&t[a]){i.features[r].style=s,this._highlightCtrl.highlight(i.features[r]);break}i.redraw()}},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();t.isLayerOfType(this._layerType)&&(this._removeMapLayerFromMap(t),this._highlightCtrl.deactivate(),this._getFeatureControlHover.deactivate(),this._getFeatureControlSelect.deactivate(),this._map.removeControl(this._highlightCtrl),this._map.removeControl(this._navCtrl),this._map.removeControl(this._getFeatureControlHover),this._map.removeControl(this._getFeatureControlSelect),this._map.removeLayer(this._statsDrawLayer))},_mapLayerVisibilityChangedEvent:function(e){var t=e.getMapLayer();"STATS"===t._layerType&&(this._statsDrawLayer.setVisibility(t.isVisible()),this._modeVisible&&(t.isVisible()?(this._getFeatureControlHover.activate(),this._getFeatureControlSelect.activate()):(this._getFeatureControlHover.deactivate(),this._getFeatureControlSelect.deactivate())))},_removeMapLayerFromMap:function(e){if(e.isLayerOfType(this._layerType)){var t=this.getOLMapLayers(e);t[0].destroy()}},getOLMapLayers:function(e){return e.isLayerOfType(this._layerType)?this._map.getLayersByName("layer_"+e.getId()):null},_removePopup:function(e){e=e||this._popup,e&&this._map.removePopup(e)},_addPopup:function(e){var t=e.features[0].attributes.kuntanimi;this._popup=new OpenLayers.Popup("mapstatsHover",this._map.getLonLatFromPixel(new OpenLayers.Pixel(e.xy.x+5,e.xy.y+5)),new OpenLayers.Size(100,100),t),this._popup.autoSize=!0,this._popup.opacity=.8,this._map.addPopup(this._popup);var i=this._sandbox.getRequestBuilder("StatsGrid.TooltipContentRequest");if(i){var n=i(e.features[0]);this._sandbox.request(this,n)}},_afterHoverTooltipContentEvent:function(e){var t=e.getContent();this._popup&&this._popup.setContentHTML(t)},_afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType(this._layerType)){this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var i=this.getOLMapLayers(t);null!=i[0]&&i[0].setOpacity(t.getOpacity()/100)}},_afterChangeMapLayerStyleEvent:function(e){var t=e.getMapLayer(),i=this.getOLMapLayers(t);null!=i&&i[0].mergeNewParams({VIS_ID:t.getCurrentStyle().getName(),VIS_NAME:"ows:Kunnat2013",VIS_ATTR:"Kuntakoodi",VIS_CLASSES:"020,091|186,086,982|111,139,740",VIS_COLORS:"choro:ccffcc|99cc99|669966"})},_afterStatsVisualizationChangeEvent:function(e){var t=e.getLayer(),i=e.getParams(),n=this.getOLMapLayers(t);null!=n&&n[0].mergeNewParams({VIS_ID:i.VIS_ID,VIS_NAME:i.VIS_NAME,VIS_ATTR:i.VIS_ATTR,VIS_CLASSES:i.VIS_CLASSES,VIS_COLORS:i.VIS_COLORS})}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.domain.StatsLayer",function(){this._layerType="STATS"},{setWmsName:function(e){this._wmsName=e},getWmsName:function(){return this._wmsName},setFilterPropertyName:function(e){this._filterPropertyName=e},getFilterPropertyName:function(){return this._filterPropertyName}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.domain.StatsLayerModelBuilder",function(e){this.localization=Oskari.getLocalization("MapStats"),this.sandbox=e},{parseLayerData:function(e,t){var i=this;e.setWmsName(t.wmsName),t.visualizations&&e.setFilterPropertyName(t.visualizations[0].filterproperty);var n=Oskari.clazz.builder("Oskari.mapframework.domain.Tool"),s=n(),a=i.localization.tools.table_icon;if(s.setName("table_icon"),s.setTitle(a.title),s.setTooltip(a.tooltip),s.setCallback(function(){i.sandbox.postRequestByName("StatsGrid.StatsGridRequest",[!0,e])}),e.addTool(s),e.getMetadataIdentifier()){var r=n();r.setName("info_icon"),r.setIconCls("icon-info"),r.setCallback(function(){var t="catalogue.ShowMetadataRequest",n=e.getMetadataIdentifier(),s=[],a={};a[n]=!0;var r=e.getSubLayers();if(r&&r.length>0)for(var o=0;o<r.length;o++){var l=r[o].getMetadataIdentifier();l&&""!=l&&!a[l]&&(a[l]=!0,s.push({uuid:l}))}i.sandbox.postRequestByName(t,[{uuid:n},s])})}e.addTool(r)}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.event.StatsVisualizationChangeEvent",function(e,t){this._layer=e,this._params=t},{getName:function(){return"MapStats.StatsVisualizationChangeEvent"},getLayer:function(){return this._layer},getParams:function(){return this._params}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.event.FeatureHighlightedEvent",function(e,t,i){this._feature=e,this._highlighted=t,this._highlightType=i},{getName:function(){return"MapStats.FeatureHighlightedEvent"},getFeature:function(){return this._feature},isHighlighted:function(){return this._highlighted},getHighlighType:function(){return this._highlightType}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapstats.event.HoverTooltipContentEvent",function(e){this._content=e},{getName:function(){return"MapStats.HoverTooltipContentEvent"},getContent:function(){return this._content}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.MapAnalysisBundle",function(){},{create:function(){return null},update:function(e,t,i,n){e.alert("RECEIVED update notification "+n)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapanalysis/plugin/AnalysisLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapanalysis/domain/AnalysisLayer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapanalysis/domain/AnalysisLayerModelBuilder.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapanalysis/event/AnalysisVisualizationChangeEvent.js"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapanalysis/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapanalysis/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/mapanalysis/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"mapanalysis","Bundle-Name":"mapanalysis","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"Analysis",Title:"Analysis"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"]}}}),Oskari.bundle_manager.installBundleClass("mapanalysis","Oskari.mapframework.bundle.mapanalysis.MapAnalysisBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.plugin.AnalysisLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this.wfsLayerPlugin=null,this._sandbox=null,this._map=null,this._supportedFormats={},this.config=e,this.ajaxUrl=null,e&&e.ajaxUrl&&(this.ajaxUrl=e.ajaxUrl)},{__name:"AnalysisLayerPlugin",_layerType:"ANALYSIS",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("analysislayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("analysislayer",null)},init:function(e){var t=(this.config?this.config.sandbox:null)||"sandbox",e=Oskari.getSandbox(t),i=e.getService("Oskari.mapframework.service.MapLayerService");if(i){i.registerLayerModel("analysislayer","Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayer");var n=Oskari.clazz.create("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayerModelBuilder",e);i.registerLayerModelBuilder("analysislayer",n)}this.wfsLayerPlugin=e.findRegisteredModuleInstance("MainMapModuleWfsLayerPlugin")},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.ajaxUrl||(this.ajaxUrl=e.getAjaxUrl()+"action_route=GetAnalysis?")},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapMoveEvent:function(){},WFSFeaturesSelectedEvent:function(){},MapClickedEvent:function(){},GetInfoResultEvent:function(){},AfterChangeMapLayerStyleEvent:function(){},MapLayerVisibilityChangedEvent:function(){},MapSizeChangedEvent:function(){},WFSSetFilter:function(){},AfterMapLayerAddEvent:function(e){this._afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this._afterChangeMapLayerOpacityEvent(e)},"MapAnalysis.AnalysisVisualizationChangeEvent":function(e){this._afterAnalysisVisualizationChangeEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var n=e[i],s=n.getId();n.isLayerOfType(this._layerType)&&(t.printDebug("preselecting "+s),this._addMapLayerToMap(n,!0,n.isBaseLayer()))}},_afterMapLayerAddEvent:function(e){this._addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},_addMapLayerToMap:function(e,t){if(e.isLayerOfType(this._layerType)){var i=this._map.getLayersByName("Markers");if(i)for(var n=0;n<i.length;n++)i[n]&&this._map.removeLayer(i[n],!1);var s="layer_"+e.getId(),a=e.getWpsUrl()+"wpsLayerId="+e.getWpsLayerId(),r=this.getMapModule().calculateLayerScales(e.getMaxScale(),e.getMinScale()),o=new OpenLayers.Layer.WMS(s,a,{layers:e.getWpsName(),transparent:!0,format:"image/png"},{scales:r,isBaseLayer:!1,displayInLayerSwitcher:!1,visibility:!0,singleTile:!0,buffer:0});if(o.opacity=e.getOpacity()/100,this._map.addLayer(o),this._sandbox.printDebug("#!#! CREATED OPENLAYER.LAYER.WMS for AnalysisLayer "+e.getId()),t?this._map.setLayerIndex(o,this._map.layers.length):this._map.setLayerIndex(o,0),i)for(var n=0;n<i.length;n++)i[n]&&this._map.addLayer(i[n])}},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();t.isLayerOfType(this._layerType)&&this._removeMapLayerFromMap(t)},_removeMapLayerFromMap:function(e){if(e.isLayerOfType(this._layerType)){var t=this.getOLMapLayers(e);t[0].destroy()}},getOLMapLayers:function(e){return e.isLayerOfType(this._layerType)?this._map.getLayersByName("layer_"+e.getId()):null},_afterChangeMapLayerOpacityEvent:function(){},_afterAnalysisVisualizationChangeEvent:function(e){var t=e.getLayer();e.getParams(),this.getOLMapLayers(t)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayer",function(){this._layerType="ANALYSIS",this._metaType="ANALYSIS"},{setWpsUrl:function(e){this._wpsUrl=e},getWpsUrl:function(){return this._wpsUrl},setWpsName:function(e){this._wpsName=e},getWpsName:function(){return this._wpsName},setWpsLayerId:function(e){this._wpsLayerId=e},getWpsLayerId:function(){return this._wpsLayerId}},{extend:["Oskari.mapframework.bundle.mapwfs2.domain.WFSLayer"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayerModelBuilder",function(e){this.localization=Oskari.getLocalization("MapAnalysis"),this.sandbox=e,this.wfsBuilder=Oskari.clazz.create("Oskari.mapframework.bundle.mapwfs2.domain.WfsLayerModelBuilder",e)},{parseLayerData:function(e,t,i){var n=this,s=n.localization.layer;this.wfsBuilder.parseLayerData(e,t,i),t.fields&&e.setFields(t.fields),t.locales&&e.setLocales(t.locales),t.name&&e.setName(t.name),t.wpsName&&e.setWpsName(t.wpsName),t.wpsUrl&&e.setWpsUrl(t.wpsUrl),t.wpsLayerId&&e.setWpsLayerId(t.wpsLayerId),s.organization&&e.setOrganizationName(s.organization),s.inspire&&e.setInspireName(s.inspire)}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.event.AnalysisVisualizationChangeEvent",function(e,t){this._layer=e,this._params=t},{getName:function(){return"MapAnalysis.AnalysisVisualizationChangeEvent"},getLayer:function(){return this._layer},getParams:function(){return this._params}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.service.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/service/service.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"service-base","Bundle-Name":"mapframework.service.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.service.Bundle",Title:" mapframework.service.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("service-base","Oskari.mapframework.service.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.service.Service",function(){throw"mapframework.service.Service should not be used"},{getName:function(){throw"Running default implementation of Service.getName(). implement your own!"}}),Oskari.clazz.define("Oskari.mapframework.event.map.layer.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/event/common/after-rearrange-selected-map-layer-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-change-map-layer-opacity-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-change-map-layer-style-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-highlight-map-layer-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-dim-map-layer-event.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"event-map-layer","Bundle-Name":"mapframework.event.map.layer.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.event.Bundle",Title:" mapframework.event.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("event-map-layer","Oskari.mapframework.event.map.layer.Bundle"),Oskari.clazz.define("Oskari.mapframework.event.common.AfterRearrangeSelectedMapLayerEvent",function(e,t,i){this._creator=null,this._movedMapLayer=e,this._fromPosition=t,this._toPosition=i},{__name:"AfterRearrangeSelectedMapLayerEvent",getName:function(){return this.__name},getMovedMapLayer:function(){return this._movedMapLayer},getFromPosition:function(){return this._fromPosition},getToPosition:function(){return this._toPosition}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterChangeMapLayerOpacityEvent",function(e){this._mapLayer=e},{__name:"AfterChangeMapLayerOpacityEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterChangeMapLayerStyleEvent",function(e){this._mapLayer=e},{__name:"AfterChangeMapLayerStyleEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterHighlightMapLayerEvent",function(e){this._creator=null,this._mapLayer=e},{__name:"AfterHighlightMapLayerEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterDimMapLayerEvent",function(e){this._creator=null,this._mapLayer=e},{__name:"AfterDimMapLayerEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.request.map.layer.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/request/common/rearrange-selected-map-layer-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/change-map-layer-opacity-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/change-map-layer-style-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/highlight-map-layer-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/dim-map-layer-request.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"request-map-layer","Bundle-Name":"mapframework.request.map.layer.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.request.Bundle",Title:" mapframework.request.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("request-map-layer","Oskari.mapframework.request.map.layer.Bundle"),Oskari.clazz.define("Oskari.mapframework.request.common.RearrangeSelectedMapLayerRequest",function(e,t){this._mapLayerId=e,this._toPosition=t
},{__name:"RearrangeSelectedMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId},getToPosition:function(){return this._toPosition}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.ChangeMapLayerOpacityRequest",function(e,t){this._creator=null,this._mapLayerId=e,this._opacity=t},{__name:"ChangeMapLayerOpacityRequest",getName:function(){return this.__name},getOpacity:function(){return this._opacity},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.ChangeMapLayerStyleRequest",function(e,t){this._creator=null,this._mapLayerId=e,this._style=t},{__name:"ChangeMapLayerStyleRequest",getName:function(){return this.__name},getStyle:function(){return this._style},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.HighlightMapLayerRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"HighlightMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.DimMapLayerRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"DimMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.PluginMapModuleBundle",function(){},{create:function(){return this},update:function(e,t,i,n){e.alert("RECEIVED update notification "+n)}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/ui/module/map-module.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/Plugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/ControlsPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/PorttiKeyboard.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/PorttiMouse.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/DisableMapKeyboardMovementRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/DisableMapMouseMovementRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/EnableMapKeyboardMovementRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/EnableMapMouseMovementRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapMovementControlsRequestHandler.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/show-map-measurement-request.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/getinfo/GetFeatureInfoHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/GetFeatureInfoRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/GetFeatureInfoActivationRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/getinfo/GetInfoPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/getinfo/css/getinfo.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/markers/MarkersPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/RemoveMarkerRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MarkerRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/search/SearchPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/service/searchservice.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/search/css/search.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/logo/LogoPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/logo/css/logoplugin.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/datasource/DataSourcePlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/datasource/css/datasource.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/indexmap/IndexMapPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/indexmap/css/indexmap.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/scalebar/ScaleBarPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/fullscreen/FullScreen.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/fullscreen/css/fullscreen.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/layers/LayerSelectionPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/layers/css/layersselection.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/layers/LayersPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapLayerVisibilityRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapLayerVisibilityRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapMoveByLayerContentRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapMoveByLayerContentRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/MapLayerVisibilityChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/wmslayer/WmsLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/vectorlayer/VectorLayerPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/location/GeoLocationPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/ToolSelectionRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/ToolSelectionHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapLayerUpdateRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapLayerUpdateRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/MapMoveRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/MapClickedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/EscPressedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/GetInfoResultEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/event/MapSizeChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/request/ClearHistoryRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/controls/ClearHistoryHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/zoombar/Portti2Zoombar.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/portti2zoombar/css/porttizoombar.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/plugin/panbuttons/PanButtons.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/plugin/panbuttons/css/panbuttons.css"},{type:"text/css",src:"../../../../resources/framework/bundle/mapmodule-plugin/css/mapmodule.css"}],locales:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/fi.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/sv.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/en.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/cs.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/de.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapmodule-plugin/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"mapmodule-plugin","Bundle-Name":"mapmodule","Bundle-Tag":{mapframework:!0},"Bundle-Icon":{href:"icon.png"},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"Kartta",Title:"Kartta"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","Ext","OpenLayers"]}}}),Oskari.bundle_manager.installBundleClass("mapmodule-plugin","Oskari.mapframework.bundle.PluginMapModuleBundle"),Oskari.clazz.define("Oskari.mapframework.ui.module.common.MapModule",function(e,t,i){if(this._id=e,this._imageUrl=t,this._options={resolutions:[2e3,1e3,500,200,100,50,20,10,4,2,1,.5,.25],srsName:"EPSG:3067",units:"m"},i)for(var n in i)this._options[n]=i[n];this._controls={},this._layerPlugins={},this._supportedFormats={},this._map=null,this._mapScales=[],this._sandbox=null,this._stealth=!1,this._pluginInstances={},this._navigationHistoryTool=new OpenLayers.Control.NavigationHistory,this._navigationHistoryTool.id="navigationhistory",this._localization=null},{getImageUrl:function(){return this._imageUrl?this._imageUrl:"/Oskari/resources"},getControls:function(){return this._controls},getMapControl:function(e){return this._controls[e]},addMapControl:function(e,t){this._controls[e]=t,this._map.addControl(t)},removeMapControl:function(e){this._map.removeControl(this._controls[e]),this._controls[e]=null,delete this._controls[e]},setLayerPlugin:function(e,t){this._layerPlugins[e]=t},getLayerPlugin:function(e){return this._layerPlugins[e]},getLayerPlugins:function(){return this._layerPlugins},clearNavigationHistory:function(){this._navigationHistoryTool.clear()},getName:function(){return this._id+"MapModule"},getSandbox:function(){return this._sandbox},getLocalization:function(e,t){return this._localization&&t!==!0||(this._localization=Oskari.getLocalization("MapModule")),e?this._localization[e]:this._localization},init:function(e){e.printDebug("Initializing map module...#############################################"),this._sandbox=e,this._sandbox&&this._sandbox.getMap().setSrsName(this._options.srsName);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.requestHandlers={mapLayerUpdateHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapLayerUpdateRequestHandler",e,this),mapMoveRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapMoveRequestHandler",e,this),clearHistoryHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.controls.ClearHistoryHandler",e,this)},e.addRequestHandler("MapModulePlugin.MapLayerUpdateRequest",this.requestHandlers.mapLayerUpdateHandler),e.addRequestHandler("MapMoveRequest",this.requestHandlers.mapMoveRequestHandler),e.addRequestHandler("ClearHistoryRequest",this.requestHandlers.clearHistoryHandler),this._createMap();for(var t=0;t<this._options.resolutions.length;++t){var i=OpenLayers.Util.getScaleFromResolution(this._options.resolutions[t],this._map.units);i=1e8*i,i=Math.round(i),i/=1e8,this._mapScales.push(i)}return this._createBaseLayer(),this.addMapControl("navigationHistoryTool",this._navigationHistoryTool),this.getMapControl("navigationHistoryTool").activate(),this._map},getPluginInstances:function(){return this._pluginInstances},getPluginInstance:function(e){return this._pluginInstances[this.getName()+e]},isPluginActivated:function(e){var t=this._pluginInstances[this.getName()+e];return t?!0:!1},registerPlugin:function(e){var t=this._sandbox;e.setMapModule(this);var i=e.getName();t.printDebug("["+this.getName()+"]"+" Registering "+i),e.register(),this._pluginInstances[i]=e},unregisterPlugin:function(e){var t=this._sandbox,i=e.getName();t.printDebug("["+this.getName()+"]"+" Unregistering "+i),e.unregister(),this._pluginInstances[i]=void 0,e.setMapModule(null),delete this._pluginInstances[i]},startPlugin:function(e){var t=this._sandbox,i=e.getName();t.printDebug("["+this.getName()+"]"+" Starting "+i),e.startPlugin(t)},stopPlugin:function(e){var t=this._sandbox,i=e.getName();t.printDebug("["+this.getName()+"]"+" Starting "+i),e.stopPlugin(t)},startPlugins:function(e){for(var t in this._pluginInstances)e.printDebug("["+this.getName()+"]"+" Starting "+t),this._pluginInstances[t].startPlugin(e)},stopPlugins:function(e){for(var t in this._pluginInstances)e.printDebug("["+this.getName()+"]"+" Starting "+t),this._pluginInstances[t].stopPlugin(e)},getStealth:function(){return this._stealth},setStealth:function(e){this._stealth=1==e},notifyAll:function(e,t){this._stealth||this._sandbox.notifyAll(e,t)},getMap:function(){return this._map},getMapViewPortDiv:function(){return this._map.viewPortDiv},getMapLayersContainerDiv:function(){return this._map.layerContainerDiv},transformCoordinates:function(e,t){return e.transform(new OpenLayers.Projection(t),this.getMap().getProjectionObject())},_createMap:function(){this._sandbox;var e=new OpenLayers.LonLat(0,0),t=new OpenLayers.Bounds(0,0,1e7,1e7);return null!=this._options&&null!=this._options.maxExtent&&null!=this._options.maxExtent.left&&null!=this._options.maxExtent.bottom&&null!=this._options.maxExtent.right&&null!=this._options.maxExtent.top&&(t=new OpenLayers.Bounds(this._options.maxExtent.left,this._options.maxExtent.bottom,this._options.maxExtent.right,this._options.maxExtent.top)),this._map=new OpenLayers.Map({controls:[],units:this._options.units,maxExtent:t,resolutions:this._options.resolutions,projection:this._options.srsName,isBaseLayer:!0,center:e,theme:null,zoom:0}),this._map},getProjection:function(){return this._options.srsName},_createBaseLayer:function(){var e=new OpenLayers.Layer("BaseLayer",{layerId:0,isBaseLayer:!0,displayInLayerSwitcher:!1});this._map.addLayer(e)},moveMapToLanLot:function(e,t,i){var n=i===!0;this._map.setCenter(e,this._map.getZoom(),n),t&&this.adjustZoomLevel(t,!0),this._updateDomain()},panMapToLonLat:function(e,t){this._map.setCenter(e,this._map.getZoom()),this._updateDomain(),t!==!0&&this.notifyMoveEnd()},zoomToScale:function(e,t,i){var n=t===!0;this._map.zoomToScale(e,n),this._updateDomain(),i!==!0&&this.notifyMoveEnd()},centerMap:function(e,t,i){this._map.setCenter(e,t,!1),this._updateDomain(),i!==!0&&this.notifyMoveEnd()},zoomIn:function(){this.adjustZoomLevel(1)},zoomOut:function(){this.adjustZoomLevel(-1)},zoomTo:function(e){this.setZoomLevel(e,!1)},panMapEast:function(){var e=this._map.getSize();this.panMapByPixels(.75*e.w,0)},panMapWest:function(){var e=this._map.getSize();this.panMapByPixels(-.75*e.w,0)},panMapNorth:function(){var e=this._map.getSize();this.panMapByPixels(0,-.75*e.h)},panMapSouth:function(){var e=this._map.getSize();this.panMapByPixels(0,.75*e.h)},panMapByPixels:function(e,t,i,n,s){this._map.pan(e,t,{dragging:s?!0:!1,animate:!1}),this._updateDomain(),i!==!0&&this.notifyStartMove(),n!==!0&&this.notifyMoveEnd()},moveMapByPixels:function(e,t,i,n){this._map.moveByPx(e,t),this._updateDomain(),i!==!0&&this.notifyStartMove(),n!==!0&&this.notifyMoveEnd()},centerMapByPixels:function(e,t,i,n){var s=new OpenLayers.Pixel(e,t),a=this._map.getLonLatFromViewPortPx(s);this.isValidLonLat(a.lon,a.lat)&&(this.moveMapToLanLot(a),i!==!0&&this.notifyStartMove(),n!==!0&&this.notifyMoveEnd())},isValidLonLat:function(e,t){var i=!0;return 625e4>t||t>82e5?i=!1:((0>e||e>135e4)&&(i=!1),i)},zoomToExtent:function(e,t,i){this._map.zoomToExtent(e),this._updateDomain(),t!==!0&&this.notifyStartMove(),i!==!0&&this.notifyMoveEnd()},adjustZoomLevel:function(e,t){var i=this._getNewZoomLevel(e);this._map.zoomTo(i),this._updateDomain(),t!==!0&&this.notifyMoveEnd()},setZoomLevel:function(e,t){e!=this._map.getZoom()&&((0>e||e>this._map.getNumZoomLevels)&&(e=this._map.getZoom()),this._map.zoomTo(e),this._updateDomain(),t!==!0&&this.notifyMoveEnd())},_getNewZoomLevel:function(e){var t=this._map.getZoom()+e;return t>=0&&t<=this._map.getNumZoomLevels()?t:this._map.getZoom()},notifyStartMove:function(){if(!this.getStealth()){this._sandbox.getMap().setMoving(!0);var e=this._map.getCenter().lon,t=this._map.getCenter().lat,i=this._sandbox.getEventBuilder("MapMoveStartEvent")(e,t);this._sandbox.notifyAll(i)}},notifyMoveEnd:function(){if(!this.getStealth()){var e=this._sandbox;e.getMap().setMoving(!1);var t=this._map.getCenter();this._updateDomain();var i=e.getEventBuilder("AfterMapMoveEvent")(t.lon,t.lat,this._map.getZoom(),!1,this._map.getScale());e.notifyAll(i)}},updateSize:function(){this.getMap().updateSize(),this._updateDomain();var e=this._sandbox,t=e.getMap(),i=e.getEventBuilder("MapSizeChangedEvent")(t.getWidth(),t.getHeight());e.notifyAll(i)},_updateDomain:function(){if(!this.getStealth()){var e=this._sandbox,t=e.getMap(),i=this._map.getCenter();t.moveTo(i.lon,i.lat,this._map.getZoom()),t.setScale(this._map.getScale());var n=this._map.getCurrentSize();t.setWidth(n.w),t.setHeight(n.h),t.setResolution(this._map.getResolution()),t.setExtent(this._map.getExtent()),t.setMaxExtent(this._map.getMaxExtent()),t.setBbox(this._map.calculateBounds())}},getMapScales:function(){return this._mapScales},calculateLayerScales:function(e,t){for(var i=[],n=0;n<this._mapScales.length;n++)(!t||t>=this._mapScales[n])&&(!e||e<=this._mapScales[n])&&i.push(this._mapScales[n]);return i},calculateLayerResolutions:function(e,t){for(var i=[],n=0;n<this._mapScales.length;n++)(!t||t>=this._mapScales[n])&&(!e||e<=this._mapScales[n])&&i.push(this._options.resolutions[n]);return i},getClosestZoomLevel:function(e,t){var i=this._map.getZoom();if(!t||!e)return i;var n=this._map.getScale();if(t>n){for(var s=i;s>0;s--)if(this._mapScales[s]>=t)return s}else if(n>e)for(var s=i;s<this._mapScales.length;s++)if(this._mapScales[s]<=e)return s;return i},start:function(e){this.started||(e.printDebug("Starting "+this.getName()),this.startPlugins(e),this.updateCurrentState(),this.started=!0)},stop:function(e){this.started&&(this.stopPlugins(e),this.started=!1)},_drawMarker:function(){this._removeMarkers();var e=this._map.getCenter(),t=new OpenLayers.Layer.Markers("Markers");this._map.addLayer(t);var i=new OpenLayers.Size(32,32),n=new OpenLayers.Pixel(-16,-i.h),s=new OpenLayers.Icon(this.getImageUrl()+"/framework/bundle/mapmodule-plugin/images/marker.png",i,n),a=new OpenLayers.Marker(e,s);t.addMarker(a)},_removeMarkers:function(){var e=this._map.getLayersByName("Markers");if(e)for(var t=0;t<e.length;t++)e[t]&&this._map.removeLayer(e[t],!1)},_hasMarkers:function(){var e=this._map.getLayersByName("Markers");if(e)for(var t=0;t<e.length;t++)if(e[t]&&e[t].markers&&e[t].markers.length>0)return!0;return!1},eventHandlers:{SearchClearedEvent:function(){this._removeMarkers()}},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},getOLMapLayers:function(e){var t=this,i=t._sandbox,n=i.findMapLayerFromSelectedMapLayers(e);if(!n)return null;var s=this.getLayerPlugins();for(var a in s){var r=s[a],o=r.getOLMapLayers(n);if(o)return o}return null},updateCurrentState:function(){var e=this,t=e._sandbox,i=t.findAllSelectedMapLayers(),n=this.getLayerPlugins();for(p in n){var s=n[p];t.printDebug("preselecting "+p),s.preselectLayers(i)}},changeCssClasses:function(e,t,i){var n,s,a;for(n=0;n<i.length;n++)a=i[n],a.removeClass(function(e,i){var n="",a=i.split(" ");for(s=0;s<a.length;++s)t.test(a[s])&&(n+=a[s]+" ");return n}),a.addClass(e)}},{protocol:["Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.ui.module.common.mapmodule.Plugin",function(){throw"Oskari.mapframework.ui.module.common.mapmodule.Plugin should not be instantiated"},{getName:function(){throw"Implement your own"},setMapModule:function(){throw"Implement your own"},register:function(){throw"Implement your own"},unregister:function(){throw"Implement your own"},startPlugin:function(){throw"Implement your own"},stopPlugin:function(){throw"Implement your own"},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}}),Oskari.clazz.define("Oskari.mapframework.mapmodule.ControlsPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.conf=e||{}},{__name:"ControlsPlugin",getName:function(){return this.pluginName},hasUI:function(){return!0},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name,this._createMapControls())},register:function(){},unregister:function(){},init:function(e){var t=this,i=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapMovementControlsRequestHandler",t.getMapModule());this.requestHandlers={ToolSelectionRequest:Oskari.clazz.create("Oskari.mapframework.mapmodule.ToolSelectionHandler",e,t),EnableMapKeyboardMovementRequest:i,DisableMapKeyboardMovementRequest:i,EnableMapMouseMovementRequest:i,DisableMapMouseMovementRequest:i}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(var t in this.requestHandlers)e.addRequestHandler(t,this.requestHandlers[t]);for(var i in this.eventHandlers)e.registerForEventByName(this,i);this._addMapControls()},stopPlugin:function(e){for(var t in this.requestHandlers)e.removeRequestHandler(t,this.requestHandlers[t]);for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._removeMapControls(),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{"Toolbar.ToolSelectedEvent":function(){this.conf.zoomBox!==!1&&this._zoomBoxTool.deactivate(),this.conf.measureControls!==!1&&(this._measureControls.line.deactivate(),this._measureControls.area.deactivate())}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_addMapControls:function(){this.conf.zoomBox!==!1&&(this.getMapModule().addMapControl("zoomBoxTool",this._zoomBoxTool),this._zoomBoxTool.deactivate()),this.getMapModule().addMapControl("keyboardControls",this._keyboardControls),this.getMapModule().getMapControl("keyboardControls").activate(),this.conf.measureControls!==!1&&(this.getMapModule().addMapControl("measureControls_line",this._measureControls.line),this._measureControls.line.deactivate(),this.getMapModule().addMapControl("measureControls_area",this._measureControls.area),this._measureControls.area.deactivate()),this.getMapModule().addMapControl("mouseControls",this._mouseControls)},_removeMapControls:function(){this.conf.zoomBox!==!1&&(this._zoomBoxTool.deactivate(),this.getMapModule().removeMapControl("zoomBoxTool",this._zoomBoxTool)),this._keyboardControls.deactivate(),this.getMapModule().removeMapControl("keyboardControls",this._keyboardControls),this.conf.measureControls!==!1&&(this._measureControls.line.deactivate(),this._measureControls.area.deactivate(),this.getMapModule().removeMapControl("measureControls_line",this._measureControls.line),this.getMapModule().removeMapControl("measureControls_area",this._measureControls.area)),this._mouseControls.deactivate(),this.getMapModule().removeMapControl("mouseControls",this._mouseControls)},_createMapControls:function(){function e(e,i){var n=t._sandbox,s=e.geometry,a=e.units,r=e.order,o=e.measure,l=null;1===r?l=o.toFixed(3)+" "+a:2===r&&(l=o.toFixed(3)+" "+a+"<sup>2</sup>");var u=null,c=null;if(i&&OpenLayers.Format.GeoJSON){var h=new OpenLayers.Format.GeoJSON;u=h.write(s,!0),c="application/json"}n.request(t,n.getRequestBuilder("ShowMapMeasurementRequest")(l,i,u,c))}var t=this;if(t._sandbox,!this._zoomBoxTool){this.conf.zoomBox!==!1&&(OpenLayers.Control.ZoomBox.prototype.draw=function(){this.handler=new OpenLayers.Handler.Box(this,{done:function(e){this.zoomBox(e),t.getMapModule()&&t.getMapModule().notifyMoveEnd()}},{keyMask:this.keyMask})},this._zoomBoxTool=new OpenLayers.Control.ZoomBox({alwaysZoom:!0})),this.conf.keyboardControls!==!1&&(this._keyboardControls=new OpenLayers.Control.PorttiKeyboard,this._keyboardControls.setup(this.getMapModule()));var i={handlerOptions:{persist:!0},immediate:!0},n={handlerOptions:{persist:!0},immediate:!0};this._measureControls={},this.conf.measureControls!==!1&&(this._measureControls={line:new OpenLayers.Control.Measure(OpenLayers.Handler.Path,i),area:new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,n)});for(var s in this._measureControls){var a=this._measureControls[s];a.events.on({measure:function(t){e(t,!0)},measurepartial:function(t){e(t,!1)}})}this.conf.mouseControls!==!1&&(this._mouseControls=new OpenLayers.Control.PorttiMouse(this.conf.mouse),this._mouseControls.setup(this.getMapModule()))}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),OpenLayers.Control.PorttiKeyboard=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,slideFactor:50,core:null,setup:function(e){this.mapmodule=e,this.sandbox=e.getSandbox()},initialize:function(){OpenLayers.Control.prototype.initialize.apply(this,arguments)},draw:function(){this.handler=new OpenLayers.Handler.Keyboard(this,{keydown:this.defaultKeyDown,keyup:this.defaultKeyUp})},defaultKeyDown:function(e){if(!(jQuery("input:focus").length>0))switch(e.keyCode){case OpenLayers.Event.KEY_LEFT:this.mapmodule.panMapByPixels(-this.slideFactor,0,!1,!0);break;case OpenLayers.Event.KEY_RIGHT:this.mapmodule.panMapByPixels(this.slideFactor,0,!1,!0);break;case OpenLayers.Event.KEY_UP:this.mapmodule.panMapByPixels(0,-this.slideFactor,!1,!0);break;case OpenLayers.Event.KEY_DOWN:this.mapmodule.panMapByPixels(0,this.slideFactor,!1,!0);break;case 17:this.sandbox.postRequestByName("CtrlKeyDownRequest");break;case 27:this.sandbox.postRequestByName("EscPressedEvent");break;case 33:this.mapmodule.notifyStartMove(),this.mapmodule.panMapNorth();break;case 34:this.mapmodule.notifyStartMove(),this.mapmodule.panMapSouth();break;case 35:this.mapmodule.notifyStartMove(),this.mapmodule.panMapEast();break;case 36:this.mapmodule.notifyStartMove(),this.mapmodule.panMapWest();break;case 43:case 61:case 187:case 107:this.mapmodule.zoomIn();break;case 45:case 109:case 189:case 95:this.mapmodule.zoomOut();break;case 70:this.sandbox.postRequestByName("MapFull.MapWindowFullScreenRequest")}},defaultKeyUp:function(e){switch(e.keyCode){case 17:this.sandbox.postRequestByName("CtrlKeyUpRequest");break;case 37:case 38:case 39:case 40:case 33:case 34:case 35:case 36:case 43:case 61:case 187:case 107:case 45:case 109:case 189:case 95:this.mapmodule.notifyMoveEnd()}},CLASS_NAME:"OpenLayers.Control.PorttiKeyboard"}),OpenLayers.Control.PorttiMouse=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOOL,panned:!1,interval:1,documentDrag:!1,kinetic:null,enableKinetic:!1,kineticInterval:10,pinchZoom:null,pinchZoomOptions:null,documentDrag:!1,zoomBox:null,zoomBoxEnabled:!0,zoomWheelEnabled:!0,mouseWheelOptions:null,handleRightClicks:!1,zoomBoxKeyMask:OpenLayers.Handler.MOD_SHIFT,autoActivate:!0,useCenterMapInWheelZoom:!1,useCenterMapInDblClickZoom:!1,initialize:function(){this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,arguments)},setup:function(e){this.mapmodule=e,this.sandbox=this.mapmodule.getSandbox(),this._hoverEventBuilder=this.sandbox.getEventBuilder("MouseHoverEvent"),this._hoverEvent=this._hoverEventBuilder(),this._mapClickedBuilder=this.sandbox.getEventBuilder("MapClickedEvent")},destroy:function(){this.deactivate(),this.zoomBox&&this.zoomBox.destroy(),this.zoomBox=null,this.pinchZoom&&this.pinchZoom.destroy(),this.pinchZoom=null,OpenLayers.Control.prototype.destroy.apply(this,arguments)},activate:function(){return this.handlers.drag.activate(),this.zoomWheelEnabled&&this.handlers.wheel.activate(),this.handlers.click.activate(),this.handlers.hover.activate(),this.zoomBoxEnabled&&this.zoomBox.activate(),this.pinchZoom&&this.pinchZoom.activate(),OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.pinchZoom&&this.pinchZoom.deactivate(),this.zoomBox.deactivate(),this.handlers.drag.deactivate(),this.handlers.click.deactivate(),this.handlers.wheel.deactivate(),this.handlers.hover.deactivate(),OpenLayers.Control.prototype.deactivate.apply(this,arguments)},draw:function(){if(this.enableKinetic){var e={interval:this.kineticInterval};"object"==typeof this.enableKinetic&&(e=OpenLayers.Util.extend(e,this.enableKinetic)),this.kinetic=new OpenLayers.Kinetic(e)}this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.panMap,done:this.panMapDone,down:this.panMapStart},{interval:this.interval,documentDrag:this.documentDrag}),this.handleRightClicks&&(this.map.viewPortDiv.oncontextmenu=OpenLayers.Function.False);var t={click:this.defaultClick,dblclick:this.defaultDblClick,dblrightclick:this.defaultDblRightClick},i={"double":!0,stopDouble:!0};this.handlers.click=new OpenLayers.Handler.Click(this,t,i);var n={move:this.defaultHoverMove,pause:this.defaultHoverPause},s=this,a={pixelTolerance:1.1,passesTolerance:function(e){var t=!0;if(s.panned)return!1;if(this.pixelTolerance&&this.px){var i=Math.sqrt(Math.pow(this.px.x-e.x,2)+Math.pow(this.px.y-e.y,2));i<this.pixelTolerance&&(t=!1)}return t}};if(this.handlers.hover=new OpenLayers.Handler.Hover(this,n,a),this.dragPan=new OpenLayers.Control.DragPan(OpenLayers.Util.extend({map:this.map,documentDrag:this.documentDrag},this.dragPanOptions)),this.zoomBox=new OpenLayers.Control.ZoomBox({map:this.map,keyMask:this.zoomBoxKeyMask}),this.dragPan.draw(),this.zoomBox.draw(),this.handlers.wheel=new OpenLayers.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown},this.mouseWheelOptions),OpenLayers.Control.PinchZoom){var r=this.pinchZoomOptions||{};r.pinchDone=function(e,t,i){this.applyTransform("");var n=this.map.getZoomForResolution(this.map.getResolution()/i.scale,!0);if(n!==this.map.getZoom()||!this.currentCenter.equals(this.pinchOrigin)){var a=this.map.getResolutionForZoom(n),r=this.map.getLonLatFromPixel(this.pinchOrigin),o=this.currentCenter,l=this.map.getSize();r.lon+=a*(l.w/2-o.x),r.lat-=a*(l.h/2-o.y),s.sendMapSetCenter(r,n)}},this.pinchZoom=new OpenLayers.Control.PinchZoom(OpenLayers.Util.extend({map:this.map},r))}},defaultClick:function(e){if(e.lastTouches&&2==e.lastTouches.length)this.sendMapZoomOut();else{var t=-1!=navigator.userAgent.indexOf("MSIE 8.0");if(t){var i=(new Date).getTime();this.lastDblClickMs?i-this.lastDblClickMs<1e3||this.sendMapClickEvent(e):this.sendMapClickEvent(e)}else this.sendMapClickEvent(e)}},defaultDblClick:function(e){var t=1,i=this.map.getZoom(),n=this.map.getZoom()+Math.round(t);if(n=Math.max(n,0),n=Math.min(n,this.map.getNumZoomLevels()),n!==i){var s=this.map.getSize(),a=s.w/2-e.xy.x,r=e.xy.y-s.h/2,o=this.map.baseLayer.getResolutionForZoom(n),l=this.map.getLonLatFromPixel(e.xy),u=null;u=this.useCenterMapInDblClickZoom?this.map.getCenter():new OpenLayers.LonLat(l.lon+a*o,l.lat+r*o);
var c=-1!=navigator.userAgent.indexOf("MSIE 8.0");c&&(this.lastDblClickMs=(new Date).getTime()),this.sendMapSetCenter(u,n)}},defaultDblRightClick:function(){this.sendMapZoomOut()},wheelChange:function(e,t){var i=this.map.getZoom(),n=this.map.getZoom()+Math.round(t);if(n=Math.max(n,0),n=Math.min(n,this.map.getNumZoomLevels()),n!==i){var s=this.map.getSize(),a=s.w/2-e.xy.x,r=e.xy.y-s.h/2,o=this.map.baseLayer.getResolutionForZoom(n),l=this.map.getLonLatFromPixel(e.xy),u=null;u=this.useCenterMapInWheelZoom?this.map.getCenter():new OpenLayers.LonLat(l.lon+a*o,l.lat+r*o),this.sendMapSetCenter(u,n)}},wheelUp:function(e,t){this.wheelChange(e,t||1)},wheelDown:function(e,t){this.wheelChange(e,t||-1)},disableZoomBox:function(){this.zoomBoxEnabled=!1,this.zoomBox.deactivate()},enableZoomBox:function(){this.zoomBoxEnabled=!0,this.active&&this.zoomBox.activate()},disableZoomWheel:function(){this.zoomWheelEnabled=!1,this.handlers.wheel.deactivate()},enableZoomWheel:function(){this.zoomWheelEnabled=!0,this.active&&this.handlers.wheel.activate()},panMapStart:function(){this.kinetic&&this.kinetic.begin(),this.panned=!1},panMap:function(e){this.kinetic&&this.kinetic.update(e),this.panned||this.mapmodule.notifyStartMove(),this.panned=!0,this.map.pan(this.handlers.drag.last.x-e.x,this.handlers.drag.last.y-e.y,{dragging:!0,animate:!1})},panMapDone:function(e){if(this.panned){var t=null;if(this.kinetic&&(t=this.kinetic.end(e)),this.mapmodule.panMapByPixels(this.handlers.drag.x-e.x,this.handlers.drag.y-e.y,!0,!1,!1),t){var i=this;this.kinetic.move(t,function(e,t){i.mapmodule.panMapByPixels(e,t,!0,!1,!1)})}this.panned=!1}},defaultHoverMove:function(e){if(!this.panned){var t=this.map.getLonLatFromViewPortPx(e.xy);this._hoverEvent.set(t.lon,t.lat,!1,e.pageX,e.pageY),this.sandbox.notifyAll(this._hoverEvent,!0)}},defaultHoverPause:function(e){if(!this.panned){var t=this.map.getLonLatFromViewPortPx(e.xy),i=this._hoverEventBuilder();i.set(t.lon,t.lat,!1,e.pageX,e.pageY),this.sandbox.notifyAll(i)}},sendMapClickEvent:function(e){var t=this.map.getLonLatFromViewPortPx(e.xy),e=this._mapClickedBuilder(t,e.xy.x,e.xy.y);this.sandbox.notifyAll(e)},sendMapSetCenter:function(e,t){this.mapmodule.centerMap(e,t)},sendMapZoomOut:function(){this.mapmodule.zoomOut()},sendMapZoomIn:function(){this.mapmodule.zoomIn()},CLASS_NAME:"OpenLayers.Control.PorttiMouse"}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.DisableMapKeyboardMovementRequest",function(){this._creator=null},{__name:"DisableMapKeyboardMovementRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.DisableMapMouseMovementRequest",function(){this._creator=null},{__name:"DisableMapMouseMovementRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.EnableMapKeyboardMovementRequest",function(){this._creator=null},{__name:"EnableMapKeyboardMovementRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.EnableMapMouseMovementRequest",function(){this._creator=null},{__name:"EnableMapMouseMovementRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapMovementControlsRequestHandler",function(e){this.mapModule=e},{handleRequest:function(e,t){if("EnableMapKeyboardMovementRequest"==t.getName()){var i=this.mapModule.getMapControl("keyboardControls");i&&i.activate()}else if("DisableMapKeyboardMovementRequest"==t.getName()){var i=this.mapModule.getMapControl("keyboardControls");i&&i.deactivate()}else if("EnableMapMouseMovementRequest"==t.getName()){var i=this.mapModule.getMapControl("mouseControls");i&&(i.activate(),i.registerMouseEvents())}else if("DisableMapMouseMovementRequest"==t.getName()){var i=this.mapModule.getMapControl("mouseControls");i&&(i.deactivate(),i.unregisterMouseEvents())}}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.request.common.ShowMapMeasurementRequest",function(e,t,i,n){this._creator=null,this._value=e,this._geometry=i,this._finished=t,this._geometryMimeType=n},{__name:"ShowMapMeasurementRequest",getName:function(){return this.__name},getValue:function(){return this._value},getGeometry:function(){return this._geometry},getGeometryMimeType:function(){return this._geometryMimeType},isFinished:function(){return this._finished}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.getinfo.GetFeatureInfoHandler",function(e){this.getInfoPlugin=e},{handleRequest:function(e,t){"MapModulePlugin.GetFeatureInfoRequest"==t.getName()?this.getInfoPlugin.handleGetInfo({lon:t.getLon(),lat:t.getLat()},t.getX(),t.getY()):"MapModulePlugin.GetFeatureInfoActivationRequest"==t.getName()&&this.getInfoPlugin.setEnabled(t.isEnabled())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.GetFeatureInfoRequest",function(e,t,i,n){this._lon=e,this._lat=t,this._x=i,this._y=n},{__name:"MapModulePlugin.GetFeatureInfoRequest",getName:function(){return this.__name},getLon:function(){return this._lon},getLat:function(){return this._lat},getX:function(){return this._x},getY:function(){return this._y}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.GetFeatureInfoActivationRequest",function(e){this._enable=e===!0},{__name:"MapModulePlugin.GetFeatureInfoActivationRequest",getName:function(){return this.__name},isEnabled:function(){return this._enable}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.GetInfoPlugin",function(e,t){this.config=e,this._locale=t,this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.enabled=!0,this.infoboxId="getinforesult",this._pendingAjaxQuery={busy:!1,jqhr:null,timestamp:null},this.template={};for(p in this.__templates)this.template[p]=jQuery(this.__templates[p])},{__templates:{wrapper:"<div></div>",getinfo_result_table:'<table class="getinforesult_table"></table>',link_outside:'<a target="_blank"></a>',tableRow:"<tr></tr>",tableCell:"<td></td>",span:"<span></span>",header:'<div class="getinforesult_header"><div class="icon-bubble-left"></div>',headerTitle:'<div class="getinforesult_header_title"></div>',myPlacesWrapper:'<div class="myplaces_place"><h3 class="myplaces_header"></h3><p class="myplaces_desc"></p><a class="myplaces_imglink" target="_blank"><img class="myplaces_img"></img></a><a class="myplaces_link"></a></div>'},__name:"GetInfoPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(e){var t=this;t._sandbox=e,t._sandbox.printDebug("[GetInfoPlugin] init"),t.getGFIHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.getinfo.GetFeatureInfoHandler",t)},register:function(){},unregister:function(){},startPlugin:function(e){var t=this;e&&e.register&&(t._sandbox=e),t._map=t.getMapModule().getMap(),t._sandbox.register(t);for(p in t.eventHandlers)t._sandbox.registerForEventByName(t,p);t._sandbox.addRequestHandler("MapModulePlugin.GetFeatureInfoRequest",t.getGFIHandler),t._sandbox.addRequestHandler("MapModulePlugin.GetFeatureInfoActivationRequest",t.getGFIHandler)},stopPlugin:function(e){var t=this;t._closeGfiInfo(),e&&e.register&&(t._sandbox=e);for(p in t.eventHandlers)t._sandbox.unregisterFromEventByName(t,p);t._sandbox.unregister(t),t._map=null,t._sandbox=null},start:function(){},stop:function(){},setEnabled:function(e){this.enabled=e===!0,this.enabled||this._closeGfiInfo()},eventHandlers:{EscPressedEvent:function(){this._closeGfiInfo()},MapClickedEvent:function(e){if(this.enabled){var t=e.getLonLat(),i=e.getMouseX(),n=e.getMouseY();this.handleGetInfo(t,i,n)}},AfterMapMoveEvent:function(){this._cancelAjaxRequest()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_cancelAjaxRequest:function(){var e=this;if(e._pendingAjaxQuery.busy){var t=e._pendingAjaxQuery.jqhr;e._pendingAjaxQuery.jqhr=null,t&&(this._sandbox.printDebug("[GetInfoPlugin] Abort jqhr ajax request"),t.abort(),t=null,e._pendingAjaxQuery.busy=!1)}},_buildLayerIdList:function(){for(var e=this,t=e._sandbox.findAllSelectedMapLayers(),i=null,n=e._sandbox.getMap().getScale(),s=0;s<t.length;s++){var a=t[s];e._isIgnoredLayerType(a)||a.getQueryable&&a.getQueryable()&&a.isInScale(n)&&a.isVisible()&&(i||(i=""),""!==i&&(i+=","),i+=a.getId())}return i},_isIgnoredLayerType:function(e){if(null!=this.config&&this.config.ignoredLayerTypes)for(var t=0;t<this.config.ignoredLayerTypes.length;t++)if(e.isLayerOfType(this.config.ignoredLayerTypes[t]))return!0;return!1},_startAjaxRequest:function(e){var t=this;t._pendingAjaxQuery.busy=!0,t._pendingAjaxQuery.timestamp=e},_finishAjaxRequest:function(){var e=this;e._pendingAjaxQuery.busy=!1,e._pendingAjaxQuery.jqhr=null,this._sandbox.printDebug("[GetInfoPlugin] finished jqhr ajax request")},_notifyAjaxFailure:function(){var e=this;e._sandbox.printDebug("[GetInfoPlugin] GetFeatureInfo AJAX failed")},_isAjaxRequestBusy:function(){var e=this;return e._pendingAjaxQuery.busy},handleGetInfo:function(e,t,i){var n=this,s=new Date,a=s.getTime();if(n._pendingAjaxQuery.busy&&n._pendingAjaxQuery.timestamp&&a-n._pendingAjaxQuery.timestamp<500)return n._sandbox.printDebug("[GetInfoPlugin] GetFeatureInfo NOT SENT (time difference < 500ms)"),void 0;n._cancelAjaxRequest();var r=n._buildLayerIdList();if(!r){var o={fragments:[],lonlat:e,popupid:this.infoboxId,title:""},l=this.getMapModule().getLocalization("plugin",!0),u=l[this.__name];o.title=u.title;var c=n._sandbox.getEventBuilder("GetInfoResultEvent")(o);return n._sandbox.notifyAll(c),n._sandbox.printDebug("[GetInfoPlugin] NO layers with featureInfoEnabled, in scale and visible"),void 0}n._startAjaxRequest(a);var h=this._sandbox.getAjaxUrl(),d=e.lon,p=e.lat,f=n._sandbox.getMap();jQuery.ajax({beforeSend:function(e){n._pendingAjaxQuery.jqhr=e,e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(t){if(t.data&&t.data instanceof Array){t.lonlat=e;var i=n._parseGfiResponse(t);if(!i)return;if(i.popupid=n.infoboxId,i.lonlat=e,!n._isAjaxRequestBusy())return;n._showFeatures(i)}n._finishAjaxRequest()},error:function(){n._finishAjaxRequest(),n._notifyAjaxFailure()},always:function(){n._finishAjaxRequest()},complete:function(){n._finishAjaxRequest()},data:{layerIds:r,projection:n.mapModule.getProjection(),x:t,y:i,lon:d,lat:p,width:f.getWidth(),height:f.getHeight(),bbox:f.getBbox().toBBOX(),zoom:f.getZoom(),srs:f.getSrsName()},type:"POST",dataType:"json",url:h+"action_route=GetFeatureInfoWMS"})},_closeGfiInfo:function(){var e=this._sandbox.getRequestBuilder("InfoBox.HideInfoBoxRequest")(this.infoboxId);this._sandbox.request(this,e)},_showGfiInfo:function(e,t){var i=this._sandbox.getRequestBuilder("InfoBox.ShowInfoBoxRequest")("getinforesult","GetInfo Result",e,t,!0);this._sandbox.request(this,i)},_formatResponseForInfobox:function(e){var t=[];if(!e||!e.data)return t;var i=this,n=[];e.data.length?n=e.data:n.push(e.data);for(var s=0;s<n.length;s++){var a=n[s],r=i._formatGfiDatum(a);null!=r&&t.push({html:r})}return t},_parseGfiResponse:function(e){var t=this._sandbox,i=e.data,n=[],s=e.lonlat,a=s.lon+", "+s.lat,r=e.layerCount;if(0!=r&&0!=i.length&&i instanceof Array){for(var o=0;o<i.length;o++){var l=i[o],u=l.layerId,c=t.findMapLayerFromSelectedMapLayers(u),h=c?c.getName():"",d=l.type;if("wfslayer"==d){var p=l.features;if(!p||!p.length)continue;for(var f=0;f<p.length;f++){var m=p[f],g=m.children;if(g&&g.length)for(var y=0;y<g.length;y++){var v=g[y],b=v.pnr_PaikanNimi;b&&b["pnr:kirjoitusasu"]&&(a=b["pnr:kirjoitusasu"]);var _=this._json2html(v);n.push({markup:_,layerId:u,layerName:h,type:d})}}}else{var _=this._formatGfiDatum(l);if(null!=_){var w;w=l.layerId&&"string"==typeof l.layerId&&l.layerId.match("myplaces_")?!0:!1;var L={markup:_,layerId:u,layerName:h,type:d,isMyPlace:w};n.push(L)}}}return{fragments:n,title:a}}},_formatJSONValue:function(e){if(e){var t=this.template.span.clone();if("[object Array]"===Object.prototype.toString.call(e))for(var i=0;i<e.length;++i){var n=e[i];for(objAttr in n){var s=this._formatJSONValue(n[objAttr]);if(s){var a=this.getMapModule().getLocalization("plugin",!0),r=a[this.__name],o=r[objAttr];t.append(o?o:objAttr),t.append(": "),t.append(s),t.append("<br/>")}}}else if(e.indexOf&&e.indexOf("://")>0&&e.indexOf("://")<7){var l=this.template.link_outside.clone();l.attr("href",e),l.append(e),t.append(l)}else t.append(e);return t}},_formatGfiDatum:function(e){if(!e.presentationType)return null;var t=this,i=t.template.wrapper.clone(),n=typeof e.content,s=!1;if("string"==n&&(s=e.content.indexOf("<html>")>=0,s=s||e.content.indexOf("<HTML>")>=0),"JSON"==e.presentationType||e.content&&e.content.parsed){if(e.layerId&&"string"==typeof e.layerId&&e.layerId.match("myplaces_"))return t._formatMyPlacesGfi(e);var a=!1,r=e.content.parsed,o=[];"[object Array]"===Object.prototype.toString.call(r)?o=r:o.push(r);for(var l=0;l<o.length;++l){var u=o[l],c=t.template.getinfo_result_table.clone();for(var h in u){var d=t._formatJSONValue(u[h]);if(d){var p=t.template.tableRow.clone();c.append(p),a||p.addClass("odd"),a=!a;var f=t.template.tableCell.clone(),m=this.getMapModule().getLocalization("plugin",!0),g=m[this.__name],y=g[h];f.append(y?y:h),p.append(f);var v=t.template.tableCell.clone();v.append(d),p.append(v)}}i.append(c)}return i}return i.append(e.content),i},_formatMyPlacesGfi:function(e){var t,i,n,s=this,a=s.template.wrapper.clone(),r=e.content.parsed.places,o=r.length;for(a.addClass("myplaces_wrapper"),n=0;o>n;++n)t=r[n],i=s.template.myPlacesWrapper.clone(),i.find("h3.myplaces_header").html(t.name),i.find("p.myplaces_desc").html(t.description),t.imageUrl?(i.find("img.myplaces_img").attr({src:t.imageUrl}),i.find("a.myplaces_imglink").attr({href:t.imageUrl})):i.find("img.myplaces_img").remove(),i.find("a.myplaces_link").attr({href:t.link}).html(t.link),a.append(i);return a},_json2html:function(e){if(null==e)return"";var t=!0,i=this.template.getinfo_result_table.clone(),n=null,s=null,a=null;for(var r in e){var o=e[r],l=(typeof o).toLowerCase();switch(l){case"string":0==o.indexOf("http://")?(valpres=this.template.link_outside.clone(),valpres.attr("href",o),valpres.append(o)):valpres=o;break;case"undefined":valpres="n/a";break;case"boolean":valpres=o?"true":"false";break;case"number":valpres=""+o;break;case"function":valpres="?";break;case"object":valpres=this._json2html(o);break;default:valpres=""}t=!t,n=this.template.tableRow.clone(),t||n.addClass("odd"),s=this.template.tableCell.clone(),s.append(r),n.append(s),a=this.template.tableCell.clone(),a.append(valpres),n.append(a),i.append(n)}return i},_showFeatures:function(e){var t=this,i={},n=t.template.wrapper.clone(),s=null,a=null;i.html="",i.actions={};for(var r=0;r<e.fragments.length;r++){var o=e.fragments[r],l=o.layerName,u=o.markup,c=t.template.wrapper.clone();if(!o.isMyPlace){var h=t.template.header.clone(),d=t.template.headerTitle.clone();d.append(l),d.attr("title",l),h.append(d),c.append(h)}u&&c.append(u),n.append(c)}this.config&&this.config.colourScheme&&(s=this.config.colourScheme),this.config&&this.config.font&&(a=this.config.font),i.html=n;var p=this.getMapModule().getLocalization("plugin",!0),f=p[this.__name];if(e.title=f.title,!this.config||this.config.infoBox){var m=t._sandbox.getRequestBuilder("InfoBox.ShowInfoBoxRequest");if(m){var g=m(e.popupid,e.title,[i],e.lonlat,!0,s,a);t._sandbox.request(t,g)}}var y=t._sandbox.getEventBuilder("GetInfoResultEvent")(e);t._sandbox.notifyAll(y)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.MarkersPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null},{__name:"MarkersPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this.requestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MarkerRequestHandler",this)},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this._createMapMarkersLayer(),e.register(this),this._sandbox.addRequestHandler("MapModulePlugin.RemoveMarkerRequest",this.requestHandler);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){this._sandbox.removeRequestHandler("MapModulePlugin.RemoveMarkerRequest",this.requestHandler);for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},removeMapMarkers:function(){var e=this.getMapModule();e&&e._removeMarkers()},_createMapMarkersLayer:function(){this._sandbox;var e=new OpenLayers.Layer.Markers("Markers");this._map.addLayer(e)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.RemoveMarkerRequest",function(e){this._list=e},{__name:"MapModulePlugin.RemoveMarkerRequest",getName:function(){return this.__name},getMarkerIds:function(){return this._list}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MarkerRequestHandler",function(e){this.markersPlugin=e},{handleRequest:function(e,t){"MapModulePlugin.RemoveMarkerRequest"==t.getName()&&this.markersPlugin.removeMapMarkers(t.getMarkerIds())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.SearchPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._conf=e,this.container=null,this.loc=null},{__name:"SearchPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(e){var t=this.getMapModule().getLocalization("plugin",!0);this.loc=t[this.__name],this.template=jQuery('<div class="search-div"><div class="search-textarea-and-button"><input placeholder="'+this.loc.placeholder+'" type="text" />'+'<input type="button" value="'+this.loc.search+'" name="search" />'+"</div>"+'<div class="results">'+'<div class="header">'+'<div class="close icon-close" title="'+this.loc.close+'"></div>'+"</div>"+'<div class="content">&nbsp;</div>'+"</div>"+"</div>"),this.styledTemplate=jQuery('<div class="published-search-div"><div class="search-area-div"><div class="search-left"></div><div class="search-middle"><input class="search-input" placeholder="'+this.loc.placeholder+'" type="text" />'+"</div>"+'<div class="search-right"></div>'+"</div>"+'<div class="results published-search-results">'+'<div class="header published-search-header">'+'<div class="close icon-close" title="'+this.loc.close+'"></div>'+"</div>"+'<div class="content published-search-content">&nbsp;</div>'+"</div>"+"</div>"),this.templateResultsTable=jQuery("<table class='search-results'><thead><tr><th>"+this.loc.column_name+"</th>"+"<th>"+this.loc.column_village+"</th>"+"<th>"+this.loc.column_type+"</th>"+"</tr></thead><tbody></tbody></table>"),this.templateResultsRow=jQuery("<tr><td nowrap='nowrap'><a href='JavaScript:void(0);'></a></td><td nowrap='nowrap'></td><td nowrap='nowrap'></td></tr>");var i=null;i=this.conf&&this.conf.url?this.conf.url:e.getAjaxUrl()+"action_route=GetSearchResult",this.service=Oskari.clazz.create("Oskari.mapframework.bundle.search.service.SearchService",i)},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this._createUI()},stopPlugin:function(e){this.container.remove();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_createUI:function(){var e,t=this._sandbox,i=this;this._conf&&this._conf.toolStyle?(e=this.styledTemplate.clone(),this.changeToolStyle(this._conf.toolStyle,e)):e=this.template.clone(),this.container=e;var n=jQuery("div.mapplugins.left");n&&0!=n.length||(n=jQuery(this._map.div),e.addClass("mapplugin"));var i=this,s=e.find("input[type=text]");s.focus(function(){t.request(i.getName(),t.getRequestBuilder("DisableMapKeyboardMovementRequest")())}),s.blur(function(){t.request(i.getName(),t.getRequestBuilder("EnableMapKeyboardMovementRequest")())}),s.keypress(function(e){i._checkForEnter(e)}),e.find("input[type=button]").click(function(){i._doSearch()}),e.find("div.search-right").click(function(){i._doSearch()}),e.find("div.close").click(function(){i._hideSearch()}),e.find("div.results").hide(),n.append(e),this._conf&&this._conf.location&&(this._conf.location.top&&e.css("top",this._conf.location.top),this._conf.location.left&&e.css("left",this._conf.location.left),this._conf.location.right&&e.css("right",this._conf.location.right),this._conf.location.bottom&&e.css("bottom",this._conf.location.bottom)),this._conf&&this._conf.font&&this.changeFont(this._conf.font,e),this._conf&&this._conf.toolStyle&&s.keyup(function(e){(27==e.keyCode||8==e.keyCode&&!jQuery(this).val())&&i._hideSearch()})},_checkForEnter:function(e){var t;window.event?t=window.event.keyCode:e&&(t=e.which),13==e.keyCode&&this._doSearch()},_doSearch:function(){if(1!=this._searchInProgess){var e=this;this._hideSearch(),this._searchInProgess=!0;var t=this.container.find("input[type=text]");t.addClass("search-loading");var i=t.val(),n=function(t){e._showResults(t),e._enableSearch()},s=function(){e._enableSearch()};this.service.doSearch(i,n,s)}},_showResults:function(e){var t=e.error,i=this,n=this.container.find("div.results"),s=n.find("div.header"),a=n.find("div.content");if(null!=t)return a.html(t),n.show(),void 0;var r=e.totalCount;if(0==r)a.html(this.loc.noresults),n.show();else if(1==r){var o=e.locations[0].lon,l=e.locations[0].lat,u=e.locations[0].zoomLevel;this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("MapMoveRequest")(o,l,u,!1))}else{for(var c=this.templateResultsTable.clone(),h=c.find("tbody"),d=0;r>d;d++){if(d>=100){h.append("<tr><td class='search-result-too-many' colspan='3'>"+this.loc.toomanyresults+"</td></tr>");break}var o=e.locations[d].lon,l=e.locations[d].lat,u=e.locations[d].zoomLevel,p=o+"---"+l+"---"+u,f=this.templateResultsRow.clone();f.attr("data-location",p);var m=e.locations[d].name,g=e.locations[d].village,y=e.locations[d].type,v=f.find("td"),b=jQuery(v[0]).find("a");b.attr("data-location",p),b.append(m),b.click(function(){return i._resultClicked(jQuery(this).attr("data-location")),!1}),jQuery(v[1]).append(g),jQuery(v[2]).append(y),h.append(f)}this._conf&&this._conf.toolStyle||h.find(":odd").addClass("odd"),a.html(c),n.show(),this._conf&&this._conf.font&&this.changeFont(this._conf.font,a),this._conf&&this._conf.toolStyle&&(s.remove(),i.changeResultListStyle(i._conf.toolStyle,n))}},_resultClicked:function(e){var t=e.split("---"),i=t[0],n=t[1],s=t[2];this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("MapMoveRequest")(i,n,s,!1))},_enableSearch:function(){this._searchInProgess=!1,jQuery("#search-string").removeClass("search-loading")},_hideSearch:function(){this.container.find("div.results").hide(),this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("HideMapMarkerRequest")())},changeToolStyle:function(e,t){if(t=t||this.container,e&&t){if(t.hasClass("search-div"))return t.remove(),this._createUI(),void 0;var i=this.getMapModule().getImageUrl(),n=i+"/framework/bundle/mapmodule-plugin/plugin/search/images/",s=e.val,a=n+"search-tool-"+s+"_01.png",r=n+"search-tool-"+s+"_02.png",o=n+"search-tool-"+s+"_03.png",l=t.find("div.search-left"),u=t.find("div.search-middle"),c=t.find("div.search-right");l.css({"background-image":'url("'+a+'")',width:e.widthLeft}),u.css({"background-image":'url("'+r+'")',"background-repeat":"repeat-x"}),c.css({"background-image":'url("'+o+'")',width:e.widthRight})}},changeFont:function(e,t){if(t=t||this.container,t&&e){var i=[];i.push(t.find("table.search-results")),i.push(t.find("input"));var n="oskari-publisher-font-"+e,s=/oskari-publisher-font-/;this.getMapModule().changeCssClasses(n,s,i)}},changeResultListStyle:function(e,t){var i="oskari-publisher-search-results-"+e.val,n=/oskari-publisher-search-results-/;this.getMapModule().changeCssClasses(i,n,[t])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.search.service.SearchService",function(e){this._searchUrl=e},{__qname:"Oskari.mapframework.bundle.search.service.SearchService",getQName:function(){return this.__qname},__name:"SearchService",getName:function(){return this.__name},doSearch:function(e,t,i){var n=Oskari.getLang();jQuery.ajax({dataType:"json",type:"POST",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/json")},url:this._searchUrl,data:"searchKey="+e+"&Language="+n,error:i,success:t})}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.LogoPlugin",function(e){this.conf=e,this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.element=null},{templates:{main:jQuery("<div class='logoplugin'><div class='icon'></div><div class='terms'><a href='JavaScript:void(0);'></a></div></div>")},__name:"LogoPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){},register:function(){},unregister:function(){},startPlugin:function(e){var t,i=this;i._sandbox=e,i._map=i.getMapModule().getMap(),e.register(i);for(t in i.eventHandlers)i.eventHandlers.hasOwnProperty(t)&&e.registerForEventByName(i,t);i._createUI()},stopPlugin:function(e){var t,i=this;for(t in i.eventHandlers)i.eventHandlers.hasOwnProperty(t)&&e.unregisterFromEventByName(i,t);e.unregister(i),i._map=null,i._sandbox=null,i.element&&(i.element.find("a").unbind("click"),i.element.remove(),i.element=void 0)},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_createUI:function(){var e,t,i,n,s=this,a=s._sandbox,r=jQuery(s._map.div),o=s.getMapModule().getLocalization("plugin",!0),l=o[s.__name];s.conf&&(i=a.getLocalizedProperty(s.conf.mapUrlPrefix),n=a.getLocalizedProperty(s.conf.termsUrl)),s.element||(s.element=s.templates.main.clone()),r.append(s.element),e=s.element.find("div.icon"),i&&e.bind("click",function(){return t=a.generateMapLinkParameters(),i+=t,window.open(i,"_blank"),!1}),e=s.element.find("a"),n?(e.append(l.terms),e.bind("click",function(){return window.open(n,"_blank"),!1})):e.hide()},changeFont:function(e,t){var i,n;t=t||this.element,t&&e&&(i="oskari-publisher-font-"+e,n=/oskari-publisher-font-/,this.getMapModule().changeCssClasses(i,n,[t]))}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.DataSourcePlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.template=null,this.element=null,this.sandbox=null,this.tool=null},{__name:"DataSourcePlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this.template=jQuery("<div class='oskari-datasource'><div class='link'><a href='JavaScript:void(0);'></a></div></div>"),this.templateinfoIcon=jQuery('<div class="icon-info"></div>'),this.templategroupTemplate=jQuery('<ul style="padding: 0 12px;"></ul>'),this.templatecontent=jQuery("<div></div>"),this.templateheading=jQuery("<b></b>")},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this._createUI()},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null,this.element.find("a").unbind("click"),this.element.remove(),this.element=void 0},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},_layerListComparator:function(e,t){var i=e.getOrganizationName().toLowerCase(),n=t.getOrganizationName().toLowerCase();return i==n&&(i=e.getName().toLowerCase(),n=t.getName().toLowerCase()),n>i?-1:i>n?1:0},_createUI:function(){var e=this;e._sandbox;var t=jQuery(this._map.div);this.element||(this.element=this.template.clone()),t.append(this.element);var i=this.getMapModule().getLocalization("plugin",!0);this.localization=i[this.__name];var n=this.element.find("a");n.append(this.localization.link),n.bind("click",function(){return e._openDialog(),!1})},_openDialog:function(){var e=this;e._sandbox;var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=t.createCloseButton(this.localization.button.close);this.templateinfoIcon.clone();for(var n=this.templategroupTemplate.clone(),s=this._getLayers(),a=null,r=this.templatecontent.clone(),o=null,l=0;l<s.length;++l){var u=s[l];if(a!=u.getOrganizationName()){a=u.getOrganizationName();var c=this.templateheading.clone();a?c.append(a):c.append("N/A"),r.append(c),o=n.clone(),r.append(o)}var h=this._getLayerContainer(u);h&&o.append(h)}t.show(this.localization.popup.title,r,[i]),t.moveTo(this.element.find("a"),"top")},_getLayers:function(){var e=this,t=this._sandbox.findAllSelectedMapLayers();return t.sort(function(t,i){return e._layerListComparator(t,i)}),t},_getLayerContainer:function(e){var t=this,i=this.templateinfoIcon.clone(),n=e.getName();if(n){var s=jQuery("<li>"+n+"</li>"),a=e.getMetadataIdentifier();if(a){var r=i.clone();r.bind("click",function(){t._getMetadataInfoCallback(e)}),s.append(r)}return s}return null},_getMetadataInfoCallback:function(e){var t=this,i=t._sandbox,n=e.getMetadataIdentifier(),s=[],a={};a[n]=!0;var r=e.getSubLayers();if(r&&r.length>0)for(var o=0;o<r.length;o++){var l=r[o].getMetadataIdentifier();l&&""!=l&&!a[l]&&(a[l]=!0,s.push({uuid:l}))}i.postRequestByName("catalogue.ShowMetadataRequest",[{uuid:n},s])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.IndexMapPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._conf=e,this._indexMap=null,this._indexMapUrl="/framework/bundle/mapmodule-plugin/plugin/indexmap/images/suomi25m_tm35fin.png"},{__name:"IndexMapPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){},_createUI:function(){var e=new OpenLayers.Layer.Image("Overview map image",this.getMapModule().getImageUrl()+this._indexMapUrl,new OpenLayers.Bounds(26783,6608595,852783,7787250),new OpenLayers.Size(120,173)),t={mapOptions:{maxExtent:new OpenLayers.Bounds(26783,6608595,852783,7787250),units:"m",projection:this._map.getProjection(),numZoomLevels:1},layers:[e],size:new OpenLayers.Size(120,173),autoPan:!1,controls:[]};
this._indexMap=new OpenLayers.Control.OverviewMap(t)},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this._createUI(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.getMapModule().addMapControl("overviewMap",this._indexMap)},stopPlugin:function(e){this.getMapModule().removeMapControl("overviewMap");for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapMoveEvent:function(){this._indexMap&&this._indexMap.update()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.ScaleBarPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._scalebar=null},{__name:"ScaleBarPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this._scalebar=new OpenLayers.Control.ScaleLine},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.getMapModule().addMapControl("scaleBar",this._scalebar)},stopPlugin:function(e){this.getMapModule().removeMapControl("scaleBar");for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapMoveEvent:function(){this._scalebar&&this._scalebar.update()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.FullScreenPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._fullscreen=null,this.__templates={}},{__name:"FullScreenPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){var e=this.getMapModule().getImageUrl()+"/framework/bundle/mapmodule-plugin/plugin/fullscreen/images/";this.__templates.fullscreen=jQuery('<div class="fullscreenDiv"><img class="fullscreenDivImg" src="'+e+"hide-navigation.png"+'"></img>'+"</div>")},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.createUI()},stopPlugin:function(e){jQuery("div.fullscreenDiv").remove();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},createUI:function(){var e=this,t=this.__templates.fullscreen.clone(),i=this.getMapModule().getImageUrl()+"/framework/bundle/mapmodule-plugin/plugin/fullscreen/images/";t.find(".fullscreenDivImg").bind("click",function(t){t.preventDefault(),e._sandbox.postRequestByName("MapFull.MapWindowFullScreenRequest"),jQuery(this).attr("src").match(/hide-navigation/)?jQuery(this).attr("src",i+"show-navigation.png"):jQuery(this).attr("src",i+"hide-navigation.png")}),jQuery(this._map.div).append(t)},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.LayerSelectionPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.element=void 0,this.conf=e,this.initialSetup=!0},{__name:"LayerSelectionPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},getMap:function(){return this._map},register:function(){},unregister:function(){},init:function(){this.template=jQuery('<div class=\'layerSelectionPlugin\'><div class="header"><div class="header-icon icon-arrow-white-right"></div></div><div class="content"><div class="layers"></div><div class="baselayers"></div></div></div>'),this.templateLayer=jQuery("<div class='layer'><span></span></div>"),this.templateCheckbox=jQuery("<input type='checkbox' />"),this.templateRadiobutton=jQuery("<input type='radio' name='defaultBaselayer'/>"),this.templateBaseLayerHeader=jQuery('<div class="baseLayerHeader"></div>'),this.templateHeaderArrow=jQuery('<div class="styled-header-arrow"></div>'),this.templateContentHeader=jQuery('<div class="content-header"><div class="content-header-title"></div><div class="content-close icon-close-white"></div></div>')},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this._createUI()},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this.element&&(this.element.remove(),this.element=void 0,delete this.element)},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerRemoveEvent:function(e){this.removeLayer(e.getMapLayer())},AfterMapLayerAddEvent:function(e){this.addLayer(e.getMapLayer())},MapLayerVisibilityChangedEvent:function(e){this.updateLayer(e.getMapLayer())},AfterMapMoveEvent:function(){if(this.initialSetup&&(this.initialSetup=!1,this.conf&&this.conf.baseLayers)){for(var e=0;e<this.conf.baseLayers.length;++e){var t=this._sandbox.findMapLayerFromSelectedMapLayers(this.conf.baseLayers[e]);this.addBaseLayer(t)}this.conf.defaultBaseLayer&&this.selectBaseLayer(this.conf.defaultBaseLayer)}}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(){},selectBaseLayer:function(e){var t=this.element.find("div.content div.baselayers");if(t&&0!=t.length){var i=t.find("input[value="+e+"]");i.attr("checked","checked"),this._changedBaseLayer()}},addLayer:function(e){var t=this.element.find("div.content"),i=t.find("div.layers"),n=this.templateLayer.clone();n.find("span").append(e.getName());var s=this.templateCheckbox.clone();s.attr("value",e.getId()),e.isVisible()?s.attr("checked",!0):s.attr("checked",!1),this._bindCheckbox(s,e),n.find("span").before(s),this.layerRefs[e.getId()]=n,i.append(n)},updateLayer:function(e){var t=this.layerRefs[e.getId()],i=t.find("input"),n=e.isVisible();n?i.is(":checked")||i.attr("checked","checked"):i.is(":checked")&&i.removeAttr("checked")},_bindCheckbox:function(e,t){var i=this;e.change(function(){var e=jQuery(this),n=e.is(":checked");n?i._setLayerVisible(t,!0):i._setLayerVisible(t,!1)})},_setLayerVisible:function(e,t){var i=this._sandbox,n=i.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest"),s=n(e.getId(),t);i.request(this,s)},removeLayer:function(e){var t=this.layerRefs[e.getId()];t.remove(),delete this.layerRefs[e.getId()]},addBaseLayer:function(e){if(e&&e.getId){var t=this.layerRefs[e.getId()];t.remove();var i=t.find("input");i.remove(),i=this.templateRadiobutton.clone(),i.attr("value",e.getId());var n=this;i.bind("change",function(){n._changedBaseLayer()}),t.find("span").before(i);var s=this.element.find("div.content div.baselayers");if(0==s.find("div.layer").length){var a=this.getMapModule().getLocalization("plugin"),r=a[this.__name],o=this.templateBaseLayerHeader.clone();o.append(r.chooseDefaultBaseLayer),s.before(o),i.attr("checked","checked")}s.append(t),n._changedBaseLayer()}},removeBaseLayer:function(e){var t=this.layerRefs[e.getId()];t.remove();var i=t.find("input");i.remove(),i=this.templateCheckbox.clone(),i.attr("value",e.getId()),this._bindCheckbox(i,e),t.find("span").before(i);var n=this.element.find("div.content div.layers");n.append(t),this._setLayerVisible(e,!0);var s=this.element.find("div.content div.baselayers"),a=s.find("div.layer");if(0==a.length){var r=this.element.find("div.content div.baseLayerHeader");r.remove()}else{var o=a.find("input:checked");0==o.length&&(jQuery(a.find("input").get(0)).attr("checked","checked"),this._changedBaseLayer())}},_changedBaseLayer:function(){for(var e=this.getBaseLayers(),t=0;t<e.baseLayers.length;++t){var i=e.baseLayers[t],n=this._sandbox.findMapLayerFromSelectedMapLayers(i);this._setLayerVisible(n,e.defaultBaseLayer==i)}var s=this._sandbox,a="RearrangeSelectedMapLayerRequest",r=s.getRequestBuilder(a),o=r(e.defaultBaseLayer,0);s.request(this,o)},setupLayers:function(){var e=this;delete this.layerRefs,this.layerRefs={};for(var t=this._sandbox.findAllSelectedMapLayers(),i=0;i<t.length;++i)e.addLayer(t[i])},openSelection:function(){var e=this.element.find("div.header div.header-icon");e.removeClass("icon-arrow-white-right"),e.addClass("icon-arrow-white-down"),this.element.find("div.content").show()},closeSelection:function(){var e=this.element.find("div.header div.header-icon");e.removeClass("icon-arrow-white-down"),e.addClass("icon-arrow-white-right"),this.element.find("div.content").hide()},getBaseLayers:function(){for(var e=this.element.find("div.content div.baselayers div.layer input"),t=[],i=null,n=0;n<e.length;++n){var s=jQuery(e[n]);t.push(s.val()),s.is(":checked")&&(i=s.val())}return{baseLayers:t,defaultBaseLayer:i}},_createUI:function(){var e=this;this.element||(this.element=this.template.clone());var t=this.getMapModule().getLocalization("plugin",!0),i=t[this.__name],n=this.element.find("div.header");n.append(i.title),n.bind("click",function(){var t=e.element.find("div.content");t.is(":hidden")?e.openSelection():e.closeSelection()}),this.closeSelection(),this.setupLayers();var s=jQuery("div.mapplugins.left");if(s&&0!=s.length){var a=s.find("div");a&&0!=a.length?a.first().before(this.element):s.append(this.element)}else{s=jQuery(this._map.div);var r=this.element.find("div.content");r.addClass("mapplugin"),s.append(this.element)}this.conf&&this.conf.toolStyle&&this.changeToolStyle(this.conf.toolStyle,this.element),this.conf&&this.conf.font&&this.changeFont(this.conf.font,this.element),this.conf&&this.conf.colourScheme&&this.changeColourScheme(this.conf.colourScheme,this.element)},changeToolStyle:function(e,t){if(t=t||this.element,t&&e){var i=this,n=this.getMapModule().getLocalization("plugin",!0),s=t.find("div.header"),a=this.templateHeaderArrow.clone(),r=t.find("div.content"),o=this.templateContentHeader.clone(),l=this.getMapModule().getImageUrl(),u=l+"/framework/bundle/mapmodule-plugin/plugin/layers/images/",c=u+"map-layer-button-"+e+".png";t.addClass("published-styled-layerselector"),r.addClass("published-styled-layerselector-content"),s.addClass("published-styled-layerselector-header"),r.find("div.content-header").remove(),r.find("div.styled-header-arrow").remove(),o.find("div.content-header-title").append(n[this.__name].title),r.prepend(o),r.prepend(a),o.find("div.content-close").on("click",function(){i.closeSelection()}),r.addClass("layerselection-styled-content"),this.getMapModule().changeCssClasses("oskari-publisher-layers-"+e,/oskari-publisher-layers-/,[r]),this.getMapModule().changeCssClasses("oskari-publisher-layers-header-"+e,/oskari-publisher-layers-header-/,[o]),s.empty(),s.css({"background-image":'url("'+c+'")'}),this.conf&&this.conf.colourScheme&&this.changeColourScheme(this.conf.colourScheme,this.element)}},changeColourScheme:function(e,t){if(t=t||this.element,t&&e){t.find("div.content-header").css({"background-color":e.bgColour}),t.find("div.styled-header-arrow").css({"border-bottom-color":e.bgColour});var i=t.find("div.content-header div.content-close");i.removeClass("icon-close").removeClass("icon-close-white"),i.addClass(e.iconCls),t.find("div.content-header div.content-header-title").css({color:e.titleColour})}},changeFont:function(e,t){if(t=t||this.element,t&&e){var i="oskari-publisher-font-"+e,n=/oskari-publisher-font-/;this.getMapModule().changeCssClasses(i,n,[t])}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.LayersPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this._visibilityPollingInterval=1500,this._visibilityCheckOrder=0,this._previousTimer=null},{__name:"LayersPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},getMap:function(){return this._map},register:function(){},unregister:function(){},init:function(e){this.requestHandlers={layerVisibilityHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapLayerVisibilityRequestHandler",e,this),layerContentHandler:Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.request.MapMoveByLayerContentRequestHandler",e,this)}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);e.addRequestHandler("MapModulePlugin.MapLayerVisibilityRequest",this.requestHandlers.layerVisibilityHandler),e.addRequestHandler("MapModulePlugin.MapMoveByLayerContentRequest",this.requestHandlers.layerContentHandler)},stopPlugin:function(e){e.removeRequestHandler("MapModulePlugin.MapLayerVisibilityRequest",this.requestHandlers.layerVisibilityHandler),e.removeRequestHandler("MapModulePlugin.MapMoveByLayerContentRequest",this.requestHandlers.layerContentHandler);for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterRearrangeSelectedMapLayerEvent:function(e){this._afterRearrangeSelectedMapLayerEvent(e)},MapMoveStartEvent:function(){this._visibilityCheckOrder++,this._previousTimer&&(clearTimeout(this._previousTimer),this._previousTimer=null)},AfterMapMoveEvent:function(){this._scheduleVisiblityCheck()},AfterMapLayerAddEvent:function(e){this._parseGeometryForLayer(e.getMapLayer()),this._scheduleVisiblityCheck()}},_scheduleVisiblityCheck:function(){var e=this;this._previousTimer&&(clearTimeout(this._previousTimer),this._previousTimer=null),this._visibilityCheckOrder++,this._previousTimer=setTimeout(function(){e._checkLayersVisibility(e._visibilityCheckOrder)},this._visibilityPollingInterval)},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(){},_parseGeometryForLayer:function(e){if(e.getGeometry&&0==e.getGeometry().length){var t=e.getGeometryWKT();if(!t)return;var i=new OpenLayers.Format.WKT,n=i.read(t);if(n){n.constructor!=Array&&(n=[n]);for(var s=[],a=0;a<n.length;++a)s.push(n[a].geometry);e.setGeometry(s)}}},_checkLayersVisibility:function(e){if(e==this._visibilityCheckOrder){for(var t=this._sandbox.findAllSelectedMapLayers(),i=0;i<t.length;++i){var n=t[i];n.isVisible()&&this.notifyLayerVisibilityChanged(n)}this._visibilityCheckScheduled=!1}},_isInScale:function(e){var t=this._sandbox.getMap().getScale();return e.isInScale(t)},isInGeometry:function(e){var t=e.getGeometry();if(!t)return!0;if(0==t.length)return!0;for(var i=this.getMap().getExtent(),n=0;n<t.length;++n){var s=t[n].getBounds();if(s&&s.intersectsBounds(i))return!0}return!1},notifyLayerVisibilityChanged:function(e){var t=e.isVisible(),i=e.isVisible();e.isVisible()&&(t=this._isInScale(e),i=this.isInGeometry(e)),this.getMap();var n=this.getMapModule().getOLMapLayers(e.getId()),s=n.length?n[0]:null;t&&i&&e.isVisible()?s&&!s.getVisibility()&&(s.setVisibility(!0),s.display(!0)):s&&s.getVisibility()&&(s.setVisibility(!1),s.display(!1));var a=this._sandbox.getEventBuilder("MapLayerVisibilityChangedEvent")(e,t,i);this._sandbox.notifyAll(a)},_afterRearrangeSelectedMapLayerEvent:function(){var e=this._sandbox.findAllSelectedMapLayers(),t=0,i=this._map.layers.length,n=this._map.getLayersByName("Markers");n.length>0&&(this._map.setLayerIndex(n[0],i),i--);for(var s=0,a=e.length;a>s;s++)for(var r=this.getMapModule().getOLMapLayers(e[s].getId()),o=0,l=r.length;l>o;o++)this._map.setLayerIndex(r[o],t),t++}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapLayerVisibilityRequest",function(e,t){this._creator=null,this._mapLayerId=e,this._visible=t},{__name:"MapModulePlugin.MapLayerVisibilityRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId},getVisible:function(){return this._visible}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapLayerVisibilityRequestHandler",function(e,t){this.sandbox=e,this.layersPlugin=t},{handleRequest:function(e,t){var i=t.getMapLayerId(),n=this.sandbox.findMapLayerFromSelectedMapLayers(i);if(n&&n.isVisible()!=t.getVisible()){n.setVisible(t.getVisible()),this.layersPlugin.getMap();for(var s=this.layersPlugin.getMapModule(),a=s.getOLMapLayers(n.getId()),r=0;r<a.length;r++)a[r].setVisibility(n.isVisible()),a[r].display(n.isVisible());this.layersPlugin.notifyLayerVisibilityChanged(n)}}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapMoveByLayerContentRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"MapModulePlugin.MapMoveByLayerContentRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapMoveByLayerContentRequestHandler",function(e,t){this.sandbox=e,this.layersPlugin=t},{handleRequest:function(e,t){var i=t.getMapLayerId(),n=this.sandbox.findMapLayerFromSelectedMapLayers(i);if(n){var s=this.layersPlugin.getMapModule().getClosestZoomLevel(n.getMinScale(),n.getMaxScale());if(this.layersPlugin.getMapModule().setZoomLevel(s,!0),n.getGeometry().length>0){var a=this.layersPlugin.isInGeometry(n);if(!a){var r=n.getGeometry()[0].getCentroid();this.layersPlugin.getMapModule().moveMapToLanLot(new OpenLayers.LonLat(r.x,r.y))}}this.layersPlugin.getMapModule().notifyMoveEnd(),this.layersPlugin._checkLayersVisibility(this.layersPlugin._visibilityCheckOrder)}}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.MapLayerVisibilityChangedEvent",function(e,t,i){this._mapLayer=e,this._inScale=1==t,this._geomMatch=0!=i},{__name:"MapLayerVisibilityChangedEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer},isInScale:function(){return this._inScale},isGeometryMatch:function(){return this._geomMatch}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.WmsLayerPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={}},{__name:"WmsLayerPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("wmslayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("wmslayer",null)},init:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this._afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this._afterChangeMapLayerOpacityEvent(e)},AfterChangeMapLayerStyleEvent:function(e){this._afterChangeMapLayerStyleEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var n=e[i],s=n.getId();n.isLayerOfType("WMS")&&(t.printDebug("preselecting "+s),this._addMapLayerToMap(n,!0,n.isBaseLayer()))}},_afterMapLayerAddEvent:function(e){this._addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},_addMapLayerToMap:function(e,t,i){if(e.isLayerOfType("WMS")){var n=this._map.getLayersByName("Markers");if(n)for(var s=0;s<n.length;s++)n[s]&&this._map.removeLayer(n[s],!1);var a=[],r="layer_";(e.isGroupLayer()||e.isBaseLayer()||1==i)&&e.getSubLayers().length>0?(a=e.getSubLayers(),r="basemap_"):a.push(e);for(var o=0,l=a.length;l>o;o++){var u=a[o],c={layers:u.getWmsName(),transparent:!0,id:u.getId(),styles:u.getCurrentStyle().getName(),format:"image/png"},h={layerId:u.getWmsName(),isBaseLayer:!1,displayInLayerSwitcher:!1,visibility:!0,buffer:0},d=u.getParams(),p=u.getOptions();if(u.getMaxScale()||u.getMinScale()){var f=this.getMapModule().calculateLayerResolutions(u.getMaxScale(),u.getMinScale());h.resolutions=f}for(var m in d)c[m]=d[m];for(var m in p)h[m]=p[m];var g=new OpenLayers.Layer.WMS(r+u.getId(),u.getWmsUrls(),c,h);g.opacity=u.getOpacity()/100,this._map.addLayer(g),this._sandbox.printDebug("#!#! CREATED OPENLAYER.LAYER.WMS for "+u.getId()),t?this._map.setLayerIndex(g,this._map.layers.length):this._map.setLayerIndex(g,0)}if(n)for(var s=0;s<n.length;s++)n[s]&&this._map.addLayer(n[s])}},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this._removeMapLayerFromMap(t)},_removeMapLayerFromMap:function(e){if(e.isLayerOfType("WMS"))if(e.isBaseLayer()||e.isGroupLayer())if(e.getSubLayers().length>0)for(var t=0;t<e.getSubLayers().length;t++){var i=e.getSubLayers()[t],n=this._map.getLayersByName("basemap_"+i.getId());n&&n[0]&&n[0].destroy&&n[0].destroy()}else{var n=this._map.getLayersByName("layer_"+e.getId());n[0].destroy()}else{var n=this._map.getLayersByName("layer_"+e.getId());n[0].destroy()}},getOLMapLayers:function(e){if(!e.isLayerOfType("WMS"))return null;if(e.isBaseLayer()||e.isGroupLayer()){if(e.getSubLayers().length>0){for(var t=[],i=0;i<e.getSubLayers().length;i++){var n=this._map.getLayersByName("basemap_"+e.getSubLayers()[i].getId());t.push(n[0])}return t}return this._map.getLayersByName("layer_"+e.getId())}return this._map.getLayersByName("layer_"+e.getId())},_afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(t.isLayerOfType("WMS"))if(t.isBaseLayer()||t.isGroupLayer())if(t.getSubLayers().length>0)for(var i=0;i<t.getSubLayers().length;i++){var n=this._map.getLayersByName("basemap_"+t.getSubLayers()[i].getId());n[0].setOpacity(t.getOpacity()/100)}else{var n=this._map.getLayersByName("layer_"+t.getId());null!=n[0]&&n[0].setOpacity(t.getOpacity()/100)}else{this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var n=this._map.getLayersByName("layer_"+t.getId());null!=n[0]&&n[0].setOpacity(t.getOpacity()/100)}},_afterChangeMapLayerStyleEvent:function(e){if(e.getMapLayer().isLayerOfType("WMS")){var t=e.getMapLayer();if(!t.isBaseLayer()){var i=this._map.getLayersByName("layer_"+t.getId());null!=i&&i[0].mergeNewParams({styles:t.getCurrentStyle().getName()})}}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.VectorLayerPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this._sldFormat=new OpenLayers.Format.SLD({multipleSymbolizers:!1,namedLayersAsArray:!0})},{__name:"VectorLayerPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("vectorlayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("vectorlayer",null)},init:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this.registerVectorFormats(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this.afterMapLayerRemoveEvent(e)},FeaturesAvailableEvent:function(e){this.handleFeaturesAvailableEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this._sandbox,i=0;i<e.length;i++){var n=e[i],s=n.getId();n.isLayerOfType("VECTOR")&&(t.printDebug("preselecting "+s),this.addMapLayerToMap(n,!0,n.isBaseLayer()))}},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},registerVectorFormat:function(e,t){this._supportedFormats[e]=t},registerVectorFormats:function(){this.registerVectorFormat("application/json",new OpenLayers.Format.GeoJSON({})),this.registerVectorFormat("application/nlsfi-x-openlayers-feature",new function(){this.read=function(e){return e}})},addMapLayerToMap:function(e,t){if(e.isLayerOfType("VECTOR")){var i=this._map.getLayersByName("Markers");this._map.removeLayer(i[0],!1);var n=new OpenLayers.StyleMap,s={styleMap:n},a=e.getStyledLayerDescriptor();if(a){this._sandbox.printDebug(a);var r=this._sldFormat.read(a);window.styleInfo=r;var o=r.namedLayers[0].userStyles,l=o[0];n.styles["default"]=l}var u=new OpenLayers.Layer.Vector("layer_"+e.getId(),s);u.opacity=e.getOpacity()/100,this._map.addLayer(u),this._sandbox.printDebug("#!#! CREATED VECTOR / OPENLAYER.LAYER.VECTOR for "+e.getId()),t?this._map.setLayerIndex(u,this._map.layers.length):this._map.setLayerIndex(u,0),this._map.addLayer(i[0])}},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.removeMapLayerFromMap(t)},removeMapLayerFromMap:function(e){if(e.isLayerOfType("VECTOR")){var t=this._map.getLayersByName("layer_"+e.getId());t[0].destroy()}},getOLMapLayers:function(e){return e.isLayerOfType("VECTOR")?this._map.getLayersByName("layer_"+e.getId()):void 0},handleFeaturesAvailableEvent:function(e){var t=e.getMapLayer(),i=e.getMimeType(),n=e.getFeatures(),s=e.getOp(),a=this._map.getLayersByName("layer_"+t.getId())[0];if(a){s&&"replace"==s&&a.removeFeatures(a.features);var r=this._supportedFormats[i];if(r){var o=r.read(n);a.addFeatures(o)}}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.GeoLocationPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._locationIsSet=!1},{__name:"GeoLocationPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!1},init:function(){},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this),this._setupLocation()},stopPlugin:function(e){e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},hasSetLocation:function(){return this._locationIsSet},_setupLocation:function(){var e=this,t=function(t,i){var n=e.getMapModule().transformCoordinates(new OpenLayers.LonLat(t,i),"EPSG:4326");e.getMapModule().centerMap(n,6),e._locationIsSet=!0};if(navigator.geolocation)navigator.geolocation.getCurrentPosition(function(e){var i=e.coords.latitude,n=e.coords.longitude;t(n,i)},function(){},{maximumAge:36e5,timeout:6e3});else if("function"==typeof window.geoip_latitude&&"function"==typeof window.geoip_longitude){var i=geoip_latitude(),n=geoip_longitude();t(n,i)}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.ToolSelectionRequest",function(e){this._toolId=e},{tools:{navigate:"map_control_navigate_tool",zoom:"map_control_zoom_tool",previous:"map_control_tool_prev",next:"map_control_tool_prev",measure:"map_control_measure_tool",measure_area:"map_control_measure_area_tool",select:"map_control_select_tool",draw_area:"map_control_draw_area_tool"},__name:"ToolSelectionRequest",getName:function(){return this.__name},getToolId:function(){return this._toolId},setToolId:function(e){this._toolId=e},getNamespace:function(){return-1==this._toolId.indexOf(".")?"":this._toolId.substring(0,this._toolId.lastIndexOf("."))},getToolName:function(){return-1==this._toolId.indexOf(".")?this._toolId:this._toolId.substring(this._toolId.lastIndexOf("."))}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.ToolSelectionHandler",function(e,t){this.sandbox=e,this.controlsPlugin=t},{handleRequest:function(e,t){t.getToolId(),t.getNamespace();var i=t.getToolName();if("map_control_tool_prev"==i){var n=this.sandbox.findRegisteredModuleInstance("StateHandler");n&&n.historyMovePrevious()}else if("map_control_tool_next"==i){var n=this.sandbox.findRegisteredModuleInstance("StateHandler");n&&n.historyMoveNext()}else if("map_control_select_tool"==i){var s=this.sandbox.findRegisteredModuleInstance("SketchLayerPlugin");s&&s.clearBbox()}else"map_control_zoom_tool"==i&&this.controlsPlugin._zoomBoxTool?this.controlsPlugin._zoomBoxTool.activate():"map_control_measure_tool"==i&&this.controlsPlugin._measureControls?this.controlsPlugin._measureControls.line.activate():"map_control_measure_area_tool"==i&&this.controlsPlugin._measureControls&&this.controlsPlugin._measureControls.area.activate()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapLayerUpdateRequest",function(e,t,i){this._layerId=e,this._forced=1==t,this._parameters=i},{__name:"MapModulePlugin.MapLayerUpdateRequest",getName:function(){return this.__name},getLayerId:function(){return this._layerId},isForced:function(){return this._forced},getParameters:function(){return this._parameters},setParameters:function(e){this._parameters=e}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapLayerUpdateRequestHandler",function(e,t){this.sandbox=e,this.mapModule=t},{handleRequest:function(e,t){var i=t.getLayerId(),n=t.isForced(),s=t.getParameters(),a=this.sandbox,r=a.findMapLayerFromSelectedMapLayers(i);if(r)if(s&&r.isLayerOfType("WMS")){var o=this.mapModule.getOLMapLayers(i),l=0;if(o){l=o.length;for(var u=0;u<o.length;++u)o[u].mergeNewParams(s)}this.sandbox.printDebug("[MapLayerUpdateRequestHandler] WMS layer / merge new params: "+i+", found "+l)}else{var o=this.mapModule.getOLMapLayers(i),l=0;if(o){l=o.length;for(var u=0;u<o.length;++u)o[u].redraw(n)}this.sandbox.printDebug("[MapLayerUpdateRequestHandler] Layer / update layer "+i+", found "+l)}}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.MapMoveRequestHandler",function(e,t){this.sandbox=e,this.mapModule=t},{handleRequest:function(e,t){var i=t.getCenterX(),n=t.getCenterY(),s=t.getMarker(),a=t.getZoom(),r=t.getSrsName(),o=new OpenLayers.LonLat(i,n);
if(r&&this.mapModule.getProjection()!==r){var l=Proj4js.defs[r];if(!l)throw"SrsName not supported!";o=this.mapModule.transformCoordinates(o,r)}this.mapModule.moveMapToLanLot(o,a,!1),(a||0===a)&&("OpenLayers.Bounds"===a.CLASS_NAME?this.mapModule._map.zoomToExtent(a):this.mapModule._map.zoomTo(a)),this.mapModule._updateDomain(),s&&this.mapModule._drawMarker(),this.mapModule.notifyMoveEnd(),this.sandbox.printDebug("[MapMoveRequestHandler] map moved")}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.MapClickedEvent",function(e,t,i){this._lonlat=e,this._mouseX=Math.floor(t),this._mouseY=Math.floor(i)},{__name:"MapClickedEvent",getName:function(){return this.__name},getLonLat:function(){return this._lonlat},getMouseX:function(){return this._mouseX},getMouseY:function(){return this._mouseY}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.EscPressedEvent",function(){},{__name:"EscPressedEvent",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.GetInfoResultEvent",function(e){this._data=e},{__name:"GetInfoResultEvent",getName:function(){return this.__name},getData:function(){return this._data}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.event.MapSizeChangedEvent",function(e,t){this._width=e,this._height=t},{__name:"MapSizeChangedEvent",getName:function(){return this.__name},getWidth:function(){return this._width},getHeight:function(){return this._height}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.request.ClearHistoryRequest",function(){},{__name:"ClearHistoryRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.controls.ClearHistoryHandler",function(e,t){this.mapModule=t,this.sandbox=e},{handleRequest:function(){this.mapModule.clearNavigationHistory()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.Portti2Zoombar",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.__templates={},this.__elements={},this.__parent=null,this._slider=null,this._zoombar_messages={},this._suppressEvents=!1,this._conf=e},{__name:"Portti2Zoombar",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},hasUI:function(){return!0},setMapModule:function(e){this.mapModule=e,e&&(this._map=e.getMap(),this.pluginName=e.getName()+this.__name)},init:function(){this.__templates.zoombar=jQuery('<div class="oskariui mapplugin pzbDiv"><div class="pzbDiv-plus"  title="Katu"></div><input type=\'hidden\' /><div class="slider"></div><div class="pzbDiv-minus"  title="Koko Maa"></div></div>')},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this._draw(),this._setZoombarValue(this._map.getZoom())},stopPlugin:function(e){this.__elements.zoombarSlider&&(this.__elements.zoombarSlider.remove(),this._slider.remove(),delete this.__elements.zoombarSlider),e.unregister(this),this._sandbox=null},_draw:function(){var e=this;e.__parent||(e.__parent=this._map.div),e.__elements.zoombarSlider||(e.__elements.zoombarSlider=e.__templates.zoombar.clone());var t="pzb-input-"+this.getName(),i="pzb-slider-"+this.getName(),n=e.__elements.zoombarSlider.find("div.slider");e.__elements.zoombarSlider.find("input").attr("id",t),n.attr("id",i),e.__elements.zoombarSlider.mousedown(function(e){e.stopPropagation()}),jQuery(e.__parent).append(e.__elements.zoombarSlider);var n=e.__elements.zoombarSlider.find("div.slider");n.css("height",11*this._map.getNumZoomLevels()+"px"),e._slider=n.slider({orientation:"vertical",range:"min",min:0,max:this._map.getNumZoomLevels()-1,value:this._map.getZoom(),slide:function(t,i){e.getMapModule().zoomTo(i.value)}});var s=e.__elements.zoombarSlider.find(".pzbDiv-plus");s.bind("click",function(){e._slider.slider("value")<e._map.getNumZoomLevels()&&e.getMapModule().zoomTo(e._slider.slider("value")+1)});var a=e.__elements.zoombarSlider.find(".pzbDiv-minus");a.bind("click",function(){e._slider.slider("value")>0&&e.getMapModule().zoomTo(e._slider.slider("value")-1)}),this._conf&&this._conf.location&&e.setZoombarLocation(this._conf.location,e.__elements.zoombarSlider),e._conf&&e._conf.toolStyle&&e.changeToolStyle(e._conf.toolStyle,e.__elements.zoombarSlider)},_setZoombarValue:function(e){var t=this;t._slider&&(this._suppressEvents=!0,t._slider.slider("value",e),this._suppressEvents=!1)},setZoombarLocation:function(e,t){t||(t=this.__elements.zoombarSlider),e.top&&(t.css("bottom","auto"),t.css("top",e.top)),e.left&&(t.css("right","auto"),t.css("left",e.left)),e.right&&(t.css("left","auto"),t.css("right",e.right)),e.bottom&&(t.css("top","auto"),t.css("bottom",e.bottom))},eventHandlers:{AfterMapMoveEvent:function(e){if(this._sandbox){var t=this;t._setZoombarValue(e.getZoom())}}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},start:function(){},stop:function(){},changeToolStyle:function(e,t){if(t=t||this.__elements.zoombarSlider,e&&t){var i=this.getMapModule().getImageUrl(),n=i+"/framework/bundle/mapmodule-plugin/plugin/portti2zoombar/images/",s=e.val,a=n+"zoombar-"+s+".png",r=n+"zoombar-cursor-"+s+".png",o=n+"zoombar_minus-"+s+".png",l=n+"zoombar_plus-"+s+".png",u=t.find(".ui-slider-vertical"),c=t.find(".ui-slider-handle"),h=t.find(".pzbDiv-plus"),d=t.find(".pzbDiv-minus"),p=t.find("div.slider"),f=s.match(/^rounded/),m=this._map.getNumZoomLevels()*e.heightCenter;u.css({"background-image":'url("'+a+'")',width:e.widthCenter,"margin-left":"0"}),c.css({"background-image":'url("'+r+'")',width:e.widthCursor,height:e.heightCursor,"margin-left":f?"2px":"0"}),h.css({"background-image":'url("'+l+'")',width:e.widthPlus,height:e.heightPlus}),d.css({"background-image":'url("'+o+'")',width:e.widthMinus,height:e.heightMinus}),p.css({height:m+"px"})}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapmodule.plugin.PanButtons",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.__templates={},this.__elements={},this.__parent=null,this.__conf=e,this.__prestart=null},{__name:"PanButtons",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},hasUI:function(){return!0},setMapModule:function(e){this.mapModule=e,e&&(this._map=e.getMap(),this.pluginName=e.getName()+this.__name)},init:function(){var e=(new Date).getTime()+"";this.__templates.pan=jQuery('<div class="mapplugin panbuttonDiv"><div>  <img class="panbuttonDivImg" usemap="#panbuttons_'+e+'">'+'    <map name="panbuttons_'+e+'">'+'      <area shape="circle" '+'class="panbuttons_center" '+'coords="45,45,20" href="#">'+'      <area shape="polygon" '+'class="panbuttons_left" '+'coords="13,20,25,30,20,45,27,65,13,70,5,45" '+'href="#">'+'      <area shape="polygon" '+'class="panbuttons_up" '+'coords="30,8,45,4,60,8,60,23,45,20,30,23" '+'href="#">'+'      <area shape="polygon" '+'class="panbuttons_right" '+'coords="79,20,67,30,72,45,65,65,79,70,87,45" '+'href="#">'+'      <area shape="polygon" '+'class="panbuttons_down" '+'coords="30,82,45,86,60,82,60,68,45,70,30,68" '+'href="#">'+"    </map>"+"  </img>"+"</div>"+"</div>")},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);var t=null;if(this._map.div&&(t=jQuery(this._map.div).find(".pzbDiv")),this.__conf&&this.__conf.location&&this.__conf.location.top&&t){var i=this,n=i.__conf.location.top;"auto"==n?n=10:n.indexOf("px")>=0&&(n=n.substring(0,n.indexOf("px"))),jQuery(i._map.div).height();var s="auto",a=t.css("top"),r=t.css("bottom");a||(a="auto"),r||(r="auto"),null==i.__prestart&&(i.__prestart={zbtop:a,zbbtm:r}),n=10,s="auto",a=110,r="auto","auto"!==a&&(a+="px"),"auto"!==r&&(r+="px"),t.css("top",a),t.css("bottom",r),"auto"!==n&&(n+="px"),"auto"!==s&&(s+="px"),i.__conf.location.top=n,i.__conf.location.bottom=s,window.setTimeout(function(){var e=i.__elements.panbuttons;e&&(e.css("top",n),e.css("bottom","auto"))},50)}this._draw()},stopPlugin:function(e){this.__elements.panbuttons&&(this.__elements.panbuttons.remove(),delete this.__elements.panbuttons),this._map.div&&this.__prestart&&(zb=jQuery(this._map.div).find(".pzbDiv"),zb&&(zb.css("top",this.__prestart.zbtop),zb.css("bottom",this.__prestart.zbbtm))),e.unregister(this)},_draw:function(){var e=this;e.__parent||(e.__parent=this._map.div),e.__elements.panbuttons||(e.__elements.panbuttons=e.__templates.pan.clone());var t=e.__elements.panbuttons;jQuery(e.__parent).append(t),e.__conf&&e.__conf.location&&(e.__conf.location.top&&(t.css("bottom","auto"),t.css("top",e.__conf.location.top)),e.__conf.location.left&&(t.css("right","auto"),t.css("left",e.__conf.location.left)),e.__conf.location.right&&(t.css("left","auto"),t.css("right",e.__conf.location.right)),e.__conf.location.bottom&&(t.css("top","auto"),t.css("bottom",e.__conf.location.bottom)));var i=this.getMapModule().getImageUrl()+"/framework/bundle/mapmodule-plugin/plugin/panbuttons/images/",n=t.find(".panbuttonDivImg");n.attr("src",i+"empty.png"),e.__conf&&e.__conf.toolStyle&&e.changeToolStyle(e.__conf.toolStyle,t);var s=t.find(".panbuttons_center");s.bind("mouseover",function(){n.addClass("root")}),s.bind("mouseout",function(){n.removeClass("root")}),s.bind("click",function(){var t="StateHandler.SetStateRequest",i=e.getMapModule(),n=i.getSandbox(),s=n.getRequestBuilder(t);s?n.request(e,s()):n.resetState()});var a=t.find(".panbuttons_left");a.bind("mouseover",function(){n.addClass("left")}),a.bind("mouseout",function(){n.removeClass("left")}),a.bind("click",function(){e.getMapModule().panMapByPixels(-100,0,!0)});var r=t.find(".panbuttons_right");r.bind("mouseover",function(){n.addClass("right")}),r.bind("mouseout",function(){n.removeClass("right")}),r.bind("click",function(){e.getMapModule().panMapByPixels(100,0,!0)});var o=t.find(".panbuttons_up");o.bind("mouseover",function(){n.addClass("up")}),o.bind("mouseout",function(){n.removeClass("up")}),o.bind("click",function(){e.getMapModule().panMapByPixels(0,-100,!0)});var l=t.find(".panbuttons_down");l.bind("mouseover",function(){n.addClass("down")}),l.bind("mouseout",function(){n.removeClass("down")}),l.bind("click",function(){e.getMapModule().panMapByPixels(0,100,!0)}),t.mousedown(function(e){var t=Math.round(.5*n[0].width),i=n.offset(),s=i.left+t,a=i.top+t;Math.sqrt(Math.pow(s-e.pageX,2)+Math.pow(a-e.pageY,2))<t&&e.stopPropagation()})},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},start:function(){},stop:function(){},changeToolStyle:function(e,t){if(t=t||this.__elements.panbuttons,e&&t){var i=this.getMapModule().getImageUrl(),n=i+"/framework/bundle/mapmodule-plugin/plugin/panbuttons/images/",s=n+"panbutton-sprites-"+e+".png",a=t.find("img.panbuttonDivImg");a.css({"background-image":'url("'+s+'")'})}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.event.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/event/event.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"event-base","Bundle-Name":"mapframework.event.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.event.Bundle",Title:" mapframework.event.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("event-base","Oskari.mapframework.event.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.event.Event",function(){throw"mapframework.event.Event should not be used"},{getName:function(){throw"Running default implementation of Event.getName(). implement your own!"},setCreator:function(e){this._creator=e},getCreator:function(){return this._creator}}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.MapFullBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.mapfull.MapFullBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/enhancement/start-map-with-link-enhancement.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/request/MapResizeEnabledRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/request/MapResizeEnabledRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/request/MapWindowFullScreenRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/mapfull/request/MapWindowFullScreenRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/mapfull/css/style.css"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"mapfull","Bundle-Name":"mapframework.mapfull.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"mapframework.mapfull.Bundle",Title:"mapframework.mapfull.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("mapfull","Oskari.mapframework.bundle.mapfull.MapFullBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.MapFullBundleInstance",function(){this.map=null,this.core=null,this.sandbox=null,this.mapmodule=null,this.state=void 0,this.mapDivId="mapdiv",this.contentMapDivId="contentMap"},{getMapModule:function(){return this.mapmodule},getSandbox:function(){return this.sandbox},_createUi:function(){function e(){if(null==t.resizeEnabled||t.resizeEnabled){var e=jQuery("#"+t.contentMapDivId),n=jQuery("#"+t.mapDivId);n.height(jQuery(window).height()),e.height(jQuery(window).height());var s=e.find(".oskariui-menutoolbar");s.length>0&&s.is(":visible")&&n.height(jQuery(window).height()-s.height()),i.updateSize()}}var t=this,i=Oskari.clazz.create("Oskari.mapframework.ui.module.common.MapModule","Main",t.conf.imageLocation,t.conf.mapOptions);t.mapmodule=i;var n=t.sandbox.register(i);if(t.conf.size)jQuery("#"+t.mapDivId).width(t.conf.size.width),jQuery("#"+t.mapDivId).height(t.conf.size.height);else{var s;jQuery(window).resize(function(){clearTimeout(s),s=setTimeout(e,100)}),e()}if(i.start(t.sandbox),n.render(t.mapDivId),t.conf.plugins)for(var a=this.conf.plugins,r=0;r<a.length;r++)a[r].instance=Oskari.clazz.create(a[r].id,a[r].config),i.registerPlugin(a[r].instance),i.startPlugin(a[r].instance);t.map=n},start:function(){Proj4js.defs={"EPSG:3067":"+proj=utm +zone=35 +ellps=GRS80 +units=m +no_defs","EPSG:4326":"+title=WGS 84 +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"};var e=this,t=e.conf;e.conf.projectionDefs&&(Proj4js.defs=e.conf.projectionDefs);var i=(Oskari.getLang(),Oskari.clazz.create("Oskari.mapframework.core.Core"));e.core=i;var n=i.getSandbox();e.sandbox=n;var s=(t?t.sandbox:null)||"sandbox";Oskari.setSandbox(s,n),jQuery.ajax({type:"POST",url:t.globalMapAjaxUrl+"action_route=GetSupportedLocales",timestamp:(new Date).getTime(),success:function(e){Oskari.setSupportedLocales(e.supportedLocales)},error:function(){}}),t&&(t.mapElement&&(e.mapDivId=t.mapElement),t.mapContainer&&(e.contentMapDivId=t.mapContainer)),n.setUser(t.user),n.setAjaxUrl(t.globalMapAjaxUrl);var a=e._createServices(t),r=[];r.push(Oskari.clazz.create("Oskari.mapframework.enhancement.mapfull.StartMapWithLinkEnhancement")),i.init(a,r),e._createUi();var o=n.getService("Oskari.mapframework.service.MapLayerService"),l=t.layers;if(l)for(var u=0;u<l.length;u++){var c=o.createMapLayer(l[u]);o.addLayer(c,!0)}n.registerAsStateful(e.mediator.bundleId,this);var h=!1;if(e.mapmodule.isPluginActivated("GeoLocationPlugin")){var d=e.mapmodule.getPluginInstance("GeoLocationPlugin");h=d.hasSetLocation()}e.setState(e.state,h),e.mapResizeEnabledRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequestHandler",e),e.mapWindowFullScreenRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequestHandler",e),n.addRequestHandler("MapFull.MapResizeEnabledRequest",e.mapResizeEnabledRequestHandler),n.addRequestHandler("MapFull.MapWindowFullScreenRequest",e.mapWindowFullScreenRequestHandler)},_teardownState:function(e){for(var t=this.sandbox.findAllSelectedMapLayers(),i=this.sandbox.getRequestBuilder("RemoveMapLayerRequest"),n=0;n<t.length;n++)this.sandbox.request(e.getName(),i(t[n].getId()))},_createServices:function(e){var t=this,i=[],n=Oskari.clazz.create("Oskari.mapframework.service.MapLayerService",e.globalMapAjaxUrl+"action_route=GetMapLayers&lang="+Oskari.getLang(),t.core.getSandbox());return i.push(n),"true"==e.disableDevelopmentMode&&core.disableDebug(),i},update:function(){},stop:function(){this.sandbox.unregisterStateful(this.mediator.bundleId),alert("Stopped!")},setState:function(e,t){var i=this,n=i.sandbox.findRegisteredModuleInstance("MainMapModule");if(i._teardownState(n),e.selectedLayers)for(var s=i.sandbox.getRequestBuilder("AddMapLayerRequest"),a=i.sandbox.getRequestBuilder("ChangeMapLayerOpacityRequest"),r=i.sandbox.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest"),o=i.sandbox.getRequestBuilder("ChangeMapLayerStyleRequest"),l=e.selectedLayers.length,u=0;l>u;++u){var c=e.selectedLayers[u];i.sandbox.request(n.getName(),s(c.id,!0)),i.sandbox.request(n.getName(),r(c.id,c.hidden!==!0)),c.style&&i.sandbox.request(n.getName(),o(c.id,c.style)),c.opacity&&i.sandbox.request(n.getName(),a(c.id,c.opacity))}e.east&&t!==!0&&i.sandbox.getMap().moveTo(e.east,e.north,e.zoom),i.sandbox.syncMapState(!0)},getState:function(){var e,t,i,n=this.sandbox.getMap(),s=this.sandbox.findAllSelectedMapLayers(),a=(n.getZoom(),n.getX()),r=n.getY(),o={north:r,east:a,zoom:n.getZoom(),srs:n.getSrsName(),selectedLayers:[]};for(e=0;e<s.length;e++)t=s[e],i={id:t.getId(),opacity:t.getOpacity()},t.isVisible()||(i.hidden=!0),t.getCurrentStyle&&t.getCurrentStyle()&&t.getCurrentStyle().getName()&&"!default!"!=t.getCurrentStyle().getName()&&(i.style=t.getCurrentStyle().getName()),o.selectedLayers.push(i);return o},getStateParameters:function(){var e=this.getState(),t="zoomLevel="+e.zoom+"&coord="+e.east+"_"+e.north+"&mapLayers=",i=e.selectedLayers,n="",s=null,a=0,r=0;for(a=0,r=i.length;r>a;a++)s=i[a],s.hidden||(""!=n&&(n+=","),n+=s.id+"+"+s.opacity,n+=s.style?"+"+s.style:"+");return t+n},toggleFullScreen:function(){jQuery("#"+this.contentMapDivId).toggleClass("oskari-map-window-fullscreen"),this.mapmodule.getMap().updateSize()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.userinterface.Stateful"]}),Oskari.clazz.define("Oskari.mapframework.enhancement.mapfull.StartMapWithLinkEnhancement",function(){},{enhance:function(e){function t(e){return e===!0||"true"===e}e.printDebug("Checking if map is started with link...");var i=e.getRequestParameter("coord"),n=e.getRequestParameter("zoomLevel");e.getRequestParameter("mapLayers");var s=e.getRequestParameter("showMarker"),a=e.getRequestParameter("isCenterMarker"),r=e.getRequestParameter("keepLayersOrder");if(null===r&&(r=!0),e.getMap().setMarkerVisible(t(s)||t(a)),null!==i&&null!==n){var o;o=i.indexOf("_")>=0?i.split("_"):i.split("%20");var l=o[0],u=o[1];if(null===l||null===u)return e.printDebug("Could not parse link location. Skipping."),void 0;e.printDebug("This is startup by link, moving map..."),e.getMap().moveTo(l,u,n)}}},{protocol:["Oskari.mapframework.enhancement.Enhancement"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequest",function(e){this._creator=null,this._resizeEnabled=e},{__name:"MapFull.MapResizeEnabledRequest",getName:function(){return this.__name},getResizeEnabled:function(){return this._resizeEnabled}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapResizeEnabledRequestHandler",function(e){this.mapfull=e},{handleRequest:function(e,t){this.mapfull.resizeEnabled=t.getResizeEnabled()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequest",function(){this._creator=null},{__name:"MapFull.MapWindowFullScreenRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.mapfull.request.MapWindowFullScreenRequestHandler",function(e){this.mapfull=e},{handleRequest:function(){this.mapfull.toggleFullScreen()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.core.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/core/core.js"},{type:"text/javascript",src:"../../../../sources/framework/core/core-enhancement-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/core/core-key-listener-methods.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"core-base","Bundle-Name":"mapframework.core.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.core.Bundle",Title:" mapframework.core.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("core-base","Oskari.mapframework.core.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.core.Core",function(){this._selectedLayers=new Array,this._mapLayersHighlighted=new Array,this._map=null,this._sandbox=Oskari.clazz.create("Oskari.mapframework.sandbox.Sandbox",this),Oskari.$("sandbox")||Oskari.$("sandbox",this._sandbox),this._services=[],this._servicesByQName={},this._debug=!1,this._ctrlKeyDown=!1,this._allowMultipleHighlightLayers=!1,this._availableRequestsByName={},this._availableEventsByName={},this.externalHandlerCls={}},{init:function(e,t){if(this.printDebug("Initializing core..."),this._sandbox,this._services=e,e)for(var i=0;i<e.length;i++)this.registerService(e[i]);this.printDebug("Sandbox ready, building up domain..."),this._map=Oskari.clazz.create("Oskari.mapframework.domain.Map"),this.enhancements=t,this._doEnhancements(this.enhancements),this.printDebug("Modules started. Core ready.")},dispatch:function(e){this._sandbox.notifyAll(e)},defaultRequestHandlers:{AddMapLayerRequest:function(e){return this._handleAddMapLayerRequest(e),!0},RemoveMapLayerRequest:function(e){return this._handleRemoveMapLayerRequest(e),!0},ShowMapLayerInfoRequest:function(e){return this._handleShowMapLayerInfoRequest(e),!0},RearrangeSelectedMapLayerRequest:function(e){return this._handleRearrangeSelectedMapLayerRequest(e),!0},ChangeMapLayerOpacityRequest:function(e){return this._handleChangeMapLayerOpacityRequest(e),!0},ChangeMapLayerStyleRequest:function(e){return this._handleChangeMapLayerStyleRequest(e),!0},HighlightMapLayerRequest:function(e){return this._handleHighlightMapLayerRequest(e),!0},HighlightWFSFeatureRequest:function(e){return this.handleHighlightWFSFeatureRequest(e),!0},HideMapMarkerRequest:function(e){return this._handleHideMapMarkerRequest(e),!0},DimMapLayerRequest:function(e){return this._handleDimMapLayerRequest(e.getMapLayerId()),!0},CtrlKeyDownRequest:function(){return this._handleCtrlKeyDownRequest(),!0},CtrlKeyUpRequest:function(){return this._handleCtrlKeyUpRequest(),!0},__default:function(e){return this.printWarn("!!!"),this.printWarn("  There is no handler for"),this.printWarn("  '"+e.getName()+"'"),!1}},processRequest:function(e){var t=e.getName(),i=this.defaultRequestHandlers[t];if(i)rv=i.apply(this,[e]);else{var n=this.externalHandlerCls[t];n?rv=n.handleRequest(this,e):(i=this.defaultRequestHandlers.__default,rv=i.apply(this,[e]))}return delete e,rv},addRequestHandler:function(e,t){this.externalHandlerCls[e]=t},removeRequestHandler:function(e,t){this.externalHandlerCls[e]===t&&(this.externalHandlerCls[e]=null)},_getQNameForRequest:function(e){var t=this._availableRequestsByName[e];if(!t){this.printDebug("#!#!# ! Updating request metadata...");var i=Oskari.clazz.protocol("Oskari.mapframework.request.Request");for(p in i){var n=i[p],s=n._class.prototype.getName();this._availableRequestsByName[s]=p}this.printDebug("#!#!# ! Finished Updating request metadata..."),t=this._availableRequestsByName[e]}return t},getRequestBuilder:function(e){var t=this._getQNameForRequest(e);return t?Oskari.clazz.builder(t):void 0},_getQNameForEvent:function(e){var t=this._availableEventsByName[e];if(!t){this.printDebug("#!#!# ! Updating event metadata...");var i=Oskari.clazz.protocol("Oskari.mapframework.event.Event");for(p in i){var n=i[p],s=n._class.prototype.getName();this._availableEventsByName[s]=p}this.printDebug("#!#!# ! Finished Updating event metadata..."),t=this._availableEventsByName[e]}return t},getEventBuilder:function(e){var t=this._getQNameForEvent(e);return t?Oskari.clazz.builder(t):void 0},disableDebug:function(){this._debug=!1},enableDebug:function(){this._debug=!0},printDebug:function(e){this._debug&&null!=window.console&&(null!=window.console.debug?console.debug(e):null!=window.console.log&&console.log(e))},printWarn:function(e){null!=window.console&&console.warn(e)},registerService:function(e){this._servicesByQName[e.getQName()]=e},getService:function(e){return this._servicesByQName[e]},getMap:function(){return this._map},getSandbox:function(){return this._sandbox},getRequestParameter:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",i=new RegExp(t),n=i.exec(window.location.href);return null==n?null:n[1]},getObjectName:function(e){return e.__name},getObjectCreator:function(e){return e._creator},setObjectCreator:function(e,t){e._creator=t},copyObjectCreatorToFrom:function(e,t){e._creator=t._creator}}),Oskari.clazz.category("Oskari.mapframework.core.Core","enhancement-methods",{_doEnhancements:function(e){for(var t=0;t<e.length;t++)e[t].enhance(this)}}),Oskari.clazz.category("Oskari.mapframework.core.Core","feature-key-listener-methods",{_handleCtrlKeyDownRequest:function(){this._ctrlKeyDown=!0},_handleCtrlKeyUpRequest:function(){this._ctrlKeyDown=!1},isCtrlKeyDown:function(){return this._ctrlKeyDown}}),Oskari.clazz.define("Oskari.mapframework.bundle.oskariui.OskariUIBundle",function(){this.conf={}},{create:function(){return this},update:function(){},start:function(){var e=this.conf.partsMap||{},t=Oskari.clazz.create("Oskari.framework.bundle.oskariui.DomManager",jQuery,e);Oskari.setDomManager(t)},stop:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/oskariui/jquery-ui-1.9.1.custom.min.js"},{type:"text/javascript",src:"../../../../libraries/jquery/plugins/jquery.base64.min.js"},{type:"text/css",src:"../../../../resources/framework/bundle/oskariui/css/jquery-ui-1.9.1.custom.css"},{type:"text/css",src:"../../../../resources/framework/bundle/oskariui/bootstrap-grid.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/oskariui/DomManager.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/oskariui/Layout.js"}],locales:[]},bundle:{manifest:{"Bundle-Identifier":"oskariui","Bundle-Name":"oskariui","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("oskariui","Oskari.mapframework.bundle.oskariui.OskariUIBundle"),function(e,t){function i(t,i){var s,a,r,o=t.nodeName.toLowerCase();return"area"===o?(s=t.parentNode,a=s.name,t.href&&a&&"map"===s.nodeName.toLowerCase()?(r=e("img[usemap=#"+a+"]")[0],!!r&&n(r)):!1):(/input|select|textarea|button|object/.test(o)?!t.disabled:"a"===o?t.href||i:i)&&n(t)}function n(t){return e.expr.filters.visible(t)&&!e(t).parents().andSelf().filter(function(){return"hidden"===e.css(this,"visibility")}).length}var s=0,a=/^ui-id-\d+$/;e.ui=e.ui||{},e.ui.version||(e.extend(e.ui,{version:"1.9.1",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),e.fn.extend({_focus:e.fn.focus,focus:function(t,i){return"number"==typeof t?this.each(function(){var n=this;setTimeout(function(){e(n).focus(),i&&i.call(n)},t)}):this._focus.apply(this,arguments)},scrollParent:function(){var t;return t=e.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(e.css(this,"position"))&&/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!t.length?e(document):t},zIndex:function(i){if(i!==t)return this.css("zIndex",i);if(this.length)for(var n,s,a=e(this[0]);a.length&&a[0]!==document;){if(n=a.css("position"),("absolute"===n||"relative"===n||"fixed"===n)&&(s=parseInt(a.css("zIndex"),10),!isNaN(s)&&0!==s))return s;a=a.parent()}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++s)})},removeUniqueId:function(){return this.each(function(){a.test(this.id)&&e(this).removeAttr("id")})}}),e("<a>").outerWidth(1).jquery||e.each(["Width","Height"],function(i,n){function s(t,i,n,s){return e.each(a,function(){i-=parseFloat(e.css(t,"padding"+this))||0,n&&(i-=parseFloat(e.css(t,"border"+this+"Width"))||0),s&&(i-=parseFloat(e.css(t,"margin"+this))||0)}),i}var a="Width"===n?["Left","Right"]:["Top","Bottom"],r=n.toLowerCase(),o={innerWidth:e.fn.innerWidth,innerHeight:e.fn.innerHeight,outerWidth:e.fn.outerWidth,outerHeight:e.fn.outerHeight};e.fn["inner"+n]=function(i){return i===t?o["inner"+n].call(this):this.each(function(){e(this).css(r,s(this,i)+"px")})},e.fn["outer"+n]=function(t,i){return"number"!=typeof t?o["outer"+n].call(this,t):this.each(function(){e(this).css(r,s(this,t,!0,i)+"px")})}}),e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(i){return!!e.data(i,t)}}):function(t,i,n){return!!e.data(t,n[3])},focusable:function(t){return i(t,!isNaN(e.attr(t,"tabindex")))},tabbable:function(t){var n=e.attr(t,"tabindex"),s=isNaN(n);return(s||n>=0)&&i(t,!s)}}),e(function(){var t=document.body,i=t.appendChild(i=document.createElement("div"));
i.offsetHeight,e.extend(i.style,{minHeight:"100px",height:"auto",padding:0,borderWidth:0}),e.support.minHeight=100===i.offsetHeight,e.support.selectstart="onselectstart"in i,t.removeChild(i).style.display="none"}),function(){var t=/msie ([\w.]+)/.exec(navigator.userAgent.toLowerCase())||[];e.ui.ie=t.length?!0:!1,e.ui.ie6=6===parseFloat(t[1],10)}(),e.fn.extend({disableSelection:function(){return this.bind((e.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(e){e.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),e.extend(e.ui,{plugin:{add:function(t,i,n){var s,a=e.ui[t].prototype;for(s in n)a.plugins[s]=a.plugins[s]||[],a.plugins[s].push([i,n[s]])},call:function(e,t,i){var n,s=e.plugins[t];if(s&&e.element[0].parentNode&&11!==e.element[0].parentNode.nodeType)for(n=0;n<s.length;n++)e.options[s[n][0]]&&s[n][1].apply(e.element,i)}},contains:e.contains,hasScroll:function(t,i){if("hidden"===e(t).css("overflow"))return!1;var n=i&&"left"===i?"scrollLeft":"scrollTop",s=!1;return t[n]>0?!0:(t[n]=1,s=t[n]>0,t[n]=0,s)},isOverAxis:function(e,t,i){return e>t&&t+i>e},isOver:function(t,i,n,s,a,r){return e.ui.isOverAxis(t,n,a)&&e.ui.isOverAxis(i,s,r)}}))}(jQuery),function(e,t){var i=0,n=Array.prototype.slice,s=e.cleanData;e.cleanData=function(t){for(var i,n=0;null!=(i=t[n]);n++)try{e(i).triggerHandler("remove")}catch(a){}s(t)},e.widget=function(t,i,n){var s,a,r,o,l=t.split(".")[0];t=t.split(".")[1],s=l+"-"+t,n||(n=i,i=e.Widget),e.expr[":"][s.toLowerCase()]=function(t){return!!e.data(t,s)},e[l]=e[l]||{},a=e[l][t],r=e[l][t]=function(e,t){return this._createWidget?(arguments.length&&this._createWidget(e,t),void 0):new r(e,t)},e.extend(r,a,{version:n.version,_proto:e.extend({},n),_childConstructors:[]}),o=new i,o.options=e.widget.extend({},o.options),e.each(n,function(t,s){e.isFunction(s)&&(n[t]=function(){var e=function(){return i.prototype[t].apply(this,arguments)},n=function(e){return i.prototype[t].apply(this,e)};return function(){var t,i=this._super,a=this._superApply;return this._super=e,this._superApply=n,t=s.apply(this,arguments),this._super=i,this._superApply=a,t}}())}),r.prototype=e.widget.extend(o,{widgetEventPrefix:o.widgetEventPrefix||t},n,{constructor:r,namespace:l,widgetName:t,widgetBaseClass:s,widgetFullName:s}),a?(e.each(a._childConstructors,function(t,i){var n=i.prototype;e.widget(n.namespace+"."+n.widgetName,r,i._proto)}),delete a._childConstructors):i._childConstructors.push(r),e.widget.bridge(t,r)},e.widget.extend=function(i){for(var s,a,r=n.call(arguments,1),o=0,l=r.length;l>o;o++)for(s in r[o])a=r[o][s],r[o].hasOwnProperty(s)&&a!==t&&(i[s]=e.isPlainObject(a)?e.isPlainObject(i[s])?e.widget.extend({},i[s],a):e.widget.extend({},a):a);return i},e.widget.bridge=function(i,s){var a=s.prototype.widgetFullName;e.fn[i]=function(r){var o="string"==typeof r,l=n.call(arguments,1),u=this;return r=!o&&l.length?e.widget.extend.apply(null,[r].concat(l)):r,o?this.each(function(){var n,s=e.data(this,a);return s?e.isFunction(s[r])&&"_"!==r.charAt(0)?(n=s[r].apply(s,l),n!==s&&n!==t?(u=n&&n.jquery?u.pushStack(n.get()):n,!1):void 0):e.error("no such method '"+r+"' for "+i+" widget instance"):e.error("cannot call methods on "+i+" prior to initialization; "+"attempted to call method '"+r+"'")}):this.each(function(){var t=e.data(this,a);t?t.option(r||{})._init():new s(r,this)}),u}},e.Widget=function(){},e.Widget._childConstructors=[],e.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(t,n){n=e(n||this.defaultElement||this)[0],this.element=e(n),this.uuid=i++,this.eventNamespace="."+this.widgetName+this.uuid,this.options=e.widget.extend({},this.options,this._getCreateOptions(),t),this.bindings=e(),this.hoverable=e(),this.focusable=e(),n!==this&&(e.data(n,this.widgetName,this),e.data(n,this.widgetFullName,this),this._on(this.element,{remove:function(e){e.target===n&&this.destroy()}}),this.document=e(n.style?n.ownerDocument:n.document||n),this.window=e(this.document[0].defaultView||this.document[0].parentWindow)),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:e.noop,_getCreateEventData:e.noop,_create:e.noop,_init:e.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData(e.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:e.noop,widget:function(){return this.element},option:function(i,n){var s,a,r,o=i;if(0===arguments.length)return e.widget.extend({},this.options);if("string"==typeof i)if(o={},s=i.split("."),i=s.shift(),s.length){for(a=o[i]=e.widget.extend({},this.options[i]),r=0;r<s.length-1;r++)a[s[r]]=a[s[r]]||{},a=a[s[r]];if(i=s.pop(),n===t)return a[i]===t?null:a[i];a[i]=n}else{if(n===t)return this.options[i]===t?null:this.options[i];o[i]=n}return this._setOptions(o),this},_setOptions:function(e){var t;for(t in e)this._setOption(t,e[t]);return this},_setOption:function(e,t){return this.options[e]=t,"disabled"===e&&(this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!t).attr("aria-disabled",t),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_on:function(t,i){var n,s=this;i?(t=n=e(t),this.bindings=this.bindings.add(t)):(i=t,t=this.element,n=this.widget()),e.each(i,function(i,a){function r(){return s.options.disabled===!0||e(this).hasClass("ui-state-disabled")?void 0:("string"==typeof a?s[a]:a).apply(s,arguments)}"string"!=typeof a&&(r.guid=a.guid=a.guid||r.guid||e.guid++);var o=i.match(/^(\w+)\s*(.*)$/),l=o[1]+s.eventNamespace,u=o[2];u?n.delegate(u,l,r):t.bind(l,r)})},_off:function(e,t){t=(t||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,e.unbind(t).undelegate(t)},_delay:function(e,t){function i(){return("string"==typeof e?n[e]:e).apply(n,arguments)}var n=this;return setTimeout(i,t||0)},_hoverable:function(t){this.hoverable=this.hoverable.add(t),this._on(t,{mouseenter:function(t){e(t.currentTarget).addClass("ui-state-hover")},mouseleave:function(t){e(t.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(t){this.focusable=this.focusable.add(t),this._on(t,{focusin:function(t){e(t.currentTarget).addClass("ui-state-focus")},focusout:function(t){e(t.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(t,i,n){var s,a,r=this.options[t];if(n=n||{},i=e.Event(i),i.type=(t===this.widgetEventPrefix?t:this.widgetEventPrefix+t).toLowerCase(),i.target=this.element[0],a=i.originalEvent,a)for(s in a)s in i||(i[s]=a[s]);return this.element.trigger(i,n),!(e.isFunction(r)&&r.apply(this.element[0],[i].concat(n))===!1||i.isDefaultPrevented())}},e.each({show:"fadeIn",hide:"fadeOut"},function(t,i){e.Widget.prototype["_"+t]=function(n,s,a){"string"==typeof s&&(s={effect:s});var r,o=s?s===!0||"number"==typeof s?i:s.effect||i:t;s=s||{},"number"==typeof s&&(s={duration:s}),r=!e.isEmptyObject(s),s.complete=a,s.delay&&n.delay(s.delay),r&&e.effects&&(e.effects.effect[o]||e.uiBackCompat!==!1&&e.effects[o])?n[t](s):o!==t&&n[o]?n[o](s.duration,s.easing,a):n.queue(function(i){e(this)[t](),a&&a.call(n[0]),i()})}}),e.uiBackCompat!==!1&&(e.Widget.prototype._getCreateOptions=function(){return e.metadata&&e.metadata.get(this.element[0])[this.widgetName]})}(jQuery),function(e){var t=!1;e(document).mouseup(function(){t=!1}),e.widget("ui.mouse",{version:"1.9.1",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var t=this;this.element.bind("mousedown."+this.widgetName,function(e){return t._mouseDown(e)}).bind("click."+this.widgetName,function(i){return!0===e.data(i.target,t.widgetName+".preventClickEvent")?(e.removeData(i.target,t.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(i){if(!t){this._mouseStarted&&this._mouseUp(i),this._mouseDownEvent=i;var n=this,s=1===i.which,a="string"==typeof this.options.cancel&&i.target.nodeName?e(i.target).closest(this.options.cancel).length:!1;return s&&!a&&this._mouseCapture(i)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){n.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(i)&&this._mouseDelayMet(i)&&(this._mouseStarted=this._mouseStart(i)!==!1,!this._mouseStarted)?(i.preventDefault(),!0):(!0===e.data(i.target,this.widgetName+".preventClickEvent")&&e.removeData(i.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(e){return n._mouseMove(e)},this._mouseUpDelegate=function(e){return n._mouseUp(e)},e(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),i.preventDefault(),t=!0,!0)):!0}},_mouseMove:function(t){return!e.ui.ie||document.documentMode>=9||t.button?this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,t)!==!1,this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted):this._mouseUp(t)},_mouseUp:function(t){return e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,t.target===this._mouseDownEvent.target&&e.data(t.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(t)),!1},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}})}(jQuery),function(e,t){function i(e,t,i){return[parseInt(e[0],10)*(d.test(e[0])?t/100:1),parseInt(e[1],10)*(d.test(e[1])?i/100:1)]}function n(t,i){return parseInt(e.css(t,i),10)||0}e.ui=e.ui||{};var s,a=Math.max,r=Math.abs,o=Math.round,l=/left|center|right/,u=/top|center|bottom/,c=/[\+\-]\d+%?/,h=/^\w+/,d=/%$/,p=e.fn.position;e.position={scrollbarWidth:function(){if(s!==t)return s;var i,n,a=e("<div style='display:block;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),r=a.children()[0];return e("body").append(a),i=r.offsetWidth,a.css("overflow","scroll"),n=r.offsetWidth,i===n&&(n=a[0].clientWidth),a.remove(),s=i-n},getScrollInfo:function(t){var i=t.isWindow?"":t.element.css("overflow-x"),n=t.isWindow?"":t.element.css("overflow-y"),s="scroll"===i||"auto"===i&&t.width<t.element[0].scrollWidth,a="scroll"===n||"auto"===n&&t.height<t.element[0].scrollHeight;return{width:s?e.position.scrollbarWidth():0,height:a?e.position.scrollbarWidth():0}},getWithinInfo:function(t){var i=e(t||window),n=e.isWindow(i[0]);return{element:i,isWindow:n,offset:i.offset()||{left:0,top:0},scrollLeft:i.scrollLeft(),scrollTop:i.scrollTop(),width:n?i.width():i.outerWidth(),height:n?i.height():i.outerHeight()}}},e.fn.position=function(t){if(!t||!t.of)return p.apply(this,arguments);t=e.extend({},t);var s,d,f,m,g,y=e(t.of),v=e.position.getWithinInfo(t.within),b=e.position.getScrollInfo(v),_=y[0],w=(t.collision||"flip").split(" "),L={};return 9===_.nodeType?(d=y.width(),f=y.height(),m={top:0,left:0}):e.isWindow(_)?(d=y.width(),f=y.height(),m={top:y.scrollTop(),left:y.scrollLeft()}):_.preventDefault?(t.at="left top",d=f=0,m={top:_.pageY,left:_.pageX}):(d=y.outerWidth(),f=y.outerHeight(),m=y.offset()),g=e.extend({},m),e.each(["my","at"],function(){var e,i,n=(t[this]||"").split(" ");1===n.length&&(n=l.test(n[0])?n.concat(["center"]):u.test(n[0])?["center"].concat(n):["center","center"]),n[0]=l.test(n[0])?n[0]:"center",n[1]=u.test(n[1])?n[1]:"center",e=c.exec(n[0]),i=c.exec(n[1]),L[this]=[e?e[0]:0,i?i[0]:0],t[this]=[h.exec(n[0])[0],h.exec(n[1])[0]]}),1===w.length&&(w[1]=w[0]),"right"===t.at[0]?g.left+=d:"center"===t.at[0]&&(g.left+=d/2),"bottom"===t.at[1]?g.top+=f:"center"===t.at[1]&&(g.top+=f/2),s=i(L.at,d,f),g.left+=s[0],g.top+=s[1],this.each(function(){var l,u,c=e(this),h=c.outerWidth(),p=c.outerHeight(),_=n(this,"marginLeft"),k=n(this,"marginTop"),O=h+_+n(this,"marginRight")+b.width,x=p+k+n(this,"marginBottom")+b.height,S=e.extend({},g),C=i(L.my,c.outerWidth(),c.outerHeight());"right"===t.my[0]?S.left-=h:"center"===t.my[0]&&(S.left-=h/2),"bottom"===t.my[1]?S.top-=p:"center"===t.my[1]&&(S.top-=p/2),S.left+=C[0],S.top+=C[1],e.support.offsetFractions||(S.left=o(S.left),S.top=o(S.top)),l={marginLeft:_,marginTop:k},e.each(["left","top"],function(i,n){e.ui.position[w[i]]&&e.ui.position[w[i]][n](S,{targetWidth:d,targetHeight:f,elemWidth:h,elemHeight:p,collisionPosition:l,collisionWidth:O,collisionHeight:x,offset:[s[0]+C[0],s[1]+C[1]],my:t.my,at:t.at,within:v,elem:c})}),e.fn.bgiframe&&c.bgiframe(),t.using&&(u=function(e){var i=m.left-S.left,n=i+d-h,s=m.top-S.top,o=s+f-p,l={target:{element:y,left:m.left,top:m.top,width:d,height:f},element:{element:c,left:S.left,top:S.top,width:h,height:p},horizontal:0>n?"left":i>0?"right":"center",vertical:0>o?"top":s>0?"bottom":"middle"};h>d&&r(i+n)<d&&(l.horizontal="center"),p>f&&r(s+o)<f&&(l.vertical="middle"),l.important=a(r(i),r(n))>a(r(s),r(o))?"horizontal":"vertical",t.using.call(this,e,l)}),c.offset(e.extend(S,{using:u}))})},e.ui.position={fit:{left:function(e,t){var i,n=t.within,s=n.isWindow?n.scrollLeft:n.offset.left,r=n.width,o=e.left-t.collisionPosition.marginLeft,l=s-o,u=o+t.collisionWidth-r-s;t.collisionWidth>r?l>0&&0>=u?(i=e.left+l+t.collisionWidth-r-s,e.left+=l-i):e.left=u>0&&0>=l?s:l>u?s+r-t.collisionWidth:s:l>0?e.left+=l:u>0?e.left-=u:e.left=a(e.left-o,e.left)},top:function(e,t){var i,n=t.within,s=n.isWindow?n.scrollTop:n.offset.top,r=t.within.height,o=e.top-t.collisionPosition.marginTop,l=s-o,u=o+t.collisionHeight-r-s;t.collisionHeight>r?l>0&&0>=u?(i=e.top+l+t.collisionHeight-r-s,e.top+=l-i):e.top=u>0&&0>=l?s:l>u?s+r-t.collisionHeight:s:l>0?e.top+=l:u>0?e.top-=u:e.top=a(e.top-o,e.top)}},flip:{left:function(e,t){var i,n,s=t.within,a=s.offset.left+s.scrollLeft,o=s.width,l=s.isWindow?s.scrollLeft:s.offset.left,u=e.left-t.collisionPosition.marginLeft,c=u-l,h=u+t.collisionWidth-o-l,d="left"===t.my[0]?-t.elemWidth:"right"===t.my[0]?t.elemWidth:0,p="left"===t.at[0]?t.targetWidth:"right"===t.at[0]?-t.targetWidth:0,f=-2*t.offset[0];0>c?(i=e.left+d+p+f+t.collisionWidth-o-a,(0>i||i<r(c))&&(e.left+=d+p+f)):h>0&&(n=e.left-t.collisionPosition.marginLeft+d+p+f-l,(n>0||r(n)<h)&&(e.left+=d+p+f))},top:function(e,t){var i,n,s=t.within,a=s.offset.top+s.scrollTop,o=s.height,l=s.isWindow?s.scrollTop:s.offset.top,u=e.top-t.collisionPosition.marginTop,c=u-l,h=u+t.collisionHeight-o-l,d="top"===t.my[1],p=d?-t.elemHeight:"bottom"===t.my[1]?t.elemHeight:0,f="top"===t.at[1]?t.targetHeight:"bottom"===t.at[1]?-t.targetHeight:0,m=-2*t.offset[1];0>c?(n=e.top+p+f+m+t.collisionHeight-o-a,e.top+p+f+m>c&&(0>n||n<r(c))&&(e.top+=p+f+m)):h>0&&(i=e.top-t.collisionPosition.marginTop+p+f+m-l,e.top+p+f+m>h&&(i>0||r(i)<h)&&(e.top+=p+f+m))}},flipfit:{left:function(){e.ui.position.flip.left.apply(this,arguments),e.ui.position.fit.left.apply(this,arguments)},top:function(){e.ui.position.flip.top.apply(this,arguments),e.ui.position.fit.top.apply(this,arguments)}}},function(){var t,i,n,s,a,r=document.getElementsByTagName("body")[0],o=document.createElement("div");t=document.createElement(r?"div":"body"),n={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},r&&e.extend(n,{position:"absolute",left:"-1000px",top:"-1000px"});for(a in n)t.style[a]=n[a];t.appendChild(o),i=r||document.documentElement,i.insertBefore(t,i.firstChild),o.style.cssText="position: absolute; left: 10.7432222px;",s=e(o).offset().left,e.support.offsetFractions=s>10&&11>s,t.innerHTML="",i.removeChild(t)}(),e.uiBackCompat!==!1&&function(e){var i=e.fn.position;e.fn.position=function(n){if(!n||!n.offset)return i.call(this,n);var s=n.offset.split(" "),a=n.at.split(" ");return 1===s.length&&(s[1]=s[0]),/^\d/.test(s[0])&&(s[0]="+"+s[0]),/^\d/.test(s[1])&&(s[1]="+"+s[1]),1===a.length&&(/left|center|right/.test(a[0])?a[1]="center":(a[1]=a[0],a[0]="center")),i.call(this,e.extend(n,{at:a[0]+s[0]+" "+a[1]+s[1],offset:t}))}}(jQuery)}(jQuery),function(e){e.widget("ui.draggable",e.ui.mouse,{version:"1.9.1",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1},_create:function(){"original"==this.options.helper&&!/^(?:r|a|f)/.test(this.element.css("position"))&&(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},_destroy:function(){this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy()},_mouseCapture:function(t){var i=this.options;return this.helper||i.disabled||e(t.target).is(".ui-resizable-handle")?!1:(this.handle=this._getHandle(t),this.handle?(e(i.iframeFix===!0?"iframe":i.iframeFix).each(function(){e('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(e(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(t){var i=this.options;return this.helper=this._createHelper(t),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),e.ui.ddmanager&&(e.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,i.cursorAt&&this._adjustOffsetFromHelper(i.cursorAt),i.containment&&this._setContainment(),this._trigger("start",t)===!1?(this._clear(),!1):(this._cacheHelperProportions(),e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this._mouseDrag(t,!0),e.ui.ddmanager&&e.ui.ddmanager.dragStart(this,t),!0)},_mouseDrag:function(t,i){if(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),!i){var n=this._uiHash();if(this._trigger("drag",t,n)===!1)return this._mouseUp({}),!1;this.position=n.position}return this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px"),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),!1},_mouseStop:function(t){var i=!1;e.ui.ddmanager&&!this.options.dropBehaviour&&(i=e.ui.ddmanager.drop(this,t)),this.dropped&&(i=this.dropped,this.dropped=!1);for(var n=this.element[0],s=!1;n&&(n=n.parentNode);)n==document&&(s=!0);if(!s&&"original"===this.options.helper)return!1;if("invalid"==this.options.revert&&!i||"valid"==this.options.revert&&i||this.options.revert===!0||e.isFunction(this.options.revert)&&this.options.revert.call(this.element,i)){var a=this;e(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){a._trigger("stop",t)!==!1&&a._clear()})}else this._trigger("stop",t)!==!1&&this._clear();return!1},_mouseUp:function(t){return e("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),e.ui.ddmanager&&e.ui.ddmanager.dragStop(this,t),e.ui.mouse.prototype._mouseUp.call(this,t)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(t){var i=this.options.handle&&e(this.options.handle,this.element).length?!1:!0;return e(this.options.handle,this.element).find("*").andSelf().each(function(){this==t.target&&(i=!0)}),i},_createHelper:function(t){var i=this.options,n=e.isFunction(i.helper)?e(i.helper.apply(this.element[0],[t])):"clone"==i.helper?this.element.clone().removeAttr("id"):this.element;return n.parents("body").length||n.appendTo("parent"==i.appendTo?this.element[0].parentNode:i.appendTo),n[0]!=this.element[0]&&!/(fixed|absolute)/.test(n.css("position"))&&n.css("position","absolute"),n},_adjustOffsetFromHelper:function(t){"string"==typeof t&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left"in t&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();return"absolute"==this.cssPosition&&this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&"html"==this.offsetParent[0].tagName.toLowerCase()&&e.ui.ie)&&(t={top:0,left:0}),{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"==this.cssPosition){var e=this.element.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t=this.options;if("parent"==t.containment&&(t.containment=this.helper[0].parentNode),("document"==t.containment||"window"==t.containment)&&(this.containment=["document"==t.containment?0:e(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,"document"==t.containment?0:e(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,("document"==t.containment?0:e(window).scrollLeft())+e("document"==t.containment?document:window).width()-this.helperProportions.width-this.margins.left,("document"==t.containment?0:e(window).scrollTop())+(e("document"==t.containment?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(t.containment)||t.containment.constructor==Array)t.containment.constructor==Array&&(this.containment=t.containment);else{var i=e(t.containment),n=i[0];if(!n)return;var s=(i.offset(),"hidden"!=e(n).css("overflow"));this.containment=[(parseInt(e(n).css("borderLeftWidth"),10)||0)+(parseInt(e(n).css("paddingLeft"),10)||0),(parseInt(e(n).css("borderTopWidth"),10)||0)+(parseInt(e(n).css("paddingTop"),10)||0),(s?Math.max(n.scrollWidth,n.offsetWidth):n.offsetWidth)-(parseInt(e(n).css("borderLeftWidth"),10)||0)-(parseInt(e(n).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(s?Math.max(n.scrollHeight,n.offsetHeight):n.offsetHeight)-(parseInt(e(n).css("borderTopWidth"),10)||0)-(parseInt(e(n).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=i}},_convertPositionTo:function(t,i){i||(i=this.position);var n="absolute"==t?1:-1,s=(this.options,"absolute"!=this.cssPosition||this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent),a=/(html|body)/i.test(s[0].tagName);return{top:i.top+this.offset.relative.top*n+this.offset.parent.top*n-("fixed"==this.cssPosition?-this.scrollParent.scrollTop():a?0:s.scrollTop())*n,left:i.left+this.offset.relative.left*n+this.offset.parent.left*n-("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():a?0:s.scrollLeft())*n}},_generatePosition:function(t){var i=this.options,n="absolute"!=this.cssPosition||this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,s=/(html|body)/i.test(n[0].tagName),a=t.pageX,r=t.pageY;if(this.originalPosition){var o;if(this.containment){if(this.relative_container){var l=this.relative_container.offset();o=[this.containment[0]+l.left,this.containment[1]+l.top,this.containment[2]+l.left,this.containment[3]+l.top]}else o=this.containment;t.pageX-this.offset.click.left<o[0]&&(a=o[0]+this.offset.click.left),t.pageY-this.offset.click.top<o[1]&&(r=o[1]+this.offset.click.top),t.pageX-this.offset.click.left>o[2]&&(a=o[2]+this.offset.click.left),t.pageY-this.offset.click.top>o[3]&&(r=o[3]+this.offset.click.top)}if(i.grid){var u=i.grid[1]?this.originalPageY+Math.round((r-this.originalPageY)/i.grid[1])*i.grid[1]:this.originalPageY;r=o?u-this.offset.click.top<o[1]||u-this.offset.click.top>o[3]?u-this.offset.click.top<o[1]?u+i.grid[1]:u-i.grid[1]:u:u;var c=i.grid[0]?this.originalPageX+Math.round((a-this.originalPageX)/i.grid[0])*i.grid[0]:this.originalPageX;a=o?c-this.offset.click.left<o[0]||c-this.offset.click.left>o[2]?c-this.offset.click.left<o[0]?c+i.grid[0]:c-i.grid[0]:c:c}}return{top:r-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"==this.cssPosition?-this.scrollParent.scrollTop():s?0:n.scrollTop()),left:a-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():s?0:n.scrollLeft())}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]!=this.element[0]&&!this.cancelHelperRemoval&&this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(t,i,n){return n=n||this._uiHash(),e.ui.plugin.call(this,t,[i,n]),"drag"==t&&(this.positionAbs=this._convertPositionTo("absolute")),e.Widget.prototype._trigger.call(this,t,i,n)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),e.ui.plugin.add("draggable","connectToSortable",{start:function(t,i){var n=e(this).data("draggable"),s=n.options,a=e.extend({},i,{item:n.element});n.sortables=[],e(s.connectToSortable).each(function(){var i=e.data(this,"sortable");i&&!i.options.disabled&&(n.sortables.push({instance:i,shouldRevert:i.options.revert}),i.refreshPositions(),i._trigger("activate",t,a))})},stop:function(t,i){var n=e(this).data("draggable"),s=e.extend({},i,{item:n.element});e.each(n.sortables,function(){this.instance.isOver?(this.instance.isOver=0,n.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=!0),this.instance._mouseStop(t),this.instance.options.helper=this.instance.options._helper,"original"==n.options.helper&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",t,s))})},drag:function(t,i){var n=e(this).data("draggable"),s=this;e.each(n.sortables,function(){var a=!1,r=this;this.instance.positionAbs=n.positionAbs,this.instance.helperProportions=n.helperProportions,this.instance.offset.click=n.offset.click,this.instance._intersectsWith(this.instance.containerCache)&&(a=!0,e.each(n.sortables,function(){return this.instance.positionAbs=n.positionAbs,this.instance.helperProportions=n.helperProportions,this.instance.offset.click=n.offset.click,this!=r&&this.instance._intersectsWith(this.instance.containerCache)&&e.ui.contains(r.instance.element[0],this.instance.element[0])&&(a=!1),a})),a?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=e(s).clone().removeAttr("id").appendTo(this.instance.element).data("sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return i.helper[0]},t.target=this.instance.currentItem[0],this.instance._mouseCapture(t,!0),this.instance._mouseStart(t,!0,!0),this.instance.offset.click.top=n.offset.click.top,this.instance.offset.click.left=n.offset.click.left,this.instance.offset.parent.left-=n.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=n.offset.parent.top-this.instance.offset.parent.top,n._trigger("toSortable",t),n.dropped=this.instance.element,n.currentItem=n.element,this.instance.fromOutside=n),this.instance.currentItem&&this.instance._mouseDrag(t)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",t,this.instance._uiHash(this.instance)),this.instance._mouseStop(t,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),n._trigger("fromSortable",t),n.dropped=!1)})}}),e.ui.plugin.add("draggable","cursor",{start:function(){var t=e("body"),i=e(this).data("draggable").options;t.css("cursor")&&(i._cursor=t.css("cursor")),t.css("cursor",i.cursor)},stop:function(){var t=e(this).data("draggable").options;t._cursor&&e("body").css("cursor",t._cursor)}}),e.ui.plugin.add("draggable","opacity",{start:function(t,i){var n=e(i.helper),s=e(this).data("draggable").options;n.css("opacity")&&(s._opacity=n.css("opacity")),n.css("opacity",s.opacity)},stop:function(t,i){var n=e(this).data("draggable").options;n._opacity&&e(i.helper).css("opacity",n._opacity)}}),e.ui.plugin.add("draggable","scroll",{start:function(){var t=e(this).data("draggable");t.scrollParent[0]!=document&&"HTML"!=t.scrollParent[0].tagName&&(t.overflowOffset=t.scrollParent.offset())},drag:function(t){var i=e(this).data("draggable"),n=i.options,s=!1;i.scrollParent[0]!=document&&"HTML"!=i.scrollParent[0].tagName?(n.axis&&"x"==n.axis||(i.overflowOffset.top+i.scrollParent[0].offsetHeight-t.pageY<n.scrollSensitivity?i.scrollParent[0].scrollTop=s=i.scrollParent[0].scrollTop+n.scrollSpeed:t.pageY-i.overflowOffset.top<n.scrollSensitivity&&(i.scrollParent[0].scrollTop=s=i.scrollParent[0].scrollTop-n.scrollSpeed)),n.axis&&"y"==n.axis||(i.overflowOffset.left+i.scrollParent[0].offsetWidth-t.pageX<n.scrollSensitivity?i.scrollParent[0].scrollLeft=s=i.scrollParent[0].scrollLeft+n.scrollSpeed:t.pageX-i.overflowOffset.left<n.scrollSensitivity&&(i.scrollParent[0].scrollLeft=s=i.scrollParent[0].scrollLeft-n.scrollSpeed))):(n.axis&&"x"==n.axis||(t.pageY-e(document).scrollTop()<n.scrollSensitivity?s=e(document).scrollTop(e(document).scrollTop()-n.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<n.scrollSensitivity&&(s=e(document).scrollTop(e(document).scrollTop()+n.scrollSpeed))),n.axis&&"y"==n.axis||(t.pageX-e(document).scrollLeft()<n.scrollSensitivity?s=e(document).scrollLeft(e(document).scrollLeft()-n.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<n.scrollSensitivity&&(s=e(document).scrollLeft(e(document).scrollLeft()+n.scrollSpeed)))),s!==!1&&e.ui.ddmanager&&!n.dropBehaviour&&e.ui.ddmanager.prepareOffsets(i,t)
}}),e.ui.plugin.add("draggable","snap",{start:function(){var t=e(this).data("draggable"),i=t.options;t.snapElements=[],e(i.snap.constructor!=String?i.snap.items||":data(draggable)":i.snap).each(function(){var i=e(this),n=i.offset();this!=t.element[0]&&t.snapElements.push({item:this,width:i.outerWidth(),height:i.outerHeight(),top:n.top,left:n.left})})},drag:function(t,i){for(var n=e(this).data("draggable"),s=n.options,a=s.snapTolerance,r=i.offset.left,o=r+n.helperProportions.width,l=i.offset.top,u=l+n.helperProportions.height,c=n.snapElements.length-1;c>=0;c--){var h=n.snapElements[c].left,d=h+n.snapElements[c].width,p=n.snapElements[c].top,f=p+n.snapElements[c].height;if(r>h-a&&d+a>r&&l>p-a&&f+a>l||r>h-a&&d+a>r&&u>p-a&&f+a>u||o>h-a&&d+a>o&&l>p-a&&f+a>l||o>h-a&&d+a>o&&u>p-a&&f+a>u){if("inner"!=s.snapMode){var m=Math.abs(p-u)<=a,g=Math.abs(f-l)<=a,y=Math.abs(h-o)<=a,v=Math.abs(d-r)<=a;m&&(i.position.top=n._convertPositionTo("relative",{top:p-n.helperProportions.height,left:0}).top-n.margins.top),g&&(i.position.top=n._convertPositionTo("relative",{top:f,left:0}).top-n.margins.top),y&&(i.position.left=n._convertPositionTo("relative",{top:0,left:h-n.helperProportions.width}).left-n.margins.left),v&&(i.position.left=n._convertPositionTo("relative",{top:0,left:d}).left-n.margins.left)}var b=m||g||y||v;if("outer"!=s.snapMode){var m=Math.abs(p-l)<=a,g=Math.abs(f-u)<=a,y=Math.abs(h-r)<=a,v=Math.abs(d-o)<=a;m&&(i.position.top=n._convertPositionTo("relative",{top:p,left:0}).top-n.margins.top),g&&(i.position.top=n._convertPositionTo("relative",{top:f-n.helperProportions.height,left:0}).top-n.margins.top),y&&(i.position.left=n._convertPositionTo("relative",{top:0,left:h}).left-n.margins.left),v&&(i.position.left=n._convertPositionTo("relative",{top:0,left:d-n.helperProportions.width}).left-n.margins.left)}!n.snapElements[c].snapping&&(m||g||y||v||b)&&n.options.snap.snap&&n.options.snap.snap.call(n.element,t,e.extend(n._uiHash(),{snapItem:n.snapElements[c].item})),n.snapElements[c].snapping=m||g||y||v||b}else n.snapElements[c].snapping&&n.options.snap.release&&n.options.snap.release.call(n.element,t,e.extend(n._uiHash(),{snapItem:n.snapElements[c].item})),n.snapElements[c].snapping=!1}}}),e.ui.plugin.add("draggable","stack",{start:function(){var t=e(this).data("draggable").options,i=e.makeArray(e(t.stack)).sort(function(t,i){return(parseInt(e(t).css("zIndex"),10)||0)-(parseInt(e(i).css("zIndex"),10)||0)});if(i.length){var n=parseInt(i[0].style.zIndex)||0;e(i).each(function(e){this.style.zIndex=n+e}),this[0].style.zIndex=n+i.length}}}),e.ui.plugin.add("draggable","zIndex",{start:function(t,i){var n=e(i.helper),s=e(this).data("draggable").options;n.css("zIndex")&&(s._zIndex=n.css("zIndex")),n.css("zIndex",s.zIndex)},stop:function(t,i){var n=e(this).data("draggable").options;n._zIndex&&e(i.helper).css("zIndex",n._zIndex)}})}(jQuery),function(e){e.widget("ui.droppable",{version:"1.9.1",widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect"},_create:function(){var t=this.options,i=t.accept;this.isover=0,this.isout=1,this.accept=e.isFunction(i)?i:function(e){return e.is(i)},this.proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight},e.ui.ddmanager.droppables[t.scope]=e.ui.ddmanager.droppables[t.scope]||[],e.ui.ddmanager.droppables[t.scope].push(this),t.addClasses&&this.element.addClass("ui-droppable")},_destroy:function(){for(var t=e.ui.ddmanager.droppables[this.options.scope],i=0;i<t.length;i++)t[i]==this&&t.splice(i,1);this.element.removeClass("ui-droppable ui-droppable-disabled")},_setOption:function(t,i){"accept"==t&&(this.accept=e.isFunction(i)?i:function(e){return e.is(i)}),e.Widget.prototype._setOption.apply(this,arguments)},_activate:function(t){var i=e.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),i&&this._trigger("activate",t,this.ui(i))},_deactivate:function(t){var i=e.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),i&&this._trigger("deactivate",t,this.ui(i))},_over:function(t){var i=e.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!=this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",t,this.ui(i)))},_out:function(t){var i=e.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!=this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",t,this.ui(i)))},_drop:function(t,i){var n=i||e.ui.ddmanager.current;if(!n||(n.currentItem||n.element)[0]==this.element[0])return!1;var s=!1;return this.element.find(":data(droppable)").not(".ui-draggable-dragging").each(function(){var t=e.data(this,"droppable");return t.options.greedy&&!t.options.disabled&&t.options.scope==n.options.scope&&t.accept.call(t.element[0],n.currentItem||n.element)&&e.ui.intersect(n,e.extend(t,{offset:t.element.offset()}),t.options.tolerance)?(s=!0,!1):void 0}),s?!1:this.accept.call(this.element[0],n.currentItem||n.element)?(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",t,this.ui(n)),this.element):!1},ui:function(e){return{draggable:e.currentItem||e.element,helper:e.helper,position:e.position,offset:e.positionAbs}}}),e.ui.intersect=function(t,i,n){if(!i.offset)return!1;var s=(t.positionAbs||t.position.absolute).left,a=s+t.helperProportions.width,r=(t.positionAbs||t.position.absolute).top,o=r+t.helperProportions.height,l=i.offset.left,u=l+i.proportions.width,c=i.offset.top,h=c+i.proportions.height;switch(n){case"fit":return s>=l&&u>=a&&r>=c&&h>=o;case"intersect":return l<s+t.helperProportions.width/2&&a-t.helperProportions.width/2<u&&c<r+t.helperProportions.height/2&&o-t.helperProportions.height/2<h;case"pointer":var d=(t.positionAbs||t.position.absolute).left+(t.clickOffset||t.offset.click).left,p=(t.positionAbs||t.position.absolute).top+(t.clickOffset||t.offset.click).top,f=e.ui.isOver(p,d,c,l,i.proportions.height,i.proportions.width);return f;case"touch":return(r>=c&&h>=r||o>=c&&h>=o||c>r&&o>h)&&(s>=l&&u>=s||a>=l&&u>=a||l>s&&a>u);default:return!1}},e.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(t,i){var n=e.ui.ddmanager.droppables[t.options.scope]||[],s=i?i.type:null,a=(t.currentItem||t.element).find(":data(droppable)").andSelf();e:for(var r=0;r<n.length;r++)if(!(n[r].options.disabled||t&&!n[r].accept.call(n[r].element[0],t.currentItem||t.element))){for(var o=0;o<a.length;o++)if(a[o]==n[r].element[0]){n[r].proportions.height=0;continue e}n[r].visible="none"!=n[r].element.css("display"),n[r].visible&&("mousedown"==s&&n[r]._activate.call(n[r],i),n[r].offset=n[r].element.offset(),n[r].proportions={width:n[r].element[0].offsetWidth,height:n[r].element[0].offsetHeight})}},drop:function(t,i){var n=!1;return e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){this.options&&(!this.options.disabled&&this.visible&&e.ui.intersect(t,this,this.options.tolerance)&&(n=this._drop.call(this,i)||n),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],t.currentItem||t.element)&&(this.isout=1,this.isover=0,this._deactivate.call(this,i)))}),n},dragStart:function(t,i){t.element.parentsUntil("body").bind("scroll.droppable",function(){t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,i)})},drag:function(t,i){t.options.refreshPositions&&e.ui.ddmanager.prepareOffsets(t,i),e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){if(!this.options.disabled&&!this.greedyChild&&this.visible){var n=e.ui.intersect(t,this,this.options.tolerance),s=n||1!=this.isover?n&&0==this.isover?"isover":null:"isout";if(s){var a;if(this.options.greedy){var r=this.options.scope,o=this.element.parents(":data(droppable)").filter(function(){return e.data(this,"droppable").options.scope===r});o.length&&(a=e.data(o[0],"droppable"),a.greedyChild="isover"==s?1:0)}a&&"isover"==s&&(a.isover=0,a.isout=1,a._out.call(a,i)),this[s]=1,this["isout"==s?"isover":"isout"]=0,this["isover"==s?"_over":"_out"].call(this,i),a&&"isout"==s&&(a.isout=0,a.isover=1,a._over.call(a,i))}}})},dragStop:function(t,i){t.element.parentsUntil("body").unbind("scroll.droppable"),t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,i)}}}(jQuery),function(e){e.widget("ui.resizable",e.ui.mouse,{version:"1.9.1",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:1e3},_create:function(){var t=this,i=this.options;if(this.element.addClass("ui-resizable"),e.extend(this,{_aspectRatio:!!i.aspectRatio,aspectRatio:i.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:i.helper||i.ghost||i.animate?i.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/canvas|textarea|input|select|button|img/i)&&(this.element.wrap(e('<div class="ui-wrapper" style="overflow: hidden;"></div>').css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("resizable",this.element.data("resizable")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=i.handles||(e(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this.handles.constructor==String){"all"==this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw");var n=this.handles.split(",");this.handles={};for(var s=0;s<n.length;s++){var a=e.trim(n[s]),r="ui-resizable-"+a,o=e('<div class="ui-resizable-handle '+r+'"></div>');o.css({zIndex:i.zIndex}),"se"==a&&o.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[a]=".ui-resizable-"+a,this.element.append(o)}}this._renderAxis=function(t){t=t||this.element;for(var i in this.handles){if(this.handles[i].constructor==String&&(this.handles[i]=e(this.handles[i],this.element).show()),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/textarea|input|select|button/i)){var n=e(this.handles[i],this.element),s=0;s=/sw|ne|nw|se|n|s/.test(i)?n.outerHeight():n.outerWidth();var a=["padding",/ne|nw|n/.test(i)?"Top":/se|sw|s/.test(i)?"Bottom":/^e$/.test(i)?"Right":"Left"].join("");t.css(a,s),this._proportionallyResize()}e(this.handles[i]).length}},this._renderAxis(this.element),this._handles=e(".ui-resizable-handle",this.element).disableSelection(),this._handles.mouseover(function(){if(!t.resizing){if(this.className)var e=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i);t.axis=e&&e[1]?e[1]:"se"}}),i.autoHide&&(this._handles.hide(),e(this.element).addClass("ui-resizable-autohide").mouseenter(function(){i.disabled||(e(this).removeClass("ui-resizable-autohide"),t._handles.show())}).mouseleave(function(){i.disabled||t.resizing||(e(this).addClass("ui-resizable-autohide"),t._handles.hide())})),this._mouseInit()},_destroy:function(){this._mouseDestroy();var t=function(t){e(t).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").removeData("ui-resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};if(this.elementIsWrapper){t(this.element);var i=this.element;this.originalElement.css({position:i.css("position"),width:i.outerWidth(),height:i.outerHeight(),top:i.css("top"),left:i.css("left")}).insertAfter(i),i.remove()}return this.originalElement.css("resize",this.originalResizeStyle),t(this.originalElement),this},_mouseCapture:function(t){var i=!1;for(var n in this.handles)e(this.handles[n])[0]==t.target&&(i=!0);return!this.options.disabled&&i},_mouseStart:function(i){var n=this.options,s=this.element.position(),a=this.element;this.resizing=!0,this.documentScroll={top:e(document).scrollTop(),left:e(document).scrollLeft()},(a.is(".ui-draggable")||/absolute/.test(a.css("position")))&&a.css({position:"absolute",top:s.top,left:s.left}),this._renderProxy();var r=t(this.helper.css("left")),o=t(this.helper.css("top"));n.containment&&(r+=e(n.containment).scrollLeft()||0,o+=e(n.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:r,top:o},this.size=this._helper?{width:a.outerWidth(),height:a.outerHeight()}:{width:a.width(),height:a.height()},this.originalSize=this._helper?{width:a.outerWidth(),height:a.outerHeight()}:{width:a.width(),height:a.height()},this.originalPosition={left:r,top:o},this.sizeDiff={width:a.outerWidth()-a.width(),height:a.outerHeight()-a.height()},this.originalMousePosition={left:i.pageX,top:i.pageY},this.aspectRatio="number"==typeof n.aspectRatio?n.aspectRatio:this.originalSize.width/this.originalSize.height||1;var l=e(".ui-resizable-"+this.axis).css("cursor");return e("body").css("cursor","auto"==l?this.axis+"-resize":l),a.addClass("ui-resizable-resizing"),this._propagate("start",i),!0},_mouseDrag:function(e){var t=this.helper,i=(this.options,this.originalMousePosition),n=this.axis,s=e.pageX-i.left||0,a=e.pageY-i.top||0,r=this._change[n];if(!r)return!1;var o=r.apply(this,[e,s,a]);return this._updateVirtualBoundaries(e.shiftKey),(this._aspectRatio||e.shiftKey)&&(o=this._updateRatio(o,e)),o=this._respectSize(o,e),this._propagate("resize",e),t.css({top:this.position.top+"px",left:this.position.left+"px",width:this.size.width+"px",height:this.size.height+"px"}),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),this._updateCache(o),this._trigger("resize",e,this.ui()),!1},_mouseStop:function(t){this.resizing=!1;var i=this.options,n=this;if(this._helper){var s=this._proportionallyResizeElements,a=s.length&&/textarea/i.test(s[0].nodeName),r=a&&e.ui.hasScroll(s[0],"left")?0:n.sizeDiff.height,o=a?0:n.sizeDiff.width,l={width:n.helper.width()-o,height:n.helper.height()-r},u=parseInt(n.element.css("left"),10)+(n.position.left-n.originalPosition.left)||null,c=parseInt(n.element.css("top"),10)+(n.position.top-n.originalPosition.top)||null;i.animate||this.element.css(e.extend(l,{top:c,left:u})),n.helper.height(n.size.height),n.helper.width(n.size.width),this._helper&&!i.animate&&this._proportionallyResize()}return e("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",t),this._helper&&this.helper.remove(),!1},_updateVirtualBoundaries:function(e){var t,n,s,a,r,o=this.options;r={minWidth:i(o.minWidth)?o.minWidth:0,maxWidth:i(o.maxWidth)?o.maxWidth:1/0,minHeight:i(o.minHeight)?o.minHeight:0,maxHeight:i(o.maxHeight)?o.maxHeight:1/0},(this._aspectRatio||e)&&(t=r.minHeight*this.aspectRatio,s=r.minWidth/this.aspectRatio,n=r.maxHeight*this.aspectRatio,a=r.maxWidth/this.aspectRatio,t>r.minWidth&&(r.minWidth=t),s>r.minHeight&&(r.minHeight=s),n<r.maxWidth&&(r.maxWidth=n),a<r.maxHeight&&(r.maxHeight=a)),this._vBoundaries=r},_updateCache:function(e){this.options,this.offset=this.helper.offset(),i(e.left)&&(this.position.left=e.left),i(e.top)&&(this.position.top=e.top),i(e.height)&&(this.size.height=e.height),i(e.width)&&(this.size.width=e.width)},_updateRatio:function(e){var t=(this.options,this.position),n=this.size,s=this.axis;return i(e.height)?e.width=e.height*this.aspectRatio:i(e.width)&&(e.height=e.width/this.aspectRatio),"sw"==s&&(e.left=t.left+(n.width-e.width),e.top=null),"nw"==s&&(e.top=t.top+(n.height-e.height),e.left=t.left+(n.width-e.width)),e},_respectSize:function(e,t){var n=(this.helper,this._vBoundaries),s=(this._aspectRatio||t.shiftKey,this.axis),a=i(e.width)&&n.maxWidth&&n.maxWidth<e.width,r=i(e.height)&&n.maxHeight&&n.maxHeight<e.height,o=i(e.width)&&n.minWidth&&n.minWidth>e.width,l=i(e.height)&&n.minHeight&&n.minHeight>e.height;o&&(e.width=n.minWidth),l&&(e.height=n.minHeight),a&&(e.width=n.maxWidth),r&&(e.height=n.maxHeight);var u=this.originalPosition.left+this.originalSize.width,c=this.position.top+this.size.height,h=/sw|nw|w/.test(s),d=/nw|ne|n/.test(s);o&&h&&(e.left=u-n.minWidth),a&&h&&(e.left=u-n.maxWidth),l&&d&&(e.top=c-n.minHeight),r&&d&&(e.top=c-n.maxHeight);var p=!e.width&&!e.height;return p&&!e.left&&e.top?e.top=null:p&&!e.top&&e.left&&(e.left=null),e},_proportionallyResize:function(){if(this.options,this._proportionallyResizeElements.length)for(var t=this.helper||this.element,i=0;i<this._proportionallyResizeElements.length;i++){var n=this._proportionallyResizeElements[i];if(!this.borderDif){var s=[n.css("borderTopWidth"),n.css("borderRightWidth"),n.css("borderBottomWidth"),n.css("borderLeftWidth")],a=[n.css("paddingTop"),n.css("paddingRight"),n.css("paddingBottom"),n.css("paddingLeft")];this.borderDif=e.map(s,function(e,t){var i=parseInt(e,10)||0,n=parseInt(a[t],10)||0;return i+n})}n.css({height:t.height()-this.borderDif[0]-this.borderDif[2]||0,width:t.width()-this.borderDif[1]-this.borderDif[3]||0})}},_renderProxy:function(){var t=this.element,i=this.options;if(this.elementOffset=t.offset(),this._helper){this.helper=this.helper||e('<div style="overflow:hidden;"></div>');var n=e.ui.ie6?1:0,s=e.ui.ie6?2:-1;this.helper.addClass(this._helper).css({width:this.element.outerWidth()+s,height:this.element.outerHeight()+s,position:"absolute",left:this.elementOffset.left-n+"px",top:this.elementOffset.top-n+"px",zIndex:++i.zIndex}),this.helper.appendTo("body").disableSelection()}else this.helper=this.element},_change:{e:function(e,t){return{width:this.originalSize.width+t}},w:function(e,t){var i=(this.options,this.originalSize),n=this.originalPosition;return{left:n.left+t,width:i.width-t}},n:function(e,t,i){var n=(this.options,this.originalSize),s=this.originalPosition;return{top:s.top+i,height:n.height-i}},s:function(e,t,i){return{height:this.originalSize.height+i}},se:function(t,i,n){return e.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[t,i,n]))},sw:function(t,i,n){return e.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[t,i,n]))},ne:function(t,i,n){return e.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[t,i,n]))},nw:function(t,i,n){return e.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[t,i,n]))}},_propagate:function(t,i){e.ui.plugin.call(this,t,[i,this.ui()]),"resize"!=t&&this._trigger(t,i,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),e.ui.plugin.add("resizable","alsoResize",{start:function(){var t=e(this).data("resizable"),i=t.options,n=function(t){e(t).each(function(){var t=e(this);t.data("resizable-alsoresize",{width:parseInt(t.width(),10),height:parseInt(t.height(),10),left:parseInt(t.css("left"),10),top:parseInt(t.css("top"),10)})})};"object"!=typeof i.alsoResize||i.alsoResize.parentNode?n(i.alsoResize):i.alsoResize.length?(i.alsoResize=i.alsoResize[0],n(i.alsoResize)):e.each(i.alsoResize,function(e){n(e)})},resize:function(t,i){var n=e(this).data("resizable"),s=n.options,a=n.originalSize,r=n.originalPosition,o={height:n.size.height-a.height||0,width:n.size.width-a.width||0,top:n.position.top-r.top||0,left:n.position.left-r.left||0},l=function(t,n){e(t).each(function(){var t=e(this),s=e(this).data("resizable-alsoresize"),a={},r=n&&n.length?n:t.parents(i.originalElement[0]).length?["width","height"]:["width","height","top","left"];e.each(r,function(e,t){var i=(s[t]||0)+(o[t]||0);i&&i>=0&&(a[t]=i||null)}),t.css(a)})};"object"!=typeof s.alsoResize||s.alsoResize.nodeType?l(s.alsoResize):e.each(s.alsoResize,function(e,t){l(e,t)})},stop:function(){e(this).removeData("resizable-alsoresize")}}),e.ui.plugin.add("resizable","animate",{stop:function(t){var i=e(this).data("resizable"),n=i.options,s=i._proportionallyResizeElements,a=s.length&&/textarea/i.test(s[0].nodeName),r=a&&e.ui.hasScroll(s[0],"left")?0:i.sizeDiff.height,o=a?0:i.sizeDiff.width,l={width:i.size.width-o,height:i.size.height-r},u=parseInt(i.element.css("left"),10)+(i.position.left-i.originalPosition.left)||null,c=parseInt(i.element.css("top"),10)+(i.position.top-i.originalPosition.top)||null;i.element.animate(e.extend(l,c&&u?{top:c,left:u}:{}),{duration:n.animateDuration,easing:n.animateEasing,step:function(){var n={width:parseInt(i.element.css("width"),10),height:parseInt(i.element.css("height"),10),top:parseInt(i.element.css("top"),10),left:parseInt(i.element.css("left"),10)};s&&s.length&&e(s[0]).css({width:n.width,height:n.height}),i._updateCache(n),i._propagate("resize",t)}})}}),e.ui.plugin.add("resizable","containment",{start:function(){var i=e(this).data("resizable"),n=i.options,s=i.element,a=n.containment,r=a instanceof e?a.get(0):/parent/.test(a)?s.parent().get(0):a;if(r)if(i.containerElement=e(r),/document/.test(a)||a==document)i.containerOffset={left:0,top:0},i.containerPosition={left:0,top:0},i.parentData={element:e(document),left:0,top:0,width:e(document).width(),height:e(document).height()||document.body.parentNode.scrollHeight};else{var o=e(r),l=[];e(["Top","Right","Left","Bottom"]).each(function(e,i){l[e]=t(o.css("padding"+i))}),i.containerOffset=o.offset(),i.containerPosition=o.position(),i.containerSize={height:o.innerHeight()-l[3],width:o.innerWidth()-l[1]};var u=i.containerOffset,c=i.containerSize.height,h=i.containerSize.width,d=e.ui.hasScroll(r,"left")?r.scrollWidth:h,p=e.ui.hasScroll(r)?r.scrollHeight:c;i.parentData={element:r,left:u.left,top:u.top,width:d,height:p}}},resize:function(t){var i=e(this).data("resizable"),n=i.options,s=(i.containerSize,i.containerOffset),a=(i.size,i.position),r=i._aspectRatio||t.shiftKey,o={top:0,left:0},l=i.containerElement;l[0]!=document&&/static/.test(l.css("position"))&&(o=s),a.left<(i._helper?s.left:0)&&(i.size.width=i.size.width+(i._helper?i.position.left-s.left:i.position.left-o.left),r&&(i.size.height=i.size.width/i.aspectRatio),i.position.left=n.helper?s.left:0),a.top<(i._helper?s.top:0)&&(i.size.height=i.size.height+(i._helper?i.position.top-s.top:i.position.top),r&&(i.size.width=i.size.height*i.aspectRatio),i.position.top=i._helper?s.top:0),i.offset.left=i.parentData.left+i.position.left,i.offset.top=i.parentData.top+i.position.top;var u=Math.abs((i._helper?i.offset.left-o.left:i.offset.left-o.left)+i.sizeDiff.width),c=Math.abs((i._helper?i.offset.top-o.top:i.offset.top-s.top)+i.sizeDiff.height),h=i.containerElement.get(0)==i.element.parent().get(0),d=/relative|absolute/.test(i.containerElement.css("position"));h&&d&&(u-=i.parentData.left),u+i.size.width>=i.parentData.width&&(i.size.width=i.parentData.width-u,r&&(i.size.height=i.size.width/i.aspectRatio)),c+i.size.height>=i.parentData.height&&(i.size.height=i.parentData.height-c,r&&(i.size.width=i.size.height*i.aspectRatio))},stop:function(){var t=e(this).data("resizable"),i=t.options,n=(t.position,t.containerOffset),s=t.containerPosition,a=t.containerElement,r=e(t.helper),o=r.offset(),l=r.outerWidth()-t.sizeDiff.width,u=r.outerHeight()-t.sizeDiff.height;t._helper&&!i.animate&&/relative/.test(a.css("position"))&&e(this).css({left:o.left-s.left-n.left,width:l,height:u}),t._helper&&!i.animate&&/static/.test(a.css("position"))&&e(this).css({left:o.left-s.left-n.left,width:l,height:u})}}),e.ui.plugin.add("resizable","ghost",{start:function(){var t=e(this).data("resizable"),i=t.options,n=t.size;t.ghost=t.originalElement.clone(),t.ghost.css({opacity:.25,display:"block",position:"relative",height:n.height,width:n.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass("string"==typeof i.ghost?i.ghost:""),t.ghost.appendTo(t.helper)},resize:function(){var t=e(this).data("resizable");t.options,t.ghost&&t.ghost.css({position:"relative",height:t.size.height,width:t.size.width})},stop:function(){var t=e(this).data("resizable");t.options,t.ghost&&t.helper&&t.helper.get(0).removeChild(t.ghost.get(0))}}),e.ui.plugin.add("resizable","grid",{resize:function(t){var i=e(this).data("resizable"),n=i.options,s=i.size,a=i.originalSize,r=i.originalPosition,o=i.axis;n._aspectRatio||t.shiftKey,n.grid="number"==typeof n.grid?[n.grid,n.grid]:n.grid;var l=Math.round((s.width-a.width)/(n.grid[0]||1))*(n.grid[0]||1),u=Math.round((s.height-a.height)/(n.grid[1]||1))*(n.grid[1]||1);/^(se|s|e)$/.test(o)?(i.size.width=a.width+l,i.size.height=a.height+u):/^(ne)$/.test(o)?(i.size.width=a.width+l,i.size.height=a.height+u,i.position.top=r.top-u):/^(sw)$/.test(o)?(i.size.width=a.width+l,i.size.height=a.height+u,i.position.left=r.left-l):(i.size.width=a.width+l,i.size.height=a.height+u,i.position.top=r.top-u,i.position.left=r.left-l)}});var t=function(e){return parseInt(e,10)||0},i=function(e){return!isNaN(parseInt(e,10))}}(jQuery),function(e){e.widget("ui.selectable",e.ui.mouse,{version:"1.9.1",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch"},_create:function(){var t=this;this.element.addClass("ui-selectable"),this.dragged=!1;var i;this.refresh=function(){i=e(t.options.filter,t.element[0]),i.addClass("ui-selectee"),i.each(function(){var t=e(this),i=t.offset();e.data(this,"selectable-item",{element:this,$element:t,left:i.left,top:i.top,right:i.left+t.outerWidth(),bottom:i.top+t.outerHeight(),startselected:!1,selected:t.hasClass("ui-selected"),selecting:t.hasClass("ui-selecting"),unselecting:t.hasClass("ui-unselecting")})})},this.refresh(),this.selectees=i.addClass("ui-selectee"),this._mouseInit(),this.helper=e("<div class='ui-selectable-helper'></div>")},_destroy:function(){this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled"),this._mouseDestroy()},_mouseStart:function(t){var i=this;if(this.opos=[t.pageX,t.pageY],!this.options.disabled){var n=this.options;this.selectees=e(n.filter,this.element[0]),this._trigger("start",t),e(n.appendTo).append(this.helper),this.helper.css({left:t.clientX,top:t.clientY,width:0,height:0}),n.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var n=e.data(this,"selectable-item");n.startselected=!0,!t.metaKey&&!t.ctrlKey&&(n.$element.removeClass("ui-selected"),n.selected=!1,n.$element.addClass("ui-unselecting"),n.unselecting=!0,i._trigger("unselecting",t,{unselecting:n.element}))}),e(t.target).parents().andSelf().each(function(){var n=e.data(this,"selectable-item");if(n){var s=!t.metaKey&&!t.ctrlKey||!n.$element.hasClass("ui-selected");return n.$element.removeClass(s?"ui-unselecting":"ui-selected").addClass(s?"ui-selecting":"ui-unselecting"),n.unselecting=!s,n.selecting=s,n.selected=s,s?i._trigger("selecting",t,{selecting:n.element}):i._trigger("unselecting",t,{unselecting:n.element}),!1}})}},_mouseDrag:function(t){var i=this;if(this.dragged=!0,!this.options.disabled){var n=this.options,s=this.opos[0],a=this.opos[1],r=t.pageX,o=t.pageY;if(s>r){var l=r;r=s,s=l}if(a>o){var l=o;o=a,a=l}return this.helper.css({left:s,top:a,width:r-s,height:o-a}),this.selectees.each(function(){var l=e.data(this,"selectable-item");if(l&&l.element!=i.element[0]){var u=!1;"touch"==n.tolerance?u=!(l.left>r||l.right<s||l.top>o||l.bottom<a):"fit"==n.tolerance&&(u=l.left>s&&l.right<r&&l.top>a&&l.bottom<o),u?(l.selected&&(l.$element.removeClass("ui-selected"),l.selected=!1),l.unselecting&&(l.$element.removeClass("ui-unselecting"),l.unselecting=!1),l.selecting||(l.$element.addClass("ui-selecting"),l.selecting=!0,i._trigger("selecting",t,{selecting:l.element}))):(l.selecting&&((t.metaKey||t.ctrlKey)&&l.startselected?(l.$element.removeClass("ui-selecting"),l.selecting=!1,l.$element.addClass("ui-selected"),l.selected=!0):(l.$element.removeClass("ui-selecting"),l.selecting=!1,l.startselected&&(l.$element.addClass("ui-unselecting"),l.unselecting=!0),i._trigger("unselecting",t,{unselecting:l.element}))),l.selected&&!t.metaKey&&!t.ctrlKey&&!l.startselected&&(l.$element.removeClass("ui-selected"),l.selected=!1,l.$element.addClass("ui-unselecting"),l.unselecting=!0,i._trigger("unselecting",t,{unselecting:l.element})))}}),!1}},_mouseStop:function(t){var i=this;return this.dragged=!1,this.options,e(".ui-unselecting",this.element[0]).each(function(){var n=e.data(this,"selectable-item");n.$element.removeClass("ui-unselecting"),n.unselecting=!1,n.startselected=!1,i._trigger("unselected",t,{unselected:n.element})}),e(".ui-selecting",this.element[0]).each(function(){var n=e.data(this,"selectable-item");n.$element.removeClass("ui-selecting").addClass("ui-selected"),n.selecting=!1,n.selected=!0,n.startselected=!0,i._trigger("selected",t,{selected:n.element})}),this._trigger("stop",t),this.helper.remove(),!1}})}(jQuery),function(e){e.widget("ui.sortable",e.ui.mouse,{version:"1.9.1",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3},_create:function(){var e=this.options;this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.floating=this.items.length?"x"===e.axis||/left|right/.test(this.items[0].item.css("float"))||/inline|table-cell/.test(this.items[0].item.css("display")):!1,this.offset=this.element.offset(),this._mouseInit(),this.ready=!0},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled"),this._mouseDestroy();for(var e=this.items.length-1;e>=0;e--)this.items[e].item.removeData(this.widgetName+"-item");return this},_setOption:function(t,i){"disabled"===t?(this.options[t]=i,this.widget().toggleClass("ui-sortable-disabled",!!i)):e.Widget.prototype._setOption.apply(this,arguments)},_mouseCapture:function(t,i){var n=this;if(this.reverting)return!1;if(this.options.disabled||"static"==this.options.type)return!1;this._refreshItems(t);var s=null;if(e(t.target).parents().each(function(){return e.data(this,n.widgetName+"-item")==n?(s=e(this),!1):void 0}),e.data(t.target,n.widgetName+"-item")==n&&(s=e(t.target)),!s)return!1;if(this.options.handle&&!i){var a=!1;if(e(this.options.handle,s).find("*").andSelf().each(function(){this==t.target&&(a=!0)}),!a)return!1}return this.currentItem=s,this._removeCurrentsFromItems(),!0},_mouseStart:function(t,i,n){var s=this.options;if(this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(t),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,s.cursorAt&&this._adjustOffsetFromHelper(s.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!=this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),s.containment&&this._setContainment(),s.cursor&&(e("body").css("cursor")&&(this._storedCursor=e("body").css("cursor")),e("body").css("cursor",s.cursor)),s.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",s.opacity)),s.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",s.zIndex)),this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",t,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!n)for(var a=this.containers.length-1;a>=0;a--)this.containers[a]._trigger("activate",t,this._uiHash(this));
return e.ui.ddmanager&&(e.ui.ddmanager.current=this),e.ui.ddmanager&&!s.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(t),!0},_mouseDrag:function(t){if(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll){var i=this.options,n=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<i.scrollSensitivity?this.scrollParent[0].scrollTop=n=this.scrollParent[0].scrollTop+i.scrollSpeed:t.pageY-this.overflowOffset.top<i.scrollSensitivity&&(this.scrollParent[0].scrollTop=n=this.scrollParent[0].scrollTop-i.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<i.scrollSensitivity?this.scrollParent[0].scrollLeft=n=this.scrollParent[0].scrollLeft+i.scrollSpeed:t.pageX-this.overflowOffset.left<i.scrollSensitivity&&(this.scrollParent[0].scrollLeft=n=this.scrollParent[0].scrollLeft-i.scrollSpeed)):(t.pageY-e(document).scrollTop()<i.scrollSensitivity?n=e(document).scrollTop(e(document).scrollTop()-i.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<i.scrollSensitivity&&(n=e(document).scrollTop(e(document).scrollTop()+i.scrollSpeed)),t.pageX-e(document).scrollLeft()<i.scrollSensitivity?n=e(document).scrollLeft(e(document).scrollLeft()-i.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<i.scrollSensitivity&&(n=e(document).scrollLeft(e(document).scrollLeft()+i.scrollSpeed))),n!==!1&&e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t)}this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var s=this.items.length-1;s>=0;s--){var a=this.items[s],r=a.item[0],o=this._intersectsWithPointer(a);if(o&&a.instance===this.currentContainer&&r!=this.currentItem[0]&&this.placeholder[1==o?"next":"prev"]()[0]!=r&&!e.contains(this.placeholder[0],r)&&("semi-dynamic"==this.options.type?!e.contains(this.element[0],r):!0)){if(this.direction=1==o?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(a))break;this._rearrange(t,a),this._trigger("change",t,this._uiHash());break}}return this._contactContainers(t),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t,i){if(t){if(e.ui.ddmanager&&!this.options.dropBehaviour&&e.ui.ddmanager.drop(this,t),this.options.revert){var n=this,s=this.placeholder.offset();this.reverting=!0,e(this.helper).animate({left:s.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollLeft),top:s.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollTop)},parseInt(this.options.revert,10)||500,function(){n._clear(t)})}else this._clear(t,i);return!1}},cancel:function(){if(this.dragging){this._mouseUp({target:null}),"original"==this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var t=this.containers.length-1;t>=0;t--)this.containers[t]._trigger("deactivate",null,this._uiHash(this)),this.containers[t].containerCache.over&&(this.containers[t]._trigger("out",null,this._uiHash(this)),this.containers[t].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!=this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),e.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?e(this.domPosition.prev).after(this.currentItem):e(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(t){var i=this._getItemsAsjQuery(t&&t.connected),n=[];return t=t||{},e(i).each(function(){var i=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);i&&n.push((t.key||i[1]+"[]")+"="+(t.key&&t.expression?i[1]:i[2]))}),!n.length&&t.key&&n.push(t.key+"="),n.join("&")},toArray:function(t){var i=this._getItemsAsjQuery(t&&t.connected),n=[];return t=t||{},i.each(function(){n.push(e(t.item||this).attr(t.attribute||"id")||"")}),n},_intersectsWith:function(e){var t=this.positionAbs.left,i=t+this.helperProportions.width,n=this.positionAbs.top,s=n+this.helperProportions.height,a=e.left,r=a+e.width,o=e.top,l=o+e.height,u=this.offset.click.top,c=this.offset.click.left,h=n+u>o&&l>n+u&&t+c>a&&r>t+c;return"pointer"==this.options.tolerance||this.options.forcePointerForContainers||"pointer"!=this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>e[this.floating?"width":"height"]?h:a<t+this.helperProportions.width/2&&i-this.helperProportions.width/2<r&&o<n+this.helperProportions.height/2&&s-this.helperProportions.height/2<l},_intersectsWithPointer:function(t){var i="x"===this.options.axis||e.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,t.top,t.height),n="y"===this.options.axis||e.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,t.left,t.width),s=i&&n,a=this._getDragVerticalDirection(),r=this._getDragHorizontalDirection();return s?this.floating?r&&"right"==r||"down"==a?2:1:a&&("down"==a?2:1):!1},_intersectsWithSides:function(t){var i=e.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,t.top+t.height/2,t.height),n=e.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),s=this._getDragVerticalDirection(),a=this._getDragHorizontalDirection();return this.floating&&a?"right"==a&&n||"left"==a&&!n:s&&("down"==s&&i||"up"==s&&!i)},_getDragVerticalDirection:function(){var e=this.positionAbs.top-this.lastPositionAbs.top;return 0!=e&&(e>0?"down":"up")},_getDragHorizontalDirection:function(){var e=this.positionAbs.left-this.lastPositionAbs.left;return 0!=e&&(e>0?"right":"left")},refresh:function(e){return this._refreshItems(e),this.refreshPositions(),this},_connectWith:function(){var e=this.options;return e.connectWith.constructor==String?[e.connectWith]:e.connectWith},_getItemsAsjQuery:function(t){var i=[],n=[],s=this._connectWith();if(s&&t)for(var a=s.length-1;a>=0;a--)for(var r=e(s[a]),o=r.length-1;o>=0;o--){var l=e.data(r[o],this.widgetName);l&&l!=this&&!l.options.disabled&&n.push([e.isFunction(l.options.items)?l.options.items.call(l.element):e(l.options.items,l.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),l])}n.push([e.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):e(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(var a=n.length-1;a>=0;a--)n[a][0].each(function(){i.push(this)});return e(i)},_removeCurrentsFromItems:function(){var t=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=e.grep(this.items,function(e){for(var i=0;i<t.length;i++)if(t[i]==e.item[0])return!1;return!0})},_refreshItems:function(t){this.items=[],this.containers=[this];var i=this.items,n=[[e.isFunction(this.options.items)?this.options.items.call(this.element[0],t,{item:this.currentItem}):e(this.options.items,this.element),this]],s=this._connectWith();if(s&&this.ready)for(var a=s.length-1;a>=0;a--)for(var r=e(s[a]),o=r.length-1;o>=0;o--){var l=e.data(r[o],this.widgetName);l&&l!=this&&!l.options.disabled&&(n.push([e.isFunction(l.options.items)?l.options.items.call(l.element[0],t,{item:this.currentItem}):e(l.options.items,l.element),l]),this.containers.push(l))}for(var a=n.length-1;a>=0;a--)for(var u=n[a][1],c=n[a][0],o=0,h=c.length;h>o;o++){var d=e(c[o]);d.data(this.widgetName+"-item",u),i.push({item:d,instance:u,width:0,height:0,left:0,top:0})}},refreshPositions:function(t){this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());for(var i=this.items.length-1;i>=0;i--){var n=this.items[i];if(n.instance==this.currentContainer||!this.currentContainer||n.item[0]==this.currentItem[0]){var s=this.options.toleranceElement?e(this.options.toleranceElement,n.item):n.item;t||(n.width=s.outerWidth(),n.height=s.outerHeight());var a=s.offset();n.left=a.left,n.top=a.top}}if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(var i=this.containers.length-1;i>=0;i--){var a=this.containers[i].element.offset();this.containers[i].containerCache.left=a.left,this.containers[i].containerCache.top=a.top,this.containers[i].containerCache.width=this.containers[i].element.outerWidth(),this.containers[i].containerCache.height=this.containers[i].element.outerHeight()}return this},_createPlaceholder:function(t){t=t||this;var i=t.options;if(!i.placeholder||i.placeholder.constructor==String){var n=i.placeholder;i.placeholder={element:function(){var i=e(document.createElement(t.currentItem[0].nodeName)).addClass(n||t.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];return n||(i.style.visibility="hidden"),i},update:function(e,s){(!n||i.forcePlaceholderSize)&&(s.height()||s.height(t.currentItem.innerHeight()-parseInt(t.currentItem.css("paddingTop")||0,10)-parseInt(t.currentItem.css("paddingBottom")||0,10)),s.width()||s.width(t.currentItem.innerWidth()-parseInt(t.currentItem.css("paddingLeft")||0,10)-parseInt(t.currentItem.css("paddingRight")||0,10)))}}}t.placeholder=e(i.placeholder.element.call(t.element,t.currentItem)),t.currentItem.after(t.placeholder),i.placeholder.update(t,t.placeholder)},_contactContainers:function(t){for(var i=null,n=null,s=this.containers.length-1;s>=0;s--)if(!e.contains(this.currentItem[0],this.containers[s].element[0]))if(this._intersectsWith(this.containers[s].containerCache)){if(i&&e.contains(this.containers[s].element[0],i.element[0]))continue;i=this.containers[s],n=s}else this.containers[s].containerCache.over&&(this.containers[s]._trigger("out",t,this._uiHash(this)),this.containers[s].containerCache.over=0);if(i)if(1===this.containers.length)this.containers[n]._trigger("over",t,this._uiHash(this)),this.containers[n].containerCache.over=1;else{for(var a=1e4,r=null,o=this.containers[n].floating?"left":"top",l=this.containers[n].floating?"width":"height",u=this.positionAbs[o]+this.offset.click[o],c=this.items.length-1;c>=0;c--)if(e.contains(this.containers[n].element[0],this.items[c].item[0])&&this.items[c].item[0]!=this.currentItem[0]){var h=this.items[c].item.offset()[o],d=!1;Math.abs(h-u)>Math.abs(h+this.items[c][l]-u)&&(d=!0,h+=this.items[c][l]),Math.abs(h-u)<a&&(a=Math.abs(h-u),r=this.items[c],this.direction=d?"up":"down")}if(!r&&!this.options.dropOnEmpty)return;this.currentContainer=this.containers[n],r?this._rearrange(t,r,null,!0):this._rearrange(t,null,this.containers[n].element,!0),this._trigger("change",t,this._uiHash()),this.containers[n]._trigger("change",t,this._uiHash(this)),this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[n]._trigger("over",t,this._uiHash(this)),this.containers[n].containerCache.over=1}},_createHelper:function(t){var i=this.options,n=e.isFunction(i.helper)?e(i.helper.apply(this.element[0],[t,this.currentItem])):"clone"==i.helper?this.currentItem.clone():this.currentItem;return n.parents("body").length||e("parent"!=i.appendTo?i.appendTo:this.currentItem[0].parentNode)[0].appendChild(n[0]),n[0]==this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(""==n[0].style.width||i.forceHelperSize)&&n.width(this.currentItem.width()),(""==n[0].style.height||i.forceHelperSize)&&n.height(this.currentItem.height()),n},_adjustOffsetFromHelper:function(t){"string"==typeof t&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left"in t&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();return"absolute"==this.cssPosition&&this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&"html"==this.offsetParent[0].tagName.toLowerCase()&&e.ui.ie)&&(t={top:0,left:0}),{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"==this.cssPosition){var e=this.currentItem.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t=this.options;if("parent"==t.containment&&(t.containment=this.helper[0].parentNode),("document"==t.containment||"window"==t.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,e("document"==t.containment?document:window).width()-this.helperProportions.width-this.margins.left,(e("document"==t.containment?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),!/^(document|window|parent)$/.test(t.containment)){var i=e(t.containment)[0],n=e(t.containment).offset(),s="hidden"!=e(i).css("overflow");this.containment=[n.left+(parseInt(e(i).css("borderLeftWidth"),10)||0)+(parseInt(e(i).css("paddingLeft"),10)||0)-this.margins.left,n.top+(parseInt(e(i).css("borderTopWidth"),10)||0)+(parseInt(e(i).css("paddingTop"),10)||0)-this.margins.top,n.left+(s?Math.max(i.scrollWidth,i.offsetWidth):i.offsetWidth)-(parseInt(e(i).css("borderLeftWidth"),10)||0)-(parseInt(e(i).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,n.top+(s?Math.max(i.scrollHeight,i.offsetHeight):i.offsetHeight)-(parseInt(e(i).css("borderTopWidth"),10)||0)-(parseInt(e(i).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(t,i){i||(i=this.position);var n="absolute"==t?1:-1,s=(this.options,"absolute"!=this.cssPosition||this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent),a=/(html|body)/i.test(s[0].tagName);return{top:i.top+this.offset.relative.top*n+this.offset.parent.top*n-("fixed"==this.cssPosition?-this.scrollParent.scrollTop():a?0:s.scrollTop())*n,left:i.left+this.offset.relative.left*n+this.offset.parent.left*n-("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():a?0:s.scrollLeft())*n}},_generatePosition:function(t){var i=this.options,n="absolute"!=this.cssPosition||this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,s=/(html|body)/i.test(n[0].tagName);"relative"==this.cssPosition&&(this.scrollParent[0]==document||this.scrollParent[0]==this.offsetParent[0])&&(this.offset.relative=this._getRelativeOffset());var a=t.pageX,r=t.pageY;if(this.originalPosition&&(this.containment&&(t.pageX-this.offset.click.left<this.containment[0]&&(a=this.containment[0]+this.offset.click.left),t.pageY-this.offset.click.top<this.containment[1]&&(r=this.containment[1]+this.offset.click.top),t.pageX-this.offset.click.left>this.containment[2]&&(a=this.containment[2]+this.offset.click.left),t.pageY-this.offset.click.top>this.containment[3]&&(r=this.containment[3]+this.offset.click.top)),i.grid)){var o=this.originalPageY+Math.round((r-this.originalPageY)/i.grid[1])*i.grid[1];r=this.containment?o-this.offset.click.top<this.containment[1]||o-this.offset.click.top>this.containment[3]?o-this.offset.click.top<this.containment[1]?o+i.grid[1]:o-i.grid[1]:o:o;var l=this.originalPageX+Math.round((a-this.originalPageX)/i.grid[0])*i.grid[0];a=this.containment?l-this.offset.click.left<this.containment[0]||l-this.offset.click.left>this.containment[2]?l-this.offset.click.left<this.containment[0]?l+i.grid[0]:l-i.grid[0]:l:l}return{top:r-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"==this.cssPosition?-this.scrollParent.scrollTop():s?0:n.scrollTop()),left:a-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():s?0:n.scrollLeft())}},_rearrange:function(e,t,i,n){i?i[0].appendChild(this.placeholder[0]):t.item[0].parentNode.insertBefore(this.placeholder[0],"down"==this.direction?t.item[0]:t.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var s=this.counter;this._delay(function(){s==this.counter&&this.refreshPositions(!n)})},_clear:function(t,i){this.reverting=!1;var n=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]==this.currentItem[0]){for(var s in this._storedCSS)("auto"==this._storedCSS[s]||"static"==this._storedCSS[s])&&(this._storedCSS[s]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();this.fromOutside&&!i&&n.push(function(e){this._trigger("receive",e,this._uiHash(this.fromOutside))}),(this.fromOutside||this.domPosition.prev!=this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!=this.currentItem.parent()[0])&&!i&&n.push(function(e){this._trigger("update",e,this._uiHash())}),this!==this.currentContainer&&(i||(n.push(function(e){this._trigger("remove",e,this._uiHash())}),n.push(function(e){return function(t){e._trigger("receive",t,this._uiHash(this))}}.call(this,this.currentContainer)),n.push(function(e){return function(t){e._trigger("update",t,this._uiHash(this))}}.call(this,this.currentContainer))));for(var s=this.containers.length-1;s>=0;s--)i||n.push(function(e){return function(t){e._trigger("deactivate",t,this._uiHash(this))}}.call(this,this.containers[s])),this.containers[s].containerCache.over&&(n.push(function(e){return function(t){e._trigger("out",t,this._uiHash(this))}}.call(this,this.containers[s])),this.containers[s].containerCache.over=0);if(this._storedCursor&&e("body").css("cursor",this._storedCursor),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"==this._storedZIndex?"":this._storedZIndex),this.dragging=!1,this.cancelHelperRemoval){if(!i){this._trigger("beforeStop",t,this._uiHash());for(var s=0;s<n.length;s++)n[s].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!1}if(i||this._trigger("beforeStop",t,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.helper[0]!=this.currentItem[0]&&this.helper.remove(),this.helper=null,!i){for(var s=0;s<n.length;s++)n[s].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!0},_trigger:function(){e.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(t){var i=t||this;return{helper:i.helper,placeholder:i.placeholder||e([]),position:i.position,originalPosition:i.originalPosition,offset:i.positionAbs,item:i.currentItem,sender:t?t.element:null}}})}(jQuery),function(e){var t=5;e.widget("ui.slider",e.ui.mouse,{version:"1.9.1",widgetEventPrefix:"slide",options:{animate:!1,distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null},_create:function(){var i,n,s=this.options,a=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),r="<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",o=[];for(this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget"+" ui-widget-content"+" ui-corner-all"+(s.disabled?" ui-slider-disabled ui-disabled":"")),this.range=e([]),s.range&&(s.range===!0&&(s.values||(s.values=[this._valueMin(),this._valueMin()]),s.values.length&&2!==s.values.length&&(s.values=[s.values[0],s.values[0]])),this.range=e("<div></div>").appendTo(this.element).addClass("ui-slider-range ui-widget-header"+("min"===s.range||"max"===s.range?" ui-slider-range-"+s.range:""))),n=s.values&&s.values.length||1,i=a.length;n>i;i++)o.push(r);this.handles=a.add(e(o.join("")).appendTo(this.element)),this.handle=this.handles.eq(0),this.handles.add(this.range).filter("a").click(function(e){e.preventDefault()}).mouseenter(function(){s.disabled||e(this).addClass("ui-state-hover")}).mouseleave(function(){e(this).removeClass("ui-state-hover")}).focus(function(){s.disabled?e(this).blur():(e(".ui-slider .ui-state-focus").removeClass("ui-state-focus"),e(this).addClass("ui-state-focus"))}).blur(function(){e(this).removeClass("ui-state-focus")}),this.handles.each(function(t){e(this).data("ui-slider-handle-index",t)}),this._on(this.handles,{keydown:function(i){var n,s,a,r,o=e(i.target).data("ui-slider-handle-index");switch(i.keyCode){case e.ui.keyCode.HOME:case e.ui.keyCode.END:case e.ui.keyCode.PAGE_UP:case e.ui.keyCode.PAGE_DOWN:case e.ui.keyCode.UP:case e.ui.keyCode.RIGHT:case e.ui.keyCode.DOWN:case e.ui.keyCode.LEFT:if(i.preventDefault(),!this._keySliding&&(this._keySliding=!0,e(i.target).addClass("ui-state-active"),n=this._start(i,o),n===!1))return}switch(r=this.options.step,s=a=this.options.values&&this.options.values.length?this.values(o):this.value(),i.keyCode){case e.ui.keyCode.HOME:a=this._valueMin();break;case e.ui.keyCode.END:a=this._valueMax();break;case e.ui.keyCode.PAGE_UP:a=this._trimAlignValue(s+(this._valueMax()-this._valueMin())/t);break;case e.ui.keyCode.PAGE_DOWN:a=this._trimAlignValue(s-(this._valueMax()-this._valueMin())/t);break;case e.ui.keyCode.UP:case e.ui.keyCode.RIGHT:if(s===this._valueMax())return;a=this._trimAlignValue(s+r);break;case e.ui.keyCode.DOWN:case e.ui.keyCode.LEFT:if(s===this._valueMin())return;a=this._trimAlignValue(s-r)}this._slide(i,o,a)},keyup:function(t){var i=e(t.target).data("ui-slider-handle-index");this._keySliding&&(this._keySliding=!1,this._stop(t,i),this._change(t,i),e(t.target).removeClass("ui-state-active"))}}),this._refreshValue(),this._animateOff=!1},_destroy:function(){this.handles.remove(),this.range.remove(),this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all"),this._mouseDestroy()},_mouseCapture:function(t){var i,n,s,a,r,o,l,u,c=this,h=this.options;return h.disabled?!1:(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),i={x:t.pageX,y:t.pageY},n=this._normValueFromMouse(i),s=this._valueMax()-this._valueMin()+1,this.handles.each(function(t){var i=Math.abs(n-c.values(t));s>i&&(s=i,a=e(this),r=t)}),h.range===!0&&this.values(1)===h.min&&(r+=1,a=e(this.handles[r])),o=this._start(t,r),o===!1?!1:(this._mouseSliding=!0,this._handleIndex=r,a.addClass("ui-state-active").focus(),l=a.offset(),u=!e(t.target).parents().andSelf().is(".ui-slider-handle"),this._clickOffset=u?{left:0,top:0}:{left:t.pageX-l.left-a.width()/2,top:t.pageY-l.top-a.height()/2-(parseInt(a.css("borderTopWidth"),10)||0)-(parseInt(a.css("borderBottomWidth"),10)||0)+(parseInt(a.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(t,r,n),this._animateOff=!0,!0))},_mouseStart:function(){return!0},_mouseDrag:function(e){var t={x:e.pageX,y:e.pageY},i=this._normValueFromMouse(t);return this._slide(e,this._handleIndex,i),!1},_mouseStop:function(e){return this.handles.removeClass("ui-state-active"),this._mouseSliding=!1,this._stop(e,this._handleIndex),this._change(e,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation="vertical"===this.options.orientation?"vertical":"horizontal"},_normValueFromMouse:function(e){var t,i,n,s,a;return"horizontal"===this.orientation?(t=this.elementSize.width,i=e.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(t=this.elementSize.height,i=e.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),n=i/t,n>1&&(n=1),0>n&&(n=0),"vertical"===this.orientation&&(n=1-n),s=this._valueMax()-this._valueMin(),a=this._valueMin()+n*s,this._trimAlignValue(a)},_start:function(e,t){var i={handle:this.handles[t],value:this.value()};return this.options.values&&this.options.values.length&&(i.value=this.values(t),i.values=this.values()),this._trigger("start",e,i)},_slide:function(e,t,i){var n,s,a;this.options.values&&this.options.values.length?(n=this.values(t?0:1),2===this.options.values.length&&this.options.range===!0&&(0===t&&i>n||1===t&&n>i)&&(i=n),i!==this.values(t)&&(s=this.values(),s[t]=i,a=this._trigger("slide",e,{handle:this.handles[t],value:i,values:s}),n=this.values(t?0:1),a!==!1&&this.values(t,i,!0))):i!==this.value()&&(a=this._trigger("slide",e,{handle:this.handles[t],value:i}),a!==!1&&this.value(i))},_stop:function(e,t){var i={handle:this.handles[t],value:this.value()};this.options.values&&this.options.values.length&&(i.value=this.values(t),i.values=this.values()),this._trigger("stop",e,i)},_change:function(e,t){if(!this._keySliding&&!this._mouseSliding){var i={handle:this.handles[t],value:this.value()};this.options.values&&this.options.values.length&&(i.value=this.values(t),i.values=this.values()),this._trigger("change",e,i)}},value:function(e){return arguments.length?(this.options.value=this._trimAlignValue(e),this._refreshValue(),this._change(null,0),void 0):this._value()},values:function(t,i){var n,s,a;if(arguments.length>1)return this.options.values[t]=this._trimAlignValue(i),this._refreshValue(),this._change(null,t),void 0;if(!arguments.length)return this._values();if(!e.isArray(arguments[0]))return this.options.values&&this.options.values.length?this._values(t):this.value();for(n=this.options.values,s=arguments[0],a=0;a<n.length;a+=1)n[a]=this._trimAlignValue(s[a]),this._change(null,a);this._refreshValue()},_setOption:function(t,i){var n,s=0;switch(e.isArray(this.options.values)&&(s=this.options.values.length),e.Widget.prototype._setOption.apply(this,arguments),t){case"disabled":i?(this.handles.filter(".ui-state-focus").blur(),this.handles.removeClass("ui-state-hover"),this.handles.prop("disabled",!0),this.element.addClass("ui-disabled")):(this.handles.prop("disabled",!1),this.element.removeClass("ui-disabled"));break;case"orientation":this._detectOrientation(),this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation),this._refreshValue();break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":for(this._animateOff=!0,this._refreshValue(),n=0;s>n;n+=1)this._change(null,n);this._animateOff=!1;break;case"min":case"max":this._animateOff=!0,this._refreshValue(),this._animateOff=!1}},_value:function(){var e=this.options.value;return e=this._trimAlignValue(e)},_values:function(e){var t,i,n;if(arguments.length)return t=this.options.values[e],t=this._trimAlignValue(t);for(i=this.options.values.slice(),n=0;n<i.length;n+=1)i[n]=this._trimAlignValue(i[n]);return i},_trimAlignValue:function(e){if(e<=this._valueMin())return this._valueMin();if(e>=this._valueMax())return this._valueMax();var t=this.options.step>0?this.options.step:1,i=(e-this._valueMin())%t,n=e-i;return 2*Math.abs(i)>=t&&(n+=i>0?t:-t),parseFloat(n.toFixed(5))},_valueMin:function(){return this.options.min},_valueMax:function(){return this.options.max},_refreshValue:function(){var t,i,n,s,a,r=this.options.range,o=this.options,l=this,u=this._animateOff?!1:o.animate,c={};this.options.values&&this.options.values.length?this.handles.each(function(n){i=100*((l.values(n)-l._valueMin())/(l._valueMax()-l._valueMin())),c["horizontal"===l.orientation?"left":"bottom"]=i+"%",e(this).stop(1,1)[u?"animate":"css"](c,o.animate),l.options.range===!0&&("horizontal"===l.orientation?(0===n&&l.range.stop(1,1)[u?"animate":"css"]({left:i+"%"},o.animate),1===n&&l.range[u?"animate":"css"]({width:i-t+"%"},{queue:!1,duration:o.animate})):(0===n&&l.range.stop(1,1)[u?"animate":"css"]({bottom:i+"%"},o.animate),1===n&&l.range[u?"animate":"css"]({height:i-t+"%"},{queue:!1,duration:o.animate}))),t=i}):(n=this.value(),s=this._valueMin(),a=this._valueMax(),i=a!==s?100*((n-s)/(a-s)):0,c["horizontal"===this.orientation?"left":"bottom"]=i+"%",this.handle.stop(1,1)[u?"animate":"css"](c,o.animate),"min"===r&&"horizontal"===this.orientation&&this.range.stop(1,1)[u?"animate":"css"]({width:i+"%"},o.animate),"max"===r&&"horizontal"===this.orientation&&this.range[u?"animate":"css"]({width:100-i+"%"},{queue:!1,duration:o.animate}),"min"===r&&"vertical"===this.orientation&&this.range.stop(1,1)[u?"animate":"css"]({height:i+"%"},o.animate),"max"===r&&"vertical"===this.orientation&&this.range[u?"animate":"css"]({height:100-i+"%"},{queue:!1,duration:o.animate}))}})}(jQuery),function(e){function t(t,i){var n=(t.attr("aria-describedby")||"").split(/\s+/);n.push(i),t.data("ui-tooltip-id",i).attr("aria-describedby",e.trim(n.join(" ")))}function i(t){var i=t.data("ui-tooltip-id"),n=(t.attr("aria-describedby")||"").split(/\s+/),s=e.inArray(i,n);-1!==s&&n.splice(s,1),t.removeData("ui-tooltip-id"),n=e.trim(n.join(" ")),n?t.attr("aria-describedby",n):t.removeAttr("aria-describedby")}var n=0;e.widget("ui.tooltip",{version:"1.9.1",options:{content:function(){return e(this).attr("title")},hide:!0,items:"[title]:not([disabled])",position:{my:"left top+15",at:"left bottom",collision:"flipfit flipfit"},show:!0,tooltipClass:null,track:!1,close:null,open:null},_create:function(){this._on({mouseover:"open",focusin:"open"}),this.tooltips={},this.parents={},this.options.disabled&&this._disable()},_setOption:function(t,i){var n=this;return"disabled"===t?(this[i?"_disable":"_enable"](),this.options[t]=i,void 0):(this._super(t,i),"content"===t&&e.each(this.tooltips,function(e,t){n._updateContent(t)}),void 0)},_disable:function(){var t=this;e.each(this.tooltips,function(i,n){var s=e.Event("blur");s.target=s.currentTarget=n[0],t.close(s,!0)}),this.element.find(this.options.items).andSelf().each(function(){var t=e(this);t.is("[title]")&&t.data("ui-tooltip-title",t.attr("title")).attr("title","")})},_enable:function(){this.element.find(this.options.items).andSelf().each(function(){var t=e(this);t.data("ui-tooltip-title")&&t.attr("title",t.data("ui-tooltip-title"))})},open:function(t){var i=this,n=e(t?t.target:this.element).closest(this.options.items);if(n.length)return this.options.track&&n.data("ui-tooltip-id")?(this._find(n).position(e.extend({of:n},this.options.position)),this._off(this.document,"mousemove"),void 0):(n.attr("title")&&n.data("ui-tooltip-title",n.attr("title")),n.data("tooltip-open",!0),t&&"mouseover"===t.type&&n.parents().each(function(){var t;e(this).data("tooltip-open")&&(t=e.Event("blur"),t.target=t.currentTarget=this,i.close(t,!0)),this.title&&(e(this).uniqueId(),i.parents[this.id]={element:this,title:this.title},this.title="")}),this._updateContent(n,t),void 0)},_updateContent:function(e,t){var i,n=this.options.content,s=this;return"string"==typeof n?this._open(t,e,n):(i=n.call(e[0],function(i){e.data("tooltip-open")&&s._delay(function(){this._open(t,e,i)
})}),i&&this._open(t,e,i),void 0)},_open:function(i,n,s){function a(e){u.of=e,r.is(":hidden")||r.position(u)}var r,o,l,u=e.extend({},this.options.position);if(s){if(r=this._find(n),r.length)return r.find(".ui-tooltip-content").html(s),void 0;n.is("[title]")&&(i&&"mouseover"===i.type?n.attr("title",""):n.removeAttr("title")),r=this._tooltip(n),t(n,r.attr("id")),r.find(".ui-tooltip-content").html(s),this.options.track&&i&&/^mouse/.test(i.originalEvent.type)?(this._on(this.document,{mousemove:a}),a(i)):r.position(e.extend({of:n},this.options.position)),r.hide(),this._show(r,this.options.show),this.options.show&&this.options.show.delay&&(l=setInterval(function(){r.is(":visible")&&(a(u.of),clearInterval(l))},e.fx.interval)),this._trigger("open",i,{tooltip:r}),o={keyup:function(t){if(t.keyCode===e.ui.keyCode.ESCAPE){var i=e.Event(t);i.currentTarget=n[0],this.close(i,!0)}},remove:function(){this._removeTooltip(r)}},i&&"mouseover"!==i.type||(o.mouseleave="close"),i&&"focusin"!==i.type||(o.focusout="close"),this._on(n,o)}},close:function(t){var n=this,s=e(t?t.currentTarget:this.element),a=this._find(s);this.closing||(s.data("ui-tooltip-title")&&s.attr("title",s.data("ui-tooltip-title")),i(s),a.stop(!0),this._hide(a,this.options.hide,function(){n._removeTooltip(e(this))}),s.removeData("tooltip-open"),this._off(s,"mouseleave focusout keyup"),s[0]!==this.element[0]&&this._off(s,"remove"),this._off(this.document,"mousemove"),t&&"mouseleave"===t.type&&e.each(this.parents,function(e,t){t.element.title=t.title,delete n.parents[e]}),this.closing=!0,this._trigger("close",t,{tooltip:a}),this.closing=!1)},_tooltip:function(t){var i="ui-tooltip-"+n++,s=e("<div>").attr({id:i,role:"tooltip"}).addClass("ui-tooltip ui-widget ui-corner-all ui-widget-content "+(this.options.tooltipClass||""));return e("<div>").addClass("ui-tooltip-content").appendTo(s),s.appendTo(this.document[0].body),e.fn.bgiframe&&s.bgiframe(),this.tooltips[i]=t,s},_find:function(t){var i=t.data("ui-tooltip-id");return i?e("#"+i):e()},_removeTooltip:function(e){e.remove(),delete this.tooltips[e.attr("id")]},_destroy:function(){var t=this;e.each(this.tooltips,function(i,n){var s=e.Event("blur");s.target=s.currentTarget=n[0],t.close(s,!0),e("#"+i).remove(),n.data("ui-tooltip-title")&&(n.attr("title",n.data("ui-tooltip-title")),n.removeData("ui-tooltip-title"))})}})}(jQuery),jQuery.base64=function(){function e(e,t){var i=a.indexOf(e.charAt(t));if(-1===i)throw"Cannot decode base64";return i}function t(t){var i,n,a=0,r=t.length,o=[];if(t=String(t),0===r)return t;if(0!==r%4)throw"Cannot decode base64";for(t.charAt(r-1)===s&&(a=1,t.charAt(r-2)===s&&(a=2),r-=4),i=0;r>i;i+=4)n=e(t,i)<<18|e(t,i+1)<<12|e(t,i+2)<<6|e(t,i+3),o.push(String.fromCharCode(n>>16,255&n>>8,255&n));switch(a){case 1:n=e(t,i)<<18|e(t,i+1)<<12|e(t,i+2)<<6,o.push(String.fromCharCode(n>>16,255&n>>8));break;case 2:n=e(t,i)<<18|e(t,i+1)<<12,o.push(String.fromCharCode(n>>16))}return o.join("")}function i(e,t){var i=e.charCodeAt(t);if(i>255)throw"INVALID_CHARACTER_ERR: DOM Exception 5";return i}function n(e){if(1!==arguments.length)throw"SyntaxError: exactly one argument required";e=String(e);var t,n,r=[],o=e.length-e.length%3;if(0===e.length)return e;for(t=0;o>t;t+=3)n=i(e,t)<<16|i(e,t+1)<<8|i(e,t+2),r.push(a.charAt(n>>18)),r.push(a.charAt(63&n>>12)),r.push(a.charAt(63&n>>6)),r.push(a.charAt(63&n));switch(e.length-o){case 1:n=i(e,t)<<16,r.push(a.charAt(n>>18)+a.charAt(63&n>>12)+s+s);break;case 2:n=i(e,t)<<16|i(e,t+1)<<8,r.push(a.charAt(n>>18)+a.charAt(63&n>>12)+a.charAt(63&n>>6)+s)}return r.join("")}var s="=",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r="1.0";return{decode:t,encode:n,VERSION:r}}(jQuery),Oskari.clazz.define("Oskari.framework.bundle.oskariui.DomManager",function(e,t){this.$=e,this.partsMap=t||{},this.layout=null,this.layouts=[]},{getEl:function(e){return this.$(e)},getElForPart:function(e){return this.$(this.partsMap[e])},setElForPart:function(e,t){this.partsMap[e]=this.$(t)},setElParts:function(e){this.partsMap=e},getElParts:function(){return this.partsMap},pushLayout:function(e){this.layout&&this.layout.removeLayout(this),this.layout=e,this.layouts.push(e),e.applyLayout(this)},popLayout:function(){var e=this.layouts.pop();if(e&&e.removeLayout(this),0==this.layouts.length)return this.layout=null,void 0;var e=this.layouts[this.layouts.length-1];this.layout=e,e.applyLayout(this)},getLayout:function(){return this.layout}},{protocol:["Oskari.dom.DomManager"]}),Oskari.clazz.define("Oskari.framework.bundle.oskariui.Layout",function(){},{applyLayout:function(){},removeLayout:function(){}},{protocol:["Oskari.dom.Layout"]}),Oskari.clazz.define("Oskari.mapframework.request.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/request/request.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"request-base","Bundle-Name":"mapframework.request.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.request.Bundle",Title:" mapframework.request.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("request-base","Oskari.mapframework.request.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.request.Request",function(){throw this._creator=null,"mapframework.request.Request should not be used"},{getName:function(){throw"Running default implementation of Request.getName(). implement your own!"},setCreator:function(e){this._creator=e},getCreator:function(){return this._creator}}),Oskari.clazz.define("Oskari.mapframework.domain.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/domain/AbstractLayer.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/wmslayer.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/vectorlayer.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/map.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/style.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/tool.js"},{type:"text/javascript",src:"../../../../sources/framework/domain/user.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"domain","Bundle-Name":"mapframework.domain.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.domain.Bundle",Title:" mapframework.domain.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("domain","Oskari.mapframework.domain.Bundle"),Oskari.clazz.define("Oskari.mapframework.domain.AbstractLayer",function(e,t){this._id=null,this._name=null,this._description=null,this._type=null,this._layerType="",this._params=e||{},this._options=t||{},this._metaType=null,this._maxScale=null,this._minScale=null,this._visible=null,this._opacity=100,this._isSticky=null,this._inspireName=null,this._organizationName=null,this._dataUrl=null,this._orderNumber=null,this._subLayers=[],this._styles=[],this._currentStyle=null,this._legendImage=null,this._featureInfoEnabled=null,this._queryable=null,this._queryFormat=null,this._permissions={},this._geometry=[],this._geometryWKT=null,this._tools=[],this._metadataIdentifier=null,this._backendStatus=null,this._featureData=!1},{setId:function(e){this._id=e},getId:function(){return this._id},setQueryFormat:function(e){this._queryFormat=e},getQueryFormat:function(){return this._queryFormat},setName:function(e){this._name=e},getName:function(){return this._name},setType:function(e){this._type=e},getType:function(){return this._type},setDataUrl:function(e){this._dataUrl=e},getDataUrl:function(){return this._dataUrl},setOrganizationName:function(e){this._organizationName=e},getOrganizationName:function(){return this._organizationName},setInspireName:function(e){this._inspireName=e},getInspireName:function(){return this._inspireName},setFeatureInfoEnabled:function(e){this._featureInfoEnabled=e},isFeatureInfoEnabled:function(){return this._featureInfoEnabled===!0?!0:!1},setDescription:function(e){this._description=e},getDescription:function(){return this._description},addSubLayer:function(e){this._subLayers.push(e)},getSubLayers:function(){return this._subLayers},setMaxScale:function(e){this._maxScale=e},getMaxScale:function(){return this._maxScale},setMinScale:function(e){this._minScale=e},getMinScale:function(){return this._minScale},setOrderNumber:function(e){this._orderNumber=e},getOrderNumber:function(){return this._orderNumber},isVisible:function(){return this._visible===!0},setVisible:function(e){this._visible=e},setOpacity:function(e){this._opacity=e},getOpacity:function(){return this._opacity},setGeometryWKT:function(e){this._geometryWKT=e},getGeometryWKT:function(){return this._geometryWKT},setGeometry:function(e){this._geometry=e},getGeometry:function(){return this._geometry},addPermission:function(e,t){this._permissions[e]=t},removePermission:function(e){this._permissions[e]=null,delete this._permissions[e]},getPermission:function(e){return this._permissions[e]},getMetadataIdentifier:function(){return this._metadataIdentifier},setMetadataIdentifier:function(e){this._metadataIdentifier=e},getBackendStatus:function(){return this._backendStatus},setBackendStatus:function(e){this._backendStatus=e},setMetaType:function(e){this._metaType=e},getMetaType:function(){return this._metaType},addStyle:function(e){this._styles.push(e)},getStyles:function(){return this._styles},selectStyle:function(e){var t=this,i=null;if(!(t._styles.length>0))return i=Oskari.clazz.create("Oskari.mapframework.domain.Style"),i.setName(""),i.setTitle(""),i.setLegend(""),t._currentStyle=i,void 0;if(""===e)return t._styles.length>1?t._currentStyle=t._styles[0]:(i=Oskari.clazz.create("Oskari.mapframework.domain.Style"),i.setName(""),i.setTitle(""),i.setLegend(""),t._currentStyle=i),void 0;for(var n=0;n<t._styles.length;n++)if(i=t._styles[n],i.getName()==e)return t._currentStyle=i,""!=i.getLegend()&&(t._legendImage=i.getLegend()),void 0},getCurrentStyle:function(){return this._currentStyle},getTools:function(){return this._tools},setTools:function(e){this._tools=e},addTool:function(e){this._tools.push(e)},getTool:function(e){var t=null;if(this._tools.length>0&&""!==e)for(var i=0;i<this._tools.length;i++)if(t=this._tools[i],t.getName()==e)return t;return t},setLegendImage:function(e){this._legendImage=e},getLegendImage:function(){return this._legendImage},hasLegendImage:function(){if(this._legendImage)return!0;for(var e=0;e<this._styles.length;++e)if(this._styles[e].getLegend())return!0;return!1},setSticky:function(e){this._isSticky=e},isSticky:function(){return this._isSticky},setQueryable:function(e){this._queryable=e},getQueryable:function(){return this._queryable},setAsBaseLayer:function(){this._type="BASE_LAYER"},setAsNormalLayer:function(){this._type="NORMAL_LAYER"},setAsGroupLayer:function(){this._type="GROUP_LAYER"},isGroupLayer:function(){return"GROUP_LAYER"===this._type},isBaseLayer:function(){return"BASE_LAYER"===this._type},isInScale:function(e){var t=this.isBaseLayer();if(!e){var i=Oskari.$().sandbox;e=i.getMap().getScale()}return this.isBaseLayer()||((e>this.getMaxScale()||!this.getMaxScale())&&e<this.getMinScale()||!this.getMinScale())&&(t=!0),t},getLayerType:function(){return this._layerType.toLowerCase()},isLayerOfType:function(e){return e&&e.toLowerCase()===this.getLayerType()},getIconClassname:function(){return this.isBaseLayer()?"layer-base":this.isGroupLayer()?"layer-group":"layer-"+this.getLayerType()},getParams:function(){return this._params},getOptions:function(){return this._options},hasFeatureData:function(){return this._featureData}}),Oskari.clazz.define("Oskari.mapframework.domain.WmsLayer",function(){this._wmsLayerName=null,this._wmsUrls=[],this._layerType="WMS"},{addWmsUrl:function(e){this._wmsUrls.push(e)},setWmsUrl:function(e){this._wmsUrls=[e]},getWmsUrls:function(){return this._wmsUrls},setWmsName:function(e){this._wmsName=e},getWmsName:function(){return this._wmsName}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.domain.VectorLayer",function(){this._sldspec=null,this._layerType="VECTOR"},{setStyledLayerDescriptor:function(e){this._sldspec=e},getStyledLayerDescriptor:function(){return this._sldspec}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),Oskari.clazz.define("Oskari.mapframework.domain.Map",function(){this._centerX=null,this._centerY=null,this._zoom=null,this._scale=null,this._bbox=null,this._markerVisible=null,this.width=null,this.height=null,this.resolution=null,this.extent=null,this.maxExtent=null,this._isMoving=!1,this._projectionCode="EPSG:3067"},{moveTo:function(e,t,i){this._centerX=e,this._centerY=t,this._zoom=i},setMoving:function(e){this._isMoving=e},isMoving:function(){return this._isMoving},getX:function(){return this._centerX},getY:function(){return this._centerY},getZoom:function(){return this._zoom},setScale:function(e){this._scale=e},getScale:function(){return this._scale},setBbox:function(e){this._bbox=e},getBbox:function(){return this._bbox},setMarkerVisible:function(e){this._markerVisible=e===!0||"true"===e},isMarkerVisible:function(){return this._markerVisible===!0?!0:!1},setWidth:function(e){this.width=e},getWidth:function(){return this.width},setHeight:function(e){this.height=e},getHeight:function(){return this.height},setResolution:function(e){this.resolution=e},getResolution:function(){return this.resolution},setExtent:function(e){this.extent=e},getExtent:function(){return this.extent},setMaxExtent:function(e){this.maxExtent=e},getMaxExtent:function(){return this.maxExtent},setSrsName:function(e){this._projectionCode=e},getSrsName:function(){return this._projectionCode}}),Oskari.clazz.define("Oskari.mapframework.domain.Style",function(){this._name=null,this._title=null,this._legend=null},{setName:function(e){this._name=e},getName:function(){return this._name},setTitle:function(e){this._title=e},getTitle:function(){return this._title},setLegend:function(e){this._legend=e},getLegend:function(){return this._legend}}),Oskari.clazz.define("Oskari.mapframework.domain.Tool",function(){this._name=null,this._title=null,this._tooltip=null,this._iconCls=null,this._callback=null},{setName:function(e){this._name=e},getName:function(){return this._name},setTitle:function(e){this._title=e},getTitle:function(){return this._title},setTooltip:function(e){this._tooltip=e},getTooltip:function(){return this._tooltip},setIconCls:function(e){this._iconCls=e},getIconCls:function(){return this._iconCls},setCallback:function(e){this._callback=e},getCallback:function(){return this._callback}}),Oskari.clazz.define("Oskari.mapframework.domain.User",function(e){this._loggedIn=!1,e&&(this._firstName=e.firstName,this._lastName=e.lastName,this._nickName=e.nickName,this._loginName=e.loginName,this._uuid=e.userUUID,this._roles=e.roles,e.userUUID&&(this._loggedIn=!0))},{getName:function(){return this._firstName+" "+this._lastName},getFirstName:function(){return this._firstName},getLastName:function(){return this._lastName},getNickName:function(){return this._nickName},getLoginName:function(){return this._loginName},getUuid:function(){return this._uuid},isLoggedIn:function(){return this._loggedIn},getRoles:function(){return this._roles}}),Oskari.clazz.define("Oskari.mapframework.core.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/core/core-map-layer-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/core/core-map-methods.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"core-map","Bundle-Name":"mapframework.core.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.core.Bundle",Title:" mapframework.core.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("core-map","Oskari.mapframework.core.map.Bundle"),Oskari.clazz.category("Oskari.mapframework.core.Core","map-layer-methods",{isLayerAlreadySelected:function(e){var t=this.getService("Oskari.mapframework.service.MapLayerService"),i=t.findMapLayer(e,this._selectedLayers);return null!=i},findMapLayerFromSelectedMapLayers:function(e){var t=this.getService("Oskari.mapframework.service.MapLayerService"),i=t.findMapLayer(e,this._selectedLayers);return i},isMapLayerAlreadyHighlighted:function(e){var t=this.getService("Oskari.mapframework.service.MapLayerService"),i=t.findMapLayer(e,this._mapLayersHighlighted);return null==i&&this.printDebug("[core-map-layer-methods] "+e+" is not yet highlighted."),null!=i},findMapLayerFromAllAvailable:function(e){var t=this.getService("Oskari.mapframework.service.MapLayerService"),i=t.findMapLayer(e);return null==i&&this.printDebug("Cannot find map layer with id '"+e+"' from all available. "+"Check that current user has VIEW permissions to that layer."),i},getAllSelectedLayers:function(){return this._selectedLayers},getAllHighlightedMapLayers:function(){return this._mapLayersHighlighted},allowMultipleHighlightLayers:function(e){this._allowMultipleHighlightLayers=e},_handleAddMapLayerRequest:function(e){var t=this,i=e.getMapLayerId(),n=e.getKeepLayersOrder(),s=e.isBasemap();if(t.printDebug("Trying to add map layer with id '"+i+"' AS "+(s?" BASE ":" NORMAL ")),t.isLayerAlreadySelected(i))return t.printDebug("Attempt to select already selected layer '"+i+"'"),void 0;var a=t.findMapLayerFromAllAvailable(i);if(!a)return t.printDebug("Attempt to select layer that is not available '"+i+"'"),void 0;if(1==s&&a.setType("BASE_LAYER"),null!=n&&n)this._selectedLayers.push(a);else if(a.isBaseLayer()||1==s){var r=[];r.push(a);for(var o=0;o<this._selectedLayers.length;o++)r.push(this._selectedLayers[o]);delete this._selectedLayers,this._selectedLayers=r}else this._selectedLayers.push(a);var l;l=a.isBaseLayer()||s?t.getEventBuilder("AfterMapLayerAddEvent")(a,n,s):t.getEventBuilder("AfterMapLayerAddEvent")(a,!0,s),t.copyObjectCreatorToFrom(l,e),t.dispatch(l)},_handleRemoveMapLayerRequest:function(e){var t=this,i=e.getMapLayerId();if(t.printDebug("Trying to remove map layer with id '"+i+"'"),!t.isLayerAlreadySelected(i))return t.printDebug("Attempt to remove layer '"+i+"' that is not selected."),void 0;for(var n=t.findMapLayerFromAllAvailable(i),s=-1,a=0;a<t._selectedLayers.length;a++)if(t._selectedLayers[a]===n){s=a;break}t._selectedLayers.splice(s,1),t.isMapLayerAlreadyHighlighted(i)&&(t.printDebug("Maplayer is also highlighted, removing it from highlight list."),t._handleDimMapLayerRequest(i));var r=t.getEventBuilder("AfterMapLayerRemoveEvent")(n);t.copyObjectCreatorToFrom(r,e),t.dispatch(r)},_handleShowMapLayerInfoRequest:function(e){var t=this.findMapLayerFromAllAvailable(e.getMapLayerId()),i=this.getEventBuilder("AfterShowMapLayerInfoEvent")(t);this.copyObjectCreatorToFrom(i,e),this.dispatch(i)},_handleRearrangeSelectedMapLayerRequest:function(e){var t=e.getToPosition(),i=e.getMapLayerId(),n=null,s=0;if(null!=i&&null!=t){n=this.findMapLayerFromSelectedMapLayers(i);for(var a=new Array,r=0,o=0,l=0;t>r;l++){o++;var u=this._selectedLayers[l];u.getId()!=i?(a.push(u),r++):s=l}a.push(n);for(var l=o;l<this._selectedLayers.length;l++){var u=this._selectedLayers[l];u.getId()!=i?a.push(u):s=l}delete this._selectedLayers,this._selectedLayers=a}var c=this.getEventBuilder("AfterRearrangeSelectedMapLayerEvent")(n,s,t);this.copyObjectCreatorToFrom(c,e),this.dispatch(c)},_handleChangeMapLayerOpacityRequest:function(e){var t=this.findMapLayerFromSelectedMapLayers(e.getMapLayerId());if(t){t.setOpacity(e.getOpacity());var i=this.getEventBuilder("AfterChangeMapLayerOpacityEvent")(t);this.copyObjectCreatorToFrom(i,e),this.dispatch(i)}},_handleChangeMapLayerStyleRequest:function(e){var t=this.findMapLayerFromSelectedMapLayers(e.getMapLayerId());if(t&&"!default!"!=e.getStyle()){t.selectStyle(e.getStyle());var i=this.getEventBuilder("AfterChangeMapLayerStyleEvent")(t);this.copyObjectCreatorToFrom(i,e),this.dispatch(i)}},_removeHighLightedMapLayer:function(e){for(var t=this.getAllHighlightedMapLayers(),i=0;i<t.length;i++){var n=t[i];if(!e||n.getId()==e){t.splice(i);var s=this.getEventBuilder("AfterDimMapLayerEvent")(n);return this.dispatch(s),void 0}}},_handleHighlightMapLayerRequest:function(e){this.getObjectCreator(e);var t=e.getMapLayerId();if(this.printDebug("[core-map-layer-methods] Trying to highlight map layer with id '"+t+"'"),this.isMapLayerAlreadyHighlighted(t))return this.printWarn("[core-map-layer-methods] Attempt to highlight already highlighted wms feature info map layer '"+t+"'"),void 0;1==this._allowMultipleHighlightLayers?this._removeHighLightedMapLayer(t):this._removeHighLightedMapLayer();var i=this.findMapLayerFromSelectedMapLayers(t);if(i){this._mapLayersHighlighted.push(i),this.printDebug("[core-map-layer-methods] Adding "+i+" ("+i.getId()+") to highlighted list.");var n=this.getEventBuilder("AfterHighlightMapLayerEvent")(i);this.copyObjectCreatorToFrom(n,e),this.dispatch(n)}},_handleDimMapLayerRequest:function(e){1==this._allowMultipleHighlightLayers?this._removeHighLightedMapLayer(e):this._removeHighLightedMapLayer();var t=this.findMapLayerFromAllAvailable(e);if(t){var i=this.getEventBuilder("AfterDimMapLayerEvent")(t);this.dispatch(i)}}}),Oskari.clazz.category("Oskari.mapframework.core.Core","map-methods",{_handleHideMapMarkerRequest:function(e){this._map.setMarkerVisible(!1);var t=this.getEventBuilder("AfterHideMapMarkerEvent")();this.copyObjectCreatorToFrom(t,e),this.dispatch(t)}}),Oskari.clazz.define("Oskari.mapframework.request.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/request/common/add-map-layer-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/remove-map-layer-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/map-move-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/show-map-layer-info-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/hide-map-marker-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/ctrl-key-down-request.js"},{type:"text/javascript",src:"../../../../sources/framework/request/common/ctrl-key-up-request.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"request-map","Bundle-Name":"mapframework.request.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.request.Bundle",Title:" mapframework.request.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("request-map","Oskari.mapframework.request.map.Bundle"),Oskari.clazz.define("Oskari.mapframework.request.common.AddMapLayerRequest",function(e,t,i,n){this._creator=null,this._mapLayerId=e,this._keepLayersOrder=1==t,this._isExternal=1==n,this._isBasemap=1==i},{__name:"AddMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId},getKeepLayersOrder:function(){return this._keepLayersOrder},isBasemap:function(){return this._isBasemap},isExternal:function(){return this._isExternal}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.RemoveMapLayerRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"RemoveMapLayerRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.MapMoveRequest",function(e,t,i,n,s){this._creator=null,this._centerX=e,this._centerY=t,this._zoom=i,this._marker=n,this._projectionCode=s},{__name:"MapMoveRequest",getName:function(){return this.__name},getCenterX:function(){return this._centerX},getCenterY:function(){return this._centerY},getZoom:function(){return this._zoom},getMarker:function(){return this._marker},getSrsName:function(){return this._projectionCode}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.ShowMapLayerInfoRequest",function(e){this._creator=null,this._mapLayerId=e},{__name:"ShowMapLayerInfoRequest",getName:function(){return this.__name},getMapLayerId:function(){return this._mapLayerId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.HideMapMarkerRequest",function(){this._creator=null},{__name:"HideMapMarkerRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.CtrlKeyDownRequest",function(){},{__name:"CtrlKeyDownRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.request.common.CtrlKeyUpRequest",function(){},{__name:"CtrlKeyUpRequest",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.sandbox.base.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox.js"},{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-key-listener-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-state-methods.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"sandbox-base","Bundle-Name":"mapframework.sandbox.base.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.sandbox.Bundle",Title:" mapframework.sandbox.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("sandbox-base","Oskari.mapframework.sandbox.base.Bundle"),Oskari.clazz.define("Oskari.mapframework.sandbox.Sandbox",function(e){this._core=e,this._listeners=new Array,this._modules=new Array,this._modulesByName={},this._statefuls={},this.debugRequests=!1,this.debugEvents=!1,this.requestEventLog=[],this.requestEventStack=[],this.gatherDebugRequests=!1,this.maxGatheredRequestsAndEvents=4096,this.requestAndEventGather=[],this._eventLoopGuard=0,this._user=null,this._ajaxUrl=null},{disableDebug:function(){this.debugRequests=!1,this.debugEvents=!1,this.gatherDebugRequests=!1,this._core&&this._core.disableDebug()},enableDebug:function(){this.debugRequests=!0,this.debugEvents=!0,this.gatherDebugRequests=!0,this._core&&this._core.enableDebug()},printDebug:function(e){this._core.printDebug(e)},printWarn:function(e){this._core.printWarn(e)},setUser:function(e){this._user=Oskari.clazz.create("Oskari.mapframework.domain.User",e)},getUser:function(){return this._user||this.setUser(),this._user},setAjaxUrl:function(e){this._ajaxUrl=e},getAjaxUrl:function(){return this._ajaxUrl},registerService:function(e){this._core.registerService(e)},getService:function(e){return this._core.getService(e)},registerAsStateful:function(e,t){this._statefuls[e]=t},unregisterStateful:function(e){this._statefuls[e]=null,delete this._statefuls[e]},getStatefulComponents:function(){return this._statefuls},register:function(e){return this._modules.push(e),this._modulesByName[e.getName()]=e,e.init(this)},unregister:function(e){var t,i=this,n=[];for(t=0;t<i._modules.length;t++)e!==i._modules[t]&&n.push(i._modules[t]);i._modules=n,i._modulesByName[e.getName()]=void 0,delete i._modulesByName[e.getName()]},registerForEventByName:function(e,t){this._core.printDebug("#*#*#* Sandbox is registering module '"+e.getName()+"' to event '"+t+"'");var i=this._listeners[t];null==i&&(i=new Array,this._listeners[t]=i),i.push(e),this._core.printDebug("There are currently "+i.length+" listeners for event '"+t+"'")},unregisterFromEventByName:function(e,t){this._core.printDebug("Sandbox is unregistering module '"+e.getName()+"' from event '"+t+"'");var i,n=this._listeners[t],s=-1;if(null==n)return this._core.printDebug("Module does not listen to that event, skipping."),void 0;for(i=0;i<n.length;i++)if(n[i]==e){s=i;break}s>-1?(n.splice(s,1),this._core.printDebug("Module unregistered successfully from event")):this._core.printDebug("Module does not listen to that event, skipping.")},getRequestBuilder:function(e){return this._core.getRequestBuilder(e)},getEventBuilder:function(e){return this._core.getEventBuilder(e)},request:function(e,t){var i,n=null,s=null;if(n=null!=e.getName?e.getName():e,i=this.findRegisteredModuleInstance(n),null==i)throw"Attempt to create request with unknown component '"+e+"' as creator";return this._core.setObjectCreator(t,n),this.printDebug("Module '"+n+"' is requesting for '"+this.getObjectName(t)+"'..."),this.gatherDebugRequests&&this._pushRequestAndEventGather(n+"->Sandbox: ",this.getObjectName(t)),this._debugPushRequest(n,t),s=this._core.processRequest(t),this._debugPopRequest(),s},requestByName:function(e,t,i){this.printDebug("#!#!#! --------------> requestByName "+t);var n=this.getRequestBuilder(t),s=n.apply(this,i||[]);return this.request(e,s)},postMasterComponent:"postmaster",postRequestByName:function(e,t){var i=this,n=i.getRequestBuilder(e);n&&window.setTimeout(function(){var e=n.apply(i,t||[]),s=this.postMasterComponent,a=null;i._core.setObjectCreator(e,s),i.gatherDebugRequests&&i._pushRequestAndEventGather(s+"->Sandbox: ",i.getObjectName(e)),this.debugRequests&&i._debugPushRequest(s,e),a=i._core.processRequest(e),this.debugRequests&&i._debugPopRequest()},0)},_findModulesInterestedIn:function(e){var t=e.getName(),i=this._listeners[t];return i?i:[]},notifyAll:function(e,t){var i;t||(i=e.getName(),this._core.printDebug("Sandbox received notifyall for event '"+i+"'"));var n=this._findModulesInterestedIn(e);t||this._core.printDebug("Found "+n.length+" interested modules");for(var s=0;s<n.length;s++){var a=n[s];t||(this._core.printDebug("Notifying module '"+a.getName()+"'."),this.gatherDebugRequests&&this._pushRequestAndEventGather("Sandbox->"+a.getName()+":",i)),this._debugPushEvent(this.getObjectCreator(e),a,e),a.onEvent(e),this._debugPopEvent()}t||delete e},findRegisteredModuleInstance:function(e){return this._modulesByName[e]},getRequestParameter:function(e){return this._core.getRequestParameter(e)},getBrowserWindowSize:function(){jQuery.browser.opera&&null!=window.innerHeight&&window.innerHeight;var e=jQuery(window).width(),t={};return t.height=jQuery(window).height(),t.width=e,this.printDebug("Got browser window size is: width: "+t.width+" px, height:"+t.height+" px."),t
},getObjectName:function(e){return this._core.getObjectName(e)},getObjectCreator:function(e){return this._core.getObjectCreator(e)},setObjectCreator:function(e,t){return this._core.setObjectCreator(e,t)},copyObjectCreatorToFrom:function(e,t){return this._core.copyObjectCreatorToFrom(e,t)},addRequestHandler:function(e,t){return this._core.addRequestHandler(e,t)},removeRequestHandler:function(e,t){return this._core.removeRequestHandler(e,t)},_debugPushRequest:function(e,t){if(this.debugRequests){var i={from:e,reqName:t.getName()};this.requestEventStack.push(i),this.requestEventLog.push(i),this.requestEventLog.length>64&&this.requestEventLog.shift()}},_debugPopRequest:function(){this.debugRequests&&this.requestEventStack.pop()},_debugPushEvent:function(e,t,i){if(this.debugEvents){if(this._eventLoopGuard++,this._eventLoopGuard>64)throw"Events Looped?";var n={from:e,to:t.getName(),evtName:i.getName()};this.requestEventStack.push(n),this.requestEventLog.push(n),this.requestEventLog.length>64&&this.requestEventLog.shift()}},_debugPopEvent:function(){this.debugEvents&&(this._eventLoopGuard--,this.requestEventStack.pop())},_pushRequestAndEventGather:function(e,t){var i={};i.name=e,i.request=t,this.requestAndEventGather.push(i),this.requestAndEventGather.length>this.maxGatheredRequestsAndEvents&&this.requestAndEventGather.shift()},popUpSeqDiagram:function(){var e,t='<html><head></head><body><div class="wsd" wsd_style="modern-blue"><pre>',i="";for(x in this.requestAndEventGather)i+=this.requestAndEventGather[x].name+this.requestAndEventGather[x].request+"\n";""!=i?(t+=i+'</pre></div><script type="text/javascript" src="http://www.websequencediagrams.com/service.js"></script></body></html>',e=window.open(),e.document.write(t),this.requestAndEventGather=[]):alert("No requests in queue")},getLocalizedProperty:function(e){var t,i,n;if(null===e||"undefined"==typeof e)return null;if("object"==typeof e){if(t=e[Oskari.getLang()],null===t)for(i=Oskari.getSupportedLocales(),n=0;n<i.length&&!(t=e[i[n]]);n+=1);return t}return e}}),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","key-listener-methods",{isCtrlKeyDown:function(){return this._core.isCtrlKeyDown()}}),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","state-methods",{registerAsStateful:function(e,t){this._statefuls[e]=t},unregisterStateful:function(e){this._statefuls[e]=null,delete this._statefuls[e]},getStatefulComponents:function(){return this._statefuls},resetState:function(){var e,t,i=Oskari.app.getConfiguration(),n=this.getStatefulComponents();for(var s in n)t=n[s],e=i[s].state,t.setState&&(jQuery.isEmptyObject(e)?t.setState():t.setState(e))}}),Oskari.clazz.define("Oskari.mapframework.service.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/service/map-layer-service.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"service-map","Bundle-Name":"mapframework.service.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.service.Bundle",Title:" mapframework.service.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("service-map","Oskari.mapframework.service.map.Bundle"),Oskari.clazz.define("Oskari.mapframework.service.MapLayerService",function(e,t){this._mapLayerUrl=e,this._sandbox=t,this._allLayersAjaxLoaded=!1,this._loadedLayersList=new Array,this._reservedLayerIds={},this._stickyLayerIds={},this.typeMapping={wmslayer:"Oskari.mapframework.domain.WmsLayer",vectorlayer:"Oskari.mapframework.domain.VectorLayer"},this.modelBuilderMapping={}},{__qname:"Oskari.mapframework.service.MapLayerService",getQName:function(){return this.__qname},__name:"MapLayerService",getName:function(){return this.__name},addLayer:function(e,t){if(this.checkForDuplicateId(e.getId(),e.getName()),this._reservedLayerIds[e.getId()]=!0,this._loadedLayersList.push(e),t!==!0){var i=this._sandbox.getEventBuilder("MapLayerEvent")(e.getId(),"add");this._sandbox.notifyAll(i)}},addSubLayer:function(e,t,i){var n,s,a,r=this.findMapLayer(e);if(r&&(r.isBaseLayer()||r.isGroupLayer())){for(n=r.getSubLayers(),a=0,s=n.length;s>a;++a)if(n[a].getId()===t.getId())return!1;if(n.push(t),i!==!0){var o=this._sandbox.getEventBuilder("MapLayerEvent")(t.getId(),"add");this._sandbox.notifyAll(o)}}},removeLayer:function(e,t){for(var i=null,n=0;n<this._loadedLayersList.length;n++)if(this._loadedLayersList[n].getId()==e){i=this._loadedLayersList[n],this._loadedLayersList.splice(n,1);break}if(i&&t!==!0){var s=this._sandbox.getEventBuilder("MapLayerEvent")(i.getId(),"remove");this._sandbox.notifyAll(s)}this._reservedLayerIds[e]=!1},removeSubLayer:function(e,t,i){var n,s,a,r,o=this.findMapLayer(e);if(o&&(o.isBaseLayer()||o.isGroupLayer())){for(n=o.getSubLayers(),r=0,a=n.length;a>r;++r)if(n[r].getId()===t){s=n[r],n.splice(r,1);break}if(s&&i!==!0){var l=this._sandbox.getEventBuilder("MapLayerEvent")(s.getId(),"remove");this._sandbox.notifyAll(l)}}},updateLayer:function(e,t){var i=this.findMapLayer(e);if(i){t.dataUrl&&i.setDataUrl(t.dataUrl),t.legendImage&&i.setLegendImage(t.legendImage),t.minScale&&i.setMinScale(t.minScale),t.maxScale&&i.setMaxSclae(t.maxScale),t.name&&i.setName(t.name),t.type&&i.setType(t.type),t.wmsName&&i.setWmsName(t.wmsName),t.wmsUrl&&i.setWmsUrl(t.wmsUrl);for(var n in t.admin)t.admin[n]&&(i.admin[n]=t.admin[n]);var s=this._sandbox.getEventBuilder("MapLayerEvent")(i.getId(),"update");this._sandbox.notifyAll(s)}},makeLayerSticky:function(e,t){var i=this.findMapLayer(e);if(this._stickyLayerIds[e]=t===!0,i){i.setSticky(t);var n=this._sandbox.getEventBuilder("MapLayerEvent")(i.getId(),"sticky");this._sandbox.notifyAll(n)}},loadAllLayersAjax:function(e,t){var i=this,n=(new Date).getTime();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:this._mapLayerUrl+"&timestamp="+n+"&",success:function(t){i._loadAllLayersAjaxCallBack(t,e)},error:function(e){t&&0!=e.status&&t()}})},_loadAllLayersAjaxCallBack:function(e,t){for(var i=e.layers,n=0;n<i.length;n++){var s=this.createMapLayer(i[n]);if(this._reservedLayerIds[s.getId()]!==!0)this.addLayer(s,!0);else{var a=this.findMapLayer(s.getId());null!=i[n].admin&&(a.admin=i[n].admin),i[n].names&&(a.names=i[n].names)}}this._allLayersAjaxLoaded=!0;var r=this._sandbox.getEventBuilder("MapLayerEvent")(null,"add");this._sandbox.notifyAll(r),t&&t()},isAllLayersLoaded:function(){return this._allLayersAjaxLoaded},getAllLayers:function(){return this._loadedLayersList},getAllLayersByMetaType:function(e){for(var t=[],i=0;i<this._loadedLayersList.length;++i){var n=this._loadedLayersList[i];n.getMetaType&&n.getMetaType()===e&&t.push(n)}return t},registerLayerModel:function(e,t){this.typeMapping[e]=t},unregisterLayerModel:function(e){this.typeMapping[e]=void 0},registerLayerModelBuilder:function(e,t){this._sandbox.printDebug("[MapLayerService] registering handler for type "+e),this.modelBuilderMapping[e]=t},unregisterLayerModelBuilder:function(e){this.modelBuilderMapping[e]=void 0},createMapLayer:function(e){var t=null;return t="base"==e.type?this._createGroupMapLayer(e,!0):"groupMap"==e.type?this._createGroupMapLayer(e,!1):this._createActualMapLayer(e),t&&null!=e.admin&&(t.admin=e.admin),t&&null!=e.names&&(t.names=e.names),this._stickyLayerIds[t.getId()]&&t.setSticky(!0),t},_createGroupMapLayer:function(e,t){var i=Oskari.clazz.create("Oskari.mapframework.domain.WmsLayer");if(t?i.setAsBaseLayer():i.setAsGroupLayer(),i.setVisible(!0),i.setId(e.id),i.setName(e.name),i.setMaxScale(e.maxScale),i.setMinScale(e.minScale),i.setDataUrl(e.dataUrl),i.setMetadataIdentifier(e.dataUrl_uuid),!i.getMetadataIdentifier()&&i.getDataUrl()){var n=i.getDataUrl().split("uuid=");2==n.length&&i.setMetadataIdentifier(n[1])}if(e.orgName?i.setOrganizationName(e.orgName):i.setOrganizationName(""),e.inspire?i.setInspireName(e.inspire):i.setInspireName(""),i.setLegendImage(e.legendImage),i.setDescription(e.info),i.setQueryable(!1),e.permissions)for(var s in e.permissions)i.addPermission(s,e.permissions[s]);if(e.subLayer)for(var a=0;a<e.subLayer.length;a++){var r=this._createActualMapLayer(e.subLayer[a]);r.admin=e.subLayer[a].admin||{},i.getSubLayers().push(r)}if(null!=e.opacity)i.setOpacity(e.opacity);else if(i.getSubLayers().length>0){var o=i.getSubLayers()[0].getOpacity();null!=o?i.setOpacity(o):i.setOpacity(100)}else i.setOpacity(100);return i},_createActualMapLayer:function(e){var t=null,i=e.id;if(null!=e){if(!this.typeMapping[e.type])throw"Unknown layer type '"+e.type+"'";if(t=Oskari.clazz.create(this.typeMapping[e.type],e.params,e.options),"wmslayer"==e.type?this._populateWmsMapLayerAdditionalData(t,e):"vectorlayer"==e.type&&t.setStyledLayerDescriptor(e.styledLayerDescriptor),e.metaType&&t.setMetaType&&t.setMetaType(e.metaType),t.setAsNormalLayer(),t.setId(i),t.setName(e.name),null!=e.opacity?t.setOpacity(e.opacity):t.setOpacity(100),t.setMaxScale(e.maxScale),t.setMinScale(e.minScale),t.setDescription(e.subtitle),t.setQueryable("true"===e.isQueryable||e.isQueryable===!0),t.setDataUrl(e.dataUrl),t.setMetadataIdentifier(e.dataUrl_uuid),!t.getMetadataIdentifier()&&t.getDataUrl()){var n=t.getDataUrl().split("uuid=");2==n.length&&t.setMetadataIdentifier(n[1])}if(e.backendStatus&&t.setBackendStatus&&t.setBackendStatus(e.backendStatus),e.orgName?t.setOrganizationName(e.orgName):t.setOrganizationName(""),e.inspire?t.setInspireName(e.inspire):t.setInspireName(""),t.setVisible(!0),e.geom&&t.setGeometryWKT&&t.setGeometryWKT(e.geom),e.permissions)for(var s in e.permissions)t.addPermission(s,e.permissions[s]);var a=this.modelBuilderMapping[e.type];a&&a.parseLayerData(t,e,this)}return t},_populateWmsMapLayerAdditionalData:function(e,t){if(e.setWmsName(t.wmsName),t.wmsUrl)for(var i=t.wmsUrl.split(","),n=0;n<i.length;n++)e.addWmsUrl(i[n]);return e.setFeatureInfoEnabled("disabled"!==t.gfi),this.populateStyles(e,t)},populateStyles:function(e,t){var i=Oskari.clazz.builder("Oskari.mapframework.domain.Style");if(t.styles){for(var n=0;n<t.styles.length;n++){var s=t.styles,a=!isNaN(n);a&&(s=t.styles[n]);var r=i();if(r.setName(s.name),r.setTitle(s.title),r.setLegend(s.legend),e.addStyle(r),!a)break}e.selectStyle(t.style)}if(0==e.getStyles().length){var r=i();r.setName(""),r.setTitle(""),r.setLegend(""),e.addStyle(r),e.selectStyle("")}return e.setLegendImage(t.legendImage),t.formats&&t.formats.value&&e.setQueryFormat(t.formats.value),e},checkForDuplicateId:function(e,t){if(this._reservedLayerIds[e]===!0){var i=this.findMapLayer(e);throw"Trying to add map layer with id '"+e+" ("+t+")' but that id is already reserved for '"+i.getName()+"'"}},findMapLayer:function(e,t){t||(t=this._loadedLayersList);for(var i=0;i<t.length;i++){var n=t[i];if(n.getId()==e)return n}for(var i=0;i<t.length;i++){var n=t[i],s=n.getSubLayers(),a=this.findMapLayer(e,s);if(null!=a)return a}return null}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.sandbox.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-map-layer-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-map-methods.js"},{type:"text/javascript",src:"../../../../sources/framework/sandbox/sandbox-abstraction-methods.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"sandbox-map","Bundle-Name":"mapframework.sandbox.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.sandbox.Bundle",Title:" mapframework.sandbox.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("sandbox-map","Oskari.mapframework.sandbox.map.Bundle"),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","map-layer-methods",{findMapLayerFromAllAvailable:function(e){var t=this._core.findMapLayerFromAllAvailable(e);return t},findAllSelectedMapLayers:function(){var e=this._core.getAllSelectedLayers();return e.slice(0)},findMapLayerFromSelectedMapLayers:function(e){var t=this._core.findMapLayerFromSelectedMapLayers(e);return t},isLayerAlreadySelected:function(e){return this._core.isLayerAlreadySelected(e)},findAllHighlightedLayers:function(){var e=this._core.getAllHighlightedMapLayers();return e},isMapLayerHighLighted:function(e){for(var t=this.findAllHighlightedLayers(),i=0;i<t.length;i++)if(t[i].getId()==e)return!0;return!1},allowMultipleHighlightLayers:function(e){this._core.allowMultipleHighlightLayers(e)}}),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","map-methods",{getMap:function(){return this._core.getMap()},syncMapState:function(e){var t=this._core.getMap(),i=t.getZoom(),n=t.isMarkerVisible();e===!0&&12==i&&this._core.processRequest(this._core.getRequestBuilder("MapMoveRequest")(t.getX(),t.getY(),0,!1)),this._core.processRequest(this._core.getRequestBuilder("MapMoveRequest")(t.getX(),t.getY(),i,n)),e===!0&&this._core.processRequest(this._core.getRequestBuilder("ClearHistoryRequest")())},generateMapLinkParameters:function(e){var t=this.getStatefulComponents(),i=null,n=null,s=[],a=[];for(i in t)n=t[i],n.getStateParameters&&"function"==typeof n.getStateParameters&&a.push(n.getStateParameters());e=e||{showMarker:!1,forceCache:!1,noSavedState:!1};for(i in e)s.push(i+"="+(e[i]!==!1));return a.concat(s).join("&")||null}}),Oskari.clazz.category("Oskari.mapframework.sandbox.Sandbox","abstraction-methods",{domSelector:function(e){return jQuery(e)},ajax:function(e,t,i,n){if(jQuery&&jQuery.ajax){var s="GET";n&&(s="POST"),jQuery.ajax({type:s,url:e,beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},data:n,success:t,error:i})}else i()},getDefer:function(){return window.Q&&window.Q.defer?window.Q.defer():void 0}}),Oskari.clazz.define("Oskari.mapframework.event.map.Bundle",function(){},{create:function(){return null},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../sources/framework/event/common/features-available-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-map-layer-add-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-map-layer-remove-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-map-move-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-map-move-start-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-show-map-layer-info-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/after-hide-map-marker-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/mouse-hover-event.js"},{type:"text/javascript",src:"../../../../sources/framework/event/common/MapLayerEvent.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"event-map","Bundle-Name":"mapframework.event.map.Bundle","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" mapframework.event.Bundle",Title:" mapframework.event.Bundle"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("event-map","Oskari.mapframework.event.map.Bundle"),Oskari.clazz.define("Oskari.mapframework.event.common.FeaturesAvailableEvent",function(e,t,i,n,s){this._creator=null,this._features=t,this._op=s,this._mapLayer=e,this._mimeType=i,this._projCode=n},{__name:"FeaturesAvailableEvent",getName:function(){return this.__name},getFeatures:function(){return this._features},getOp:function(){return this._op},getMapLayer:function(){return this._mapLayer},getMimeType:function(){return this._mimeType},getProjCode:function(){return this._projCode}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterMapLayerAddEvent",function(e,t,i){this._creator=null,this._mapLayer=e,this._keepLayersOrder=t,this._isBasemap=i?i:!1},{__name:"AfterMapLayerAddEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer},getKeepLayersOrder:function(){return this._keepLayersOrder},isBasemap:function(){return this._isBasemap}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterMapLayerRemoveEvent",function(e){this._creator=null,this._mapLayer=e},{__name:"AfterMapLayerRemoveEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterMapMoveEvent",function(e,t,i,n,s){this._creator=null,this._centerX=e,this._centerY=t,this._zoom=i,this._marker=n,this._scale=s},{__name:"AfterMapMoveEvent",getName:function(){return this.__name},getCreator:function(){return this._creator},getCenterX:function(){return this._centerX},getCenterY:function(){return this._centerY},getZoom:function(){return this._zoom},getMarker:function(){return this._marker},getScale:function(){return this._scale}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.MapMoveStartEvent",function(e,t){this._creator=null,this._x=e,this._y=t},{__name:"MapMoveStartEvent",getName:function(){return this.__name},getX:function(){return this._x},getY:function(){return this._y}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterShowMapLayerInfoEvent",function(e){this._creator=null,this._mapLayer=e},{__name:"AfterShowMapLayerInfoEvent",getName:function(){return this.__name},getMapLayer:function(){return this._mapLayer}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.AfterHideMapMarkerEvent",function(){},{__name:"AfterHideMapMarkerEvent",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.MouseHoverEvent",function(e,t,i){this._creator=null,this._lon=e,this._lat=t,this._paused=i},{__name:"MouseHoverEvent",getName:function(){return this.__name},getLon:function(){return this._lon},getLat:function(){return this._lat},set:function(e,t,i,n,s){this._lon=e,this._lat=t,this._paused=i,this._pageX=n,this._pageY=s},isPaused:function(){return this._paused},getPageX:function(){return this._pageX},getPageY:function(){return this._pageY}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.event.common.MapLayerEvent",function(e,t){if(this._creator=null,this._layerId=e,!this.operations[t])throw"Unknown operation '"+t+"'";this._operation=t},{__name:"MapLayerEvent",getName:function(){return this.__name},getLayerId:function(){return this._layerId},getOperation:function(){return this._operation},operations:{add:"add",remove:"remove",sticky:"sticky",update:"update"}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.UserInterfaceBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.userinterface.bundle.ui.UserInterfaceBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/AddExtensionRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/AddExtensionRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/RemoveExtensionRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/RemoveExtensionRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/UpdateExtensionRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/UpdateExtensionRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/ModalDialogRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/request/ModalDialogRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/event/ExtensionUpdatedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Accordion.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/AccordionPanel.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/TabContainer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/TabDropdownContainer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/TabPanel.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Badge.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Alert.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Popup.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Overlay.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Button.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Form.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/UIHelper.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/FormInput.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Popover.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/Grid.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/GridModel.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/component/ProgressSpinner.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultTile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultFlyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultExtension.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultView.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/DefaultLayout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/EnhancedTile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/EnhancedFlyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/EnhancedExtension.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/divmanazer/extension/EnhancedView.js"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/divman.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/accordion.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/tab.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/modal.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/badge.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/alert.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/forminput.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/grid.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/popup.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/button.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/overlay.css"},{type:"text/css",src:"../../../../resources/framework/bundle/divmanazer/css/popover.css"}]},bundle:{manifest:{"Bundle-Identifier":"ui","Bundle-Name":"ui","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" kpI",Title:" kpI"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("divmanazer","Oskari.userinterface.bundle.ui.UserInterfaceBundle"),Oskari.clazz.define("Oskari.userinterface.bundle.ui.UserInterfaceBundleInstance",function(){"use strict";this.sandbox=null,this.requestHandlers={},this.extensions=[],this.extensionsByName={},this.compiledTemplates={},this.flyoutContainer=null,this.tileContainer=null,this.flyoutZIndexBase=1100,this.menubarContainerId="#menubar"},{getName:function(){"use strict";return"userinterface.DivManazer"},init:function(){"use strict"},getExtensionByName:function(e){"use strict";return this.extensionsByName[e]},getSandbox:function(){"use strict";return this.sandbox},start:function(){"use strict";this.compileTemplates();var e,t,i,n,s,a=this.conf,r=(a?a.sandbox:null)||"sandbox",o=Oskari.getSandbox(r);if(this.sandbox=o,this.flyoutContainer=jQuery(document.body),this.tileContainer=jQuery(this.menubarContainerId),this.tileContainer.addClass("oskari-tile-container"),this.sandbox.register(this),this.requestHandlers.add=Oskari.clazz.create("Oskari.userinterface.bundle.ui.request.AddExtensionRequestHandler",this),this.requestHandlers.remove=Oskari.clazz.create("Oskari.userinterface.bundle.ui.request.RemoveExtensionRequestHandler",this),this.requestHandlers.update=Oskari.clazz.create("Oskari.userinterface.bundle.ui.request.UpdateExtensionRequestHandler",this),o.addRequestHandler("userinterface.AddExtensionRequest",this.requestHandlers.add),o.addRequestHandler("userinterface.RemoveExtensionRequest",this.requestHandlers.remove),o.addRequestHandler("userinterface.UpdateExtensionRequest",this.requestHandlers.update),this.requestHandlers.modal=Oskari.clazz.create("Oskari.userinterface.bundle.ui.request.ModalDialogRequestHandler",this),o.addRequestHandler("userinterface.ModalDialogRequest",this.requestHandlers.modal),jQuery.browser.msie&&jQuery.browser.version<"9.0")for(e=this.compiledTemplates["Oskari.userinterface.Flyout"].children(".oskari-flyoutcontentcontainer"),t=this.flyoutContainer.height(),i=this.ieFixClasses,n=0;n<i.length;n+=1)if(s=i[n],t>=s.min&&t<=s.max){e.addClass(s.cls);break}},update:function(){"use strict"},stop:function(){"use strict";sandbox.removeRequestHandler("userinterface.UpdateExtensionRequest",this.requestHandlers.update),sandbox.removeRequestHandler("userinterface.RemoveExtensionRequest",this.requestHandlers.remove),sandbox.removeRequestHandler("userinterface.AddExtensionRequest",this.requestHandlers.add),sandbox.removeRequestHandler("userinterface.ModalDialogRequest",this.requestHandlers.modal),this.sandbox.unregister(this),this.started=!1},templates:{"Oskari.userinterface.Tile":'<div class="oskari-tile oskari-tile-closed"><div class="oskari-tile-title"></div><div class="oskari-tile-status"></div></div>',"Oskari.userinterface.Flyout":'<div class="oskari-flyout oskari-closed"><div class="oskari-flyouttoolbar"><div class="oskari-flyoutheading"></div><div class="oskari-flyout-title"><p></p></div><div class="oskari-flyouttools"><div class="oskari-flyouttool-help"></div><div class="oskari-flyouttool-attach"></div><div class="oskari-flyouttool-detach"></div><div class="oskari-flyouttool-minimize"></div><div class="oskari-flyouttool-restore"></div><div class="oskari-flyouttool-close icon-close icon-close:hover"></div></div></div><div class="oskari-flyoutcontentcontainer"><div class="oskari-flyoutcontent"></div></div></div>',"Oskari.userinterface.View":'<div class="oskari-view"></div>'},compileTemplates:function(){"use strict";var e,t=this;t.compiledTemplates["Oskari.userinterface.Tile"]=jQuery(this.templates["Oskari.userinterface.Tile"]),e=jQuery(t.templates["Oskari.userinterface.Flyout"]),e.css("left",t.defaults.attach.left),e.css("top",t.defaults.attach.top),t.compiledTemplates["Oskari.userinterface.Flyout"]=e,t.compiledTemplates["Oskari.userinterface.View"]=jQuery(this.templates["Oskari.userinterface.View"])},addExtension:function(e){"use strict";var t,i,n,s,a,r,o,l,u,c,h,d,p,f,m=this;return e.startExtension(),t=e.getPlugins(),i=m.extensions,n=m.extensionsByName,s={state:"close",extension:e,draggable:null,draggableTarget:null,draggableHandle:null,viewState:{},extensionUpdatedEvent:null},s.extensionUpdatedEvent=m.sandbox.getEventBuilder("userinterface.ExtensionUpdatedEvent")(e,s.state),a=i.length,r=e.getName(),o=t["Oskari.userinterface.Flyout"],l=null,u=null,null!==o&&"undefined"!=typeof o&&(l=m.createFlyout(e,o,a,s),m._applyDraggableToFlyout(l,s,".oskari-flyouttoolbar"),c=l.children(".oskari-flyoutcontentcontainer"),u=c.children(".oskari-flyoutcontent"),o.setEl(u.get()),m.flyoutContainer.append(l),o.startPlugin()),h=t["Oskari.userinterface.Tile"],d=null,null!==h&&"undefined"!=typeof h&&(d=m.createTile(e,h,a,s),h.startPlugin(),d.fadeIn(200),m.tileContainer.append(d)),p=t["Oskari.userinterface.View"],f=null,null!==p&&"undefined"!=typeof p&&(f=m.createView(e,p,a,s),u=f,p.setEl(u.get()),p.startPlugin()),s.plugins={},h&&(s.plugins["Oskari.userinterface.Tile"]={plugin:h,el:d}),o&&(s.plugins["Oskari.userinterface.Flyout"]={plugin:o,el:l}),p&&(s.plugins["Oskari.userinterface.View"]={plugin:p,el:f}),i.push(s),n[r]=s,s},_applyDraggableToFlyout:function(e,t,i){"use strict";var n,s=this,a=e.children(i).get()[0],r=e.get()[0],o=!1;t.draggableHandle=a,t.draggableTarget=r,t.draggable=$(e).draggable({handle:jQuery(a),helper:o?function(){return n=jQuery("<div />"),n.css("width",e.css("width")),n.css("height",e.css("height")),n.css("border","2px solid rgba(0,0,0,.5)"),n.css("z-index",e.css("z-index")),n}:null,scroll:!1,stack:".oskari-flyout",create:function(){jQuery.browser.msie&&"9"===jQuery.browser.version[0]&&e.css("width",e.width()+"px")},start:function(){o&&e.css("display","none")},drag:function(){},stop:function(i,n){var a;o&&(e.css("top",n.helper.css("top")),e.css("left",n.helper.css("left"))),s.shuffleZIndices(e),o&&e.css("display",""),a=s.getFlyoutViewState(e,"detach"),t.viewState=a,s.notifyExtensionViewStateChange(t)}})},createTile:function(e,t){"use strict";var i=this,n=this.compiledTemplates["Oskari.userinterface.Tile"].clone(!0,!0),s=n.children(".oskari-tile-title");return s.append(t.getTitle()),n.click(function(){i.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"toggle"])}),t.setEl(n.get()),n},createFlyout:function(e,t){"use strict";var i,n,s=this,a=this.compiledTemplates["Oskari.userinterface.Flyout"].clone(!0,!0);return a.find(".oskari-flyout-title p").append(t.getTitle()),i=a.children(".oskari-flyouttoolbar").children(".oskari-flyouttools"),n={attach:i.children(".oskari-flyouttool-attach"),detach:i.children(".oskari-flyouttool-detach"),minimize:i.children(".oskari-flyouttool-minimize"),restore:i.children(".oskari-flyouttool-restore"),close:i.children(".oskari-flyouttool-close"),help:i.children(".oskari-flyouttool-help")},n.detach.click(function(){s.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"detach"])
}),n.attach.click(function(){s.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"attach"])}),n.minimize.click(function(){s.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"minimize"])}),n.restore.click(function(){s.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"restore"])}),n.close.click(function(){s.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[e,"close"])}),n.help.click(function(){s.getSandbox().postRequestByName("userguide.ShowUserGuideRequest",[{placement:"bottom",el:n.help,extension:e.getName(),toggle:!0}])}),a},createView:function(){"use strict";var e=this,t=e.compiledTemplates["Oskari.userinterface.View"].clone(!0,!0);return t},removeExtension:function(e){"use strict";var t,i,n,s,a,r,o,l,u,c=this,h=c.extensions,d=this.extensionsByName,p=d[e.getName()],f=p.plugins["Oskari.userinterface.Flyout"];for(f&&(t=f.plugin,i=f.el,n=this.flyoutOps,s=n.close,s.apply(this,[i,t,p]),i.remove()),a=p.plugins["Oskari.userinterface.Tile"],a&&(r=a.el,r.remove()),d[e.getName()]=null,o=[],l=0,u=h.length;u>l;l+=1)h[l]!==p&&o.push(h[l]);c.extensions=o,e.stopExtension()},updateExtension:function(e,t){"use strict";var i,n,s,a,r,o,l,u,c,h,d,p,f,m,g,y,v,b,_,w,L,k,O,x,S,C,M=this,P=M.extensions;if(e){if(n=this.extensionsByName,s=n[e.getName()],a=s.state,r=t.getState(),"toggle"===r&&("close"===a?r="attach":"attach"===a?r="close":"detach"===a?r="minimize":"minimize"===a?r="restore":"restore"===a&&(r="minimize")),u=s.plugins["Oskari.userinterface.Flyout"],"attach"===r&&u)for(o=M.flyoutOps,c=o.close,h=0,C=P.length;C>h;h+=1)d=P[h],d!==s&&"attach"===d.state&&(p="close",f=d.plugins,m=f["Oskari.userinterface.Flyout"],m&&(g=m.plugin,y=m.el,d.state=p,c.apply(this,[y,g,d]),M.notifyExtensionViewStateChange(d),v=f["Oskari.userinterface.Tile"],v&&(b=v.el,M.applyTransition(b,p,M.tileTransitions))));u&&(_=u.plugin,w=u.el,o=M.flyoutOps,l=o[r],l.apply(this,[w,_,s,P])),L=s.plugins["Oskari.userinterface.Tile"],L&&(k=L.el,M.applyTransition(k,r,M.tileTransitions)),O=s.plugins["Oskari.userinterface.View"],O&&(x=O.plugin,S=O.el,o=M.viewOps,l=o[r],l&&l.apply(this,[S,x,s,P])),s.state=r,M.notifyExtensionViewStateChange(s)}else for(i=0;i<P.length;i+=1)this.updateExtension(P[i].extension,t)},notifyExtensionViewStateChange:function(e){"use strict";var t=e.extensionUpdatedEvent;t.setViewState(e.state),t.setViewInfo(e.viewState),this.sandbox.notifyAll(t,!0)},validStates:{attach:{attach:!0,detach:!1,close:!1,minimize:!1,restore:!1,drawer:!1,sidebar:!1},detach:{attach:!1,detach:!0,close:!1,minimize:!1,restore:!1,drawer:!1,sidebar:!1},minimize:{attach:!0,detach:!0,close:!1,minimize:!0,restore:!1,drawer:!1,sidebar:!1},restore:{attach:!1,detach:!0,close:!1,minimize:!1,restore:!0,drawer:!1,sidebar:!1},close:{attach:!1,detach:!1,close:!0,minimize:!1,restore:!1,drawer:!1,sidebar:!1},drawer:{attach:!1,detach:!1,close:!1,minimize:!1,restore:!1,drawer:!0,sidebar:!1},sidebar:{attach:!1,detach:!1,close:!1,minimize:!1,restore:!1,drawer:!1,sidebar:!0}},defaults:{detach:{left:"212px",top:"50px"},attach:{left:"192px",top:"30px"}},tileTransitions:{attach:{"oskari-tile-attached":!0,"oskari-tile-detached":!1,"oskari-tile-closed":!1},detach:{"oskari-tile-attached":!1,"oskari-tile-detached":!0,"oskari-tile-minimized":!1,"oskari-tile-closed":!1},minimize:{"oskari-tile-minimized":!0,"oskari-tile-closed":!1,"oskari-tile-detached":!1},restore:{"oskari-tile-minimized":!1,"oskari-tile-detached":!0},close:{"oskari-tile-closed":!0,"oskari-tile-attached":!1,"oskari-tile-detached":!1}},flyoutTransitions:{attach:{"oskari-attached":!0,"oskari-detached":!1,"oskari-closed":!1},detach:{"oskari-attached":!1,"oskari-detached":!0,"oskari-closed":!1},minimize:{"oskari-minimized":!0,"oskari-closed":!1,"oskari-detached":!1},restore:{"oskari-minimized":!1,"oskari-closed":!1,"oskari-detached":!0,"oskari-attached":!1},close:{"oskari-closed":!0,"oskari-minimized":!1,"oskari-detached":!1,"oskari-attached":!1}},applyTransition:function(e,t,i){"use strict";var n,s=i[t];if(s)for(n in s)s.hasOwnProperty(n)&&(s[n]?e.addClass(n):e.removeClass(n))},getFlyoutViewState:function(e,t){"use strict";var i={left:e.css("left"),top:e.css("top"),width:e.width(),height:e.height(),"z-index":e.css("z-index"),viewState:t};return i},flyoutOps:{detach:function(e,t,i){"use strict";var n,s=this;(!i.viewState.left||!i.viewState.top||i.viewState.left===s.defaults.attach.left&&i.viewState.top===s.defaults.attach.top)&&(i.viewState.left=s.defaults.detach.left,i.viewState.top=s.defaults.detach.top),s.shuffleZIndices(e),s.applyTransition(e,"detach",s.flyoutTransitions),n=s.getFlyoutViewState(e,"detach"),i.viewState=n},attach:function(e,t,i){"use strict";var n,s=this;s.shuffleZIndices(e),s.applyTransition(e,"attach",s.flyoutTransitions),n=s.getFlyoutViewState(e,"attach"),i.viewState=n},minimize:function(e,t,i){"use strict";var n=this,s=n.getFlyoutViewState(e,"minimize");n.applyTransition(e,"minimize",n.flyoutTransitions),i.viewState=s},restore:function(e){"use strict";var t=this;t.applyTransition(e,"restore",t.flyoutTransitions)},close:function(e,t,i){"use strict";var n=this;i.viewState={viewState:"close"},n.applyTransition(e,"close",n.flyoutTransitions)}},viewOps:{view:function(){"use strict"},close:function(){"use strict"}},setState:function(e){"use strict";var t,i,n,s=this,a=e;if(a)for(t in s.extensionsByName)if(s.extensionsByName.hasOwnProperty(t)){if(i=s.extensionsByName[t],n=a.extensionStatesByName[t],!n)continue;i.state=n.state,i.viewState=n.viewState||{}}},getState:function(){"use strict";var e,t,i,n=this;n.refreshExtensionViewStates(),e={extensionStatesByName:{}};for(t in n.extensionsByName)n.extensionsByName.hasOwnProperty(t)&&(i=n.extensionsByName[t],e.extensionStatesByName[t]={state:i.state,viewState:i.viewState});return e},applyState:function(){"use strict";var e=this;e.restoreExtensionViewStates()},refreshExtensionViewStates:function(){"use strict";var e,t,i,n,s,a=this;for(e in a.extensionsByName)a.extensionsByName.hasOwnProperty(e)&&(t=a.extensionsByName[e],i=t.plugins["Oskari.userinterface.Flyout"],i&&(n=i.el,s=a.getFlyoutViewState(n,t.state),t.viewState=s))},restoreExtensionViewStates:function(){"use strict";var e,t,i,n,s,a,r,o,l,u=this,c=u.flyoutOps,h=u.extensions;for(e in u.extensionsByName)u.extensionsByName.hasOwnProperty(e)&&(t=u.extensionsByName[e],i=t.plugins["Oskari.userinterface.Flyout"],i&&(n=i.plugin,s=i.el,a=t.viewState,s.removeAttr("style"),s.css("left",a.left),s.css("top",a.top),s.width(a.width),s.height(a.height),s.css("z-index",a["z-index"]),r=c[t.state],r.apply(u,[s,n,t,h])),o=t.plugins["Oskari.userinterface.Tile"],o&&(l=o.el,u.applyTransition(l,t.state,u.tileTransitions)))},_toggleMapWindowFullScreen:function(){"use strict";var e=this,t=e.sandbox.getRequestBuilder("MapFull.MapWindowFullScreenRequest");t&&e.sandbox.request(e.getName(),t())},shuffleZIndices:function(e){"use strict";var t,i,n,s,a,r,o,l=this,u=[],c={},h={},d={},p=1100;for(i in l.extensionsByName)l.extensionsByName.hasOwnProperty(i)&&(n=l.extensionsByName[i],s=n.plugins["Oskari.userinterface.Flyout"],s&&(a=s.el,r=a.css("z-index"),u.push(r),t=String(r),c[t]=r,d[t]=a,h[t]=n));for(u.sort(),o=0;o<u.length;o+=1)t=u[o],c[t]=p+o,d[t].css("z-index",c[u[o]]);e.css("z-index",p+u.length+2)},ieFixClasses:[{min:400,max:599,cls:"oskari-flyoutcontentcontainer_IE_400_599"},{min:600,max:799,cls:"oskari-flyoutcontentcontainer_IE_600_799"},{min:800,max:999,cls:"oskari-flyoutcontentcontainer_IE_800_999"},{min:1e3,max:1199,cls:"oskari-flyoutcontentcontainer_IE_1000_1199"},{min:1200,max:1399,cls:"oskari-flyoutcontentcontainer_IE_1200_1399"},{min:1400,max:9999,cls:"oskari-flyoutcontentcontainer_IE_1400"}]},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Stateful"]}),Oskari.clazz.define("Oskari.userinterface.request.AddExtensionRequest",function(e){"use strict";this._extension=e},{__name:"userinterface.AddExtensionRequest",getName:function(){"use strict";return this.__name},getExtension:function(){"use strict";return this._extension}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.request.AddExtensionRequestHandler",function(e){"use strict";this.ui=e},{handleRequest:function(e,t){"use strict";var i=t.getExtension();this.ui.addExtension(i)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.request.RemoveExtensionRequest",function(e){"use strict";this._extension=e},{__name:"userinterface.RemoveExtensionRequest",getName:function(){"use strict";return this.__name},getExtension:function(){"use strict";return this._extension}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.request.RemoveExtensionRequestHandler",function(e){"use strict";this.ui=e},{handleRequest:function(e,t){"use strict";var i=t.getExtension();this.ui.removeExtension(i)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.request.UpdateExtensionRequest",function(e,t,i){"use strict";this._extension=e,this._state=t,this._extensionName=i},{__name:"userinterface.UpdateExtensionRequest",getName:function(){"use strict";return this.__name},getExtension:function(){"use strict";return this._extension},getState:function(){"use strict";return this._state},getExtensionName:function(){"use strict";return this._extensionName}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.request.UpdateExtensionRequestHandler",function(e){"use strict";this.ui=e},{handleRequest:function(e,t){"use strict";var i,n=t.getExtension(),s=t.getExtensionName();if(!n&&s&&"*"!==s){if(i=this.ui.getExtensionByName(s),!i)return;n=i.extension}this.ui.updateExtension(n,t)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.request.ModalDialogRequest",function(e,t,i,n){"use strict";this._title=e?e:"Untitled",this._message=t?t:"Lorem ipsum",this._buttons=i?i:{},this._parent=parent?parent:jQuery("#mapdiv"),this._onshow=n?n:null},{__name:"userinterface.ModalDialogRequest",getName:function(){"use strict";return this.__name},getTitle:function(){"use strict";return this._title},getMessage:function(){"use strict";return this._message},getButtons:function(){"use strict";return this._buttons},getGeom:function(){"use strict";return this._geom},getParent:function(){"use strict";return this._parent},getOnShow:function(){"use strict";return this._onshow}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.userinterface.bundle.ui.request.ModalDialogRequestHandler",function(e){"use strict";this._ui=e,this._tpl={},this._tpl.modal=jQuery('<div id="modaldialog" class="modaldialog">  <div class="modaltitle"></div>  <div class="modalmessage"></div>  <div class="modalbuttons"></div> </div>'),this._tpl.button=jQuery('<div class="modalbutton"><input type="button" /></input></div>'),this._buttons={},this._args={closeClass:"modalclose",overlayId:"modaloverlay",overlayCss:{"background-color":"lightgrey",cursor:"wait"},containerId:"modalcontainer",containerCss:{"background-color":"white"},onClose:function(){this.close()},zIndex:80130}},{handleRequest:function(e,t){"use strict";var i,n,s,a,r,o,l=this._tpl.modal.clone();l.find(".modaltitle").append(t.getTitle()),l.find(".modalmessage").append(t.getMessage()),i=t.getButtons(),n=l.find(".modalbuttons");for(o in i)if(i.hasOwnProperty(o)){if(!i[o].name)continue;s=i[o],a=this._tpl.button.clone(),r=a.find("input"),r.attr("name",s.name),r.attr("text",s.text),r.attr("value",s.text),r.bind("click",s.onclick),s.close!==!1&&r.addClass(this._args.closeClass),n.append(a)}t.onshow&&(this._args.onShow=t.onshow),$.modal=l.modal(this._args)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.event.ExtensionUpdatedEvent",function(e,t,i){"use strict";this._creator=null,this._extension=e,this.viewstate=t,this.viewinfo=i},{__name:"userinterface.ExtensionUpdatedEvent",getName:function(){"use strict";return this.__name},getExtension:function(){"use strict";return this._extension},getViewState:function(){"use strict";return this.viewstate},setViewState:function(e){"use strict";this.viewstate=e},getViewInfo:function(){"use strict";return this.viewinfo},setViewInfo:function(e){"use strict";this.viewinfo=e}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.userinterface.component.Accordion",function(){"use strict";this.template=jQuery('<div class="accordion"></div>'),this.templateMsg=jQuery('<div class="accordionmsg"></div>'),this.panels=[],this.ui=this.template.clone()},{addPanel:function(e){"use strict";this.removeMessage(),this.panels.push(e),e.insertTo(this.ui)},removePanel:function(e){"use strict";var t,i=null;for(t=0;t<this.panels.length;t+=1)if(this.panels[t]===e){i=this.panels[t],this.panels.splice(t,1);break}return i?(i.destroy(),!0):!1},removeAllPanels:function(){"use strict";this.ui.empty(),this.panels=[]},removeMessage:function(){"use strict";var e=this.ui.find("div.accordionmsg");e.length>0&&e.remove()},showMessage:function(e){"use strict";this.removeMessage();var t=this.templateMsg.clone();t.append(e),this.ui.append(t)},showPanels:function(){"use strict";var e;for(e=0;e<this.panels.length;e+=1)this.panels[e].setVisible(!0)},hidePanels:function(){"use strict";var e;for(e=0;e<this.panels.length;e+=1)this.panels[e].setVisible(!1)},insertTo:function(e){"use strict";e.append(this.ui)},getContainer:function(){"use strict";return this.ui}}),Oskari.clazz.define("Oskari.userinterface.component.AccordionPanel",function(){"use strict";this.template=jQuery('<div class="accordion_panel"><div class="header"><div class="headerIcon icon-arrow-right"></div><div class="headerText"></div></div><div class="content"></div></div>'),this.title=null,this.content=null,this.html=this.template.clone();var e=this,t=e.html.find("div.header");t.click(function(){e.isOpen()?e.close():e.open()}),this.html.find("div.content").hide()},{setVisible:function(e){"use strict";e===!0?this.html.show():this.html.hide()},isVisible:function(){"use strict";return this.html.is(":visible")},isOpen:function(){"use strict";return this.html.hasClass("open")},open:function(){"use strict";this.html.addClass("open");var e=this.html.find("div.header div.headerIcon");e.removeClass("icon-arrow-right"),e.addClass("icon-arrow-down"),this.html.find("div.content").show()},close:function(){"use strict";this.html.removeClass("open");var e=this.html.find("div.header div.headerIcon");e.removeClass("icon-arrow-down"),e.addClass("icon-arrow-right"),this.html.find("div.content").hide()},setTitle:function(e){"use strict";this.title=e;var t=this.html.find("div.header div.headerText");t.html(this.title)},getTitle:function(){"use strict";return this.title},setContent:function(e){"use strict";this.content=e;var t=this.html.find("div.content");t.append(this.content)},destroy:function(){"use strict";this.html.remove()},getContainer:function(){"use strict";return this.html.find("div.content")},insertTo:function(e){"use strict";e.append(this.html)}}),Oskari.clazz.define("Oskari.userinterface.component.TabContainer",function(e){this.panels=[],this.tabChangeListeners=[],this.emptyMsg=e?e:"No content",this.template=jQuery('<div class="oskariTabs">'+this.emptyMsg+"</div>"),this.templateTabs=jQuery('<div class="tabsHeader"><ul class="tabsItem"></ul></div><br clear="all"/><div class="tabsContent tabsContentItem"></div>'),this.ui=this.template.clone()},{addPanel:function(e,t){var i,n,s,a,r=this;0===this.panels.length&&(i=this.templateTabs.clone(),this.ui.html(i)),n=this.ui.find("ul.tabsItem"),s=e.getHeader(),t?n.prepend(s):n.append(s),e.insertTo(this.ui.find("div.tabsContentItem")),this.panels.push(e),1===this.panels.length&&this.select(e),a=s.find("a"),a.bind("click",function(){return r.select(e),!1})},addTabChangeListener:function(e){this.tabChangeListeners.push(e)},select:function(e){var t,i,n,s=null;for(t=0;t<this.panels.length;t+=1)if(this.isSelected(this.panels[t])){s=this.panels[t],s.handleSelection(!1);break}for(i=this.ui.find("ul"),i.find("li").removeClass("active"),n=this.ui.children().children("div.tab-content"),n.hide(),e.getHeader().addClass("active"),e.getContainer().show(),e.handleSelection(!0),t=0;t<this.tabChangeListeners.length;t+=1)this.tabChangeListeners[t](s,e)},isSelected:function(e){return e.getHeader().hasClass("active")},removePanel:function(e){var t,i=null;for(t=0;t<this.panels.length;t+=1)if(this.panels[t]===e){i=this.panels[t],this.panels.splice(t,1);break}if(0===this.panels.length)for(this.ui.html(this.emptyMsg),t=0;t<this.tabChangeListeners.length;t+=1)this.tabChangeListeners[t](e);else this.select(this.panels[0]);return i?(i.destroy(),!0):!1},insertTo:function(e){e.append(this.ui)}}),Oskari.clazz.define("Oskari.userinterface.component.TabDropdownContainer",function(e){this.panels=[],this.tabChangeListeners=[],this.emptyMsg=e?e:"No content",this.template=jQuery('<div class="oskariTabs">'+this.emptyMsg+"</div>"),this.templateTabOption=jQuery("<option></option>"),this.templateTabs=jQuery('<div class="tabsHeader"><ul><li><select name="tabs"></select></li></ul></div><br clear="all"/><div class="tabsContent"></div>'),this.ui=this.template.clone()},{addPanel:function(e){var t=this;if(0==this.panels.length){var i=this.templateTabs.clone();this.ui.html(i)}var n=this.ui.find("ul li select"),s=this.templateTabOption.clone();s.attr("id","layer-id-"+e.getId()),s.append(e.getTitle()),n.append(s),e.setHeader(s),e.insertTo(this.ui.find("div.tabsContent")),this.panels.push(e),1==this.panels.length&&(this.select(e),n.bind("change",function(){t.select(t.panels[this.selectedIndex])}))},updatePanel:function(e){for(var t=this.ui.find("ul li select"),i=0;i<t.find("option").length;i++){var n=jQuery(t.find("option")[i]);n.attr("id")=="layer-id-"+e.getId()&&n.html(e.getTitle())}},addTabChangeListener:function(e){this.tabChangeListeners.push(e)},select:function(e){var t=null;if(this.tabChangeListeners.length>0)for(var i=0;i<this.panels.length;i++)if(this.isSelected(this.panels[i])){t=this.panels[i];break}var n=this.ui.children().children("div.tab-content");n.hide();var s=this.ui.find("ul li select"),a=s.find("option");a.removeAttr("selected");var r=this._getPanelIndex(e);jQuery(a[r]).attr("selected","selected"),e.getContainer().show();for(var i=0;i<this.tabChangeListeners.length;i++)this.tabChangeListeners[i](t,e)},isSelected:function(e){var t=this.ui.find("ul li select :selected");return t.index()==this._getPanelIndex(e)},_getPanelIndex:function(e){for(var t=0;t<this.panels.length;t++)if(this.panels[t]==e)return t;return-1},removePanel:function(e){for(var t=null,i=0;i<this.panels.length;i++)if(this.panels[i]===e){t=this.panels[i],this.panels.splice(i,1);break}for(var n=this.ui.find("ul li select :selected"),i=0;i<n.length;i++){var s=jQuery(n[i]);s.attr("id")=="layer-id-"+t.getId()&&s.remove()}if(0==this.panels.length){this.ui.html(this.emptyMsg);for(var i=0;i<this.tabChangeListeners.length;i++)this.tabChangeListeners[i](e)}else this.select(this.panels[0]);return t?(t.destroy(),!0):!1},insertTo:function(e){e.append(this.ui)}}),Oskari.clazz.define("Oskari.userinterface.component.TabPanel",function(){this.template=jQuery('<div class="tab-content"></div>'),this.templateTabHeader=jQuery('<li><a href="JavaScript:void(0);"></a></li>'),this.id=null,this.title=null,this.content=null,this.header=null,this.selectionHandler=null,this.html=this.template.clone(),this.html.hide()},{setId:function(e){this.id=e},getId:function(){return this.id},setTitle:function(e){var t,i;this.title=e,t=this.templateTabHeader.clone(),this.header=t,i=t.find("a"),i.html(this.getTitle())},getTitle:function(){return this.title},setHeader:function(e){this.header=e},getHeader:function(){return this.header},setContent:function(e){this.content=e,this.html.html(this.content)},destroy:function(){this.header.remove(),this.html.remove()},getContainer:function(){return this.html},setSelectionHandler:function(e){this.selectionHandler=e},handleSelection:function(e){this.selectionHandler&&this.selectionHandler(e===!0)},insertTo:function(e){e.append(this.html)}}),Oskari.clazz.define("Oskari.userinterface.component.Badge",function(){"use strict";this.compiledTemplates={},this.compileTemplates(),this.ui=null,this.container=null},{templates:{"default":'<span class="oskari-badge"></span>',success:'<span class="oskari-badge oskari-badge-success"></span>',warning:'<span class="oskari-badge oskari-badge-warning"></span>',important:'<span class="oskari-badge oskari-badge-important"></span>',info:'<span class="oskari-badge oskari-badge-info"></span>',inverse:'<span class="oskari-badge oskari-badge-inverse"></span>'},compileTemplates:function(){"use strict";var e;for(e in this.templates)this.templates.hasOwnProperty(e)&&(this.compiledTemplates[e]=jQuery(this.templates[e]))},insertTo:function(e){"use strict";this.container=e},setContent:function(e,t){"use strict";this.ui&&(this.ui.remove(),this.ui=null);var i=this.compiledTemplates[t||"default"].clone();i.append(e),this.container.append(i),this.ui=i},hide:function(){"use strict";this.ui&&(this.ui.remove(),this.ui=null)}}),Oskari.clazz.define("Oskari.userinterface.component.Alert",function(){"use strict";this.compiledTemplates={},this.compileTemplates(),this.ui=null,this.container=null},{templates:{"default":'<div class="oskari-alert"><div class="oskari-alert-icon-close"><div class="icon-close"></div></div></div>',success:'<div class="oskari-alert oskari-alert-success"><div class="oskari-alert-icon-close"><div class="icon-close"></div></div></div>',error:'<div class="oskari-alert oskari-alert-error"><div class="oskari-alert-icon-close"><div class="icon-close"></div></div></div>',info:'<div class="oskari-alert oskari-alert-info"><div class="oskari-alert-icon-close"><div class="icon-close"></div></div></div>'},compileTemplates:function(){"use strict";var e;for(e in this.templates)this.templates.hasOwnProperty(e)&&(this.compiledTemplates[e]=jQuery(this.templates[e]))},insertTo:function(e){"use strict";this.container=e},setContent:function(e,t,i){"use strict";this.ui&&(this.ui.remove(),this.ui=null);var n=this,s=n.compiledTemplates[t||"default"].clone();s.append(e),n.container.prepend(s),n.ui=s,i?s.children(".oskari-alert-icon-close").remove():s.children(".oskari-alert-icon-close").click(function(){n.hide()})},hide:function(){"use strict";this.ui&&(this.ui.remove(),this.ui=null)}}),Oskari.clazz.define("Oskari.userinterface.component.Popup",function(){"use strict";this.template=jQuery('<div class="divmanazerpopup"><h3 class="popupHeader"></h3><div class="content"></div><div class="actions"></div></div>'),this.templateButton=jQuery('<div class="button"><a href="JavaScript:void(0);"></a></div>'),this.dialog=this.template.clone(),this.overlay=null},{show:function(e,t,i){"use strict";var n,s,a,r,o=this,l=this.dialog.find("div.content");if(this.dialog.find("h3").html(e),l.html(t),i&&i.length>0)for(n=this.dialog.find("div.actions"),n.empty(),s=0;s<i.length;s+=1)i[s].insertTo(n);else this.dialog.bind("click",function(){o.close(!0)});jQuery("body").append(this.dialog),a=l.height(),r=.6*jQuery(document).height(),a>r&&(l.height(r),l.css("overflow-y","auto")),this.dialog.css("margin-left",-(this.dialog.width()/2)+"px"),this.dialog.css("margin-top",-(this.dialog.height()/2)+"px")},fadeout:function(e){"use strict";var t=this,i=3e3;e&&(i=e),setTimeout(function(){t.close()},i)},addClass:function(e){"use strict";this.dialog.addClass(e)},createCloseButton:function(e){"use strict";var t=this,i=Oskari.clazz.create("Oskari.userinterface.component.Button");return i.setTitle(e),i.setHandler(function(){t.close(!0)}),i},close:function(e){"use strict";var t=this;this.overlay&&this.overlay.close(),e?t.dialog.remove():(t.dialog.animate({opacity:0},500),setTimeout(function(){t.dialog.remove()},500))},alignment:["left","right","top","bottom"],moveTo:function(e,t){"use strict";var i=this,n="right",s=jQuery(e),a=s.offset(),r=s.outerWidth(),o=s.outerHeight(),l=i.dialog.outerWidth(),u=i.dialog.outerHeight(),c=a.left,h=a.top;t&&-1!==jQuery.inArray(t,this.alignment)&&(n=t),"right"===n?(c=c+r+5,h=h+o/2-u/2):"left"===n?(c=c-l-5,h=h+o/2-u/2):"top"===n?(h=h-u-5,c=c+r/2-l/2):"bottom"===n&&(h=h+o+5,c=c+r/2-l/2),0>c&&(c=0),0>h&&(h=0),i.dialog.addClass("arrow"),i.dialog.addClass(t),i.dialog.css({left:c+"px",top:h+"px","margin-left":0,"margin-top":0})},resetPosition:function(){"use strict";var e;for(this.dialog.removeClass("arrow"),e=0;e<this.alignment.length;e+=1)this.dialog.removeClass(this.alignment[e]);this.dialog.removeAttr("style")},makeModal:function(){"use strict";var e=Oskari.clazz.create("Oskari.userinterface.component.Overlay");e.overlay("body"),this.overlay=e,e.followResizing(!0)},setContent:function(e){"use strict";var t=this.dialog.find("div.content");t.empty(),t.append(e)},getContent:function(){"use strict";return this.dialog.find("div.content")[0].textContent},getJqueryContent:function(){"use strict";return this.dialog.find("div.content")},makeDraggable:function(){"use strict";var e=this;e.dialog.css("position","absolute"),e.dialog.draggable({scroll:!1})}}),Oskari.clazz.define("Oskari.userinterface.component.Overlay",function(){"use strict";this.template=jQuery('<div class="oskarioverlay transparent"></div>'),this._overlay=null,this._targetSelector=null,this._resizingWorkaround=null},{overlay:function(e){"use strict";var t,i=this;i._overlay=this.template.clone(),i._targetSelector=e,this._targetSelector||(this._targetSelector="body"),t=jQuery(this._targetSelector),t.append(this._overlay),i._setupSizeAndLocation(),i._overlay.bind("click",function(e){e.preventDefault()})},_setupSizeAndLocation:function(){"use strict";var e=this,t=jQuery(this._targetSelector);e._overlay.css({left:"0px",top:"0px",width:t.width()+"px",height:t.height()+"px"})},resize:function(){"use strict";var e=jQuery(this._targetSelector);this._overlay.height(e.height()),this._overlay.width(e.width())},followResizing:function(e){"use strict";var t=this;e?jQuery(window).resize(function(){t.resize()}):this._resizingWorkaround=setTimeout(function(){t.resize(),t.followResizing()},500)},close:function(){"use strict";this._overlay.remove(),this._resizingWorkaround&&clearTimeout(this._resizingWorkaround)},bindClickToClose:function(){"use strict";var e=this;e._overlay.bind("click",function(){e.close()})}}),Oskari.clazz.define("Oskari.userinterface.component.Button",function(){"use strict";this.template=jQuery('<input type="button"/>'),this.title=null,this.ui=this.template.clone(),this.handler=null},{setTitle:function(e){"use strict";this.title=e,this.ui&&this.ui.attr("value",e)},addClass:function(e){"use strict";this.ui.addClass(e)},setEnabled:function(e){"use strict";e===!0?this.ui.removeAttr("disabled"):this.ui.attr("disabled","disabled")},getTitle:function(){"use strict";return this.title},setHandler:function(e){"use strict";this.handler&&this.ui.unbind("click",this.handler),this.handler=e,this.ui.bind("click",this.handler)},destroy:function(){"use strict";this.ui.remove()},insertTo:function(e){"use strict";e.append(this.ui)},getButton:function(){"use strict";return this.ui}}),Oskari.clazz.define("Oskari.userinterface.component.Form",function(){"use strict";this.template=jQuery('<div class="oskariform"></div>'),this._form=this.template.clone(),this.fields=[]},{addField:function(e){"use strict";this.fields.push(e)},getForm:function(){"use strict";var e;for(this._form=this.template.clone(),e=0;e<this.fields.length;e+=1)this._form.append(this.fields[e].getField());return this._form},validate:function(){"use strict";var e,t=[];for(e=0;e<this.fields.length;e+=1)t=t.concat(this.fields[e].validate());return t},showErrors:function(){"use strict";var e,t;for(e=0;e<this.fields.length;e+=1)t=this.fields[e].validate(),this.fields[e].showErrors(t)},clearErrors:function(){"use strict";var e;for(e=0;e<this.fields.length;e+=1)this.fields[e].clearErrors()}}),Oskari.clazz.define("Oskari.userinterface.component.UIHelper",function(e){"use strict";this.sandbox=e},{processHelpLinks:function(e,t,i,n){"use strict";if(t){var s,a=this;s=function(t){return function(s,a){var r=Oskari.clazz.create("Oskari.userinterface.component.Popup"),o=r.createCloseButton("OK");o.addClass("primary"),s?(r.show(e,a.static,[o]),r.moveTo(t,"bottom")):r.show(i,n,[o])}},t.find("[helptags]").each(function(e,t){var i=jQuery(t),n=i.attr("helptags");i.bind("click",function(){a.getHelpArticle(n,s(i))})})}},getHelpArticle:function(e,t){"use strict";var i=this;jQuery.ajax({url:i.sandbox.getAjaxUrl()+"action_route=GetArticlesByTag",data:{tags:e},type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(e){e&&e.articles[0]&&e.articles[0].content?t(!0,e.articles[0].content):t(!1)},error:function(){t(!1)}})}}),Oskari.clazz.define("Oskari.userinterface.component.FormInput",function(e,t){"use strict";var i,n,s=t||Oskari.getSandbox();this.sandbox=s,this.template=jQuery('<div class="oskarifield"><label></label><input type="text" autofocus/></div>'),this.templateErrors=jQuery('<div class="error"></div>'),this.templateTooltip=jQuery('<div class="icon-info"></div>'),this.templateClearButton=jQuery('<div class="icon-close"></div>'),this._field=this.template.clone(),i=this._field.find("label"),i.attr("for",e),n=this._field.find("input").focus(),n.attr("name",e),this._name=e,this._validator=null,this._required=!1,this._requiredMsg="required",this._contentCheck=!1,this._contentCheckMsg="illegal characters",this._bindFocusAndBlur(),this._regExp=/[\s\w\d\.\,\?\!\-äöåÄÖÅ]*/,this._colorRegExp=/^([A-Fa-f0-9]{6})$/},{setLabel:function(e){"use strict";var t=this._field.find("label");t.html(e)},setTooltip:function(e,t){"use strict";var i,n=this.templateTooltip.clone();n.attr("title",e),t&&(n.addClass("help"),n.attr("helptags",t)),i=this._field.find("label"),i.before(n)},setPlaceholder:function(e){"use strict";var t=this._field.find("input");t.attr("placeholder",e)},setRequired:function(e,t){"use strict";this._required=e===!0,t&&(this._requiredMsg=t)},setContentCheck:function(e,t,i){"use strict";this._contentCheck=e===!0,i&&(this._regExp=i),t&&(this._contentCheckMsg=t)},showErrors:function(e){"use strict";this.clearErrors();var t,i=this.templateErrors.clone();for(t=0;t<e.length;t+=1)i.append(e[t].error+"<br/>");this._field.append(i)},clearErrors:function(){"use strict";var e=this._field.find("div.error");e.remove()},getField:function(){"use strict";return this._field},getValue:function(e){"use strict";var t=this._field.find("input").val();return e&&(t=t.match(this._regExp)),String(t)},setValue:function(e){"use strict";this._field.find("input").attr("value",e)},getName:function(){"use strict";return this._name},setEnabled:function(e){"use strict";e===!0?this._field.find("input").removeAttr("disabled"):this._field.find("input").attr("disabled","disabled")},setRegExp:function(e){"use strict";this._regExp=e},setValidator:function(e){"use strict";this._validator=e},validate:function(){"use strict";var e,t=[];return this._validator&&(t=this._validator(this)),e=this.getValue(),this._required&&(this.checkLength(e,1)||t.push({field:this.getName(),error:this._requiredMsg})),this._contentCheck&&(this.checkValue()||t.push({field:this.getName(),error:this._contentCheckMsg})),t},checkLength:function(e,t,i){"use strict";if(e){var n=jQuery.trim(e.toString());return t&&n.length<t?!1:i&&n.length>i?!1:!0}return!1},checkValue:function(){"use strict";var e=this.getValue(),t=this.getValue(!0);return e===t},validateNumberRange:function(e,t,i){"use strict";return isNaN(parseInt(e,10))?!1:isFinite(e)?t>e||e>i?!1:!0:!1},validateHexColor:function(e){"use strict";return this._colorRegExp.test(e)},bindEnterKey:function(e){"use strict";var t=this,i=this._field.find("input");i.keypress(function(i){t._isEnterPress(i)&&e(i)})},bindUpKey:function(e){"use strict";
var t=this,i=this._field.find("input");i.keydown(function(i){t._isUpPress(i)&&(i.preventDefault(),e(i))})},bindDownKey:function(e){"use strict";var t=this,i=this._field.find("input");i.keydown(function(i){t._isDownPress(i)&&(i.preventDefault(),e(i))})},bindOnBlur:function(e){"use strict";var t=this._field.find("input");t.blur(function(){e()})},bindChange:function(e,t){"use strict";var i=this._field.find("input");t?i.keyup(e):i.on("change",e)},addClearButton:function(){"use strict";var e=this.templateClearButton.clone(),t=this._field.find("input");e.bind("click",function(){t.val(""),t.trigger("change"),t.trigger("keyup")}),t.after(e)},_bindFocusAndBlur:function(){"use strict";var e,t,i,n=this.sandbox;n&&(e=n.getRequestBuilder("EnableMapKeyboardMovementRequest"),t=n.getRequestBuilder("DisableMapKeyboardMovementRequest"),e&&t&&(i=this._field.find("input"),i.focus(function(){n.postRequestByName("DisableMapKeyboardMovementRequest")}),i.blur(function(){n.postRequestByName("EnableMapKeyboardMovementRequest")})))},_isEnterPress:function(e){"use strict";var t=e.which;return 13===t},_isDownPress:function(e){"use strict";var t=e.which;return 40===t},_isUpPress:function(e){"use strict";var t=e.which;return 38===t}}),!function(e){"use strict";var t=function(e,t){this.init("oskariTooltip",e,t)},i=function(e,t){this.init("oskariPopover",e,t)};t.prototype={constructor:t,init:function(t,i,n){var s,a;this.type=t,this.$element=e(i),this.options=this.getOptions(n),this.enabled=!0,"manual"!==this.options.trigger&&(s="hover"===this.options.trigger?"mouseenter":"focus",a="hover"===this.options.trigger?"mouseleave":"blur",this.$element.on(s,this.options.selector,e.proxy(this.enter,this)),this.$element.on(a,this.options.selector,e.proxy(this.leave,this))),this.options.selector?this._options=e.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},getOptions:function(t){return t=e.extend({},e.fn[this.type].defaults,t,this.$element.data()),t.delay&&"number"==typeof t.delay&&(t.delay={show:t.delay,hide:t.delay}),t},enter:function(t){var i=e(t.currentTarget)[this.type](this._options).data(this.type);return i.options.delay&&i.options.delay.show?(clearTimeout(this.timeout),i.hoverState="in",this.timeout=setTimeout(function(){"in"===i.hoverState&&i.show()},i.options.delay.show),void 0):i.show()},leave:function(t){var i=e(t.currentTarget)[this.type](this._options).data(this.type);return i.options.delay&&i.options.delay.hide?(clearTimeout(this.timeout),i.hoverState="out",this.timeout=setTimeout(function(){"out"===i.hoverState&&i.hide()},i.options.delay.hide),void 0):i.hide()},show:function(){var e,t,i,n,s,a,r;if(this.hasContent()&&this.enabled){switch(e=this.tip(),this.setContent(),this.options.animation&&e.addClass("fade"),a=this.options.placement.apply(this.options.scope),t=/in/.test(a),e.remove().css({top:0,left:0,display:"block"}).appendTo(t?this.$element:document.body),i=this.getPosition(t),n=e[0].offsetWidth,s=e[0].offsetHeight,t?a.split(" ")[1]:a){case"bottom":r={top:i.top+i.height,left:i.left+i.width/2-n/2};break;case"top":r={top:i.top-s,left:i.left+i.width/2-n/2};break;case"left":r={top:i.top+i.height/2-s/2,left:i.left-n};break;case"right":r={top:i.top+i.height/2-s/2,left:i.left+i.width}}e.css(r).addClass(a).addClass("in")}},isHTML:function(e){return"string"!=typeof e||"<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3||/^(?:[^<]*<[\w\W]+>[^>]*$)/.exec(e)},setContent:function(){var e=this.tip(),t=this.getTitle();e.find(".oskari-tooltip-inner")[this.isHTML(t)?"html":"text"](t),e.removeClass("fade in top bottom left right")},hide:function(){function t(){var t=setTimeout(function(){i.off(e.support.transition.end).remove()},500);i.one(e.support.transition.end,function(){clearTimeout(t),i.remove()})}var i=this.tip();i.removeClass("in"),e.support.transition&&this.$tip.hasClass("fade")?t():i.remove()},fixTitle:function(){var e=this.$element;(e.attr("title")||"string"!=typeof e.attr("data-original-title"))&&e.attr("data-original-title",e.attr("title")||"").removeAttr("title")},hasContent:function(){return this.getTitle()},getPosition:function(t){return e.extend({},t?{top:0,left:0}:this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight})},getTitle:function(){return this.options.title.apply(this.options.scope)},tip:function(){return this.$tip=this.$tip||e(this.options.template)},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled},toggle:function(){this[this.tip().hasClass("in")?"hide":"show"]()},attach:function(e){this.$element=e}},e.fn.oskariTooltip=function(i){return this.each(function(){var n=e(this),s=n.data("oskariTooltip"),a="object"==typeof i&&i;s||n.data("oskariTooltip",s=new t(this,a)),"string"==typeof i&&s[i]()})},e.fn.oskariTooltip.Constructor=t,e.fn.oskariTooltip.defaults={animation:!0,placement:"top",selector:!1,template:'<div class="oskari-tooltip"><div class="oskari-tooltip-arrow"></div><div class="oskari-tooltip-inner"></div></div>',trigger:"hover",title:"",delay:0},i.prototype=e.extend({},e.fn.oskariTooltip.Constructor.prototype,{constructor:i,setContent:function(){var e=this.tip(),t=this.getTitle(),i=this.getContent();e.find(".oskari-popover-title")[this.isHTML(t)?"html":"text"](t),e.find(".oskari-popover-content > *")[this.isHTML(i)?"html":"text"](i),e.removeClass("fade top bottom left right in")},hasContent:function(){return this.getTitle()||this.getContent()},getContent:function(){return this.options.content.apply(this.options.scope)},tip:function(){return this.$tip||(this.$tip=e(this.options.template)),this.$tip}}),e.fn.oskariPopover=function(t){return this.each(function(){var n=e(this),s=n.data("oskariPopover"),a="object"==typeof t&&t;s||n.data("oskariPopover",s=new i(this,a)),"string"==typeof t&&s[t]()})},e.fn.oskariPopover.Constructor=i,e.fn.oskariPopover.defaults=e.extend({},e.fn.oskariTooltip.defaults,{placement:"right",content:"",template:'<div class="oskari-popover"><div class="oskari-arrow"></div><div class="oskari-popover-inner"><h3 class="oskari-popover-title"></h3><div class="oskari-popover-content"><p></p></div></div></div>'}),Oskari.clazz.define("Oskari.userinterface.component.Popover",function(e,t){this.title=e,this.content=t,this.$container=null,this.data=null,this.shown=!1,this.placement="bottom"},{templates:{container:'<div class="oskari-popover-container"/>'},hide:function(){this.shown&&(this.shown=!1,this.data&&this.data.hide())},show:function(){this.shown||this.data&&(this.data.show(),this.shown=!0)},attachTo:function(t){var n=this;n.$container=e(t),n.data?n.data.attach(n.$container):n.data=new i(t,{scope:n,title:n.getTitle,content:n.getContent,trigger:"manual",placement:n.getPlacement}),n.$container.data("oskariPopover",n.data)},getTitle:function(){return this.title},getContent:function(){return this.content},setContent:function(e,t){var i=this;i.hide(),i.content=e,t&&(i.title=t),i.show()},setTitle:function(e,t){var i=this;i.hide(),i.title=e,t&&(i.content=t),i.show()},setPlacement:function(e){this.placement=e},getPlacement:function(){return this.placement}})}(window.jQuery),Oskari.clazz.define("Oskari.userinterface.component.Grid",function(e){"use strict";this.model=null;var t="";"undefined"!=typeof e&&(t=e),this.template=jQuery('<table class="oskari-grid"><thead><tr></tr></thead><tbody></tbody></table>'),this.templateTableHeader=jQuery('<th><a href="JavaScript:void(0);"></a></th>'),this.templateDiv=jQuery("<div></div>"),this.templateRow=jQuery("<tr></tr>"),this.templateCell=jQuery("<td></td>"),this.templatePopupLink=jQuery('<a href="JavaScript: void(0);"></a>'),this.templateColumnSelectorButtonWrapper=jQuery("<div/>",{}),this.templateColumnSelectorButton=jQuery("<div/>",{title:t}),this.templateColumnSelector=jQuery("<div/>",{}),this.templateColumnSelectorList=jQuery("<ul/>",{}),this.templateColumnSelectorListItem=jQuery('<li><div><input type="checkbox"/><label></label></div></li>'),this.templateColumnSelectorClose=jQuery('<div class="icon-close close-selector-button"></div>'),this.table=null,this.fieldNames=[],this.selectionListeners=[],this.additionalDataHandler=null,this.visibleColumnSelector=null,this.showColumnSelector=!1,this.resizableColumns=!1,this.uiNames={},this.valueRenderer={},this.lastSort=null},{setDataModel:function(e){"use strict";this.model=e},getDataModel:function(){"use strict";return this.model},setColumnSelector:function(e){"use strict";this.showColumnSelector=e},setResizableColumns:function(e){"use strict";this.resizableColumns=e},setColumnUIName:function(e,t){"use strict";this.uiNames[e]=t},setColumnValueRenderer:function(e,t){"use strict";this.valueRenderer[e]=t},setVisibleFields:function(e){"use strict";this.fieldNames=e},addSelectionListener:function(e){"use strict";this.selectionListeners.push(e)},setAdditionalDataHandler:function(e,t){"use strict";this.additionalDataHandler={title:e,handler:t}},_createAdditionalDataField:function(e){"use strict";var t,i=this,n=this._renderAdditionalData(e);return!e.size&&this.additionalDataHandler?(t=this.templatePopupLink.clone(),t.append(this.additionalDataHandler.title),t.bind("click",function(){return i.additionalDataHandler.handler(t,n),!1}),t):n},_renderAdditionalData:function(e){"use strict";var t,i,n,s,a,r,o,l,u=this.template.clone(),c=u.find("tbody");if(e.size){for(t="",o=0;o<e.size();o+=1)0!==o&&(t+=", "),t+=e[o];return t}if(jQuery.isArray(e)){for(var h=this.templateDiv.clone(),o=0;o<e.length;++o){var r=this._renderAdditionalData(e[o]);h.append(r)}return h}for(l in e)if(e.hasOwnProperty(l)){i=this.templateRow.clone(),n=this.templateCell.clone(),s=this.templateCell.clone(),t=e[l],n.append(l),i.append(n);try{a=typeof t,"object"===a?(r=this._renderAdditionalData(t),s.append(r)):"function"!==a&&s.append(t),i.append(s)}catch(d){}c.append(i)}return u},_renderHeader:function(e,t){"use strict";var i,n,s,a,r,o,l=this,u=e.find("thead tr"),c=e.find("tbody");for(o=function(i){return function(){var n,s,a=jQuery(this),r=l.getSelection(),o=!1;for(c.empty(),l.lastSort&&l.lastSort.attr===i&&(o=!l.lastSort.descending),l._sortBy(i,o),l._renderBody(e,t),u.find("th").removeClass("asc"),u.find("th").removeClass("desc"),o?a.parent().addClass("desc"):a.parent().addClass("asc"),n=l.model.getIdField(),s=0;s<r.length;s+=1)l.select(r[s][n],!0);return!1}},i=0;i<t.length;i+=1)n=this.templateTableHeader.clone(),s=n.find("a"),a=t[i],r=this.uiNames[a],r||(r=a),s.append(r),l.lastSort&&a===l.lastSort.attr&&(l.lastSort.descending?n.addClass("desc"):n.addClass("asc")),s.bind("click",o(t[i])),u.append(n)},_renderBody:function(e,t){"use strict";var i,n,s,a,r,o,l,u,c,h,d=this,p=e.find("tbody"),f=this.model.getData();for(i=0;i<f.length;i+=1){for(n=this.templateRow.clone(),s=f[i],n.attr("data-id",s[this.model.getIdField()]),a=0;a<t.length;a+=1)r=t[a],o=s[r],l=this.templateCell.clone(),"object"==typeof o?l.append(this._createAdditionalDataField(o)):(u=this.valueRenderer[r],u&&(o=u(o,s)),l.append(o)),n.append(l);p.append(n)}c=e.find("tbody tr"),h=function(){d._dataSelected(jQuery(this).attr("data-id"))},c.bind("click",h),c.find("a").hover(function(){jQuery(this).parents("tr").unbind("click")},function(){jQuery(this).parents("tr").bind("click",h)})},_renderColumnSelector:function(e,t){"use strict";this.visibleColumnSelector=this.templateColumnSelectorButtonWrapper.clone();var i,n,s,a,r,o,l=this,u=this.templateColumnSelectorButton.clone(),c=this.templateColumnSelector.clone(),h=this.templateColumnSelectorList.clone(),d=this.templateColumnSelectorClose.clone();for(this.visibleColumnSelector.addClass("column-selector-placeholder"),u.addClass("icon-menu"),c.addClass("column-selector"),this.visibleColumnSelector.append(u),this.visibleColumnSelector.append(c),jQuery("input.column-selector-list-item").remove(),u.click(function(){"hidden"!==c.css("visibility")?c.css("visibility","hidden"):c.css("visibility","visible")}),d.click(function(e){e.stopPropagation(),c.css("visibility","hidden")}),i=this.model.getFields(),s=0;s<i.length;s+=1){for(n=!1,a=0;a<t.length;a+=1)if(i[s]===t[a]){n=!0;break}r=this.templateColumnSelectorListItem.clone(),r.addClass("column-selector-list-item"),o=r.find("input"),o.attr("checked",n),o.addClass("column-selector-list-item"),o.attr("id",i[s]),r.find("label").attr({"for":i[s],"class":"column-label"}).html(i[s]),r.css({margin:"5px"}),o.change(function(){var e,t,i=jQuery("input.column-selector-list-item"),n=l.model.getFields(),s=[];for(e=0;e<n.length;e+=1)for(t=0;t<i.length;t+=1)if(n[e]===i[t].id){i[t].checked&&s.push(n[e]);break}s.length>0&&l.setVisibleFields(s),l.renderTo(l.visibleColumnSelector.parent(),{columnSelector:"open"})}),h.append(r)}h.attr("class","column-selector-list"),c.append(h,d),d.click(function(e){e.stopPropagation(),c.css("visibility","hidden")})},_enableColumnResizer:function(){"use strict";var e,t,i,n=!1,s=jQuery("table.oskari-grid th");s.css("cursor","e-resize"),s.mousedown(function(s){e=jQuery(this),n=!0,t=s.pageX,i=jQuery(this).width(),jQuery(e).addClass("resizing"),jQuery(document).attr("unselectable","on").css("user-select","none").on("selectstart",!1)}),jQuery(document).mousemove(function(s){n&&jQuery(e).width(i+(s.pageX-t))}),jQuery(document).mouseup(function(){n&&(jQuery(e).removeClass("resizing"),n=!1)})},renderTo:function(e,t){"use strict";e.empty();var i=this.fieldNames,n=this.template.clone();0===i.length&&(i=this.model.getFields()),this.table=n,this._renderHeader(n,i),this.lastSort&&this._sortBy(this.lastSort.attr,this.lastSort.descending),this._renderBody(n,i),this.showColumnSelector&&(this._renderColumnSelector(n,i),e.append(this.visibleColumnSelector),null!==t&&"undefined"!=typeof t&&"open"===t.columnSelector&&this.visibleColumnSelector.find(".column-selector").css("visibility","visible")),e.append(n),this.resizableColumns&&this._enableColumnResizer()},_dataSelected:function(e){"use strict";var t;for(t=0;t<this.selectionListeners.length;t+=1)this.selectionListeners[t](this,e)},select:function(e,t){"use strict";var i,n,s,a=this.model.getIdField(),r=this.model.getData();for(i=0;i<r.length&&(s=r[i],s[a]!==e);i+=1);n=this.table.find("tbody tr"),t!==!0&&n.removeClass("selected"),jQuery(n[i]).addClass("selected")},removeSelections:function(){"use strict";var e=this.table.find("tbody tr");e.removeClass("selected")},getSelection:function(){"use strict";var e,t,i=this.model.getData(),n=[],s=this.table.find("tbody tr");for(e=0;e<s.length;e+=1)t=jQuery(s[e]),t.hasClass("selected")&&n.push(i[e]);return n},getTable:function(){"use strict";return this.table},_sortBy:function(e,t){"use strict";var i=this,n=i.model.getData();0!==n.length&&(this.lastSort={attr:e,descending:t},n.sort(function(n,s){return i._sortComparator(n,s,e,t)}))},_sortComparator:function(e,t,i,n){"use strict";var s,a,r;return"object"==typeof e[i]||"object"==typeof t[i]?0:(s=e[i],s?s.toLowerCase&&(s=s.toLowerCase()):s="",a=t[i],a?a.toLowerCase&&(a=a.toLowerCase()):a="",r=0,a>s?r=-1:s>a&&(r=1),n&&(r=-1*r),r)}}),Oskari.clazz.define("Oskari.userinterface.component.GridModel",function(){"use strict";this.fields=[],this.data=[],this.idField=null},{_addField:function(e){"use strict";this.idField||(this.idField=e),this.fields.push(e)},getFields:function(){"use strict";return this.fields},setIdField:function(e){"use strict";this.idField=e},getIdField:function(){"use strict";return this.idField},addData:function(e){"use strict";var t;if(0===this.fields.length)for(t in e)e.hasOwnProperty(t)&&this._addField(t);this.data.push(e)},getData:function(){"use strict";return this.data}}),Oskari.clazz.define("Oskari.userinterface.component.ProgressSpinner",function(){"use strict";this.container=void 0,this.opts=void 0},{__opts:{lines:15,length:0,width:5,radius:16,corners:0,rotate:0,color:"#000",speed:.6,trail:59,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},insertTo:function(e,t){"use strict";this.container=e,this.opts=t||this.__opts},start:function(){"use strict";var e=this.container,t=$(e),i=t.data(),n=this._Spinner,s=this.opts;i.spinner&&(i.spinner.stop(),delete i.spinner),s!==!1&&(i.spinner=new n($.extend({color:t.css("color")},s)).spin(t.get()[0]))},stop:function(){"use strict";var e,t,i=this.container;i&&(e=$(i),t=e.data(),t.spinner&&(t.spinner.stop(),delete t.spinner))},_Spinner:function(e,t){"use strict";function i(e,i){var n,s=t.createElement(e||"div");for(n in i)i.hasOwnProperty(n)&&(s[n]=i[n]);return s}function n(e){var t,i;for(t=1,i=arguments.length;i>t;t+=1)e.appendChild(arguments[t]);return e}function s(e,t,i,n){var s=["opacity",t,~~(100*e),i,n].join("-"),a=.01+100*(i/n),r=Math.max(1-(1-e)/t*(100-a),e),o=c.substring(0,c.indexOf("Animation")).toLowerCase(),l=o&&"-"+o+"-"||"";return p[s]||(h.insertRule("@"+l+"keyframes "+s+"{"+"0%{opacity:"+r+"}"+a+"%{opacity:"+e+"}"+(a+.01)+"%{opacity:1}"+(a+t)%100+"%{opacity:"+e+"}"+"100%{opacity:"+r+"}"+"}",h.cssRules.length),p[s]=1),s}function a(e,t){var i,n,s=e.style;if(void 0!==s[t])return t;for(t=t.charAt(0).toUpperCase()+t.slice(1),n=0;n<d.length;n+=1)if(i=d[n]+t,void 0!==s[i])return i}function r(e,t){var i;for(i in t)t.hasOwnProperty(i)&&(e.style[a(e,i)||i]=t[i]);return e}function o(e){var t,i,n;for(n=1;n<arguments.length;n+=1){t=arguments[n];for(i in t)t.hasOwnProperty(i)&&void 0===e[i]&&(e[i]=t[i])}return e}function l(e){for(var t={x:e.offsetLeft,y:e.offsetTop};e=e.offsetParent;)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function u(e){return this.spin?(this.opts=o(e||{},u.defaults,f),void 0):new u(e)}var c,h,d=["webkit","Moz","ms","O"],p={},f={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};return h=function(){var e=i("style",{type:"text/css"});return n(t.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}(),u.defaults={},o(u.prototype,{spin:function(e){this.stop();var t,n,s,a,o,u,h,d=this,p=d.opts,f=d.el=r(i(0,{className:p.className}),{position:p.position,width:0,zIndex:p.zIndex}),m=p.radius+p.length+p.width;return e&&(e.insertBefore(f,e.firstChild||null),n=l(e),t=l(f),r(f,{left:("auto"===p.left?n.x-t.x+(e.offsetWidth>>1):parseInt(p.left,10)+m)+"px",top:("auto"===p.top?n.y-t.y+(e.offsetHeight>>1):parseInt(p.top,10)+m)+"px"})),f.setAttribute("aria-role","progressbar"),d.lines(f,d.opts),c||(s=0,a=p.fps,o=a/p.speed,u=(1-p.opacity)/(o*p.trail/100),h=o/p.lines,function g(){var e,t;for(s+=1,e=p.lines;e;e-=1)t=Math.max(1-(s+e*h)%o*u,p.opacity),d.opacity(f,p.lines-e,t,p);d.timeout=d.el&&setTimeout(g,~~(1e3/a))}()),d},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=void 0),this},lines:function(e,t){function a(e,n){return r(i(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:e,boxShadow:n,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*o+t.rotate)+"deg) translate("+t.radius+"px"+",0)",borderRadius:(t.corners*t.width>>1)+"px"})}var o,l;for(o=0;o<t.lines;o+=1)l=r(i(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:c&&s(t.opacity,t.trail,o,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&n(l,r(a("#000","0 0 4px #000"),{top:"2px"})),n(e,n(l,a(t.color,"0 0 1px rgba(0,0,0,.1)")));return e},opacity:function(e,t,i){t<e.childNodes.length&&(e.childNodes[t].style.opacity=i)}}),function(){function e(e,t){return i("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}var t=r(i("group"),{behavior:"url(#default#VML)"});!a(t,"transform")&&t.adj?(h.addRule(".spin-vml","behavior:url(#default#VML)"),u.prototype.lines=function(t,i){function s(){return r(e("group",{coordsize:h+" "+h,coordorigin:-c+" "+-c}),{width:h,height:h})}function a(t,a,o){n(l,n(r(s(),{rotation:360/i.lines*t+"deg",left:~~a}),n(r(e("roundrect",{arcsize:i.corners}),{width:c,height:i.width,left:i.radius,top:-i.width>>1,filter:o}),e("fill",{color:i.color,opacity:i.opacity}),e("stroke",{opacity:0}))))}var o,l,u,c=i.length+i.width,h=2*c;if(o=2*-(i.width+i.length)+"px",l=r(s(),{position:"absolute",top:o,left:o}),i.shadow)for(u=1;u<=i.lines;u+=1)a(u,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(u=1;u<=i.lines;u+=1)a(u);return n(t,l)},u.prototype.opacity=function(e,t,i,n){var s=e.firstChild;n=n.shadow&&n.lines||0,s&&t+n<s.childNodes.length&&(s=s.childNodes[t+n],s=s&&s.firstChild,s=s&&s.firstChild,s&&(s.opacity=i))}):c=a(t,"animation")}(),u}(window,document)}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultTile",function(e,t){"use strict";this.locale=t,this.instance=e,this.container=null,this.template=null},{getName:function(){"use strict";return"Oskari.userinterface.extension.DefaultTile"},setEl:function(e){"use strict";this.container=$(e)},startPlugin:function(){"use strict"},stopPlugin:function(){"use strict"},getTitle:function(){"use strict";return this.locale.title},getDescription:function(){"use strict";return this.locale.description},getOptions:function(){"use strict"},setState:function(e){"use strict";this.state=e},getState:function(){"use strict";return this.state}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultFlyout",function(e,t){"use strict";this.instance=e,this.locale=t,this.container=null},{getName:function(){"use strict";return"Oskari.userinterface.extension.DefaultFlyout"},setEl:function(e){"use strict";this.container=jQuery(e)},getEl:function(){"use strict";return this.container},startPlugin:function(){"use strict"},stopPlugin:function(){"use strict"},getTitle:function(){"use strict";return this.locale.title},getDescription:function(){"use strict";return this.locale.description},setState:function(e){"use strict";this.state=e},getState:function(){"use strict";return this.state},getLocalization:function(){"use strict";return this.locale}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultExtension",function(e,t,i,n){"use strict";this.sandbox=null,this.plugins={},this._localization=null,this.conf={name:e,tileClazz:i||"Oskari.userinterface.extension.DefaultTile",flyoutClazz:t||"Oskari.userinterface.extension.DefaultFlyout",viewClazz:n}},{getTitle:function(){"use strict";return this.getLocalization("title")},getDescription:function(){"use strict";return this.getLocalization("desc")},getSandbox:function(){"use strict";return this.sandbox},update:function(){"use strict"},getLocalization:function(e){"use strict";return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){"use strict";var e,t=this,i=this.conf,n=(i?i.sandbox:null)||"sandbox",s=Oskari.getSandbox(n);t.sandbox=s,s.register(this),i&&i.stateful===!0&&s.registerAsStateful(this.mediator.bundleId,this),e=s.getRequestBuilder("userinterface.AddExtensionRequest")(this),s.request(this,e)},stop:function(){"use strict";var e=this.sandbox,t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),e.unregisterStateful(this.mediator.bundleId),e.unregister(this),this.sandbox=null,this.started=!1},startExtension:function(){"use strict";var e,t,i,n,s=this,a=s.sandbox;for(e in s.eventHandlers)s.eventHandlers.hasOwnProperty(e)&&a.registerForEventByName(s,e);t=s.getLocalization("flyout"),t&&s.conf.flyoutClazz&&(s.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create(s.conf.flyoutClazz,s,t)),i=s.getLocalization("tile"),i&&s.conf.tileClazz&&(s.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create(s.conf.tileClazz,s,i)),n=s.getLocalization("view"),n&&s.conf.viewClazz&&(s.plugins["Oskari.userinterface.View"]=Oskari.clazz.create(s.conf.viewClazz,s,n))},stopExtension:function(){"use strict";var e,t,i=this,n=i.sandbox;for(e in i.eventHandlers)i.eventHandlers.hasOwnProperty(e)&&n.unregisterFromEventByName(i,e);for(t in i.plugins)i.plugins.hasOwnProperty(t)&&t&&(i.plugins[t]=null)},getPlugins:function(){"use strict";return this.plugins},init:function(){"use strict";return null},getName:function(){"use strict";return this.conf.name},getConfiguration:function(){"use strict";return this.conf},eventHandlers:{},onEvent:function(e){"use strict";var t=this,i=t.eventHandlers[e.getName()];if(i)return i.apply(this,[e])},getLang:function(){"use strict";return Oskari.getLang()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultView",function(e,t){"use strict";this.instance=e,this.locale=t,this.container=null},{getName:function(){"use strict";return"Oskari.userinterface.extension.DefaultView"},setEl:function(e){"use strict";this.container=jQuery(e)},getEl:function(){"use strict";return this.container},startPlugin:function(){"use strict"},stopPlugin:function(){"use strict"},getTitle:function(){"use strict";return this.locale.title},getDescription:function(){"use strict";return this.locale.description},setState:function(e){"use strict";this.state=e},getState:function(){"use strict";return this.state},getLocalization:function(){"use strict";return this.locale}},{protocol:["Oskari.userinterface.View"]}),Oskari.clazz.define("Oskari.userinterface.extension.DefaultLayout",function(e,t){"use strict";this.instance=e,this.locale=t,this.container=null},{getName:function(){"use strict";return"Oskari.userinterface.extension.DefaultLayout"},setEl:function(e){"use strict";this.container=jQuery(e)},getEl:function(){"use strict";return this.container},startPlugin:function(){"use strict"},stopPlugin:function(){"use strict"},getTitle:function(){"use strict";return this.locale.title},getDescription:function(){"use strict";return this.locale.description},setState:function(e){"use strict";this.state=e},getState:function(){"use strict";return this.state},getLocalization:function(){"use strict";return this.locale}},{protocol:["Oskari.userinterface.Layout"]}),Oskari.clazz.define("Oskari.userinterface.extension.EnhancedTile",function(){},{getName:function(){return"Oskari.userinterface.extension.EnhancedTile"}},{protocol:["Oskari.userinterface.Tile"],extend:["Oskari.userinterface.extension.DefaultTile"]}),Oskari.clazz.define("Oskari.userinterface.extension.EnhancedFlyout",function(e,t){this.instance=e,this.locale=t,this.container=null},{getName:function(){return"Oskari.userinterface.extension.DefaultFlyout"},setEl:function(e){this.container=jQuery(e)},getEl:function(){return this.container},startPlugin:function(){},stopPlugin:function(){},getTitle:function(){return this.locale.title},getDescription:function(){return this.locale.description},setState:function(e){this.state=e},getState:function(){return this.state},getLocalization:function(){return this.locale?this.locale:this.instance?this.instance.getLocalization().flyout:void 0},getSandbox:function(){return this.instance.getSandbox()},getExtension:function(){return this.instance},slicer:Array.prototype.slice,issue:function(){var e=arguments[0],t=this.slicer.apply(arguments,[1]),i=this.getSandbox().getRequestBuilder(e),n=i.apply(i,t);return this.getSandbox().request(this.getExtension(),n)},notify:function(){var e=arguments[0],t=this.slicer.apply(arguments,[1]),i=this.getSandbox().getEventBuilder(e),n=i.apply(i,t);return this.getSandbox().notifyAll(n)}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.userinterface.extension.EnhancedExtension",function(e,t){this.sandbox=null,this.plugins={},this._localization=t,this.conf={name:e}},{getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},getSandbox:function(){return this.sandbox},update:function(){},setLocalization:function(e){this._localization=e},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this,t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,n.register(this),t&&t.stateful===!0&&n.registerAsStateful(this.mediator.bundleId,this);var s=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,s)},stop:function(){var e=this.sandbox,t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),e.unregisterStateful(this.mediator.bundleId),e.unregister(this),this.sandbox=null,this.started=!1},startExtension:function(){var e=this,t=e.sandbox;e.startPlugin();for(p in e.requestHandlers)t.addRequestHandler(p,this);for(p in e.eventHandlers)t.registerForEventByName(e,p)},startPlugin:function(){console.log("BASECLASS startPlugin called ",this)},stopPlugin:function(){console.log("BASECLASS stopPlugin called ",this)},stopExtension:function(){var e=this,t=e.sandbox;for(p in e.eventHandlers)t.unregisterFromEventByName(e,p);for(p in e.requestHandlers)t.removeRequestHandler(p,this);this.stopPlugin()},getPlugins:function(){return this.plugins},init:function(){return null},getName:function(){return this.conf.name},getConfiguration:function(){return this.conf},eventHandlers:{},requestHandlers:{},onEvent:function(e){var t=this,i=t.eventHandlers[e.getName()];return i?i.apply(this,[e]):void 0},handleRequest:function(e,t){return this.onRequest(t)},onRequest:function(e){var t=this,i=t.requestHandlers[e.getName()];return i?i.apply(this,[e]):void 0},getLang:function(){return Oskari.getLang()},getTile:function(){return this.plugins["Oskari.userinterface.Tile"]},setTile:function(e){this.plugins["Oskari.userinterface.Tile"]=e},setDefaultTile:function(e){var t=Oskari.cls().extend("Oskari.userinterface.extension.DefaultTile"),i=t.create(this,{title:e||""});return this.plugins["Oskari.userinterface.Tile"]=i,i},getFlyout:function(){return this.plugins["Oskari.userinterface.Flyout"]},setFlyout:function(e){this.plugins["Oskari.userinterface.Flyout"]=e},slicer:Array.prototype.slice,notify:function(e,t){return this.getSandbox().notifyAll(e,t)},request:function(e){return this.getSandbox().request(this,e)},issue:function(){var e=arguments[0],t=this.slicer.apply(arguments,[1]),i=this.getSandbox().getRequestBuilder(e),n=i.apply(i,t);return this.getSandbox().request(this.getExtension(),n)},notify:function(){var e=arguments[0],t=this.slicer.apply(arguments,[1]),i=this.getSandbox().getEventBuilder(e),n=i.apply(i,t);return this.getSandbox().notifyAll(n)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension","Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.userinterface.extension.EnhancedView",function(){},{getName:function(){return"Oskari.userinterface.extension.EnhancedView"}},{protocol:["Oskari.userinterface.View"],extend:["Oskari.userinterface.extension.DefaultView"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.ToolbarBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.toolbar.ToolbarBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/button-methods.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/default-buttons.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/AddToolButtonRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/RemoveToolButtonRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ToolButtonStateRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/SelectToolButtonRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ToolButtonRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ShowMapMeasurementRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/event/ToolSelectedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ToolbarRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/request/ToolbarRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/toolbar/css/toolbar.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/toolbar/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"toolbar","Bundle-Name":"toolbar","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"Toolbar",Title:"Toolbar"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("toolbar","Oskari.mapframework.bundle.toolbar.ToolbarBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.ToolbarBundleInstance",function(){this.sandbox=null,this.started=!1,this.buttons={},this.selectedButton=null,this.defaultButton=null,this.container=null,this.menutoolbarcontainer=null,this.containers={},this.toolbars={},this.groupsToToolbars={}
},{__name:"Toolbar",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},update:function(){},start:function(){var e=this;if(!e.started){e.started=!0;var t=e.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);n.register(e),e.setSandbox(n);var s=(t?t.defaultToolbarContainer:null)||"#toolbar";this.container=jQuery(s),this.containers["default"]=this.container,this.toolbars["default"]=this.container;var a=(t?t.defaultMenuToolbarContainer:null)||"#menutoolbar";this.menutoolbarcontainer=jQuery(a);for(var r in e.eventHandlers)r&&n.registerForEventByName(e,r);n.addRequestHandler("Toolbar.AddToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),n.addRequestHandler("Toolbar.RemoveToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),n.addRequestHandler("Toolbar.ToolButtonStateRequest",this.requestHandlers.toolButtonRequestHandler),n.addRequestHandler("Toolbar.SelectToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),n.addRequestHandler("Toolbar.ToolbarRequest",this.requestHandlers.toolbarRequestHandler),n.addRequestHandler("ShowMapMeasurementRequest",this.requestHandlers.showMapMeasurementRequestHandler),n.registerAsStateful(this.mediator.bundleId,this),this._addDefaultButtons&&this._addDefaultButtons()}},templates:{group:'<div class="toolrow"></div>',tool:'<div class="tool"></div>',menutoolbar:'<div class="oskari-closed oskariui-menutoolbar"><div class="oskariui-menutoolbar-modetitle"><div class="oskariui-menutoolbar-title"><p></p></div></div><div class="oskariui-menutoolbar-container"><div class="oskariui-menutoolbarbuttongroup"></div></div><div class="oskariui-menutoolbar-closebox"><div class="icon-close-white"></div></div></div>'},init:function(){var e=this;this.templateGroup=jQuery(this.templates.group),this.templateTool=jQuery(this.templates.tool),this.templateMenutoolbar=jQuery(this.templates.menutoolbar),this.requestHandlers={toolButtonRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.toolbar.request.ToolButtonRequestHandler",e),toolbarRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.toolbar.request.ToolbarRequestHandler",e),showMapMeasurementRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.toolbar.request.ShowMapMeasurementRequestHandler",e)}},createMenuToolbarContainer:function(e,t){var i=t||{},n=this.templateMenutoolbar.clone();this.menutoolbarcontainer.append(n),this.toolbars[e]=n;var s=n.find(".oskariui-menutoolbarbuttongroup");return this.containers[e]=s,i.title&&n.find(".oskariui-menutoolbar-title p").append(i.title),i.show&&n.removeClass("oskari-closed"),i.closeBoxCallback&&n.find(".oskariui-menutoolbar-closebox div").click(i.closeBoxCallback),s},changeMenuToolbarTitle:function(e){e&&this.menutoolbarcontainer.find(".oskariui-menutoolbar-title p").html(e)},getToolbarContainer:function(e,t){var i=e||"default",n=this.containers[i];return void 0===n&&this.menutoolbarcontainer&&(n=this.createMenuToolbarContainer(i,t)),n},onEvent:function(e){var t=this,i=t.eventHandlers[e.getName()];return i?i.apply(this,[e]):void 0},measureTools:{basictools:{measureline:!0,measurearea:!0}},eventHandlers:{"Toolbar.ToolSelectedEvent":function(e){var t=this,i=this.getSandbox();if(t.measureTools[e.getGroupId()]&&t.measureTools[e.getGroupId()][e.getToolId()]){var n=t.getLocalization("measure").guidance[e.getToolId()];i.request(t,i.getRequestBuilder("ShowMapMeasurementRequest")(n?n:"",!1,null,null))}}},stop:function(){var e=this,t=e.sandbox();for(var i in e.eventHandlers)i&&t.unregisterFromEventByName(e,i);t.removeRequestHandler("ShowMapMeasurementRequest",this.requestHandlers.showMapMeasurementRequestHandler),t.removeRequestHandler("Toolbar.ToolbarRequest",this.requestHandlers.toolbarRequestHandler),t.removeRequestHandler("Toolbar.AddToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),t.removeRequestHandler("Toolbar.RemoveToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),t.removeRequestHandler("Toolbar.ToolButtonStateRequest",this.requestHandlers.toolButtonRequestHandler),t.removeRequestHandler("Toolbar.SelectToolButtonRequest",this.requestHandlers.toolButtonRequestHandler),this.sandbox.unregisterStateful(this.mediator.bundleId),e.sandbox.unregister(e),e.started=!1},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},setState:function(e){if(e)if(e.selected){this.selectedButton=e.selected;var t=e.selected.id,i=e.selected.group,n=this.getToolbarContainer();this._removeToolSelections();var s=n.find("div.toolrow[tbgroup="+i+"]");if(s.length>0){var a=s.find("div.tool[tool="+t+"]");a.length>0&&(a.addClass("selected"),this.buttons[i][t].callback())}}else this.selectedButton=null},getState:function(){var e={};return this.selectedButton&&(e.selected=this.selectedButton),e},_removeToolbar:function(e){var t=this.toolbars[e];this.toolbars[e]=void 0,t.remove(),delete t},_showToolbar:function(e){this.toolbars[e].show()},_hideToolbar:function(e){this.toolbars[e].hide()},_addToolbar:function(e,t){this.getToolbarContainer(e,t)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.category("Oskari.mapframework.bundle.toolbar.ToolbarBundleInstance","button-methods",{addToolButton:function(e,t,i){if(e&&t&&i&&i.callback){var n=this,s=this.getToolbarContainer(i?i.toolbarid:null,i),a=null;if(this.buttons[t]?a=s.find("div.toolrow[tbgroup="+t+"]"):(this.buttons[t]={},a=this.templateGroup.clone(),a.attr("tbgroup",t),s.append(a),this.groupsToToolbars[t]=i?i.toolbarid:null),!this.buttons[t][e]){this.buttons[t][e]=i;var r=this.templateTool.clone();r.attr("tool",e),r.attr("title",i.tooltip),r.addClass(i.iconCls),this.selectedButton?this.selectedButton.id==e&&this.selectedButton.group==t&&(r.addClass("selected"),i.callback()):i.selected&&(r.addClass("selected"),this.selectedButton={id:e,group:t}),i.selected&&(this.defaultButton={id:e,group:t}),r.bind("click",function(){n._clickButton(e,t)}),i.prepend?a.prepend(r):a.append(r),i.disabled===!0&&r.addClass("disabled")}}},_clickButton:function(e,t){e||(e=this.defaultButton.id,t=this.defaultButton.group);var i=this.buttons[t][e];if(0!=i.enabled){if(1==i.sticky){var n=this.sandbox.getEventBuilder("Toolbar.ToolSelectedEvent")(e,t);this.sandbox.notifyAll(n),this._removeToolSelections(t);var s=this.getToolbarContainer(this.groupsToToolbars[t]),a=s.find("div.toolrow[tbgroup="+t+"]"),r=a.find("div.tool[tool="+e+"]");r.addClass("selected"),this.selectedButton={id:e,group:t}}if(i.toggleSelection){var s=this.getToolbarContainer(this.groupsToToolbars[t]),a=s.find("div.toolrow[tbgroup="+t+"]"),r=a.find("div.tool[tool="+e+"]");r.hasClass("selected")?r.removeClass("selected"):r.addClass("selected")}i.callback()}},_removeToolSelections:function(e){var t=this.getToolbarContainer(this.groupsToToolbars[e]),i=t.find("div.tool");i.removeClass("selected")},removeToolButton:function(e,t){if(t&&this.buttons[t]){var i=this.getToolbarContainer(this.groupsToToolbars[t]),n=i.find("div.toolrow[tbgroup="+t+"]");if(e){var s=n.find("div.tool[tool="+e+"]");s.remove(),this.buttons[t][e]=null,delete this.buttons[t][e]}else n.remove(),this.buttons[t]=null,delete this.buttons[t]}},changeToolButtonState:function(e,t,i){if(t&&this.buttons[t]){var n=this.getToolbarContainer(this.groupsToToolbars[t]),s=n.find("div.toolrow[tbgroup="+t+"]");if(e){var a=s.find("div.tool[tool="+e+"]");this.buttons[t][e].enabled=i,i?a.removeClass("disabled"):a.addClass("disabled")}else{var r=s.find("div.tool");i?r.removeClass("disabled"):r.addClass("disabled");for(var o in this.buttons[t])this.buttons[t][o].enabled=i}}}}),Oskari.clazz.category("Oskari.mapframework.bundle.toolbar.ToolbarBundleInstance","default-buttons",{_isButtonConfigured:function(e,t){return this.conf&&(this.conf[t]===!1||this.conf[t]&&this.conf[t][e]===!1)?!1:!0},_addDefaultButtons:function(){var e,t,i,n,s,a,r,o,l,u,c,h=this,d=this.getLocalization("buttons"),p=this.getSandbox().getRequestBuilder("ToolSelectionRequest"),f="MapModulePlugin.GetFeatureInfoActivationRequest",m=this.getSandbox().getRequestBuilder(f),g=null;this._isButtonConfigured("reset","history")&&this.addToolButton("reset","history",{iconCls:"tool-reset",tooltip:d.history.reset,sticky:!1,callback:function(){e=h.getSandbox().getRequestBuilder("StateHandler.SetStateRequest"),e&&h.getSandbox().request(h,e()),i=h.getSandbox().getRequestBuilder("ClearHistoryRequest")(),h.getSandbox().request(h,i)}}),h._isButtonConfigured("history_back","history")&&h.addToolButton("history_back","history",{iconCls:"tool-history-back",tooltip:d.history.back,sticky:!1,callback:function(){h.getSandbox().request(h,p("map_control_tool_prev"))}}),h._isButtonConfigured("history_forward","history")&&h.addToolButton("history_forward","history",{iconCls:"tool-history-forward",tooltip:d.history.next,sticky:!1,callback:function(){h.getSandbox().request(h,p("map_control_tool_next"))}}),h._isButtonConfigured("zoombox","basictools")&&h.addToolButton("zoombox","basictools",{iconCls:"tool-zoombox",tooltip:d.zoom,sticky:!0,callback:function(){t="map_control_zoom_tool",h.getSandbox().request(h,m(!1)),h.getSandbox().request(h,p(t))}}),h._isButtonConfigured("select","basictools")&&h.addToolButton("select","basictools",{iconCls:"tool-pan",tooltip:d.pan,selected:!0,sticky:!0,callback:function(){t="map_control_navigate_tool",h.getSandbox().request(h,m(!0)),h.getSandbox().request(h,p(t))}}),h._isButtonConfigured("measureline","basictools")&&h.addToolButton("measureline","basictools",{iconCls:"tool-measure-line",tooltip:d.measure.line,sticky:!0,callback:function(){t="map_control_measure_tool",h.getSandbox().request(h,m(!1)),h.getSandbox().request(h,p(t))}}),h._isButtonConfigured("measurearea","basictools")&&h.addToolButton("measurearea","basictools",{iconCls:"tool-measure-area",tooltip:d.measure.area,sticky:!0,callback:function(){t="map_control_measure_area_tool",h.getSandbox().request(h,m(!1)),h.getSandbox().request(h,p(t))}}),h.conf&&(g=h.getSandbox().getLocalizedProperty(h.conf.mapUrlPrefix)),h._isButtonConfigured("link","viewtools")&&g&&h.addToolButton("link","viewtools",{iconCls:"tool-link",tooltip:d.link.tooltip,sticky:!1,callback:function(){n=h.getSandbox().generateMapLinkParameters({showMarker:!0}),s="Oskari.userinterface.component.Popup",a="Oskari.userinterface.component.Button",r=Oskari.clazz.create(s),r.addClass("no_resize"),o=Oskari.clazz.create(a),o.setTitle(d.link.ok),o.addClass("primary"),o.setHandler(function(){t="EnableMapKeyboardMovementRequest",r.close(),h.getSandbox().postRequestByName(t)}),l='<textarea rows="3" cols="80">'+g+n+"</textarea>",t="DisableMapKeyboardMovementRequest",h.getSandbox().postRequestByName(t),r.show(d.link.title,l,[o])}}),h._isButtonConfigured("print","viewtools")&&h.addToolButton("print","viewtools",{iconCls:"tool-print",tooltip:d.print.tooltip,sticky:!1,callback:function(){u="location=1,status=1,scrollbars=1,width=850,height=1200",c=window.location.pathname+"?"+h.getSandbox().generateMapLinkParameters()+"&p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=0&p_p_state=exclusive"+"&showMarker=false&forceCache=true&mapmode=print&viewId=2",window.open(c,"Print",u)}})}}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.AddToolButtonRequest",function(e,t,i){this._id=e,this._group=t,this._config=i},{__name:"Toolbar.AddToolButtonRequest",getName:function(){return this.__name},getId:function(){return this._id},getGroup:function(){return this._group},getConfig:function(){return this._config}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.RemoveToolButtonRequest",function(e,t){this._id=e,this._group=t},{__name:"Toolbar.RemoveToolButtonRequest",getName:function(){return this.__name},getId:function(){return this._id},getGroup:function(){return this._group}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ToolButtonStateRequest",function(e,t,i){this._id=e,this._group=t,this._state=1==i},{__name:"Toolbar.ToolButtonStateRequest",getName:function(){return this.__name},getId:function(){return this._id},getGroup:function(){return this._group},getState:function(){return this._state}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.SelectToolButtonRequest",function(e,t){this._id=e,this._group=t},{__name:"Toolbar.SelectToolButtonRequest",getName:function(){return this.__name},getId:function(){return this._id},getGroup:function(){return this._group}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ToolButtonRequestHandler",function(e){this._toolbar=e},{handleRequest:function(e,t){var i=e.getSandbox();"Toolbar.AddToolButtonRequest"==t.getName()?this._handleAdd(i,t):"Toolbar.RemoveToolButtonRequest"==t.getName()?this._handleRemove(i,t):"Toolbar.ToolButtonStateRequest"==t.getName()?this._handleState(i,t):"Toolbar.SelectToolButtonRequest"==t.getName()&&this._handleClick(i,t)},_handleAdd:function(e,t){this._toolbar.addToolButton(t.getId(),t.getGroup(),t.getConfig())},_handleRemove:function(e,t){this._toolbar.removeToolButton(t.getId(),t.getGroup())},_handleState:function(e,t){this._toolbar.changeToolButtonState(t.getId(),t.getGroup(),t.getState())},_handleClick:function(e,t){this._toolbar._clickButton(t.getId(),t.getGroup())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ShowMapMeasurementRequestHandler",function(e){var t=this;t._toolbar=e;var i=this._toolbar.getLocalization("measure"),n=i.title;t._title=n,t._dialog=Oskari.clazz.create("Oskari.userinterface.component.Popup"),t._dialog.addClass("oskari-measurement");var s=[],a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(i.close),s.push(a),t._buttons=s,t._dialogShown=!1,t._content=null},{handleRequest:function(e,t){e.getSandbox(),this._showMeasurementResults(t.getValue())},getValue:function(){return this._value},_showMeasurementResults:function(e){var t=this,i=t._dialog;if(!t._dialogShown){i.show(t._title,"",t._buttons);var n=t._buttons[0];n.setHandler(function(){t._dialogShown=!1;var e=t._toolbar.getSandbox().getRequestBuilder("Toolbar.SelectToolButtonRequest")();t._toolbar.getSandbox().request(t._toolbar,e),t._dialog.close(!0)}),i.moveTo("#toolbar div.toolrow[tbgroup=basictools]","top"),t._content=jQuery("<div></div>"),i.setContent(t._content),t._dialogShown=!0}t._content.html(e)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.event.ToolSelectedEvent",function(e,t){this._toolId=e,this._groupId=t},{__name:"Toolbar.ToolSelectedEvent",getName:function(){return this.__name},getToolId:function(){return this._toolId},getGroupId:function(){return this._groupId}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ToolbarRequest",function(e,t,i){this._id=e,this._op=t,this._data=i},{__name:"Toolbar.ToolbarRequest",getName:function(){return this.__name},getId:function(){return this._id},getOp:function(){return this._op},getData:function(){return this._data}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.toolbar.request.ToolbarRequestHandler",function(e){this._toolbar=e},{handleRequest:function(e,t){e.getSandbox(),"add"==t.getOp()?this._toolbar._addToolbar(t.getId(),t.getData()):"show"==t.getOp()?this._toolbar._showToolbar(t.getId()):"hide"==t.getOp()?this._toolbar._hideToolbar(t.getId()):"remove"==t.getOp()?this._toolbar._removeToolbar(t.getId()):"changeName"==t.getOp()&&this._toolbar.changeMenuToolbarTitle(t.getData())},_handleAdd:function(e,t){this._toolbar.addToolButton(t.getId(),t.getGroup(),t.getConfig())},_handleRemove:function(e,t){this._toolbar.removeToolButton(t.getId(),t.getGroup())},_handleState:function(e,t){this._toolbar.changeToolButtonState(t.getId(),t.getGroup(),t.getState())},_handleClick:function(e,t){this._toolbar._clickButton(t.getId(),t.getGroup())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.StateHandlerBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.StateHandlerBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/instance.js"},{type:"text/javascript",src:"../../../../libraries/jquery/plugins/jquery.cookie.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/state-methods.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/plugin/Plugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/plugin/SaveViewPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/request/SetStateRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/request/SetStateRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/event/StateSavedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/request/SaveStateRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/statehandler/request/SaveStateRequestHandler.js"}]},bundle:{manifest:{"Bundle-Identifier":"statehandler","Bundle-Name":"statehandler","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"statehandler",Title:"statehandler"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("statehandler","Oskari.mapframework.bundle.statehandler.StateHandlerBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.StateHandlerBundleInstance",function(){this._localization=null,this._pluginInstances={},this._startupState=null,this._historyPollingInterval=1500,this._historyTimer=null,this._historyPrevious=[],this._historyNext=[],this._historyEnabled=!0,this._defaultViewId=1,this._currentViewId="undefined"!=typeof window.viewId?window.viewId:this._defaultViewId},{__name:"StateHandler",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);var s=n.getAjaxUrl(),a=Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.plugin.SaveViewPlugin",s);this.registerPlugin(a),this.startPlugin(a),n.addRequestHandler("StateHandler.SetStateRequest",this.requestHandlers.setStateHandler),n.addRequestHandler("StateHandler.SaveStateRequest",this.requestHandlers.saveStateHandler)}},update:function(){},stop:function(){var e=this.sandbox();e.removeRequestHandler("StateHandler.SetStateRequest",this.requestHandlers.setStateHandler),e.removeRequestHandler("StateHandler.SaveStateRequest",this.requestHandlers.saveStateHandler);var t=e.getRequestBuilder("MapControls.ToolButtonRequest");t&&e.request(this,t(this.toolbar.config,"remove"));for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);this.sandbox.unregister(this),this.started=!1},init:function(){var e=this.sandbox;return this.requestHandlers={setStateHandler:Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.request.SetStateRequestHandler",e,this),saveStateHandler:Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.request.SaveStateRequestHandler",e,this)},null},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapMoveEvent:function(){var e=this;e._pushState()},AfterMapLayerAddEvent:function(){var e=this;e._pushState()},AfterMapLayerRemoveEvent:function(){var e=this;e._pushState()},AfterChangeMapLayerStyleEvent:function(){var e=this;e._pushState()},MapLayerVisibilityChangedEvent:function(){var e=this;e._pushState()}},registerPlugin:function(e){e.setHandler(this);var t=e.getName();this.sandbox.printDebug("["+this.getName()+"]"+" Registering "+t),this._pluginInstances[t]=e},unregisterPlugin:function(e){var t=e.getName();this.sandbox.printDebug("["+this.getName()+"]"+" Unregistering "+t),this._pluginInstances[t]=void 0,e.setHandler(null)},startPlugin:function(e){var t=e.getName();this.sandbox.printDebug("["+this.getName()+"]"+" Starting "+t),e.startPlugin(this.sandbox)},stopPlugin:function(e){var t=e.getName();this.sandbox.printDebug("["+this.getName()+"]"+" Starting "+t),e.stopPlugin(this.sandbox)},setCurrentViewId:function(e){this._currentViewId=e},getCurrentViewId:function(){return this._currentViewId},_stateComparators:[{rule:"nohistory",cmp:function(e){return e?void 0:!0}},{rule:"location",cmp:function(e,t){return e.east!=t.east||e.north!=t.north?!0:e.zoom!=t.zoom?!0:void 0}},{rule:"layers",cmp:function(e,t){var i=this,n=e.selectedLayers,s=t.selectedLayers;if(n.length!=s.length)return!0;for(var a=0;a<s.length;a++){var r=n[a],o=s[a];if(i.sandbox.printDebug("[StateHandler] comparing layer state "+r.id+" vs "+o.id),r.id!==o.id)return!0;if(r.opacity!==o.opacity)return!0;if(r.hidden!==o.hidden)return!0;if(r.style!==o.style)return!0}return!1}}],_compareState:function(e,t,i){for(var n={result:!1,rule:null,rulesMatched:{}},s=this,a=0;a<s._stateComparators.length;a++){var r=s._stateComparators[a];if(s.sandbox.printDebug("[StateHandler] comparing state "+r.rule),r.cmp.apply(this,[e,t])&&(s.sandbox.printDebug("[StateHandler] comparing state MATCH "+r.rule),n.result=!0,n.rule=r.rule,n.rulesMatched[r.rule]=r.rule,i))return n}return n},_logState:function(){var e=this,t=e.conf.logUrl+"?"+e.sandbox.generateMapLinkParameters();jQuery.ajax({type:"GET",url:t})},_pushState:function(){var e=this;if(e._historyEnabled){var t=e._historyPrevious,i=this._getMapState(),n=0==t.length?null:t[t.length-1],s=e._compareState(n,i,!0);s.result&&(e.sandbox.printDebug("[StateHandler] PUSHING state"),i.rule=s.rule,e._historyPrevious.push(i),e._historyNext=[],e.conf&&e.conf.logUrl&&e._logState())}},historyMoveNext:function(){var e=this.getSandbox();if(this._historyNext.length>0){var t=this._historyNext.pop();this._historyPrevious.push(t);var i=e.findRegisteredModuleInstance("MainMapModule");this._historyEnabled=!1;var n=this._getMapState();this._setMapState(i,t,n),this._historyEnabled=!0}},historyMovePrevious:function(){var e=this.getSandbox();switch(this._historyPrevious.length){case 0:break;case 1:var t=this._historyNext;this.resetState(),this._historyNext=t;break;default:var i=this._historyPrevious.pop();this._historyNext.push(i);var n=this._historyPrevious[this._historyPrevious.length-1],s=e.findRegisteredModuleInstance("MainMapModule"),a=this._getMapState();this._historyEnabled=!1,this._setMapState(s,n,a),this._historyEnabled=!0}},_getMapState:function(){var e=this.getSandbox(),t=e.getMap(),i=e.findAllSelectedMapLayers();t.getZoom();for(var n=t.getX(),s=t.getY(),a={north:s,east:n,zoom:t.getZoom(),selectedLayers:[]},r=0;r<i.length;r++){var o=i[r],l={id:o.getId(),opacity:o.getOpacity()};o.isVisible()||(l.hidden=!0),o.getCurrentStyle&&o.getCurrentStyle()&&o.getCurrentStyle().getName()&&"!default!"!=o.getCurrentStyle().getName()&&(l.style=o.getCurrentStyle().getName()),a.selectedLayers.push(l)}return a},_setMapState:function(e,t,i){var n=this.getSandbox(),s=this._compareState(i,t,!1);if(t.selectedLayers&&s.rulesMatched.layers){n.printDebug("[StateHandler] restoring LAYER state"),this._teardownState(e);for(var a=n.getRequestBuilder("AddMapLayerRequest"),r=n.getRequestBuilder("ChangeMapLayerOpacityRequest"),o=n.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest"),l=n.getRequestBuilder("ChangeMapLayerStyleRequest"),u=t.selectedLayers.length,c=0;u>c;++c){var h=t.selectedLayers[c];n.request(e.getName(),a(h.id,!0)),h.hidden?n.request(e.getName(),o(h.id,!1)):n.request(e.getName(),o(h.id,!0)),h.style&&n.request(e.getName(),l(h.id,h.style)),h.opacity&&n.request(e.getName(),r(h.id,h.opacity))}}t.east&&(n.printDebug("[StateHandler] restoring LOCATION state"),this.getSandbox().getMap().moveTo(t.east,t.north,t.zoom)),n.syncMapState(!0)},_teardownState:function(e){for(var t=this.getSandbox(),i=t.findAllSelectedMapLayers(),n=t.getRequestBuilder("RemoveMapLayerRequest"),s=0;s<i.length;s++)t.request(e.getName(),n(i[s].getId()))}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),function(e,t,i){function n(e){return e}function s(e){return decodeURIComponent(e.replace(a," "))}var a=/\+/g,r=e.cookie=function(a,o,l){if(o!==i){if(l=e.extend({},r.defaults,l),null===o&&(l.expires=-1),"number"==typeof l.expires){var u=l.expires,c=l.expires=new Date;c.setDate(c.getDate()+u)}return o=r.json?JSON.stringify(o):String(o),t.cookie=[encodeURIComponent(a),"=",r.raw?o:encodeURIComponent(o),l.expires?"; expires="+l.expires.toUTCString():"",l.path?"; path="+l.path:"",l.domain?"; domain="+l.domain:"",l.secure?"; secure":""].join("")}for(var h,d=r.raw?n:s,p=t.cookie.split("; "),f=0;h=p[f]&&p[f].split("=");f++)if(d(h.shift())===a){var m=d(h.join("="));return r.json?JSON.parse(m):m}return null};r.defaults={},e.removeCookie=function(t,i){return null!==e.cookie(t)?(e.cookie(t,null,i),!0):!1}}(jQuery,document),Oskari.clazz.category("Oskari.mapframework.bundle.statehandler.StateHandlerBundleInstance","state-methods",{useState:function(e){if(!e)return[];var t=this.sandbox.getStatefulComponents(),i=[];for(var n in e)t[n]&&t[n].setState&&t[n].setState(e[n].state),i.push(n);return i},resetState:function(){var e=this;e._historyEnabled=!1,e._historyPrevious=[],e._historyNext=[];for(var t in this._pluginInstances)e.sandbox.printDebug("["+e.getName()+"]"+" resetting state on "+t),e._pluginInstances[t].resetState();e._currentViewId=this._defaultViewId,e._startupState?e._resetComponentsWithNoStateData(e.useState(this._startupState)):jQuery.ajax({dataType:"json",type:"GET",url:e.sandbox.getAjaxUrl()+"action_route=GetAppSetup&noSavedState=true",success:function(t){t&&t.configuration?(e._startupState=t.configuration,e._resetComponentsWithNoStateData(e.useState(t.configuration)),e._historyEnabled=!0):alert("error in getting configuration")},error:function(){alert("error loading conf"),e._historyEnabled=!0},complete:function(){e._historyEnabled=!0}}),e._historyEnabled=!0},_resetComponentsWithNoStateData:function(e){var t=this.sandbox.getStatefulComponents();for(var i in t){for(var n=!1,s=0;s<e.length;++s)if(i==e[s]){n=!0;break}n||t[i].setState()}},saveState:function(e,t){if(t)this.sandbox.printDebug("["+this.getName()+"]"+" saving state with "+t),this._pluginInstances[t].saveState(e);else for(var t in this._pluginInstances)this.saveState(e,t)},getCurrentState:function(){var e={},t=this.sandbox.getStatefulComponents();for(var i in t)t[i].getState?e[i]={state:t[i].getState()}:this.sandbox.printWarn("Stateful component "+i+" doesnt have getState()");return e},getSavedState:function(e){return this._pluginInstances[e].getState()}}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.plugin.Plugin",function(){throw"Oskari.mapframework.bundle.statehandler.Plugin should not be instantiated"},{getName:function(){throw"Implement your own"},setHandler:function(){throw"Implement your own"},startPlugin:function(){throw"Implement your own"},stopPlugin:function(){throw"Implement your own"},getState:function(){throw"Implement your own"},resetState:function(){throw"Implement your own"},saveState:function(){throw"Implement your own"}}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.plugin.SaveViewPlugin",function(e){this.handler=null,this.pluginName=null,this._sandbox=null,this._ajaxUrl=e},{__name:"statehandler.SaveViewPlugin",getName:function(){return this.pluginName},getHandler:function(){return this.handler},setHandler:function(e){this.handler=e,this.pluginName=e.getName()+this.__name},getState:function(){},resetState:function(){},saveState:function(e,t){var i=t,n=this;i||(i=this.handler.getCurrentState());var s={currentViewId:n.handler.getCurrentViewId(),viewData:i};e&&(s.viewName=e.name,s.viewDescription=e.description);var a=n._sandbox.getEventBuilder("StateSavedEvent"),r=a(s.viewName,i);jQuery.cookie.json=!0;var o=7;jQuery.cookie("oskaristate",s,{expires:o}),s.viewData=JSON.stringify(s.viewData),jQuery.ajax({type:"POST",url:this._ajaxUrl+"action_route=AddView",data:s,success:function(e){n._sandbox.notifyAll(r),n.handler.setCurrentViewId(e.id)},error:function(){s.viewName&&(r.setError(!0),n._sandbox.notifyAll(r))}})},serializeJSON:function(e){var t=this,i=typeof e;if("object"!=i||null===e)return"string"==i&&(e='"'+e+'"'),String(e);var n=[],s=e&&e.constructor==Array;return jQuery.each(e,function(e,a){i=typeof a,"string"==i?a='"'+a+'"':"object"==i&null!==a&&(a=t.serializeJSON(a)),n.push((s?"":'"'+e+'":')+String(a))}),(s?"[":"{")+String(n)+(s?"]":"}")},startPlugin:function(e){this._sandbox=e;var t=this;jQuery(document).ready(function(){window.onbeforeunload=function(){t.saveState()}})},stopPlugin:function(){this._sandbox=null}},{protocol:["Oskari.mapframework.bundle.statehandler.plugin.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.request.SetStateRequest",function(e){this._creator=null,this._state=e,this._currentViewId=1},{__name:"StateHandler.SetStateRequest",getName:function(){return this.__name},getState:function(){return this._state},getCurrentViewId:function(){return this._currentViewId},setCurrentViewId:function(e){this.currentViewId=e}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.request.SetStateRequestHandler",function(e,t){this.sandbox=e,this.statehandler=t},{handleRequest:function(e,t){t.getState()?(this.statehandler.setCurrentViewId(t.getCurrentViewId()),this.statehandler.useState(t.getState())):this.statehandler.resetState()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.event.StateSavedEvent",function(e,t){this._name=e,this._state=t,this._error=!1},{__name:"StateSavedEvent",getName:function(){return this.__name},getViewName:function(){return this._name},getState:function(){return this._state},isError:function(){return this._error},setError:function(e){this._error=1==e}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.request.SaveStateRequest",function(e,t){this._viewName=e,this._viewDescription=t},{__name:"StateHandler.SaveStateRequest",getName:function(){return this.__name},getViewName:function(){return this._viewName},getViewDescription:function(){return this._viewDescription}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.request.SaveStateRequestHandler",function(e,t){this.sandbox=e,this.statehandler=t},{handleRequest:function(e,t){this.statehandler.saveState({name:t.getViewName(),description:t.getViewDescription()})}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.InfoBoxBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.infobox.InfoBoxBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/plugin/openlayerspopup/OpenlayersPopupPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/request/ShowInfoBoxRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/request/ShowInfoBoxRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/request/HideInfoBoxRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/infobox/request/HideInfoBoxRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/infobox/css/infobox.css"}]},bundle:{manifest:{"Bundle-Identifier":"infobox","Bundle-Name":"infobox","Bundle-Author":[{Name:"ev",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("infobox","Oskari.mapframework.bundle.infobox.InfoBoxBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.InfoBoxBundleInstance",function(){this.sandbox=null,this.started=!1,this.mediator=null
},{__name:"Infobox",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},update:function(){},start:function(){var e=this;if(!e.started){e.started=!0;var t=Oskari.$("sandbox");t.register(e),e.setSandbox(t);for(var i in e.eventHandlers)i&&t.registerForEventByName(e,i);var n=t.findRegisteredModuleInstance("MainMapModule");n.registerPlugin(this.popupPlugin),n.startPlugin(this.popupPlugin),t.addRequestHandler("InfoBox.ShowInfoBoxRequest",this.requestHandlers.showInfoHandler),t.addRequestHandler("InfoBox.HideInfoBoxRequest",this.requestHandlers.hideInfoHandler)}},init:function(){var e=this.conf&&this.conf.adaptable===!0;return this.popupPlugin=Oskari.clazz.create("Oskari.mapframework.bundle.infobox.plugin.mapmodule.OpenlayersPopupPlugin"),this.popupPlugin.setAdaptable(e),this.requestHandlers={showInfoHandler:Oskari.clazz.create("Oskari.mapframework.bundle.infobox.request.ShowInfoBoxRequestHandler",this.popupPlugin),hideInfoHandler:Oskari.clazz.create("Oskari.mapframework.bundle.infobox.request.HideInfoBoxRequestHandler",this.popupPlugin)},null},onEvent:function(e){var t=this,i=t.eventHandlers[e.getName()];return i?i.apply(this,[e]):void 0},eventHandlers:{},stop:function(){var e=this,t=this.sandbox;for(var i in e.eventHandlers)i&&t.unregisterFromEventByName(e,i);e.sandbox.unregister(e),e.started=!1},setState:function(e){if(e&&e.popups){this.popupPlugin.close();for(var t=0;t<e.popups.length;++t){var i=e.popups[t];this.popupPlugin.popup(i.id,i.title,i.data,i.lonlat)}}},getState:function(){var e={popups:[]},t=this.popupPlugin.getPopups();for(var i in t){var n=t[i],s={id:i,title:n.title,data:n.contentData,lonlat:n.lonlat};e.popups.push(s)}return e}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),jQuery.fn.outerHTML=function(e){var t;return this.length?e?(jQuery.each(this,function(t,i){var n,s=i,a=i.outerHTML?"outerHTML":"innerHTML";i.outerHTML||(i=jQuery(i).wrap("<div>").parent()[0]),jQuery.isFunction(e)?(n=e.call(s,t,i[a]))!==!1&&(i[a]=n):i[a]=e,i.outerHTML||jQuery(i).children().unwrap()}),this):this[0].outerHTML||(t=this.wrap("<div>").parent().html(),this.unwrap(),t):"undefined"==typeof val?this:null},Oskari.clazz.define("Oskari.mapframework.bundle.infobox.plugin.mapmodule.OpenlayersPopupPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._popups={}},{__name:"OpenLayersPopupPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+this.__name},init:function(){this._arrow=jQuery('<div class="popupHeaderArrow"></div>'),this._header=jQuery("<div></div>"),this._headerWrapper=jQuery('<div class="popupHeader"></div>'),this._headerCloseButton=jQuery('<div class="olPopupCloseBox icon-close-white" style="position: absolute; top: 12px;"></div>'),this._contentDiv=jQuery('<div class="popupContent"></div>'),this._contentWrapper=jQuery('<div class="contentWrapper"></div>'),this._actionLink=jQuery('<span class="infoboxActionLinks"><a href="#"></a></span>'),this._actionButton=jQuery('<span class="infoboxActionLinks"><input type="button" /></span>'),this._contentSeparator=jQuery('<div class="infoboxLine">separator</div>')},popup:function(e,t,i,n,s,a){var r=this,o=this._arrow.clone(),l=this._header.clone(),u=this._headerWrapper.clone(),c=this._contentDiv.clone(),h=this._headerCloseButton.clone();l.append(t),u.append(l),u.append(h);for(var d=0;d<i.length;d++){0!=d&&c.append(this._contentSeparator.clone());var p=i[d].html,f=this._contentWrapper.clone();f.append(p);var m=i[d].actions,g=1==i[d].useButtons,y=i[d].primaryButton;for(var v in m){var b=v;m[v];var _=null;if(g){_=this._actionButton.clone();var w=_.find("input");w.attr("contentdata",d),w.attr("value",b),b==y&&w.addClass("primary")}else{_=this._actionLink.clone();var L=_.find("a");L.attr("contentdata",d),L.append(b)}f.append(_)}c.append(f)}var k=this.getMapModule().getMap(),O=new OpenLayers.Popup(e,new OpenLayers.LonLat(n.lon,n.lat),new OpenLayers.Size(400,300),o.outerHTML()+u.outerHTML()+c.outerHTML(),!1);O.moveTo=function(e){if(null!=e&&null!=this.div){this.div.style.left=e.x+"px";var t=e.y-20;this.div.style.top=t+"px"}},O.setBackgroundColor("transparent"),this._popups[e]={title:t,contentData:i,lonlat:n,popup:O},jQuery(O.div).css("overflow","visible"),jQuery(O.groupDiv).css("overflow","visible"),O.events.un({click:O.onclick,scope:O}),O.events.on({click:function(t){var n=jQuery(t.target||t.srcElement);if(n.hasClass("olPopupCloseBox"))r.close(e);else{var s=n.attr("contentdata"),a=n.attr("value");a||(a=n.html()),i[s]&&i[s].actions&&i[s].actions[a]&&i[s].actions[a]()}},scope:O}),k.addPopup(O),this.adaptable&&jQuery(this._adaptPopupSize($)),this._panMapToShowPopup(n),s&&this._changeColourScheme(s),a&&this._changeFont(a)},setAdaptable:function(e){this.adaptable=e},_adaptPopupSize:function(e){var t=e(".olMapViewport"),i=e(".olPopup"),n=parseFloat(i.css("left"))+10;i.find(".popupHeaderArrow").css({"margin-left":"-10px"}),i.find(".popupHeader").css("width","100%");var s=i.find(".popupContent").css({"margin-left":"0",padding:"5px 20px 5px 20px"});i.find(".olPopupContent").css({width:"100%",height:"100%"});var a=.7*t.width(),r=.7*t.height(),o=s.find(".contentWrapper");if(jQuery.browser.msie)o.css({"padding-bottom":"5px"});else{var l=o.height();l=l>r?r+30+"px":"auto",s.css({height:l})}i.css({height:"auto",width:"auto","min-width":"256px","max-width":a+"px","min-height":"200px","max-height":r+"px",left:n+"px","z-index":"16000"})},_panMapToShowPopup:function(e){var t=this._map.getViewPortPxFromLonLat(e),i=this._map.getCurrentSize(),n=i.w,s=i.h,a=0,r=0,o=jQuery(".olPopup"),l=o.width()+50,u=o.height()+90;t.x+l>n&&(a=n-(t.x+l)),t.y+u>s?r=s-(t.y+u):t.y<25&&(r=25),(0!=a||0!=r)&&this.getMapModule().panMapByPixels(-a,-r)},_changeColourScheme:function(e,t){if(t=t||jQuery("div#getinforesult"),e&&t){var i=t.find("div.popupHeaderArrow"),n=t.find("div.popupHeader"),s=t.find("div.popupTitle"),a=t.find("div.getinforesult_header"),r=t.find("h3.myplaces_header"),o=t.find("div.olPopupCloseBox");i.css({"border-right-color":e.bgColour}),n.css({"background-color":e.bgColour,color:e.titleColour}),s.css({color:e.titleColour}),a.css({"background-color":e.bgColour}),a.find("div.getinforesult_header_title").css({color:e.titleColour}),r.css({color:e.headerColour}),o.removeClass("icon-close-white"),o.removeClass("icon-close"),o.addClass(e.iconCls)}},_changeFont:function(e,t){if(t=t||jQuery("div#getinforesult"),t&&e){var i=[];i.push(t),i.push(t.find("table.getinforesult_table"));for(var n=0;n<i.length;n++){var s=i[n];s.removeClass(function(){for(var e="",t=this.className.split(" "),i=0;i<t.length;++i)/oskari-publisher-font-/.test(t[i])&&(e+=t[i]+" ");return e}),s.addClass("oskari-publisher-font-"+e)}}},close:function(e){if(e)this._popups[e]&&(this._popups[e].popup&&this._popups[e].popup.destroy(),delete this._popups[e]);else for(var t in this._popups)this._popups[t].popup.destroy(),delete this._popups[t]},getPopups:function(){return this._popups},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this)},stopPlugin:function(e){e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.request.ShowInfoBoxRequest",function(e,t,i,n,s,a,r){this._creator=null,this._id=e,this._title=t,this._content=i,this._position=n,this._hidePrevious=1==s,this._colourScheme=a,this._font=r},{__name:"InfoBox.ShowInfoBoxRequest",getName:function(){return this.__name},getId:function(){return this._id},getTitle:function(){return this._title},getContent:function(){return this._content},getPosition:function(){return this._position},getHidePrevious:function(){return this._hidePrevious},getColourScheme:function(){return this._colourScheme},getFont:function(){return this._font}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.request.ShowInfoBoxRequestHandler",function(e){this.popupPlugin=e},{handleRequest:function(e,t){t.getHidePrevious()&&this.popupPlugin.close(),this.popupPlugin.popup(t.getId(),t.getTitle(),t.getContent(),t.getPosition(),t.getColourScheme(),t.getFont())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.request.HideInfoBoxRequest",function(e){this._creator=null,this._id=e},{__name:"InfoBox.HideInfoBoxRequest",getName:function(){return this.__name},getId:function(){return this._id}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.infobox.request.HideInfoBoxRequestHandler",function(e){this.popupPlugin=e},{handleRequest:function(e,t){this.popupPlugin.close(t.getId())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.search.SearchBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.search.SearchBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/service/searchservice.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/search/Tile.js"},{type:"text/css",src:"../../../../resources/framework/bundle/search/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/search/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"search","Bundle-Name":"search","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("search","Oskari.mapframework.bundle.search.SearchBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.search.SearchBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.service=null},{__name:"Search",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e&&this._localization[e]?this._localization[e]:this.localization?this._localization:{}},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,this.localization=Oskari.getLocalization(this.getName());var s=null;s=this.conf&&this.conf.url?this.conf.url:n.getAjaxUrl()+"action_route=GetSearchResult";var a="Oskari.mapframework.bundle.search.service.SearchService";this.service=Oskari.clazz.create(a,s),n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);var r="userinterface.AddExtensionRequest",o=n.getRequestBuilder(r),l=o(this);n.request(this,l),n.registerAsStateful(this.mediator.bundleId,this),e.createUi()}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t="userinterface.RemoveExtensionRequest",i=e.getRequestBuilder(t),n=i(this);e.request(this,n),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.search.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.search.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.search.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.templateResultTable=null,this.templateResultTableHeader=null,this.templateResultTableRow=null,this.resultHeaders=[],this.lastResult=null,this.lastSort=null,this._searchContainer=null},{getName:function(){return"Oskari.mapframework.bundle.search.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("search")||jQuery(this.container).addClass("search")},startPlugin:function(){this.template=jQuery('<div class="searchContainer"><div class="searchDescription"></div><div class="controls"></div><div><br></div><div class="info"></div><div><br></div><div class="resultList"></div></div>'),this.templateResultTable=jQuery('<table class="search_result"><thead><tr></tr></thead><tbody></tbody></table>'),this.templateResultTableHeader=jQuery('<th><a href="JavaScript:void(0);"></a></th>'),this.templateResultTableRow=jQuery('<tr><td><a href="JavaScript:void(0);"></a></td><td></td><td></td></tr>'),this.resultHeaders=[{title:this.instance.getLocalization("grid").name,prop:"name"},{title:this.instance.getLocalization("grid").village,prop:"village"},{title:this.instance.getLocalization("grid").type,prop:"type"}]},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},getState:function(){return this.state?this.state:{}},createUi:function(){var e=this,t=e.instance.getSandbox(),i=jQuery(this.container);i.empty();var n=this.template.clone();this._searchContainer=n;var s=n.find("div.searchDescription");s.html(this.instance.getLocalization("searchDescription"));var a=Oskari.clazz.create("Oskari.userinterface.component.FormInput"),r=/[\s\w\d\.\,\?\!\-äöåÄÖÅ]*\*?$/;a.setContentCheck(!0,this.instance.getLocalization("contentErrorMsg"),r),a.bindChange(function(){null===e.state&&(e.state={});var i=a.getValue();if(e.state.searchtext=i,!i){var s=n.find("div.info");s.empty();var r=n.find("div.resultList");r.empty();var o=t.getRequestBuilder("MapModulePlugin.RemoveMarkerRequest");o&&t.request(e.instance.getName(),o())}}),a.addClearButton();var o=Oskari.clazz.create("Oskari.userinterface.component.Button");o.setTitle(this.instance.getLocalization("searchButton"));var l=function(){a.setEnabled(!1),o.setEnabled(!1);var t=n.find("div.resultList");t.empty();var i=n.find("div.info");i.empty();var s=a.getValue(!0);e.instance.service.doSearch(s,function(t){a.setEnabled(!0),o.setEnabled(!0),e._renderResults(t,s)},function(){a.setEnabled(!0),o.setEnabled(!0);var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=t.createCloseButton("OK"),n=e.instance.getLocalization("searchservice_search_alert_title");t.show(n,n,[i])})};o.setHandler(l),a.bindEnterKey(l);var u=n.find("div.controls");u.append(a.getField()),u.append(o.getButton()),i.append(n)},_renderResults:function(e,t){if(e&&"number"==typeof e.totalCount){var i=this._searchContainer.find("div.resultList");i.empty(),this.lastResult=e;var n=this,s=this._searchContainer.find("div.info");s.empty();var a=this.instance;if(-1==e.totalCount)return i.append(this.instance.getLocalization("searchservice_search_alert_title")+this.instance.getLocalization(e.errorText)),void 0;if(0==e.totalCount){var r="searchservice_search_alert_title",o=a.getLocalization(r),l="searchservice_search_not_found_anything_text",u=a.getLocalization(l);return i.append(o+":"+u),void 0}s.append(this.instance.getLocalization("searchResultCount")+e.totalCount+this.instance.getLocalization("searchResultCount2")),s.append("<br/>"),e.hasMore&&(s.append(this.instance.getLocalization("searchResultDescriptionMoreResults")),s.append("<br/>")),s.append(this.instance.getLocalization("searchResultDescriptionOrdering")),1==e.totalCount&&(n._resultClicked(e.locations[0]),a.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[n.instance,"close"]));for(var c=this.templateResultTable.clone(),h=c.find("thead tr"),d=c.find("tbody"),p=function(e){return function(){d.empty();var t=!1;n.lastSort&&n.lastSort.attr==e.prop&&(t=!n.lastSort.descending),n._sortResults(e.prop,t),n._populateResultTable(d);var i=h.find("a:contains("+e.title+")");return h.find("th").removeClass("asc"),h.find("th").removeClass("desc"),t?i.parent().addClass("desc"):i.parent().addClass("asc"),!1}},f=0;f<this.resultHeaders.length;++f){var m=this.templateResultTableHeader.clone(),g=m.find("a");g.append(this.resultHeaders[f].title),g.bind("click",p(this.resultHeaders[f])),h.append(m)}this._populateResultTable(d),i.append("<div><h3>"+this.instance.getLocalization("searchResults")+e.totalCount+this.instance.getLocalization("searchResultsDescription")+t+"</h3></div>"),i.append(c)}},_populateResultTable:function(e){for(var t=this,i=function(e){return function(){return t._resultClicked(e),!1}},n=this.lastResult.locations,s=0;s<n.length;++s){var a=n[s],r=this.templateResultTableRow.clone(),o=r.find("td"),l=jQuery(o[0]),u=l.find("a");u.append(a.name),u.bind("click",i(a)),jQuery(o[1]).append(a.village),jQuery(o[2]).append(a.type),e.append(r)}},_resultClicked:function(e){var t=this,i="searchResultPopup",n=this.instance,s=n.sandbox,a=s.getRequestBuilder("MapMoveRequest");s.request(t.instance.getName(),a(e.lon,e.lat,e.zoomLevel,!1));var r=this.instance.getLocalization("resultBox"),o={html:"<h3>"+e.name+"</h3>"+"<p>"+e.village+"<br/>"+e.type+"</p>",actions:{}},l=[o];o.actions[r.close]=function(){var e="InfoBox.HideInfoBoxRequest",n=s.getRequestBuilder(e),a=n(i);s.request(t.instance.getName(),a)};var u="InfoBox.ShowInfoBoxRequest",c=s.getRequestBuilder(u),h=c(i,r.title,l,new OpenLayers.LonLat(e.lon,e.lat),!0);s.request(this.instance.getName(),h)},_sortResults:function(e,t){var i=this;this.lastResult&&(this.lastSort={attr:e,descending:t},this.lastResult.locations.sort(function(n,s){return i._searchResultComparator(n,s,e,t)}))},_searchResultComparator:function(e,t,i,n){var s=e[i].toLowerCase(),a=t[i].toLowerCase(),r=0;return(s==a||"name"==i)&&(s=e.id,a=t.id),a>s?r=-1:s>a&&(r=1),n&&(r=-1*r),r}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.search.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.search.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){var e=this,t=e.instance,i=this.container;this.template,t.getSandbox(),i.children(".oskari-tile-status")}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/Tile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/model/LayerGroup.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/view/Layer.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/view/LayersTab.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/view/PublishedLayersTab.js"},{type:"text/css",src:"../../../../resources/framework/bundle/layerselector2/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselector2/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"layerselector2","Bundle-Name":"layerselector2","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("layerselector2","Oskari.mapframework.bundle.layerselector2.LayerSelectorBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null},{__name:"LayerSelector",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e,t,i,n,s,a=this,r=a.conf,o=r?r.sandbox:"sandbox",l=Oskari.getSandbox(o);if(!a.started){a.started=!0,a.sandbox=l,l.register(a);for(s in a.eventHandlers)a.eventHandlers.hasOwnProperty(s)&&l.registerForEventByName(a,s);e=l.getRequestBuilder("userinterface.AddExtensionRequest")(a),l.request(a,e),a.createUi(),t=a.sandbox.getService("Oskari.mapframework.service.MapLayerService"),l.registerAsStateful(a.mediator.bundleId,a),i=function(){},n=function(){alert(a.getLocalization("errors").loadFailed)},t.loadAllLayersAjax(i,n)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!1)},AfterMapLayerAddEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!0)},MapLayerEvent:function(e){var t,i=this,n=i.sandbox.getService("Oskari.mapframework.service.MapLayerService"),s=e.getLayerId();"update"===e.getOperation()?(t=n.findMapLayer(s),i.plugins["Oskari.userinterface.Flyout"].handleLayerModified(t)):"add"===e.getOperation()?(t=n.findMapLayer(s),i.plugins["Oskari.userinterface.Flyout"].handleLayerAdded(t),i.plugins["Oskari.userinterface.Tile"].refresh()):"remove"===e.getOperation()?(i.plugins["Oskari.userinterface.Flyout"].handleLayerRemoved(s),i.plugins["Oskari.userinterface.Tile"].refresh()):"sticky"===e.getOperation()&&(t=n.findMapLayer(s),i.plugins["Oskari.userinterface.Flyout"].handleLayerSticky(t),i.plugins["Oskari.userinterface.Tile"].refresh())}},stop:function(){var e,t,i=this,n=i.sandbox();for(t in i.eventHandlers)i.eventHandlers.hasOwnProperty(t)&&n.unregisterFromEventByName(i,t);e=n.getRequestBuilder("userinterface.RemoveExtensionRequest")(this),n.request(i,e),i.sandbox.unregisterStateful(i.mediator.bundleId),i.sandbox.unregister(i),i.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){var e=this;e.plugins["Oskari.userinterface.Flyout"].createUi(),e.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setContentState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getContentState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.Flyout",function(e){this.instance=e,this.container=null,this.template=null,this.state=null,this.layerTabs=[]},{getName:function(){return"Oskari.mapframework.bundle.layerselector2.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("layerselector2")||jQuery(this.container).addClass("layerselector2")},startPlugin:function(){var e,t=this,i=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.LayersTab",t.instance,t.instance.getLocalization("filter").inspire),n=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.LayersTab",t.instance,t.instance.getLocalization("filter").organization);t.template=jQuery('<div class="allLayersTabContent"></div>'),i.groupingMethod="getInspireName",n.groupingMethod="getOrganizationName",t.layerTabs.push(i),t.layerTabs.push(n),t.instance.conf&&t.instance.conf.showPublishedTab===!0&&(e=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.PublishedLayersTab",t.instance,t.instance.getLocalization("filter").published),this.layerTabs.push(e))},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},setContentState:function(e){var t,i;for(e||(e={}),t=0;t<this.layerTabs.length;t+=1)i=this.layerTabs[t],i.getTitle()===e.tab&&(this.tabContainer.select(i.getTabPanel()),i.setState(e))},getContentState:function(){var e,t,i={};for(e=0;e<this.layerTabs.length;e+=1)if(t=this.layerTabs[e],this.tabContainer.isSelected(t.getTabPanel())){i=t.getState();break}return i},createUi:function(){var e,t,i=this,n=jQuery(this.container);for(n.empty(),i.tabContainer=Oskari.clazz.create("Oskari.userinterface.component.TabContainer"),i.tabContainer.insertTo(n),e=0;e<i.layerTabs.length;e+=1)t=i.layerTabs[e],i.tabContainer.addPanel(t.getTabPanel());i.populateLayers()},populateLayers:function(){var e,t,i,n,s=this.instance.getSandbox(),a=s.getService("Oskari.mapframework.service.MapLayerService"),r=a.getAllLayers();for(e=0;e<this.layerTabs.length;e+=1)t=this.layerTabs[e],t.groupingMethod&&(i=r.slice(0),n=this._getLayerGroups(i,t.groupingMethod),t.showLayerGroups(n))},_getLayerGroups:function(e,t){var i,n,s,a=this,r=[],o=null;for(e.sort(function(e,i){return a._layerListComparator(e,i,t)}),i=0;i<e.length;i+=1)n=e[i],n.getMetaType&&"published"===n.getMetaType()||(s=n[t](),o&&o.getTitle()===s||(o=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",s),r.push(o)),o.addLayer(n));return r},_layerListComparator:function(e,t,i){var n=e[i]().toLowerCase(),s=t[i]().toLowerCase();return n===s&&e.getName()&&t.getName()&&(n=e.getName().toLowerCase(),s=t.getName().toLowerCase()),s>n?-1:n>s?1:0},handleLayerSelectionChanged:function(e,t){var i,n;for(i=0;i<this.layerTabs.length;i+=1)n=this.layerTabs[i],n.setLayerSelected(e.getId(),t)},handleLayerModified:function(e){var t,i,n=this;for(t=0;t<n.layerTabs.length;t+=1)i=n.layerTabs[t],i.updateLayerContent(e.getId(),e)},handleLayerSticky:function(e){var t,i,n=this;for(t=0;t<n.layerTabs.length;t+=1)i=n.layerTabs[t],i.updateLayerContent(e.getId(),e)},handleLayerAdded:function(){var e=this;e.populateLayers()},handleLayerRemoved:function(){var e=this;e.populateLayers()}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.layerselector2.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",function(e){this.name=e,this.layers=[],this.searchIndex={}},{setTitle:function(e){this.name=e},getTitle:function(){return this.name},addLayer:function(e){this.layers.push(e),this.searchIndex[e.getId()]=this._getSearchIndex(e)},getLayers:function(){return this.layers},_getSearchIndex:function(e){var t=e.getName()+" "+e.getInspireName()+" "+e.getOrganizationName();return t.toLowerCase()},matchesKeyword:function(e,t){var i=this.searchIndex[e];return-1!==i.indexOf(t.toLowerCase())}}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.Layer",function(e,t,i){this.sandbox=t,this.localization=i,this.layer=e,this.backendStatus="OK",this.ui=this._createLayerContainer(e)},{__template:'<div class="layer"><input type="checkbox" /> <div class="layer-tools"><div class="layer-backendstatus-icon backendstatus-ok"></div><div class="layer-icon"></div><div class="layer-info"></div></div><div class="layer-title"></div></div>',getId:function(){return this.layer.getId()},setVisible:function(e){1==e?this.ui.show():this.ui.hide()},setSelected:function(e){this.ui.find("input").attr("checked",1==e)},updateLayerContent:function(e){var t=e.getName(),i=this.backendStatus,n=e.getBackendStatus(),s=this.localization.backendStatus,a=i?s.prevBackendStatus:null,r=n?s.currBackendStatus:null,o=a?a.iconClass:null,l=r?r.iconClass:null,u=a?a.tooltip:null,c=r?r.tooltip:null,h=this.ui.find(".layer-backendstatus-icon");this.ui.find(".layer-title").html(t),e.isSticky()&&this.ui.find("input").attr("disabled","disabled"),o&&o!==l&&h.removeClass(o),l&&o!==l&&h.addClass(l),c?u!==c&&h.attr("title",c):u&&h.attr("title",""),this.backendStatus=n},getContainer:function(){return this.ui},_createLayerContainer:function(e){var t,i,n,s,a,r,o,l,u,c,h=this,d=h.sandbox,p=jQuery(this.__template),f=this.localization.tooltip,m=jQuery(p).find("div.layer-tools"),g=m.find("div.layer-icon");
return g.addClass(e.getIconClassname()),e.isBaseLayer()?g.attr("title",f["type-base"]):e.isLayerOfType("WMS")?g.attr("title",f["type-wms"]):e.isLayerOfType("WMTS")?g.attr("title",f["type-wms"]):e.isLayerOfType("WFS")?g.attr("title",f["type-wfs"]):e.isLayerOfType("VECTOR")&&g.attr("title",f["type-wms"]),e.getMetadataIdentifier()&&(m.find("div.layer-info").addClass("icon-info"),m.find("div.layer-info").click(function(){if(t="catalogue.ShowMetadataRequest",i=e.getMetadataIdentifier(),n=[],s={},s[i]=!0,a=e.getSubLayers(),a&&a.length>0)for(r=0;r<a.length;r+=1)o=a[r].getMetadataIdentifier(),o&&""!==o&&!s[o]&&(s[o]=!0,n.push({uuid:o}));d.postRequestByName(t,[{uuid:i},n])})),jQuery(p).attr("layer_id",e.getId()),jQuery(p).find(".layer-title").append(e.getName()),jQuery(p).find("input").change(function(){l=jQuery(this),l.is(":checked")?d.postRequestByName("AddMapLayerRequest",[e.getId(),!1,e.isBaseLayer()]):d.postRequestByName("RemoveMapLayerRequest",[e.getId()])}),e.isSticky()&&jQuery(p).find("input").attr("disabled","disabled"),u=m.find(".layer-backendstatus-icon"),u.click(function(){c=e.getId(),d.postRequestByName("ShowMapLayerInfoRequest",[c])}),p}},{protocol:["Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.LayersTab",function(e,t){this.instance=e,this.title=t,this.showSearchSuggestions=e.conf&&e.conf.showSearchSuggestions===!0,this.layerGroups=[],this.layerContainers={},this.templates={spinner:'<span class="spinner-text"></span>',shortDescription:'<div class="field-description"></div>',description:'<div><h4 class="indicator-msg-popup"></h4><p></p></div>',relatedKeywords:'<div class="related-keywords"></div>',keywordsTitle:'<div class="keywords-title"></div>',keywordContainer:'<a href="#"class="keyword-cont"><span class="keyword"></span></a>',keywordType:'<div class="type"></div>'},this._createUI()},{getTitle:function(){return this.title},getTabPanel:function(){return this.tabPanel},getState:function(){var e={tab:this.getTitle(),filter:this.filterField.getValue(),groups:[]};return e},setState:function(e){e&&(e.filter||(this.filterField.setValue(e.filter),this.filterLayers(e.filter)))},_createInfoIcon:function(e){var t=this,i=jQuery('<div class="icon-info"></div>'),n=e.find(".field-description");n.find(".icon-info").remove(),n.append(i),i.click(function(){var e=jQuery(t.templates.description),i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=Oskari.clazz.create("Oskari.userinterface.component.Button");e.find("p").text(t._locale.filter.description),n.setTitle(t._locale.buttons.ok),n.addClass("primary"),n.setHandler(function(){i.close(!0)}),i.show(t._locale.filter.text,e,[n])})},_createUI:function(){var e,t=this;t._locale=t.instance._localization,t.tabPanel=Oskari.clazz.create("Oskari.userinterface.component.TabPanel"),t.tabPanel.setTitle(t.title),e=t.getFilterField().getField(),t.showSearchSuggestions&&(e.append(jQuery(t.templates.spinner).text(t._locale.loading)),e.append(jQuery(t.templates.relatedKeywords))),e.append(jQuery(t.templates.shortDescription).text(t._locale.filter.shortDescription)),t._createInfoIcon(e),t.tabPanel.getContainer().append(e),e.find(".spinner-text").hide(),t.accordion=Oskari.clazz.create("Oskari.userinterface.component.Accordion"),t.accordion.insertTo(t.tabPanel.getContainer())},getFilterField:function(){var e,t=this,i=0;return t.filterField?t.filterField:(e=Oskari.clazz.create("Oskari.userinterface.component.FormInput"),e.setPlaceholder(t.instance.getLocalization("filter").text),e.addClearButton(),e.bindChange(function(n){n.stopPropagation();var s=n;i&&clearTimeout(i),i=setTimeout(function(){t._fireFiltering(e.getValue(),s,t),i=null},300)},!0),t.filterField=e,e)},_fireFiltering:function(e,t,i){i.filterLayers(e),i.showSearchSuggestions&&(i.clearRelatedKeywordsPopup(e,jQuery(t.currentTarget).parents(".oskarifield")),i._relatedKeywordsPopup(e,t,i))},showLayerGroups:function(e){var t,i,n,s,a,r,o,l,u,c,h=this;for(h.accordion.removeAllPanels(),h.layerContainers=void 0,h.layerContainers={},h.layerGroups=e,t=0;t<e.length;t+=1){for(i=e[t],n=i.getLayers(),s=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel"),s.setTitle(i.getTitle()+" ("+n.length+")"),i.layerListPanel=s,a=s.getContainer(),r=0;r<n.length;r+=1)o=n[r],l=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.Layer",o,h.instance.sandbox,h.instance.getLocalization()),u=l.getContainer(),a.append(u),h.layerContainers[o.getId()]=l;h.accordion.addPanel(s)}for(c=h.instance.sandbox.findAllSelectedMapLayers(),t=0;t<c.length;t+=1)h.setLayerSelected(c[t].getId(),!0);h.filterLayers(h.filterField.getValue())},filterLayers:function(e,t){var i,n,s,a,r,o,l,u,c,h,d=this,p=0;if(t||d.sentKeyword!==e||(t=d.ontologyLayers),d.accordion.showPanels(),!e||0===e.length)return d._showAllLayers(),void 0;for(n=0;n<d.layerGroups.length;n+=1){for(a=d.layerGroups[n],o=a.getLayers(),i=0,s=0;s<o.length;s+=1)r=o[s],l=r.getId(),u=d.layerContainers[l],c=a.matchesKeyword(l,e)||d.showSearchSuggestions&&t&&d._arrayContains(t,l),u.setVisible(c),c&&(i+=1,1===i%2?u.getContainer().addClass("odd"):u.getContainer().removeClass("odd"),a.layerListPanel.open());a.layerListPanel.setVisible(i>0),a.layerListPanel.isVisible()&&(p+=1),a.layerListPanel.setTitle(a.getTitle()+" ("+i+"/"+o.length+")")}0===p?(h=d.instance.getLocalization("errors"),d.accordion.showMessage(h.noResults)):d.accordion.removeMessage()},clearRelatedKeywordsPopup:function(e,t){this.sentKeyword&&this.sentKeyword!==e&&t.find(".related-keywords").html("").hide()},_relatedKeywordsPopup:function(e,t,i){var n,s,a=jQuery(t.currentTarget).parents(".oskarifield");return e&&0!==e.length?e.length<4?(a.find(".related-keywords").hide(),void 0):(n=a.find(".spinner-text").show(),i.sentKeyword=e,s=this.instance.sandbox.getAjaxUrl(),jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:s+"action_route=SearchKeywords&keyword="+encodeURIComponent(e)+"&lang="+Oskari.getLang(),success:function(t){i.relatedKeywords=t,i._showRelatedKeywords(e,t,a),n.hide()},error:function(){var e=i.instance.getLocalization("errors");i.accordion.showMessage(e.generic),n.hide()}}),void 0):(this._showAllLayers(),void 0)},_arrayContains:function(e,t){var i;if(e.indexOf)return e.indexOf(t)>-1;for(i=0;i<e.length;i+=1)if(e[i]===t)return!0;return!1},_concatNew:function(e,t){var i,n=this;for(i=t.length-1;i>=0;i-=1)n._arrayContains(e,t[i])||e.push(t[i])},_isDefined:function(e){return"undefined"!=typeof e&&null!==e&&""!==e},_containsIgnoreCase:function(e,t){var i=this;return i._isDefined(e)&&i._isDefined(t)&&e.toLowerCase().indexOf(t.toLowerCase())>-1},_matchesIgnoreCase:function(e,t){var i=this;return i._isDefined(e)&&i._isDefined(t)&&e.toLowerCase()===t.toLowerCase()},_showRelatedKeywords:function(e,t,i){var n,s,a,r=this,o=r.getFilterField().getField().find(".related-keywords"),l=[],u=[];for(r.clearRelatedKeywordsPopup(null,i),n=0;n<t.length;n+=1)s=t[n],s.layers.length>0&&(r._matchesIgnoreCase(s.type,"syn")||!r._isDefined(s.type)&&r._containsIgnoreCase(s.keyword,e)?0===u.size?u.concat(s.layers):r._concatNew(u,s.layers):l.push({idx:n,count:s.layers.length}));for(l.length>0&&o.prepend(jQuery(r.templates.keywordsTitle).text(r._locale.filter.didYouMean)),l.sort(function(e,t){return e.count<t.count}),n=0;n<l.length&&3>n;n+=1)s=t[l[n].idx],a=jQuery(r.templates.keywordContainer),a.attr("data-id",s.id).attr("data-keyword",s.keyword).find(".keyword").text(s.keyword.toLowerCase()+" ("+s.layers.length+")"),o.append(a);l.length&&o.show(),r.ontologyLayers=u,r.filterLayers(e,u),o.find(".keyword-cont").on("click",function(e){var t=jQuery(e.currentTarget).attr("data-keyword");r.getFilterField().setValue(t),r._fireFiltering(t,e,r)})},_showAllLayers:function(){var e,t,i,n,s,a,r;for(e=0;e<this.layerGroups.length;e+=1){for(t=this.layerGroups[e],i=t.getLayers(),n=0;n<i.length;n+=1)s=i[n],a=s.getId(),r=this.layerContainers[a],r.setVisible(!0),1===n%2?r.getContainer().addClass("odd"):r.getContainer().removeClass("odd");t.layerListPanel.setVisible(!0),t.layerListPanel.close(),t.layerListPanel.setTitle(t.getTitle()+" ("+i.length+")")}},setLayerSelected:function(e,t){var i=this.layerContainers[e];i&&i.setSelected(t)},updateLayerContent:function(e,t){var i=this.layerContainers[e];i&&i.updateLayerContent(t)}}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.PublishedLayersTab",function(e,t){this.instance=e,this.title=t,this.layerGroups=[],this.layerContainers={},this._createUI()},{getTitle:function(){return this.title},getTabPanel:function(){return this.tabPanel},getState:function(){var e={tab:this.getTitle(),filter:this.filterField.getValue(),groups:[]};return e},setState:function(e){e&&(e.filter||(this.filterField.setValue(e.filter),this.filterLayers(e.filter)))},_createUI:function(){var e=this;e.tabPanel=Oskari.clazz.create("Oskari.userinterface.component.TabPanel"),e.tabPanel.setTitle(this.title),e.tabPanel.setSelectionHandler(function(t){t?e.tabSelected():e.tabUnselected()}),e.tabPanel.getContainer().append(this.getFilterField().getField()),e.accordion=Oskari.clazz.create("Oskari.userinterface.component.Accordion"),e.accordion.insertTo(this.tabPanel.getContainer())},getFilterField:function(){if(this.filterField)return this.filterField;var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.FormInput");return t.setPlaceholder(e.instance.getLocalization("filter").text),t.addClearButton(),t.bindChange(function(){e._searchTrigger(t.getValue())},!0),t.bindEnterKey(function(){e._relatedSearchTrigger(t.getValue())}),this.filterField=t,t},_searchTrigger:function(e){var t=this;t.searchTimer&&clearTimeout(t.searchTimer),e&&0!==e.length?t.searchTimer=setTimeout(function(){t._search(e),t.searchTimer=void 0},500):t._search(e)},_relatedSearchTrigger:function(){var e=this;e.searchTimer&&clearTimeout(e.searchTimer)},tabSelected:function(){if(0===this.layerGroups.length){this.accordion.showMessage(this.instance.getLocalization("loading"));var e=this,t=this.instance.sandbox.getAjaxUrl();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:t+"action_route=GetPublishedMyPlaceLayers",success:function(t){e._populateLayerGroups(t),e.showLayerGroups(e.layerGroups)},error:function(){var t=e.instance.getLocalization("errors");e.accordion.showMessage(t.generic)}})}},tabUnselected:function(){},_populateLayerGroups:function(e){var t,i,n,s,a,r=this,o=r.instance.getSandbox(),l=o.getService("Oskari.mapframework.service.MapLayerService"),u=o.getUser().getUuid(),c=null;for(this.layerGroups=[],t=0;t<e.length;t+=1)for(i=e[t],c&&c.getTitle()===i.name||(c=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",i.name),this.layerGroups.push(c)),n=0;n<i.layers.length;n+=1)s=i.layers[n],a=this._getPublishedLayer(s,l,u===i.id),a.setDescription(i.name),c.addLayer(a)},_getPublishedLayer:function(e,t,i){var n,s=this._getMapLayerJsonBase();if(s.wmsUrl="/karttatiili/myplaces?myCat="+e.id+"&",s.name=e.name,s.id="myplaces_"+e.id,s.permissions=i?{publish:"publication_permission_ok"}:{publish:"no_publication_permission"},n=t.createMapLayer(s),!i)try{t.addLayer(n)}catch(a){}return n},_getMapLayerJsonBase:function(){var e=this.instance.getLocalization("published"),t={wmsName:"ows:my_places_categories",type:"wmslayer",isQueryable:!0,opacity:50,metaType:"published",orgName:e.organization,inspire:e.inspire};return t},showLayerGroups:function(e){var t,i,n,s,a,r,o,l,u,c,h,d=this;for(d.accordion.removeAllPanels(),d.layerContainers=void 0,d.layerContainers={},d.layerGroups=e,t=0;t<e.length;t+=1){for(i=e[t],n=i.getLayers(),a=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel"),a.setTitle(i.getTitle()+" ("+n.length+")"),i.layerListPanel=a,s=a.getContainer(),r=0;r<n.length;r+=1)o=n[r],l=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.Layer",o,d.instance.sandbox,d.instance.getLocalization()),u=l.getContainer(),s.append(u),d.layerContainers[o.getId()]=l;d.accordion.addPanel(a)}if(0===d.layerGroups.length)c=d.instance.getLocalization("errors"),d.accordion.showMessage(c.noResults);else for(h=d.instance.sandbox.findAllSelectedMapLayers(),t=0;t<h.length;t+=1)d.setLayerSelected(h[t].getId(),!0)},_search:function(e){var t=this;return e&&0!==e.length?(t.showLayerGroups([]),t.accordion.showMessage(this.instance.getLocalization("loading")),jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},data:{searchKey:e},url:ajaxUrl+"action_route=FreeFindFromMyPlaceLayers",success:function(e){t._populateLayerGroups(e),t.showLayerGroups(t.layerGroups)},error:function(){var e=t.instance.getLocalization("errors");t.accordion.showMessage(e.generic)}}),void 0):(t.updateLayerContent(),void 0)},setLayerSelected:function(e,t){var i=this.layerContainers[e];i&&i.setSelected(t)},updateLayerContent:function(){this.showLayerGroups([]),this.tabSelected()}}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.LayerSelectionBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.layerselection2.LayerSelectionBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/Tile.js"},{type:"text/css",src:"../../../../resources/framework/bundle/layerselection2/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/layerselection2/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"layerselection2","Bundle-Name":"layerselection2","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("layerselection2","Oskari.mapframework.bundle.layerselection2.LayerSelectionBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.LayerSelectionBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null},{__name:"LayerSelection",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,this.localization=Oskari.getLocalization(this.getName()),n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);var s=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,s),e.createUi()}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(e){this.plugins["Oskari.userinterface.Tile"].refresh(),this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!1)},AfterMapLayerAddEvent:function(e){this.plugins["Oskari.userinterface.Tile"].refresh(),this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!0,e.getKeepLayersOrder())},MapLayerEvent:function(e){var t=this.sandbox.getService("Oskari.mapframework.service.MapLayerService"),i=e.getLayerId();if("update"===e.getOperation()){var n=t.findMapLayer(i);this.plugins["Oskari.userinterface.Flyout"].handleLayerModified(n)}else if("sticky"===e.getOperation()){var n=t.findMapLayer(i);this.plugins["Oskari.userinterface.Flyout"].handleLayerSticky(n)}},MapLayerVisibilityChangedEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerVisibilityChanged(e.getMapLayer(),e.isInScale(),e.isGeometryMatch())},AfterChangeMapLayerOpacityEvent:function(e){e._creator!=this.getName()&&this.plugins["Oskari.userinterface.Flyout"].handleLayerOpacityChanged(e.getMapLayer())},AfterChangeMapLayerStyleEvent:function(e){e._creator!=this.getName()&&this.plugins["Oskari.userinterface.Flyout"].handleLayerStyleChanged(e.getMapLayer())},"userinterface.ExtensionUpdatedEvent":function(e){var t=this;e.getExtension().getName()==t.getName()&&"close"!=e.getViewState()}},stop:function(){var e=this.sandbox;for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselection2.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselection2.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.templateLayer=null,this.templateLayerTools=null,this.templateLayerOutOfScale=null,this.templateLayerOutOfContentArea=null,this.sortableBinded=!1,this._sliders={}},{getName:function(){return"Oskari.mapframework.bundle.layerselection2.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("layerselection2")||jQuery(this.container).addClass("layerselection2")},startPlugin:function(){var e=this.instance.getLocalization("layer");this.template=jQuery('<ul class="selectedLayersList sortable" data-sortable=\'{itemCss: "li.layer.selected", handleCss: "div.layer-title" }\'></ul>'),this.templateLayer=jQuery('<li class="layer selected"><div class="layer-info"><div class="layer-icon"></div><div class="layer-tool-remove"></div><div class="layer-title"><h4></h4></div></div><div class="stylesel"><label for="style">'+e.style+"</label>"+'<select name="style"></select></div>'+'<div class="layer-tools volatile">'+"</div>"+"</li>"),this.templateLayerFooterTools=jQuery('<div class="left-tools"><div class="layer-visibility"><a href="JavaScript:void(0);">'+e.hide+"</a>"+"&nbsp;"+'<span class="temphidden" '+'style="display: none;">'+e.hidden+"</span>"+"</div>"+'<div class="oskariui layer-opacity">'+'<div class="layout-slider" id="layout-slider">'+"</div> "+'<div class="opacity-slider" style="display:inline-block">'+'<input type="text" name="opacity-slider" class="opacity-slider opacity" id="opacity-slider" />%</div>'+"</div>"+"</div>"+'<div class="right-tools">'+'<div class="layer-rights"></div>'+'<div class="object-data"></div>'+'<div class="layer-description">'+'<div class="icon-info"></div>'+"</div></div>"),this.templateLayerFooterHidden=jQuery('<p class="layer-msg"><a href="JavaScript:void(0);">'+e.show+"</a> "+e.hidden+"</p>"),this.templateLayerFooterOutOfScale=jQuery('<p class="layer-msg">'+e["out-of-scale"]+' <a href="JavaScript:void(0);">'+e["move-to-scale"]+"</a></p>"),this.templateLayerFooterOutOfContentArea=jQuery('<p class="layer-msg">'+e["out-of-content-area"]+' <a href="JavaScript:void(0);">'+e["move-to-content-area"]+"</a></p>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},createUi:function(){var e=this,t=jQuery(this.container);t.empty();var i=this.template.clone();t.append(i);for(var n=e.instance.getSandbox(),s=n.findAllSelectedMapLayers(),a=n.getMap().getScale(),r=s.length-1;r>=0;--r){var o=s[r],l=this._createLayerContainer(o);i.append(l),this._appendLayerFooter(l,o,o.isInScale(a),!0)}i.sortable({stop:function(t,i){var n=i.item;e._layerOrderChanged(n)}}),this.sortableBinded||(this.sortableBinded=!0)},_appendLayerFooter:function(e,t,i,n){var s=e.find("div.layer-tools"),a=this._createLayerFooter(t,e);if(t.isVisible())if(i)if(n)a.css("display","");else{var r=this._createLayerFooterOutOfContentArea(t);s.addClass("out-of-content"),a.css("display","none"),s.append(r)}else{var o=this._createLayerFooterOutOfScale(t);s.addClass("out-of-scale"),a.css("display","none"),s.append(o)}else s.addClass("hidden-layer"),a.css("display","none"),s.append(this._createLayerFooterHidden(t));s.append(a),this._addSlider(t,e);var l=e.find("div.layer-opacity input.opacity");l.attr("value",t.getOpacity())},_addSlider:function(e,t){var i=this,n=e.getId(),s=e.getOpacity(),a=t.find(".layout-slider"),r=a.slider({min:0,max:100,value:s,slide:function(t,n){i._layerOpacityChanged(e,n.value)},stop:function(t,n){i._layerOpacityChanged(e,n.value)}});return i._sliders[n]=r,r},_layerOrderChanged:function(e){var t=jQuery(this.container).find(".selectedLayersList li"),i=e.attr("layer_id"),n=-1;if(t.each(function(e){return $(this).attr("layer_id")==i?(n=e,!1):!0}),n>-1){n=t.length-1-n;var s=this.instance.getSandbox(),a="RearrangeSelectedMapLayerRequest",r=s.getRequestBuilder(a),o=r(i,n);s.request(this.instance.getName(),o)}},_createLayerContainer:function(e){var t=this,i=t.instance.getSandbox(),n="ChangeMapLayerOpacityRequest";i.getRequestBuilder(n);var s=e.getId();e.getOpacity();var a=this.templateLayer.clone();a.attr("layer_id",s),a.find("div.layer-title h4").append(e.getName()),a.find("div.layer-title").append(e.getDescription());var r=a.find("div.stylesel");if(r.hide(),e.getStyles&&e.getStyles().length>1){for(var o=!1,l=e.getStyles(),u=r.find("select"),c=0;c<l.length;c++)if(l[c].getName()){var h=jQuery('<option value="'+l[c].getName()+'">'+l[c].getTitle()+"</option>");u.append(h),o=!0}u.change(function(){var n=u.find("option:selected").val();e.selectStyle(n);var s="ChangeMapLayerStyleRequest",a=i.getRequestBuilder(s),r=a(e.getId(),n);i.request(t.instance.getName(),r)}),o&&(e.getCurrentStyle()&&u.val(e.getCurrentStyle().getName()),r.show())}var d=this.instance.getLocalization("layer").tooltip,p=a.find("div.layer-icon");return p.addClass(e.getIconClassname()),e.isBaseLayer()?p.attr("title",d["type-base"]):e.isLayerOfType("WMS")?p.attr("title",d["type-wms"]):e.isLayerOfType("WMTS")?p.attr("title",d["type-wms"]):e.isLayerOfType("WFS")?p.attr("title",d["type-wfs"]):e.isLayerOfType("VECTOR")&&p.attr("title",d["type-wms"]),e.isSticky()||(a.find("div.layer-tool-remove").addClass("icon-close"),a.find("div.layer-tool-remove").bind("click",function(){var n="RemoveMapLayerRequest",s=i.getRequestBuilder(n),a=s(e.getId());i.request(t.instance.getName(),a)})),a},handleLayerVisibilityChanged:function(e,t,i){var n=this;n.instance.getSandbox();var s="li.layer.selected[layer_id="+e.getId()+"]",a=jQuery(this.container).find(s);this.instance.getLocalization("layer");var r=a.find("div.layer-tools");r.empty(),a.removeClass("hidden-layer"),a.removeClass("out-of-scale"),a.removeClass("out-of-content"),this._sliders[e.getId()]=null,this._appendLayerFooter(a,e,t,i)},_layerOpacityChanged:function(e,t){var i=this.instance.getSandbox(),n="ChangeMapLayerOpacityRequest",s=i.getRequestBuilder(n),a=s(e.getId(),t);i.request(this.instance.getName(),a);var r="li.layer.selected[layer_id="+e.getId()+"]",o=jQuery(this.container).find(r),l=o.find("div.layer-opacity input.opacity");l.attr("value",e.getOpacity())},handleLayerOpacityChanged:function(e){this._sliders[e.getId()]&&this._sliders[e.getId()].slider("value",e.getOpacity())},handleLayerStyleChanged:function(e){var t="li.layer.selected[layer_id="+e.getId()+"]",i=jQuery(this.container).find(t),n=i.find("div.stylesel select");n.val(e.getCurrentStyle().getName())},_createLayerFooterOutOfScale:function(e){var t=this,i=t.instance.getSandbox(),n=this.templateLayerFooterOutOfScale.clone();n.addClass("layer-msg-for-outofscale");var s="MapModulePlugin.MapMoveByLayerContentRequest",a=i.getRequestBuilder(s);return n.find("a").bind("click",function(){var n=a(e.getId());return i.request(t.instance.getName(),n),!1}),n},_createLayerFooterHidden:function(e){var t=this,i=t.instance.getSandbox(),n=this.templateLayerFooterHidden.clone();n.addClass("layer-msg-for-hidden");var s="MapModulePlugin.MapLayerVisibilityRequest",a=i.getRequestBuilder(s);return n.find("a").bind("click",function(){var n=a(e.getId(),!0);return i.request(t.instance.getName(),n),!1}),n},_createLayerFooterOutOfContentArea:function(e){var t=this,i=t.instance.getSandbox(),n=this.templateLayerFooterOutOfContentArea.clone();n.addClass("layer-msg-for-outofcontentarea");var s="MapModulePlugin.MapMoveByLayerContentRequest",a=i.getRequestBuilder(s);return n.find("a").bind("click",function(){var n=a(e.getId());return i.request(t.instance.getName(),n),!1}),n},_createLayerFooter:function(e){var t=this,i=t.instance.getSandbox(),n=this.templateLayerFooterTools.clone();this.instance.getLocalization("layer");var s="MapModulePlugin.MapLayerVisibilityRequest",a=i.getRequestBuilder(s);n.find("div.layer-visibility a").bind("click",function(){var n=a(e.getId(),!1);return i.request(t.instance.getName(),n),!1}),e.getMetadataIdentifier()?n.find("div.icon-info").bind("click",function(){var t="catalogue.ShowMetadataRequest",n=e.getMetadataIdentifier(),s=[],a={};a[n]=!0;var r=e.getSubLayers();if(r&&r.length>0)for(var o=0;o<r.length;o++){var l=r[o].getMetadataIdentifier();l&&""!=l&&!a[l]&&(a[l]=!0,s.push({uuid:l}))}i.postRequestByName(t,[{uuid:n},s])}):n.find("div.layer-description").hide();for(var r=function(e){return function(){return e.getCallback()(),!1}},o=e.getTools(),l=0;l<o.length;l++){var u=o[l];if(u)if(u.getIconCls()){var c=jQuery("<div></div>");c.addClass(u.getIconCls()),c.attr("title",u.getTooltip()),n.find("div.object-data").append(c),c.bind("click",r(u))}else{var c=jQuery('<a href="JavaScript:void(0);"></a>');c.append(u.getTitle()),n.find("div.object-data").append(c),c.bind("click",r(u))}}return this._updatePublishPermissionText(e,n),n},_updatePublishPermissionText:function(e,t){var i=this.instance.getSandbox(),n=this.instance.getLocalization("layer"),s=e.getPermission("publish");"publication_permission_ok"==s&&i.getUser().isLoggedIn()&&(t.find("div.layer-rights").html(n.rights.can_be_published_map_user.label),t.find("div.layer-rights").attr("title",n.rights.can_be_published_map_user.tooltip))},handleLayerSelectionChanged:function(e,t,i){if(1==t){var n=this,s=n.instance.getSandbox(),a=s.getMap().getScale(),r=jQuery("ul.selectedLayersList"),o=this._createLayerContainer(e);o.find("div.layer-tools");var l=[];l=e.isBaseLayer()&&1!=i?r.find("li[layer_id^=base_]"):r.find(".layer.selected"),l.length>0?e.isBaseLayer()&&1!=i?l.last().after(o):l.first().before(o):r.append(o),this._appendLayerFooter(o,e,e.isInScale(a),!0)}else{var u=jQuery(this.container).find("li[layer_id="+e.getId()+"]");u&&(this._sliders[e.getId()]=null,u.remove())}},handleLayerModified:function(e){var t=jQuery(this.container).find("li[layer_id="+e.getId()+"]");jQuery(t).find(".layer-title h4").html(e.getName());var i=t.find("div.layer-tools");this._updatePublishPermissionText(e,i)},handleLayerSticky:function(e){var t=jQuery(this.container).find("li[layer_id="+e.getId()+"]");t.find("div.layer-tool-remove").removeClass("icon-close")},refresh:function(){for(var e=this,t=e.instance.getSandbox(),i=t.findAllSelectedMapLayers(),n=i.length-1;n>=0;--n){var s=i[n];this.handleLayerOpacityChanged(s)}}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.Tile",function(e){this.instance=e,this.container=null,this.template=null,this.shownLayerCount=null},{getName:function(){return"Oskari.mapframework.bundle.layerselection2.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},notifyUser:function(){var e=this.container.children(".oskari-tile-status");e.stop(),this._blink(e,2)},_blink:function(e,t){var i=this;e&&(t||(t=1),e.animate({opacity:.25},500,function(){e.animate({opacity:1},500,function(){t>1&&i._blink(e,--t)})}))},refresh:function(){var e=this,t=e.instance;this.container,this.template;var i=t.getSandbox(),n=i.findAllSelectedMapLayers(),s=n.length,a=this.container.children(".oskari-tile-status");a.addClass("icon-bubble-right"),a.html(s),this.notifyUser()}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.PersonalDataBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.PersonalDataBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/Tile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/MyPlacesTab.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/MyViewsTab.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/service/ViewService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/PublishedMapsTab.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/AccountTab.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/request/AddTabRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/request/AddTabRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/personaldata/css/personaldata.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/personaldata/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"personaldata","Bundle-Name":"personaldata","Bundle-Author":[{Name:"ejv",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("personaldata","Oskari.mapframework.bundle.personaldata.PersonalDataBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.PersonalDataBundleInstance",function(){this.core=null,this.sandbox=null,this.started=!1,this.template=null,this.plugins={},this.viewService=null
},{__name:"PersonalData",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getViewService:function(){return this.viewService},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,this.viewService=Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.service.ViewService",n.getAjaxUrl()),n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);var s=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,s),e.createUi(),this.requestHandlers={addTabRequestHandler:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.request.AddTabRequestHandler",n,this.plugins["Oskari.userinterface.Flyout"])},n.addRequestHandler("PersonalData.AddTabRequest",this.requestHandlers.addTabRequestHandler)}},init:function(){return window.personaldataTest=this,null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.removeRequestHandler("PersonalData.AddTabRequest",this.requestHandlers.addTabRequestHandler);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.templateTabHeader=null,this.templateTabContent=null,this.tabsData=[]},{getName:function(){return"Oskari.mapframework.bundle.personaldata.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("personaldata")||jQuery(this.container).addClass("personaldata")},startPlugin:function(){var e=this,t=e.instance.getLocalization("tabs");this.tabsData={myPlaces:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.MyPlacesTab",e.instance,t.myplaces),myViews:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.MyViewsTab",e.instance,t.myviews),publishedMaps:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.PublishedMapsTab",e.instance,t.publishedmaps),account:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.AccountTab",e.instance,t.account)}},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},createUi:function(){var e,t,i,n=this,s=n.instance.getSandbox(),a=jQuery(this.container);if(a.empty(),this.tabsContainer=Oskari.clazz.create("Oskari.userinterface.component.TabContainer",this.instance.getLocalization("notLoggedIn")),this.tabsContainer.insertTo(a),s.getUser().isLoggedIn())for(e in this.tabsData)this.tabsData.hasOwnProperty(e)&&(t=this.tabsData[e],i=Oskari.clazz.create("Oskari.userinterface.component.TabPanel"),i.setTitle(t.getTitle()),t.addTabContent(i.getContainer()),t.bindEvents&&t.bindEvents(),this.tabsContainer.addPanel(i))},addTab:function(e){var t,i=this.instance.getSandbox();i.getUser().isLoggedIn()&&(t=Oskari.clazz.create("Oskari.userinterface.component.TabPanel"),t.setTitle(e.title),t.setContent(e.content),this.tabsContainer.addPanel(t,e.first))}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.personaldata.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.MyPlacesTab",function(e,t){this.instance=e,this.loc=t,this.tabsContainer=void 0,this.tabPanels={},this.linkTemplate=jQuery('<a href="JavaScript:void(0);"></a>'),this.iconTemplate=jQuery('<div class="icon"></div>')},{getName:function(){return"PersonalData.MyPlaces"},getTitle:function(){return this.loc.title},addTabContent:function(e){this.tabsContainer=Oskari.clazz.create("Oskari.userinterface.component.TabDropdownContainer",this.loc.nocategories),this.tabsContainer.insertTo(e)},eventHandlers:{"MyPlaces.MyPlacesChangedEvent":function(){var e=this.instance.sandbox.getService("Oskari.mapframework.bundle.myplaces2.service.MyPlacesService"),t=e.getAllCategories();e.getAllMyPlaces();for(var i=this,n=function(e){return function(){var t=i.instance.sandbox.getRequestBuilder("MyPlaces.EditCategoryRequest")(e);return i.instance.sandbox.request(i.instance,t),!1}},s=function(e){return function(){var t=i.instance.sandbox.getRequestBuilder("MyPlaces.DeleteCategoryRequest")(e);return i.instance.sandbox.request(i.instance,t),!1}},a=0;a<t.length;++a){var r=t[a].getId(),o=this.tabPanels[r];o?(o.setTitle(t[a].name),i.tabsContainer.updatePanel(o)):(o=this._createCategoryTab(t[a]),this.tabsContainer.addPanel(o),this.tabPanels[r]=o),this._populatePlaces(r),o.getContainer().empty(),o.grid.renderTo(o.getContainer());var l=this.linkTemplate.clone();l.addClass("categoryOp"),l.append(this.loc.editCategory),l.bind("click",n(r)),o.getContainer().append(l);var u=this.linkTemplate.clone();u.addClass("categoryOp"),u.append(this.loc.deleteCategory),u.bind("click",s(r)),o.getContainer().append(u)}this._removeObsoleteCategories()}},_showPlace:function(e,t){var i=e.getCentroid(),n=this.instance.sandbox.getRequestBuilder("MapMoveRequest")(i.x,i.y,e.getBounds(),!1);this.instance.sandbox.request(this.instance,n);var s="myplaces_"+t,a=this.instance.sandbox.findMapLayerFromSelectedMapLayers(s);if(!a){var r=this.instance.sandbox.getRequestBuilder("AddMapLayerRequest")(s,!0);this.instance.sandbox.request(this.instance,r)}},_editPlace:function(e){this._showPlace(e.geometry,e.categoryId);var t=this.instance.sandbox.getRequestBuilder("MyPlaces.EditPlaceRequest")(e.id);this.instance.sandbox.request(this.instance,t)},_deletePlace:function(e){var t=this,i=this.instance.sandbox,n=this.loc.notification["delete"],s=Oskari.clazz.create("Oskari.userinterface.component.Popup"),a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(n.btnDelete),a.addClass("primary"),a.setHandler(function(){s.close();var a=i.getService("Oskari.mapframework.bundle.myplaces2.service.MyPlacesService"),r=function(a){var r=e.categoryId,o="myplaces_"+r,l=i.findMapLayerFromSelectedMapLayers(o);if(l){var u=i.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest"),c=u(o,!0);i.request(t.instance,c)}a?s.show(n.title,n.success):s.show(n.title,n.error),s.fadeout()};a.deleteMyPlace(e.id,r)});var r=s.createCloseButton(n.btnCancel),o=n.confirm+'"'+e.name+'"'+"?";s.show(n.title,o,[r,a]),s.makeModal()},_getDrawModeFromGeometry:function(e){if(null===e)return null;var t=e.CLASS_NAME;return"OpenLayers.Geometry.MultiPoint"===t||"OpenLayers.Geometry.Point"===t?"point":"OpenLayers.Geometry.MultiLineString"===t||"OpenLayers.Geometry.LineString"===t?"line":"OpenLayers.Geometry.MultiPolygon"===t||"OpenLayers.Geometry.Polygon"===t?"area":null},_createCategoryTab:function(e){var t=this,i=e.getId(),n=Oskari.clazz.create("Oskari.userinterface.component.TabPanel");n.setId(i),n.setTitle(e.getName()),n.grid=Oskari.clazz.create("Oskari.userinterface.component.Grid");var s=["name","desc","createDate","updateDate","edit","delete"];n.grid.setVisibleFields(s);var a=function(e,i){var n=t.linkTemplate.clone(),s=t.iconTemplate.clone(),a=t._getDrawModeFromGeometry(i.geometry);return s.addClass("myplaces-"+a),n.append(s),n.append(e),n.bind("click",function(){return t._showPlace(i.geometry,i.categoryId),!1}),n};n.grid.setColumnValueRenderer("name",a);var r=function(e,i){var n=t.linkTemplate.clone();return n.append(e),n.bind("click",function(){return t._editPlace(i),!1}),n};n.grid.setColumnValueRenderer("edit",r);var o=function(e,i){var n=t.linkTemplate.clone();return n.append(e),n.bind("click",function(){return t._deletePlace(i),!1}),n};n.grid.setColumnValueRenderer("delete",o);for(var l=0;l<s.length;++l){var u=s[l];n.grid.setColumnUIName(u,this.loc.grid[u])}return n},_populatePlaces:function(e){var t=this.instance.sandbox.getService("Oskari.mapframework.bundle.myplaces2.service.MyPlacesService"),i=t.getAllMyPlaces(),n=this.tabPanels[e],s=Oskari.clazz.create("Oskari.userinterface.component.GridModel");s.setIdField("id"),n.grid.setDataModel(s);for(var a=0;a<i.length;++a)i[a].getCategoryID()==e&&s.addData({id:i[a].getId(),name:i[a].getName(),desc:i[a].getDescription(),geometry:i[a].getGeometry(),categoryId:i[a].getCategoryID(),edit:this.loc.edit,"delete":this.loc["delete"],createDate:this._formatDate(t,i[a].getCreateDate()),updateDate:this._formatDate(t,i[a].getUpdateDate())})},_formatDate:function(e,t){var i=e.parseDate(t),n="";return i.length>0&&(n=i[0]),n},_removeObsoleteCategories:function(){var e=this.instance.sandbox.getService("Oskari.mapframework.bundle.myplaces2.service.MyPlacesService");for(var t in this.tabPanels){var i=e.findCategory(t);i||(this.tabsContainer.removePanel(this.tabPanels[t]),this.tabPanels[t].grid=void 0,delete this.tabPanels[t].grid,this.tabPanels[t]=void 0,delete this.tabPanels[t])}},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},bindEvents:function(){var e=this.instance,t=e.getSandbox();for(p in this.eventHandlers)t.registerForEventByName(this,p)},unbindEvents:function(){var e=this.instance,t=e.getSandbox();for(p in this.eventHandlers)t.unregisterFromEventByName(this,p)}}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.MyViewsTab",function(e,t){this.instance=e,this.loc=t,this.template=jQuery('<div class="viewsList volatile"></div>'),this.templateLink=jQuery('<a href="JavaScript:void(0);"></a>'),this.templateDesc=jQuery('<div class="oskarifield"><label for="description"></label><textarea id="view_description" name="description" placeholder="'+this.loc.popup.description_placeholder+'"></textarea></div>'),this.container=null;var i=e.sandbox,n=this,s=i.getRequestBuilder("StateHandler.SaveStateRequest");if(s){var a=i.getRequestBuilder("Toolbar.AddToolButtonRequest"),r="localization.button.toolbarsave";t&&t.button&&t.button.toolbarsave&&(r=t.button.toolbarsave),i.request(e,a("save_view","viewtools",{iconCls:"tool-save-view",tooltip:r,sticky:!1,prepend:!0,callback:function(){n._promptForView(function(t,n){var s=i.getRequestBuilder("StateHandler.SaveStateRequest");i.request(e,s(t,n))})}}))}if(!i.getUser().isLoggedIn()){var a=i.getRequestBuilder("Toolbar.ToolButtonStateRequest");i.request(e,a("save_view","viewtools",!1))}},{getName:function(){return"PersonalData.MyViews"},getTitle:function(){return this.loc.title},addTabContent:function(e){var t=this,i=t.template.clone();t.container=e,e.append(i),t._refreshViewsList()},_renderViewsList:function(e){e||(e=[]);var t=this,i=t.container.find(".viewsList");i.empty(),this.viewData=e;var n=this._getGridModel(e),s=this._getGrid(n);s.renderTo(i)},_refreshViewsList:function(){var e=this,t=e.instance.getViewService();t.loadViews("USER",function(t,i){t?e._renderViewsList(i.views):e._showErrorMessage(e.loc.error.loadfailed)})},_editView:function(e){var t=this;this.instance.getSandbox();var i=t.instance.getViewService(),n=function(n,s){i.updateView(e.id,n,s,function(e){if(e){var i=Oskari.clazz.create("Oskari.userinterface.component.Popup");i.show(t.loc.popup.title,t.loc.save.success),i.fadeout(),t._refreshViewsList()}else t._showErrorMessage(t.loc.error.notsaved)})};this._promptForView(n,e.name,e.description)},_promptForView:function(e,t,i){var n=this,s=Oskari.clazz.create("Oskari.userinterface.component.Form"),a=Oskari.clazz.create("Oskari.userinterface.component.FormInput","name");a.setPlaceholder(this.loc.popup.name_placeholder);var r=this.loc.popup.title;t&&(r=this.loc.popup.edit,a.setValue(t)),a.setRequired(!0,n.loc.save.error_noname),a.setContentCheck(!0,n.loc.save.error_illegalchars),s.addField(a);var o=s.getForm();o.append(n.templateDesc.clone()),i&&o.find("textarea").val(i);var l=Oskari.clazz.create("Oskari.userinterface.component.Popup"),u=Oskari.clazz.create("Oskari.userinterface.component.Button");u.setTitle(this.loc.button.save),u.addClass("primary"),this.instance.sandbox,u.setHandler(function(){var t=s.validate();0==t.length?(e(a.getValue(),o.find("textarea").val()),l.close()):s.showErrors()});var c=l.createCloseButton(this.loc.button.cancel);l.show(r,o,[c,u]),l.dialog.on("keyup",function(e){e.stopPropagation()}),l.dialog.on("keydown",function(e){e.stopPropagation()})},_getGridModel:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.GridModel");t.setIdField("id");for(var i=0;i<e.length;++i){var n=e[i],s=n.isPublic===!0,a={id:n.id,state:n.state,name:n.name,description:n.description,isPublic:s,edit:this.loc.edit,publish:s?this.loc.unpublish:this.loc.publish,"delete":this.loc["delete"]};t.addData(a)}return t},_getGrid:function(e){var t=this,i=this.instance,n=i.getSandbox(),s=["name","description","edit","delete"],a=Oskari.clazz.create("Oskari.userinterface.component.Grid");a.setDataModel(e),a.setVisibleFields(s);var r=function(e,s){var a=t.templateLink.clone();return a.append(e),a.bind("click",function(){var e=n.getRequestBuilder("StateHandler.SetStateRequest");if(e){var t=e(s.state);t.setCurrentViewId(s.id),n.request(i,t)}return!1}),a};a.setColumnValueRenderer("name",r);var o=function(e,i){var n=t.templateLink.clone();return n.append(e),n.bind("click",function(){var e=t._getViewById(i.id);return e&&t._editView(e),!1}),n};a.setColumnValueRenderer("edit",o);var l=function(e,i){var n=t.templateLink.clone();return n.append(e),n.bind("click",function(){var e=t._getViewById(i.id);return e&&t._confirmDelete(e),!1}),n};a.setColumnValueRenderer("delete",l);for(var u=0;u<s.length;++u){var c=s[u],h="grid."+c;this.loc&&this.loc.grid&&this.loc.grid[c]&&(h=this.loc.grid[c]),a.setColumnUIName(c,h)}return a},_getViewById:function(e){for(var t=0;t<this.viewData.length;++t)if(this.viewData[t].id==e)return this.viewData[t];this._showErrorMessage(me.loc.error.generic)},_confirmDelete:function(e){var t=this,i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=Oskari.clazz.create("Oskari.userinterface.component.Button");n.setTitle(this.loc["delete"]),n.addClass("primary"),this.instance.sandbox,n.setHandler(function(){t._deleteView(e),i.close()});var s=i.createCloseButton(this.loc.button.cancel);i.show(t.loc.popup.deletetitle,t.loc.popup.deletemsg,[s,n]),i.makeModal()},_deleteView:function(e){var t=this,i=t.instance.getViewService();i.deleteView(e,function(e){e?t._refreshViewsList():t._showErrorMessage(t.loc.error.notdeleted)})},_showErrorMessage:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=t.createCloseButton(this.loc.button.ok);i.addClass("primary"),t.show(this.loc.error.title,e,[i])},bindEvents:function(){var e=this.instance,t=e.getSandbox();for(var i in this.eventHandlers)t.registerForEventByName(this,i)},unbindEvents:function(){var e=this.instance,t=e.getSandbox();for(var i in this.eventHandlers)t.unregisterFromEventByName(this,i)},eventHandlers:{StateSavedEvent:function(e){if(e.isError())return this._showErrorMessage(this.loc.error.notsaved),void 0;var t=Oskari.clazz.create("Oskari.userinterface.component.Popup");t.show(this.loc.popup.title,this.loc.save.success),t.fadeout(),this._refreshViewsList()}},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])}}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.service.ViewService",function(e){this._viewUrl=e},{__qname:"Oskari.mapframework.bundle.personaldata.service.ViewService",getQName:function(){return this.__qname},__name:"ViewService",getName:function(){return this.__name},loadViews:function(e,t){var i=this;e||(e="USER"),jQuery.ajax({url:i._viewUrl+"action_route=GetViews",data:{viewType:e},type:"POST",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(e){t(!0,e)},error:function(){t(!1)}})},deleteView:function(e,t){var i=this;jQuery.ajax({url:i._viewUrl+"action_route=DeleteView",data:{id:e.id},type:"POST",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(){t(!0)},error:function(){t(!1)}})},makeViewPublic:function(e,t,i){var n=this;jQuery.ajax({url:n._viewUrl+"action_route=AdjustViewAccess",data:{id:e,isPublic:t},type:"POST",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(){i(!0)},error:function(){i(!1)}})},updateView:function(e,t,i,n){var s=this;jQuery.ajax({url:s._viewUrl+"action_route=UpdateView",type:"POST",data:{id:e,newName:t,newDescription:i},dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(){n(!0)},error:function(){n(!1)}})},isViewLayersLoaded:function(e,t){var i={status:!1,msg:"error"};if(e&&e.state&&e.state.mapfull&&e.state.mapfull.state&&e.state.mapfull.state.selectedLayers){var n,s,a=e.state.mapfull.state.selectedLayers,r=t.getService("Oskari.mapframework.service.MapLayerService"),o=r.getAllLayers(),l=r.isAllLayersLoaded(),u=!1;for(n=0;n<a.length;++n)if(s=r.findMapLayer(a[n].id,o),!s){u=!0;break}l?u?i.msg="missing":(i.status=!0,i.msg="ok"):u?i.msg="notloaded":(i.status=!0,i.msg="ok")}return i}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.PublishedMapsTab",function(e,t){this.instance=e,this.template=jQuery('<div class="viewsList volatile"></div>'),this.templateLink=jQuery('<a href="JavaScript:void(0);"></a>'),this.loc=t,this.container=null},{getName:function(){return"PersonalData.PublishedMapsTab"},getTitle:function(){return this.loc.title},addTabContent:function(e){var t=this,i=t.template.clone();t.container=e,e.append(i),t._refreshViewsList()},_renderViewsList:function(e){e||(e=[]);var t=this,i=t.container.find(".viewsList");i.empty(),this.viewData=e;var n=this._getGridModel(e),s=this._getGrid(n);s.renderTo(i)},_refreshViewsList:function(){var e=this,t=e.instance.getViewService();t.loadViews("PUBLISHED",function(t,i){t?e._renderViewsList(i.views):e._showErrorMessage(e.loc.error.loadfailed)})},_getViewById:function(e){for(var t=0;t<this.viewData.length;++t)if(this.viewData[t].id==e)return this.viewData[t];this._showErrorMessage(me.loc.error.generic)},_confirmSetState:function(e,t){var i=this,n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(this.loc.button.ok),s.addClass("primary"),s.setHandler(function(){n.close(),e&&t&&e()});var a=n.createCloseButton(this.loc.button.cancel);t?n.show(i.loc.popup.showErrorTitle,i.loc.popup.showConfirmMissing,[a,s]):n.show(i.loc.popup.showErrorTitle,i.loc.popup.showConfirmNotLoaded,[a]),n.makeModal()},_confirmDelete:function(e){var t=this,i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=Oskari.clazz.create("Oskari.userinterface.component.Button");n.setTitle(this.loc["delete"]),n.addClass("primary"),this.instance.sandbox,n.setHandler(function(){t._deleteView(e),i.close()});var s=i.createCloseButton(this.loc.button.cancel);i.show(t.loc.popup.deletetitle,t.loc.popup.deletemsg,[s,n]),i.makeModal()},_deleteView:function(e){var t=this,i=t.instance.getViewService();i.deleteView(e,function(e){e?t._refreshViewsList():t._showErrorMessage(t.loc.error.notdeleted)})},_showErrorMessage:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=t.createCloseButton(this.loc.button.ok);i.addClass("primary"),t.show(this.loc.error.title,e,[i])},_getGridModel:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.GridModel");t.setIdField("id");for(var i=0;i<e.length;++i){var n=e[i],s=n.isPublic===!0,a={id:n.id,state:n.state,name:n.name,domain:n.pubDomain,lang:n.lang,isPublic:s,show:this.loc.show,edit:this.loc.edit,publish:s?this.loc.unpublish:this.loc.publish,"delete":this.loc["delete"]};t.addData(a)}return t},_getGrid:function(e){var t=this,i=this.instance,n=i.getSandbox(),s=["name","domain","publish","show","edit","delete"],a=Oskari.clazz.create("Oskari.userinterface.component.Grid");a.setDataModel(e),a.setVisibleFields(s);var r=function(e,i){var n=t.templateLink.clone();return n.append(e),n.bind("click",function(){return window.open("/web/fi/kartta?p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=0&p_p_state=exclusive&published=true&viewId="+i.id,"Published","location=1,status=1,scrollbars=yes,width=850,height=800"),!1}),n};a.setColumnValueRenderer("name",r);var o=n.getRequestBuilder("StateHandler.SetStateRequest"),l=i.getViewService(),u=function(e,s,a){var r=l.isViewLayersLoaded(e,n);if(r.status||s===!0){if(o){var u=o(e.state);return u.setCurrentViewId(e.id),n.request(i,u),!0}return!1}return t._confirmSetState(a,"missing"==r.msg),!1},c=function(e,i){var n=t.templateLink.clone();return n.append(e),n.bind("click",function(){return u(i,!1,function(){return u(i,!0),!1}),!1}),n};a.setColumnValueRenderer("show",c);var h=n.getRequestBuilder("Publisher.PublishMapEditorRequest"),d=function(e){if(h){var t=h(e);n.request(i,t)}},p=function(e,i){var n=t.templateLink.clone();return n.append(e),n.bind("click",function(){return u(i,!1,function(){u(i,!0),d(i)})&&d(i),!1}),n};a.setColumnValueRenderer("edit",p);var f=function(e,i){var n=t.templateLink.clone();return n.append(e),n.bind("click",function(){var e=t._getViewById(i.id);return e&&t._confirmDelete(e),!1}),n};a.setColumnValueRenderer("delete",f);var l=i.getViewService(),m=function(e,i){var n=t.templateLink.clone();return n.html(e),n.bind("click",function(){var e=t._getViewById(i.id);if(e){var s=!e.isPublic;l.makeViewPublic(i.id,s,function(a){a?(e.isPublic=s,i.publish=e.isPublic?t.loc.unpublish:t.loc.publish,n.html(i.publish)):s?t._showErrorMessage(t.loc.error.makePublic):t._showErrorMessage(t.loc.error.makePrivate)})}return!1}),n};a.setColumnValueRenderer("publish",m);for(var g=0;g<s.length;++g){var y=s[g],v="grid."+y;this.loc&&this.loc.grid&&this.loc.grid[y]&&(v=this.loc.grid[y]),a.setColumnUIName(y,v)}return a},bindEvents:function(){var e=this.instance,t=e.getSandbox();for(var i in this.eventHandlers)t.registerForEventByName(this,i)},unbindEvents:function(){var e=this.instance,t=e.getSandbox();for(var i in this.eventHandlers)t.unregisterFromEventByName(this,i)},eventHandlers:{"Publisher.MapPublishedEvent":function(){this._refreshViewsList()}},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])}}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.AccountTab",function(e,t){this.conf=e.conf,this.instance=e,this.template=jQuery('<div class="account"><div class="info"></div><div class="bottomlinks"></div></div>'),this.loc=t},{getTitle:function(){return this.loc.title},addTabContent:function(e){var t=this.template.clone();e.append(t),this._createAccountTab(e)},_createAccountTab:function(e){var t,i,n,s,a,r,o=this,l=o.instance.getSandbox(),u=jQuery('<div class="dataField"><div class="label"></div><div class="value"></div><br clear="all" /></div>'),c=l.getUser(),h=this.loc,d=[{label:h.firstName,value:c.getFirstName()},{label:h.lastName,value:c.getLastName()},{label:h.nickName,value:c.getNickName()},{label:h.email,value:c.getLoginName()}],p=e.find("div.info"),f=null;for(t=0;t<d.length;t+=1)i=d[t],n=u.clone(),n.find(".label").html(i.label),n.find(".value").html(i.value),p.append(n);for(o.conf&&(f=l.getLocalizedProperty(o.conf.changeInfoUrl)),s=[{label:h.changeInfo,href:f}],a=e.find("div.bottomlinks"),t=0;t<s.length;t+=1)i=s[t],i.href&&i.label&&(r=jQuery('<a href="'+i.href+'">'+i.label+"</a>&nbsp; "),a.append(r))}}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.request.AddTabRequest",function(e,t,i){this._title=e,this._content=t,this._first=!!i},{__name:"PersonalData.AddTabRequest",getName:function(){return this.__name},getTitle:function(){return this._title},getContent:function(){return this._content},isFirst:function(){return this._first}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.request.AddTabRequestHandler",function(e,t){this.sandbox=e,this.personaldata=t},{handleRequest:function(e,t){this.personaldata.addTab({title:t.getTitle(),content:t.getContent(),first:t.isFirst()})}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.PublisherBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.PublisherBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/Tile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/event/MapPublishedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/event/ToolStyleChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/event/ColourSchemeChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/event/FontChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/view/NotLoggedIn.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/view/StartView.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/view/BasicPublisher.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/view/PublisherLocationForm.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/view/PublisherLayerForm.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/view/PublisherLayoutForm.js"},{type:"text/css",src:"../../../../resources/framework/bundle/publisher/css/style.css"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/request/PublishMapEditorRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/request/PublishMapEditorRequestHandler.js"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/publisher/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"publisher","Bundle-Name":"publisher","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("publisher","Oskari.mapframework.bundle.publisher.PublisherBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.PublisherBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.publisher=null,this.disabledLayers=null},{__name:"Publisher",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e,t,i=this,n=i.conf,s=(n?n.sandbox:null)||"sandbox",a=Oskari.getSandbox(s);if(i.conf.urlPrefix&&!i.started){i.started=!0,i.sandbox=a,this.localization=Oskari.getLocalization(this.getName()),a.register(i);for(t in i.eventHandlers)i.eventHandlers.hasOwnProperty(t)&&a.registerForEventByName(i,t);e=a.getRequestBuilder("userinterface.AddExtensionRequest")(this),a.request(this,e),i._createUi(),i.publishMapEditorRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.request.PublishMapEditorRequestHandler",i),a.addRequestHandler("Publisher.PublishMapEditorRequest",i.publishMapEditorRequestHandler)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},AfterMapLayerAddEvent:function(){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},MapLayerEvent:function(){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},"Publisher.MapPublishedEvent":function(e){var t,i,n,s,a=this.getLocalization(),r=Oskari.clazz.create("Oskari.userinterface.component.Popup"),o=r.createCloseButton(a.BasicView.buttons.ok);o.addClass("primary"),t=this.sandbox.getLocalizedProperty(this.conf.urlPrefix)+"/published/"+e.getLanguage()+"/"+e.getId(),i='<iframe src="'+t+'" width="'+e.getWidth()+'" height="'+e.getHeight()+'"></iframe>',n='<textarea rows="3" cols="80">'+i+"</textarea>",s=a.published.desc+"<br/>"+n,r.show(a.published.title,s,[o]),this.setPublishMode(!1)},"Publisher.ToolStyleChangedEvent":function(e){this.publisher&&this.publisher.changeToolStyles(e.getStyle())},"Publisher.ColourSchemeChangedEvent":function(e){this.publisher&&this.publisher.changeColourScheme(e.getColourScheme())},"Publisher.FontChangedEvent":function(e){this.publisher&&this.publisher.changeFont(e.getFont())}},stop:function(){var e,t,i=this.sandbox();for(t in this.eventHandlers)this.eventHandlers.hasOwnProperty(t)&&i.unregisterFromEventByName(this,t);e=i.getRequestBuilder("userinterface.RemoveExtensionRequest")(this),i.request(this,e),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")
},getDescription:function(){return this.getLocalization("desc")},_createUi:function(){var e=this;e.plugins["Oskari.userinterface.Flyout"].createUi(),e.plugins["Oskari.userinterface.Tile"].refresh()},setPublishMode:function(e,t,i){var n,s,a,r,o,l,u=this,c=jQuery("#contentMap");for(n=u.sandbox.findAllSelectedMapLayers(),s=null,a=0;a<n.length;a+=1)if(r=n[a],"stats"===r.getLayerType()){o=u.sandbox.getRequestBuilder("StatsGrid.StatsGridRequest")(!1,r),u.sandbox.request(u.getName(),o),s=r;break}1==e?(u.disabledLayers=t,u.oskariLang=Oskari.getLang(),u._removeLayers(),c.addClass("mapPublishMode"),o=u.sandbox.getRequestBuilder("userinterface.UpdateExtensionRequest")(u,"close",u.getName()),u.sandbox.request(u.getName(),o),u.publisher=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.BasicPublisher",u,u.getLocalization("BasicView"),i),u.publisher.render(c),u.publisher.setEnabled(!0),s&&u.publisher.initGrid(s)):(jQuery("#contentMap").width(""),jQuery(".oskariui-left").css({width:"",height:"100%","float":""}).removeClass("published-grid-left").empty(),jQuery(".oskariui-center").css({width:"100%","float":""}).removeClass("published-grid-center"),Oskari.setLang(u.oskariLang),u.publisher&&(u.publisher.setEnabled(!1),u.publisher.destroy()),c.removeClass("mapPublishMode"),u._addLayers()),l=u.sandbox.getRequestBuilder("MapFull.MapResizeEnabledRequest"),l&&(o=l(!e),u.sandbox.request(u,o))},_addLayers:function(){var e,t,i=this,n=this.sandbox,s=n.getRequestBuilder("AddMapLayerRequest");if(i.disabledLayers)for(e=0;e<i.disabledLayers.length;e+=1)t=i.disabledLayers[e],n.request(i,s(t.getId(),!0))},_removeLayers:function(){var e,t,i=this,n=i.sandbox,s=n.getRequestBuilder("RemoveMapLayerRequest");if(i.disabledLayers)for(e=0;e<i.disabledLayers.length;e+=1)t=i.disabledLayers[e],n.request(i,s(t.getId()))},hasPublishRight:function(e){return"publication_permission_ok"===e.getPermission("publish")},getLayersWithoutPublishRights:function(){var e,t,i=[],n=this.sandbox.findAllSelectedMapLayers();for(e=0;e<n.length;e+=1)t=n[e],!this.hasPublishRight(t)&&t.getId().toString().indexOf("myplaces_")<0&&i.push(t);return i}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.view=null},{getName:function(){return"Oskari.mapframework.bundle.publisher.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("publisher")||jQuery(this.container).addClass("publisher")},startPlugin:function(){this.template=jQuery("<div></div>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("flyouttitle")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},createUi:function(){var e=this,t=jQuery(this.container);t.empty();var i=e.instance.getSandbox();this.view=i.getUser().isLoggedIn()?Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.StartView",this.instance,this.instance.getLocalization("StartView")):Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.NotLoggedIn",this.instance,this.instance.getLocalization("NotLoggedView")),this.view.render(t)},handleLayerSelectionChanged:function(){this.view&&this.view.handleLayerSelectionChanged&&this.view.handleLayerSelectionChanged()}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.publisher.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.event.MapPublishedEvent",function(e,t,i,n){this._id=e,this._width=t,this._height=i,this._language=n},{__name:"Publisher.MapPublishedEvent",getName:function(){return this.__name},getId:function(){return this._id},getWidth:function(){return this._width},getHeight:function(){return this._height},getLanguage:function(){return this._language}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.event.ToolStyleChangedEvent",function(e){this._style=e},{__name:"Publisher.ToolStyleChangedEvent",getName:function(){return this.__name},getStyle:function(){return this._style}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.event.ColourSchemeChangedEvent",function(e){this._colourScheme=e},{__name:"Publisher.ColourSchemeChangedEvent",getName:function(){return this.__name},getColourScheme:function(){return this._colourScheme}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.event.FontChangedEvent",function(e){this._font=e},{__name:"Publisher.FontChangedEvent",getName:function(){return this.__name},getFont:function(){return this._font}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.NotLoggedIn",function(e,t){this.instance=e,this.template=jQuery("<div class='notLoggedIn'></div>"),this.loginTemplate=jQuery("<div class='notLoggedIn'><a></a></div>"),this.registerTemplate=jQuery("<div class='notLoggedIn'><a></a></div>"),this.loc=t},{render:function(e){var t=this,i=t.instance.conf,n=t.instance.getSandbox(),s=t.template.clone(),a=t.loginTemplate.clone(),r=null,o=t.registerTemplate.clone(),l=null,u=a.find("a"),c=o.find("a");i&&(r=n.getLocalizedProperty(i.loginUrl),l=n.getLocalizedProperty(i.registerUrl)),s.append(t.loc.text),e.append(s),r&&(u.attr("href",r),u.append(t.loc.signup),e.append(a)),l&&(c.attr("href",l),c.append(t.loc.register),e.append(o))}}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.StartView",function(e,t){this.instance=e,this.template=jQuery("<div class='startview'><div class='content'></div><div class='tou'><a href='JavaScript:void(0;)'></a></div><div class='buttons'></div></div>"),this.templateLayerList=jQuery("<div class='layerlist'><h4></h4><ul></ul></div>"),this.templateListItem=jQuery("<li></li>"),this.templateError=jQuery('<div class="error"><ul></ul></div>'),this.templateInfo=jQuery("<div class='icon-info'></div>"),this.loc=t,this.content=void 0,this.buttons={},this.hasAcceptedTou=!1},{render:function(e){var t=this,i=this.template.clone();this.content=i,i.find("div.content").before(this.loc.text),e.append(i);var n=i.find("div.tou a");n.append(this.loc.touLink),n.bind("click",function(){return t._showTermsOfUse(),!1});var s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.addClass("primary"),s.setHandler(function(){t.hasAcceptedTou||t._markTouAccepted();var e=t.instance.getLayersWithoutPublishRights();t.instance.setPublishMode(!0,e)}),this.buttons["continue"]=s,this._updateContinueButton(),s.insertTo(i.find("div.buttons"));var a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(this.loc.buttons.cancel),a.setHandler(function(){t.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[t.instance,"close"])}),this.buttons.cancel=a,a.insertTo(i.find("div.buttons")),this._renderLayerLists(),this._checkTouAccepted()},_renderLayerLists:function(){var e=this.content.find("div.content");e.find("div.error").remove(),e.find("div.layerlist").remove();for(var t=[],i=[],n=this.instance.sandbox.findAllSelectedMapLayers(),s=0;s<n.length;++s){var a=n[s];!this.instance.hasPublishRight(a)&&a.getId().toString().indexOf("myplaces_")<0?i.push(a):t.push(a)}if(t.length>0){var r=this._getRenderedLayerList(t),o=r.find("h4"),l="loc.layerlist_title";if(this.loc&&this.loc.layerlist_title&&(l=this.loc.layerlist_title),o.append(l),e.append(r),this.buttons["continue"].setEnabled(!0),i.length>0){var u=this._getRenderedLayerList(i),o=u.find("h4");o.append(this.loc.layerlist_denied);var c=this.templateInfo.clone();c.attr("title",this.loc.denied_tooltip),o.before(c),e.append(u)}}else{var h=this.templateError.clone(),d=this.templateListItem.clone();d.append(this.loc.layerlist_empty),h.find("ul").append(d),e.append(h),this.buttons["continue"].setEnabled(!1)}},_getRenderedLayerList:function(e){for(var t=this.templateLayerList.clone(),i=t.find("ul"),n=0;n<e.length;++n){var s=e[n],a=this.templateListItem.clone();s.getId().toString().indexOf("myplaces_")>-1?a.append(s.getName()+" ("+this.loc.myPlacesDisclaimer+")"):a.append(s.getName()),i.append(a)}return t},handleLayerSelectionChanged:function(){this._renderLayerLists()},_showTermsOfUse:function(){var e=this;if(!this.termsOfUse){var t=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",e.instance.sandbox);return t.getHelpArticle("termsofuse, mappublication, "+Oskari.getLang(),function(t,i){t&&(e.termsOfUse=i,e._showTermsOfUse())}),void 0}var i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=i.createCloseButton(this.loc.buttons.close);i.show(e.termsOfUse.title,e.termsOfUse.body,[n])},_checkTouAccepted:function(){var e=this;jQuery.ajax({url:e.instance.sandbox.getAjaxUrl(),type:"GET",data:{action_route:"HasAcceptedPublishedTermsOfUse"},dataType:"json",error:function(){this.success(!1)},beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(t){e.hasAcceptedTou=t,e._updateContinueButton()}})},_updateContinueButton:function(){this.hasAcceptedTou?this.buttons["continue"].setTitle(this.loc.buttons["continue"]):this.buttons["continue"].setTitle(this.loc.buttons.continueAndAccept)},_markTouAccepted:function(){var e=this;jQuery.ajax({url:e.instance.sandbox.getAjaxUrl(),type:"GET",data:{action_route:"AcceptPublishedTermsOfUse"},dataType:"json",error:function(){this.success(!1)},beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(t){e.hasAcceptedTou=t,e._updateContinueButton()}})}}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.BasicPublisher",function(e,t,i){this.data=i;var n=this;if(this.instance=e,this.template=jQuery('<div class="basic_publisher"><div class="header"><div class="icon-close"></div><h3></h3></div><div class="content"></div></div>'),n.templates={publishedGridTemplate:'<div class="publishedgrid"></div>'},this.templateButtonsDiv=jQuery('<div class="buttons"></div>'),this.templateHelp=jQuery('<div class="help icon-info"></div>'),this.templateTool=jQuery('<div class="tool "><input type="checkbox"/><span></span></div>'),this.templateData=jQuery('<div class="data "><input type="checkbox"/><label></label></div>'),this.templateSizeOptionTool=jQuery('<div class="tool "><input type="radio" name="size" /><span></span></div>'),this.templateCustomSize=jQuery('<div class="customsize"><input type="text" name="width" placeholder="'+t.sizes.width+'"/> x '+'<input type="text" name="height" placeholder="'+t.sizes.height+'"/></div>'),this.tools=[{id:"Oskari.mapframework.bundle.mapmodule.plugin.ScaleBarPlugin",selected:!1},{id:"Oskari.mapframework.bundle.mapmodule.plugin.IndexMapPlugin",selected:!1},{id:"Oskari.mapframework.bundle.mapmodule.plugin.PanButtons",selected:!1,config:{location:{top:"10px",left:"10px"}}},{id:"Oskari.mapframework.bundle.mapmodule.plugin.Portti2Zoombar",selected:!0,config:{location:{top:"10px",left:"10px"}}},{id:"Oskari.mapframework.bundle.mapmodule.plugin.SearchPlugin",selected:!1,config:{}},{id:"Oskari.mapframework.mapmodule.ControlsPlugin",selected:!0},{id:"Oskari.mapframework.mapmodule.GetInfoPlugin",selected:!0,config:{infoBox:!0}}],this.sizeOptions=[{id:"small",width:580,height:387},{id:"medium",width:700,height:525,selected:!0},{id:"large",width:1240,height:700},{id:"custom",minWidth:30,minHeight:20,maxWidth:4e3,maxHeight:2e3}],this.grid={},this.grid.selected=!0,i){i.lang&&Oskari.setLang(i.lang);for(var s=!1,a=this.data.state.mapfull.config.size.width,r=this.data.state.mapfull.config.size.height,o=0;o<this.sizeOptions.length;++o){var l=this.sizeOptions[o];a===l.width&&r==l.height?(l.selected=!0,s=!0):l.selected=!1}if(!s){var u=this.sizeOptions[this.sizeOptions.length-1];u.selected=!0,u.width=a,u.height=r}var c=this.data.state.mapfull.config.plugins;this.data.hasLayerSelectionPlugin=!1;for(var o=0;o<this.tools.length;++o)for(var l=this.tools[o],h=0;h<c.length;++h){var d=c[h];if(l.id==d.id){l.selected=!0;break}l.selected=!1,"Oskari.mapframework.bundle.mapmodule.plugin.LayerSelectionPlugin"==d.id&&(this.data.hasLayerSelectionPlugin=d.config)}}this.loc=t,this.accordion=null,this.maplayerPanel=null,this.mainPanel=null,this.normalMapPlugins=[],this.logoPlugin=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.plugin.LogoPlugin"),this.latestGFI=null,this.urlBase=e.conf.urlPrefix+"/web/"},{render:function(e){var t=this,i=this.template.clone();this.mainPanel=i,e.append(i);var n=i.find("div.content"),s=Oskari.clazz.create("Oskari.userinterface.component.Accordion");this.accordion=s;var a=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.PublisherLocationForm",this.loc,this);this.locationForm=a,this.data?(i.find("div.header h3").append(this.loc.titleEdit),a.init({domain:this.data.domain,name:this.data.name,lang:this.data.lang})):(i.find("div.header h3").append(this.loc.title),a.init());var r=a.getPanel();r.open(),s.addPanel(r);for(var o=this.instance.getSandbox(),l=o.findAllSelectedMapLayers(),u=!1,c=0;c<l.length;c++){var h=l[c];"stats"===h.getLayerType()&&(u=!0)}if(u){var d=o.findRegisteredModuleInstance("MainMapModule");t.mapModule=d;var e=jQuery(t.templates.publishedGridTemplate);t.statsContainer=e;var p=this._createDataPanel();p.open(),s.addPanel(p)}s.addPanel(this._createSizePanel()),s.addPanel(this._createToolsPanel()),this.layoutPanel=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.PublisherLayoutForm",this.loc,this),this.layoutPanel.init(),s.addPanel(this.layoutPanel.getPanel()),this.maplayerPanel=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.PublisherLayerForm",this.loc,this.instance),this.maplayerPanel.init(),s.addPanel(this.maplayerPanel.getPanel()),s.insertTo(n),e.find("div.header div.icon-close").bind("click",function(){t.instance.setPublishMode(!1)}),n.append(this._getButtons());var f=this.mainPanel.find("input[type=text]");f.focus(function(){t.instance.sandbox.postRequestByName("DisableMapKeyboardMovementRequest")}),f.blur(function(){t.instance.sandbox.postRequestByName("EnableMapKeyboardMovementRequest")});var m=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",this.instance.sandbox);m.processHelpLinks(this.loc.help,i,this.loc.error.title,this.loc.error.nohelp)},_setSelectedSize:function(){var e=this,t=this.mainPanel.find("div.customsize input[name=width]");t.removeClass("error");var i=this.mainPanel.find("div.customsize input[name=height]");i.removeClass("error");for(var n=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule"),s=0;s<e.sizeOptions.length;++s){var a=e.sizeOptions[s];if(a.selected){var r=jQuery(n.getMap().div);if("custom"==a.id){var o=t.val();this._validateNumberRange(o,a.minWidth,a.maxWidth)?(r.width(o),e.adjustDataContainer()):t.addClass("error");var l=i.val();this._validateNumberRange(l,a.minHeight,a.maxHeight)?r.height(l):i.addClass("error");break}r.width(a.width),r.height(a.height),e.adjustDataContainer();break}}n.updateSize()},_createSizePanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.size.label);var i=t.getContainer(),n=this.templateHelp.clone();n.attr("title",this.loc.size.tooltip),i.append(n);for(var s=function(t){return function(){i.find("input[name=size]:checked").val();for(var n=0;n<e.sizeOptions.length;++n)e.sizeOptions[n].selected=!1;t.selected=!0,e._setSelectedSize()}},a=!1,r=0;r<this.sizeOptions.length;++r){var o=this.sizeOptions[r],l=this.templateSizeOptionTool.clone(),u=this.loc.sizes[o.id];o.width&&o.height&&"custom"!=o.id&&(u=e._getSizeLabel(u,o)),l.find("span").addClass("sizeoption_"+o.id).append(u),o.selected&&(l.find("input").attr("checked","checked"),"custom"==o.id&&(a=!0)),i.append(l),l.find("input").attr("value",o.id),l.find("input").change(s(o))}var c=this.templateCustomSize.clone(),h=c.find("input");if(h.focus(function(){var e=i.find("input[name=size][value=custom]");e.attr("checked","checked"),e.trigger("change")}),h.bind("keyup",function(){e._setSelectedSize()}),a){var d=c.find("input[name=width]");d.val(o.width);var p=c.find("input[name=height]");p.val(o.height)}return i.append(c),t},_getSizeLabel:function(e,t){var i=this.isDataVisible?this._calculateGridWidth():0;return e+" ("+(t.width+i)+" x "+t.height+"px)"},_setSizeLabels:function(){for(var e=0;e<this.sizeOptions.length;++e){var t=this.sizeOptions[e],i=jQuery("span.sizeoption_"+t.id),n=this.loc.sizes[t.id];t.width&&t.height&&"custom"!=t.id&&(n=this._getSizeLabel(n,t)),i.text(n)}},_createToolsPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.tools.label);var i=t.getContainer(),n=this.templateHelp.clone();n.attr("title",this.loc.tools.tooltip),i.append(n);for(var s=function(t){return function(){var i=jQuery(this),n=i.is(":checked");t.selected=n,e._activatePreviewPlugin(t,n)}},a=0;a<this.tools.length;++a){var r=this.templateTool.clone(),o=this.tools[a].id;o=o.substring(o.lastIndexOf(".")+1);var l=this.loc.tools[o];r.find("span").append(l),this.tools[a].selected&&r.find("input").attr("checked","checked"),i.append(r),r.find("input").change(s(this.tools[a]))}return t},_createDataPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.data.label);var i=t.getContainer(),n=this.templateHelp.clone();n.attr("title",this.loc.data.tooltip),i.append(n);var s=this.templateData.clone();return s.find("input").attr("id","show-grid-checkbox").change(function(){var t=jQuery(this),i=t.is(":checked");e.isDataVisible=i,e.adjustDataContainer(),e._setSizeLabels()}),s.find("label").attr("for","show-grid-checkbox").append(this.loc.data.grid),this.grid.selected&&(s.find("input").attr("checked","checked"),e.isDataVisible=this.grid.selected,e.adjustDataContainer()),i.append(s),t},adjustDataContainer:function(){if(this.statsContainer){var e=jQuery("#contentMap"),t=e.width(),i=e.css("margin-left").split("px")[0];jQuery(window).width()-i-40;var n=jQuery("#mapdiv").width(),s=jQuery("#mapdiv").height(),a=this._calculateGridWidth(),r=s,o=jQuery(".oskariui-left"),l=jQuery(".oskariui-center");this.isDataVisible?(a>400&&(a=400),o.removeClass("oskari-closed"),jQuery("#contentMap").width(a+n),a+="px",r+="px",n+="px"):(o.addClass("oskari-closed"),jQuery("#contentMap").width(""),a="0px",r="0px",t="100%"),o.css({width:a,height:r,"float":"left"}).addClass("published-grid-left"),l.css({width:n,"float":"left"}).addClass("published-grid-center"),this.statsContainer.height(s),this.gridPlugin&&this.gridPlugin.setGridHeight()}},_calculateGridWidth:function(){var e,t=Oskari.getSandbox("sandbox"),i=t.getStatefulComponents().statsgrid;if(i&&i.state&&null!=i.state.indicators){var n=i.state.indicators.length+2;e=80*n}else e=160;return e+20},getDataContainer:function(){return jQuery(".oskariui-left")},addDataGrid:function(e){this.getDataContainer.html(e)},handleMapMoved:function(){var e=this.instance.sandbox.getMap();e.getX(),e.getY(),e.getZoom()},_activatePreviewPlugin:function(e,t){if(!e.plugin&&t){var i=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule");e.plugin=Oskari.clazz.create(e.id,e.config),i.registerPlugin(e.plugin)}e.plugin&&(t?(e.plugin.startPlugin(this.instance.sandbox),e._isPluginStarted=!0):e._isPluginStarted&&(e._isPluginStarted=!1,e.plugin.stopPlugin(this.instance.sandbox)),this._adjustMapNavigationLocation(e,t))},_getButtons:function(){var e=this,t=this.templateButtonsDiv.clone(),i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.setTitle(this.loc.buttons.cancel),i.setHandler(function(){e.instance.setPublishMode(!1)}),i.insertTo(t);var n=Oskari.clazz.create("Oskari.userinterface.component.Button");if(n.setTitle(this.loc.buttons.save),n.addClass("primary"),this.data){var s=function(){var t=e._gatherSelections();t&&e._publishMap(t)};n.setTitle(this.loc.buttons.saveNew),n.setHandler(function(){e.data.id=null,delete e.data.id,s()}),n.insertTo(t);var a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(this.loc.buttons.replace),a.addClass("primary"),a.setHandler(function(){e._showReplaceConfirm(s)}),a.insertTo(t)}else n.setTitle(this.loc.buttons.save),n.setHandler(function(){var t=e._gatherSelections();t&&e._publishMap(t)}),n.insertTo(t);return t},_showReplaceConfirm:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.setTitle(this.loc.buttons.replace),i.addClass("primary"),i.setHandler(function(){t.close(),e()});var n=t.createCloseButton(this.loc.buttons.cancel);t.show(this.loc.confirm.replace.title,this.loc.confirm.replace.msg,[n,i])},_showValidationErrorMessage:function(e){for(var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=t.createCloseButton(this.loc.buttons.ok),n=jQuery("<ul></ul>"),s=0;s<e.length;++s){var a=jQuery("<li></li>");a.append(e[s].error),n.append(a)}t.show(this.loc.error.title,n,[i])},_gatherSelections:function(){var e=this.mainPanel,t=this.instance.getSandbox(),i=this.locationForm.validate(),n=this.locationForm.getValues(),s=e.find("input[name=size]:checked").val();this._calculateGridWidth();var a={domain:n.domain,name:n.name,language:n.language,plugins:[]};this.data&&this.data.id&&(a.id=this.data.id);for(var r=0;r<this.tools.length;++r)if(this.tools[r].selected){var o={id:this.tools[r].id};this.tools[r].config&&(o.config=this.tools[r].config),a.plugins.push(o)}if("custom"==s){var l=e.find("div.customsize input[name=width]").val(),u=e.find("div.customsize input[name=height]").val();this._validateSize(l,u)?a.size={width:l,height:u}:i.push({field:"size",error:this.loc.error.size})}else for(var r=0;r<this.sizeOptions.length;++r){var c=this.sizeOptions[r];if(c.id==s){a.size={width:c.width,height:c.height};break}}var h=this.maplayerPanel.getValues();if(h.layerSelection&&(a.plugins.push(h.layerSelection),a.defaultBase=h.defaultBase,a.baseLayers=h.baseLayers),this.isDataVisible){var d=this.sandbox.getStatefulComponents().statsgrid;a.gridState=d.state}var p=t.getStatefulComponents().mapfull.getState();return a.mapstate=p,t.getStatefulComponents().infobox&&(a.infobox=t.getStatefulComponents().infobox.getState()),i.length>0?(this._showValidationErrorMessage(i),void 0):a},_adjustMapNavigationLocation:function(e,t){for(var i,n,s,a={top:"110px",left:"45px"},r={top:"10px",left:"10px"},o=0;o<this.tools.length;++o)"Oskari.mapframework.bundle.mapmodule.plugin.Portti2Zoombar"===this.tools[o].id&&(i=this.tools[o]),"Oskari.mapframework.bundle.mapmodule.plugin.PanButtons"===this.tools[o].id&&(n=this.tools[o]);if(e.id===i.id)s=n._isPluginStarted?a:r;else{if(e.id!==n.id)return;s=t?a:r}i._isPluginStarted&&(i.config.location=s,i.plugin.setZoombarLocation(s))},_publishMap:function(e){var t=this,i=this.instance.getSandbox(),n=i.getAjaxUrl(),s=t.isDataVisible?e.size.width+t._calculateGridWidth():e.size.width,a=function(){var e=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=e.createCloseButton(t.loc.buttons.ok);e.show(t.loc.error.title,t.loc.error.saveFailed,[i])};jQuery.ajax({url:n+"&action_route=Publish",type:"POST",dataType:"json",data:{pubdata:JSON.stringify(e)},beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(t){if(t.id>0){var n=i.getEventBuilder("Publisher.MapPublishedEvent")(t.id,s,e.size.height,e.language);i.notifyAll(n)}else a()},error:a})},_validateNumberRange:function(e,t,i){return isNaN(parseInt(e))?!1:isFinite(e)?t>e||e>i?!1:!0:!1},_validateSize:function(e,t){for(var i=null,n=0;n<this.sizeOptions.length;++n){var s=this.sizeOptions[n];if("custom"==s.id){i=s;break}}var a=this._validateNumberRange(e,i.minWidth,i.maxWidth)&&this._validateNumberRange(t,i.minHeight,i.maxHeight);return a},_enablePreview:function(){var e=this,t=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule"),i=t.getPluginInstances();for(var n in i){var s=i[n];s.hasUI&&s.hasUI()&&(s.stopPlugin(e.instance.sandbox),t.unregisterPlugin(s),this.normalMapPlugins.push(s))}this.maplayerPanel.start(),this.data&&this.data.hasLayerSelectionPlugin&&this.maplayerPanel.useConfig(this.data.hasLayerSelectionPlugin),this._setSelectedSize();for(var a=0;a<this.tools.length;++a)this.tools[a].selected&&this._activatePreviewPlugin(this.tools[a],!0);t.registerPlugin(this.logoPlugin),this.logoPlugin.startPlugin(e.instance.sandbox)},_disablePreview:function(){var e=this,t=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule");t.getPluginInstances();for(var i=0;i<this.tools.length;++i)this.tools[i].plugin&&(this._activatePreviewPlugin(this.tools[i],!1),t.unregisterPlugin(this.tools[i].plugin),this.tools[i].plugin=void 0,delete this.tools[i].plugin);this.maplayerPanel.stop(),this.layoutPanel.stop();var n=jQuery(t.getMap().div);n.width(""),n.height(jQuery(window).height()),t.updateSize();for(var i=0;i<this.normalMapPlugins.length;++i){var s=this.normalMapPlugins[i];t.registerPlugin(s),s.startPlugin(e.instance.sandbox)}this.normalMapPlugins=[],t.unregisterPlugin(this.logoPlugin),this.logoPlugin.stopPlugin(e.instance.sandbox)},setEnabled:function(e){e?this._enablePreview():this._disablePreview()},destroy:function(){this.mainPanel.remove()},setPluginLanguage:function(e){Oskari.setLang(e);for(var t=0;t<this.tools.length;++t){var i=this.tools[t];i._isPluginStarted&&(this._activatePreviewPlugin(i,!1),this._activatePreviewPlugin(i,!0))}this._resetLayerSelectionPlugin(),this.logoPlugin.stopPlugin(this.instance.sandbox),this.logoPlugin.startPlugin(this.instance.sandbox)},_resetLayerSelectionPlugin:function(){if(this.maplayerPanel.isEnabled()){var e=this.maplayerPanel.plugin.getBaseLayers();this.maplayerPanel.enablePlugin(!1),this.maplayerPanel.enablePlugin(!0);for(var t=e.baseLayers,i=e.defaultBaseLayer,n=0;n<t.length;++n){var s=this.instance.sandbox.findMapLayerFromSelectedMapLayers(t[n]);this.maplayerPanel.plugin.addBaseLayer(s)}this.maplayerPanel.plugin.selectBaseLayer(i)}},initGrid:function(e){var t=this,i=t.conf,n=Oskari.getLocalization("StatsGrid"),s=!0,a="sandbox",r=Oskari.getSandbox(a);t.sandbox=r,r.register(t.instance);var o=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.StatisticsService",t);r.registerService(o),t.statsService=o;var l=t.sandbox.getStatefulComponents().statsgrid;if(l&&l.state&&s){var u={published:!0,layer:e,state:l.state},c=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.plugin.ManageStatsPlugin",u,n);t.mapModule.registerPlugin(c),t.mapModule.startPlugin(c),t.gridPlugin=c;var h=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.plugin.ManageClassificationPlugin",i,n);t.mapModule.registerPlugin(h),t.mapModule.startPlugin(h),t.classifyPlugin=h;var d=t.getDataContainer();d.html(t.statsContainer),t.gridPlugin.createStatsOut(t.statsContainer)}},changeToolStyles:function(e){if(e){for(var t,i=0;i<this.tools.length;++i){var n=this.tools[i];n.id.indexOf("Portti2Zoombar")>=0?(t=e.zoombar||{},t.val=e.val):n.id.indexOf("SearchPlugin")>=0?(t=e.search||{},t.val=e.val):t=e.val,n.config&&(n.config.toolStyle=t),n._isPluginStarted&&n.plugin.changeToolStyle&&n.plugin.changeToolStyle(t)}this._setLayerSelectionStyle(e.val)}},_setLayerSelectionStyle:function(e){var t=this.maplayerPanel;t.pluginConfig.toolStyle=e,t.isEnabled()&&t.plugin.changeToolStyle&&t.plugin.changeToolStyle(e)},changeColourScheme:function(e){var t=this._getGetInfoPlugin();t&&(t.config=t.config||{},t.config.colourScheme=e);var i=this.maplayerPanel;i.pluginConfig.colourScheme=e,i.isEnabled()&&i.plugin.changeColourScheme&&i.plugin.changeColourScheme(e)},changeFont:function(e){if(e){for(var t=0;t<this.tools.length;++t){var i=this.tools[t];i.config&&(i.config.font=e),i._isPluginStarted&&i.plugin.changeFont&&i.plugin.changeFont(e)}this._setLayerSelectionFont(e),this.logoPlugin&&this.logoPlugin.changeFont&&this.logoPlugin.changeFont(e);var n=this._getGetInfoPlugin();n&&(n.config=n.config||{},n.config.font=e)}},_setLayerSelectionFont:function(e){var t=this.maplayerPanel;t.pluginConfig.font=e,t.isEnabled()&&t.plugin.changeFont&&t.plugin.changeFont(e)},_getGetInfoPlugin:function(){var e,t,i=null;for(e=0;e<this.tools.length;++e)if(t=this.tools[e],"Oskari.mapframework.mapmodule.GetInfoPlugin"===t.id){i=t;break}return i}}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.PublisherLocationForm",function(e,t){this.loc=e,this._publisher=t,this.fields={domain:{label:e.domain.label,placeholder:e.domain.placeholder,helptags:"portti,help,publisher,domain",tooltip:e.domain.tooltip},name:{label:e.name.label,placeholder:e.name.placeholder,helptags:"portti,help,publisher,name",tooltip:e.name.tooltip}},this.langField={template:jQuery('<div class="field"><div class="help icon-info" title="'+e.language.tooltip+'" helptags="portti,help,publisher,language"></div>'+'<label for="language">'+e.language.label+'</label><br clear="all" />'+'<select name="language"></select>'+"</div>"),optionTemplate:jQuery("<option></option>")}},{init:function(e){var t=this;for(var i in this.fields){var n=this.fields[i],s=Oskari.clazz.create("Oskari.userinterface.component.FormInput",i);s.setLabel(n.label),s.setTooltip(n.tooltip,n.helptags),s.setPlaceholder(n.placeholder),n.field=s}this.fields.domain.field.setRequired(!0,this.loc.error.domain),this.fields.domain.field.setContentCheck(!0,this.loc.error.domainIllegalCharacters),this.fields.domain.field.setValidator(function(e){var i=e.getValue(),n=e.getName(),s=[];return 0===i.indexOf("http")||0===i.indexOf("www")?(s.push({field:n,error:t.loc.error.domainStart}),s):s}),this.fields.name.field.setRequired(!0,this.loc.error.name),this.fields.name.field.setContentCheck(!0,this.loc.error.nameIllegalCharacters),e&&(this.fields.domain.field.setValue(e.domain),this.fields.name.field.setValue(e.name));var a=this.langField.template.clone(),r=a.find("select[name=language]"),o=this.loc.language.options,l=Oskari.getLang();e&&e.lang&&(l=e.lang);for(var u in o){var c=this.langField.optionTemplate.clone();c.attr("value",u),l==u&&c.attr("selected","selected"),c.append(o[u]),r.append(c)}r.change(function(){t._publisher.setPluginLanguage(jQuery(this).attr("value"))}),this.langField.field=a},getPanel:function(){var e=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");e.setTitle(this.loc.domain.title);var t=e.getContainer();for(var i in this.fields){var n=this.fields[i];t.append(n.field.getField())}return t.append(this.langField.field),e},getValues:function(){var e={};for(var t in this.fields){var i=this.fields[t];e[t]=i.field.getValue()}return e.language=this.langField.field.find("select[name=language]").val(),e},validate:function(){var e=[];for(var t in this.fields){var i=this.fields[t];e=e.concat(i.field.validate())}return e}}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.PublisherLayerForm",function(e,t){this.loc=e,this.instance=t,this.panel=null,this.plugin=null,this.isDataVisible=!1,this.templateHelp=jQuery('<div class="help icon-info"></div>'),this.templateTool=jQuery('<div class="tool"><input type="checkbox"/><label></label></div>'),this.config={layers:{promote:[{text:this.loc.layerselection.promote,id:[24]}],preselect:["base_35"]}},this.pluginConfig={},this.showLayerSelection=!1},{init:function(){this.panel||(this.panel=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel"),this.panel.setTitle(this.loc.layers.label))
},useConfig:function(e){e&&(this.config.layers.preselect="[object Array]"===Object.prototype.toString.call(e.baseLayers)&&e.baseLayers.length>0?e.baseLayers:[],this.showLayerSelection=!0,this.enablePlugin(!0),this._populateMapLayerPanel())},getPanel:function(){return this._populateMapLayerPanel(),this.panel},enablePlugin:function(e){e?this.plugin.startPlugin(this.instance.sandbox):this.plugin.stopPlugin(this.instance.sandbox)},isEnabled:function(){return this.showLayerSelection},start:function(){this.plugin=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.plugin.LayerSelectionPlugin",this.pluginConfig);var e=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule");e.registerPlugin(this.plugin),this.showLayerSelection&&this.enablePlugin(!0)},stop:function(){this.enablePlugin(!1);var e=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule");e.unregisterPlugin(this.plugin)},getValues:function(){var e={};if(this.showLayerSelection){e.layerSelection={id:"Oskari.mapframework.bundle.mapmodule.plugin.LayerSelectionPlugin",config:this.pluginConfig};var t=this.plugin.getBaseLayers();t.defaultBaseLayer&&(e.layerSelection.config.baseLayers=t.baseLayers,e.layerSelection.config.defaultBaseLayer=t.defaultBaseLayer)}return e},validate:function(){var e=[];return e},_getLayersList:function(){var e=this.instance.sandbox.findAllSelectedMapLayers();return e},_populateMapLayerPanel:function(){var e=this,t=this.panel.getContainer();t.empty();var i=this.templateHelp.clone();i.attr("title",this.loc.layerselection.tooltip),t.append(i);var n=this.templateTool.clone();if(n.find("label").attr("for","show-map-layers-checkbox").append(this.loc.layerselection.label),this.showLayerSelection&&n.find("input").attr("checked","checked"),t.append(n),t.append(this.loc.layerselection.info),n.find("input").attr("id","show-map-layers-checkbox").change(function(){var i=jQuery(this),n=i.is(":checked");e.showLayerSelection=n,e.enablePlugin(n),t.empty(),e._populateMapLayerPanel()}),this.showLayerSelection){for(var s=function(t){return function(){var i=jQuery(this),n=i.is(":checked");t.selected=n,n?e.plugin.addBaseLayer(t):e.plugin.removeBaseLayer(t)}},a=function(t){var i=jQuery.inArray(""+t,e.config.layers.preselect);return-1!=i},r=this._getLayersList(),o=0;o<r.length;++o){var l=r[o],u=this.templateTool.clone();u.attr("data-id",l.getId()),u.find("label").attr("for","checkbox"+l.getId()).append(l.getName());var c=u.find("input");c.attr("id","checkbox"+l.getId()),a(l.getId())&&(c.attr("checked","checked"),l.selected=!0,this.plugin.addBaseLayer(l)),c.change(s(l)),t.append(u)}this.config.layers.promote&&this.config.layers.promote.length>0&&this._populateLayerPromotion(t)}},_populateLayerPromotion:function(e){for(var t=this,i=this.instance.getSandbox(),n=i.getRequestBuilder("AddMapLayerRequest"),s=i.getRequestBuilder("RemoveMapLayerRequest"),a=function(e){return function(){var a=jQuery(this),r=a.is(":checked");r?(i.request(t.instance,n(e.getId(),!0)),t.plugin.addBaseLayer(e)):i.request(t.instance,s(e.getId()))}},r=0;r<this.config.layers.promote.length;++r){var o=this.config.layers.promote[r],l=this._getActualPromotionLayers(o.id);if(l.length>0){e.append(o.text);for(var u=0;u<l.length;++u){var c=l[u],h=this.templateTool.clone();h.attr("data-id",c.getId()),h.find("label").attr("for","checkbox"+c.getId()).append(c.getName());var d=h.find("input");d.attr("id","checkbox"+c.getId()),d.change(a(c)),e.append(h)}}}},_getActualPromotionLayers:function(e){for(var t=this.instance.getSandbox(),i=[],n=0;n<e.length;++n)if(!t.isLayerAlreadySelected(e[n])){var s=t.findMapLayerFromAllAvailable(e[n]);s&&i.push(s)}return i}}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.PublisherLayoutForm",function(e,t){this.loc=e,this._publisher=t,this._sandbox=t.instance.sandbox,this._colourSchemePopup=null,this._customColoursPopup=null,this.template={};for(var i in this.__templates)this.template[i]=jQuery(this.__templates[i]);this.values=null,this.initialValues={colours:[{val:"light_grey",bgColour:"#EFF2F2",titleColour:"#333438",headerColour:"#333438",iconCls:"icon-close"},{val:"dark_grey",bgColour:"#424343",titleColour:"#FFFFFF",headerColour:"#424343",iconCls:"icon-close-white"},{val:"blue",bgColour:"#0091FF",titleColour:"#FFFFFF",headerColour:"#0091FF",iconCls:"icon-close-white"},{val:"red",bgColour:"#FF3333",titleColour:"#FFFFFF",headerColour:"#FF3333",iconCls:"icon-close-white"},{val:"green",bgColour:"#26BF4C",titleColour:"#FFFFFF",headerColour:"#48732E",iconCls:"icon-close-white"},{val:"yellow",bgColour:"#FFDE00",titleColour:"#333438",headerColour:"#333438",iconCls:"icon-close"},{val:"custom",bgColour:null,titleColour:null,headerColour:null,iconCls:"icon-close-white"}],fonts:[{name:"Arial (sans-serif)",val:"arial"},{name:"Georgia (serif)",val:"georgia"}],toolStyles:[{val:"rounded-dark",zoombar:{widthPlus:"22px",widthMinus:"22px",widthCenter:"22px",heightPlus:"38px",heightMinus:"39px",heightCenter:12,heightCursor:"18px",widthCursor:"17px"},search:{widthLeft:"17px",widthRight:"32px"}},{val:"rounded-light",zoombar:{widthPlus:"22px",widthMinus:"22px",widthCenter:"22px",heightPlus:"38px",heightMinus:"39px",heightCenter:12,heightCursor:"18px",widthCursor:"17px"},search:{widthLeft:"17px",widthRight:"32px"}},{val:"sharp-dark",zoombar:{widthPlus:"23px",widthMinus:"23px",widthCenter:"23px",heightPlus:"17px",heightMinus:"18px",heightCenter:16,heightCursor:"16px",widthCursor:"23px"},search:{widthLeft:"5px",widthRight:"30px"}},{val:"sharp-light",zoombar:{widthPlus:"23px",widthMinus:"23px",widthCenter:"23px",heightPlus:"17px",heightMinus:"18px",heightCenter:16,heightCursor:"16px",widthCursor:"23px"},search:{widthLeft:"5px",widthRight:"30px"}},{val:"3d-dark",zoombar:{widthPlus:"23px",widthMinus:"23px",widthCenter:"23px",heightPlus:"35px",heightMinus:"36px",heightCenter:13,heightCursor:"13px",widthCursor:"23px"},search:{widthLeft:"5px",widthRight:"44px"}},{val:"3d-light",zoombar:{widthPlus:"23px",widthMinus:"23px",widthCenter:"23px",heightPlus:"35px",heightMinus:"36px",heightCenter:13,heightCursor:"13px",widthCursor:"23px"},search:{widthLeft:"5px",widthRight:"44px"}}]},this.fields={colours:{label:this.loc.layout.fields.colours.label,getContent:this._getColoursTemplate},fonts:{label:this.loc.layout.fields.fonts.label,getContent:this._getFontsTemplate},toolStyles:{label:this.loc.layout.fields.toolStyles.label,getContent:this._getToolStylesTemplate}},this.customColourValues={bg:null,title:null,header:null,iconCsl:null},this.maxColourValue=255,this.minColourValue=0},{__templates:{colours:'<div id="publisher-layout-colours"><label for="publisher-colours"></label><div id="publisher-layout-coloursSelector"><input type="text" name="publisher-colour" disabled /><button id="publisher-colours"></button></div></div>',fonts:'<div id="publisher-layout-fonts"><label for="publisher-fonts"></label><select name="publisher-fonts"></select></div>',toolStyles:'<div id="publisher-layout-toolStyles"><label for="publisher-toolStyles"></label><select name="publisher-toolStyles"></select></div>',option:"<option></option>",inputRadio:'<div><input type="radio" /><label></label></div>',coloursPopup:'<div id="publisher-colour-popup"><div id="publisher-colour-inputs"></div><div id="publisher-colour-preview"></div></div>',customClrs:'<div id="publisher-custom-colours"><div id="publisher-custom-colours-bg"></div><div id="publisher-custom-colours-title"></div><div id="publisher-custom-colours-header"></div><div id="publisher-custom-colours-iconcls"></div></div>',rgbInput:'<div class="rgbInput"><label for="red">R</label><input type="text" name="red" maxlength="3" /><label for="green">G</label><input type="text" name="green" maxlength="3" /><label for="blue">B</label><input type="text" name="blue" maxlength="3" /></div>',iconClsInput:'<div class="iconClsInput"><input type="radio" name="custom-icon-class" value="icon-close" /><label for="icon-close"></label><input type="radio" name="custom-icon-class" value="icon-close-white" /><label for="icon-close-white"></label></div>'},init:function(e){var t,i,n,s=this;e=e||{},this.values={colourScheme:e.colourScheme,font:e.font,toolStyle:e.toolStyle};for(t in this.fields)i=this.fields[t],n=i.getContent.apply(s,arguments),i.content=n},stop:function(){this._closePopups()},getPanel:function(){var e,t,i=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel"),n=i.getContainer();i.setTitle(this.loc.layout.label);for(e in this.fields)t=this.fields[e],n.append(t.content);return i},getValues:function(){var e=jQuery("input[name=publisher-colour]").attr("data-colour-code");this.values.colourScheme=this._getItemByCode(e,this.initialValues.colours),this.values.font=jQuery("select[name=publisher-fonts]").val();var t=jQuery("select[name=publisher-toolStyles]").val();return this.values.toolStyle=this._getItemByCode(t,this.initialValues.toolStyles),this.values},_closePopups:function(){this._colourSchemePopup&&this._colourSchemePopup.close(!0),this._customColoursPopup&&this._customColoursPopup.close(!0),this._colourSchemePopup=null,this._customColoursPopup=null},_getColoursTemplate:function(){var e=this,t=this.template.colours.clone(),i=this.getValues().colourScheme||{},n=this.loc.layout.fields.colours[i.val],s=this.loc.layout.fields.colours.label,a=this.loc.layout.fields.colours.placeholder,r=this.loc.layout.fields.colours.buttonLabel;return t.find("label").html(s),t.find("button").html(r).on("click",function(){e._openColourDialog(jQuery(this))}),t.find("input[name=publisher-colour]").attr("placeholder",a).val(n),t},_getFontsTemplate:function(){var e,t,i,n=this,s=this.template.fonts.clone(),a=this.loc.layout.fields.fonts.label,r=this.initialValues.fonts,o=r.length;for(s.find("label").html(a),t=0;o>t;++t)e=this.template.option.clone(),e.attr({value:r[t].val}).html(r[t].name),s.find("select").append(e);return s.find("select").on("change",function(){i=jQuery(this).val(),n._sendFontChangedEvent(i)}),jQuery(s.find("select option")).filter(function(){return jQuery(this).val()==n.getValues().font}).prop("selected","selected"),s},_getToolStylesTemplate:function(){var e,t,i,n,s,a=this,r=this.template.toolStyles.clone(),o=this.loc.layout.fields.toolStyles.label,l=this.initialValues.toolStyles,u=l.length;for(r.find("label").html(o),i=0;u>i;++i)e=this.template.option.clone(),t=this.loc.layout.fields.toolStyles[l[i].val],e.attr({value:l[i].val}).html(t),r.find("select").append(e);return r.find("select").on("change",function(){n=jQuery(this).val(),s=a._getItemByCode(n,a.initialValues.toolStyles),a._sendToolStyleChangedEvent(s)}),jQuery(r.find("select option")).filter(function(){return a.getValues().toolStyle&&jQuery(this).val()==a.getValues().toolStyle.val}).prop("selected","selected"),r},_openColourDialog:function(){var e,t,i,n,s,a,r=this,o=Oskari.clazz.create("Oskari.userinterface.component.Popup"),l=Oskari.clazz.create("Oskari.userinterface.component.Button"),u=this.loc.layout.popup.title,c=this.template.coloursPopup.clone(),h=this.initialValues.colours,d=h.length;for(l.setTitle(this.loc.layout.popup.close),l.setHandler(function(){o.close(!0),r._colourSchemePopup=null}),c.find("div#publisher-colour-preview").append(r._createGfiPreview()),i=0;d>i;++i)e=this.template.inputRadio.clone(),t=this.loc.layout.fields.colours[h[i].val],e.find("input[type=radio]").attr({id:h[i].val,name:"colour",value:h[i].val}),e.find("label").html(t).attr({"for":h[i].val}),n=r.getValues().colourScheme,(n&&n.val===h[i].val||!n&&"dark_grey"===h[i].val)&&(e.find("input[type=radio]").attr("checked","checked"),r._changeGfiColours(h[i],c)),c.find("div#publisher-colour-inputs").append(e),"custom"===h[i].val&&(a=jQuery("<button>"+this.loc.layout.fields.colours.buttonLabel+"</button>"),a.click(function(){e.find("input[type=radio]").attr("checked","checked"),r._createCustomColoursPopup()}),c.find("div#publisher-colour-inputs").append(a));c.find("input[name=colour]").change(function(){s=r._getItemByCode(jQuery(this).val(),r.initialValues.colours),r._changeGfiColours(s,c),t=r.loc.layout.fields.colours[s.val],jQuery("div.basic_publisher").find("input[name=publisher-colour]").val(t).attr("data-colour-code",s.val),r._sendColourSchemeChangedEvent(s)}),o.show(u,c,[l]),this._colourSchemePopup=o},_createCustomColoursPopup:function(){var e,t=this,i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=Oskari.clazz.create("Oskari.userinterface.component.Button"),s=this.loc.layout.fields.colours.custom,a=this._createCustomColoursInputs(),r=jQuery("div#publisher-colour-inputs input#custom").attr("checked");n.setTitle(this.loc.layout.popup.close),n.setHandler(function(){t._collectCustomColourValues(a),r&&(e=t._getItemByCode("custom",t.initialValues.colours),t._changeGfiColours(e),t._sendColourSchemeChangedEvent(e)),i.close(!0),t._customColoursPopup=null}),i.show(s,a,[n]),this._customColoursPopup=i},_createCustomColoursInputs:function(){var e,t=this,i=this.template.customClrs.clone(),n=this.template.rgbInput.clone(),s=this.loc.layout.fields.colours.customLabels.bgLabel,a=this.template.rgbInput.clone(),r=this.loc.layout.fields.colours.customLabels.titleLabel,o=this.template.rgbInput.clone(),l=this.loc.layout.fields.colours.customLabels.headerLabel,u=this.template.iconClsInput.clone(),c=this.loc.layout.fields.colours.customLabels.iconLabel,h=this.loc.layout.fields.colours.customLabels.iconCloseLabel,d=this.loc.layout.fields.colours.customLabels.iconCloseWhiteLabel;return u.find("label[for=icon-close]").html(h),u.find("label[for=icon-close-white]").html(d),i.find("div#publisher-custom-colours-bg").append(s).append(n),i.find("div#publisher-custom-colours-title").append(r).append(a),i.find("div#publisher-custom-colours-header").append(l).append(o),i.find("div#publisher-custom-colours-iconcls").append(c).append(u),this._prepopulateCustomColoursTemplate(i),i.find("input[type=text]").change(function(){e=jQuery(this).val(),isNaN(e)||e<t.minColourValue?jQuery(this).val(t.minColourValue):e>t.maxColourValue&&jQuery(this).val(t.maxColourValue)}),i},_prepopulateCustomColoursTemplate:function(e){var t=e.find("div#publisher-custom-colours-bg"),i=e.find("div#publisher-custom-colours-title"),n=e.find("div#publisher-custom-colours-header"),s=e.find("div#publisher-custom-colours-iconcls"),a=this.customColourValues;this._prepopulateRgbDiv(t,a.bg),this._prepopulateRgbDiv(i,a.title),this._prepopulateRgbDiv(n,a.header),s.find("input[type=radio]").removeAttr("checked"),s.find("input[value="+a.iconCls+"]").attr("checked","checked")},_collectCustomColourValues:function(e){var t=this._getColourFromRgbDiv(e.find("div#publisher-custom-colours-bg")),i=this._getColourFromRgbDiv(e.find("div#publisher-custom-colours-title")),n=this._getColourFromRgbDiv(e.find("div#publisher-custom-colours-header"));iconCls=e.find("div#publisher-custom-colours-iconcls input[name=custom-icon-class]:checked").val(),customColours=this._getItemByCode("custom",this.initialValues.colours),this.customColourValues.bg=t,this.customColourValues.title=i,this.customColourValues.header=n,this.customColourValues.iconCls=iconCls,customColours.bgColour=this._getCssRgb(t),customColours.titleColour=this._getCssRgb(i),customColours.headerColour=this._getCssRgb(n),customColours.iconCls=iconCls},_prepopulateRgbDiv:function(e,t){t&&(e.find("input[name=red]").val(t.red),e.find("input[name=green]").val(t.green),e.find("input[name=blue]").val(t.blue))},_getColourFromRgbDiv:function(e){var t=e.find("input[name=red]").val(),i=e.find("input[name=green]").val(),n=e.find("input[name=blue]").val();return{red:t,green:i,blue:n}},_getCssRgb:function(e){return"rgb("+e.red+", "+e.green+", "+e.blue+")"},_createGfiPreview:function(){var e=this.loc.layout.popup.gfiDialog.title,t=this.loc.layout.popup.gfiDialog.featureName,i=this.loc.layout.popup.gfiDialog.featureDesc,n=this._publisher.urlBase+Oskari.getLang(),s=jQuery("<div></div>");return header=jQuery('<div class="popupTitle"></div>'),headerWrapper=jQuery('<div class="popupHeader"></div>'),headerCloseButton=jQuery('<div class="olPopupCloseBox icon-close-white" style="position: absolute; top: 12px;"></div>'),contentDiv=jQuery('<div class="popupContent"></div>'),contentWrapper=jQuery('<div class="contentWrapper"></div>'),actionLink=jQuery('<span class="infoboxActionLinks"><a href="#"></a></span>'),actionButton=jQuery('<span class="infoboxActionLinks"><input type="button" /></span>'),contentSeparator=jQuery('<div class="infoboxLine">separator</div>'),popupDataContent=jQuery('<div class="myplaces_wrapper"><div class="myplaces_place"><h3 class="myplaces_header"></h3><p class="myplaces_desc"></p><img class="myplaces_img"></img><a class="myplaces_link"></a></div></div>'),header.append(e),headerWrapper.append(header),headerWrapper.append(headerCloseButton),headerWrapper.css({width:"320px"}),popupDataContent.find("h3.myplaces_header").html(t),popupDataContent.find("p.myplaces_desc").html(i),popupDataContent.find("a.myplaces_link").html(n).attr("href",n),contentDiv.append(popupDataContent),contentDiv.css({"margin-left":"0px",height:"120px"}),contentWrapper.append(contentDiv),contentWrapper.css({width:"320px"}),s.append(headerWrapper).append(contentWrapper),s},_changeGfiColours:function(e,t){t=t||jQuery("div#publisher-colour-popup");var i=t.find("div.popupHeader"),n=t.find("div.popupTitle"),s=t.find("h3.myplaces_header"),a=t.find("div.olPopupCloseBox");i.css({"background-color":e.bgColour}),n.css({color:e.titleColour}),s.css({color:e.headerColour}),a.removeClass("icon-close-white"),a.removeClass("icon-close"),a.addClass(e.iconCls)},_sendColourSchemeChangedEvent:function(e){this._sendEvent("Publisher.ColourSchemeChangedEvent",e)},_sendFontChangedEvent:function(e){this._sendEvent("Publisher.FontChangedEvent",e)},_sendToolStyleChangedEvent:function(e){this._sendEvent("Publisher.ToolStyleChangedEvent",e)},_sendEvent:function(e,t){var i,n=this._sandbox.getEventBuilder(e);n&&(i=n(t),this._sandbox.notifyAll(i))},_getItemByCode:function(e,t){var i,n=t.length;for(i=0;n>i;++i)if(t[i].val===e)return t[i];return null}}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.request.PublishMapEditorRequest",function(e){this._viewData=e},{__name:"Publisher.PublishMapEditorRequest",getName:function(){return this.__name},getEditMap:function(){return this._viewData}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.request.PublishMapEditorRequestHandler",function(e){this.instance=e},{handleRequest:function(e,t){this.instance.publishId=t.getEditMap().id,this.instance.setPublishMode(!0,this.instance.getLayersWithoutPublishRights(),t.getEditMap()),this._showEditNotification()},_showEditNotification:function(){var e=this.instance.getLocalization("edit"),t=Oskari.clazz.create("Oskari.userinterface.component.Popup");t.show(e.popup.title,e.popup.msg),t.fadeout()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.coordinatedisplay.CoordinateDisplayBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.coordinatedisplay.CoordinateDisplayBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/plugin/CoordinatesPlugin.js"},{type:"text/css",src:"../../../../resources/framework/bundle/coordinatedisplay/css/coordinatedisplay.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/coordinatedisplay/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"coordinatedisplay","Bundle-Name":"coordinatedisplay","Bundle-Author":[{Name:"ah",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("coordinatedisplay","Oskari.mapframework.bundle.coordinatedisplay.CoordinateDisplayBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.coordinatedisplay.CoordinateDisplayBundleInstance",function(){this.sandbox=null,this.started=!1,this._localization=null},{__name:"coordinatedisplay",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},update:function(){},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=e.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.setSandbox(n);var s=n.findRegisteredModuleInstance("MainMapModule"),t={},a=this.getLocalization("display"),r=Oskari.clazz.create("Oskari.mapframework.bundle.coordinatedisplay.plugin.CoordinatesPlugin",t,a);s.registerPlugin(r),s.startPlugin(r),this.plugin=r}},stop:function(){this.sandbox=null,this.started=!1}},{protocol:["Oskari.bundle.BundleInstance"]}),Oskari.clazz.define("Oskari.mapframework.bundle.coordinatedisplay.plugin.CoordinatesPlugin",function(e,t){this._conf=e,this._locale=t,this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._elements={},this.__templates={}},{__name:"CoordinatesPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this.__templates.latlondiv=jQuery('<div class="mapplugin cbDiv"> <div class="cbSpansWrapper"> <div class="cbRow">  <div class="cbCrsLabel"></div> </div> <div class="cbRow">  <div class="cbLabel cbLabelN" axis="lat"></div>  <div class="cbValue" axis="lat"></div> </div>  <br clear="both"> <div class="cbRow">  <div class="cbLabel cbLabelE" axis="lon"></div>  <div class="cbValue" axis="lon"></div> </div> </div></div>')},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this),this._createUI();for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);this._elements.display&&(this._elements.display.remove(),delete this._elements.display),e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},_createUI:function(){this._sandbox;var e=this,t=jQuery(this._map.div),i=e._elements.display;e._elements.display||(i=e._elements.display=e.__templates.latlondiv.clone());var n=e._map.getProjection(),s=e._locale.crs[n];i.find(".cbCrsLabel").html(s),i.find(".cbLabelN").html(e._locale.compass.N),i.find(".cbLabelE").html(e._locale.compass.E),i.mousedown(function(e){e.stopPropagation()}),t.append(i),this.update(),i.show()},update:function(e){if(!e||!e.latlon){var t=this._sandbox.getMap();e={latlon:{lat:t.getY(),lon:t.getX()}}}var i=this,n=e.latlon,s=i._elements.display,a=s.find('.cbValue[axis="lat"]'),r=s.find('.cbValue[axis="lon"]');a&&r&&(a.text(n.lat),r.text(n.lon))},eventHandlers:{MouseHoverEvent:function(e){this.update({latlon:{lat:Math.floor(e.getLat()),lon:Math.floor(e.getLon())}})},AfterMapMoveEvent:function(){this.update()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.maplegend.MapLegendBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.maplegend.MapLegendBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/Tile.js"},{type:"text/css",src:"../../../../resources/framework/bundle/maplegend/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/maplegend/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"maplegend","Bundle-Name":"maplegend","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("maplegend","Oskari.mapframework.bundle.maplegend.MapLegendBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.maplegend.MapLegendBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null},{__name:"maplegend",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);var s=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,s),e.createUi(),n.registerAsStateful(this.mediator.bundleId,this)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(){this.plugins["Oskari.userinterface.Flyout"].refresh()},AfterMapLayerAddEvent:function(){this.plugins["Oskari.userinterface.Flyout"].refresh()},AfterChangeMapLayerStyleEvent:function(){this.plugins["Oskari.userinterface.Flyout"].refresh()},AfterRearrangeSelectedMapLayerEvent:function(){this.plugins["Oskari.userinterface.Flyout"].refresh()}},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.maplegend.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.maplegend.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setContentState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getContentState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.maplegend.Flyout",function(e){this.instance=e,this.container=null,this.templateLayer=null,this.templateLayerLegend=null,this.state=null},{getName:function(){return"Oskari.mapframework.bundle.maplegend.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("maplegend")||jQuery(this.container).addClass("maplegend")},startPlugin:function(){var e=this;e.templateLayer=jQuery('<div class="maplegend-layer"><div class="maplegend-tools"><div class="layer-description"><div class="icon-info"></div></div></div></div>'),e.templateLayerLegend=jQuery('<div class="maplegend-legend"><img /></div>')},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},setContentState:function(){},getContentState:function(){return{}},createUi:function(){this.refresh()},refresh:function(){this._populateLayerList()},_populateLayerList:function(){var e=this,t=jQuery(this.container);t.empty();var i=Oskari.clazz.create("Oskari.userinterface.component.Accordion");i.insertTo(t);for(var n=this.instance.getSandbox(),s=n.findAllSelectedMapLayers().slice(0),a=s.length-1;a>=0;a--){var r=s[a];r.getName(),this._createLayerContainer(r);var o=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");o.open(),o.setTitle(r.getName()),o.getContainer().append(e._createLayerContainer(r)),i.addPanel(o)}},_createLayerContainer:function(e){var t=this,i=t.instance.getSandbox(),n=this.templateLayer.clone(),s={},a=t._createLegendDiv(e,s);a&&n.append(a);var r=e.getSubLayers?e.getSubLayers():null;if(r)for(var o=0;o<r.length;o++){var l=r[o],u=t._createLegendDiv(l,s);u&&n.append(u)}var c=e.getMetadataIdentifier(),h=n.find(".maplegend-tools");return c?h.find("div.icon-info").bind("click",function(){var e="catalogue.ShowMetadataRequest";i.postRequestByName(e,[{uuid:c}])}):h.find("div.layer-description").hide(),n},_createLegendDiv:function(e,t){var i=this,n=e.getLegendImage?e.getLegendImage():null;if(n&&""!=n&&!t[n]){var s=i.templateLayerLegend.clone(),a=s.find("img");t[n]=!0;var r=new Image;return r.onload=function(){a.attr("src",n),r.onload=null},r.src=n,s}}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.maplegend.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.maplegend.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.UserGuideBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.userguide.UserGuideBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/request/ShowUserGuideRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/request/ShowUserGuideRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/service/UserGuideService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/Tile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/Flyout.js"},{type:"text/css",src:"../../../../resources/framework/bundle/userguide/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/userguide/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"userguide","Bundle-Name":"userguide","Bundle-Tag":{mapframework:!0},"Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"userguide",Title:"userguide"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("userguide","Oskari.mapframework.bundle.userguide.UserGuideBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.UserGuideBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.ui=null,this._requestHandlers={},this.attachedToDefault=!1,this.helper=null,this.isContentLoaded=!1
},{templates:{userguide:'<div class="oskari-userguide"><span class="oskari-prompt"></span><br /></div>'},__name:"userinterface.UserGuide",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,this._localization=Oskari.getLocalization(this.getName());var s=this.getLocalization("title"),a=Oskari.clazz.create("Oskari.userinterface.component.Popover",s,"");this.ui=a,a.setContent($(this.templates.userguide)),n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);this._requestHandlers["userguide.ShowUserGuideRequest"]=Oskari.clazz.create("Oskari.mapframework.bundle.userguide.request.ShowUserGuideRequestHandler",n,this),n.addRequestHandler("userguide.ShowUserGuideRequest",this._requestHandlers["userguide.ShowUserGuideRequest"]);var r=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,r),e.createUi();var o=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",n);this.helper=o}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{"userinterface.ExtensionUpdatedEvent":function(e){var t=this;if(e.getExtension().getName()==t.getName()){var i="close"!=e.getViewState();t.displayContent(i)}}},displayContent:function(e){var t=this;if(e&&!t.isContentLoaded){var i="help.contentPart";t.getLocalization("help")&&t.getLocalization("help").contentPart&&(i=t.getLocalization("help").contentPart);var n="help.tags";this.getLocalization("help")&&this.getLocalization("help").tags&&(n=this.getLocalization("help").tags),this.helper.getHelpArticle(n,function(e,n){var s=n,a="error.generic";t.getLocalization("error")&&t.getLocalization("error").generic&&(a=t.getLocalization("error").generic),e?s[i]&&(s=s[i]):s=a,t.plugins["Oskari.userinterface.Flyout"].setContent(s),t.isContentLoaded=!0})}},toggleUserInterface:function(e,t){var i=this,n=this.ui;if(e){if(!i.attachedToDefault){var t=i.plugins["Oskari.userinterface.Tile"].getEl();n.setPlacement("right"),n.attachTo(t),i.attachedToDefault=!0}n.show()}else n.hide()},scheduleShowUserGuide:function(e){var t=this,i=t.ui,n=e.isToggle();if(n&&i.shown)return t.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[this,"close"]),void 0;t.getSandbox().postRequestByName("userinterface.UpdateExtensionRequest",[this,"attach"]);var s=jQuery(this.templates.userguide),a=jQuery("<div />"),r=Oskari.getLang(),o=a.clone(),l=e.getContent();if(l)s.append(l);else{o.append("Lang: "+r),s.append(o);var o=a.clone();o.append("Extension: "+e.getExtension()),s.append(o);var o=a.clone();o.append("Context: "+e.getContext()),s.append(o);var o=a.clone();o.append("Element: "+(e.getEl()?"YES":"NO")),s.append(o)}var u=e.getEl(),c=e.getPlacement();c&&i.setPlacement(c),u?(i.hide(),t.attachedToDefault=!1,i.attachTo(u)):t.attachedToDefault||(u=t.plugins["Oskari.userinterface.Tile"].getEl(),i.attachTo(u),t.attachedToDefault=!0),i.setContent(s)},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.removeRequestHandler("userguide.ShowUserGuideRequest",this._requestHandlers["userguide.ShowUserGuideRequest"]);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.userguide.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.userguide.Tile",this,this.getLocalization("tile"))},stopExtension:function(){this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Tile"].refresh(),this.plugins["Oskari.userinterface.Flyout"].setContent("")}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.request.ShowUserGuideRequest",function(e){var t=e||{};this._creator=null,this._el=t.el,this._context=t.context,this._extension=t.extension,this._toggle=t.toggle,this._placement=t.placement,this._content=t.content},{__name:"userguide.ShowUserGuideRequest",getName:function(){return this.__name},getUuid:function(){return this._uuid},getContext:function(){return this._context},getExtension:function(){return this._extension},getEl:function(){return this._el},isToggle:function(){return this._toggle},getPlacement:function(){return this._placement},getContent:function(){return this._content}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.request.ShowUserGuideRequestHandler",function(e,t){this.sandbox=e,this.instance=t},{handleRequest:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.userguide.request.ShowUserGuideRequestHandler] Show UserGuide: "+t.getUuid()),this.instance.scheduleShowUserGuide(t)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.Tile",function(e,t){this.instance=e,this.locale=t,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.userguide.Tile"},setEl:function(e){this.container=jQuery(e),this.container.children(".oskari-tile-status")},getEl:function(){return this.container},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){return this.locale.desciption},getOptions:function(){},refresh:function(){var e=this,t=e.instance;this.container,this.template,t.getSandbox()}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.userguide.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.userguide.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("userguide")||jQuery(this.container).addClass("userguide")},startPlugin:function(){this.template=jQuery('<div class="userguide"></div>')},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},getState:function(){return this.state?this.state:{}},setContent:function(e){var t=this;t.instance.getSandbox();var i=jQuery(this.container);i.empty();var n=this.template.clone();n.append(e),i.append(n)}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.MetadataFlyoutBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.MetadataFlyoutBundleInstance")},start:function(){},stop:function(){},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/instance.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/service/MetadataLoader.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/view/MetadataPage.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/Tile.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/request/ShowMetadataRequest.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/request/ShowMetadataRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/plugin/MetadataLayerPlugin.js"},{type:"text/css",src:"../../../../resources/catalogue/bundle/metadataflyout/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/locale/fi.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/locale/en.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/catalogue/bundle/metadataflyout/locale/sv.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"metadataflyout","Bundle-Name":"catalogue.bundle.metadataflyout","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012",End:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("metadataflyout","Oskari.catalogue.bundle.metadataflyout.MetadataFlyoutBundle"),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.MetadataFlyoutBundleInstance",function(){this.map=null,this.core=null,this.sandbox=null,this.mapmodule=null,this.started=!1,this.plugins={},this._locale=null,this._requestHandlers={},this.loader=null,this.layerPlugin=null,this.layer=null},{__name:"catalogue.bundle.metadataflyout",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocale:function(){return this._locale},getLoader:function(){return this.loader},layerSpec:{text:"",name:"Metadata",wmsName:"1",type:"vectorlayer",styles:{title:"Trains",legend:"",name:"1"},descriptionLink:"",orgName:"Metadata",inspire:"Metadata",legendImage:"",info:"",isQueryable:!0,formats:{value:"text/html"},id:"catalogue_metadataflyout_layer",minScale:36e6,maxScale:1,style:"",dataUrl:"",wmsUrl:"x",opacity:60,checked:"false",styledLayerDescriptor:'<StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"     xmlns="http://www.opengis.net/sld"     xmlns:ogc="http://www.opengis.net/ogc"     xmlns:xlink="http://www.w3.org/1999/xlink"     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">   <NamedLayer>     <Name>Simple point with stroke</Name>    <UserStyle><Title>GeoServer SLD Cook Book: Simple point with stroke</Title>     <FeatureTypeStyle><Rule><PolygonSymbolizer> <Graphic><Mark><WellKnownName>circle</WellKnownName><Fill>        <CssParameter name="fill">#000040</CssParameter>       </Fill><Stroke>          <CssParameter name="stroke">#000040</CssParameter>           <CssParameter name="stroke-width">2</CssParameter>          </Stroke></Mark><Size>12</Size></Graphic>     </PolygonSymbolizer><TextSymbolizer><Label><ogc:PropertyName>title</ogc:PropertyName></Label><Fill><CssParameter name="fill">#000000</CssParameter></Fill></TextSymbolizer></Rule></FeatureTypeStyle></UserStyle></NamedLayer></StyledLayerDescriptor>'},start:function(){if(!this.started){this.started=!0,this._locale=Oskari.getLocalization(this.getName());var e=this.conf,t=(e?e.sandbox:null)||"sandbox",i=Oskari.getSandbox(t);this.sandbox=i,this.loader=Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.service.MetadataLoader",this.getLocale().loader,i),i.register(this);for(s in this.eventHandlers)i.registerForEventByName(this,s);this._requestHandlers["catalogue.ShowMetadataRequest"]=Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.request.ShowMetadataRequestHandler",i,this),i.addRequestHandler("catalogue.ShowMetadataRequest",this._requestHandlers["catalogue.ShowMetadataRequest"]);var n={};for(var s in this.layerSpec)n[s]=this.layerSpec[s];var a=this.getLocale().layer;for(var s in a)n[s]=a[s];var r=i.getService("Oskari.mapframework.service.MapLayerService"),o=r.createMapLayer(n);r.addLayer(o,!0),this.layer=o;var l=i.findRegisteredModuleInstance("MainMapModule"),u=Oskari.clazz.create("Oskari.mapframework.mapmodule.MetadataLayerPlugin");u.setMapLayer(o),l.registerPlugin(u),l.startPlugin(u),this.layerPlugin=u;var c=i.getRequestBuilder("userinterface.AddExtensionRequest")(this);i.request(this,c),i.registerAsStateful(this.mediator.bundleId,this)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerAddEvent:function(){},AfterMapLayerRemoveEvent:function(){},AfterMapMoveEvent:function(){}},stop:function(){var e=this.sandbox;e.removeRequestHandler("catalogue.ShowMetadataRequest",this._requestHandlers["catalogue.ShowMetadataRequest"]);for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},setSandbox:function(){this.sandbox=null},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.Flyout",this,this.getLocale().flyout,this.getLoader())},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null},getTitle:function(){return this.getLocale().title},getDescription:function(){return"Sample"},getPlugins:function(){return this.plugins},scheduleShowMetadata:function(e){this.plugins["Oskari.userinterface.Flyout"].scheduleShowMetadata(e),this.getSandbox().requestByName(this,"userinterface.UpdateExtensionRequest",[this,"detach"])},showExtentOnMap:function(e,t,i){var n=this;if(t){for(var s=[],a=0;a<t.length;a++){var r=t[a],o=new OpenLayers.Bounds(r.westBoundLongitude,r.southBoundLatitude,r.eastBoundLongitude,r.northBoundLatitude),l=o.toGeometry(),u=new OpenLayers.Feature.Vector(l);u.attributes=i||u.attributes,s.push(u)}var c=n.getSandbox().getEventBuilder("FeaturesAvailableEvent")(this.layer,s,"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");n.sandbox.notifyAll(c)}},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setContentState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getContentState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.service.MetadataLoader",function(e,t){this.urls=e,this.sandbox=t,this.dev=!1},{getURLForView:function(e,t){var i=this.urls[e],n=i+"uuid="+t;if(this.dev){var s={"abstract":"abstract",jhs:"jhs158",inspire:"inspire",json:"json"}[e];null!=s&&(n=s)}return n},loadMetadata:function(e,t,i,n,s,a){var r=this.getURLForView(e,t,i,n);this.sandbox.printDebug("loadMetadata "+r),null!=r&&jQuery.ajax({url:r,dataType:a||"xml",beforeSend:function(e){e&&e.overrideMimeType&&(a&&"json"==a?e.overrideMimeType("application/json"):e.overrideMimeType("text/html"))},success:function(e){s(e,!0)},error:function(){s(null,!1)}})},loadGeonetworkAjaxHTML:function(e,t,i,n,s){var a=this.getURLForView(t,i,n,s);OpenLayers.Request.GET({url:a,callback:e})},openMetadata:function(e,t,i,n,s,a,r){var o=this.getURLForView(e,t,i,n);this.sandbox.printDebug("openMetadata "+o),window.open(o,r,"resizable=yes,scrollbars=yes,status=yes")}}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.view.MetadataPage",function(e,t){this.instance=e,this.locale=t,this.container=null,this.views={},this.titles={},this.tabs={},this.browseGraphic=null,this.compileTemplates(),this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert"),this.state=null,this.contentState={title:"...",metadata:{uuid:null,RS_Identifier_Code:null,RS_Identifier_CodeSpace:null},view:"abstract",metadataJson:null},this.panel=null},{getPanel:function(){return this.panel},compileTemplates:function(){},templates:{content:"<div class='metadataflyout_content'></div>",browseGraphic:"<div class='metadataflyout_content_browseGraphic'></div>",viewTabs:"<div class='metadataflyout_content_tabs'></div>",viewTab:"<div class='metadataflyout_content_tab'></div>",titles:{"abstract":"<div class='metadataflyout_content_abstract_title'></div>",jhs:"<div class='metadataflyout_content_jhs_title'></div>",inspire:"<div class='metadataflyout_content_inspire_title'></div>"},views:{"abstract":"<div class='metadataflyout_content_abstract'></div>",jhs:"<div class='metadataflyout_content_jhs'></div>",inspire:"<div class='metadataflyout_content_inspire'></div>"}},init:function(){this.container=jQuery("<div />");var e=this.locale,t=jQuery(this.templates.content),i=this,n=jQuery(this.templates.viewTabs),s=jQuery(this.templates.viewTab);for(var a in this.templates.views){var r=n.clone(),o=e.tabs[a];for(var l in o){var u=s.clone();if("string"==typeof o[l])u.append(o[l]),r.append(u),l!=a&&u.click({viewId:l},function(e){var t=e.data;i.showMetadataView(t.viewId)});else{var c=o[l].text,h=o[l].target;u.append(c),r.append(u),u.click({viewId:l,target:h},function(e){var t=e.data;i.openMetadataView(t.viewId,t.target)})}}r.hide(),this.tabs[a]=r,t.append(r)}var d=jQuery(this.templates.browseGraphic);this.browseGraphic=d,t.append(d);for(var a in this.templates.views)this.titles[a]=jQuery(this.templates.titles[a]),this.titles[a].append(this.locale[a]),this.views[a]=jQuery(this.templates.views[a]),t.append(this.titles[a]),t.append(this.views[a]);t.append(n),this.alert.insertTo(this.container),this.container.append(t);var p=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");p.setTitle(this.contentState.title);var f=p.getContainer();f.append(this.container),this.panel=p},destroy:function(){this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){},getOptions:function(){},setState:function(e){this.state=e},openMetadataView:function(e,t){if(this.contentState){var i=this.contentState.metadata;this.instance.getLoader().openMetadata(e,i.uuid,i.RS_Identifier_Code,i.RS_Identifier_CodeSpace,function(){},null,t)}},showMetadataView:function(e){this.instance.getSandbox().printDebug("ShowMetadataView "+e);var t=this.tabs,i=this.views,n=this.titles;for(var s in i)s!=e?(t[s].hide(),n[s].hide(),i[s].hide()):(t[s].show(),n[s].show(),i[s].hide());this.contentState.view=e,this.loadMetadataForState()},resetBrowseGraphic:function(e){var t=jQuery(this.browseGraphic);t.empty(),e&&t.append(e)},loadMetadataForState:function(){function e(e){var s=jQuery("<div />");s.html(e.responseText),jQuery.each(s.find("td.metadataContent"),function(e,i){var n=jQuery(i),s=n.parent(),a=jQuery('<td class="metadataContent"/>');n.hasClass("MD_DigitalTransferOptions")&&a.addClass("MD_DigitalTransferOptions");var r=n.text().split(".\n");jQuery.each(r,function(e,t){var i=jQuery.trim(t);if(0!=i.length){var n=jQuery('<div class="metadataflyout_content_section"/>');r.length>1?n.text(i+"."):n.text(i),a.append(n)}}),n.remove(),s.append(a),t._linkify(a)});var a=s.find("a[href]"),r=new RegExp("^\\?.*");jQuery.each(a,function(e,i){var s=jQuery(i),a=s.attr("href");if(a&&r.test(a)){var o=a.split("&"),l={};jQuery.each(o,function(e,t){var i=t.split("=");l[i[0]]=i[1]}),s.attr("href",null),s.click({viewId:n,uuid:l.uuid},function(e){var i=e.data,n=i.uuid;t.showMetadata(n)})}}),i[n].append(s),i[n].css("display",""),t._updatePanel()}var t=this,i=this.views;if(!this.contentState||!this.contentState.metadata||!this.contentState.metadata.uuid)return!1;var n=this.contentState.view,s=this.contentState.metadata;i[n].empty(),t.instance.getLoader().loadGeonetworkAjaxHTML(e,n,s.uuid,s.RS_Identifier_Code,s.RS_Identifier_CodeSpace)},_updatePanel:function(){var e=this,t=e.contentState.metadataJson;if(t){var i=t.title;i&&this.panel.setTitle(i)}},loadMetadataJSONForState:function(){var e=this;if(!this.contentState||!this.contentState.metadata||!this.contentState.metadata.uuid)return!1;var t=this.contentState.metadata;return this.instance.getLoader().loadMetadata("json",t.uuid,t.RS_Identifier_Code,t.RS_Identifier_CodeSpace,function(t){if(t&&t.mdcs&&t.mdcs.length&&0!=t.mdcs.length){var i=t.mdcs[0];e.processJSON(i)}},"json"),!0},processJSON:function(e){var t=this,i=e.browseGraphic,n=e.env;if(this.resetBrowseGraphic(),i){var s=jQuery("<img />"),a=null;a=this.instance.getLoader().dev?"espoo_johtokartta_s.png":i;var r=new Image;r.onload=function(){s.attr("src",a),r.onload=null},r.src=a,this.resetBrowseGraphic(s)}n&&this.instance.showExtentOnMap(this.contentState.metadata.uuid,n,e),t.contentState.metadataJson=e,t._updatePanel()},resetContentState:function(){},showMetadata:function(e,t,i){this.resetContentState(),this.contentState.metadata.uuid=e,this.contentState.metadata.RS_Identifier_Code=t,this.contentState.metadata.RS_Identifier_CodeSpace=i,this.instance.getSandbox().printDebug("showMetadata { uuid="+e+", view="+this.contentState.view+"}"),this.loadMetadataJSONForState(),this.showMetadataView(this.contentState.view)},scheduleShowMetadata:function(e,t,i){this.showMetadata(e,t,i)},_linkify:function(e){var t=e.html(),i=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,n=t.replace(i,'<a href="$1" target="_blank">$1</a>'),s=/(^|[^\/])(www\.[\S]+(\b|$))/gim;n=n.replace(s,'$1<a href="http://$2" target="_blank">$2</a>'),e.html(n)}},{}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.Flyout",function(e,t){this.instance=e,this.locale=t,this.container=null,this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert"),this.accordion=null,this.pages={}},{getName:function(){return"Oskari.catalogue.bundle.metadataflyout.Flyout"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.locale;var e=Oskari.clazz.create("Oskari.userinterface.component.Accordion");this.accordion=e,e.insertTo(this.container)},stopPlugin:function(){for(p in this.pages)this.pages[p].destroy(),delete this.pages[p];this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){},getOptions:function(){},setState:function(e){this.state=e},scheduleShowMetadata:function(e){var t=this.accordion;for(p in this.pages){var i=this.pages[p];i&&(this.pages[p]=null,i.page.destroy(),t.removePanel(i.panel))}for(var n=0;n<e.length;n++){var s=e[n],a=Oskari.clazz.create("Oskari.catalogue.bundle.metadataflyout.view.MetadataPage",this.instance,this.locale);a.init();var r=a.getPanel();t.addPanel(r),0==n&&r.open(),this.pages[s.uuid||s.RS_Identifier_CodeSpace+":"+s.RS_Identifier_Code]={page:a,panel:r,data:s}}for(p in this.pages){var i=this.pages[p];if(i){var s=i.data,a=i.page;a.scheduleShowMetadata(s.uuid,s.RS_Identifier_Code,s.RS_Identifier_CodeSpace)}}},setContentState:function(e){this.contentState=e},getContentState:function(){return this.contentState},resetContentState:function(){this.contentState={}}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.Tile",function(e,t){this.instance=e,this.locale=t,this.container=null,this.template=null},{getName:function(){return"Oskari.catalogue.bundle.metadataflyout.Tile"},setEl:function(e){this.container=$(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){},getOptions:function(){},setState:function(e){this.state=e},refresh:function(){var e=this,t=e.instance;this.container,this.template,t.getSandbox()}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.request.ShowMetadataRequest",function(e,t){if(this._creator=null,this._uuid=e.uuid,this._RS_Identifier_Code=e.RS_Identifier_Code,this._RS_Identifier_CodeSpace=e.RS_Identifier_CodeSpace,this._additionalMetadata=t,this._allMetadata=[],this._allMetadata.push(e),t){this._additionalMetadata=t;for(var i=0;i<t.length;i++)this._allMetadata.push(t[i])}},{__name:"catalogue.ShowMetadataRequest",getName:function(){return this.__name},getUuid:function(){return this._uuid},getRS_Identifier_Code:function(){return this._RS_Identifier_Code},getRS_Identifier_CodeSpace:function(){return this._RS_Identifier_CodeSpace},getAdditionalMetadata:function(){return this._additionalMetadata},getAllMetadata:function(){return this._allMetadata}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.catalogue.bundle.metadataflyout.request.ShowMetadataRequestHandler",function(e,t){this.sandbox=e,this.instance=t},{handleRequest:function(e,t){this.instance.scheduleShowMetadata(t.getAllMetadata())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.mapmodule.MetadataLayerPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._layer=null,this._supportedFormats={},this._features=null,this._sldFormat=new OpenLayers.Format.SLD({multipleSymbolizers:!1,namedLayersAsArray:!0})},{__name:"MetadataLayerPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},register:function(){this.getMapModule().setLayerPlugin("metadatalayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("metadatalayer",null)},init:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),this.registerVectorFormats(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){},eventHandlers:{AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this.afterMapLayerRemoveEvent(e)},FeaturesAvailableEvent:function(e){this.handleFeaturesAvailableEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this.afterChangeMapLayerOpacityEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){for(var t=this.getMapLayer(),i=this._sandbox,n=0;n<e.length;n++){var s=e[n],a=s.getId();s.isLayerOfType("VECTOR")&&t.getId()==s.getId()&&(i.printDebug("preselecting "+a),this.addMapLayerToMap(s,!0,s.isBaseLayer()))}},setMapLayer:function(e){this._layer=e},getMapLayer:function(){return this._layer},registerVectorFormat:function(e,t){this._supportedFormats[e]=t},registerVectorFormats:function(){this.registerVectorFormat("application/json",new OpenLayers.Format.GeoJSON({})),this.registerVectorFormat("application/nlsfi-x-openlayers-feature",new function(){this.read=function(e){return e}})},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.removeMapLayerFromMap(t)},afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer(),i=this.getMapLayer();if(t.isLayerOfType("VECTOR")&&t.getId()==i.getId()){this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var n=this._map.getLayersByName("layer_"+t.getId());null!=n[0]&&n[0].setOpacity(t.getOpacity()/100)}},addMapLayerToMap:function(e,t){var i=this.getMapLayer();if(e.isLayerOfType("VECTOR")&&e.getId()==i.getId()){var n=this._map.getLayersByName("Markers");this._map.removeLayer(n[0],!1);var s=new OpenLayers.StyleMap,a={styleMap:s},r=e.getStyledLayerDescriptor();if(r){this._sandbox.printDebug(r);var o=this._sldFormat.read(r);window.styleInfo=o;var l=o.namedLayers[0].userStyles,u=l[0];s.styles["default"]=u}else this._sandbox.printDebug("NO SLD FOUND");var c=new OpenLayers.Layer.Vector("layer_"+e.getId(),a);c.opacity=e.getOpacity()/100,this._map.addLayer(c),this._features&&c.addFeatures(this._features),this._sandbox.printDebug("#!#! CREATED VECTOR / OPENLAYER.LAYER.VECTOR for "+e.getId()),t?this._map.setLayerIndex(c,this._map.layers.length):this._map.setLayerIndex(c,0),this._map.addLayer(n[0])}},removeMapLayerFromMap:function(e){var t=this.getMapLayer();if(e.isLayerOfType("VECTOR")&&e.getId()==t.getId()){var i=this._map.getLayersByName("layer_"+e.getId());i[0].destroy()}},getOLMapLayers:function(e){if(e.isLayerOfType("VECTOR")){var t=this.getMapLayer();if(e.getId()==t.getId())return this._map.getLayersByName("layer_"+e.getId())}},handleFeaturesAvailableEvent:function(e){var t=e.getMapLayer();if(null!=t){var i=this.getMapLayer();if(t.getId()==i.getId()){var n=e.getMimeType(),s=e.getFeatures(),a=e.getOp(),r=this._supportedFormats[n];if(r){var o=r.read(s);this._features=o;var l=this._map.getLayersByName("layer_"+t.getId())[0];l&&(a&&"replace"==a&&l.removeFeatures(l.features),l.addFeatures(o))}}}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.FeatureDataBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.FeatureDataBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/PopupHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/plugin/MapSelectionPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/event/FinishedDrawingEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/event/AddedFeatureEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/plugin/FeaturedataPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/service/GridJsonService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/service/GridModelManager.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/domain/WfsGridUpdateParams.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/request/ShowFeatureDataRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/request/ShowFeatureDataRequestHandler.js"},{type:"text/css",src:"../../../../resources/framework/bundle/featuredata/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/featuredata/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"featuredata","Bundle-Name":"featuredata","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("featuredata","Oskari.mapframework.bundle.featuredata.FeatureDataBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.FeatureDataBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.popupHandler=null,this.selectionPlugin=null,this.geometry=null},{__name:"FeatureData",getName:function(){return this.__name
},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,n.register(e);for(var s in e.eventHandlers)n.registerForEventByName(e,s);var a=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,a),e.createUi();var r=this.getLocalization("popup");if(this.conf&&this.conf.selectionTools===!0){this.popupHandler=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.PopupHandler",this);var o=n.getRequestBuilder("Toolbar.AddToolButtonRequest"),l={iconCls:"tool-feature-selection",tooltip:r.tools.select.tooltip,sticky:!1,callback:function(){e.popupHandler.showSelectionTools()}};n.request(this,o("dialog","selectiontools",l))}for(var u=n.findAllSelectedMapLayers(),c=0;c<u.length;++c)u[c].isLayerOfType("WFS")&&(this.plugin.update(),this.plugins["Oskari.userinterface.Flyout"].layerAdded(u[c]));n.addRequestHandler("ShowFeatureDataRequest",this.requestHandlers.showFeatureHandler)}},init:function(){var e=this;return this.requestHandlers={showFeatureHandler:Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.request.ShowFeatureDataRequestHandler",e)},this.service=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.service.GridJsonService",this.sandbox.getAjaxUrl()),null},getService:function(){return this.service},getSelectionPlugin:function(){return this.selectionPlugin},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(e){e.getMapLayer().isLayerOfType("WFS")&&(this.plugin.update(),this.plugins["Oskari.userinterface.Flyout"].layerRemoved(e.getMapLayer()))},AfterMapLayerAddEvent:function(e){e.getMapLayer().isLayerOfType("WFS")&&(this.plugin.update(),this.plugins["Oskari.userinterface.Flyout"].layerAdded(e.getMapLayer()))},AfterMapMoveEvent:function(){this.setGeometry(null);var e=this.getSelectionPlugin().getFullScreenSelection();this.plugins["Oskari.userinterface.Flyout"].updateGrid(e)},WFSFeaturesSelectedEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].featureSelected(e)},"userinterface.ExtensionUpdatedEvent":function(e){var t=this.plugins["Oskari.userinterface.Flyout"];if(e.getExtension().getName()===this.getName())if("close"===e.getViewState())this.setGeometry(null),t.setEnabled(!1);else if(!t.isEnabled()){var i=this.geometry;i?this.setGeometry(null):i=this.getSelectionPlugin().getFullScreenSelection(),t.setEnabled(!0,i)}}},setGeometry:function(e){this.geometry=e},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.Flyout",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi();var e=this.sandbox.findRegisteredModuleInstance("MainMapModule"),t=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.plugin.FeaturedataPlugin",{instance:this});e.registerPlugin(t),e.startPlugin(t),this.plugin=t;var i={id:"FeatureData"};this.selectionPlugin=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.plugin.MapSelectionPlugin",i),e.registerPlugin(this.selectionPlugin),e.startPlugin(this.selectionPlugin)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.PopupHandler",function(e){this.instance=e,this.localization=e.getLocalization("popup"),this.templateContent=jQuery("<div></div>"),this.templateEditDialogContent=jQuery("<div></div>"),this.templateEditButtons=jQuery("<div></div>"),this.templateToolsButton=jQuery('<div style= "display: inline-block; border: 1px solid;"></div>'),this.templateInstructions=jQuery("<div class='instructions' style= 'padding: 20px 0px 0px 0px;'></div>"),this.templateLink=jQuery("<div class='link'><a href='JavaScript:void(0);'></a></div></div>");var t=this,i=t.instance.getSelectionPlugin();this.buttons={point:{iconCls:"selection-point",tooltip:t.localization.tools.point.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"point"})}},line:{iconCls:"selection-line",tooltip:t.localization.tools.line.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"line"})}},polygon:{iconCls:"selection-area",tooltip:t.localization.tools.polygon.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"polygon"})}},square:{iconCls:"selection-square",tooltip:t.localization.tools.square.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"square"})}},circle:{iconCls:"selection-circle",tooltip:t.localization.tools.circle.tooltip,sticky:!1,callback:function(){i.startDrawing({drawMode:"circle"})}}}},{showSelectionTools:function(){var e=this;e.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e.instance,"close"]);var t=function(t){return function(){e.buttons[t].callback(),i.close(),e._selectionStarted()}},i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=this.localization.title,s=this.templateContent.clone();for(var a in this.buttons){var r=this.templateToolsButton.clone(),o=this.buttons[a];r.attr("title",o.tooltip),r.addClass(o.iconCls),r.bind("click",t(a)),s.append(r)}var l=this.templateInstructions.clone();l.append(this.localization.instructions),s.append(l);var u=i.createCloseButton(this.localization.button.cancel);u.addClass("primary"),i.addClass("tools_selection"),i.show(n,s,[u]),i.moveTo("#toolbar div.toolrow[tbgroup=selectiontools]","top")},_selectionStarted:function(){var e=this;e._sandbox;var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=e.localization.title,n=e.templateEditDialogContent.clone(),s=e.templateEditButtons.clone(),a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(e.localization.button.edit),a.setHandler(function(){t.close(),e.showSelectionTools(),e.instance.getSelectionPlugin().startDrawing({drawMode:"modify"})}),s.append(a.getButton());var r=t.createCloseButton(e.localization.button.close);s.append(r.getButton()),r.setHandler(function(){t.close(),e.instance.getSelectionPlugin().stopDrawing(),e.showSelectionTools()}),n.append(s);var o=e.templateLink.clone();o.append(e.localization.link.title),o.bind("click",function(){t.close(),e.showSelectionTools()}),n.append(o),e.instance.setGeometry(null);var l=Oskari.clazz.create("Oskari.userinterface.component.Button");l.setTitle(e.localization.button.show),l.addClass("primary showSelection"),l.setHandler(function(){var i=e.instance.getSelectionPlugin().getFeaturesAsGeoJSON();e.instance.setGeometry(i),e.instance.getSelectionPlugin().stopDrawing(),e.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e.instance,"detach"]),t.close()});var u=Oskari.clazz.create("Oskari.userinterface.component.Button");u.setTitle(e.localization.button.cancel),u.setHandler(function(){t.close(),e.instance.getSelectionPlugin().stopDrawing()}),t.show(i,n,[u,l]),t.moveTo("#toolbar div.toolrow[tbgroup=selectiontools]","top")}}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.plugin.MapSelectionPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.drawControls=null,this.drawLayer=null,this.editMode=!1,this.listeners=[],this.currentDrawMode=null,this.prefix="Default.",e&&e.id&&(this.prefix=e.id+"."),e&&e.graphicFill&&(this.graphicFill=e.graphicFill),this.multipart=e&&e.multipart===!0},{__name:"MapSelectionPlugin",getName:function(){return this.prefix+this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+this.__name},addListener:function(e){this.listeners.push(e)},startDrawing:function(e){if(e.isModify)this.modifyControls.modify.selectControl.select(this.drawLayer.features[0]);else if(e.geometry){this.editMode=!0;var t=[new OpenLayers.Feature.Vector(e.geometry)];this.drawLayer.addFeatures(t),this.drawControls.modify.selectControl.select(this.drawLayer.features[0])}else this.editMode=!1,this._toggleControl(e.drawMode)},stopDrawing:function(){this._toggleControl(),this.drawLayer.removeAllFeatures()},setDrawing:function(e){var t=[new OpenLayers.Feature.Vector(e)];this.drawLayer.addFeatures(t)},forceFinishDraw:function(){this._finishedDrawing(!0)},_finishedDrawing:function(e){if((!this.multipart||e)&&this._toggleControl(),!this.editMode){var t=this.drawLayer.features.length-1;this.drawControls.modify.selectControl.select(this.drawLayer.features[t])}var i;!this.multipart||e?(i=this._sandbox.getEventBuilder(this.prefix+"FinishedDrawingEvent")(this.getDrawing(),this.editMode),this._sandbox.notifyAll(i)):(i=this._sandbox.getEventBuilder(this.prefix+"AddedFeatureEvent")(this.getDrawing(),this.currentDrawMode),this._sandbox.notifyAll(i))},_toggleControl:function(e){this.currentDrawMode=e;for(var t in this.drawControls){var i=this.drawControls[t];e==t?i.activate():i.deactivate()}},init:function(){var e=this;if(this.drawLayer=new OpenLayers.Layer.Vector(this.prefix+"FeatureData Draw Layer",{eventListeners:{featuresadded:function(){e._finishedDrawing()}}}),this.drawControls={point:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.Path),polygon:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.Polygon),square:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4}}),circle:new OpenLayers.Control.DrawFeature(e.drawLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:40}}),modify:new OpenLayers.Control.ModifyFeature(e.drawLayer)},null!=this.graphicFill){var t=this.graphicFill,i=new OpenLayers.Format.SLD,n=i.read(t);if(n&&n.namedLayers)for(var s in n.namedLayers){this.drawLayer.styleMap.styles["default"]=n.namedLayers[s].userStyles[0],this.drawLayer.redraw();break}}this._map.addLayers([e.drawLayer]);for(var a in this.drawControls)this._map.addControl(this.drawControls[a]);this.geojson_format=new OpenLayers.Format.GeoJSON},getDrawing:function(){if(0===this.drawLayer.features.length)return null;var e=this.drawLayer.features[0].geometry.CLASS_NAME;if("OpenLayers.Geometry.MultiPoint"===e||"OpenLayers.Geometry.MultiLineString"===e||"OpenLayers.Geometry.MultiPolygon"===e)return this.drawLayer.features[0].geometry;for(var t=null,i=[],n=0;n<this.drawLayer.features.length;n++)i.push(this.drawLayer.features[n].geometry);switch(e){case"OpenLayers.Geometry.Point":t=new OpenLayers.Geometry.MultiPoint(i);break;case"OpenLayers.Geometry.LineString":t=new OpenLayers.Geometry.MultiLineString(i);break;case"OpenLayers.Geometry.Polygon":t=new OpenLayers.Geometry.MultiPolygon(i)}return t},getFeatures:function(){return this.drawLayer.features},getFeaturesAsGeoJSON:function(){var e=this.geojson_format.write(this.getFeatures()),t=JSON.parse(e);return t.crs=this._getSRS(),t},getFullScreenSelection:function(){var e=this._sandbox.getMap().getBbox(),t=e.toGeometry(),i=this.geojson_format.write(t),n=JSON.parse(i),s={type:"FeatureCollection",crs:this._getSRS(),features:[]},a={type:"Feature",geometry:n,properties:{geom_type:"polygon",buffer_radius:"0"}};return s.features.push(a),s},_getSRS:function(){return{type:"EPSG",properties:{code:3067}}},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this)},stopPlugin:function(e){e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.event.FinishedDrawingEvent",function(e,t){this._drawing=e,this._modification=1==t},{__name:"FeatureData.FinishedDrawingEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},isModification:function(){return this._modification}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.event.AddedFeatureEvent",function(e,t){this._drawing=e,this._drawingMode=t},{__name:"FeatureData.AddedFeatureEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},getDrawingMode:function(){return this._drawingMode}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.layers={},this.tabsContainer=null,this.modelMngr=null,this.selectedTab=null,this.active=!1,this.mapDivId="#mapdiv",this.templateLink=jQuery('<a href="JavaScript:void(0);"></a>'),this.resizable=!0,this.resizing=!1,this.resized=!1},{getName:function(){return"Oskari.mapframework.bundle.featuredata.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("featuredata")||jQuery(this.container).addClass("featuredata")},startPlugin:function(){this.tabsContainer=Oskari.clazz.create("Oskari.userinterface.component.TabContainer",this.instance.getLocalization("nodata")),this.modelMngr=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.service.GridModelManager");var e=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule"),t=e.getMap().div;t&&(this.mapDivId=t)},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},setResizable:function(e){this.resizable=e},createUi:function(){var e=this,t=jQuery(this.container);t.empty();var i=this.instance.sandbox,n=i.getRequestBuilder("DimMapLayerRequest"),s=i.getRequestBuilder("HighlightMapLayerRequest");this.tabsContainer.addTabChangeListener(function(t,a){if(t){e.instance.getService().cancelWFSGridUpdateForLayer(t.layer.getId());var r=n(t.layer.getId());i.request(e.instance.getName(),r)}if(e.selectedTab=a,a&&(e._updateData(a.layer),e.active)){var r=s(a.layer.getId());i.request(e.instance.getName(),r)}}),this.tabsContainer.insertTo(t)},layerAdded:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.TabPanel");t.setTitle(e.getName()),t.getContainer().append(this.instance.getLocalization("loading")),t.layer=e,this.layers[""+e.getId()]=t,this.tabsContainer.addPanel(t)},layerRemoved:function(e){var t=""+e.getId();this.instance.getService().cancelWFSGridUpdateForLayer(t);var i=this.layers[t];this.tabsContainer.removePanel(i),i.grid=null,delete i.grid,i.layer=null,delete i.layer,this.layers[t]=null,delete this.layers[t]},_updateData:function(e,t){if(this.active){this.instance.getService().cancelWFSGridUpdateForLayer(e.getId());var i=this.instance.sandbox.getMap(),n=this.layers[""+e.getId()],s=null;if(n.grid&&(s=n.grid.getSelection()),n.getContainer().empty(),!e.isInScale(i.getScale()))return n.getContainer().append(this.instance.getLocalization("errorscale")),void 0;n.getContainer().append(this.instance.getLocalization("loading"));var a=this,r=i.getWidth(),o=i.getHeight(),l=function(t){if(a._prepareData(e,t),s)for(var i=0;i<s.length;++i)n.grid.select(s[i].featureId,!0)};this.instance.getService().scheduleWFSGridUpdate(e,t,r,o,l)}},updateGrid:function(e){this.selectedTab&&(e=JSON.stringify(e),this._updateData(this.selectedTab.layer,e))},_enableResize:function(){var e=this,t=jQuery("div.oskari-flyoutcontent.featuredata"),i=t.parent().parent(),n=t.parent();t.find("div.tabsContent");var s=0,a=0;i.find("div.tab-content").css({"padding-top":"1px","padding-right":"1px"});var r=jQuery("<div/>");r.addClass("flyout-resizer");var o=16;r.removeClass("allowHover"),r.addClass("icon-drag"),r.bind("dragstart",function(e){e.preventDefault()}),r.mousedown(function(t){e.resizing||(e.resizing=!0,s=t.pageX-i[0].offsetWidth-i[0].offsetLeft,a=t.pageY-i[0].offsetHeight-i[0].offsetTop,jQuery(document).attr("unselectable","on").css("user-select","none").on("selectstart",!1))}),jQuery(document).mouseup(function(){e.resizing=!1,e.resized=!0}),jQuery(document).mousemove(function(t){if(e.resizing){var r=100,l=60,u=i.offset(),c=n.offset();if(t.pageX>u.left){var h=t.pageX-u.left-s;i.css("max-width",h.toString()+"px"),i.css("width",h.toString()+"px")}if(t.pageY-u.top>r){var d=t.pageY-u.top-a;i.css("max-height",d.toString()+"px"),i.css("height",d.toString()+"px");var p=t.pageY-c.top-a;n.css("max-height",(p-o).toString()+"px"),n.css("height",(p-o).toString()+"px");var f=jQuery("div.oskari-flyoutcontent.featuredata").find("div.tabsContent"),m=t.pageY-f[0].offsetTop-o-l;i.find("div.tab-content").css("max-height",m.toString()+"px")}}}),i.find("div.oskari-flyoutcontent").css("padding-bottom","5px"),0===jQuery("div.flyout-resizer").length&&i.append(r)},_prepareData:function(e,t){var i=this,n=this.layers[""+e.getId()],s=this.tabsContainer.isSelected(n);if(s){var a=this.modelMngr.getData(t);if(n.getContainer().empty(),!a)return n.getContainer().append(this.instance.getLocalization("errordata")),void 0;var r=a.all;r.setIdField("featureId");var o=r.getFields();if(!n.grid){var l=Oskari.clazz.create("Oskari.userinterface.component.Grid",this.instance.getLocalization("columnSelectorTooltip"));l.setColumnUIName("__featureName",this.instance.getLocalization("featureNameAll")),l.addSelectionListener(function(t,n){i._handleGridSelect(e,n)});var u=this.instance.getLocalization("showmore");l.setAdditionalDataHandler(u,function(e,t){var i=Oskari.clazz.create("Oskari.userinterface.component.Popup");i.show(u,t),i.moveTo(e,"bottom")});for(var c=[],h=0;h<o.length;++h)"featureId"!=o[h]&&"qName"!=o[h]&&c.push(o[h]);l.setVisibleFields(c),l.setColumnSelector(!0),l.setResizableColumns(!0),n.grid=l}n.grid.setDataModel(r),n.grid.renderTo(n.getContainer());var d=jQuery(i.mapDivId),p=jQuery("div.oskari-flyoutcontent.featuredata"),f=p.parent().parent();i.resized||(f.find("div.tab-content").css("max-height",(d.height()/4).toString()+"px"),f.css("max-width",d.width().toString()+"px")),i.resizable&&this._enableResize()}},_handleGridSelect:function(e,t,i){var n=this.instance.sandbox,s=[t],a=n.getEventBuilder("WFSFeaturesSelectedEvent");void 0===i&&(i=n.isCtrlKeyDown());var r=a(s,e,i);n.notifyAll(r)},featureSelected:function(e){if(this.active){var t=e.getMapLayer(),i=this.layers[""+t.getId()],n=e.getWfsFeatureIds()[0];i.grid&&i.grid.select(n,e.isKeepSelection())}},isEnabled:function(){return this.active===!0},setEnabled:function(e,t){if(this.active==e)return t&&this.updateGrid(t),void 0;this.active=e===!0;var i=this.instance.sandbox,n=i.getRequestBuilder("MapModulePlugin.GetFeatureInfoActivationRequest");if(n&&i.request(this.instance.getName(),n(!this.active)),this.active){if(this.selectedTab){var s=i.getRequestBuilder("HighlightMapLayerRequest"),a=s(this.selectedTab.layer.getId());i.request(this.instance.getName(),a),this.updateGrid(t)}}else{if(this.selectedTab){this.instance.getService().cancelWFSGridUpdateForLayer(this.selectedTab.layer.getId());var r=i.getRequestBuilder("DimMapLayerRequest"),a=r(this.selectedTab.layer.getId());i.request(this.instance.getName(),a)}for(var o in this.layers)o.getContainer&&o.getContainer().empty()}}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.plugin.FeaturedataPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._conf=e,this.__elements={},this.__templates={},this.instance=e.instance},{__name:"FeaturedataPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},init:function(){this.__templates.main=jQuery('<div class="mapplugin featuredataplugin"><a href="JavaScript: void(0);"></a></div>')},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this),this._createUI();for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);this.__elements.main&&(this.__elements.main.remove(),delete this.__elements.main),e.unregister(this)},start:function(){},stop:function(){},_createUI:function(){this._sandbox;var e=this,t=jQuery(this._map.div);e.__elements.main||(e.__elements.main=e.__templates.main.clone());var i=e.__elements.main.find("a");i.html(this.instance.getLocalization("title")),i.bind("click",function(){return e.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e.instance,"detach"]),!1}),e.__elements.main.mousedown(function(e){e.stopPropagation()}),t.append(e.__elements.main),this.update()},update:function(){for(var e=this.mapModule.getSandbox(),t=e.findAllSelectedMapLayers(),i=0,n=0;n<t.length;n++){var s=t[n];s.isLayerOfType("WFS")&&i++}var a=this;i>0?a.__elements.main.show():a.__elements.main.hide()},eventHandlers:{AfterMapMoveEvent:function(){this.update()}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.service.GridJsonService",function(e){this._gridPollingInterval=200,this.endpointUrl=e,this.pendingOperations={},this._wfsTableQueryId=0},{__qname:"Oskari.mapframework.bundle.featuredata.service.GridJsonService",getQName:function(){return this.__qname},__name:"GridJsonService",getName:function(){return this.__name},cancelWFSGridUpdateForLayer:function(e){var t=this.pendingOperations[e];t&&(t.timer&&clearTimeout(t.timer),t.query&&t.query.abort(),this.pendingOperations[e]=null,delete this.pendingOperations[e])},scheduleWFSGridUpdate:function(e,t,i,n,s){this.cancelWFSGridUpdateForLayer(e.getId());var a=Oskari.clazz.create("Oskari.mapframework.bundle.featuredata.domain.WfsGridUpdateParams",e,t,i,n,s),r=this,o=setTimeout(function(){r._processGridUpdate(a)},this._gridPollingInterval);this.pendingOperations[e.getId()]={timer:o}},_processGridUpdate:function(e){var t=this,i=e.getMapLayer();this.pendingOperations[i.getId()].timer=null,delete this.pendingOperations[i.getId()].timer;var n=function(n){t.cancelWFSGridUpdateForLayer(i.getId()),n.error||t._getLatestWfsTableQueryId()==parseInt(n.wfsQueryId)&&e.getCallback()(n)},s=jQuery.ajax({dataType:"json",type:"POST",data:{layerIds:i.getId(),flow_pm_map_width:e.getMapWidth(),flow_pm_map_height:e.getMapHeight(),mode:"data_to_table",geojson:e.getGeometry(),flow_pm_map_wfs_query_id:t._generateWfsTableQueryId()},beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:this.endpointUrl+"action_route=GetWfsFeatureData",success:n});this.pendingOperations[i.getId()].query=s},_getLatestWfsTableQueryId:function(){return this._wfsTableQueryId},_generateWfsTableQueryId:function(){return this._wfsTableQueryId++,this._wfsTableQueryId}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.service.GridModelManager",function(){},{getData:function(e){if(!this._isValidData(e))return!1;var t=this._getModels(e);if(e.featureDatas.length<2)for(var i in t)t.all=t[i];else{var n="__featureName",s=Oskari.clazz.create("Oskari.userinterface.component.GridModel");s._addField(n);for(var i in t){for(var a=t[i],r=a.getFields(),o=0;o<r.length;o++){var l=r[o],u=this._findInList(s.getFields(),l);-1===u&&s._addField(l)}for(var e=a.getData(),o=0;o<e.length;o++){var c=e[o];c[n]=i,s.addData(c)}}t.all=s}return t},_isValidData:function(e){if(!e||!e.headers||!e.featureDatas)return!1;for(var t=0;t<e.featureDatas.length;t++)if(null==e.featureDatas[t].children)return!1;return!0},_findInList:function(e,t){for(var i=0;i<e.length;++i)if(e[i]==t)return i;return-1},_getModels:function(e){for(var t=Oskari.getLang(),i={},n=0;n<e.featureDatas.length;n++){var s=e.featureDatas[n],a=this._getIndividualModel(s),r=s["feature_"+t];i[r]=a}return i},_getIndividualModel:function(e){for(var t=Oskari.clazz.create("Oskari.userinterface.component.GridModel"),i=0;i<e.children.length;i++)t.addData(e.children[i]);return t}}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.domain.WfsGridUpdateParams",function(e,t,i,n,s){this._geometry=t,this._mapWidth=i,this._mapHeight=n,this._mapLayer=e,this._onReady=s},{getMapLayer:function(){return this._mapLayer},getGeometry:function(){return this._geometry},getMapWidth:function(){return this._mapWidth},getMapHeight:function(){return this._mapHeight},getCallback:function(){return this._onReady}}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.request.ShowFeatureDataRequest",function(e){this._id=e},{__name:"ShowFeatureDataRequest",getName:function(){return this.__name},getId:function(){return this._id}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.featuredata.request.ShowFeatureDataRequestHandler",function(e){this.featureData=e},{handleRequest:function(e,t){for(var i=t.getId(),n=this.featureData.plugins["Oskari.userinterface.Flyout"],s=n.tabsContainer.panels,a=0;a<s.length;a++)if(s[a].layer.getId()===i){n.tabsContainer.select(s[a]);break}this.featureData.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[this.featureData,"detach"])}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.MyPlacesBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.MyPlacesBundleInstance")},update:function(e,t,i,n){e.alert("RECEIVED update notification "+n)}},{protocol:["Oskari.bundle.Bundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/event/FinishedDrawingEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/event/AddedFeatureEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/event/MyPlaceHoverEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/event/MyPlacesChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/event/MyPlaceSelectedEvent.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/model/MyPlace.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/model/MyPlacesCategory.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/plugin/DrawPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/plugin/HoverPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/StopDrawingRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/StartDrawingRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/GetGeometryRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/GetGeometryRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/StartDrawingRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/StopDrawingRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/EditPlaceRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/EditCategoryRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/DeleteCategoryRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/PublishCategoryRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/request/EditRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/service/MyPlacesService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/service/MyPlacesWFSTStore.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/view/MainView.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/view/PlaceForm.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/view/PointForm.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/view/LineForm.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/view/AreaForm.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/view/CategoryForm.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/ButtonHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/CategoryHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/instance.js"},{type:"text/javascript",src:"../../../../libraries/jscolor/jscolor.js"},{type:"text/javascript",src:"../../../../libraries/jquery/plugins/jquery.svg.package-1.4.5/jquery.svg.js"},{type:"text/css",src:"../../../../resources/framework/bundle/myplaces2/css/myplaces.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/myplaces2/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"myplaces2","Bundle-Name":"myplaces2","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("myplaces2","Oskari.mapframework.bundle.myplaces2.MyPlacesBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.event.FinishedDrawingEvent",function(e,t){this._drawing=e,this._modification=1==t},{__name:"MyPlaces.FinishedDrawingEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},isModification:function(){return this._modification}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.event.AddedFeatureEvent",function(e,t){this._drawing=e,this._drawingMode=t},{__name:"MyPlaces.AddedFeatureEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},getDrawingMode:function(){return this._drawingMode}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlaceHoverEvent",function(e,t,i){this._creator=null,this._lonlat=e,this._hoverEvent=t,this._zoom=i},{__name:"MyPlaces.MyPlaceHoverEvent",getName:function(){return this.__name},getHoverEvent:function(){return this._hoverEvent
},getLonLat:function(){return this._lonlat},getZoomLevel:function(){return this._zoom}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlacesChangedEvent",function(){},{__name:"MyPlaces.MyPlacesChangedEvent",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlaceSelectedEvent",function(e,t){this._creator=null,this._myPlace=e,this._dblClick=t},{__name:"MyPlaces.MyPlaceSelectedEvent",getName:function(){return this.__name},getPlace:function(){return this._myPlace},isDblClick:function(){return this._dblClick}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.model.MyPlace",function(){this.id=void 0,this.name=void 0,this.description=void 0,this.categoryID=void 0,this.geometry=void 0,this.link=void 0,this.createDate=void 0,this.updateDate=void 0},{setId:function(e){this.id=e},getId:function(){return this.id},setName:function(e){this.name=e},getName:function(){return this.name},setDescription:function(e){this.description=e},getDescription:function(){return this.description},setLink:function(e){this.link=e},getLink:function(){return this.link},setImageLink:function(e){this.imageLink=e},getImageLink:function(){return this.imageLink},setCategoryID:function(e){this.categoryID=e},getCategoryID:function(){return this.categoryID},setGeometry:function(e){this.geometry=e},getGeometry:function(){return this.geometry},setCreateDate:function(e){this.createDate=e},getCreateDate:function(){return this.createDate},setUpdateDate:function(e){this.updateDate=e},getUpdateDate:function(){return this.updateDate},setUUID:function(e){this.uuid=e},getUUID:function(){return this.uuid}}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.model.MyPlacesCategory",function(){this.id=void 0,this.name=void 0,this._isDefault=!1,this._isPublic=!1,this.lineStyle="",this.lineCap=0,this.lineCorner=0,this.lineWidth=1,this.lineColor="3233ff",this.areaLineWidth=1,this.areaLineCorner=0,this.areaLineStyle="",this.areaLineColor="000000",this.areaFillColor="ffde00",this.areaFillStyle=-1,this.dotShape=1,this.dotSize=3,this.dotColor="000000",this.uuid=void 0},{setId:function(e){this.id=e},getId:function(){return this.id},setName:function(e){this.name=e},getName:function(){return this.name},setDefault:function(e){this._isDefault=1==e},isDefault:function(){return 1==this._isDefault},setPublic:function(e){this._isPublic=1==e},isPublic:function(){return 1==this._isPublic},setLineStyle:function(e){this.lineStyle=e},getLineStyle:function(){return this.lineStyle},setLineCap:function(e){this.lineCap=e},getLineCap:function(){return this.lineCap},setLineCorner:function(e){this.lineCorner=e},getLineCorner:function(){return this.lineCorner},setLineWidth:function(e){this.lineWidth=e},getLineWidth:function(){return this.lineWidth},setLineColor:function(e){this.lineColor=e},getLineColor:function(){return this.lineColor},setAreaLineWidth:function(e){this.areaLineWidth=e},getAreaLineWidth:function(){return this.areaLineWidth},setAreaLineCorner:function(e){this.areaLineCorner=e},getAreaLineCorner:function(){return this.areaLineCorner},setAreaLineStyle:function(e){this.areaLineStyle=e},getAreaLineStyle:function(){return this.areaLineStyle},setAreaLineColor:function(e){this.areaLineColor=e},getAreaLineColor:function(){return this.areaLineColor},setAreaFillColor:function(e){this.areaFillColor=e},getAreaFillColor:function(){return this.areaFillColor},setAreaFillStyle:function(e){this.areaFillStyle=e},getAreaFillStyle:function(){return this.areaFillStyle},setDotShape:function(e){this.dotShape=e},getDotShape:function(){return this.dotShape},setDotSize:function(e){this.dotSize=e},getDotSize:function(){return this.dotSize},setDotColor:function(e){this.dotColor=e},getDotColor:function(){return this.dotColor},setUUID:function(e){this.uuid=e},getUUID:function(){return this.uuid}}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.plugin.DrawPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.drawControls=null,this.drawLayer=null,this.editMode=!1,this.currentDrawMode=null,this.prefix="Default.",e&&e.id&&(this.prefix=e.id+"."),e&&e.graphicFill&&(this.graphicFill=e.graphicFill),this.multipart=e&&e.multipart===!0},{__name:"DrawPlugin",getName:function(){return this.prefix+this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+this.__name},startDrawing:function(e){if(e.isModify)this.modifyControls.modify.selectControl.select(this.drawLayer.features[0]);else if(this.drawLayer.removeAllFeatures(),e.geometry){this.editMode=!0;var t=[new OpenLayers.Feature.Vector(e.geometry)];this.drawLayer.addFeatures(t),this.modifyControls.modify.selectControl.select(this.drawLayer.features[0])}else this.editMode=!1,this.toggleControl(e.drawMode)},stopDrawing:function(){this.toggleControl(),this.drawLayer.removeAllFeatures()},forceFinishDraw:function(){try{this.finishedDrawing(!0)}catch(e){this.stopDrawing();var t=this._sandbox.getEventBuilder(this.prefix+"MyPlaceSelectedEvent")();this._sandbox.notifyAll(t)}},finishedDrawing:function(e){if((!this.multipart||e)&&this.toggleControl(),!this.editMode){var t=this.drawLayer.features.length-1;this.modifyControls.modify.selectControl.select(this.drawLayer.features[t])}var i;!this.multipart||e?(i=this._sandbox.getEventBuilder(this.prefix+"FinishedDrawingEvent")(this.getDrawing(),this.editMode),this._sandbox.notifyAll(i)):(i=this._sandbox.getEventBuilder(this.prefix+"AddedFeatureEvent")(this.getDrawing(),this.currentDrawMode),this._sandbox.notifyAll(i))},toggleControl:function(e){this.currentDrawMode=e;for(var t in this.drawControls){var i=this.drawControls[t];e==t?i.activate():i.deactivate()}},init:function(e){var t=this;if(this.requestHandlers={startDrawingHandler:Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.request.StartDrawingRequestPluginHandler",e,t),stopDrawingHandler:Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.request.StopDrawingRequestPluginHandler",e,t),getGeometryHandler:Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.request.GetGeometryRequestPluginHandler",e,t)},this.drawLayer=new OpenLayers.Layer.Vector(this.prefix+"DrawLayer",{eventListeners:{featuresadded:function(){t.finishedDrawing()}}}),this.drawControls={point:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.Path),area:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.Polygon,{handlerOptions:{holeModifier:"altKey"}}),box:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:!0}})},null!=this.graphicFill){var i=this.graphicFill,n=new OpenLayers.Format.SLD,s=n.read(i);if(s&&s.namedLayers)for(var a in s.namedLayers){this.drawLayer.styleMap.styles["default"]=s.namedLayers[a].userStyles[0],this.drawLayer.redraw();break}}this.modifyControls={modify:new OpenLayers.Control.ModifyFeature(t.drawLayer)},this._map.addLayers([t.drawLayer]);for(var r in this.drawControls)this._map.addControl(this.drawControls[r]);for(var r in this.modifyControls)this._map.addControl(this.modifyControls[r]);this.modifyControls.modify.activate()},getDrawing:function(){if(0===this.drawLayer.features.length)return null;var e=this.drawLayer.features[0].geometry.CLASS_NAME;if("OpenLayers.Geometry.MultiPoint"===e||"OpenLayers.Geometry.MultiLineString"===e||"OpenLayers.Geometry.MultiPolygon"===e)return this.drawLayer.features[0].geometry;for(var t=null,i=[],n=0;n<this.drawLayer.features.length;n++)i.push(this.drawLayer.features[n].geometry);switch(e){case"OpenLayers.Geometry.Point":t=new OpenLayers.Geometry.MultiPoint(i);break;case"OpenLayers.Geometry.LineString":t=new OpenLayers.Geometry.MultiLineString(i);break;case"OpenLayers.Geometry.Polygon":t=new OpenLayers.Geometry.MultiPolygon(i)}return t},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this),e.addRequestHandler(this.prefix+"StartDrawingRequest",this.requestHandlers.startDrawingHandler),e.addRequestHandler(this.prefix+"StopDrawingRequest",this.requestHandlers.stopDrawingHandler),e.addRequestHandler(this.prefix+"GetGeometryRequest",this.requestHandlers.getGeometryHandler)},stopPlugin:function(e){e.removeRequestHandler(this.prefix+"StartDrawingRequest",this.requestHandlers.startDrawingHandler),e.removeRequestHandler(this.prefix+"StopDrawingRequest",this.requestHandlers.stopDrawingHandler),e.removeRequestHandler(this.prefix+"GetGeometryRequest",this.requestHandlers.getGeometryHandler),e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.plugin.HoverPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null},{__name:"MyPlaces.HoverPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+this.__name},init:function(e){var t=this;OpenLayers.Control.Hover=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{delay:500,pixelTolerance:null,stopMove:!1},initialize:function(){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Hover(this,{pause:this.onPause,move:this.onMove},this.handlerOptions)},onPause:function(){},onMove:function(){}}),this.hoverControl=new OpenLayers.Control.Hover({handlerOptions:{delay:500,pixelTolerance:6},onPause:function(i){var n=t._map.getLonLatFromPixel(i.xy),s=e.getEventBuilder("MyPlaces.MyPlaceHoverEvent")(n,i,t._map.getZoom());e.notifyAll(s)}}),this._map.addControl(this.hoverControl)},activate:function(){this.hoverControl.activate()},deactivate:function(){this.hoverControl.deactivate()},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this)},stopPlugin:function(e){e.unregister(this),this._map=null,this._sandbox=null},start:function(){},stop:function(){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.myplaces.request.StopDrawingRequest",function(e){this._creator=null,this._isCancel=1==e},{__name:"MyPlaces.StopDrawingRequest",getName:function(){return this.__name},isCancel:function(){return this._isCancel===!0}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.StartDrawingRequest",function(e){if(e.geometry)this._geometry=e.geometry;else if(e.continueCurrent)this._continueCurrent=e.continueCurrent;else{if(!this.drawModes[e.drawMode])throw"Unknown draw mode '"+e.drawMode+"'";this._drawMode=e.drawMode}},{__name:"MyPlaces.StartDrawingRequest",getName:function(){return this.__name},isModify:function(){return this._continueCurrent?!0:!1},drawModes:{point:"point",line:"line",area:"area",cut:"cut",box:"box"},getDrawMode:function(){return this._drawMode},getGeometry:function(){return this._geometry}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.GetGeometryRequest",function(e){this._creator=null,this._callbackMethod=e},{__name:"MyPlaces.GetGeometryRequest",getName:function(){return this.__name},getCallBack:function(){return this._callbackMethod}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.GetGeometryRequestPluginHandler",function(e,t){this.sandbox=e,this.drawPlugin=t},{handleRequest:function(e,t){var i=t.getCallBack();this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.GetGeometryRequestPluginHandler] geometry requested");var n=this.drawPlugin.getDrawing();i(n.geometry)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.StartDrawingRequestPluginHandler",function(e,t){this.sandbox=e,this.drawPlugin=t},{handleRequest:function(e,t){var i=t.getDrawMode();this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.StartDrawingRequestPluginHandler] Start Drawing: "+i),this.drawPlugin.startDrawing({drawMode:t.getDrawMode(),geometry:t.getGeometry(),isModify:t.isModify(),style:""})}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.StopDrawingRequestPluginHandler",function(e,t){this.sandbox=e,this.drawPlugin=t},{handleRequest:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.StopDrawingRequestPluginHandler] Stop drawing"),t.isCancel()?this.drawPlugin.stopDrawing():this.drawPlugin.forceFinishDraw()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.EditPlaceRequest",function(e){this._placeId=e},{__name:"MyPlaces.EditPlaceRequest",getName:function(){return this.__name},getId:function(){return this._placeId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.EditCategoryRequest",function(e){this._categoryId=e},{__name:"MyPlaces.EditCategoryRequest",getName:function(){return this.__name},getId:function(){return this._categoryId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.DeleteCategoryRequest",function(e){this._categoryId=e},{__name:"MyPlaces.DeleteCategoryRequest",getName:function(){return this.__name},getId:function(){return this._categoryId}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.PublishCategoryRequest",function(e,t){this._categoryId=e,this._isPublic=1==t},{__name:"MyPlaces.PublishCategoryRequest",getName:function(){return this.__name},getId:function(){return this._categoryId},isPublic:function(){return this._isPublic}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler",function(e,t){this.sandbox=e,this.instance=t},{handleRequest:function(e,t){var i=e.getSandbox();"MyPlaces.EditPlaceRequest"==t.getName()?this._handleEditPlace(i,t):"MyPlaces.EditCategoryRequest"==t.getName()?this._handleEditCategory(i,t):"MyPlaces.DeleteCategoryRequest"==t.getName()?this._handleDeleteCategory(i,t):"MyPlaces.PublishCategoryRequest"==t.getName()&&this._handlePublishCategory(i,t)},_handleEditPlace:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler] edit requested for place "+t.getId());var i=this.instance.getService(),n=i.findMyPlace(t.getId());if(n){var s=n.getGeometry().getCentroid(),a={lon:s.x,lat:s.y};this.instance.getDrawPlugin().startDrawing({geometry:n.getGeometry()}),this.instance.getMainView().showPlaceForm(a,n)}},_handleEditCategory:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler] edit requested for category "+t.getId());var i=this.instance.getService(),n=i.findCategory(t.getId());n&&this.instance.getCategoryHandler().editCategory(n)},_handleDeleteCategory:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler] delete requested for category "+t.getId());var i=this.instance.getService(),n=i.findCategory(t.getId());n&&this.instance.getCategoryHandler().confirmDeleteCategory(n)},_handlePublishCategory:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler] (un/)publish requested for category "+t.getId());var i=this.instance.getService(),n=i.findCategory(t.getId());n&&this.instance.getCategoryHandler().confirmPublishCategory(n,t.isPublic())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.service.MyPlacesService",function(e,t,i,n,s){this._categoryList=[],this._placesList=[],this.wfstStore=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.service.MyPlacesWFSTStore",e,t,s.featureNS),this._sandbox=i,this.defaultCategory=null,this.defaults=n,this._instance=s},{__qname:"Oskari.mapframework.bundle.myplaces2.service.MyPlacesService",getQName:function(){return this.__qname},__name:"MyPlacesService",getName:function(){return this.__name},init:function(){var e=this;this.wfstStore.connect();var t=!1,i=!1,n=function(){i&&t&&e._notifyDataChanged()},s=function(i){if(i)for(var s=0;s<i.length;++s)e._addCategory(i[s]);var a=function(){t=!0,n()};e.getDefaultCategory()?a():e._createDefaultCategory(a)},a=function(t){t&&(e._placesList=t),i=!0,n()};this.wfstStore.getCategories(s),this.wfstStore.getMyPlaces(a)},_createDefaultCategory:function(e){var t=this,i=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlacesCategory");i.setName(t.defaultCategoryName),t.defaultCategoryName||i.setName("My map layer"),i.setName(this.defaults.name),i.setDotShape(this.defaults.point.shape),i.setDotColor(this.defaults.point.color),i.setDotSize(this.defaults.point.size),i.setLineStyle(this.defaults.line.style),i.setLineCap(this.defaults.line.cap),i.setLineCorner(this.defaults.line.corner),i.setLineWidth(this.defaults.line.width),i.setLineColor(this.defaults.line.color),i.setAreaLineWidth(this.defaults.area.linewidth),i.setAreaLineCorner(this.defaults.area.linecorner),i.setAreaLineStyle(this.defaults.area.linestyle),i.setAreaLineColor(this.defaults.area.linecolor),i.setAreaFillColor(this.defaults.area.color),i.setAreaFillStyle(this.defaults.area.fill),i.setDefault(!0);var n=function(){0===t.getAllCategories().length?t._instance.forceDisable():e()};this.saveCategory(i,n)},_addCategory:function(e){e.isDefault()&&(this.defaultCategory=e),this._categoryList.push(e)},_movePlacesToCategory:function(e,t,i){var n=this,s=this.getPlacesInCategory(e);if(0==s.length)return i(!0),void 0;for(var a=0;a<s.length;a++)s[a].setCategoryID(t);var r=function(e){n._notifyDataChanged(),i(e)};this.wfstStore.commitMyPlaces(s,r)},_deletePlacesInCategory:function(e,t){for(var i=this.getPlacesInCategory(e),n=[],s=0;s<i.length;s++)n.push(i[s].getId());if(0==n.length)return t(!0),void 0;var a=this,r=function(e,n){if(e){for(var s=0;s<i.length;s++)a._removeMyPlace(n[s]);a._notifyDataChanged()}t(e)};this.wfstStore.deleteMyPlaces(n,r)},parseDate:function(e){if(!e&&e.length<10)return[];var t=e.substring(0,4),i=e.substring(5,7),n=e.substring(8,10),s=[n+"."+i+"."+t],a="";if(29==e.length){a=e.substring(11);var r=a.split("+");a=r[0],a=a.split(".")[0];var o=a.split(":"),l=o[0],u=o[1],c=o[2];a=l+":"+u+":"+c,s.push(a)}return s},getPlacesInCategory:function(e){for(var t=[],i=0;i<this._placesList.length;i++)this._placesList[i].getCategoryID()==e&&t.push(this._placesList[i]);return t},deleteCategory:function(e,t,i){var n=this,s=function(t){t?n._deleteEmptyCategory(e,i):i(t)};if(t===!0){var a=n.getDefaultCategory();n._movePlacesToCategory(e,a.getId(),s)}else n._deletePlacesInCategory(e,s)},_deleteEmptyCategory:function(e,t){var i=this,n=function(e,n){e&&i._removeCategory(n[0]),t(e),i._notifyDataChanged()};this.wfstStore.deleteCategories([e],n)},_removeCategory:function(e){for(var t=0;t<this._categoryList.length;t++)if(this._categoryList[t].getId()==e){this._categoryList.splice(t,1);break}},saveCategory:function(e,t){var i=this,n=!e.getId(),s=function(s,a){if(n&&s)i._addCategory(a[0]);else{var r=i.findCategory(a[0].getId());r?(r.setName(e.getName()),r.setDotSize(e.getDotSize()),r.setDotColor(e.getDotColor()),r.setDotShape(e.getDotShape()),r.setLineWidth(e.getLineWidth()),r.setLineColor(e.getLineColor()),r.setLineCap(e.getLineCap()),r.setLineCorner(e.getLineCorner()),r.setLineStyle(e.getLineStyle()),r.setAreaLineWidth(e.getAreaLineWidth()),r.setAreaLineCorner(e.getAreaLineCorner()),r.setAreaLineStyle(e.getAreaLineStyle()),r.setAreaLineColor(e.getAreaLineColor()),r.setAreaFillColor(e.getAreaFillColor()),r.setAreaFillStyle(e.getAreaFillStyle()),r.setDefault(e.isDefault())):s=!1}i._notifyDataChanged(),t(s,a[0],n)};this.wfstStore.commitCategories([e],s)},getAllCategories:function(){return this._categoryList},getDefaultCategory:function(){return this.defaultCategory},_addMyPlace:function(e){this._placesList.push(e)},_removeMyPlace:function(e){var t=this.findBy(this._placesList,"id",e);-1!==t&&this._placesList.splice(t,1)},_notifyDataChanged:function(){var e=this._sandbox.getEventBuilder("MyPlaces.MyPlacesChangedEvent")();this._sandbox.notifyAll(e)},deleteMyPlace:function(e,t){var i=this,n=function(e,n){e&&(i._removeMyPlace(n[0]),i._notifyDataChanged()),t(e,n[0])};this.wfstStore.deleteMyPlaces([e],n)},findMyPlaceByLonLat:function(e,t){for(var i=[],n=this.getAllMyPlaces(),s=0;s<n.length;++s){var a=n[s].getGeometry(),r=!1;if("OpenLayers.Geometry.Point"===a.CLASS_NAME){var o=720-5*t*t;t>10?o=5:t>8?o=20:t>5&&(o=50),r=a.atPoint(e,o,o)}else r=a.atPoint(e);r&&i.push(n[s])}return i},findMyPlace:function(e){var t=this.findBy(this._placesList,"id",e);return-1!==t?this._placesList[t]:null},findCategory:function(e){var t=this.findBy(this._categoryList,"id",e);return-1!==t?this._categoryList[t]:null},findBy:function(e,t,i){for(var n=0;n<e.length;n++)if(e[n][t]===i)return n;return-1},saveMyPlace:function(e,t){var i=this,n=!e.getId(),s=function(s,a){if(n&&s)i._addMyPlace(a[0]);else{var r=i.findMyPlace(a[0].getId());r?(r.setName(e.getName()),r.setDescription(e.getDescription()),r.setLink(e.getLink()),r.setCategoryID(e.getCategoryID()),r.setGeometry(e.getGeometry()),r.setUpdateDate(a[0].getUpdateDate())):s=!1}i._notifyDataChanged(),t(s,a[0],n)};this.wfstStore.commitMyPlaces([e],s)},getAllMyPlaces:function(){return this._placesList},publishCategory:function(e,t,i){var n=this.findCategory(e);n||i(!1);var s=this,a=this._sandbox.getAjaxUrl();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},data:{id:n.getId(),makePublic:t},url:a+"action_route=PublishMyPlaceLayer",success:function(e){e?(n.setPublic(t),i(!0),s._notifyDataChanged()):i(!1)},error:function(e){0!=e.status&&i(!1)}})}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.service.MyPlacesWFSTStore",function(e,t,i){this.uuid=t,this.protocols={},this.url=e,this.featureNS=i},{connect:function(){var e=this.url;this.protocols.categories=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",featureType:"categories",featureNS:this.featureNS,url:e}),this.protocols.my_places=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",geometryName:"geometry",featureType:"my_places",featureNS:this.featureNS,url:e})},getCategories:function(e){var t=this.uuid,i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:t}),n=this.protocols.categories,s=this;n.read({filter:i,callback:function(t){s._handleCategoriesResponse(t,e)}})},_handleCategoriesResponse:function(e,t){var i=this.uuid,n=e.features;if(null==n||0==n.length)return t&&t(),void 0;for(var s=[],a=0;a<n.length;a++){var r=n[a],o=r.attributes,l=this._parseNumericId(r.fid),u=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlacesCategory");u.setId(l),u.setName(o.category_name),u.setDefault("true"===o["default"]),u.setLineWidth(o.stroke_width),u.setLineStyle(o.stroke_dasharray),u.setLineCap(o.stroke_linecap),u.setLineCorner(o.stroke_linejoin),u.setLineColor(this._formatColorFromServer(o.stroke_color)),u.setAreaLineWidth(o.border_width),u.setAreaLineStyle(o.border_dasharray),u.setAreaLineCorner(o.border_linejoin),u.setAreaLineColor(this._formatColorFromServer(o.border_color)),u.setAreaFillColor(this._formatColorFromServer(o.fill_color)),u.setAreaFillStyle(o.fill_pattern),u.setDotShape(o.dot_shape),u.setDotColor(this._formatColorFromServer(o.dot_color)),u.setDotSize(o.dot_size),u.setUUID(i),o.publisher_name&&u.setPublic(!0),s.push(u)}t&&t(s)},_formatColorFromServer:function(e){return"#"==e.charAt(0)?e.substring(1):e},_prefixColorForServer:function(e){return"#"!=e.charAt(0)?"#"+e:e},commitCategories:function(e,t){for(var i=this.uuid,n=this.protocols.categories,s=this,a=[],r=0;r<e.length;r++){var o=e[r],l=o.getId(),u={category_name:o.getName(),"default":o.isDefault(),stroke_width:o.getLineWidth(),stroke_dasharray:o.getLineStyle(),stroke_linecap:o.getLineCap(),stroke_linejoin:o.getLineCorner(),stroke_color:this._prefixColorForServer(o.getLineColor()),border_width:o.getAreaLineWidth(),border_dasharray:o.getAreaLineStyle(),border_linejoin:o.getAreaLineCorner(),border_color:this._prefixColorForServer(o.getAreaLineColor()),fill_color:this._prefixColorForServer(o.getAreaFillColor()),fill_pattern:o.getAreaFillStyle(),dot_color:this._prefixColorForServer(o.getDotColor()),dot_size:o.getDotSize(),dot_shape:o.getDotShape(),uuid:i},c=new OpenLayers.Feature.Vector(null,u);l?(c.fid=n.featureType+"."+l,c.state=OpenLayers.State.UPDATE):c.toState(OpenLayers.State.INSERT),a.push(c)}n.commit(a,{callback:function(i){s._handleCommitCategoriesResponse(i,e,t)}})},_handleCommitCategoriesResponse:function(e,t,i){if(e.success()){for(var n,s,a=e.reqFeatures,r=e.insertIds||[],o=0,l=a.length;l>o;++o)if(s=a[o],n=s.state){if(n==OpenLayers.State.INSERT){s.fid=r[o],s.attributes.id=s.fid;var u=this._parseNumericId(s.fid);t[o].setId(u)}s.state=null}i(!0,t)}else i(!1,t)},deleteCategories:function(e,t){for(var i=this.protocols.categories,n=this.uuid,s=[],a=0;a<e.length;a++){var r=e[a];if(r){var o={uuid:n},l=new OpenLayers.Feature.Vector(null,o);l.fid=i.featureType+"."+r,l.state=OpenLayers.State.DELETE,s.push(l)}}var u=this;i.commit(s,{callback:function(i){u._handleDeleteCategoriesResponse(i,e,t)}})},_handleDeleteCategoriesResponse:function(e,t,i){e.success()?i(!0,t):i(!1,t)},_parseNumericId:function(e){var t=e.split(".")[1];return t},getMyPlaces:function(e){var t=this.uuid,i=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:t}),n=this.protocols.my_places,s=this;n.read({filter:i,callback:function(t){s._handleMyPlacesResponse(t,e)}})},_handleMyPlacesResponse:function(e,t){var i=this.uuid,n=e.features;if(null==n||0==n.length)return t&&t(),void 0;for(var s=[],a=0;a<n.length;a++){var r=n[a],o=r.attributes,l=this._parseNumericId(r.fid),u=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlace");u.setId(l),u.setName(o.name),u.setDescription(o.place_desc),u.setLink(o.link),u.setImageLink(o.image_url),u.setCategoryID(o.category_id),u.setCreateDate(o.created),u.setUpdateDate(o.updated),u.setGeometry(r.geometry),u.setUUID(i),s.push(u)}t&&t(s)},getMyPlacesByIdList:function(e,t){var i=this.uuid,n=this.protocols.my_places,s=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:i}),new OpenLayers.Filter.FeatureId({fids:e})]}),a=this;n.read({filter:s,callback:function(e){a._handleMyPlacesResponse(e,t)}})},commitMyPlaces:function(e,t){for(var i=this.protocols.my_places,n=this.uuid,s=[],a=0;a<e.length;a++){var r=e[a],o=r.getId(),l=r.getGeometry(),u={name:r.getName(),place_desc:r.getDescription(),link:r.getLink(),image_url:r.getImageLink(),category_id:r.getCategoryID(),uuid:n},c=new OpenLayers.Feature.Vector(l,u);o?(c.fid=i.featureType+"."+o,c.state=OpenLayers.State.UPDATE):c.toState(OpenLayers.State.INSERT),s.push(c)}var h=this;i.commit(s,{callback:function(i){h._handleCommitMyPlacesResponse(i,e,t)}})},_handleCommitMyPlacesResponse:function(e,t,i){if(e.success()){for(var n,s,a=e.reqFeatures,r=e.insertIds||[],o=[],l=0,u=a.length;u>l;++l)if(s=a[l],n=s.state){if(n==OpenLayers.State.INSERT){s.fid=r[l],s.attributes.id=s.fid;var c=this._parseNumericId(s.fid);t[l].setId(c),o.push(c)}else o.push(t[l].getId());s.state=null}var h=function(e){i(!0,e)};this.getMyPlacesByIdList(o,h)}else i(!1,t)},deleteMyPlaces:function(e,t){for(var i=this.protocols.my_places,n=this.uuid,s=[],a=0;a<e.length;a++){var r=e[a];if(r){var o={uuid:n},l=new OpenLayers.Feature.Vector(null,o);l.fid=i.featureType+"."+r,l.state=OpenLayers.State.DELETE,s.push(l)}}var u=this;i.commit(s,{callback:function(i){u._handleDeleteMyPlacesResponse(i,e,t)}})},_handleDeleteMyPlacesResponse:function(e,t,i){e.success()?i(!0,t):i(!1,t)},disconnect:function(){}}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.MainView",function(e){this.instance=e,this.popupId="myplacesForm",this.form=void 0},{__name:"MyPlacesMainView",getName:function(){return this.__name},getSandbox:function(){return this.instance.sandbox},init:function(){},start:function(){var e=this,t=this.instance.sandbox;t.register(e);for(var i in e.eventHandlers)t.registerForEventByName(e,i);var n=t.findRegisteredModuleInstance("MainMapModule"),s={id:"MyPlaces",multipart:!0},a=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.plugin.DrawPlugin",s);n.registerPlugin(a),n.startPlugin(a),this.drawPlugin=a},stop:function(){var e=this.instance.sandbox;for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this)},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{"Toolbar.ToolSelectedEvent":function(){this._cleanupPopup()},"MyPlaces.FinishedDrawingEvent":function(e){this._handleFinishedDrawingEvent(e)}},_handleFinishedDrawingEvent:function(e){var t=e.getDrawing().getCentroid(),i={lon:t.x,lat:t.y};this.showPlaceForm(i)},showPlaceForm:function(e,t){var i=this,n=this.instance.sandbox;n.postRequestByName("DisableMapKeyboardMovementRequest");var s=this.instance.getLocalization();this.form=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.PlaceForm",this.instance);var a=this.instance.getService().getAllCategories();if(t){var r={place:{id:t.getId(),name:t.getName(),link:t.getLink(),imageLink:t.getImageLink(),desc:t.getDescription(),category:t.getCategoryID()}};this.form.setValues(r)}var o=[{html:i.form.getForm(a),useButtons:!0,primaryButton:s.buttons.save,actions:{}}];o[0].actions[s.buttons.cancel]=function(){i._cleanupPopup();var e=i.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();i.instance.sandbox.request(i,e)},o[0].actions[s.buttons.save]=function(){i._saveForm()};var l=n.getRequestBuilder("InfoBox.ShowInfoBoxRequest")(this.popupId,s.placeform.title,o,e,!0);n.request(i.getName(),l)},_validateForm:function(e){var t=[],i=this.instance.getCategoryHandler(),t=i.validateCategoryFormValues(e.category),n=this.instance.getLocalization("validation");return e.place.name?i.hasIllegalChars(e.place.name)&&t.push({name:"name",error:n.placeNameIllegal}):t.push({name:"name",error:n.placeName}),i.hasIllegalChars(e.place.desc)&&t.push({name:"desc",error:n.descIllegal}),t},_showValidationErrorMessage:function(e){for(var t=this.instance.getLocalization(),i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=i.createCloseButton(t.buttons.ok),s=jQuery("<ul></ul>"),a=0;a<e.length;++a){var r=jQuery("<li></li>");r.append(e[a].error),s.append(r)}i.show(t.validation.title,s,[n])},_saveForm:function(){if(this.form){var e=this,t=this.form.getValues(),i=this._validateForm(t);if(0!=i.length)return this._showValidationErrorMessage(i),void 0;if(t.category){var n=this.instance.getCategoryHandler().getCategoryFromFormValues(t.category),s=function(i,n,s){if(i)t.place.category=n.getId(),e.__savePlace(t.place);else{var a=e.instance.getLocalization("notification").error;s?e.instance.showMessage(a.title,a.addCategory):e.instance.showMessage(a.title,a.editCategory)}};this.instance.getService().saveCategory(n,s)}else this.__savePlace(t.place)
}},__savePlace:function(e){var t=this;if(!e){var i=t.instance.getLocalization("notification").error;return t.instance.showMessage(i.title,i.savePlace),void 0}var n=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlace"),s=-1;e.id&&(n=this.instance.getService().findMyPlace(e.id),s=n.getCategoryID()),n.setId(e.id),n.setName(e.name),n.setLink(e.link),n.setImageLink(e.imageLink),n.setDescription(e.desc),n.setCategoryID(e.category),n.setGeometry(this.drawPlugin.getDrawing());var a=this.instance.sandbox,r=function(e,i,r){if(e){var o=t.instance.getCategoryHandler()._getMapLayerId(n.getCategoryID()),l=a.getRequestBuilder("AddMapLayerRequest"),u=a.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest"),c=l(o,!0);if(a.request(t,c),r){var h=u(o,!0);a.request(t,h)}else{var h=u(o,!0);a.request(t,h),s!=n.getCategoryID()&&(o=t.instance.getCategoryHandler()._getMapLayerId(s),c=l(o,!0),a.request(t,c))}t._cleanupPopup();var d=Oskari.clazz.create("Oskari.userinterface.component.Popup"),p=t.instance.getLocalization("notification").placeAdded;d.show(p.title,p.message),d.fadeout(),t.drawPlugin.stopDrawing()}else{var p=t.instance.getLocalization("notification").error;t.instance.showMessage(p.title,p.savePlace)}};this.instance.getService().saveMyPlace(n,r)},_cleanupPopup:function(){if(this.form){var e=this.instance.sandbox,t=e.getRequestBuilder("InfoBox.HideInfoBoxRequest")(this.popupId);e.request(this,t),this.form.destroy(),this.form=void 0,e.postRequestByName("EnableMapKeyboardMovementRequest"),this.instance.enableGfi(!0)}}},{protocol:["Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.PlaceForm",function(e){this.instance=e,this.newCategoryId="-new-",this.placeId=void 0,this.initialValues=void 0;var t=e.getLocalization("placeform");this.template=jQuery('<div class="myplacesform"><div class="field"><div class="help icon-info" title="'+t.tooltip+'"></div>'+'<input type="text" name="placename" placeholder="'+t.placename.placeholder+'"/>'+"</div>"+'<div class="field">'+'<textarea name="placedesc" placeholder="'+t.placedesc.placeholder+'">'+"</textarea>"+"</div>"+'<div class="field">'+'<input type="text" name="placelink" placeholder="'+t.placelink.placeholder+'"/>'+"</div>"+'<div class="field">'+'<input type="text" name="imagelink" placeholder="'+t.imagelink.placeholder+'"/>'+"</div>"+'<div class="field imagePreview">'+"<label>"+t.imagelink.previewLabel+'</label><br clear="all" />'+'<a class="myplaces_imglink" target="_blank"><img src=""></img></a>'+"</div>"+'<div class="field" id="newLayerForm">'+'<label for="category">'+'<a href="#" class="newLayerLink">'+t.category.newLayer+"</a>"+t.category.choose+'</label><br clear="all" />'+'<select name="category" autofocus>'+"</select>"+"</div>"+"</div>"),this.templateOption=jQuery("<option></option>"),this.categoryForm=void 0},{getForm:function(e){var t=this.template.clone();if(this.instance.getLocalization("placeform"),e){for(var i=t.find("select[name=category]"),n=this.templateOption.clone(),s=0;s<e.length;++s){var a=e[s],n=this.templateOption.clone();n.append(a.getName()),n.attr("value",a.getId()),this.initialValues?this.initialValues.place.category==a.getId()&&n.attr("selected","selected"):a.isDefault()&&n.attr("selected","selected"),i.append(n)}this._bindCategoryChange()}return this._bindImageUrlChange(),this._bindCreateNewLayer(),this.initialValues&&(t.find("input[name=placename]").attr("value",this.initialValues.place.name),t.find("textarea[name=placedesc]").append(this.initialValues.place.desc),t.find("input[name=placelink]").attr("value",this.initialValues.place.link),t.find("input[name=imagelink]").attr("value",this.initialValues.place.imageLink)),t},getValues:function(){var e={},t=this._getOnScreenForm();if(t.length>0){var i=t.find("input[name=placename]").val(),n=t.find("textarea[name=placedesc]").val(),s=t.find("input[name=placelink]").val();s&&((-1==s.indexOf("://")||s.indexOf("://")>6)&&(s="http://"+s),s=s.replace("<",""),s=s.replace(">",""));var a=t.find("input[name=imagelink]").val(),r=t.find("select[name=category]").val();e.place={name:i,desc:n,link:s,imageLink:a,category:r},this.placeId&&(e.place.id=this.placeId)}return this.categoryForm&&(e.category=this.categoryForm.getValues()),e},setValues:function(e){this.placeId=e.place.id;var t=this._getOnScreenForm();t.length>0&&(t.find("input[name=placename]").val(e.place.name),t.find("textarea[name=placedesc]").val(e.place.desc),t.find("input[name=placelink]").val(e.place.link),t.find("input[name=imagelink]").val(e.place.imageLink),t.find("select[name=category]").val(e.place.category)),this.initialValues=e},_bindCategoryChange:function(){var e=this,t=this._getOnScreenForm();t.find("select[name=category]").live("change",function(){e.categoryForm&&(e.categoryForm.destroy(),e.categoryForm=void 0)})},_bindImageUrlChange:function(){var e=this,t=e._getOnScreenForm();t.find("input[name=imagelink]").live("change",function(){var t=e._getOnScreenForm(),i=jQuery(this).val();t.find("div.imagePreview").find("img").attr("src",i),t.find("a.myplaces_imglink").attr({href:i})})},_bindCreateNewLayer:function(){var e=this,t=e._getOnScreenForm();t.find("a.newLayerLink").live("click",function(t){var i=e._getOnScreenForm();t.preventDefault(),e.categoryForm=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.CategoryForm",e.instance),i.find("div#newLayerForm").html(e.categoryForm.getForm()),e.categoryForm.start()})},destroy:function(){var e=this._getOnScreenForm();e.find("select[name=category]").die(),e.find("input[name=imagelink]").die(),e.find("a.newLayerLink").die(),this.categoryForm&&(this.categoryForm.destroy(),this.categoryForm=void 0)},_getOnScreenForm:function(){return jQuery("div.myplacesform")}}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.PointForm",function(e){this.instance=e,this.loc=e.getLocalization("pointform"),this.defaultValues={size:e.myPlacesService.defaults.point.size,color:e.myPlacesService.defaults.point.color,shape:e.myPlacesService.defaults.point.shape},this.values={size:this.defaultValues.size,color:this.defaultValues.color,shape:this.defaultValues.shape},this.minSize=this.instance.conf&&this.instance.conf.defaults&&this.instance.conf.defaults.dotMinSize?this.instance.conf.defaults.dotMinSize:1,this.maxSize=this.instance.conf&&this.instance.conf.defaults&&this.instance.conf.defaults.dotMaxSize?this.instance.conf.defaults.dotMaxSize:5,this.basicColors=["#ffffff","#666666","#ffde00","#f8931f","#ff3334","#bf2652","#000000","#cccccc","#652d90","#3233ff","#26bf4b","#00ff01"],this.activeColorCell=6,this.symbolButtons={square:{iconCls:"marker-square",iconId:1,shape:{data:{paths:[],polygons:[[[310,68],[112,68],[112,266],[166.615,266],[210.583,335.832],[254.551,266],[310,266]]],circles:[]},offset:[210.583,335.832]}},dot:{iconCls:"marker-dot",iconId:5,shape:{data:{paths:[],polygons:[],circles:[{cx:195.782,cy:185.718,r:93.782}]},offset:[195.782,185.718]}},arrow:{iconCls:"marker-arrow",iconId:6,shape:{data:{paths:[],polygons:[[[249,214],[249,69],[162,69],[162,214],[101.123,214],[205.25,331.832],[309.377,214]]],circles:[]},offset:[205.25,331.832]}},pin:{iconCls:"marker-pin",iconId:3,shape:{data:{paths:[],polygons:[[[183.893,323],[210.506,212.198],[191.684,208.229],[164.713,323]]],circles:[{cx:217.199,cy:131,r:68}]},offset:[174.303,323]}},pin2:{iconCls:"marker-pin2",iconId:2,shape:{data:{paths:[[["move",[197.282,57.936],!1],["curveC",[-51.795,0,-93.782,41.988,-93.782,93.782],!0],["curveC",[0,51.795,93.782,174.782,93.782,174.782],!0],["smoothC",[93.782,-122.987,93.782,-174.782],!0],["curveC",[291.064,99.923,249.076,57.936,197.282,57.936],!1],["close","",""]],[["move",[197.5,190.5],!1],["curveC",[-21.263,0,-38.5,-17.236,-38.5,-38.5],!0],["smoothC",[17.237,-38.5,38.5,-38.5],!0],["smoothC",[236,130.736,236,152],!1],["smoothC",[218.763,190.5,197.5,190.5],!1],["close","",""]]],polygons:[],circles:[]},offset:[197.282,57.936]}},stud:{iconCls:"marker-stud",iconId:0,shape:{data:{paths:[[["move",[228.465,61.808],!1],["curveC",[-34.129,-6.2,-74.84,2.725,-67.242,18.748],!0],["curveC",[10.313,21.754,18.316,38.636,24.535,51.754],!0],["curveC",[-13.525,13.08,-32.082,31.028,-57.578,55.687],!0],["curveC",[-15.447,14.94,26.929,42.415,68.291,49.929],!0],["curveC",[41.36,7.514,90.696,-3.301,81.49,-22.719],!0],["curveC",[-15.194,-32.051,-26.254,-55.379,-34.314,-72.38],!0],["curveC",[10.436,-10.093,23.865,-23.081,41.171,-39.818],!0],["curveC",[297.564,90.681,262.596,68.009,228.465,61.808],!1],["close","",""]]],polygons:[[[187.893,328],[201.506,253.198],[182.684,249.229],[168.713,328]]],circles:[]},offset:[178.303,328]}},flag:{iconCls:"marker-flag",iconId:4,shape:{data:{paths:[],polygons:[[[270.732,341],[333.817,76.259],[313.429,76.248],[250.647,341]],[[117.579,76],[144.322,145.722],[85,215],[265.541,215],[298.314,76]]],circles:[]},offset:[260.6895,341]}}},this.templateSymbolDialogContent=jQuery('<div class="pointform"><div class="container"><div class="column1"><label>'+this.loc.symbol.label+"</label>"+'<div class="symbols icon-buttons"></div>'+"<label>"+this.loc.size.label+"</label><br>"+'<div class="sizer-values"></div>'+'<div class="sizer"></div>'+"</div>"+'<div class="column2">'+'<div class="column21">'+"<label>"+this.loc.color.label+"</label>"+'<div class="color-grid">'+'<div class="color-rectangle"></div>'+"</div>"+'<div class="color-label">'+"<label>"+this.loc.color.labelOr+"</label>"+"</div>"+'<div class="color-source-selector">'+"<label>"+this.loc.color.labelCustom+"</label>"+"</div>"+'<div class="custom-colors"></div>'+"</div>"+'<div class="column22">'+"<label>"+this.loc.preview.label+"</label>"+'<div class="preview"></div>'+"</div>"+"</div>"+"</div>"+"</div>"),this.templateSymbolButton=jQuery('<div class="icon-button"></div>'),this.templateColorCell=jQuery('<div class="color-cell"></div>'),this.templateCustomColor=jQuery('<div class="custom-color-editor"><div class="colorcontainer"><div class="colorcolumn1"></div><div class="colorcolumn2"><div class="colorcolumn21"></div><div class="colorcolumn22"></div></div></div>'),this.templateColorSource=jQuery('<input type="checkbox" name="colorInput" value = "custom" class="color-source">'),this.templateColorValue=jQuery('<label class="color-label"></label><br><input type="text" name="color-input" value="0" disabled="disabled" class="custom-color">'),this.templateSizerValue=jQuery('<div class="sizer-value"></div>'),this.previewSize=50},{showForm:function(e,t){var i=this;null!=t&&jQuery.extend(!0,i.values,t.dot);var n=Oskari.clazz.create("Oskari.userinterface.component.Popup");n.addClass("renderdialog"),n.addClass("pointvisualization");var s=i.loc.title,a=i.templateSymbolDialogContent.clone(),r=a.find("div.symbols");for(var o in this.symbolButtons){var l=this.templateSymbolButton.clone(),u=this.symbolButtons[o];l.addClass(u.iconCls),l.attr("id",u.iconId+"marker"),u.iconId===i.values.shape&&l.css("border","2px solid"),l.click(function(){i.values.shape=parseInt(jQuery(this).attr("id").charAt(0)),i._selectButton(i.values.shape),i._updatePreview(a)}),r.append(l)}var c=10,h=110,d=i.maxSize-i.minSize,p=h/d,f=0;r=a.find(".sizer-values");for(var m=1;c>=m;m++){var g=i.templateSizerValue.clone();if(g.html(m),g.addClass("value"+m),m<i.minSize||m>i.maxSize)g.hide();else{var y=f*p.toString()+"px";g.css("left",y),g.show(),f+=1}r.append(g)}r=a.find(".sizer"),r.slider({range:"min",min:i.minSize,max:i.maxSize,value:this.values.size,slide:function(e,t){i.values.size=t.value,i._updatePreview(a)}});var v=!1;r=a.find(".color-rectangle");for(var m=0;m<i.basicColors.length;m++){var b=i.templateColorCell.clone();b.css("background-color",i.basicColors[m]);var _="ColorCell",w=m+_;w.length===_.length+1&&(w="0"+w),b.attr("id",w),b.click(function(){if(!jQuery(".color-source").prop("checked")){var e=parseInt(this.id.substring(0,2),10);if(e!==i.activeColorCell){if(i.activeColorCell>-1){var t=i.activeColorCell.toString();i.activeColorCell<10&&(t="0"+t),jQuery("#"+t+"ColorCell").css("border","1px solid #000000")}i.values.color=i.instance.rgbToHex(this.style.backgroundColor),i.activeColorCell=e,10>e&&(e="0"+e.toString()),jQuery("#"+e+"ColorCell").css("border","3px solid #ffffff"),i._updatePreview(a)}}}),"#"+i.values.color==i.basicColors[m]&&(b.css("border","3px solid #ffffff"),i.activeColorCell=m,v=!0),r.append(b)}r=a.find(".color-source-selector");var L=i.templateColorSource.clone();L.change(function(){jQuery("input.custom-color").prop("disabled",!this.checked);var e=jQuery("#"+i.activeColorCell+"ColorCell");this.checked?e.css("border","1px solid #000000"):e.css("border","3px solid #ffffff"),i._updatePreview(a)}),r.prepend(L),v||(L.checked=!0,r.find("input.color-source").prop("disabled",!1).attr("checked","checked")),r=a.find(".custom-colors");var k=this.templateCustomColor.clone();r.append(k);var O=i.templateColorValue.clone();O.addClass("custom-red-value"),a.find(".colorcolumn1").append(O),a.find("label.custom-red-value").text("R");var x=i.templateColorValue.clone();x.addClass("custom-green-value"),a.find(".colorcolumn21").append(x),a.find("label.custom-green-value").text("G");var S=i.templateColorValue.clone();if(S.addClass("custom-blue-value"),a.find(".colorcolumn22").append(S),a.find("label.custom-blue-value").text("B"),!v){var C=i.instance.hexToRgb(i.values.color);a.find("input.custom-color.custom-red-value").val(C.r),a.find("input.custom-color.custom-green-value").val(C.g),a.find("input.custom-color.custom-blue-value").val(C.b),a.find("input.custom-color").prop("disabled",!1)}a.find(".custom-color").change(function(){var e=[];e[0]=jQuery("input.custom-color.custom-red-value").val(),e[1]=jQuery("input.custom-color.custom-green-value").val(),e[2]=jQuery("input.custom-color.custom-blue-value").val();for(var t=0;3>t;t++){var n=parseInt(e[t]);if(0>n||n>255)return;e[t]=n.toString(16),1==e[t].length&&(e[t]="0"+e[t])}i.values.color=e.join(""),i._updatePreview()}),this._supportsSVG()&&this._updatePreview(a);var M=Oskari.clazz.create("Oskari.userinterface.component.Button");M.setTitle(i.loc.buttons.save),M.addClass("primary showSelection"),M.setHandler(function(){n.close()});var P=Oskari.clazz.create("Oskari.userinterface.component.Button");return P.setTitle(i.loc.buttons.cancel),P.setHandler(function(){i.values.size=i.defaultValues.size,i.values.color=i.defaultValues.color,i.values.shape=i.defaultValues.shape,n.close()}),n.show(s,a,[M,P]),n.moveTo(e,"top"),n},_selectButton:function(e){for(var t in this.symbolButtons){var i=this.symbolButtons[t],n=jQuery("div#"+i.iconId+"marker.icon-button");i.iconId.toString()===e.toString()?n.css("border","2px solid"):n.css("border","1px solid")}},_updatePreview:function(e){var t=this,i="undefined"==typeof e?jQuery(".pointform"):e,n=i.find(".preview"),s=t.values.size/35,a=400,r=a*s,o=.5*(t.previewSize-r),l={fill:"#"+t.values.color},u=[];n.svg("destroy"),n.svg({onLoad:function(e){var i=null;for(var n in t.symbolButtons){var a=t.symbolButtons[n];if(a.iconId.toString()===t.values.shape.toString()){i=a.shape.data;break}}for(var r=0;r<i.polygons.length;r++){u=[];for(var c=0;c<i.polygons[r].length;c++){u.push([]);for(var h=0;2>h;h++)u[c][h]=s*i.polygons[r][c][h]+o}e.polygon(u,l)}for(r=0;r<i.circles.length;r++){var d=s*i.circles[r].cx+o,p=s*i.circles[r].cy+o,f=s*i.circles[r].r;e.circle(d,p,f,l)}if(i.paths.length>0){var m=e.createPath(),g=m.move(0,0,!1);for(r=0;r<i.paths.length;r++)for(c=0;c<i.paths[r].length;c++){var y=i.paths[r][c];for(u=[],h=0;h<y[1].length;h++)u[h]=s*y[1][h],y[2]||(u[h]=u[h]+o);switch(y[0]){case"move":g.move(u[0],u[1],y[2]);break;case"curveC":g.curveC(u[0],u[1],u[2],u[3],u[4],u[5],y[2]);break;case"smoothC":g.smoothC(u[0],u[1],u[2],u[3],y[2]);break;case"close":g.close()}}e.path(g,l)}}})},_getOnScreenForm:function(){return jQuery("div.renderdialog")},getValues:function(){var e=null;for(var t in this.symbolButtons){var i=this.symbolButtons[t];if(i.iconId.toString()===this.values.shape.toString()){e=i.iconId;break}}return{color:this.values.color,size:this.values.size,shape:e}},_supportsSVG:function(){return!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect}}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.LineForm",function(e){this.instance=e,this.loc=e.getLocalization("lineform"),this.defaultValues={style:e.myPlacesService.defaults.line.style,cap:e.myPlacesService.defaults.line.cap,corner:e.myPlacesService.defaults.line.corner,width:e.myPlacesService.defaults.line.width,color:e.myPlacesService.defaults.line.color},this.values={style:this.defaultValues.style,cap:this.defaultValues.cap,corner:this.defaultValues.corner,width:this.defaultValues.width,color:this.defaultValues.color},this.styleButtonNames=["icon-line-basic","icon-line-dashed","icon-double-line"],this.capButtonNames=["icon-line-flat_cap","icon-line-round_cap"],this.cornerButtonNames=["icon-corner-sharp","icon-corner-round"],this.basicColors=["#ffffff","#666666","#ffde00","#f8931f","#ff3334","#bf2652","#000000","#cccccc","#652d90","#3233ff","#26bf4b","#00ff01"],this.activeColorCell=-1;for(var t=0;t<this.basicColors.length;t++)if(this.basicColors[t]==="#"+this.values.color){this.activeColorCell=t;break}this.templateLineStyleDialogContent=jQuery('<div class="lineform"><div class="container"><div class="column1"><label>'+this.loc.style.label+"</label>"+'<div class="style icon-buttons"></div>'+"<label>"+this.loc.cap.label+"</label>"+'<div class="cap icon-buttons"></div>'+"<label>"+this.loc.corner.label+"</label>"+'<div class="corner icon-buttons"></div>'+"<label>"+this.loc.width.label+"</label><br>"+'<div class="width"></div>'+"</div>"+'<div class="column2">'+'<div class="column21">'+"<label>"+this.loc.color.label+"</label>"+'<div class="color-grid">'+'<div class="color-rectangle"></div>'+"</div>"+'<div class="color-label">'+"<label>"+this.loc.color.labelOr+"</label>"+"</div>"+'<div class="color-source-selector">'+"<label>"+this.loc.color.labelCustom+"</label>"+"</div>"+'<div class="custom-colors"></div>'+"</div>"+'<div class="column22">'+"<label>"+this.loc.preview.label+"</label>"+'<div class="preview"></div>'+"</div>"+"</div>"+"</div>"+"</div>"),this.templateButton=jQuery('<div class="icon-button"></div>'),this.templateColorCell=jQuery('<div class="color-cell"></div>'),this.templateCustomColor=jQuery('<div class="custom-color-editor"><div class="colorcontainer"><div class="colorcolumn1"></div><div class="colorcolumn2"><div class="colorcolumn21"></div><div class="colorcolumn22"></div></div></div>'),this.templateColorSource=jQuery('<input type="checkbox" name="colorInput" value = "custom" class="color-source">'),this.templateColorValue=jQuery('<label class="color-label"></label><br><input type="text" name="color-input" value="0" disabled="disabled" class="custom-color">'),this.minWidth=1,this.maxWidth=10,this.templateWidthValue=jQuery('<input type="number" name="width" class="linewidth" min="'+this.minWidth+'" max="'+this.maxWidth+'" step=1 value="'+this.values.width+'">'),this.previewSize=50,this.selectColor="#dddddd"},{showForm:function(e,t){var i=this;null!=t&&(jQuery.extend(!0,i.values,t.line),i.values.width=Number(i.values.size));var n=Oskari.clazz.create("Oskari.userinterface.component.Popup");n.addClass("renderdialog"),n.addClass("linevisualization");var s=i.loc.title,a=i.templateLineStyleDialogContent.clone(),r=a.find("div.style");0===i.values.style.length&&(i.values.style=0);for(var o=0;o<i.styleButtonNames.length;o++){var l=i.templateButton.clone();l.addClass(i.styleButtonNames[o]),l.attr("id",o+"linestyle"),o===i.values.style&&this._styleSelectedButton(l),l.click(function(){var e=parseInt(jQuery(this).attr("id").charAt(0));i._selectButton("style",e),i.values.style=e,i._updatePreview(a)}),r.append(l)}r=a.find("div.cap");for(var o=0;o<i.capButtonNames.length;o++){var u=i.templateButton.clone();u.addClass(i.capButtonNames[o]),u.attr("id",o+"linecap"),o===i.values.cap&&this._styleSelectedButton(u),u.click(function(){var e=parseInt(jQuery(this).attr("id").charAt(0));i._selectButton("cap",e),i.values.cap=e,i._updatePreview(a)}),r.append(u)}r=a.find("div.corner");for(var o=0;o<i.cornerButtonNames.length;o++){var c=i.templateButton.clone();c.addClass(i.cornerButtonNames[o]),c.attr("id",o+"linecorner"),o===i.values.corner&&this._styleSelectedButton(c),c.click(function(){var e=parseInt(jQuery(this).attr("id").charAt(0));i._selectButton("corner",e),i.values.corner=e,i._updatePreview(a)}),r.append(c)}r=a.find("div.width");var h=i.templateWidthValue.clone();h.change(function(){var e=parseInt(h.val(),10);isNaN(e)||(i.values.width=e,i._updatePreview())}),h.val(null!=i.values.size?i.values.size:1),r.append(h);var d=!1;for(r=a.find(".color-rectangle"),o=0;o<i.basicColors.length;o++){var p=i.templateColorCell.clone();p.css("background-color",i.basicColors[o]);var f="ColorCell",m=o+f;m.length===f.length+1&&(m="0"+m),p.attr("id",m),p.click(function(){if(!jQuery(".color-source").prop("checked")){var e=parseInt(this.id.substring(0,2),10);if(e!==i.activeColorCell){if(i.activeColorCell>-1){var t=i.activeColorCell.toString();i.activeColorCell<10&&(t="0"+t),jQuery("#"+t+"ColorCell").css("border","1px solid #000000")}i.values.color=i.instance.rgbToHex(this.style.backgroundColor),i.activeColorCell=e,10>e&&(e="0"+e.toString()),jQuery("#"+e+"ColorCell").css("border","3px solid #ffffff"),i._updatePreview(a)}}}),"#"+i.values.color==i.basicColors[o]&&(p.css("border","3px solid #ffffff"),i.activeColorCell=o,d=!0),r.append(p)}r=a.find(".color-source-selector");var g=i.templateColorSource.clone();-1===i.activeColorCell&&g.attr("checked",!0),g.change(function(){jQuery("input.custom-color").prop("disabled",!this.checked);var e=i.activeColorCell.toString();i.activeColorCell<10&&(e="0"+e);var t=jQuery("#"+e+"ColorCell");this.checked&&(t.css("border","1px solid #000000"),jQuery(".custom-red-value").val(parseInt(i.values.color.substring(0,2),16)),jQuery(".custom-green-value").val(parseInt(i.values.color.substring(2,4),16)),jQuery(".custom-blue-value").val(parseInt(i.values.color.substring(4),16)),i.activeColorCell=-1),i._updatePreview(a)}),r.prepend(g),d||(g.checked=!0,r.find("input.color-source").prop("disabled",!1).attr("checked","checked")),r=a.find(".custom-colors");var y=this.templateCustomColor.clone();r.append(y);var v=i.templateColorValue.clone();v.addClass("custom-red-value"),-1===i.activeColorCell&&(v.val(parseInt(i.values.color.substring(0,2),16)),v.prop("disabled",!1)),a.find(".colorcolumn1").append(v),a.find("label.custom-red-value").text("R");var b=i.templateColorValue.clone();b.addClass("custom-green-value"),-1===i.activeColorCell&&(b.val(parseInt(i.values.color.substring(2,4),16)),b.prop("disabled",!1)),a.find(".colorcolumn21").append(b),a.find("label.custom-green-value").text("G");var _=i.templateColorValue.clone();if(_.addClass("custom-blue-value"),-1===i.activeColorCell&&(_.val(parseInt(i.values.color.substring(4),16)),_.prop("disabled",!1)),a.find(".colorcolumn22").append(_),a.find("label.custom-blue-value").text("B"),!d){var w=i.instance.hexToRgb(i.values.color);a.find("input.custom-color.custom-red-value").val(w.r),a.find("input.custom-color.custom-green-value").val(w.g),a.find("input.custom-color.custom-blue-value").val(w.b),a.find("input.custom-color").prop("disabled",!1)}a.find(".custom-color").change(function(){var e=[];e[0]=jQuery("input.custom-color.custom-red-value").val(),e[1]=jQuery("input.custom-color.custom-green-value").val(),e[2]=jQuery("input.custom-color.custom-blue-value").val();for(var t=0;3>t;t++){var n=parseInt(e[t]);if(0>n||n>255)return;e[t]=n.toString(16),1==e[t].length&&(e[t]="0"+e[t])}i.values.color=e.join(""),i._updatePreview()}),this._supportsSVG()&&this._updatePreview(a);var L=Oskari.clazz.create("Oskari.userinterface.component.Button");L.setTitle(i.loc.buttons.save),L.addClass("primary showSelection"),L.setHandler(function(){n.close()});var k=Oskari.clazz.create("Oskari.userinterface.component.Button");return k.setTitle(i.loc.buttons.cancel),k.setHandler(function(){i.values.size=i.defaultValues.size,i.values.color=i.defaultValues.color,i.values.shape=i.defaultValues.shape,n.close()}),n.show(s,a,[L,k]),n.moveTo(e,"top"),i._updatePreview(),n},_selectButton:function(e,t){this._styleUnselectedButton(jQuery("div#"+this.values[e]+"line"+e+".icon-button")),this._styleSelectedButton(jQuery("div#"+t+"line"+e+".icon-button"))},_updatePreview:function(e){var t=this,i="undefined"==typeof e?jQuery(".lineform"):e,n=i.find(".preview");n.svg("destroy"),n.svg({onLoad:function(e){var i=e.createPath(),n=e.group({stroke:"#"+t.values.color,fill:"none",strokeWidth:t.values.width,strokeLineJoin:0===t.values.corner?"miter":"round",strokeLineCap:0===t.values.cap?"butt":"round",strokeDashArray:1===t.values.style?[3,2+.25*t.values.width]:null}),s=[10,15],a=[20,35],r=[40,25];if(2!==t.values.style)e.path(n,i.move(s[0],s[1],!1).line([a,r]));else{var o=1.5+.5*t.values.width,l=[s[0]+2*o/Math.sqrt(5),s[1]-o/Math.sqrt(5)],u=[s[0]-2*o/Math.sqrt(5),s[1]+o/Math.sqrt(5)],c=[];c[0]=a[0]+.5*o*(Math.sqrt(3)-1),c[1]=a[1]-.5*o*(Math.sqrt(3)+1);var h=[];h[0]=a[0]-.5*o*(Math.sqrt(3)-1),h[1]=a[1]+.5*o*(Math.sqrt(3)+1);var d=[r[0]-o/Math.sqrt(5),r[1]-2*o/Math.sqrt(5)],p=[r[0]+o/Math.sqrt(5),r[1]+2*o/Math.sqrt(5)];e.path(n,i.move(l[0],l[1],!1).line([c,d]).move(u[0],u[1],!1).line([h,p]))}}})},_getOnScreenForm:function(){return jQuery("div.renderdialog")},getValues:function(){var e=null;for(var t in this.symbolButtons){var i=this.symbolButtons[t];if(i.iconId.toString()===this.values.shape.toString()){e=i.iconId;break}}return{color:this.values.color,width:this.values.size,shape:e}},_styleSelectedButton:function(e){e.css("border","2px solid"),e.css("background-color",this.selectColor)},_styleUnselectedButton:function(e){e.css("border","1px solid"),e.css("background-color","transparent")},_supportsSVG:function(){return!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect}}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.AreaForm",function(e){this.instance=e,this.loc=e.getLocalization("areaform"),this.defaultValues={color:[e.myPlacesService.defaults.area.linecolor,e.myPlacesService.defaults.area.color],line:{style:e.myPlacesService.defaults.area.linestyle,corner:e.myPlacesService.defaults.area.linecorner,width:e.myPlacesService.defaults.area.linewidth,color:e.myPlacesService.defaults.area.linecolor},fill:e.myPlacesService.defaults.area.fill},this.values={lineWidth:this.defaultValues.line.width,lineCorner:this.defaultValues.line.corner,lineStyle:this.defaultValues.line.style,lineColor:this.defaultValues.color[0],fillColor:this.defaultValues.color[1],fillStyle:this.defaultValues.fill},this.styleButtonNames=["icon-line-basic","icon-line-dashed","icon-double-line"],this.cornerButtonNames=["icon-corner-sharp","icon-corner-round"],this.colorTypes=["line","fill"],this.basicColors=["#ffffff","#666666","#ffde00","#f8931f","#ff3334","#bf2652","#000000","#cccccc","#652d90","#3233ff","#26bf4b","#00ff01"],this.activeColorCell=[-1,-1];for(var t=0;t<this.basicColors.length;t++)for(var i=0;i<this.basicColors.length;i++)if(this.basicColors[i]==="#"+this.values.fillColor[t]){this.activeColorCell[t]=i;break}this.fillButtonNames=["icon-line-thin-diagonal","icon-line-wide-diagonal","icon-line-thin-horizontal","icon-line-wide-horizontal"],this.templateAreaStyleDialogContent=jQuery('<div class="areaform"><div class="container"><div class="column1"><label>'+this.loc.linestyle.label+"</label>"+'<div class="style icon-buttons"></div>'+"<label>"+this.loc.linecorner.label+"</label>"+'<div class="corner icon-buttons"></div>'+"<label>"+this.loc.linewidth.label+"</label><br>"+'<div class="width"></div>'+"</div>"+'<div class="column2">'+'<div class="column21">'+"<label>"+this.loc.linecolor.label+"</label>"+'<div class="color-grid">'+'<div class="color-rectangle line"></div>'+"</div>"+'<div class="color-label">'+"<label>"+this.loc.linecolor.labelOr+"</label>"+"</div>"+'<div class="color-source-selector-line">'+"<label>"+this.loc.linecolor.labelCustom+"</label>"+"</div>"+'<div class="custom-colors-line"></div>'+"</div>"+'<div class="column22">'+'<div class="column221">'+"<label>"+this.loc.color.label+"</label>"+'<div class="color-grid">'+'<div class="color-rectangle fill"></div>'+"</div>"+'<div class="color-label">'+"<label>"+this.loc.color.labelOr+"</label>"+"</div>"+'<div class="color-source-selector-fill">'+"<label>"+this.loc.color.labelCustom+"</label>"+"</div>"+'<div class="custom-colors-fill"></div>'+"<label>"+this.loc.fill.label+"</label>"+'<div class="fill icon-buttons"></div>'+"</div>"+'<div class="column222">'+"<label>"+this.loc.preview.label+"</label>"+'<div class="preview"></div>'+"</div>"+"</div>"+"</div>"+"</div>"+"</div>"),this.templateButton=jQuery('<div class="icon-button"></div>'),this.templateColorCell=jQuery('<div class="color-cell"></div>'),this.templateCustomColor=jQuery('<div class="custom-color-editor"><div class="colorcontainer"><div class="colorcolumn1"></div><div class="colorcolumn2"><div class="colorcolumn21"></div><div class="colorcolumn22"></div></div></div>'),this.templateColorSource=jQuery('<input type="checkbox" name="colorInput" value = "custom" class="color-source">'),this.templateColorValue=jQuery('<label class="color-label"></label><br><input type="text" name="color-input" value="0" disabled="disabled" class="custom-color">'),this.minWidth=1,this.maxWidth=5,this.templateWidthValue=jQuery('<input type="number" name="width" class="linewidth" min="'+this.minWidth+'" max="'+this.maxWidth+'" step=1 value="'+this.values.lineWidth+'">'),this.previewSize=50,this.selectColor="#dddddd"},{showForm:function(e,t){var i=this;null!=t&&jQuery.extend(!0,i.values,t.area);var n=Oskari.clazz.create("Oskari.userinterface.component.Popup");n.addClass("renderdialog"),n.addClass("areavisualization");var s=i.loc.title,a=i.templateAreaStyleDialogContent.clone(),r=a.find("div.style");0===i.values.lineStyle.length&&(i.values.lineStyle=0);for(var o=0;o<i.styleButtonNames.length;o++){var l=i.templateButton.clone();l.addClass(i.styleButtonNames[o]),l.attr("id",o+"linestyle"),o===i.values.lineStyle&&this._styleSelectedButton(l),l.click(function(){var e=parseInt(jQuery(this).attr("id").charAt(0));i._selectButton("lineStyle",e),i.values.lineStyle=e,i._updatePreview(a)}),r.append(l)}r=a.find("div.corner");for(var o=0;o<i.cornerButtonNames.length;o++){var u=i.templateButton.clone();u.addClass(i.cornerButtonNames[o]),u.attr("id",o+"linecorner"),o===i.values.lineCorner&&this._styleSelectedButton(u),u.click(function(){var e=parseInt(jQuery(this).attr("id").charAt(0));i._selectButton("lineCorner",e),i.values.lineCorner=e,i._updatePreview(a)}),r.append(u)}r=a.find("div.width");var c=i.templateWidthValue.clone();c.val(null!=i.values.lineWidth?i.values.lineWidth:1),c.change(function(){var e=parseInt(c.val(),10);isNaN(e)||(i.values.lineWidth=e,i._updatePreview())}),r.append(c);for(var h=0;2>h;h++){var d=!1,p=0==h?"lineColor":"fillColor";for(r=a.find(".color-rectangle."+i.colorTypes[h]),o=0;o<i.basicColors.length;o++){var f=i.templateColorCell.clone();f.css("background-color",i.basicColors[o]);var m="ColorCell",g=o.toString()+h.toString()+m;g.length===m.length+2&&(g="0"+g),f.attr("id",g),f.click(function(){var e=parseInt(this.id.substring(0,2),10),t=parseInt(this.id.substring(2,3),10);if(!jQuery("#"+t+"color-checkbox").prop("checked")&&e!==i.activeColorCell[t]){if(i.activeColorCell[t]>-1){var n=i.activeColorCell[t].toString();i.activeColorCell[t]<10&&(n="0"+n),jQuery("#"+n+t+"ColorCell").css("border","1px solid #000000")}i.values[0==t?"lineColor":"fillColor"]=i.instance.rgbToHex(this.style.backgroundColor),i.activeColorCell[t]=e,10>e&&(e="0"+e.toString()),jQuery("#"+e+t+"ColorCell").css("border","3px solid #ffffff"),i._updatePreview(a)}}),"#"+i.values[p]==i.basicColors[o]&&(f.css("border","3px solid #ffffff"),i.activeColorCell[h]=o,d=!0),r.append(f)}r=a.find(".color-source-selector-"+i.colorTypes[h]);var y=i.templateColorSource.clone();y.attr("id",h+"color-checkbox"),-1===i.activeColorCell[h]&&y.attr("checked",!0),y.change(function(){var e=this.id.substring(0,1),t=0==e?"lineColor":"fillColor";
jQuery("input.custom-color."+i.colorTypes[e]).prop("disabled",!this.checked);var n=i.activeColorCell[e].toString();i.activeColorCell[e]<10&&(n="0"+n);var s=jQuery("#"+n+e+"ColorCell");this.checked&&(s.css("border","1px solid #000000"),jQuery(".custom-red-value."+i.colorTypes[e]).val(parseInt(i.values[t].substring(0,2),16)),jQuery(".custom-green-value."+i.colorTypes[e]).val(parseInt(i.values[t].substring(2,4),16)),jQuery(".custom-blue-value."+i.colorTypes[e]).val(parseInt(i.values[t].substring(4),16)),i.activeColorCell[e]=-1),i._updatePreview(a)}),r.prepend(y),d||(y.checked=!0,r.find("input.color-source").prop("disabled",!1).attr("checked","checked")),r=a.find(".custom-colors-"+i.colorTypes[h]);var v=this.templateCustomColor.clone();v.addClass(i.colorTypes[h]),r.append(v);var b=i.templateColorValue.clone();b.addClass("custom-red-value"),b.addClass(i.colorTypes[h]),-1===i.activeColorCell[h]&&(b.val(parseInt(i.values.lineColor.substring(0,2),16)),b.prop("disabled",!1)),r.find(".colorcolumn1").append(b),r.find("label.custom-red-value").text("R"),r.find("input.custom-red-value").attr("id",h+"red-value");var _=i.templateColorValue.clone();_.addClass("custom-green-value"),_.addClass(i.colorTypes[h]),-1===i.activeColorCell[h]&&(_.val(parseInt(i.values[p].substring(2,4),16)),_.prop("disabled",!1)),r.find(".colorcolumn21").append(_),r.find("label.custom-green-value").text("G"),r.find("input.custom-green-value").attr("id",h+"green-value");var w=i.templateColorValue.clone();if(w.addClass("custom-blue-value"),w.addClass(i.colorTypes[h]),-1===i.activeColorCell[h]&&(w.val(parseInt(i.values[p].substring(4),16)),w.prop("disabled",!1)),r.find(".colorcolumn22").append(w),r.find("label.custom-blue-value").text("B"),r.find("input.custom-blue-value").attr("id",h+"blue-value"),!d){var L=i.instance.hexToRgb(i.values[p]);r.find("input.custom-color.custom-red-value").val(L.r),r.find("input.custom-color.custom-green-value").val(L.g),r.find("input.custom-color.custom-blue-value").val(L.b),a.find("input#"+h.toString()+"red-value.custom-color").prop("disabled",!1),a.find("input#"+h.toString()+"green-value.custom-color").prop("disabled",!1),a.find("input#"+h.toString()+"blue-value.custom-color").prop("disabled",!1)}r.find(".custom-color").change(function(){var e=this.id.substring(0,1),t=[];t[0]=jQuery("input#"+e+"red-value").val(),t[1]=jQuery("input#"+e+"green-value").val(),t[2]=jQuery("input#"+e+"blue-value").val();for(var n=0;3>n;n++){var s=parseInt(t[n]);if(0>s||s>255)return;t[n]=s.toString(16),1==t[n].length&&(t[n]="0"+t[n])}i.values[0==e?"lineColor":"fillColor"]=t.join(""),i._updatePreview()})}r=a.find("div.fill.icon-buttons");for(var o=0;o<i.fillButtonNames.length;o++){var k=i.templateButton.clone();k.addClass(i.fillButtonNames[o]),k.attr("id",o+"fillstyle"),o===i.values.fillStyle&&this._styleSelectedButton(k),k.click(function(){var e=parseInt(jQuery(this).attr("id").charAt(0));i.values.fillStyle===e?(i.values.fillStyle=-1,i._styleUnselectedButton(jQuery("div#"+e+"fillstyle.icon-button"))):(-1!==i.values.fillStyle&&i._styleUnselectedButton(jQuery("div#"+i.values.fillStyle+"fillstyle.icon-button")),i._styleSelectedButton(jQuery("div#"+e+"fillstyle.icon-button")),i.values.fillStyle=e),i._updatePreview(a)}),r.append(k)}this._supportsSVG()&&this._updatePreview(a);var O=Oskari.clazz.create("Oskari.userinterface.component.Button");O.setTitle(i.loc.buttons.save),O.addClass("primary showSelection"),O.setHandler(function(){n.close()});var x=Oskari.clazz.create("Oskari.userinterface.component.Button");return x.setTitle(i.loc.buttons.cancel),x.setHandler(function(){i.values.lineWidth=i.defaultValues.line.width,i.values.lineCorner=i.defaultValues.line.corner,i.values.lineStyle=i.defaultValues.line.style,i.values.lineColor=i.defaultValues.color[0],i.values.fillColor=i.defaultValues.color[1],i.values.fillStyle=i.defaultValues.fill,n.close()}),n.show(s,a,[O,x]),n.moveTo(e,"top"),n},_selectButton:function(e,t){var i=e.substring(4).toLowerCase();this._styleUnselectedButton(jQuery("div#"+this.values[e]+"line"+i+".icon-button")),this._styleSelectedButton(jQuery("div#"+t+"line"+i+".icon-button"))},_updatePreview:function(e){var t=this,i="undefined"==typeof e?jQuery(".areaform"):e,n=i.find(".preview");n.svg("destroy"),n.svg({onLoad:function(e){var i=e.createPath(),n=t.values.fillStyle<0?"#"+t.values.fillColor:"url(#"+t.fillButtonNames[t.values.fillStyle]+")",s=e.group({stroke:"#"+t.values.lineColor,fill:n,strokeWidth:t.values.lineWidth,strokeLineJoin:0===t.values.lineCorner?"miter":"round",strokeDashArray:1===t.values.lineStyle?[3,2+.25*t.values.lineWidth]:null});if(t.values.fillStyle>=0){var a=null,r=e.createPath();switch(t.values.fillStyle){case 0:a=e.pattern(t.fillButtonNames[t.values.fillStyle],0,0,4,4,0,0,4,4,{patternUnits:"userSpaceOnUse"}),e.path(a,r.move(0,4,!1).line([[4,0]]),{strokeWidth:1,stroke:"#"+t.values.fillColor,fill:"none"});break;case 1:a=e.pattern(t.fillButtonNames[t.values.fillStyle],0,0,6,6,0,0,6,6,{patternUnits:"userSpaceOnUse"}),e.path(a,r.move(-1,1,!1).line([[1,-1]]).move(0,6,!1).line([[6,0]]).move(5,7,!1).line([[7,5]]),{strokeWidth:2,stroke:"#"+t.values.fillColor,fill:"none"});break;case 2:a=e.pattern(t.fillButtonNames[t.values.fillStyle],0,4,4,4,0,0,4,4,{patternUnits:"userSpaceOnUse"}),e.path(a,r.move(0,.5,!1).line([[4,.5]]),{strokeWidth:1,stroke:"#"+t.values.fillColor,fill:"none"});break;case 3:a=e.pattern(t.fillButtonNames[t.values.fillStyle],0,0,5,5,0,0,5,5,{patternUnits:"userSpaceOnUse"}),e.path(a,r.move(0,2,!1).line([[5,2]]),{strokeWidth:2,stroke:"#"+t.values.fillColor,fill:"none"})}}var o=[10,17],l=[40,12],u=[29,40];if(e.path(s,i.move(o[0],o[1],!1).line([l,u]).close()),2===t.values.lineStyle){var c=2*(2+t.values.lineWidth),h=Math.atan(Math.abs((l[1]-o[1])/(l[0]-o[0]))),d=[o[0]+c*Math.sin(Math.PI/3+h),o[1]+c*Math.cos(Math.PI/3+h)],p=Math.atan(Math.abs((u[1]-l[1])/(u[0]-l[0]))),f=[l[0]-c*Math.sin(Math.PI/3+p),l[1]-c*Math.cos(Math.PI/3+p)],m=Math.atan(Math.abs((o[1]-u[1])/(o[0]-u[0]))),g=[u[0]-c*Math.cos(Math.PI/6+m),u[1]-c*Math.sin(Math.PI/6+m)];e.path(s,i.move(d[0],d[1],!1).line([f,g]).close())}}})},_getOnScreenForm:function(){return jQuery("div.renderdialog")},_styleSelectedButton:function(e){e.css("border","2px solid"),e.css("background-color",this.selectColor)},_styleUnselectedButton:function(e){e.css("border","1px solid"),e.css("background-color","transparent")},_supportsSVG:function(){return!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect}}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.CategoryForm",function(e){this.instance=e,this.pointRenderForm=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.PointForm",this.instance),this.lineRenderForm=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.LineForm",this.instance),this.areaRenderForm=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.AreaForm",this.instance);var t=e.getLocalization("categoryform");this.renderButtons={point:{iconCls:"icon-point",tooltip:t.rendering.point.tooltip,sticky:!1,callback:function(){}},line:{iconCls:"icon-line",tooltip:t.rendering.line.tooltip,sticky:!1,callback:function(){}},area:{iconCls:"icon-area",tooltip:t.rendering.area.tooltip,sticky:!1,callback:function(){}}},this.template=jQuery('<div class="myplacescategoryform"><div class="field"><label for="categoryname">'+t.name.label+'</label><br clear="all" />'+'<input type="text" name="categoryname" placeholder="'+t.name.placeholder+'"/>'+"</div>"+'<div class="field drawing">'+"<label>"+t.drawing.label+'</label><br clear="all" />'+'<div class="rendering"></div>'+"</div>"+'<div class="field visibleFields">'+"<label>"+t.visibleFields.label+'</label><br clear="all" />'+'<input type="checkbox" name="placename" checked="checked" />'+t.visibleFields.placename+"<br/>"+'<input type="checkbox" name="placedesc" checked="checked" />'+t.visibleFields.placedesc+"<br/>"+'<input type="checkbox" name="image" checked="checked" />'+t.visibleFields.image+"<br/>"+"</div>"+"</div>"),this.templateTableRow=jQuery("<tr></tr>"),this.templateTableCell=jQuery("<td></td>"),this.templateTextInput=jQuery('<input type="text"/>'),this.templateRenderButton=jQuery('<div class="renderButton" style= "display: inline-block; border: 1px solid;"></div>'),this.defaults={lineStyle:"",lineCap:0,lineCorner:0,lineWidth:1,lineColor:"3233ff",areaLineWidth:1,areaLineCorner:0,areaLineStyle:"",areaLineColor:"000000",areaFillColor:"ffde00",areaFillStyle:-1,dotShape:1,dotSize:3,dotColor:"000000"},this.categoryId=void 0,this._isDefault=void 0,this.initialValues=void 0,this.lineCapMap=["butt","round"],this.lineCornerMap=["mitre","round","bevel"],this.lineStyleMap=["","5 2",""]},{start:function(){this._bindRenderButtons()},getForm:function(){var e=this.template.clone();e.find("div.drawing table");var t=e.find("div.rendering");for(var i in this.renderButtons){var n=this.templateRenderButton.clone(),s=this.renderButtons[i];n.attr("title",s.tooltip),n.addClass(s.iconCls),t.append(n)}return e},getValues:function(){var e={},t=this._getOnScreenForm();if(t.length>0){e.name=t.find("input[name=categoryname]").val(),this.categoryId&&(e.id=this.categoryId),e._isDefault=this._isDefault||!1;var i=this.pointRenderForm.values.size,n=this.pointRenderForm.values.color,s=this.pointRenderForm.values.shape;e.dot={size:i,color:n,shape:s};var a=this.lineRenderForm.values.width,r=this.lineRenderForm.values.color,o=this.lineRenderForm.values.corner,l=this.lineRenderForm.values.cap,u=this.lineRenderForm.values.style;e.line={width:a,color:r,cap:this.lineCapMap[l],corner:this.lineCornerMap[o],style:this.lineStyleMap[u]};var c=this.areaRenderForm.values.lineWidth,h=this.areaRenderForm.values.lineCorner,d=this.areaRenderForm.values.lineStyle,p=this.areaRenderForm.values.lineColor,f=this.areaRenderForm.values.fillColor,m=this.areaRenderForm.values.fillStyle;e.area={lineWidth:c,lineCorner:this.lineCornerMap[h],lineStyle:this.lineStyleMap[d],lineColor:p,fillColor:f,fillStyle:m},e.visibleFields=[],t.find("div.visibleFields").find("input[type=checkbox]:checked").each(function(){e.visibleFields.push(this.name)})}return e},setValues:function(e){this.categoryId=e.id,this._isDefault=e._isDefault;var t=this._getOnScreenForm();t.length>0&&(t.find("input[name=dotSize]").val(e.dot.size),t.find("input[name=dotColor]").val(e.dot.color),t.find("input[name=lineSize]").val(e.line.size),t.find("input[name=lineColor]").val(e.line.color),t.find("input[name=areaLineSize]").val(e.area.lineWidth),t.find("input[name=areaLineColor]").val(e.area.lineColor),t.find("input[name=areaFillColor]").val(e.area.fillColor),this._checkVisibleFields(e.visibleFields));for(var i=0;i<this.lineCapMap.length;i++)e.line.cap===this.lineCapMap[i]&&(e.line.cap=i);for(var i=0;i<this.lineCornerMap.length;i++)e.line.corner===this.lineCornerMap[i]&&(e.line.corner=i),e.area.lineCorner===this.lineCornerMap[i]&&(e.area.lineCorner=i);for(var i=0;i<this.lineStyleMap.length;i++)e.line.style===this.lineStyleMap[i]&&(e.line.style=i),e.area.lineStyle===this.lineStyleMap[i]&&(e.area.lineStyle=i);this.initialValues=e},_bindRenderButtons:function(){var e=this,t=this._getOnScreenForm(),i=t.find("div.renderButton.icon-point");i.off("click"),i.on("click",function(){e.dialog&&e.dialog.close(!0),e.dialog=e.pointRenderForm.showForm(this,e.initialValues)});var n=t.find("div.renderButton.icon-line");n.off("click"),n.on("click",function(){e.dialog&&e.dialog.close(!0),e.dialog=e.lineRenderForm.showForm(this,e.initialValues)});var s=t.find("div.renderButton.icon-area");s.off("click"),s.on("click",function(){e.dialog&&e.dialog.close(!0),e.dialog=e.areaRenderForm.showForm(this,e.initialValues)})},_getOnScreenForm:function(){return jQuery("div.myplacescategoryform")},destroy:function(){"undefined"!=typeof this.dialog&&this.dialog.close();var e=this._getOnScreenForm();e.remove()}}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.ButtonHandler",function(e){this.instance=e,this.buttonGroup="myplaces",this.ignoreEvents=!1,this.dialog=null;var t=this;this.buttons={point:{iconCls:"myplaces-draw-point",tooltip:"",sticky:!0,callback:function(){t.startNewDrawing({drawMode:"point"})}},line:{iconCls:"myplaces-draw-line",tooltip:"",sticky:!0,callback:function(){t.startNewDrawing({drawMode:"line"})}},area:{iconCls:"myplaces-draw-area",tooltip:"",sticky:!0,callback:function(){t.startNewDrawing({drawMode:"area"})}}},this.templateGuide=jQuery('<div><div class="guide"></div><div class="buttons"><div class="cancel button"></div><div class="finish button"></div></div></div>')},{__name:"MyPlacesButtonHandler",getName:function(){return this.__name},init:function(){var e=this.instance.getLocalization("tools"),t=this.instance.sandbox.getUser(),i=" - "+this.instance.getLocalization("guest").loginShort;for(var n in this.buttons){var s=e[n].tooltip;t.isLoggedIn()||(s+=i),this.buttons[n].tooltip=s}},start:function(){var e=this,t=this.instance.sandbox;t.register(e);for(p in e.eventHandlers)t.registerForEventByName(e,p);var i=t.getRequestBuilder("Toolbar.AddToolButtonRequest");for(var n in this.buttons)t.request(this,i(n,this.buttonGroup,this.buttons[n]));var s=this.instance.sandbox.getUser();s.isLoggedIn()||this.disableButtons()},disableButtons:function(){var e=this.instance.sandbox,t=e.getRequestBuilder("Toolbar.ToolButtonStateRequest");e.request(this,t(void 0,this.buttonGroup,!1))},startNewDrawing:function(e){var t=this.instance.sandbox.getEventBuilder("MyPlaces.MyPlaceSelectedEvent")();this.instance.sandbox.notifyAll(t),this.sendDrawRequest(e),this.instance.enableGfi(!1)},sendDrawRequest:function(e){var t=this.instance.sandbox.getRequestBuilder("MyPlaces.StartDrawingRequest")(e);this.instance.sandbox.request(this,t),e.geometry||this._showDrawHelper(e.drawMode)},_showDrawHelper:function(e){var t=this,i=this.instance.getLocalization("tools")[e],n=this.instance.getLocalization("buttons"),s=this.instance.getLocalization("title"),a=i.add,r=Oskari.clazz.create("Oskari.userinterface.component.Popup");this.dialog=r;var o=[],l=Oskari.clazz.create("Oskari.userinterface.component.Button");l.setTitle(n.cancel),l.setHandler(function(){var e=t.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();t.instance.sandbox.request(t,e),t.sendStopDrawRequest(!0)}),o.push(l);var u=Oskari.clazz.create("Oskari.userinterface.component.Button");u.setTitle(n.finish),u.addClass("primary"),u.setHandler(function(){t.sendStopDrawRequest()}),o.push(u),r.show(s,a,o),r.addClass("myplaces2"),r.moveTo("#toolbar div.toolrow[tbgroup=myplaces]","top")},sendStopDrawRequest:function(e){var t=this.instance.sandbox.getRequestBuilder("MyPlaces.StopDrawingRequest")(e);this.instance.sandbox.request(this,t),this.dialog&&this.dialog.close()},stop:function(){jQuery("div.myplaces2 div.button").die()},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{"Toolbar.ToolSelectedEvent":function(){this.ignoreEvents||(this.sendStopDrawRequest(!0),this.instance.enableGfi(!0))},"MyPlaces.MyPlaceSelectedEvent":function(e){if(!e.getPlace()){var t=this.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();this.instance.sandbox.request(this,t)}},"MyPlaces.FinishedDrawingEvent":function(){this.ignoreEvents=!0;var e=this.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();this.instance.sandbox.request(this,e),this.ignoreEvents=!1,this.instance.enableGfi(!1),this.dialog&&this.dialog.close()},"MyPlaces.AddedFeatureEvent":function(e){if("undefined"!=typeof e.getDrawingMode()&&null!==e.getDrawingMode()){var t=this.instance.getLocalization("tools"),i=t[e.getDrawingMode()].next;this.dialog.getContent()!==i&&(this.dialog.setContent(i),this.dialog.moveTo("#toolbar div.toolrow[tbgroup=myplaces]","top"))}}}},{protocol:["Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.CategoryHandler",function(e){this.instance=e,this.initialLoad=!0,this.validateTool=Oskari.clazz.create("Oskari.userinterface.component.FormInput")},{__name:"MyPlacesCategoryHandler",getName:function(){return this.__name},init:function(){},start:function(){var e=this,t=this.instance.sandbox,i=t.getUser();if(i.isLoggedIn()){t.register(e);for(p in e.eventHandlers)t.registerForEventByName(e,p)}},stop:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{"MyPlaces.MyPlacesChangedEvent":function(){this._handlePlacesChanged()}},_handlePlacesChanged:function(){for(var e=this.instance.sandbox,t=e.getService("Oskari.mapframework.service.MapLayerService"),i=this.instance.getService().getAllCategories(),n=t.getAllLayersByMetaType(this.instance.idPrefix),s=0;s<n.length;++s){for(var a=n[s],r=!1,o=0;o<i.length;++o){var l=i[o];this._getMapLayerId(l.getId())===a.getId()&&(r=!0)}r||(e.requestByName(this.getName(),"RemoveMapLayerRequest",[a.getId()]),t.removeLayer(a.getId()))}for(var o=0;o<i.length;++o){for(var l=i[o],r=!1,s=0;s<n.length;++s)if(this._getMapLayerId(l.getId())===n[s].getId()&&(r=!0,l.getName()!==n[s].getName())){var u={name:l.getName()};t.updateLayer(n[s].getId(),u)}if(!r){var c=this._getMapLayerJson(l),h=t.createMapLayer(c);t.addLayer(h,this.initialLoad)}}if(this.initialLoad){var d=e.getEventBuilder("MapLayerEvent")(null,"add");e.notifyAll(d),this._processStartupLinkLayers(e),this.initialLoad=!1}},addLayerToMap:function(e){var t=this._getMapLayerId(e),i=this.sandbox.findMapLayerFromSelectedMapLayers(t);if(!i){var n=this.sandbox.getRequestBuilder("AddMapLayerRequest")(t,!0);this.sandbox.request(this.getName(),n)}},addLayerToService:function(e){var t=this._sandbox.getService("Oskari.mapframework.service.MapLayerService"),i=this._getMapLayerJson(e),n=t.createMapLayer(i);t.addLayer(n)},_getMapLayerId:function(e){if(!e){var t=this.myPlacesService.getDefaultCategory();e=t?t.getId():"-99"}return this.instance.idPrefix+"_"+e},_getMapLayerJson:function(e){var t=this._getMapLayerJsonBase();return t.wmsUrl=this.instance.conf.wmsUrl+e.getId()+"&",t.name=e.getName(),t.id=this._getMapLayerId(e.getId()),t.permissions=e.isPublic()?{publish:"publication_permission_ok"}:{publish:"no_publication_permission"},t},_getMapLayerJsonBase:function(){var e=this.instance.getLocalization("category"),t={wmsName:"ows:my_places_categories",type:"wmslayer",isQueryable:!0,opacity:90,metaType:this.instance.idPrefix,orgName:e.organization,inspire:e.inspire};return t},_processStartupLinkLayers:function(e){var t=e.getRequestParameter("mapLayers");if(null!==t&&""!==t)for(var i=t.split(","),n=!0,s=0;s<i.length;s++){var a=i[s].split("+"),r=a[0],o=a[1];if(null!==r&&-1!==r.indexOf(this.instance.idPrefix)){var l=null,u=null;l=e.getRequestBuilder("AddMapLayerRequest"),u=l(r,n),e.request(this.getName(),u),l=e.getRequestBuilder("ChangeMapLayerOpacityRequest"),u=l(r,o),e.request(this.getName(),u)}}},editCategory:function(e){var t=this;this.instance.sandbox.postRequestByName("DisableMapKeyboardMovementRequest");var i=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.CategoryForm",t.instance),n={name:e.getName(),id:e.getId(),_isDefault:e.isDefault(),dot:{size:e.getDotSize(),color:e.getDotColor(),shape:null!=e.getDotShape()?e.getDotShape():1},line:{cap:e.getLineCap(),corner:e.getLineCorner(),style:e.getLineStyle(),size:e.getLineWidth(),color:e.getLineColor()},area:{lineWidth:e.getAreaLineWidth(),lineCorner:e.getAreaLineCorner(),lineStyle:e.getAreaLineStyle(),lineColor:e.getAreaLineColor(),fillColor:e.getAreaFillColor(),fillStyle:e.getAreaFillStyle()}};i.setValues(n);var s=i.getForm();s.find("input[name=categoryname]").val(e.name);var a=Oskari.clazz.create("Oskari.userinterface.component.Popup"),r=[],o=Oskari.clazz.create("Oskari.userinterface.component.Button"),l=this.instance.getLocalization("buttons"),u=this.instance.getLocalization("categoryform").edit;o.setTitle(l.save),o.addClass("primary"),o.setHandler(function(){var e=i.getValues(),n=t.validateCategoryFormValues(e);if(0!=n.length)return t.showValidationErrorMessage(n),void 0;var s=t.getCategoryFromFormValues(e);t.saveCategory(s),a.close(),t.instance.sandbox.postRequestByName("EnableMapKeyboardMovementRequest")});var c=Oskari.clazz.create("Oskari.userinterface.component.Button");c.setTitle(l.cancel),c.setHandler(function(){a.close()}),r.push(c),r.push(o),a.show(u.title,s,r),a.moveTo("div.personaldata ul li select","right"),a.makeModal(),i.start()},showValidationErrorMessage:function(e){var t=this.instance.getLocalization(),i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=Oskari.clazz.create("Oskari.userinterface.component.Button");n.setTitle(t.buttons.ok),n.addClass("primary"),n.setHandler(function(){i.close(!0)});for(var s=jQuery("<ul></ul>"),a=0;a<e.length;++a){var r=jQuery("<li></li>");r.append(e[a].error),s.append(r)}i.show(t.validation.title,s,[n])},_showMessage:function(e,t){var i=this.instance.getLocalization(),n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(i.buttons.ok),s.addClass("primary"),s.setHandler(function(){n.close(!0)}),n.show(e,t,[s])},hasIllegalChars:function(e){return this.validateTool.setValue(e),!this.validateTool.checkValue()},_validateNumber:function(e,t,i){return this.validateTool.validateNumberRange(e,t,i)},_isColor:function(e){return this.validateTool.validateHexColor(e)},validateCategoryFormValues:function(e){var t=[];if(!e)return t;var i=this.instance.getLocalization("validation");return e.name?this.hasIllegalChars(e.name)&&t.push({field:"name",error:i.categoryNameIllegal}):t.push({field:"name",error:i.categoryName}),this._validateNumber(e.dot.shape,0,6)||t.push({field:"dotShape",error:i.dotShape}),this._validateNumber(e.dot.size,1,5)||t.push({field:"dotSize",error:i.dotSize}),this._isColor(e.dot.color)||t.push({field:"dotColor",error:i.dotColor}),this._validateNumber(e.line.width,1,50)||t.push({field:"lineWidth",error:i.lineSize}),this._isColor(e.line.color)||t.push({field:"lineColor",error:i.lineColor}),this._validateNumber(e.area.lineWidth,0,50)||t.push({field:"areaLineWidth",error:i.areaLineSize}),this._isColor(e.area.lineColor)||t.push({field:"areaLineColor",error:i.areaLineColor}),this._isColor(e.area.fillColor)||t.push({field:"areaFillColor",error:i.areaFillColor}),t},getCategoryFromFormValues:function(e){var t=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlacesCategory");return t.setName(e.name),t.setId(e.id),t.setDotSize(e.dot.size),t.setDotColor(e.dot.color),t.setDotShape(e.dot.shape),t.setLineWidth(e.line.width),t.setLineColor(e.line.color),t.setLineCap(e.line.cap),t.setLineCorner(e.line.corner),t.setLineStyle(e.line.style),t.setAreaLineWidth(e.area.lineWidth),t.setAreaLineColor(e.area.lineColor),t.setAreaLineCorner(e.area.lineCorner),t.setAreaLineStyle(e.area.lineStyle),t.setAreaFillColor(e.area.fillColor),t.setAreaFillStyle(e.area.fillStyle),t.setDefault(e._isDefault),t},saveCategory:function(e){var t=this,i=t.instance.getLocalization("notification"),n=function(n,s,a){if(n){var r=Oskari.clazz.create("Oskari.userinterface.component.Popup");r.show(i.categorySaved.title,i.categorySaved.message),r.fadeout();var o=t._getMapLayerId(e.getId()),l=t.instance.sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(o,!0);t.instance.sandbox.request(t,l)}else a?t.instance.showMessage(i.error.title,i.error.addCategory):t.instance.showMessage(i.error.title,i.error.editCategory)};this.instance.getService().saveCategory(e,n)},confirmDeleteCategory:function(e){var t=this,i=t.instance.getLocalization("buttons"),n=this.instance.getService(),s=n.getDefaultCategory(),a=Oskari.clazz.create("Oskari.userinterface.component.Popup");if(s.getId()==e.getId()){var r=t.instance.getLocalization(),o=a.createCloseButton(r.buttons.ok);return a.show(r.notification.error.title,r.notification.error.deleteDefault,[o]),void 0}var l=n.getPlacesInCategory(e.getId()),u=[],c=a.createCloseButton(i.cancel);u.push(c);var r=t.instance.getLocalization("notification"),h="";if(l.length>0){var d=Oskari.clazz.create("Oskari.userinterface.component.Button");d.setTitle(i.deleteCategoryAndPlaces),d.setHandler(function(){a.close(),t._deleteCategory(e,!1)}),u.push(d);var p=Oskari.clazz.create("Oskari.userinterface.component.Button");p.setTitle(i.movePlaces),p.addClass("primary"),p.setHandler(function(){a.close(),t._deleteCategory(e,!0)}),u.push(p);var f=[e.getName(),l.length,s.getName()];h=this._formatMessage(r.categoryDelete.deleteConfirmMove,f)}else{var d=Oskari.clazz.create("Oskari.userinterface.component.Button");d.setTitle(i.deleteCategory),d.addClass("primary"),u.push(d),d.setHandler(function(){a.close(),t._deleteCategory(e,!1)}),h=this._formatMessage(r.categoryDelete.deleteConfirm,[e.getName()])}a.show(r.categoryDelete.title,h,u),a.makeModal()},_formatMessage:function(e,t){for(var i=e,n=0;n<t.length;++n)i=i.replace("{"+n+"}",t[n]);return i},_deleteCategory:function(e,t){var i=this,n=e.getId(),s=function(e){i._deleteCategoryCallback(e,t,n)},a=this.instance.getService();a.deleteCategory(n,t,s)},_deleteCategoryCallback:function(e,t){var i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=this.instance.getService(),s=this;if(e){if(t){var a=n.getDefaultCategory(),r=this._getMapLayerId(a.getId()),o=this.instance.sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(r,!0);this.instance.sandbox.request(this,o)}var l=s.instance.getLocalization();i.show(l.notification.categoryDelete.title,l.notification.categoryDelete.deleted),i.fadeout()}else{var l=s.instance.getLocalization(),u=i.createCloseButton(l.buttons.ok);i.show(l.notification.error.title,l.notification.error.deleteCategory,[u])}},confirmPublishCategory:function(e,t){var i=this,n=i.instance.getLocalization(),s=Oskari.clazz.create("Oskari.userinterface.component.Popup"),a=this.instance.getService(),r=[],o=s.createCloseButton(n.buttons.cancel);r.push(o);var l=Oskari.clazz.create("Oskari.userinterface.component.Button");l.addClass("primary"),l.setHandler(function(){a.publishCategory(e.getId(),t,function(n){i._handlePublishCategory(e,t,n)}),s.close()}),r.push(l);var u=[e.getName()];if(t){l.setTitle(n.buttons.changeToPublic);var c=this._formatMessage(n.notification.categoryToPublic.message,u);s.show(n.notification.categoryToPublic.title,c,r)}else{l.setTitle(n.buttons.changeToPrivate);var c=this._formatMessage(n.notification.categoryToPrivate.message,u);s.show(n.notification.categoryToPrivate.title,c,r)}},_handlePublishCategory:function(e,t,i){if(!i){var n=this.instance.getLocalization("notification");return this._showMessage(n.error.title,n.error.generic),void 0}var s=this.instance.sandbox,a=s.getService("Oskari.mapframework.service.MapLayerService"),r=this._getMapLayerId(e.getId()),o=a.findMapLayer(r);if(!o){var n=this.instance.getLocalization("notification");return this._showMessage(n.error.title,n.error.generic),void 0}t?o.addPermission("publish","publication_permission_ok"):o.addPermission("publish","no_publication_permission");var l=s.getEventBuilder("MapLayerEvent")(r,"update");s.notifyAll(l)}},{protocol:["Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.MyPlacesBundleInstance",function(){this._localization=null,this.sandbox=null,this.buttons=void 0,this.categoryHandler=void 0,this.myPlacesService=void 0,this.featureNS=void 0,this.idPrefix="myplaces"},{__name:"MyPlaces2",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization&&this._localization[e]?this._localization[e]:e:this._localization},showMessage:function(e,t){var i=this.getLocalization(),n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(i.buttons.ok),s.addClass("primary"),s.setHandler(function(){n.close(!0)}),n.show(e,t,[s])},forceDisable:function(){this.buttons.disableButtons();var e=this.getLocalization();this.showMessage(e.category.organization+" - "+e.notification.error.title,e.notification.error.generic)},enableGfi:function(e){var t=this.sandbox.getRequestBuilder("MapModulePlugin.GetFeatureInfoActivationRequest");t&&this.sandbox.request(this.buttons,t(e))},getService:function(){return this.myPlacesService},getDrawPlugin:function(){return this.view.drawPlugin},getCategoryHandler:function(){return this.categoryHandler},getMainView:function(){return this.view},update:function(){},start:function(){var e=this,t=e.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);if(this.sandbox=n,this.featureNS=t?t.featureNS:null,this.featureNS){n.printDebug("Initializing my places module..."),this.buttons=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.ButtonHandler",this),this.buttons.start();var s=n.getUser();if(s.isLoggedIn()){this.categoryHandler=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.CategoryHandler",this),this.categoryHandler.start();var a=this._getCategoryDefaults(),r=this.conf.queryUrl;this.myPlacesService=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.service.MyPlacesService",r,s.getUuid(),n,a,this),this.sandbox.registerService(this.myPlacesService),this.myPlacesService.init(),this.view=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.MainView",this),this.view.start(),this.editRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler",n,e),n.addRequestHandler("MyPlaces.EditPlaceRequest",this.editRequestHandler),n.addRequestHandler("MyPlaces.EditCategoryRequest",this.editRequestHandler),n.addRequestHandler("MyPlaces.DeleteCategoryRequest",this.editRequestHandler),n.addRequestHandler("MyPlaces.PublishCategoryRequest",this.editRequestHandler)}}},stop:function(){this.sandbox=null},_getCategoryDefaults:function(){var e={name:this.getLocalization("category").defaultName,point:{shape:1,color:"000000",size:3},line:{style:"",cap:0,corner:0,width:1,color:"3233ff"},area:{linestyle:"",linecorner:0,linewidth:1,linecolor:"000000",color:"ffde00",fill:-1}};if(!this.conf)return e;if(!this.conf.defaults)return e;for(var t in e)this.conf.defaults[t]&&(e[t]=this.conf.defaults[t]);return e},hexToRgb:function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,i,n){return t+t+i+i+n+n});var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},rgbToHex:function(e){if("#"===e.charAt(0))return e.substring(1);var t=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);delete t[0];for(var i=1;3>=i;++i)t[i]=parseInt(t[i]).toString(16),1==t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{protocol:["Oskari.bundle.BundleInstance"]});var jscolor={dir:"",bindClass:"color",binding:!0,preloading:!0,install:function(){jscolor.addEvent(window,"load",jscolor.init)},init:function(){jscolor.binding&&jscolor.bind(),jscolor.preloading&&jscolor.preload()},getDir:function(){if(!jscolor.dir){var e=jscolor.detectDir();jscolor.dir=e!==!1?e:"jscolor/"}return jscolor.dir},detectDir:function(){for(var e=location.href,t=document.getElementsByTagName("base"),i=0;i<t.length;i+=1)t[i].href&&(e=t[i].href);for(var t=document.getElementsByTagName("script"),i=0;i<t.length;i+=1)if(t[i].src&&/(^|\/)jscolor\.js([?#].*)?$/i.test(t[i].src)){var n=new jscolor.URI(t[i].src),s=n.toAbsolute(e);return s.path=s.path.replace(/[^\/]+$/,""),s.query=null,s.fragment=null,s.toString()}return!1},bind:function(){for(var matchClass=new RegExp("(^|\\s)("+jscolor.bindClass+")\\s*(\\{[^}]*\\})?","i"),e=document.getElementsByTagName("input"),i=0;i<e.length;i+=1){var m;if(!e[i].color&&e[i].className&&(m=e[i].className.match(matchClass))){var prop={};if(m[3])try{eval("prop="+m[3])}catch(eInvalidProp){}e[i].color=new jscolor.color(e[i],prop)}}},preload:function(){for(var e in jscolor.imgRequire)jscolor.imgRequire.hasOwnProperty(e)&&jscolor.loadImage(e)},images:{pad:[181,101],sld:[16,101],cross:[15,15],arrow:[7,11]},imgRequire:{},imgLoaded:{},requireImage:function(e){jscolor.imgRequire[e]=!0
},loadImage:function(e){jscolor.imgLoaded[e]||(jscolor.imgLoaded[e]=new Image,jscolor.imgLoaded[e].src=jscolor.getDir()+e)},fetchElement:function(e){return"string"==typeof e?document.getElementById(e):e},addEvent:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent&&e.attachEvent("on"+t,i)},fireEvent:function(e,t){if(e)if(document.createEvent){var i=document.createEvent("HTMLEvents");i.initEvent(t,!0,!0),e.dispatchEvent(i)}else if(document.createEventObject){var i=document.createEventObject();e.fireEvent("on"+t,i)}else e["on"+t]&&e["on"+t]()},getElementPos:function(e){var t=e,i=e,n=0,s=0;if(t.offsetParent)do n+=t.offsetLeft,s+=t.offsetTop;while(t=t.offsetParent);for(;(i=i.parentNode)&&"BODY"!==i.nodeName.toUpperCase();)n-=i.scrollLeft,s-=i.scrollTop;return[n,s]},getElementSize:function(e){return[e.offsetWidth,e.offsetHeight]},getRelMousePos:function(e){var t=0,i=0;return e||(e=window.event),"number"==typeof e.offsetX?(t=e.offsetX,i=e.offsetY):"number"==typeof e.layerX&&(t=e.layerX,i=e.layerY),{x:t,y:i}},getViewPos:function(){return"number"==typeof window.pageYOffset?[window.pageXOffset,window.pageYOffset]:document.body&&(document.body.scrollLeft||document.body.scrollTop)?[document.body.scrollLeft,document.body.scrollTop]:document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)?[document.documentElement.scrollLeft,document.documentElement.scrollTop]:[0,0]},getViewSize:function(){return"number"==typeof window.innerWidth?[window.innerWidth,window.innerHeight]:document.body&&(document.body.clientWidth||document.body.clientHeight)?[document.body.clientWidth,document.body.clientHeight]:document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?[document.documentElement.clientWidth,document.documentElement.clientHeight]:[0,0]},URI:function(e){function t(e){for(var t="";e;)if("../"===e.substr(0,3)||"./"===e.substr(0,2))e=e.replace(/^\.+/,"").substr(1);else if("/./"===e.substr(0,3)||"/."===e)e="/"+e.substr(3);else if("/../"===e.substr(0,4)||"/.."===e)e="/"+e.substr(4),t=t.replace(/\/?[^\/]*$/,"");else if("."===e||".."===e)e="";else{var i=e.match(/^\/?[^\/]*/)[0];e=e.substr(i.length),t+=i}return t}this.scheme=null,this.authority=null,this.path="",this.query=null,this.fragment=null,this.parse=function(e){var t=e.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);return this.scheme=t[3]?t[2]:null,this.authority=t[5]?t[6]:null,this.path=t[7],this.query=t[9]?t[10]:null,this.fragment=t[12]?t[13]:null,this},this.toString=function(){var e="";return null!==this.scheme&&(e=e+this.scheme+":"),null!==this.authority&&(e=e+"//"+this.authority),null!==this.path&&(e+=this.path),null!==this.query&&(e=e+"?"+this.query),null!==this.fragment&&(e=e+"#"+this.fragment),e},this.toAbsolute=function(e){var e=new jscolor.URI(e),i=this,n=new jscolor.URI;return null===e.scheme?!1:(null!==i.scheme&&i.scheme.toLowerCase()===e.scheme.toLowerCase()&&(i.scheme=null),null!==i.scheme?(n.scheme=i.scheme,n.authority=i.authority,n.path=t(i.path),n.query=i.query):(null!==i.authority?(n.authority=i.authority,n.path=t(i.path),n.query=i.query):(""===i.path?(n.path=e.path,n.query=null!==i.query?i.query:e.query):("/"===i.path.substr(0,1)?n.path=t(i.path):(n.path=null!==e.authority&&""===e.path?"/"+i.path:e.path.replace(/[^\/]+$/,"")+i.path,n.path=t(n.path)),n.query=i.query),n.authority=e.authority),n.scheme=e.scheme),n.fragment=i.fragment,n)},e&&this.parse(e)},color:function(target,prop){function RGB_HSV(e,t,i){var n=Math.min(Math.min(e,t),i),s=Math.max(Math.max(e,t),i),a=s-n;if(0===a)return[null,0,s];var r=e===n?3+(i-t)/a:t===n?5+(e-i)/a:1+(t-e)/a;return[6===r?0:r,a/s,s]}function HSV_RGB(e,t,i){if(null===e)return[i,i,i];var n=Math.floor(e),s=n%2?e-n:1-(e-n),a=i*(1-t),r=i*(1-t*s);switch(n){case 6:case 0:return[i,r,a];case 1:return[r,i,a];case 2:return[a,i,r];case 3:return[a,r,i];case 4:return[r,a,i];case 5:return[i,a,r]}}function removePicker(){delete jscolor.picker.owner,document.getElementsByTagName("body")[0].removeChild(jscolor.picker.boxB)}function drawPicker(e,t){function i(){var e=THIS.pickerInsetColor.split(/\s+/),t=e.length<2?e[0]:e[1]+" "+e[0]+" "+e[0]+" "+e[1];r.btn.style.borderColor=t}if(!jscolor.picker){jscolor.picker={box:document.createElement("div"),boxB:document.createElement("div"),pad:document.createElement("div"),padB:document.createElement("div"),padM:document.createElement("div"),sld:document.createElement("div"),sldB:document.createElement("div"),sldM:document.createElement("div"),btn:document.createElement("div"),btnS:document.createElement("span"),btnT:document.createTextNode(THIS.pickerCloseText)};for(var n=0,s=4;n<jscolor.images.sld[1];n+=s){var a=document.createElement("div");a.style.height=s+"px",a.style.fontSize="1px",a.style.lineHeight="0",jscolor.picker.sld.appendChild(a)}jscolor.picker.sldB.appendChild(jscolor.picker.sld),jscolor.picker.box.appendChild(jscolor.picker.sldB),jscolor.picker.box.appendChild(jscolor.picker.sldM),jscolor.picker.padB.appendChild(jscolor.picker.pad),jscolor.picker.box.appendChild(jscolor.picker.padB),jscolor.picker.box.appendChild(jscolor.picker.padM),jscolor.picker.btnS.appendChild(jscolor.picker.btnT),jscolor.picker.btn.appendChild(jscolor.picker.btnS),jscolor.picker.box.appendChild(jscolor.picker.btn),jscolor.picker.boxB.appendChild(jscolor.picker.box)}var r=jscolor.picker;r.box.onmouseup=r.box.onmouseout=function(){target.focus()},r.box.onmousedown=function(){abortBlur=!0},r.box.onmousemove=function(e){(holdPad||holdSld)&&(holdPad&&setPad(e),holdSld&&setSld(e),document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),dispatchImmediateChange())},r.padM.onmouseup=r.padM.onmouseout=function(){holdPad&&(holdPad=!1,jscolor.fireEvent(valueElement,"change"))},r.padM.onmousedown=function(e){switch(modeID){case 0:0===THIS.hsv[2]&&THIS.fromHSV(null,null,1);break;case 1:0===THIS.hsv[1]&&THIS.fromHSV(null,1,null)}holdPad=!0,setPad(e),dispatchImmediateChange()},r.sldM.onmouseup=r.sldM.onmouseout=function(){holdSld&&(holdSld=!1,jscolor.fireEvent(valueElement,"change"))},r.sldM.onmousedown=function(e){holdSld=!0,setSld(e),dispatchImmediateChange()};var o=getPickerDims(THIS);r.box.style.width=o[0]+"px",r.box.style.height=o[1]+"px",r.boxB.style.position="absolute",r.boxB.style.clear="both",r.boxB.style.left=e+"px",r.boxB.style.top=t+"px",r.boxB.style.zIndex=THIS.pickerZIndex,r.boxB.style.border=THIS.pickerBorder+"px solid",r.boxB.style.borderColor=THIS.pickerBorderColor,r.boxB.style.background=THIS.pickerFaceColor,r.pad.style.width=jscolor.images.pad[0]+"px",r.pad.style.height=jscolor.images.pad[1]+"px",r.padB.style.position="absolute",r.padB.style.left=THIS.pickerFace+"px",r.padB.style.top=THIS.pickerFace+"px",r.padB.style.border=THIS.pickerInset+"px solid",r.padB.style.borderColor=THIS.pickerInsetColor,r.padM.style.position="absolute",r.padM.style.left="0",r.padM.style.top="0",r.padM.style.width=THIS.pickerFace+2*THIS.pickerInset+jscolor.images.pad[0]+jscolor.images.arrow[0]+"px",r.padM.style.height=r.box.style.height,r.padM.style.cursor="crosshair",r.sld.style.overflow="hidden",r.sld.style.width=jscolor.images.sld[0]+"px",r.sld.style.height=jscolor.images.sld[1]+"px",r.sldB.style.display=THIS.slider?"block":"none",r.sldB.style.position="absolute",r.sldB.style.right=THIS.pickerFace+"px",r.sldB.style.top=THIS.pickerFace+"px",r.sldB.style.border=THIS.pickerInset+"px solid",r.sldB.style.borderColor=THIS.pickerInsetColor,r.sldM.style.display=THIS.slider?"block":"none",r.sldM.style.position="absolute",r.sldM.style.right="0",r.sldM.style.top="0",r.sldM.style.width=jscolor.images.sld[0]+jscolor.images.arrow[0]+THIS.pickerFace+2*THIS.pickerInset+"px",r.sldM.style.height=r.box.style.height;try{r.sldM.style.cursor="pointer"}catch(l){r.sldM.style.cursor="hand"}r.btn.style.display=THIS.pickerClosable?"block":"none",r.btn.style.position="absolute",r.btn.style.left=THIS.pickerFace+"px",r.btn.style.bottom=THIS.pickerFace+"px",r.btn.style.padding="0 15px",r.btn.style.height="18px",r.btn.style.border=THIS.pickerInset+"px solid",i(),r.btn.style.color=THIS.pickerButtonColor,r.btn.style.font="12px sans-serif",r.btn.style.textAlign="center";try{r.btn.style.cursor="pointer"}catch(l){r.btn.style.cursor="hand"}switch(r.btn.onmousedown=function(){THIS.hidePicker()},r.btnS.style.lineHeight=r.btn.style.height,modeID){case 0:var u="hs.png";break;case 1:var u="hv.png"}r.padM.style.backgroundImage="url('"+jscolor.getDir()+"cross.gif')",r.padM.style.backgroundRepeat="no-repeat",r.sldM.style.backgroundImage="url('"+jscolor.getDir()+"arrow.gif')",r.sldM.style.backgroundRepeat="no-repeat",r.pad.style.backgroundImage="url('"+jscolor.getDir()+u+"')",r.pad.style.backgroundRepeat="no-repeat",r.pad.style.backgroundPosition="0 0",redrawPad(),redrawSld(),jscolor.picker.owner=THIS,document.getElementsByTagName("body")[0].appendChild(r.boxB)}function getPickerDims(e){var t=[2*e.pickerInset+2*e.pickerFace+jscolor.images.pad[0]+(e.slider?2*e.pickerInset+2*jscolor.images.arrow[0]+jscolor.images.sld[0]:0),e.pickerClosable?4*e.pickerInset+3*e.pickerFace+jscolor.images.pad[1]+e.pickerButtonHeight:2*e.pickerInset+2*e.pickerFace+jscolor.images.pad[1]];return t}function redrawPad(){switch(modeID){case 0:var e=1;break;case 1:var e=2}var t=Math.round(THIS.hsv[0]/6*(jscolor.images.pad[0]-1)),i=Math.round((1-THIS.hsv[e])*(jscolor.images.pad[1]-1));jscolor.picker.padM.style.backgroundPosition=THIS.pickerFace+THIS.pickerInset+t-Math.floor(jscolor.images.cross[0]/2)+"px "+(THIS.pickerFace+THIS.pickerInset+i-Math.floor(jscolor.images.cross[1]/2))+"px";var n=jscolor.picker.sld.childNodes;switch(modeID){case 0:for(var s=HSV_RGB(THIS.hsv[0],THIS.hsv[1],1),a=0;a<n.length;a+=1)n[a].style.backgroundColor="rgb("+100*s[0]*(1-a/n.length)+"%,"+100*s[1]*(1-a/n.length)+"%,"+100*s[2]*(1-a/n.length)+"%)";break;case 1:var s,r,o=[THIS.hsv[2],0,0],a=Math.floor(THIS.hsv[0]),l=a%2?THIS.hsv[0]-a:1-(THIS.hsv[0]-a);switch(a){case 6:case 0:s=[0,1,2];break;case 1:s=[1,0,2];break;case 2:s=[2,0,1];break;case 3:s=[2,1,0];break;case 4:s=[1,2,0];break;case 5:s=[0,2,1]}for(var a=0;a<n.length;a+=1)r=1-1/(n.length-1)*a,o[1]=o[0]*(1-r*l),o[2]=o[0]*(1-r),n[a].style.backgroundColor="rgb("+100*o[s[0]]+"%,"+100*o[s[1]]+"%,"+100*o[s[2]]+"%)"}}function redrawSld(){switch(modeID){case 0:var e=2;break;case 1:var e=1}var t=Math.round((1-THIS.hsv[e])*(jscolor.images.sld[1]-1));jscolor.picker.sldM.style.backgroundPosition="0 "+(THIS.pickerFace+THIS.pickerInset+t-Math.floor(jscolor.images.arrow[1]/2))+"px"}function isPickerOwner(){return jscolor.picker&&jscolor.picker.owner===THIS}function blurTarget(){valueElement===target&&THIS.importColor(),THIS.pickerOnfocus&&THIS.hidePicker()}function blurValue(){valueElement!==target&&THIS.importColor()}function setPad(e){var t=jscolor.getRelMousePos(e),i=t.x-THIS.pickerFace-THIS.pickerInset,n=t.y-THIS.pickerFace-THIS.pickerInset;switch(modeID){case 0:THIS.fromHSV(i*(6/(jscolor.images.pad[0]-1)),1-n/(jscolor.images.pad[1]-1),null,leaveSld);break;case 1:THIS.fromHSV(i*(6/(jscolor.images.pad[0]-1)),null,1-n/(jscolor.images.pad[1]-1),leaveSld)}}function setSld(e){var t=jscolor.getRelMousePos(e),i=t.y-THIS.pickerFace-THIS.pickerInset;switch(modeID){case 0:THIS.fromHSV(null,null,1-i/(jscolor.images.sld[1]-1),leavePad);break;case 1:THIS.fromHSV(null,1-i/(jscolor.images.sld[1]-1),null,leavePad)}}function dispatchImmediateChange(){THIS.onImmediateChange&&("string"==typeof THIS.onImmediateChange?eval(THIS.onImmediateChange):THIS.onImmediateChange(THIS))}this.required=!0,this.adjust=!0,this.hash=!1,this.caps=!0,this.slider=!0,this.valueElement=target,this.styleElement=target,this.onImmediateChange=null,this.hsv=[0,0,1],this.rgb=[1,1,1],this.pickerOnfocus=!0,this.pickerMode="HSV",this.pickerPosition="bottom",this.pickerSmartPosition=!0,this.pickerButtonHeight=20,this.pickerClosable=!1,this.pickerCloseText="Close",this.pickerButtonColor="ButtonText",this.pickerFace=10,this.pickerFaceColor="ThreeDFace",this.pickerBorder=1,this.pickerBorderColor="ThreeDHighlight ThreeDShadow ThreeDShadow ThreeDHighlight",this.pickerInset=1,this.pickerInsetColor="ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow",this.pickerZIndex=1e4;for(var p in prop)prop.hasOwnProperty(p)&&(this[p]=prop[p]);this.hidePicker=function(){isPickerOwner()&&removePicker()},this.showPicker=function(){if(!isPickerOwner()){var e,t,i,n=jscolor.getElementPos(target),s=jscolor.getElementSize(target),a=jscolor.getViewPos(),r=jscolor.getViewSize(),o=getPickerDims(this);switch(this.pickerPosition.toLowerCase()){case"left":e=1,t=0,i=-1;break;case"right":e=1,t=0,i=1;break;case"top":e=0,t=1,i=-1;break;default:e=0,t=1,i=1}var l=(s[t]+o[t])/2;if(this.pickerSmartPosition)var u=[-a[e]+n[e]+o[e]>r[e]?-a[e]+n[e]+s[e]/2>r[e]/2&&n[e]+s[e]-o[e]>=0?n[e]+s[e]-o[e]:n[e]:n[e],-a[t]+n[t]+s[t]+o[t]-l+l*i>r[t]?-a[t]+n[t]+s[t]/2>r[t]/2&&n[t]+s[t]-l-l*i>=0?n[t]+s[t]-l-l*i:n[t]+s[t]-l+l*i:n[t]+s[t]-l+l*i>=0?n[t]+s[t]-l+l*i:n[t]+s[t]-l-l*i];else var u=[n[e],n[t]+s[t]-l+l*i];drawPicker(u[e],u[t])}},this.importColor=function(){valueElement?this.adjust?!this.required&&/^\s*$/.test(valueElement.value)?(valueElement.value="",styleElement.style.backgroundImage=styleElement.jscStyle.backgroundImage,styleElement.style.backgroundColor=styleElement.jscStyle.backgroundColor,styleElement.style.color=styleElement.jscStyle.color,this.exportColor(leaveValue|leaveStyle)):this.fromString(valueElement.value)||this.exportColor():this.fromString(valueElement.value,leaveValue)||(styleElement.style.backgroundImage=styleElement.jscStyle.backgroundImage,styleElement.style.backgroundColor=styleElement.jscStyle.backgroundColor,styleElement.style.color=styleElement.jscStyle.color,this.exportColor(leaveValue|leaveStyle)):this.exportColor()},this.exportColor=function(e){if(!(e&leaveValue)&&valueElement){var t=this.toString();this.caps&&(t=t.toUpperCase()),this.hash&&(t="#"+t),valueElement.value=t}e&leaveStyle||!styleElement||(styleElement.style.backgroundImage="none",styleElement.style.backgroundColor="#"+this.toString(),styleElement.style.color=.213*this.rgb[0]+.715*this.rgb[1]+.072*this.rgb[2]<.5?"#FFF":"#000"),e&leavePad||!isPickerOwner()||redrawPad(),e&leaveSld||!isPickerOwner()||redrawSld()},this.fromHSV=function(e,t,i,n){0>e&&(e=0)||e>6&&(e=6),0>t&&(t=0)||t>1&&(t=1),0>i&&(i=0)||i>1&&(i=1),this.rgb=HSV_RGB(null===e?this.hsv[0]:this.hsv[0]=e,null===t?this.hsv[1]:this.hsv[1]=t,null===i?this.hsv[2]:this.hsv[2]=i),this.exportColor(n)},this.fromRGB=function(e,t,i,n){0>e&&(e=0)||e>1&&(e=1),0>t&&(t=0)||t>1&&(t=1),0>i&&(i=0)||i>1&&(i=1);var s=RGB_HSV(null===e?this.rgb[0]:this.rgb[0]=e,null===t?this.rgb[1]:this.rgb[1]=t,null===i?this.rgb[2]:this.rgb[2]=i);null!==s[0]&&(this.hsv[0]=s[0]),0!==s[2]&&(this.hsv[1]=s[1]),this.hsv[2]=s[2],this.exportColor(n)},this.fromString=function(e,t){var i=e.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i);return i?(6===i[1].length?this.fromRGB(parseInt(i[1].substr(0,2),16)/255,parseInt(i[1].substr(2,2),16)/255,parseInt(i[1].substr(4,2),16)/255,t):this.fromRGB(parseInt(i[1].charAt(0)+i[1].charAt(0),16)/255,parseInt(i[1].charAt(1)+i[1].charAt(1),16)/255,parseInt(i[1].charAt(2)+i[1].charAt(2),16)/255,t),!0):!1},this.toString=function(){return(256|Math.round(255*this.rgb[0])).toString(16).substr(1)+(256|Math.round(255*this.rgb[1])).toString(16).substr(1)+(256|Math.round(255*this.rgb[2])).toString(16).substr(1)};var THIS=this,modeID="hvs"===this.pickerMode.toLowerCase()?1:0,abortBlur=!1,valueElement=jscolor.fetchElement(this.valueElement),styleElement=jscolor.fetchElement(this.styleElement),holdPad=!1,holdSld=!1,leaveValue=1,leaveStyle=2,leavePad=4,leaveSld=8;if(jscolor.addEvent(target,"focus",function(){THIS.pickerOnfocus&&THIS.showPicker()}),jscolor.addEvent(target,"blur",function(){abortBlur?abortBlur=!1:window.setTimeout(function(){abortBlur||blurTarget(),abortBlur=!1},0)}),valueElement){var updateField=function(){THIS.fromString(valueElement.value,leaveValue),dispatchImmediateChange()};jscolor.addEvent(valueElement,"keyup",updateField),jscolor.addEvent(valueElement,"input",updateField),jscolor.addEvent(valueElement,"blur",blurValue),valueElement.setAttribute("autocomplete","off")}switch(styleElement&&(styleElement.jscStyle={backgroundImage:styleElement.style.backgroundImage,backgroundColor:styleElement.style.backgroundColor,color:styleElement.style.color}),modeID){case 0:jscolor.requireImage("hs.png");break;case 1:jscolor.requireImage("hv.png")}jscolor.requireImage("cross.gif"),jscolor.requireImage("arrow.gif"),this.importColor()}};if(jscolor.install(),function(e){function t(){this._settings=[],this._extensions=[],this.regional=[],this.regional[""]={errorLoadingText:"Error loading",notSupportedText:"This browser does not support SVG"},this.local=this.regional[""],this._uuid=(new Date).getTime(),this._renesis=i("RenesisX.RenesisCtrl")}function i(e){try{return!(!window.ActiveXObject||!new ActiveXObject(e))}catch(t){return!1}}function n(t,i){this._svg=t,this._container=i;for(var n=0;n<e.svg._extensions.length;n++){var s=e.svg._extensions[n];this[s[0]]=new s[1](this)}}function s(){this._path=""}function a(){this._parts=[]}function r(e){return e&&e.constructor==Array}var o="svgwrapper";e.extend(t.prototype,{markerClassName:"hasSVG",svgNS:"http://www.w3.org/2000/svg",xlinkNS:"http://www.w3.org/1999/xlink",_wrapperClass:n,_attrNames:{class_:"class",in_:"in",alignmentBaseline:"alignment-baseline",baselineShift:"baseline-shift",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorRendering:"color-rendering",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",underlinePosition:"underline-position",underlineThickness:"underline-thickness",vertAdvY:"vert-adv-y",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode"},_attachSVG:function(t,i){var n=t.namespaceURI==this.svgNS?t:null,t=n?null:t;if(!e(t||n).hasClass(this.markerClassName)){"string"==typeof i?i={loadURL:i}:"function"==typeof i&&(i={onLoad:i}),e(t||n).addClass(this.markerClassName);try{n||(n=document.createElementNS(this.svgNS,"svg"),n.setAttribute("version","1.1"),t.clientWidth>0&&n.setAttribute("width",t.clientWidth),t.clientHeight>0&&n.setAttribute("height",t.clientHeight),t.appendChild(n)),this._afterLoad(t,n,i||{})}catch(s){e.browser.msie?(t.id||(t.id="svg"+this._uuid++),this._settings[t.id]=i,t.innerHTML='<embed type="image/svg+xml" width="100%" height="100%" src="'+(i.initPath||"")+'blank.svg" '+'pluginspage="http://www.adobe.com/svg/viewer/install/main.html"/>'):t.innerHTML='<p class="svg_error">'+this.local.notSupportedText+"</p>"}}},_registerSVG:function(){for(var t=0;t<document.embeds.length;t++){var i=document.embeds[t].parentNode;if(e(i).hasClass(e.svg.markerClassName)&&!e.data(i,o)){var n=null;try{n=document.embeds[t].getSVGDocument()}catch(s){return setTimeout(e.svg._registerSVG,250),void 0}n=n?n.documentElement:null,n&&e.svg._afterLoad(i,n)}}},_afterLoad:function(t,i,n){var n=n||this._settings[t.id];this._settings[t?t.id:""]=null;var s=new this._wrapperClass(i,t);e.data(t||i,o,s);try{n.loadURL&&s.load(n.loadURL,n),n.settings&&s.configure(n.settings),n.onLoad&&!n.loadURL&&n.onLoad.apply(t||i,[s])}catch(a){alert(a)}},_getSVG:function(t){return t="string"==typeof t?e(t)[0]:t.jquery?t[0]:t,e.data(t,o)},_destroySVG:function(t){var i=e(t);i.hasClass(this.markerClassName)&&(i.removeClass(this.markerClassName),t.namespaceURI!=this.svgNS&&i.empty(),e.removeData(t,o))},addExtension:function(e,t){this._extensions.push([e,t])},isSVGElem:function(t){return 1==t.nodeType&&t.namespaceURI==e.svg.svgNS}}),e.extend(n.prototype,{_width:function(){return this._container?this._container.clientWidth:this._svg.width},_height:function(){return this._container?this._container.clientHeight:this._svg.height},root:function(){return this._svg},configure:function(t,i,n){if(t.nodeName||(n=i,i=t,t=this._svg),n)for(var s=t.attributes.length-1;s>=0;s--){var a=t.attributes.item(s);"onload"!=a.nodeName&&"version"!=a.nodeName&&"xmlns"!=a.nodeName.substring(0,5)&&t.attributes.removeNamedItem(a.nodeName)}for(var r in i)t.setAttribute(e.svg._attrNames[r]||r,i[r]);return this},getElementById:function(e){return this._svg.ownerDocument.getElementById(e)},change:function(t,i){if(t)for(var n in i)null==i[n]?t.removeAttribute(e.svg._attrNames[n]||n):t.setAttribute(e.svg._attrNames[n]||n,i[n]);return this},_args:function(t,i,n){i.splice(0,0,"parent"),i.splice(i.length,0,"settings");var s={},a=0;null!=t[0]&&t[0].jquery&&(t[0]=t[0][0]),null==t[0]||"object"==typeof t[0]&&t[0].nodeName||(s.parent=null,a=1);for(var r=0;r<t.length;r++)s[i[r+a]]=t[r];return n&&e.each(n,function(e,t){"object"==typeof s[t]&&(s.settings=s[t],s[t]=null)}),s},title:function(){var e=this._args(arguments,["text"]),t=this._makeNode(e.parent,"title",e.settings||{});return t.appendChild(this._svg.ownerDocument.createTextNode(e.text)),t},describe:function(){var e=this._args(arguments,["text"]),t=this._makeNode(e.parent,"desc",e.settings||{});return t.appendChild(this._svg.ownerDocument.createTextNode(e.text)),t},defs:function(){var t=this._args(arguments,["id"],["id"]);return this._makeNode(t.parent,"defs",e.extend(t.id?{id:t.id}:{},t.settings||{}))},symbol:function(){var t=this._args(arguments,["id","x1","y1","width","height"]);return this._makeNode(t.parent,"symbol",e.extend({id:t.id,viewBox:t.x1+" "+t.y1+" "+t.width+" "+t.height},t.settings||{}))},marker:function(){var t=this._args(arguments,["id","refX","refY","mWidth","mHeight","orient"],["orient"]);return this._makeNode(t.parent,"marker",e.extend({id:t.id,refX:t.refX,refY:t.refY,markerWidth:t.mWidth,markerHeight:t.mHeight,orient:t.orient||"auto"},t.settings||{}))},style:function(){var t=this._args(arguments,["styles"]),i=this._makeNode(t.parent,"style",e.extend({type:"text/css"},t.settings||{}));return i.appendChild(this._svg.ownerDocument.createTextNode(t.styles)),e.browser.opera&&e("head").append('<style type="text/css">'+t.styles+"</style>"),i},script:function(){var t=this._args(arguments,["script","type"],["type"]),i=this._makeNode(t.parent,"script",e.extend({type:t.type||"text/javascript"},t.settings||{}));return i.appendChild(this._svg.ownerDocument.createTextNode(t.script)),e.browser.mozilla||e.globalEval(t.script),i},linearGradient:function(){var t=this._args(arguments,["id","stops","x1","y1","x2","y2"],["x1"]),i=e.extend({id:t.id},null!=t.x1?{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2}:{});return this._gradient(t.parent,"linearGradient",e.extend(i,t.settings||{}),t.stops)},radialGradient:function(){var t=this._args(arguments,["id","stops","cx","cy","r","fx","fy"],["cx"]),i=e.extend({id:t.id},null!=t.cx?{cx:t.cx,cy:t.cy,r:t.r,fx:t.fx,fy:t.fy}:{});return this._gradient(t.parent,"radialGradient",e.extend(i,t.settings||{}),t.stops)},_gradient:function(t,i,n,s){for(var a=this._makeNode(t,i,n),r=0;r<s.length;r++){var o=s[r];this._makeNode(a,"stop",e.extend({offset:o[0],stopColor:o[1]},null!=o[2]?{stopOpacity:o[2]}:{}))}return a},pattern:function(){var t=this._args(arguments,["id","x","y","width","height","vx","vy","vwidth","vheight"],["vx"]),i=e.extend({id:t.id,x:t.x,y:t.y,width:t.width,height:t.height},null!=t.vx?{viewBox:t.vx+" "+t.vy+" "+t.vwidth+" "+t.vheight}:{});return this._makeNode(t.parent,"pattern",e.extend(i,t.settings||{}))},clipPath:function(){var t=this._args(arguments,["id","units"]);return t.units=t.units||"userSpaceOnUse",this._makeNode(t.parent,"clipPath",e.extend({id:t.id,clipPathUnits:t.units},t.settings||{}))},mask:function(){var t=this._args(arguments,["id","x","y","width","height"]);return this._makeNode(t.parent,"mask",e.extend({id:t.id,x:t.x,y:t.y,width:t.width,height:t.height},t.settings||{}))},createPath:function(){return new s},createText:function(){return new a},svg:function(){var t=this._args(arguments,["x","y","width","height","vx","vy","vwidth","vheight"],["vx"]),i=e.extend({x:t.x,y:t.y,width:t.width,height:t.height},null!=t.vx?{viewBox:t.vx+" "+t.vy+" "+t.vwidth+" "+t.vheight}:{});return this._makeNode(t.parent,"svg",e.extend(i,t.settings||{}))},group:function(){var t=this._args(arguments,["id"],["id"]);return this._makeNode(t.parent,"g",e.extend({id:t.id},t.settings||{}))},use:function(){var t=this._args(arguments,["x","y","width","height","ref"]);"string"==typeof t.x&&(t.ref=t.x,t.settings=t.y,t.x=t.y=t.width=t.height=null);var i=this._makeNode(t.parent,"use",e.extend({x:t.x,y:t.y,width:t.width,height:t.height},t.settings||{}));return i.setAttributeNS(e.svg.xlinkNS,"href",t.ref),i},link:function(){var t=this._args(arguments,["ref"]),i=this._makeNode(t.parent,"a",t.settings);return i.setAttributeNS(e.svg.xlinkNS,"href",t.ref),i},image:function(){var t=this._args(arguments,["x","y","width","height","ref"]),i=this._makeNode(t.parent,"image",e.extend({x:t.x,y:t.y,width:t.width,height:t.height},t.settings||{}));return i.setAttributeNS(e.svg.xlinkNS,"href",t.ref),i},path:function(){var t=this._args(arguments,["path"]);return this._makeNode(t.parent,"path",e.extend({d:t.path.path?t.path.path():t.path},t.settings||{}))},rect:function(){var t=this._args(arguments,["x","y","width","height","rx","ry"],["rx"]);return this._makeNode(t.parent,"rect",e.extend({x:t.x,y:t.y,width:t.width,height:t.height},t.rx?{rx:t.rx,ry:t.ry}:{},t.settings||{}))},circle:function(){var t=this._args(arguments,["cx","cy","r"]);return this._makeNode(t.parent,"circle",e.extend({cx:t.cx,cy:t.cy,r:t.r},t.settings||{}))},ellipse:function(){var t=this._args(arguments,["cx","cy","rx","ry"]);return this._makeNode(t.parent,"ellipse",e.extend({cx:t.cx,cy:t.cy,rx:t.rx,ry:t.ry},t.settings||{}))},line:function(){var t=this._args(arguments,["x1","y1","x2","y2"]);return this._makeNode(t.parent,"line",e.extend({x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2},t.settings||{}))},polyline:function(){var e=this._args(arguments,["points"]);return this._poly(e.parent,"polyline",e.points,e.settings)},polygon:function(){var e=this._args(arguments,["points"]);return this._poly(e.parent,"polygon",e.points,e.settings)},_poly:function(t,i,n,s){for(var a="",r=0;r<n.length;r++)a+=n[r].join()+" ";return this._makeNode(t,i,e.extend({points:e.trim(a)},s||{}))},text:function(){var t=this._args(arguments,["x","y","value"]);return"string"==typeof t.x&&arguments.length<4&&(t.value=t.x,t.settings=t.y,t.x=t.y=null),this._text(t.parent,"text",t.value,e.extend({x:t.x&&r(t.x)?t.x.join(" "):t.x,y:t.y&&r(t.y)?t.y.join(" "):t.y},t.settings||{}))},textpath:function(){var t=this._args(arguments,["path","value"]),i=this._text(t.parent,"textPath",t.value,t.settings||{});return i.setAttributeNS(e.svg.xlinkNS,"href",t.path),i},_text:function(t,i,n,s){var a=this._makeNode(t,i,s);if("string"==typeof n)a.appendChild(a.ownerDocument.createTextNode(n));else for(var r=0;r<n._parts.length;r++){var o=n._parts[r];if("tspan"==o[0]){var l=this._makeNode(a,o[0],o[2]);l.appendChild(a.ownerDocument.createTextNode(o[1])),a.appendChild(l)}else if("tref"==o[0]){var l=this._makeNode(a,o[0],o[2]);l.setAttributeNS(e.svg.xlinkNS,"href",o[1]),a.appendChild(l)}else if("textpath"==o[0]){var u=e.extend({},o[2]);u.href=null;var l=this._makeNode(a,o[0],u);l.setAttributeNS(e.svg.xlinkNS,"href",o[2].href),l.appendChild(a.ownerDocument.createTextNode(o[1])),a.appendChild(l)}else a.appendChild(a.ownerDocument.createTextNode(o[1]))}return a},other:function(){var e=this._args(arguments,["name"]);return this._makeNode(e.parent,e.name,e.settings||{})},_makeNode:function(t,i,n){t=t||this._svg;var s=this._svg.ownerDocument.createElementNS(e.svg.svgNS,i);for(var i in n){var a=n[i];null==a||null==a||"string"==typeof a&&""==a||s.setAttribute(e.svg._attrNames[i]||i,a)}return t.appendChild(s),s},add:function(t){var i=this._args(1==arguments.length?[null,t]:arguments,["node"]),n=this;i.parent=i.parent||this._svg,i.node=i.node.jquery?i.node:e(i.node);try{if(e.svg._renesis)throw"Force traversal";i.parent.appendChild(i.node.cloneNode(!0))}catch(s){i.node.each(function(){var e=n._cloneAsSVG(this);e&&i.parent.appendChild(e)})}return this},clone:function(t){var i=this,n=this._args(1==arguments.length?[null,t]:arguments,["node"]);n.parent=n.parent||this._svg,n.node=n.node.jquery?n.node:e(n.node);var s=[];return n.node.each(function(){var e=i._cloneAsSVG(this);e&&(e.id="",n.parent.appendChild(e),s.push(e))}),s},_cloneAsSVG:function(t){var i=null;if(1==t.nodeType){i=this._svg.ownerDocument.createElementNS(e.svg.svgNS,this._checkName(t.nodeName));for(var n=0;n<t.attributes.length;n++){var s=t.attributes.item(n);"xmlns"!=s.nodeName&&s.nodeValue&&("xlink"==s.prefix?i.setAttributeNS(e.svg.xlinkNS,s.localName||s.baseName,s.nodeValue):i.setAttribute(this._checkName(s.nodeName),s.nodeValue))}for(var n=0;n<t.childNodes.length;n++){var a=this._cloneAsSVG(t.childNodes[n]);a&&i.appendChild(a)}}else if(3==t.nodeType)e.trim(t.nodeValue)&&(i=this._svg.ownerDocument.createTextNode(t.nodeValue));else if(4==t.nodeType&&e.trim(t.nodeValue))try{i=this._svg.ownerDocument.createCDATASection(t.nodeValue)}catch(r){i=this._svg.ownerDocument.createTextNode(t.nodeValue.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"))}return i},_checkName:function(e){return e=e.substring(0,1)>="A"&&e.substring(0,1)<="Z"?e.toLowerCase():e,"svg:"==e.substring(0,4)?e.substring(4):e},load:function(t,i){i="boolean"==typeof i?{addTo:i}:"function"==typeof i?{onLoad:i}:"string"==typeof i?{parent:i}:"object"==typeof i&&i.nodeName?{parent:i}:"object"==typeof i&&i.jquery?{parent:i}:i||{},i.parent||i.addTo||this.clear(!1);var n=[this._svg.getAttribute("width"),this._svg.getAttribute("height")],s=this,a=function(t){t=e.svg.local.errorLoadingText+": "+t,i.onLoad?i.onLoad.apply(s._container||s._svg,[s,t]):s.text(null,10,20,t)},r=function(e){var t=new ActiveXObject("Microsoft.XMLDOM");return t.validateOnParse=!1,t.resolveExternals=!1,t.async=!1,t.loadXML(e),0!=t.parseError.errorCode?(a(t.parseError.reason),null):t},o=function(t){if(t){if("svg"!=t.documentElement.nodeName){var r=t.getElementsByTagName("parsererror"),o=r.length?r[0].getElementsByTagName("div"):[];return a(r.length?(o.length?o[0]:r[0]).firstChild.nodeValue:"???"),void 0}for(var l=i.parent?e(i.parent)[0]:s._svg,u={},c=0;c<t.documentElement.attributes.length;c++){var h=t.documentElement.attributes.item(c);"version"!=h.nodeName&&"xmlns"!=h.nodeName.substring(0,5)&&(u[h.nodeName]=h.nodeValue)}s.configure(l,u,!i.parent);for(var d=t.documentElement.childNodes,c=0;c<d.length;c++)try{if(e.svg._renesis)throw"Force traversal";l.appendChild(s._svg.ownerDocument.importNode(d[c],!0)),"script"==d[c].nodeName&&e.globalEval(d[c].textContent)}catch(p){s.add(l,d[c])}i.changeSize||s.configure(l,{width:n[0],height:n[1]}),i.onLoad&&i.onLoad.apply(s._container||s._svg,[s])}};return t.match("<svg")?o(e.browser.msie?r(t):(new DOMParser).parseFromString(t,"text/xml")):e.ajax({url:t,dataType:e.browser.msie?"text":"xml",success:function(t){o(e.browser.msie?r(t):t)
},error:function(e,t,i){a(t+(i?" "+i.message:""))}}),this},remove:function(e){return e=e.jquery?e[0]:e,e.parentNode.removeChild(e),this},clear:function(e){for(e&&this.configure({},!0);this._svg.firstChild;)this._svg.removeChild(this._svg.firstChild);return this},toSVG:function(e){return e=e||this._svg,"undefined"==typeof XMLSerializer?this._toSVG(e):(new XMLSerializer).serializeToString(e)},_toSVG:function(t){var i="";if(!t)return i;if(3==t.nodeType)i=t.nodeValue;else if(4==t.nodeType)i="<![CDATA["+t.nodeValue+"]]>";else{if(i="<"+t.nodeName,t.attributes)for(var n=0;n<t.attributes.length;n++){var s=t.attributes.item(n);""==e.trim(s.nodeValue)||s.nodeValue.match(/^\[object/)||s.nodeValue.match(/^function/)||(i+=" "+(s.namespaceURI==e.svg.xlinkNS?"xlink:":"")+s.nodeName+'="'+s.nodeValue+'"')}if(t.firstChild){i+=">";for(var a=t.firstChild;a;)i+=this._toSVG(a),a=a.nextSibling;i+="</"+t.nodeName+">"}else i+="/>"}return i}}),e.extend(s.prototype,{reset:function(){return this._path="",this},move:function(e,t,i){return i=r(e)?t:i,this._coords(i?"m":"M",e,t)},line:function(e,t,i){return i=r(e)?t:i,this._coords(i?"l":"L",e,t)},horiz:function(e,t){return this._path+=(t?"h":"H")+(r(e)?e.join(" "):e),this},vert:function(e,t){return this._path+=(t?"v":"V")+(r(e)?e.join(" "):e),this},curveC:function(e,t,i,n,s,a,o){return o=r(e)?t:o,this._coords(o?"c":"C",e,t,i,n,s,a)},smoothC:function(e,t,i,n,s){return s=r(e)?t:s,this._coords(s?"s":"S",e,t,i,n)},curveQ:function(e,t,i,n,s){return s=r(e)?t:s,this._coords(s?"q":"Q",e,t,i,n)},smoothQ:function(e,t,i){return i=r(e)?t:i,this._coords(i?"t":"T",e,t)},_coords:function(e,t,i,n,s,a,o){if(r(t))for(var l=0;l<t.length;l++){var u=t[l];this._path+=(0==l?e:" ")+u[0]+","+u[1]+(u.length<4?"":" "+u[2]+","+u[3]+(u.length<6?"":" "+u[4]+","+u[5]))}else this._path+=e+t+","+i+(null==n?"":" "+n+","+s+(null==a?"":" "+a+","+o));return this},arc:function(e,t,i,n,s,a,o,l){if(l=r(e)?t:l,this._path+=l?"a":"A",r(e))for(var u=0;u<e.length;u++){var c=e[u];this._path+=(0==u?"":" ")+c[0]+","+c[1]+" "+c[2]+" "+(c[3]?"1":"0")+","+(c[4]?"1":"0")+" "+c[5]+","+c[6]}else this._path+=e+","+t+" "+i+" "+(n?"1":"0")+","+(s?"1":"0")+" "+a+","+o;return this},close:function(){return this._path+="z",this},path:function(){return this._path}}),s.prototype.moveTo=s.prototype.move,s.prototype.lineTo=s.prototype.line,s.prototype.horizTo=s.prototype.horiz,s.prototype.vertTo=s.prototype.vert,s.prototype.curveCTo=s.prototype.curveC,s.prototype.smoothCTo=s.prototype.smoothC,s.prototype.curveQTo=s.prototype.curveQ,s.prototype.smoothQTo=s.prototype.smoothQ,s.prototype.arcTo=s.prototype.arc,e.extend(a.prototype,{reset:function(){return this._parts=[],this},string:function(e){return this._parts[this._parts.length]=["text",e],this},span:function(e,t){return this._parts[this._parts.length]=["tspan",e,t],this},ref:function(e,t){return this._parts[this._parts.length]=["tref",e,t],this},path:function(t,i,n){return this._parts[this._parts.length]=["textpath",i,e.extend({href:t},n||{})],this}}),e.fn.svg=function(t){var i=Array.prototype.slice.call(arguments,1);return"string"==typeof t&&"get"==t?e.svg["_"+t+"SVG"].apply(e.svg,[this[0]].concat(i)):this.each(function(){"string"==typeof t?e.svg["_"+t+"SVG"].apply(e.svg,[this].concat(i)):e.svg._attachSVG(this,t||{})})},e.svg=new t}(jQuery),Oskari.clazz.define("Oskari.framework.bundle.guidedtour.GuidedTourBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.framework.bundle.guidedtour.GuidedTourBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/instance.js"},{type:"text/javascript",src:"../../../../libraries/jquery/plugins/jquery.cookie.js"},{type:"text/css",src:"../../../../resources/framework/bundle/guidedtour/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/guidedtour/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"guidedtour","Bundle-Name":"guidedtour","Bundle-Author":[{Name:"ev",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("guidedtour","Oskari.framework.bundle.guidedtour.GuidedTourBundle"),Oskari.clazz.define("Oskari.framework.bundle.guidedtour.GuidedTourBundleInstance",function(){this.sandbox=null,this._localization=null,this.mediator=null,this.guideStep=0},{__name:"GuidedTour",getName:function(){return this.__name},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},getSandbox:function(){return this.sandbox},update:function(){},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){if("1"!=jQuery.cookie("pti_tour_seen")){var e=this,t=e.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);this.sandbox=n,this.localization=Oskari.getLocalization(this.getName()),n.register(e),e._startGuide()}},_startGuide:function(){this.guideStep=0;var e="Oskari.userinterface.component.Popup",t=Oskari.clazz.create(e);t.makeDraggable(),t.addClass("guidedtour"),this._showGuideContentForStep(this.guideStep,t)},_guideSteps:[{appendTourSeenCheckbox:!0,setScope:function(e){this.ref=e},getTitle:function(){return this.ref.getLocalization("page1").title},getContent:function(){var e=this.ref;e.getLocalization("page1");var t=jQuery("<div></div>");return t.append(this.ref.getLocalization("page1").message),t}},{setScope:function(e){this.ref=e},getTitle:function(){return""+this.ref.getLocalization("page2").title+"<span>1/8</span>"},getContent:function(){var e=this.ref;e._openExtension("Search");var t=e.getLocalization("page2"),i=jQuery("<div></div>");i.append(t.message);var n=jQuery('<a href="#"></a>'),s=n.clone();s.append(t.openLink),s.bind("click",function(){e._openExtension("Search"),s.hide(),a.show()});var a=n.clone();return a.append(t.closeLink),a.bind("click",function(){e._closeExtension("Search"),s.show(),a.hide()}),i.append("<br /><br />"),i.append(s),i.append(a),a.show(),s.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page3").title;return e+"<span>2/8</span>"},getContent:function(){var e=this.ref;e._openExtension("LayerSelector");var t=e.getLocalization("page3"),i=jQuery("<div></div>");i.append(t.message);var n=jQuery('<a href="#"></a>'),s=n.clone();s.append(t.openLink),s.bind("click",function(){e._openExtension("LayerSelector"),s.hide(),a.show()});var a=n.clone();return a.append(t.closeLink),a.bind("click",function(){e._closeExtension("LayerSelector"),s.show(),a.hide()}),i.append("<br><br>"),i.append(s),i.append(a),a.show(),s.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page4").title;return e+"<span>3/8</span>"},getContent:function(){var e=this.ref;e._openExtension("LayerSelection");var t=e.getLocalization("page4"),i=jQuery("<div></div>");i.append(t.message);var n=jQuery('<a href="#"></a>'),s=n.clone();s.append(t.openLink),s.bind("click",function(){e._openExtension("LayerSelection"),s.hide(),a.show()});var a=n.clone();return a.append(t.closeLink),a.bind("click",function(){e._closeExtension("LayerSelection"),s.show(),a.hide()}),i.append("<br><br>"),i.append(s),i.append(a),a.show(),s.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page5").title;return e+"<span>4/8</span>"},getContent:function(){var e=this.ref;e._openExtension("PersonalData");var t=e.getLocalization("page5"),i=jQuery("<div></div>");i.append(t.message);var n=jQuery('<a href="#"></a>'),s=n.clone();s.append(t.openLink),s.bind("click",function(){e._openExtension("PersonalData"),s.hide(),a.show()});var a=n.clone();return a.append(t.closeLink),a.bind("click",function(){e._closeExtension("PersonalData"),s.show(),a.hide()}),i.append("<br><br>"),i.append(s),i.append(a),a.show(),s.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page6").title;return e+"<span>5/8</span>"},getContent:function(){var e=this.ref;e._openExtension("Publisher");var t=e.getLocalization("page6"),i=jQuery("<div></div>");i.append(t.message);var n=jQuery('<a href="#"></a>'),s=n.clone();s.append(t.openLink),s.bind("click",function(){e._openExtension("Publisher"),s.hide(),a.show()});var a=n.clone();return a.append(t.closeLink),a.bind("click",function(){e._closeExtension("Publisher"),s.show(),a.hide()}),i.append("<br><br>"),i.append(s),i.append(a),a.show(),s.hide(),i}},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page7").title;return e+"<span>6/8</span>"},getContent:function(){var e=this.ref;e._closeExtension("Publisher");var t=e.getLocalization("page7"),i=jQuery("<div></div>");return i.append(t.message),i},getPositionRef:function(){return jQuery("#toolbar")},positionAlign:"right"},{setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page8").title;return e+"<span>7/8</span>"},getContent:function(){var e=this.ref,t=e.getLocalization("page8"),i=jQuery("<div></div>");return i.append(t.message),i},getPositionRef:function(){return jQuery(".panbuttonDiv")},positionAlign:"left"},{appendTourSeenCheckbox:!0,setScope:function(e){this.ref=e},getTitle:function(){var e=this.ref.getLocalization("page9").title;return e+"<span>8/8</span>"},getContent:function(){var e=this.ref,t=e.getLocalization("page9"),i=jQuery("<div></div>");return i.append(t.message),i},getPositionRef:function(){return jQuery(".pzbDiv")},positionAlign:"left"}],_showGuideContentForStep:function(e,t){var i=this._guideSteps[e];i.setScope(this);var n=this._getDialogButton(t),s=i.getTitle(),a=i.getContent();if(i.appendTourSeenCheckbox){a.append("<br><br>");var r=jQuery('<input type="checkbox" name="pti_tour_seen" id="pti_tour_seen" value="1">'),o=r.clone(),l=jQuery('<label for="pti_tour_seen"></label>'),u=l.clone();u.append(this.getLocalization("tourseen").label),o.bind("change",function(){jQuery(this).attr("checked")?jQuery.cookie("pti_tour_seen","1",{expires:365}):jQuery.cookie("pti_tour_seen","0",{expires:1})}),a.append(o),a.append("&nbsp;"),a.append(u)}t.show(s,a,n),i.getPositionRef?t.moveTo(i.getPositionRef(),i.positionAlign):t.resetPosition()},_getFakeExtension:function(e){return{getName:function(){return e}}},_openExtension:function(e){var t=this._getFakeExtension(e),i="userinterface.UpdateExtensionRequest";this.sandbox.postRequestByName(i,[t,"attach"])},_closeExtension:function(e){var t=this._getFakeExtension(e),i="userinterface.UpdateExtensionRequest";this.sandbox.postRequestByName(i,[t,"close"])},_getDialogButton:function(e){var t=this,i=[],n="!button.close!";this.localization&&this.localization.button&&this.localization.button.previous&&(n=this.localization.button.close);var s=e.createCloseButton(n);if(i.push(s),this.guideStep>1){var a="Oskari.userinterface.component.Button",r=Oskari.clazz.create(a),o="!button.previous!";this.localization&&this.localization.button&&this.localization.button.previous&&(o=this.localization.button.previous),r.setTitle(o),r.setHandler(function(){t.guideStep--,t._showGuideContentForStep(t.guideStep,e)}),i.push(r)}if(0==this.guideStep){var a="Oskari.userinterface.component.Button",l=Oskari.clazz.create(a),u="!button.start!";this.localization&&this.localization.button&&this.localization.button.start&&(u=this.localization.button.start),l.setTitle(u),l.setHandler(function(){t.guideStep++,t._showGuideContentForStep(t.guideStep,e)}),i.push(l)}else if(this.guideStep<this._guideSteps.length-1){var a="Oskari.userinterface.component.Button",c=Oskari.clazz.create(a),h="!button.next!";this.localization&&this.localization.button&&this.localization.button.start&&(h=this.localization.button.next),c.setTitle(h),c.setHandler(function(){t.guideStep++,t._showGuideContentForStep(t.guideStep,e)}),i.push(c),e.addClass("bluetitle")}else if(this.guideStep==this._guideSteps.length-1){var d="!button.finish!";this.localization&&this.localization.button&&this.localization.button.start&&(d=this.localization.button.finish);var p=e.createCloseButton(d);i.push(p)}return i},init:function(){return null},onEvent:function(e){var t=this,i=t.eventHandlers[e.getName()];if(!i){var n=i.apply(this,[e]);if(n)return n}return null},eventHandlers:{},stop:function(){var e=this;e.sandbox(),e.sandbox.unregister(e)}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.backendstatus.BackendStatusBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.backendstatus.BackendStatusBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/backendstatus/instance.js"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/backendstatus/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/backendstatus/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/backendstatus/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"backendstatus","Bundle-Name":"backendstatus","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:"backendstatus",Title:"backendstatus"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("backendstatus","Oskari.mapframework.bundle.backendstatus.BackendStatusBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.backendstatus.BackendStatusBundleInstance",function(){this._localization=null,this._sandbox=null,this._started=!1,this._pendingAjaxQuery={busy:!1,jqhr:null,timestamp:null},this.timeInterval=this.ajaxSettings.defaultTimeThreshold,this.backendStatus={},this.backendExtendedStatus={},this.gotStartupEvent=!1,this.gotStartupTimeoutEvent=!1,this.gotStartupProcessCall=!1,this._mapLayerService=null},{ajaxSettings:{defaultTimeThreshold:15e3},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},__name:"BackendStatus",getName:function(){return this.__name},setSandbox:function(e){this._sandbox=e},getSandbox:function(){return this._sandbox},getAjaxUrl:function(e,t){var i=this.getSandbox().getAjaxUrl(),n=null;return n=t?i+"action_route=GetBackendStatus&Subset=AllKnown":i+"action_route=GetBackendStatus&Subset=Alert"},start:function(){var e=this;if(!e._started){e._started=!0;var t=e.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e._sandbox=n,e._mapLayerService=n.getService("Oskari.mapframework.service.MapLayerService"),n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);e._mapLayerService.isAllLayersLoaded()&&!e.gotStartupProcessCall&&e.updateBackendStatus(!0)}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},extensionsByName:{LayerSelector:!0},extensionStatesByName:{attach:!0,detach:!0},eventHandlers:{"userinterface.ExtensionUpdatedEvent":function(e){var t=e.getExtension();if(t){var i=t.getName();if(i&&this.extensionsByName[i]){var n=e.getViewState();this.extensionStatesByName[n]&&this.updateBackendStatus()}}},AfterShowMapLayerInfoEvent:function(e){var t=e.getMapLayer(),i=t.getId();t.getBackendStatus();var n=this.backendExtendedStatus[i];if(!n)return this.showFeedbackDialog("missing_backendstatus_information"),void 0;var s=n.infourl;return s?(this.openURLinWindow(s),void 0):(this.showFeedbackDialog("missing_backendstatus_infourl"),void 0)},MapLayerEvent:function(e){if(null==e.getLayerId()&&"add"==e.getOperation()){var t=this;t.gotStartupEvent=!0,window.setTimeout(function(){t.gotStartupTimeoutEvent=!0,t.updateBackendStatus(!0)},15)}}},showFeedbackDialog:function(e){var t=this.getLocalization("feedback")[e],i=Oskari.clazz.create("Oskari.userinterface.component.Popup");i.show(t.title,t.message),i.fadeout()},openURLinWindow:function(e){var t="location=1,status=1,scrollbars=1,width=850,height=1200",i=e;window.open(i,"BackendStatus",t)},stop:function(){var e=this,t=e._sandbox;e._cancelAjaxRequest();for(p in e.eventHandlers)t.unregisterFromEventByName(this,p);t.unregister(this),this._started=!1,this._sandbox=null},getTitle:function(){return"Backend Status"},getDescription:function(){return"Backend Status"},_cancelAjaxRequest:function(){var e=this;if(e._pendingAjaxQuery.busy){var t=e._pendingAjaxQuery.jqhr;e._pendingAjaxQuery.jqhr=null,t&&(this._sandbox.printDebug("[BackendStatus] Abort jqhr ajax request"),t.abort(),t=null,e._pendingAjaxQuery.busy=!1)}},_startAjaxRequest:function(e){var t=this;t._pendingAjaxQuery.busy=!0,t._pendingAjaxQuery.timestamp=e},_finishAjaxRequest:function(){var e=this;e._pendingAjaxQuery.busy=!1,e._pendingAjaxQuery.jqhr=null,this._sandbox.printDebug("[BackendStatus] finished jqhr ajax request")},_notifyAjaxFailure:function(){var e=this;e._sandbox.printDebug("[BackendStatus] BackendStatus AJAX failed"),e._processResponse({backendstatus:[]})},_isAjaxRequestBusy:function(){var e=this;return e._pendingAjaxQuery.busy},updateBackendStatus:function(e){var t=this;t.gotStartupProcessCall=t.gotStartupProcessCall||e;var i=t._sandbox;if(!e&&t._pendingAjaxQuery.busy)return i.printDebug("[BackendStatus] updateBackendStatus NOT SENT previous query is busy"),void 0;var n=new Date,s=n.getTime();if(!e&&t._pendingAjaxQuery.timestamp&&s-t._pendingAjaxQuery.timestamp<t.timeInterval)return i.printDebug("[BackendStatus] updateBackendStatus NOT SENT (time difference < "+t.timeInterval+"ms)"),void 0;t._cancelAjaxRequest(),t._startAjaxRequest(s);var a=t.getAjaxUrl(null,e);jQuery.ajax({beforeSend:function(e){t._pendingAjaxQuery.jqhr=e,e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(i){t._finishAjaxRequest(),t._processResponse(i,e)},error:function(){t._finishAjaxRequest(),t._notifyAjaxFailure()},always:function(){t._finishAjaxRequest()},complete:function(){t._finishAjaxRequest()},data:{},type:"POST",dataType:"json",url:a})},_processResponse:function(e,t){var i=this,n=this._sandbox;if(!e)return n.printDebug("[BackendStatus] empty data from server"),void 0;var s=e.backendstatus;if(!s||void 0==s.length)return n.printDebug("[BackendStatus] backendStatus NO data"),void 0;for(var a=n.getEventBuilder("MapLayerEvent"),r={},o=t?{}:this.backendExtendedStatus,l=0;l<s.length;l++){var u=s[l],c=u.maplayer_id;this.backendStatus[c]?this.backendStatus[c].status!=u.status?(r[c]={status:u.status,changed:!0},o[c]=u):(r[c]={status:u.status,changed:!1},o[c]=u):(r[c]={status:u.status,changed:!0},o[c]=u)}for(p in this.backendStatus)r[p]||null==this.backendStatus[p].status||(r[p]={status:null,changed:!0});this.backendExtendedStatus=o;var h={};for(p in r){this.backendStatus[p]=r[p];var d=n.findMapLayerFromAllAvailable(p);d&&(d.setBackendStatus(this.backendStatus[p].status),(r[p].changed||"DOWN"==d.getBackendStatus())&&(h[p]=d))}if(t)i._pendingAjaxQuery.timestamp=null,i.backendStatus={};else for(p in h){var f=a(p,"update");n.notifyAll(f)}}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.PrintoutBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.mapframework.bundle.printout.PrintoutBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/jquery.imagesLoaded.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/Tile.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/plugin/LegendPlugin.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/service/PrintService.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/view/StartView.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/view/BasicPrintout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/request/PrintMapRequest.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/request/PrintMapRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/event/PrintableContentEvent.js"},{type:"text/css",src:"../../../../resources/framework/bundle/printout/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/en.js"},{lang:"cs",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/cs.js"},{lang:"de",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/de.js"},{lang:"es",type:"text/javascript",src:"../../../../bundles/framework/bundle/printout/locale/es.js"}]},bundle:{manifest:{"Bundle-Identifier":"printout","Bundle-Name":"printout","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" style-1",Title:" style-1"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("printout","Oskari.mapframework.bundle.printout.PrintoutBundle"),function(e,t){"use strict";var i="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";e.fn.imagesLoaded=function(n){function s(){var t=e(d),i=e(p);l&&(p.length?l.reject(c,t,i):l.resolve(c)),e.isFunction(n)&&n.call(o,c,t,i)}function a(e){r(e.target,"error"===e.type)}function r(t,n){t.src!==i&&-1===e.inArray(t,h)&&(h.push(t),n?p.push(t):d.push(t),e.data(t,"imagesLoaded",{isBroken:n,src:t.src}),u&&l.notifyWith(e(t),[n,c,e(d),e(p)]),c.length===h.length&&(setTimeout(s),c.unbind(".imagesLoaded",a)))}var o=this,l=e.isFunction(e.Deferred)?e.Deferred():0,u=e.isFunction(l.notify),c=o.find("img").add(o.filter("img")),h=[],d=[],p=[];return e.isPlainObject(n)&&e.each(n,function(e,t){"callback"===e?n=t:l&&l[e](t)}),c.length?c.bind("load.imagesLoaded error.imagesLoaded",a).each(function(n,s){var a=s.src,o=e.data(s,"imagesLoaded");return o&&o.src===a?(r(s,o.isBroken),void 0):s.complete&&s.naturalWidth!==t?(r(s,0===s.naturalWidth||0===s.naturalHeight),void 0):((s.readyState||s.complete)&&(s.src=i,s.src=a),void 0)}):s(),l?l.promise(o):o}}(jQuery),Oskari.clazz.define("Oskari.mapframework.bundle.printout.PrintoutBundleInstance",function(){this.sandbox=void 0,this.started=!1,this.plugins={},this.localization=void 0,this.printout=void 0,this.buttonGroup="viewtools",this.ignoreEvents=!1,this.dialog=void 0,this.printoutHandler=void 0,this.isMapStateChanged=!0,this.state=void 0,this.geoJson=void 0,this.tileData=void 0,this.printService=void 0,this.legendPlugin=void 0,this.backendConfiguration={formatProducers:{"application/pdf":"","image/png":""}}},{__name:"Printout",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,this.localization=Oskari.getLocalization(this.getName()),n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);e.backendConfiguration.formatProducers["application/pdf"]=(t?t.backendConfiguration.formatProducers["application/pdf"]:null)||"",e.backendConfiguration.formatProducers["image/png"]=(t?t.backendConfiguration.formatProducers["image/png"]:null)||"",this.printoutHandler=Oskari.clazz.create("Oskari.mapframework.bundle.printout.request.PrintMapRequestHandler",n,function(){e.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e.instance,"attach"])}),n.addRequestHandler("printout.PrintMapRequest",this.printoutHandler);var s=n.getRequestBuilder("Toolbar.AddToolButtonRequest"),a={print:{iconCls:"tool-print",tooltip:this.localization.btnTooltip,sticky:!0,callback:function(){e.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[e,"attach"])}}};for(var r in a)n.request(this,s(r,this.buttonGroup,a[r]));var o=Oskari.clazz.create("Oskari.mapframework.bundle.printout.service.PrintService",e);n.registerService(o),this.printService=o;var l=e.getLocalization(),u=n.findRegisteredModuleInstance("MainMapModule"),c=this.conf.legend,h=Oskari.clazz.create("Oskari.mapframework.bundle.printout.plugin.LegendPlugin",e,c,l);u.registerPlugin(h),u.startPlugin(h),this.legendPlugin=h;var d=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,d),e._createUi(),n.registerAsStateful(this.mediator.bundleId,this),this.tileData={}}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{MapLayerVisibilityChangedEvent:function(){this.printout&&this.printout.isEnabled&&this.isMapStateChanged&&(this.isMapStateChanged=!1,this.getSandbox().printDebug("PRINTOUT REFRESH"),this.printout.refresh(!0))},AfterMapMoveEvent:function(){this.isMapStateChanged=!0,this.printout&&this.printout.isEnabled&&this.printout.refresh(!1),this.isMapStateChanged=!0},AfterMapLayerAddEvent:function(){this.isMapStateChanged=!0,this.printout&&this.printout.isEnabled&&this.printout.refresh(!1)},AfterMapLayerRemoveEvent:function(){this.isMapStateChanged=!0,this.printout&&this.printout.isEnabled&&this.printout.refresh(!1)},AfterChangeMapLayerStyleEvent:function(){this.isMapStateChanged=!0,this.printout&&this.printout.isEnabled&&this.printout.refresh(!1)},"userinterface.ExtensionUpdatedEvent":function(e){var t=this;if(e.getExtension().getName()==t.getName()){var i="close"!=e.getViewState();t.displayContent(i)}},"Printout.PrintableContentEvent":function(e){var t=(e.getContentId(),e.getLayer()),i=t&&t.getId?t.getId():null,n=e.getTileData(),s=e.getGeoJsonData();s&&(this.geoJson=s),n&&i&&(this.tileData[i]=n)}},stop:function(){this.printout&&(this.printout.destroy(),this.printout=void 0),this.geoJson=null,this.tileData=null;var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.removeRequestHandler("printout.PrintMapRequest",this.printoutHandler),this.printoutHandler=null;var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.printout.Flyout",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},_createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi()},setPublishMode:function(e){var t=this,i=jQuery("#contentMap");if(jQuery("#maptools"),1==e){var n=t.sandbox.getRequestBuilder("userinterface.UpdateExtensionRequest")(t,"close",t.getName());t.sandbox.request(t.getName(),n),this.printout||(this.printout=Oskari.clazz.create("Oskari.mapframework.bundle.printout.view.BasicPrintout",this,this.getLocalization("BasicView"),this.backendConfiguration),this.printout.render(i)),this.state&&this.state.form&&this.printout.setState(this.state.form),this.printout.show(),this.printout.setEnabled(!0),this.printout.refresh(!1),this.printout.refresh(!0)}else this.printout&&(this.printout.setEnabled(!1),this.printout.hide(),this.printout&&this.legendPlugin.clearLegendLayers())},displayContent:function(e){e&&this.plugins["Oskari.userinterface.Flyout"].refresh()},setState:function(e){this.state=e},getState:function(){var e=this.state||{};if(this.printout){var t=this.printout.getState();e.form=t}return e}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension","Oskari.userinterface.Stateful"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.view=null},{getName:function(){return"Oskari.mapframework.bundle.printout.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("printout")||jQuery(this.container).addClass("printout")},startPlugin:function(){this.template=jQuery("<div></div>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("flyouttitle")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},createUi:function(){jQuery(this.container),this.view=Oskari.clazz.create("Oskari.mapframework.bundle.printout.view.StartView",this.instance,this.instance.getLocalization("StartView"))},refresh:function(){var e=jQuery(this.container);e.empty(),this.view.render(e)}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.printout.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.plugin.LegendPlugin",function(e,t,i){this.instance=e,this.sandbox=e.sandbox,this.mapModule=null,this.pluginName=null,this.conf=t,this.conf||(this.conf={}),this.locale=i,this.headerLayer=null,this.printAreaLayer=null,this.boxesLayer=null,this._map=null},{__name:"LegendPlugin",__qname:"Oskari.mapframework.bundle.printout.plugin.LegendPlugin",getQName:function(){return this.__qname},getName:function(){return this.pluginName},getMap:function(){return this._map},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this)
},stopPlugin:function(e){e.unregister(this)},start:function(){},stop:function(){},init:function(){var e=new OpenLayers.StyleMap({"default":this.conf.printAreaDefault});this.printAreaLayer=new OpenLayers.Layer.Vector("PrintArea",{styleMap:e});var t=new OpenLayers.StyleMap({"default":this.conf.legendBoxDefault});this.headerLayer=new OpenLayers.Layer.Vector("LegendHeader",{styleMap:t});var i=new OpenLayers.StyleMap({"default":this.conf.colorBoxDefault});this.boxesLayer=new OpenLayers.Layer.Vector("LegendBoxes",{styleMap:i})},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this._map=e.getMap(),this.pluginName=e.getName()+this.__name)},plotLegend:function(e,t,i,n){var s=this.getMapModule().getMap();-1==s.getLayerIndex(this.printAreaLayer)?(s.addLayer(this.printAreaLayer),s.setLayerIndex(this.printAreaLayer,10004)):s.raiseLayer(this.printAreaLayer,101),-1==s.getLayerIndex(this.headerLayer)?(s.addLayer(this.headerLayer),s.setLayerIndex(this.headerLayer,10005)):s.raiseLayer(this.headerLayer,102),s.getLayerIndex(-1==this.boxesLayer)?(s.addLayer(this.boxesLayer),s.setLayerIndex(this.boxesLayer,10006)):s.raiseLayer(this.boxesLayer,103),this.clearLegendLayers();var a=this._getLegendGeom(e,t,i,n);return this._plotLegendHeader(e,t,a),this._plotLegendBoxes(e,t,a),this._createPrintGeoJSON()},_maxLayerIndex:function(){for(var e=0,t=this.instance.getSandbox().findAllSelectedMapLayers(),i=0;i<t.length;i++)this.getMapModule().getMap().getLayerIndex(t[i])>e&&(e=this.getMapModule().getMap().getLayerIndex(t[i]));return e},_getLegendGeom:function(e,t,i,n){var s=i.features[0].properties;s.targetWidth,s.targetHeight;var a=i.features[0].geometry.coordinates[0],r=Number(a[1][0])-Number(a[0][0]),o=Number(a[2][1])-Number(a[1][1]),l=[];if(e.length>this.conf.general.charsInrow){for(var u=e.split(" "),c="",h=0;h<u.length;h++)c.length+u[h].length+1<this.conf.general.charsInrow?c=c+u[h]+" ":(l.push(c),c=u[h]);c.length>0&&l.push(c)}else l.push(e);var d=r;o>r&&(d=o);var p=this.conf.general.legendRowHeight*d*(t.length+l.length+1),f=this.conf.general.legendWidth*d,m=p/(t.length+l.length+1),g=[];"LL"==n?(g.push(new OpenLayers.Geometry.Point(a[0][0],a[0][1]+p)),g.push(new OpenLayers.Geometry.Point(a[0][0]+f,a[0][1]+p)),g.push(new OpenLayers.Geometry.Point(a[0][0]+f,a[0][1])),g.push(new OpenLayers.Geometry.Point(a[0][0],a[0][1]))):"LU"==n?(g.push(new OpenLayers.Geometry.Point(a[0][0],a[3][1])),g.push(new OpenLayers.Geometry.Point(a[0][0]+f,a[3][1])),g.push(new OpenLayers.Geometry.Point(a[0][0]+f,a[3][1]-p)),g.push(new OpenLayers.Geometry.Point(a[0][0],a[3][1]-p))):"RU"==n?(g.push(new OpenLayers.Geometry.Point(a[2][0]-f,a[2][1])),g.push(new OpenLayers.Geometry.Point(a[2][0],a[2][1])),g.push(new OpenLayers.Geometry.Point(a[2][0],a[2][1]-p)),g.push(new OpenLayers.Geometry.Point(a[2][0]-f,a[2][1]-p))):"RL"==n&&(g.push(new OpenLayers.Geometry.Point(a[1][0]-f,a[1][1]+p)),g.push(new OpenLayers.Geometry.Point(a[1][0],a[1][1]+p)),g.push(new OpenLayers.Geometry.Point(a[1][0],a[1][1])),g.push(new OpenLayers.Geometry.Point(a[1][0]-f,a[1][1])));for(var y=[],h=0;coordp=a[h++];)y.push(new OpenLayers.Geometry.Point(coordp[0],coordp[1]));var v={print_area:y,bbox:g,rangebox_size:m,properties:s,titles:l};return v},clearLegendLayers:function(){this.headerLayer&&this.headerLayer.removeAllFeatures(),this.boxesLayer&&this.boxesLayer.removeAllFeatures(),this.printAreaLayer&&this.printAreaLayer.removeAllFeatures()},_plotLegendHeader:function(e,t,i){var n=this,s=i.bbox,a=s,r=new OpenLayers.Geometry.LinearRing(a),o=new OpenLayers.Geometry.Polygon([r]),l="\0",u={color:"#FFFFFF",name:l},c=new OpenLayers.Geometry.LineString(i.print_area),h=new OpenLayers.Feature.Vector(c,null);n.printAreaLayer.addFeatures([h]),n.printAreaLayer.redraw();var d=new OpenLayers.Feature.Vector(o,u);n.headerLayer.addFeatures([d]);for(var p=i.titles,f=0;f<p.length;f++){var m=s[0].clone(),g=new OpenLayers.Geometry.Point(m.x+.2*i.rangebox_size,m.y-(f*i.rangebox_size+i.rangebox_size/2)),y={name:p[f]},v=new OpenLayers.Feature.Vector(g,y);n.headerLayer.addFeatures([v])}n.headerLayer.redraw()},_plotLegendBoxes:function(e,t,i){for(var n=this,s="\0",a=i.bbox,r=i.titles,o=i.rangebox_size,l=.8*i.rangebox_size,u=a[0].clone(),c=u.x+.2*o,h=u.y-o*r.length,d=0;d<t.length;d++){var p=t[d],f="#FFFFFF";p.boxcolor.split(":").length>1&&(f=p.boxcolor.split(":")[1].replace(/^\s+|\s+$/g,""));var m=c,g=h,y=[new OpenLayers.Geometry.Point(m,g),new OpenLayers.Geometry.Point(m+l,g),new OpenLayers.Geometry.Point(m+l,g-l),new OpenLayers.Geometry.Point(m,g-l)],v=new OpenLayers.Geometry.LinearRing(y),b=new OpenLayers.Geometry.Polygon([v]),_={color:f,name:s},w=new OpenLayers.Feature.Vector(b,_);n.boxesLayer.addFeatures([w]);var u=new OpenLayers.Geometry.Point(m+o,g-l),L={name:p.range},k=new OpenLayers.Feature.Vector(u,L);n.boxesLayer.addFeatures([k]),h-=o}n.boxesLayer.redraw()},_createPrintGeoJSON:function(){var e=new OpenLayers.Format.GeoJSON,t=[],i=JSON.parse(e.write(this.headerLayer.features)),n={type:"geojson",name:this.headerLayer.name,id:this.headerLayer.name,data:{type:"FeatureCollection",features:i.features},styles:[]};n.styles.push(this._getDefaultStyle(this.headerLayer.styleMap)),t.push(n);var s=JSON.parse(e.write(this.boxesLayer.features)),n={type:"geojson",name:this.boxesLayer.name,id:this.boxesLayer.name,data:{type:"FeatureCollection",features:s.features},styles:[]};return n.styles.push(this._getDefaultStyle(this.boxesLayer.styleMap)),t.push(n),t},_getDefaultStyle:function(e){var t=e.styles["default"].defaultStyle,i=e.styles["default"].id,n={title:"Standard",name:i,styleMap:{"default":{}}};return n.styleMap["default"]=this._cleanStyle(t,["labelXOffset","labelYOffset"]),n},_cleanStyle:function(e,t){for(var i=jQuery.extend(!0,{},e),n=0;n<t.length;n++){var s=t[n];i[s]&&i[s].toString().indexOf("${delta")>-1&&delete i[s]}return i},protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.service.PrintService",function(e){this.instance=e,this.sandbox=e.sandbox},{__name:"Printout.PrintService",__qname:"Oskari.mapframework.bundle.printout.service.PrintService",getQName:function(){return this.__qname},getName:function(){return this.__name},init:function(){},fetchPrintMapData:function(e,t,i){jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:e,success:function(e){t&&t(e)},error:function(e,t){i&&0!=e.status&&i(e,t)}})}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.view.StartView",function(e,t){this.instance=e,this.template=jQuery("<div class='startview'><div class='content'></div><div class='buttons'></div></div>"),this.templateError=jQuery('<div class="error"><ul></ul></div>'),this.templateInfo=jQuery("<div class='icon-info'></div>"),this.loc=t,this.content=void 0,this.buttons={},this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert")},{_isTooManyLayers:function(){var e=this.instance.getSandbox().findAllSelectedMapLayers().length,t=e>7;return t},_isManyLayers:function(){var e=this.instance.getSandbox().findAllSelectedMapLayers().length,t=e>2;return t},render:function(e){var t=this,i=this.template.clone();this.content=i,e.append(i),this.alert.insertTo(e);var n=this._isTooManyLayers(),s=this._isManyLayers();if(n?this.alert.setContent(this.loc.info.maxLayers,"error"):s?this.alert.setContent(this.loc.info.printoutProcessingTime,"info"):this.alert.setContent(this.loc.text,"default"),!n){var a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.addClass("primary"),a.setTitle(this.loc.buttons["continue"]),a.setHandler(function(){t.instance.setPublishMode(!0)}),this.buttons["continue"]=a,a.insertTo(i.find("div.buttons"))}var r=Oskari.clazz.create("Oskari.userinterface.component.Button");n&&r.addClass("primary"),r.setTitle(this.loc.buttons.cancel),r.setHandler(function(){t.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[t.instance,"close"])}),this.buttons.cancel=r,r.insertTo(i.find("div.buttons"))}}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.view.BasicPrintout",function(e,t,i){this.isEnabled=!1,this.instance=e,this.loc=t,this.backendConfiguration=i,this.legendInProcess=!1,this.template={};for(p in this.__templates)this.template[p]=jQuery(this.__templates[p]);this.sizeOptions=this.loc.size.options,this.sizeOptionsMap={};for(var n=0;n<this.sizeOptions.length;n++)this.sizeOptionsMap[this.sizeOptions[n].id]=this.sizeOptions[n];this.formatOptions=this.loc.format.options,this.formatOptionsMap={};for(var s=0;s<this.formatOptions.length;s++)this.formatOptionsMap[this.formatOptions[s].id]=this.formatOptions[s];this.contentOptions=this.loc.content.options,this.contentOptionsMap={};for(var s=0;s<this.contentOptions.length;s++)this.contentOptionsMap[this.contentOptions[s].id]=this.contentOptions[s];this.legendOptions=this.loc.legend.options,this.legendOptionsMap={};for(var s=0;s<this.legendOptions.length;s++)this.legendOptionsMap[this.legendOptions[s].id]=this.legendOptions[s];this.accordion=null,this.mainPanel=null,this.progressSpinner=Oskari.clazz.create("Oskari.userinterface.component.ProgressSpinner"),this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert"),this.previewContent=null,this.previewImgDiv=null,this.contentOptionDivs={}},{__templates:{preview:'<div class="preview"><img /><span></span></div>',previewNotes:'<div class="previewNotes"><span></span></div>',location:'<div class="location"></div>',tool:'<div class="tool "><input type="checkbox"/><label></label></div>',buttons:'<div class="buttons"></div>',help:'<div class="help icon-info"></div>',main:'<div class="basic_printout"><div class="header"><div class="icon-close"></div><h3></h3></div><div class="content"></div><form method="post" target="map_popup_111" id="oskari_print_formID" style="display:none" action="" ><input name="geojson" type="hidden" value="" id="oskari_geojson"/><input name="tiles" type="hidden" value="" id="oskari_tiles"/></form></div>',format:'<div class="printout_format_cont printout_settings_cont"><div class="printout_format_label"></div></div>',formatOptionTool:'<div class="tool "><input type="radio" name="format" /><label></label></div>',legend:'<div class="printout_legend_cont printout_settings_cont"><div class="printout_legend_label"></div></div>',legendOptionTool:'<div class="tool "><input type="radio" name="legend" /><label></label></div>',title:'<div class="printout_title_cont printout_settings_cont"><div class="printout_title_label"></div><input class="printout_title_field" type="text"></div>',option:'<div class="printout_option_cont printout_settings_cont"><input type="checkbox" /><label></label></div>',sizeOptionTool:'<div class="tool "><input type="radio" name="size" /><label></label></div>'},render:function(e){var t=this,i=this.template.main.clone();this.mainPanel=i,i.find("div.header h3").append(this.loc.title),e.append(i);var n=i.find("div.content");this.alert.insertTo(n);var s=Oskari.clazz.create("Oskari.userinterface.component.Accordion");this.accordion=s;var a=this._createSizePanel();a.open(),s.addPanel(a);var r=this._createSettingsPanel();s.addPanel(r);var o=this._createPreviewPanel();o.open(),s.addPanel(o),s.insertTo(n),this._setLegendVisibility(),e.find("div.header div.icon-close").bind("click",function(){t.instance.setPublishMode(!1)}),n.append(this._getButtons());var l=this.mainPanel.find("input[type=text]");l.focus(function(){t.instance.sandbox.postRequestByName("DisableMapKeyboardMovementRequest")}),l.blur(function(){t.instance.sandbox.postRequestByName("EnableMapKeyboardMovementRequest")});var u=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",this.instance.sandbox);u.processHelpLinks(this.loc.help,i,this.loc.error.title,this.loc.error.nohelp)},_createSizePanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.size.label);var i=t.getContainer(),n=this.template.help.clone();n.attr("title",this.loc.size.tooltip),i.append(n);for(var s=function(t){return function(){i.find("input[name=size]:checked").val();for(var n=0;n<e.sizeOptions.length;++n)e.sizeOptions[n].selected=!1;t.selected=!0,e._cleanMapPreview(),e._updateMapPreview(),e._createLegend()}},a=0;a<this.sizeOptions.length;++a){var r=this.sizeOptions[a],o=this.template.sizeOptionTool.clone(),l=r.label;r.width&&r.height&&(l=l+" ("+r.width+" x "+r.height+"px)"),o.find("label").append(l).attr({"for":r.id,"class":"printout_radiolabel"}),r.selected&&o.find("input").attr("checked","checked"),i.append(o),o.find("input").attr({value:r.id,name:"size",id:r.id}),o.find("input").change(s(r))}return t},_createSettingsPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.settings.label);var i=t.getContainer(),n=this.template.help.clone();n.attr("title",this.loc.settings.tooltip),i.append(n);var s=function(t){return function(){i.find("input[name=format]:checked").val();for(var n=0;n<e.formatOptions.length;++n)e.formatOptions[n].selected=!1;t.selected=!0}},a=this.template.format.clone();a.find(".printout_format_label").html(this.loc.format.label);for(var r=0;r<this.formatOptions.length;++r){var o=this.formatOptions[r],l=this.template.formatOptionTool.clone(),u=o.label;l.find("label").append(u).attr({"for":o.id,"class":"printout_radiolabel"}),o.selected&&l.find("input").attr("checked","checked"),a.append(l),l.find("input").attr({value:o.format,name:"format",id:o.id}),l.find("input").change(s(o))}i.append(a);var c=this.template.title.clone();c.find(".printout_title_label").html(this.loc.mapTitle.label),c.find(".printout_title_field").attr({value:"",placeholder:this.loc.mapTitle.label}),i.append(c);for(var h=0;h<this.contentOptions.length;h++){var d=this.contentOptions[h],p=this.template.option.clone();p.find("input").attr({id:d.id,checked:d.checked}),p.find("label").html(d.label).attr({"for":d.id,"class":"printout_checklabel"}),this.contentOptionDivs[d.id]=p,i.append(p)}var f=function(t){return function(){i.find("input[name=legend]:checked").val();for(var n=0;n<e.legendOptions.length;++n)e.legendOptions[n].selected=!1;t.selected=!0}},m=this.template.legend.clone();m.find(".printout_legend_label").html(this.loc.legend.label);for(var r=0;r<this.legendOptions.length;++r){var o=this.legendOptions[r],l=this.template.legendOptionTool.clone(),u=o.label;l.find("label").append(u).attr({"for":o.id,"class":"printout_radiolabel"}),o.selected&&l.find("input").attr("checked","checked"),m.append(l),l.find("input").attr({value:o.loca,name:"location",id:o.id}),l.find("input").change(f(o)),l.find('input[name="location"]').click(function(){e._createLegend()})}return i.append(m),t},_createPreviewPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.preview.label);var i=t.getContainer(),n=this.template.help.clone();n.attr("title",this.loc.preview.tooltip),i.append(n);var s=this.template.preview.clone();i.append(s),e.progressSpinner.insertTo(s);var a=s.find("img");a.click(function(){e.showFullScaleMapPreview()});var r=s.find("span");this.previewContent=s,this.previewImgDiv=a,this.previewSpan=r;for(var o in this.loc.preview.notes){var l=this.template.previewNotes.clone();l.find("span").text(this.loc.preview.notes[o]),i.append(l)}return t},_createLocationAndScalePanel:function(){var e=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");e.setTitle(this.loc.location.label);var t=e.getContainer(),i=this.template.help.clone();i.attr("title",this.loc.location.tooltip),t.append(i);var n=this.template.location.clone();return t.append(n),e},_cleanMapPreview:function(){var e=this.loc,t=this.previewImgDiv,i=this.previewSpan;t.hide(),i.text(e.preview.pending)},_updateMapPreview:function(){var e=this,t=this._gatherSelections("image/png"),i=this.backendConfiguration.formatProducers[t.format],n=t.maplinkArgs,s="&pageSize="+t.pageSize,a="&scaledWidth=200",r=i+n+s+a;this.previewContent.removeClass("preview-portrait"),this.previewContent.removeClass("preview-landscape"),this.previewContent.addClass(this.sizeOptionsMap[t.pageSize].classForPreview);var o=this.previewImgDiv,l=this.previewSpan;e.progressSpinner.start(),window.setTimeout(function(){o.imagesLoaded(function(){l.text(""),o.fadeIn("slow",function(){e.progressSpinner.stop()})}),o.attr("src",r)},100)},showFullScaleMapPreview:function(){var e=this._gatherSelections("image/png"),t=this.backendConfiguration.formatProducers[e.format],i=e.maplinkArgs,n="&pageSize="+e.pageSize,s=t+i+n;this.openURLinWindow(s,e)},_getButtons:function(){var e=this,t=this.template.buttons.clone(),i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.setTitle(this.loc.buttons.cancel),i.setHandler(function(){e.instance.setPublishMode(!1)}),i.insertTo(t);var n=Oskari.clazz.create("Oskari.userinterface.component.Button");return n.setTitle(this.loc.buttons.save),n.addClass("primary"),n.setHandler(function(){var t=e.instance.sandbox.getMap(),i="undefined"==typeof t.geojs?null:t.geojs,n=e._gatherSelections();n&&e._printMap(n,i)}),n.insertTo(t),t},_gatherSelections:function(e){var t=this.mainPanel,i=this.instance.getSandbox(),n=t.find("input[name=size]:checked").val(),s=null!=e?e:t.find("input[name=format]:checked").val(),a=t.find(".printout_title_field").val(),r=i.generateMapLinkParameters(),o={pageTitle:a,pageSize:n,maplinkArgs:r,format:s||"application/pdf"};for(var l in this.contentOptionsMap)o[l]=this.contentOptionDivs[l].find("input").prop("checked");return o},openURLinWindow:function(e,t){var i="location=1,status=1,scrollbars=1,width=850,height=1200";this._isLandscape(t)&&(i="location=1,status=1,scrollbars=1,width=1200,height=850");var n=e;window.open(n,"BasicPrintout",i)},openPostURLinWindow:function(e,t,i,n){var s=this,a="location=1,status=1,scrollbars=1,width=850,height=1200";this._isLandscape(n)&&(a="location=1,status=1,scrollbars=1,width=1200,height=850");var r=i;if(s.mainPanel.find("#oskari_print_formID").attr("action",r),e){var o=unescape(encodeURIComponent(e));s.mainPanel.find("input[name=geojson]").val(jQuery.base64.encode(o))}t&&s.mainPanel.find("input[name=tiles]").val(t),window.open("about:blank","map_popup_111",a),s.mainPanel.find("#oskari_print_formID").submit()},_printMap:function(e){var t=this.instance.getSandbox(),i=t.getAjaxUrl();this.backendConfiguration.formatProducers[e.format];var n=e.maplinkArgs,s="&pageSize="+e.pageSize,a="&pageTitle="+e.pageTitle,r=[];for(var o in this.contentOptionsMap)e[o]&&r.push("&"+o+"=true");var l=r.join(""),u="&format="+e.format,c=n+"&action_route=GetPreview"+s+a+l+u;if(i+=c,this.instance.geoJson||!jQuery.isEmptyObject(this.instance.tileData)){var h=this._stringifyGeoJson(this.instance.geoJson),d=this._stringifyTileData(this.instance.tileData);this.instance.getSandbox().printDebug("PRINT POST URL "+i),this.openPostURLinWindow(h,d,i,e)}else this.instance.getSandbox().printDebug("PRINT URL "+i),this.openURLinWindow(i,e)},_isLandscape:function(e){return this.sizeOptionsMap[e.pageSize].id.indexOf("Land")>-1?!0:!1},_stringifyGeoJson:function(e){return e?JSON.stringify(e).replace('"','"'):null},_stringifyTileData:function(e){if(jQuery.isEmptyObject(e))return null;var t,i=[];for(var n in e)i.push(e[n]);return t=[].concat.apply([],i),JSON.stringify(t)},_setLegendVisibility:function(){var e=this.mainPanel;this._hasStatsLayers()?e.find(".printout_legend_cont").show():e.find(".printout_legend_cont").hide()},_hasStatsLayers:function(){for(var e=this.instance.getSandbox().findAllSelectedMapLayers(),t=0;t<e.length;t++)if(e[t].isLayerOfType("STATS")&&e[t].isVisible())return!0;return!1},_createLegend:function(){var e=this;if(e._setLegendVisibility(),e._hasStatsLayers()){this.instance.sandbox.getMap();var t=this.mainPanel,i=jQuery("#contentMap"),n=t.find("input[name=location]:checked").val();if("NO"==n)e.instance.getSandbox().getMap().GeoJSON&&(e.instance.getSandbox().getMap().GeoJSON=null),e.instance.legendPlugin.clearLegendLayers();else{var s=i.find("div.geostats-legend");if(s.length>0){if(e.legendInProcess)return;e.legendInProcess=!0,this._printMapInfo(s,function(t){var i=s.find(".geostats-legend-title").html(),a=[];s.find("div").each(function(){var e=jQuery(this).attr("class");if(void 0==e){var t={boxcolor:jQuery(this).find(".geostats-legend-block").attr("style"),range:jQuery(this).text()};a.push(t)}});var r=e.instance.legendPlugin.plotLegend(i,a,t,n);e.instance.geoJson=r,e.legendInProcess=!1})}}}},_printMapInfo:function(e,t){var i=this,n=i._gatherSelections(),s=this.instance.getSandbox(),a=s.getAjaxUrl();this.backendConfiguration.formatProducers[n.format];var r=n.maplinkArgs,o="&pageSize="+n.pageSize,l="&pageTitle="+n.pageTitle,u=[];for(var c in this.contentOptionsMap)n[c]&&u.push("&"+c+"=true");var h=u.join(""),d="&format="+n.format,p=r+"&action_route=GetProxyRequest&serviceId=print"+o+l+h+d;a+=p,i.instance.printService.fetchPrintMapData(a,function(e){e?t(e):alert("Error to fetch print info: ")},function(){alert("Error to fetch print info: ")})},destroy:function(){this.mainPanel.remove()},hide:function(){this.mainPanel.hide()},show:function(){this.mainPanel.show()},setEnabled:function(e){this.isEnabled=e},getEnabled:function(){return this.isEnabled},refresh:function(e){e?this._updateMapPreview():this._cleanMapPreview(),this._createLegend()},getState:function(){return this._gatherSelections()},setState:function(){}}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.request.PrintMapRequest",function(e){this._creator=null,this._selections=e},{__name:"printout.PrintMapRequest",getName:function(){return this.__name},getSelections:function(){return this._selections}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.request.PrintMapRequestHandler",function(e,t){this.sandbox=e,this.cb=t},{handleRequest:function(e,t){var i=t.getSelections();this.sandbox.printDebug("[Oskari.mapframework.bundle.printout.request.PrintMapRequestHandler] printout requested"),this.cb(i)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.mapframework.bundle.printout.event.PrintableContentEvent",function(e,t,i,n){this._contentId=e,this._layer=t,this._tileData=i,this._geojsonData=n},{getName:function(){return"Printout.PrintableContentEvent"},getContentId:function(){return this._contentId},getLayer:function(){return this._layer},setLayer:function(e){this._layer=e},getTileData:function(){return this._tileData},setTileData:function(e){this._tileData=e},getGeoJsonData:function(){return this._geojsonData},setGeoJsonData:function(e){this._geojsonData=e}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.mapframework.bundle.postprocessor.PostProcessorBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.mapframework.bundle.postprocessor.PostProcessorBundleInstance")},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/postprocessor/instance.js"}]},bundle:{manifest:{"Bundle-Identifier":"postprocessor","Bundle-Name":"postprocessor","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2012"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("postprocessor","Oskari.mapframework.bundle.postprocessor.PostProcessorBundle"),Oskari.clazz.define("Oskari.mapframework.bundle.postprocessor.PostProcessorBundleInstance",function(){this.sandbox=null},{__name:"PostProcessor",getName:function(){return this.__name},start:function(){var e=this.conf,t=(e?e.sandbox:null)||"sandbox",i=Oskari.getSandbox(t);if(this.sandbox=i,i.register(this),this.state){var n=this.state.highlightFeatureLayerId;this._highlightFeature(n,this.state.highlightFeatureId)}},_highlightFeature:function(e,t){if(t&&e){var i=this.state.featurePoints;i&&this._showPoints(i);var n=this.sandbox.getEventBuilder("WFSFeaturesSelectedEvent"),s=[];"[object Array]"===Object.prototype.toString.call(t)?s=t:s.push(t);var a=Oskari.clazz.create("Oskari.mapframework.domain.WfsLayer");a.setId(e),a.setOpacity(100);var r=n(s,a);this.sandbox.notifyAll(r)}},_showPoints:function(e){for(var t=new OpenLayers.Geometry.MultiPoint,i=0;i<e.length;++i){var n=e[i],s=new OpenLayers.Geometry.Point(n.lat,n.lon);t.addPoint(s)}var a=t.getBounds(),r=t.getCentroid(),o=this.sandbox.getRequestBuilder("MapMoveRequest");if(o&&i>0)if(1==i){var l=o(r.x,r.y,9);this.sandbox.request(this,l)}else{var l=o(r.x,r.y,a);this.sandbox.request(this,l)}},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{MapLayerEvent:function(e){"add"!=e.getOperation()||e.getLayerId()||this._highlightFeature(this.state.highlightFeatureLayerId,this.state.highlightFeatureId)}},init:function(){return null},update:function(){},stop:function(){}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatsGridBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.StatsGridBundleInstance","statsgrid")},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/instance.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/StatsView.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/GridModeView.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/StatsToolbar.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/plugin/ManageClassificationPlugin.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/plugin/ManageStatsPlugin.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/event/SotkadataChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/event/ModeChangedEvent.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/event/ClearHilightsEvent.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/event/SelectHilightsModeEvent.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/request/StatsGridRequest.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/request/StatsGridRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/request/TooltipContentRequest.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/request/TooltipContentRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/service/StatisticsService.js"},{type:"text/css",src:"../../../../resources/statistics/bundle/statsgrid/css/style.css"},{type:"text/css",src:"../../../../resources/statistics/bundle/statsgrid/css/classifyplugin.css"},{type:"text/css",src:"../../../../libraries/slickgrid/css/slick.grid.css"},{type:"text/css",src:"../../../../libraries/slickgrid/css/municipality.css"},{type:"text/css",src:"../../../../libraries/slickgrid/css/slick-default-theme.css"},{src:"../../../../libraries/jquery/jquery.event.drag-2.0.min.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.core.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.formatters.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.editors.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.cellrangedecorator.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.cellrangeselector.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.cellselectionmodel.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.headermenu2.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.headermenu2.css",type:"text/css"},{src:"../../../../libraries/slickgrid/plugins/slick.rowselectionmodel.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/plugins/slick.checkboxselectcolumn2.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.grid.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.groupitemmetadataprovider.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/slick.dataview.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/controls/slick.pager.js",type:"text/javascript"},{src:"../../../../libraries/slickgrid/controls/slick.columnpicker.js",type:"text/javascript"},{src:"../../../../libraries/chosen/chosen.jquery.js",type:"text/javascript"},{src:"../../../../libraries/chosen/chosen.css",type:"text/css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/statistics/bundle/statsgrid/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"statsgrid","Bundle-Name":"statsgrid","Bundle-Author":[{Name:"jjk",Organisatpation:"nls.fi",Temporal:{Start:"2013",End:"2013"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Verspation":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("statsgrid","Oskari.statistics.bundle.statsgrid.StatsGridBundle"),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatsGridBundleInstance",function(){this.conf={name:"StatsGrid",sandbox:"sandbox",stateful:!0,viewClazz:"Oskari.statistics.bundle.statsgrid.StatsView"},this.state={indicators:[],layerId:null}},{start:function(){var e=this,t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,n.register(this),t&&t.stateful===!0&&n.registerAsStateful(this.mediator.bundleId,this);var s=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,s);var a=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.request.TooltipContentRequestHandler",this);n.addRequestHandler("StatsGrid.TooltipContentRequest",a);var r=e.getLocalization(),o=n.findRegisteredModuleInstance("MainMapModule");this.mapModule=o;var l=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.StatisticsService",e);n.registerService(l),this.statsService=l;var u={state:e.getState(),statistics:[{id:"avg",visible:!0},{id:"max",visible:!0},{id:"min",visible:!0},{id:"mde",visible:!0},{id:"mdn",visible:!0},{id:"std",visible:!0},{id:"sum",visible:!0}]},c=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.plugin.ManageStatsPlugin",u,r);o.registerPlugin(c),o.startPlugin(c),this.gridPlugin=c;var h=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.plugin.ManageClassificationPlugin",t,r);o.registerPlugin(h),o.startPlugin(h),this.classifyPlugin=h,this.setState(this.state)},eventHandlers:{"userinterface.ExtensionUpdatedEvent":function(e){var t=this,i=this.plugins["Oskari.userinterface.View"];if(e.getExtension().getName()==t.getName()){var n="close"!=e.getViewState();i.prepareMode(n,null,!0)}},"MapStats.StatsVisualizationChangeEvent":function(e){this._afterStatsVisualizationChangeEvent(e)},AfterMapMoveEvent:function(){var e=this.plugins["Oskari.userinterface.View"];e.isVisible&&e._layer&&this._createPrintParams(e._layer)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)
}},setState:function(e){var t=this,i=this.plugins["Oskari.userinterface.View"],n=i.getEl(),s=this.sandbox.findMapLayerFromAllAvailable(e.layerId);s&&(t.gridPlugin.setState(e),i.isVisible?t.gridPlugin.loadStateIndicators(e,n):i.prepareMode(!0,s))},getState:function(){return this.state},getStateParameters:function(){if(!this.state||jQuery.isEmptyObject(this.state))return null;var e=null,t=null,i=null,n="statsgrid=",s="+",a=",",r=null,o=null,l=this.state,u=["layerId","currentColumn","methodId","numberOfClasses","manualBreaksInput"],c=l.indicators||[];for(e=0,t=u.length,i=t-1;t>e;e++)value=l[u[e]],null==value||(r+=value),e!=i&&(r+=s);for(e=0,t=c.length,i=t-1;t>e;e++)o+=c[e].indicator,o+=s,o+=c[e].year,o+=s,o+=c[e].gender,e!=i&&(o+=a);return r&&o?n+r+"-"+o:null},getView:function(){return this.plugins["Oskari.userinterface.View"]},_createPrintParams:function(e){var t,i,n=this.mapModule.getOLMapLayers(e.getId())[0],s=[{bbox:n.maxExtent.toArray(),url:n.getURL(n.getExtent())}];this.printEvent?(t=!0,this.printEvent.setLayer(e),this.printEvent.setTileData(s)):(t=!1,i=this.sandbox.getEventBuilder("Printout.PrintableContentEvent"),i&&(this.printEvent=i(this.getName(),e,s))),this.sandbox.notifyAll(this.printEvent,t)},_afterStatsVisualizationChangeEvent:function(e){var t=e.getParams(),i=e.getLayer();this.state.methodId=t.methodId,this.state.numberOfClasses=t.numberOfClasses,this.state.manualBreaksInput=t.manualBreaksInput,this.state.colors=t.colors,this._createPrintParams(i)},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer(),i=t.getId(),n=this.plugins["Oskari.userinterface.View"];n._layer&&i===n._layer.getId()&&n.prepareMode(!1)}},{extend:["Oskari.userinterface.extension.DefaultExtension"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatsView",function(){},{showContent:function(e){e?(this.getLeftColumn().addClass("statsgrid_100"),this.getLeftColumn().append(this.getEl())):(this.getLeftColumn().removeClass("statsgrid_100"),this.getEl().empty(),this.getEl().remove())}},{protocol:["Oskari.userinterface.View"],extend:["Oskari.statistics.bundle.statsgrid.GridModeView"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.GridModeView",function(){},{startPlugin:function(){var e=this,t=e.instance.getSandbox();this.toolbar=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.StatsToolbar",{title:e.getTitle()},this.instance),this.requestHandler=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.request.StatsGridRequestHandler",e),t.addRequestHandler("StatsGrid.StatsGridRequest",this.requestHandler);var i=e.getEl();i.addClass("statsgrid")},prepareMode:function(e,t,i){if(!this.isVisible||!e){this.isVisible=1==e,(null!=t&&null==this._layer||null!=t&&this._layer.getId()!=t.getId())&&(this._layer=t,this.instance.gridPlugin.setLayer(t),this.instance.state.layerId=this._layer.getId(),this.toolbar.changeName(this._layer.getName())),this.showMode(e,i),this.showContent(e),e&&this.instance.gridPlugin.createStatsOut(this.getEl());var n=this.instance.getSandbox().getEventBuilder("StatsGrid.ModeChangedEvent");if(n){var s=n(this.isVisible);this.instance.getSandbox().notifyAll(s)}}},showMode:function(e,t){var i=this,n=this.instance.getSandbox();this.toolbar.show(e);var s=this.instance.getSandbox().findRegisteredModuleInstance("MainMapModule"),a=s.getMap();if(e){s.zoomTo(0),jQuery("#contentMap").addClass("statsgrid-contentMap"),jQuery(".oskariui-mode-content").addClass("statsgrid-mode");var r=40,o=this.getCenterColumn();o.removeClass("span12"),o.width(100-r+"%"),jQuery("#mapdiv").height(jQuery(window).height()-jQuery("#contentMap").find(".oskariui-menutoolbar").height());var l=this.getLeftColumn();l.empty(),l.removeClass("oskari-closed"),l.width(r+"%"),l.resizable({minWidth:450,handles:"e",resize:function(){o.width(jQuery(".row-fluid").width()-l.width()),a.updateSize(),i.instance.gridPlugin.grid.resizeCanvas()}}),a.updateSize()}else{jQuery("#contentMap").removeClass("statsgrid-contentMap"),jQuery(".oskariui-mode-content").removeClass("statsgrid-mode");var o=jQuery(".oskariui-center");o.width("").addClass("span12"),jQuery("#mapdiv").height(jQuery(window).height());var l=jQuery(".oskariui-left");if(l.addClass("oskari-closed"),l.width(""),l.empty(),!t){var u=n.getRequestBuilder("userinterface.UpdateExtensionRequest")(this.instance,"close",this.instance.getName());n.request(this.instance.getName(),u)}a.updateSize()}},getLeftColumn:function(){return jQuery(".oskariui-left")},getCenterColumn:function(){return jQuery(".oskariui-center")},getRightColumn:function(){return jQuery(".oskariui-right")},stopPlugin:function(){this.toolbar.destroy(),sandbox.removeRequestHandler("StatsGrid.StatsGridRequest",this.requestHandler)}},{protocol:["Oskari.userinterface.View"],extend:["Oskari.userinterface.extension.DefaultView"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatsToolbar",function(e,t){this.toolbarId="statsgrid",this.instance=t,this.localization=e,this._createUI()},{show:function(e){var t=e?"show":"hide",i=this.instance.getSandbox();i.requestByName(this.instance,"Toolbar.ToolbarRequest",[this.toolbarId,t])},destroy:function(){var e=this.instance.getSandbox();e.requestByName(this.instance,"Toolbar.ToolbarRequest",[this.toolbarId,"remove"])},changeName:function(e){var t=this.instance.getSandbox();t.requestByName(this.instance,"Toolbar.ToolbarRequest",[this.toolbarId,"changeName",e])},_createUI:function(){var e=this.instance.plugins["Oskari.userinterface.View"],t=this,i=this.instance.getSandbox();i.requestByName(this.instance,"Toolbar.ToolbarRequest",[this.toolbarId,"add",{title:t.localization.title,show:!1,closeBoxCallback:function(){e.prepareMode(!1)}}]);var n="statsgrid-tools",s={selectAreas:{toolbarid:t.toolbarId,iconCls:"selection-square",tooltip:this.instance._localization.showSelected,sticky:!1,toggleSelection:!0,callback:function(){var i=e.instance.gridPlugin,n=i.toggleSelectMunicipalitiesMode();if(n){i.unselectAllAreas(!0);var s=t.instance.getSandbox().getEventBuilder("StatsGrid.SelectHilightsModeEvent");if(s){var a=s(i.selectedMunicipalities);t.instance.getSandbox().notifyAll(a)}}else{i.grid.scrollRowToTop(0);var s=t.instance.getSandbox().getEventBuilder("StatsGrid.ClearHilightsEvent");if(s){var a=s(t.isVisible);t.instance.getSandbox().notifyAll(a)}}}}},a=this.instance,r=i.getRequestBuilder("Toolbar.AddToolButtonRequest");for(var o in s)i.request(a,r(o,n,s[o]))}}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.plugin.ManageClassificationPlugin",function(e,t){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.element=void 0,this.conf=e,this._locale=null!=t?t:Oskari.getLocalization("StatsGrid"),this.initialSetup=!0,this.colorsets_div=null,this.colorsets_seq=null,this.colorsets_qual=null,this.content=null,this.dialog=null,this.colorsetIndex=0,this.currentColorSet="seq",this.curCol=null,this._layer=null,this._params=null,this.minClassNum=2,this.maxClassNum=9,this.isSelectHilightedMode=!1,this.templates={block:'<div class="block"></div>',classificationGuide:'<p class="classification-guide"></p>'}},{__name:"ManageClassificationPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},hasUI:function(){return!0},getMap:function(){return this._map},register:function(){},unregister:function(){},init:function(){this.classify_temp=jQuery('<div class=\'manageClassificationPlugin\'><div class="classheader"><div class="header-icon icon-arrow-white-right"></div></div><div class="content"></div></div>'),this.templateContent=jQuery("<div></div>"),this.templateInstructions2=jQuery("<div class='instructions2' style= 'padding: 20px 0px 0px 0px;'></div>"),this.setColors()},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.statsService=e.getService("Oskari.statistics.bundle.statsgrid.StatisticsService"),this._createUI()},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this.element&&(this.element.remove(),this.element=void 0,delete this.element)},start:function(){},stop:function(){},eventHandlers:{MapLayerEvent:function(){for(var e=this._sandbox.findAllSelectedMapLayers(),t=e.length-1;t>=0;--t){var i=e[t];if("STATS"===i._layerType&&!i.isBaseLayer()){i.isVisible()?this._visibilityOn():this._visibilityOff();break}}},AfterMapLayerRemoveEvent:function(e){"STATS"===e.getMapLayer()._layerType&&this._visibilityOff()},AfterMapLayerAddEvent:function(e){"STATS"===e.getMapLayer()._layerType&&this._visibilityOn()},MapLayerVisibilityChangedEvent:function(e){if("STATS"===e.getMapLayer()._layerType){var t=e.getMapLayer().isVisible();t?this._visibilityOn():this._visibilityOff()}},AfterMapMoveEvent:function(){},"StatsGrid.SelectHilightsModeEvent":function(){this.isSelectHilightedMode=!0},"StatsGrid.ClearHilightsEvent":function(){this.isSelectHilightedMode=!1},"StatsGrid.SotkadataChangedEvent":function(e){this._layer=e.getLayer(),this._params=e.getParams(),this.classifyData(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},classifyData:function(){var e=this;if(e._layer){var t,i,n=this._layer,s=this._params,a=s.CUR_COL,r=[],o=!1,l=[];if(!(a.field.indexOf("indicator")<0)){var u=e._adjustClassificationSlider(s.CHECKED_COUNT),c=u.slider("option","disabled");if(c){var h=e.element.find(".classificationMethod");h.find(".block").remove();var d=jQuery(e.templates.block);return d.append(jQuery(e.templates.classificationGuide).text(this._locale.select4Municipalities)),h.append(d),this.element.find("div.content").show(),void 0}var p=e.element.find(".classificationMethod").find(".method").val(),f=Number(e.element.find(".classificationMethod").find(".classCount").find("#amount_class").val()),m=s.COL_VALUES;m=m.slice(0);var g=s.VIS_CODES,y=new geostats(m),v=s.COL_VALUES;if(1==p&&(l=y.getJenks(f)),2==p&&(l=y.getQuantile(f)),3==p&&(l=y.getEqInterval(f)),4==p){if(l=this.setManualBreaks(y),!l)return;f=l.length-1}for(t=0;f>t;t++)r[t]=[];for(i=0;i<v.length;i++){for(t=0;t<r.length;t++){if(parseFloat(v[i])>=l[t]&&parseFloat(v[i])<=l[t+1]){r[t].push(g[i]),o=!0;break}if(parseFloat(v[i])==l[t]&&parseFloat(v[i])==l[t+1]){r[t].push(g[i]),o=!0;break}}o?o=!1:r[r.length-1].push(g[i])}var b=[];for(t=0;t<r.length;t++)b.push(r[t].join(","));var _=b.join("|"),w=e._getColors(this.currentColorSet,e.colorsetIndex,f-2);e.colorsFlipped&&(w=w.split(",").reverse().join(","));var L=w.split(",");for(t=0;t<L.length;t++)L[t]="#"+L[t];y.setColors(L);var k=this.element.find(".manualBreaks").find("input[name=breaksInput]").val(),w=w.replace(/,/g,"|"),O={methodId:p,numberOfClasses:f,manualBreaksInput:k.toString(),colors:{set:e.currentColorSet,index:e.colorsetIndex,flipped:e.colorsFlipped},VIS_ID:-1,VIS_NAME:s.VIS_NAME,VIS_ATTR:s.VIS_ATTR,VIS_CLASSES:_,VIS_COLORS:"choro:"+w};this.statsService.sendVisualizationData(n,O);var x=function(e){return 0===e%1?e:Math.round(10*e)/10},S=y.getHtmlLegend(null,a.name,!0,x),h=e.element.find(".classificationMethod");h.find(".block").remove();var d=jQuery('<div class="block"></div>');d.append(S),h.append(d),this.element.find("div.content").show()}}},_createUI:function(){var e=this;this.element||(this.element=this.classify_temp.clone());var t=this.element.find("div.classheader");t.append(this._locale.classify.classify);for(var i=e.element.find("div.content"),n=jQuery('<div class="classificationMethod"><br>'+this._locale.classify.classifymethod+'<br><select class="method"></select><br></div>'),s=n.find("select"),a=[this._locale.classify.jenks,this._locale.classify.quantile,this._locale.classify.eqinterval,this._locale.classify.manual],r=0;r<a.length;r++){var o=jQuery('<option value="'+(r+1)+'">'+a[r]+"</option>");s.append(o)}s.change(function(){4==jQuery(this).val()?(jQuery(".classCount").hide(),jQuery(".manualBreaks").show()):(jQuery(".manualBreaks").hide(),jQuery(".classCount").show(),e.classifyData())});var l=jQuery('<div class="classCount">'+this._locale.classify.classes+' <input type="text" id="amount_class" readonly="readonly" value="5" /><div id="slider-range-max"></div>'),u=l.find("#slider-range-max").slider({range:"min",min:e.minClassNum,max:e.maxClassNum,value:5,slide:function(t,i){jQuery("input#amount_class").val(i.value),jQuery(this).slider("option","value",i.value),e.classifyData(t)}});this.rangeSlider=u;var c=jQuery('<div class="manualBreaks"><input type="text" name="breaksInput" placeholder="'+this._locale.classify.manualPlaceholder+'"></input>'+'<div class="icon-info"></div>'+"</div>");c.find("input[type=button]").click(function(){e._createColorDialog()}),c.find("input[name=breaksInput]").keypress(function(t){13==t.which&&e.classifyData()}).focus(function(){e._sandbox.postRequestByName("DisableMapKeyboardMovementRequest")}).blur(function(){e._sandbox.postRequestByName("EnableMapKeyboardMovementRequest")}),c.find(".icon-info").click(function(){var t="<p>"+e._locale.classify.info+"</p>";e.showMessage(e._locale.classify.infoTitle,t)}),c.hide();var h=jQuery('<input type="button" value="'+e._locale.colorset.button+'" />');h.click(function(){e._createColorDialog()});var d=jQuery('<input type="button" value="'+e._locale.colorset.flipButton+'" />');d.click(function(){e._flipCurrentColors()}),n.append(l),n.append(c),n.append(h),n.append(d),i.append(n),t.click(function(){i.animate({height:"toggle"},500)});var p=jQuery(this._map.div),f=p.find("div");f&&0!=f.length?f.first().before(this.element):p.append(this.element),i.hide(),this._visibilityOff()},showMessage:function(e,t){if(!this._published){var i=this._locale,n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(i.buttons.ok),s.addClass("primary"),s.setHandler(function(){n.close(!0)}),n.show(e,t,[s])}},setManualBreaks:function(e){var t,i,n=this,s=[],a=this.element.find(".classificationMethod").find(".manualBreaks").find("input[name=breaksInput]").val().split(",");return a.length-1<this.minClassNum||a.length-1>this.maxClassNum?(t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=this._locale.classify.manualRangeError.replace(/\{min\}/,this.minClassNum+1).replace(/\{max\}/,this.maxClassNum+1),t.show(null,i),t.fadeout(),null):(jQuery.each(a,function(e,a){var r=Number(a);return isNaN(r)?(t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=n._locale.classify.nanError,t.show(null,i),t.fadeout(),null):(s.push(r),void 0)}),e.bounds=s,e.setRanges(),s)},setColors:function(){this.colorsets_div=[{colorname:"BrBG",type:"div",colors:["d8b365,5ab4ac","d8b365,f5f5f5,5ab4ac","a6611a,dfc27d,80cdc1,018571","a6611a,dfc27d,f5f5f5,80cdc1,018571","8c510a,d8b365,f6e8c3,c7eae5,5ab4ac,01665e","8c510a,d8b365,f6e8c3,f5f5f5,c7eae5,5ab4ac,01665e","8c510a,bf812d,dfc27d,f6e8c3,c7eae5,80cdc1,35978f,01665e","8c510a,bf812d,dfc27d,f6e8c3,f5f5f5,c7eae5,80cdc1,35978f,01665e","543005,8c510a,bf812d,dfc27d,f6e8c3,c7eae5,80cdc1,35978f,01665e,003c30","543005,8c510a,bf812d,dfc27d,f6e8c3,f5f5f5,c7eae5,80cdc1,35978f,01665e,003c30"]},{colorname:"PiYG",type:"div",colors:["e9a3c9,a1d76a","e9a3c9,f7f7f7,a1d76a","d01c8b,f1b6da,b8e186,4dac26","d01c8b,f1b6da,f7f7f7,b8e186,4dac26","c51b7d,e9a3c9,fde0ef,e6f5d0,a1d76a,4d9221","c51b7d,e9a3c9,fde0ef,f7f7f7,e6f5d0,a1d76a,4d9221","c51b7d,de77ae,f1b6da,fde0ef,e6f5d0,b8e186,7fbc41,4d9221","c51b7d,de77ae,f1b6da,fde0ef,f7f7f7,e6f5d0,b8e186,7fbc41,4d9221","8e0152,c51b7d,de77ae,f1b6da,fde0ef,e6f5d0,b8e186,7fbc41,4d9221,276419","8e0152,c51b7d,de77ae,f1b6da,fde0ef,f7f7f7,e6f5d0,b8e186,7fbc41,4d9221,276419"]},{colorname:"PRGn",type:"div",colors:["af8dc3,7fbf7b","af8dc3,f7f7f7,7fbf7b","7b3294,c2a5cf,a6dba0,008837","7b3294,c2a5cf,f7f7f7,a6dba0,008837","762a83,af8dc3,e7d4e8,d9f0d3,7fbf7b,1b7837","762a83,af8dc3,e7d4e8,f7f7f7,d9f0d3,7fbf7b,1b7837","762a83,9970ab,c2a5cf,e7d4e8,d9f0d3,a6dba0,5aae61,1b7837","762a83,9970ab,c2a5cf,e7d4e8,f7f7f7,d9f0d3,a6dba0,5aae61,1b7837","40004b,762a83,9970ab,c2a5cf,e7d4e8,d9f0d3,a6dba0,5aae61,1b7837,00441b","40004b,762a83,9970ab,c2a5cf,e7d4e8,f7f7f7,d9f0d3,a6dba0,5aae61,1b7837,00441b"]},{colorname:"PuOr",type:"div",colors:["f1a340,998ec3","f1a340,f7f7f7,998ec3","e66101,fdb863,b2abd2,5e3c99","e66101,fdb863,f7f7f7,b2abd2,5e3c99","b35806,f1a340,fee0b6,d8daeb,998ec3,542788","b35806,f1a340,fee0b6,f7f7f7,d8daeb,998ec3,542788","b35806,e08214,fdb863,fee0b6,d8daeb,b2abd2,8073ac,542788","b35806,e08214,fdb863,fee0b6,f7f7f7,d8daeb,b2abd2,8073ac,542788","7f3b08,b35806,e08214,fdb863,fee0b6,d8daeb,b2abd2,8073ac,542788,2d004b","7f3b08,b35806,e08214,fdb863,fee0b6,f7f7f7,d8daeb,b2abd2,8073ac,542788,2d004b"]},{colorname:"RdBu",type:"div",colors:["ef8a62,67a9cf","ef8a62,f7f7f7,67a9cf","ca0020,f4a582,92c5de,0571b0","ca0020,f4a582,f7f7f7,92c5de,0571b0","b2182b,ef8a62,fddbc7,d1e5f0,67a9cf,2166ac","b2182b,ef8a62,fddbc7,f7f7f7,d1e5f0,67a9cf,2166ac","b2182b,d6604d,f4a582,fddbc7,d1e5f0,92c5de,4393c3,2166ac","b2182b,d6604d,f4a582,fddbc7,f7f7f7,d1e5f0,92c5de,4393c3,2166ac","67001f,b2182b,d6604d,f4a582,fddbc7,d1e5f0,92c5de,4393c3,2166ac,053061","67001f,b2182b,d6604d,f4a582,fddbc7,f7f7f7,d1e5f0,92c5de,4393c3,2166ac,053061"]},{colorname:"RdGy",type:"div",colors:["ef8a62,999999","ef8a62,ffffff,999999","ca0020,f4a582,bababa,404040","ca0020,f4a582,ffffff,bababa,404040","b2182b,ef8a62,fddbc7,e0e0e0,999999,4d4d4d","b2182b,ef8a62,fddbc7,ffffff,e0e0e0,999999,4d4d4d","b2182b,d6604d,f4a582,fddbc7,e0e0e0,bababa,878787,4d4d4d","b2182b,d6604d,f4a582,fddbc7,ffffff,e0e0e0,bababa,878787,4d4d4d","67001f,b2182b,d6604d,f4a582,fddbc7,e0e0e0,bababa,878787,4d4d4d,1a1a1a","67001f,b2182b,d6604d,f4a582,fddbc7,ffffff,e0e0e0,bababa,878787,4d4d4d,1a1a1a"]},{colorname:"RdYlBu",type:"div",colors:["fc8d59,91bfdb","fc8d59,ffffbf,91bfdb","d7191c,fdae61,abd9e9,2c7bb6","d7191c,fdae61,ffffbf,abd9e9,2c7bb6","d73027,fc8d59,fee090,e0f3f8,91bfdb,4575b4","d73027,fc8d59,fee090,ffffbf,e0f3f8,91bfdb,4575b4","d73027,f46d43,fdae61,fee090,e0f3f8,abd9e9,74add1,4575b4","d73027,f46d43,fdae61,fee090,ffffbf,e0f3f8,abd9e9,74add1,4575b4","a50026,d73027,f46d43,fdae61,fee090,e0f3f8,abd9e9,74add1,4575b4,313695","a50026,d73027,f46d43,fdae61,fee090,ffffbf,e0f3f8,abd9e9,74add1,4575b4,313695"]},{colorname:"RdYlGn",type:"div",colors:["fc8d59,91cf60","fc8d59,ffffbf,91cf60","d7191c,fdae61,a6d96a,1a9641","d7191c,fdae61,ffffbf,a6d96a,1a9641","d73027,fc8d59,fee08b,d9ef8b,91cf60,1a9850","d73027,fc8d59,fee08b,ffffbf,d9ef8b,91cf60,1a9850","d73027,f46d43,fdae61,fee08b,d9ef8b,a6d96a,66bd63,1a9850","d73027,f46d43,fdae61,fee08b,ffffbf,d9ef8b,a6d96a,66bd63,1a9850","a50026,d73027,f46d43,fdae61,fee08b,d9ef8b,a6d96a,66bd63,1a9850,006837","a50026,d73027,f46d43,fdae61,fee08b,ffffbf,d9ef8b,a6d96a,66bd63,1a9850,006837"]},{colorname:"Spectral",type:"div",colors:["fc8d59,99d594","fc8d59,ffffbf,99d594","d7191c,fdae61,abdda4,2b83ba","d7191c,fdae61,ffffbf,abdda4,2b83ba","d53e4f,fc8d59,fee08b,e6f598,99d594,3288bd","d53e4f,fc8d59,fee08b,ffffbf,e6f598,99d594,3288bd","d53e4f,f46d43,fdae61,fee08b,e6f598,abdda4,66c2a5,3288bd","d53e4f,f46d43,fdae61,fee08b,ffffbf,e6f598,abdda4,66c2a5,3288bd","9e0142,d53e4f,f46d43,fdae61,fee08b,e6f598,abdda4,66c2a5,3288bd,5e4fa2","9e0142,d53e4f,f46d43,fdae61,fee08b,ffffbf,e6f598,abdda4,66c2a5,3288bd,5e4fa2"]}],this.colorsets_seq=[{colorname:"Blues",type:"seq",colors:["deebf7,3182bd","deebf7,9ecae1,3182bd","eff3ff,bdd7e7,6baed6,2171b5","eff3ff,bdd7e7,6baed6,3182bd,08519c","eff3ff,c6dbef,9ecae1,6baed6,3182bd,08519c","eff3ff,c6dbef,9ecae1,6baed6,4292c6,2171b5,084594","f7fbff,deebf7,c6dbef,9ecae1,6baed6,4292c6,2171b5,084594","f7fbff,deebf7,c6dbef,9ecae1,6baed6,4292c6,2171b5,08519c,08306b"]},{colorname:"BuGn",type:"seq",colors:["e5f5f9,2ca25f","e5f5f9,99d8c9,2ca25f","edf8fb,b2e2e2,66c2a4,238b45","edf8fb,b2e2e2,66c2a4,2ca25f,006d2c","edf8fb,ccece6,99d8c9,66c2a4,2ca25f,006d2c","edf8fb,ccece6,99d8c9,66c2a4,41ae76,238b45,005824","f7fcfd,e5f5f9,ccece6,99d8c9,66c2a4,41ae76,238b45,005824","f7fcfd,e5f5f9,ccece6,99d8c9,66c2a4,41ae76,238b45,006d2c,00441b"]},{colorname:"BuPu",type:"seq",colors:["e0ecf4,8856a7","e0ecf4,9ebcda,8856a7","edf8fb,b3cde3,8c96c6,88419d","edf8fb,b3cde3,8c96c6,8856a7,810f7c","edf8fb,bfd3e6,9ebcda,8c96c6,8856a7,810f7c","edf8fb,bfd3e6,9ebcda,8c96c6,8c6bb1,88419d,6e016b","f7fcfd,e0ecf4,bfd3e6,9ebcda,8c96c6,8c6bb1,88419d,6e016b","f7fcfd,e0ecf4,bfd3e6,9ebcda,8c96c6,8c6bb1,88419d,810f7c,4d004b"]},{colorname:"GnBu",type:"seq",colors:["e0f3db,43a2ca","e0f3db,a8ddb5,43a2ca","f0f9e8,bae4bc,7bccc4,2b8cbe","f0f9e8,bae4bc,7bccc4,43a2ca,0868ac","f0f9e8,ccebc5,a8ddb5,7bccc4,43a2ca,0868ac","f0f9e8,ccebc5,a8ddb5,7bccc4,4eb3d3,2b8cbe,08589e","f7fcf0,e0f3db,ccebc5,a8ddb5,7bccc4,4eb3d3,2b8cbe,08589e","f7fcf0,e0f3db,ccebc5,a8ddb5,7bccc4,4eb3d3,2b8cbe,0868ac,084081"]},{colorname:"Greens",type:"seq",colors:["e5f5e0,31a354","e5f5e0,a1d99b,31a354","edf8e9,bae4b3,74c476,238b45","edf8e9,bae4b3,74c476,31a354,006d2c","edf8e9,c7e9c0,a1d99b,74c476,31a354,006d2c","edf8e9,c7e9c0,a1d99b,74c476,41ab5d,238b45,005a32","f7fcf5,e5f5e0,c7e9c0,a1d99b,74c476,41ab5d,238b45,005a32","f7fcf5,e5f5e0,c7e9c0,a1d99b,74c476,41ab5d,238b45,006d2c,00441b"]},{colorname:"Greys",type:"seq",colors:["f0f0f0,636363","f0f0f0,bdbdbd,636363","f7f7f7,cccccc,969696,525252","f7f7f7,cccccc,969696,636363,252525","f7f7f7,d9d9d9,bdbdbd,969696,636363,252525","f7f7f7,d9d9d9,bdbdbd,969696,737373,525252,252525","ffffff,f0f0f0,d9d9d9,bdbdbd,969696,737373,525252,252525","ffffff,f0f0f0,d9d9d9,bdbdbd,969696,737373,525252,252525,000000"]},{colorname:"Oranges",type:"seq",colors:["fee6ce,e6550d","fee6ce,fdae6b,e6550d","feedde,fdbe85,fd8d3c,d94701","feedde,fdbe85,fd8d3c,e6550d,a63603","feedde,fdd0a2,fdae6b,fd8d3c,e6550d,a63603","feedde,fdd0a2,fdae6b,fd8d3c,f16913,d94801,8c2d04","fff5eb,fee6ce,fdd0a2,fdae6b,fd8d3c,f16913,d94801,8c2d04","fff5eb,fee6ce,fdd0a2,fdae6b,fd8d3c,f16913,d94801,a63603,7f2704"]},{colorname:"OrRd",type:"seq",colors:["fee8c8,e34a33","fee8c8,fdbb84,e34a33","fef0d9,fdcc8a,fc8d59,d7301f","fef0d9,fdcc8a,fc8d59,e34a33,b30000","fef0d9,fdd49e,fdbb84,fc8d59,e34a33,b30000","fef0d9,fdd49e,fdbb84,fc8d59,ef6548,d7301f,990000","fff7ec,fee8c8,fdd49e,fdbb84,fc8d59,ef6548,d7301f,990000","fff7ec,fee8c8,fdd49e,fdbb84,fc8d59,ef6548,d7301f,b30000,7f0000"]},{colorname:"PuBu",type:"seq",colors:["ece7f2,2b8cbe","ece7f2,a6bddb,2b8cbe","f1eef6,bdc9e1,74a9cf,0570b0","f1eef6,bdc9e1,74a9cf,2b8cbe,045a8d","f1eef6,d0d1e6,a6bddb,74a9cf,2b8cbe,045a8d","f1eef6,d0d1e6,a6bddb,74a9cf,3690c0,0570b0,034e7b","fff7fb,ece7f2,d0d1e6,a6bddb,74a9cf,3690c0,0570b0,034e7b","fff7fb,ece7f2,d0d1e6,a6bddb,74a9cf,3690c0,0570b0,045a8d,023858"]},{colorname:"PuBuGn",type:"seq",colors:["ece2f0,1c9099","ece2f0,a6bddb,1c9099","f6eff7,bdc9e1,67a9cf,02818a","f6eff7,bdc9e1,67a9cf,1c9099,016c59","f6eff7,d0d1e6,a6bddb,67a9cf,1c9099,016c59","f6eff7,d0d1e6,a6bddb,67a9cf,3690c0,02818a,016450","fff7fb,ece2f0,d0d1e6,a6bddb,67a9cf,3690c0,02818a,016450","fff7fb,ece2f0,d0d1e6,a6bddb,67a9cf,3690c0,02818a,016c59,014636"]},{colorname:"PuRd",type:"seq",colors:["e7e1ef,dd1c77","e7e1ef,c994c7,dd1c77","f1eef6,d7b5d8,df65b0,ce1256","f1eef6,d7b5d8,df65b0,dd1c77,980043","f1eef6,d4b9da,c994c7,df65b0,dd1c77,980043","f1eef6,d4b9da,c994c7,df65b0,e7298a,ce1256,91003f","f7f4f9,e7e1ef,d4b9da,c994c7,df65b0,e7298a,ce1256,91003f","f7f4f9,e7e1ef,d4b9da,c994c7,df65b0,e7298a,ce1256,980043,67001f"]},{colorname:"Purples",type:"seq",colors:["efedf5,756bb1","efedf5,bcbddc,756bb1","f2f0f7,cbc9e2,9e9ac8,6a51a3","f2f0f7,cbc9e2,9e9ac8,756bb1,54278f","f2f0f7,dadaeb,bcbddc,9e9ac8,756bb1,54278f","f2f0f7,dadaeb,bcbddc,9e9ac8,807dba,6a51a3,4a1486","fcfbfd,efedf5,dadaeb,bcbddc,9e9ac8,807dba,6a51a3,4a1486","fcfbfd,efedf5,dadaeb,bcbddc,9e9ac8,807dba,6a51a3,54278f,3f007d"]},{colorname:"RdPu",type:"seq",colors:["fde0dd,c51b8a","fde0dd,fa9fb5,c51b8a","feebe2,fbb4b9,f768a1,ae017e","feebe2,fbb4b9,f768a1,c51b8a,7a0177","feebe2,fcc5c0,fa9fb5,f768a1,c51b8a,7a0177","feebe2,fcc5c0,fa9fb5,f768a1,dd3497,ae017e,7a0177","fff7f3,fde0dd,fcc5c0,fa9fb5,f768a1,dd3497,ae017e,7a0177","fff7f3,fde0dd,fcc5c0,fa9fb5,f768a1,dd3497,ae017e,7a0177,49006a"]},{colorname:"Reds",type:"seq",colors:["fee0d2,de2d26","fee0d2,fc9272,de2d26","fee5d9,fcae91,fb6a4a,cb181d","fee5d9,fcae91,fb6a4a,de2d26,a50f15","fee5d9,fcbba1,fc9272,fb6a4a,de2d26,a50f15","fee5d9,fcbba1,fc9272,fb6a4a,ef3b2c,cb181d,99000d","fff5f0,fee0d2,fcbba1,fc9272,fb6a4a,ef3b2c,cb181d,99000d","fff5f0,fee0d2,fcbba1,fc9272,fb6a4a,ef3b2c,cb181d,a50f15,67000d"]},{colorname:"YlGn",type:"seq",colors:["f7fcb9,31a354","f7fcb9,addd8e,31a354","ffffcc,c2e699,78c679,238443","ffffcc,c2e699,78c679,31a354,006837","ffffcc,d9f0a3,addd8e,78c679,31a354,006837","ffffcc,d9f0a3,addd8e,78c679,41ab5d,238443,005a32","ffffe5,f7fcb9,d9f0a3,addd8e,78c679,41ab5d,238443,005a32","ffffe5,f7fcb9,d9f0a3,addd8e,78c679,41ab5d,238443,006837,004529"]},{colorname:"YlGnBu",type:"seq",colors:["edf8b1,2c7fb8","edf8b1,7fcdbb,2c7fb8","ffffcc,a1dab4,41b6c4,225ea8","ffffcc,a1dab4,41b6c4,2c7fb8,253494","ffffcc,c7e9b4,7fcdbb,41b6c4,2c7fb8,253494","ffffcc,c7e9b4,7fcdbb,41b6c4,1d91c0,225ea8,0c2c84","ffffd9,edf8b1,c7e9b4,7fcdbb,41b6c4,1d91c0,225ea8,0c2c84","ffffd9,edf8b1,c7e9b4,7fcdbb,41b6c4,1d91c0,225ea8,253494,081d58"]},{colorname:"YlOrBr",type:"seq",colors:["fff7bc,d95f0e","fff7bc,fec44f,d95f0e","ffffd4,fed98e,fe9929,cc4c02","ffffd4,fed98e,fe9929,d95f0e,993404","ffffd4,fee391,fec44f,fe9929,d95f0e,993404","ffffd4,fee391,fec44f,fe9929,ec7014,cc4c02,8c2d04","ffffe5,fff7bc,fee391,fec44f,fe9929,ec7014,cc4c02,8c2d04","ffffe5,fff7bc,fee391,fec44f,fe9929,ec7014,cc4c02,993404,662506"]},{colorname:"YlOrRd",type:"seq",colors:["ffeda0,f03b20","ffeda0,feb24c,f03b20","ffffb2,fecc5c,fd8d3c,e31a1c","ffffb2,fecc5c,fd8d3c,f03b20,bd0026","ffffb2,fed976,feb24c,fd8d3c,f03b20,bd0026","ffffb2,fed976,feb24c,fd8d3c,fc4e2a,e31a1c,b10026","ffffcc,ffeda0,fed976,feb24c,fd8d3c,fc4e2a,e31a1c,b10026","ffffcc,ffeda0,fed976,feb24c,fd8d3c,fc4e2a,e31a1c,bd0026,800026"]}],this.colorsets_qual=[{colorname:"Accent",type:"qual",colors:["7fc97f,fdc086","7fc97f,beaed4,fdc086","7fc97f,beaed4,fdc086,ffff99","7fc97f,beaed4,fdc086,ffff99,386cb0","7fc97f,beaed4,fdc086,ffff99,386cb0,f0027f","7fc97f,beaed4,fdc086,ffff99,386cb0,f0027f,bf5b17","7fc97f,beaed4,fdc086,ffff99,386cb0,f0027f,bf5b17,666666"]},{colorname:"Dark2",type:"qual",colors:["1b9e77,7570b3","1b9e77,d95f02,7570b3","1b9e77,d95f02,7570b3,e7298a","1b9e77,d95f02,7570b3,e7298a,66a61e","1b9e77,d95f02,7570b3,e7298a,66a61e,e6ab02","1b9e77,d95f02,7570b3,e7298a,66a61e,e6ab02,a6761d","1b9e77,d95f02,7570b3,e7298a,66a61e,e6ab02,a6761d,666666"]},{colorname:"Paired",type:"qual",colors:["a6cee3,b2df8a","a6cee3,1f78b4,b2df8a","a6cee3,1f78b4,b2df8a,33a02c","a6cee3,1f78b4,b2df8a,33a02c,fb9a99","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00,cab2d6","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00,cab2d6,6a3d9a","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00,cab2d6,6a3d9a,ffff99","a6cee3,1f78b4,b2df8a,33a02c,fb9a99,e31a1c,fdbf6f,ff7f00,cab2d6,6a3d9a,ffff99,b15928"]},{colorname:"Pastel1",type:"qual",colors:["bb4ae,ccebc5","bb4ae,b3cde3,ccebc5","fbb4ae,b3cde3,ccebc5,decbe4","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6,ffffcc","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6,ffffcc,e5d8bd","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6,ffffcc,e5d8bd,fddaec","fbb4ae,b3cde3,ccebc5,decbe4,fed9a6,ffffcc,e5d8bd,fddaec,f2f2f2"]},{colorname:"Pastel2",type:"qual",colors:["b3e2cd,cbd5e8","b3e2cd,fdcdac,cbd5e8","b3e2cd,fdcdac,cbd5e8,f4cae4","b3e2cd,fdcdac,cbd5e8,f4cae4,e6f5c9","b3e2cd,fdcdac,cbd5e8,f4cae4,e6f5c9,fff2ae","b3e2cd,fdcdac,cbd5e8,f4cae4,e6f5c9,fff2ae,f1e2cc","b3e2cd,fdcdac,cbd5e8,f4cae4,e6f5c9,fff2ae,f1e2cc,cccccc"]},{colorname:"Set1",type:"qual",colors:["e41a1c,4daf4a","e41a1c,377eb8,4daf4a","e41a1c,377eb8,4daf4a,984ea3","e41a1c,377eb8,4daf4a,984ea3,ff7f00","e41a1c,377eb8,4daf4a,984ea3,ff7f00,ffff33","e41a1c,377eb8,4daf4a,984ea3,ff7f00,ffff33,a65628","e41a1c,377eb8,4daf4a,984ea3,ff7f00,ffff33,a65628,f781bf","e41a1c,377eb8,4daf4a,984ea3,ff7f00,ffff33,a65628,f781bf,999999"]},{colorname:"Set2",type:"qual",colors:["66c2a5,8da0cb","66c2a5,fc8d62,8da0cb","66c2a5,fc8d62,8da0cb,e78ac3","66c2a5,fc8d62,8da0cb,e78ac3,a6d854","66c2a5,fc8d62,8da0cb,e78ac3,a6d854,ffd92f","66c2a5,fc8d62,8da0cb,e78ac3,a6d854,ffd92f,e5c494","66c2a5,fc8d62,8da0cb,e78ac3,a6d854,ffd92f,e5c494,b3b3b3"]},{colorname:"Set3",type:"qual",colors:["8dd3c7,bebada","8dd3c7,ffffb3,bebada","8dd3c7,ffffb3,bebada,fb8072","8dd3c7,ffffb3,bebada,fb8072,80b1d3","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5,d9d9d9","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5,d9d9d9,bc80bd","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5,d9d9d9,bc80bd,ccebc5","8dd3c7,ffffb3,bebada,fb8072,80b1d3,fdb462,b3de69,fccde5,d9d9d9,bc80bd,ccebc5,ffed6f"]}]},_getColors:function(e,t,i){var n=null;return n="div"==e?this.colorsets_div[t].colors[i]:"qual"==e?this.colorsets_qual[t].colors[i]:this.colorsets_seq[t].colors[i]},_visibilityOn:function(){this.element.show()},_visibilityOff:function(){this.element.hide()},_createColorDialog:function(){var e=this;e.dialog=Oskari.clazz.create("Oskari.userinterface.component.Popup"),e.content=e.templateContent.clone();var t=jQuery('<div class="colorset_sotka"><br>'+this._locale.colorset.setselection+'<br><select id="colo_set"></select><br></div>');e.content.append(t);var i=t.find("select"),n=jQuery('<option value="seq">'+this._locale.colorset.sequential+"</option>");i.append(n);var n=jQuery('<option value="qual">'+this._locale.colorset.qualitative+"</option>");i.append(n);var n=jQuery('<option value="div">'+this._locale.colorset.divergent+"</option>");i.append(n),i.change(function(){e._colorTableChanged()}),i.attr("value",e.currentColorSet),e.content.append(i);var s=e.templateInstructions2.clone();s.append(this._locale.colorset.info2),e.content.append(s),e.content.append(e._createColorTable()),e._hiliSelectedColors();var a=e.dialog.createCloseButton(this._locale.colorset.cancel);a.addClass("primary"),e.dialog.addClass("tools_selection"),e.dialog.show(this._locale.colorset.themeselection,e.content,[a])},_createColorTable:function(){var e=this,t=jQuery('<table class="colo_table1"></table>'),i=5,n=null,s=3;"div"==e.currentColorSet?(i=this.colorsets_div.length,n=e.colorsets_div):"qual"==e.currentColorSet?(i=e.colorsets_qual.length,n=this.colorsets_qual):(i=e.colorsets_seq.length,n=e.colorsets_seq);for(var a=5,r=jQuery("<tbody></tbody>"),o=0;i>o;o++){var l=jQuery("<td></td>");l.attr("data-colorIdx",o);for(var u=n[o].colors[s],c=u.split(","),h=jQuery("<div></div>"),d=0;a>d;d++){var p=h.clone();p.css("background-color","#"+c[d]),l.append(p)}l.mouseover(function(){jQuery(this).hasClass("selected")||jQuery(this).addClass("hover")}),l.mouseout(function(){jQuery(this).removeClass("hover")}),l.click(function(){var t=jQuery(this).attr("data-colorIdx");e._selectedColors(t)}),r.append(l)}return t.append(r),t},_selectedColors:function(e){var t=this;t.colorsetIndex=e,t._hiliSelectedColors(),t.currentColorSet=t.content.find("select#colo_set").val(),t.classifyData()},_hiliSelectedColors:function(){var e=this;if(e.content){var t=0;t="div"==e.currentColorSet?e.colorsets_div.length:"qual"==e.currentColorSet?e.colorsets_qual.length:e.colorsets_seq.length,e.content.find("td").removeClass("selected"),e.content.find("td[data-colorIdx="+e.colorsetIndex.toString()+"]").addClass("selected")}},_hoverZoomColorTable:function(e){var t=e.clone();t.find("div").width("18px");var i=jQuery('<table class="table_temp"></table>'),n=jQuery("<tbody></tbody>");n.append(t),i.append(n);var s=jQuery('<div id="pop-up_06052013">  </div>');s.append(i),e.append(s),s.hide(),e.hover(function(){jQuery(this).find("div#pop-up_06052013").fadeIn("slow")},function(){jQuery(this).find("div#pop-up_06052013").fadeOut("slow")
})},_colorTableChanged:function(){var e=this;if(e.content){e.currentColorSet=e.content.find("select#colo_set").val(),e.content.find(".colo_table1").remove();var t=e._createColorTable(),i=5,n=2,s=9;"div"==e.currentColorSet?(i=this.colorsets_div.length,s=11):"qual"==e.currentColorSet?(i=e.colorsets_qual.length,s=8):i=e.colorsets_seq.length,e.colorsetIndex>i&&(e.colorsetIndex=i-1);var a=Number(e.element.find(".classificationMethod").find(".classCount").find("#amount_class").val());a>s&&(a=s,e.element.find(".classificationMethod").find(".classCount").find("#amount_class").attr("value",s));var r=e.element.find(".classificationMethod").find(".classCount");r.find("#slider-range-max").remove();var o=jQuery('<div id="slider-range-max"></div>');r.append(o),r.find("#slider-range-max").slider({range:"min",min:n,max:s,value:a,slide:function(t,i){jQuery("input#amount_class").val(i.value),jQuery(this).slider("option","value",i.value),e.classifyData()}}),e.content.find(".instructions2").append(t),e._hiliSelectedColors()}},_flipCurrentColors:function(){this.colorsFlipped=this.colorsFlipped?!1:!0,this.classifyData()},_adjustClassificationSlider:function(e){var t=jQuery("#slider-range-max"),i=t.slider("option","value"),n=e<this.maxClassNum?e>2?e:3:this.maxClassNum;return n--,i=n>i?i>2?i:2:n,t.slider("option","min",2),t.slider("option","max",n),t.slider("option","value",i),3>n?t.slider("option","disabled",!0):t.slider("option","disabled",!1),jQuery("input#amount_class").val(i),t}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.plugin.ManageStatsPlugin",function(e,t){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._layer=null,this._state=null,this.element=void 0,this.statsService=null,this.indicators=[],this.selectedMunicipalities={},defaults={statistics:[{id:"avg",visible:!0},{id:"max",visible:!0},{id:"min",visible:!0},{id:"mde",visible:!0},{id:"mdn",visible:!0},{id:"std",visible:!0},{id:"sum",visible:!0}]},this.conf=jQuery.extend(!0,e,defaults),this._locale=t||{},this.templates={csvButton:'<button class="statsgrid-csv-button">csv</button>',statsgridTotalsVar:'<span class="statsgrid-variable"></span>',subHeader:'<span class="statsgrid-grid-subheader"></span>',gridHeaderMenu:'<li><input type="checkbox" /><label></label></li>',groupingHeader:'<span style="color:green"></span>',toolbarButton:'<button class="statsgrid-select-municipalities"></button>',filterPopup:'<div class="indicator-filter-popup"><p class="filter-desc"></p><div class="filter-container"></div></div>',filterRow:'<div class="filter-row"><div class="filter-label"></div><div class="filter-value"></div></div>',filterSelect:'<div><select class="filter-select"></select><div class="filter-inputs-container"></div></div>',filterOption:"<option></option>",filterInputs:'<input type="text" class="filter-input filter-input1" /><span class="filter-between" style="display:none;">-</span><input type="text" class="filter-input filter-input2" style="display:none;" />',filterLink:'<a href="javascript:void(0);"></a>'}},{__name:"ManageStatsPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,e&&(this.pluginName=e.getName()+this.__name)},register:function(){},unregister:function(){},init:function(){},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.statsService=e.getService("Oskari.statistics.bundle.statsgrid.StatisticsService"),this._published=this.conf.published||!1,this._state=this.conf.state||{},this._layer=this.conf.layer||null,this.selectMunicipalitiesMode=!1},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this.element&&(this.element.remove(),this.element=void 0,delete this.element)},eventHandlers:{"MapStats.FeatureHighlightedEvent":function(e){this.selectMunicipalitiesMode?this._featureSelectedEvent(e):this._featureHighlightedEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},getLayer:function(){return this._layer},setLayer:function(e){this._layer=e},setState:function(e){this._state=e},createStatsOut:function(e){this.prepareIndicatorParams(e),e.on("keyup",function(e){e.stopPropagation()}),e.on("keydown",function(e){e.stopPropagation()})},prepareIndicatorParams:function(e){if(!this._published){e.find("selectors-container").remove();var t=jQuery('<div class="selectors-container"></div>');e.append(t);var i=this;if(i.conf.csvDownload){var n=jQuery(i.templates.csvButton);t.append(n),n.click(function(){if(i.dataView){var e=i.dataView.getItems();i.downloadJSON2CSV(e)}})}this.getSotkaIndicators(e)}this.getSotkaRegionData(e)},getSotkaRegionData:function(e){var t=this;t.statsService.fetchStatsData(t._sandbox.getAjaxUrl()+"action_route=GetSotkaData&action=regions&version=1.1",function(i){i?(t.createMunicipalitySlickGrid(e,i),t._state&&t.loadStateIndicators(t._state,e)):t.showMessage(t._locale.sotka.errorTitle,t._locale.sotka.regionDataError)},function(){t.showMessage(t._locale.sotka.errorTitle,t._locale.sotka.regionDataXHRError)})},createMunicipalitySlickGrid:function(e,t){var i,n=this,s=jQuery('<div id="municipalGrid" class="municipal-grid"></div>');e.find(".municipal-grid").remove(),e.append(s);var a=new Slick.CheckboxSelectColumn2({cssClass:"slick-cell-checkboxsel"});this.checkboxSelector=a;for(var r=[n.checkboxSelector.getColumnDefinition(),{id:"municipality",name:this._locale.sotka.municipality,field:"municipality",sortable:!0},{id:"code",name:this._locale.sotka.code,field:"code"}],o={enableCellNavigation:!0,enableColumnReorder:!0,multiColumnSort:!0,showHeaderRow:!0,headerRowHeight:97},l=[],u=0,c=0;c<t.length;c++){var h=t[c];"KUNTA"==h.category&&(l[u]={id:h.id,code:h.code,municipality:h.title[Oskari.getLang()],sel:"checked"},u++)}var d=new Slick.Data.GroupItemMetadataProvider;dataView=new Slick.Data.DataView({groupItemMetadataProvider:d,inlineFilters:!0}),dataView.onRowsChanged.subscribe(function(e,t){i.invalidateRows(t.rows),i.render()}),dataView.setGrouping({getter:"sel",comparer:function(e,t){return"checked"==e.groupingKey&&e.groupingKey==t.groupingKey?0:e.groupingKey<t.groupingKey?1:-1},formatter:function(e){var t=("checked"==e.groupingKey?n._locale.municipality:n._locale.not_included)+" ("+e.count+")";return"<span style='color:green'>"+t+"</span>"},aggregateCollapsed:!1}),i=new Slick.Grid(s,dataView,r,o),i.onSort.subscribe(function(e,t){var n=jQuery(e.target);if(!n.hasClass("slick-header-menubutton")){var s=t.sortCols;dataView.sort(function(e,t){for(var i=0,n=s.length;n>i;i++){var a=s[i].sortCol.field,r=s[i].sortAsc?1:-1,o=e[a],l=t[a];if(null==o)return 1;if(null==l)return-1;var u=(o==l?0:o>l?1:-1)*r;if(0!=u)return u}return 0}),i.invalidate(),i.render()}}),i.onHeaderClick.subscribe(function(e,t){return t.column.id===n._state.currentColumn?!1:(n.sendStatsData(t.column),void 0)}),i.onHeaderRowCellRendered.subscribe(function(e,t){jQuery(t.node).empty(),jQuery(n.templates.subHeader).appendTo(t.node)}),i.onColumnsReordered.subscribe(function(){n.dataView.refresh()}),i.registerPlugin(a),i.registerPlugin(d),a.onSelectRowClicked.subscribe(function(e,t){var i=t.grid.getData(),s=i.getItem(t.row),a=i.getGroups().length;if(s.sel=jQuery(e.target).is(":checked")?"checked":"empty",i.updateItem(s.id,s),groups=i.getGroups(),groups.length>1)for(var r=0;r<groups.length;r++){var o=groups[r];"empty"==o.groupingKey&&o.count<2&&1==a&&i.collapseGroup("empty")}var l=n._getColumnById(n._state.currentColumn);n.sendStatsData(l),t.grid.setColumns(t.grid.getColumns()),i.refresh()}),a.onSelectHeaderRowClicked.subscribe(function(){var e=n._getColumnById(n._state.currentColumn);n.sendStatsData(e)}),n._initHeaderPlugin(r,i),dataView.beginUpdate(),dataView.setItems(l),dataView.endUpdate(),i.invalidate(),i.render(),n.grid=i,n.dataView=dataView,n.setGridHeight();var p;jQuery(window).resize(function(){clearTimeout(p),p=setTimeout(function(){n.setGridHeight()},100)})},setGridHeight:function(){var e=jQuery("#municipalGrid"),t=e.parent(),i=t.find(".selectors-container"),n=0;i.length>0&&(n=i.outerHeight()),e.height(t.height()-n),this.grid.resizeCanvas()},getIdxByCode:function(e){var t,i=this.dataView?this.dataView.getItems():[],n=null;for(t=0;t<i.length;++t)if(i[t].code===e){n=i[t];break}if(n){var s=this.dataView.getRowById(n.id);return s?s:-1}return null},getItemByCode:function(e){var t,i=this.dataView?this.dataView.getItems():[],n=null;for(t=0;t<i.length;++t)if(i[t].code===e){n=i[t];break}return n?this.dataView.getItemById(n.id):null},getSotkaIndicators:function(e){var t=this,i=t._sandbox;t.statsService.fetchStatsData(i.getAjaxUrl()+"action_route=GetSotkaData&action=indicators&version=1.1",function(i){i?t.createIndicatorsSelect(e,i):t.showMessage(t._locale.sotka.errorTitle,t._locale.sotka.indicatorsDataError)},function(){t.showMessage(t._locale.sotka.errorTitle,t._locale.sotka.indicatorsDataXHRError)})},createIndicatorsSelect:function(e,t){for(var i=this,n=jQuery('<div class="indicator-cont"><div class="indisel selector-cont"><label for="indi">'+this._locale.indicators+'</label><select id="indi" name="indi" class="indi"><option value="" selected="selected"></option></select></div></div>'),s=n.find("select"),a=0;a<t.length;a++){var r=t[a];for(var o in r)if("id"==o){var l=r[o],u=r.title[Oskari.getLang()],c=jQuery('<option value="'+l+'">'+u+"</option>");s.append(c),t[a].titlename=u}}s.change(function(){var t=s.find("option:selected").val();i.deleteIndicatorInfoButton(e),i.deleteDemographicsSelect(e),i.getSotkaIndicatorMeta(e,t)}),e.find(".selectors-container").append(n),s.chosen({no_results_text:this._locale.noMatch,placeholder_text:this._locale.selectIndicator}),jQuery(".chzn-drop").css("width","298px"),jQuery(".chzn-search input").css("width","263px")},getSotkaIndicatorMeta:function(e,t){var i=this,n=i._sandbox;i.statsService.fetchStatsData(n.getAjaxUrl()+"action_route=GetSotkaData&action=indicator_metadata&indicator="+t+"&version=1.1",function(t){t?(i.createIndicatorInfoButton(e,t),i.createDemographicsSelects(e,t)):i.showMessage(i._locale.sotka.errorTitle,i._locale.sotka.indicatorMetaError)},function(){i.showMessage(i._locale.sotka.errorTitle,i._locale.sotka.indicatorMetaXHRError)})},createIndicatorInfoButton:function(e,t){var i=this,n=jQuery('<div class="icon-info"></div>'),s=e.find(".indicator-cont");s.find(".icon-info").remove(),s.append(n),n.click(function(){var e=Oskari.getLang(),n='<h4 class="indicator-msg-popup">'+i._locale.sotka.descriptionTitle+"</h4><p>"+t.description[e]+'</p><br/><h4 class="indicator-msg-popup">'+i._locale.sotka.sourceTitle+"</h4><p>"+t.organization.title[e]+"</p>";i.showMessage(t.title[e],n)})},deleteIndicatorInfoButton:function(e){e.find(".indicator-cont").find(".icon-info").remove()},createDemographicsSelects:function(e,t){var i=this;this.indicators.push(t);var n=e.find(".selectors-container"),s=jQuery('<div class="parameters-cont"></div>'),a=null,r=null;null!=t.range&&(s.append(this.getYearSelectorHTML(t.range.start,t.range.end)),a=t.range.end),null!=t.classifications&&null!=t.classifications.sex&&(s.append(this.getGenderSelectorHTML(t.classifications.sex.values)),r=t.classifications.sex.values[t.classifications.sex.values.length-1]),r=null!=r?r:"total";var o=i._getIndicatorColumnId(t.id,r,a),l=this.isIndicatorInGrid(o),u=jQuery('<button class="fetch-data'+(l?" hidden":"")+'">'+this._locale.addColumn+"</button>"),c=jQuery('<button class="remove-data'+(l?"":" hidden")+'">'+this._locale.removeColumn+"</button>");s.append(u),s.append(c),n.find(".parameters-cont").remove(),n.append(s),u.click(function(n){jQuery(n.currentTarget);var s=jQuery(".statsgrid").find(".yearsel").find(".year").val(),a=jQuery(".statsgrid").find(".gendersel").find(".gender").val();a=null!=a?a:"total",i._getIndicatorColumnId(t.id,a,s),i.getSotkaIndicatorData(e,t.id,a,s)}),c.click(function(){var e=jQuery(".statsgrid").find(".yearsel").find(".year").val(),n=jQuery(".statsgrid").find(".gendersel").find(".gender").val();n=null!=n?n:"total",i._getIndicatorColumnId(t.id,n,e),i.removeIndicatorDataFromGrid(t.id,n,e)})},deleteDemographicsSelect:function(e){e.find(".parameters-cont").remove()},updateDemographicsButtons:function(e,t,i){e=e?e:jQuery(".statsgrid").find(".indisel ").find("option:selected").val(),t=t?t:jQuery(".statsgrid").find(".gendersel").find(".gender").val(),t=null!=t?t:"total",i=i?i:jQuery(".statsgrid").find(".yearsel").find(".year").val();var n="indicator"+e+i+t,s=this.isIndicatorInGrid(n);s?(jQuery(".statsgrid").find(".fetch-data").addClass("hidden"),jQuery(".statsgrid").find(".remove-data").removeClass("hidden")):(jQuery(".statsgrid").find(".fetch-data").removeClass("hidden"),jQuery(".statsgrid").find(".remove-data").addClass("hidden"))},isIndicatorInGrid:function(e){for(var t=this.grid.getColumns(),i=0,n=t.length;n>i;i++)if(e===t[i].id)return!0;return!1},getSotkaIndicatorData:function(e,t,i,n){var s=this,a=null!=i?i:"total";s.statsService.fetchStatsData(s._sandbox.getAjaxUrl()+"action_route=GetSotkaData&action=data&version=1.0&indicator="+t+"&years="+n+"&genders="+a,function(i){i?(null==s._state.indicators&&(s._state.indicators=[]),s._state.indicators.push({indicator:t,year:n,gender:a}),s.addIndicatorDataToGrid(e,t,a,n,i,s.indicators[s.indicators.length-1])):s.showMessage(s._locale.sotka.errorTitle,s._locale.sotka.indicatorDataError)},function(){s.showMessage(s._locale.sotka.errorTitle,s._locale.sotka.indicatorDataXHRError)})},_getIndicatorColumnId:function(e,t,i){var n="indicator"+e+i+t;return n},addIndicatorDataToGrid:function(e,t,i,n,s,a,r){var o=this,l=o._getIndicatorColumnId(t,i,n),u=o.grid.getColumns(),c=a.title[Oskari.getLang()],l="indicator"+t+n+i;if(o.isIndicatorInGrid(l))return!1;var h=c+"/"+n+"/"+i;u.push({id:l,name:h,field:l,toolTip:h,sortable:!0,header:{menu:{items:[{element:jQuery(o.templates.filterLink).text(o._locale.filter),command:"filter",actionType:"link"}]},icon:"icon-funnel"},groupTotalsFormatter:function(e,t){var i="";valueCount=0;for(var n=e.group.rows,s=0;s<n.length;s++){var a=n[s];null!=a[t.field]&&valueCount++}return i=valueCount+" "+o._locale.values}}),o.grid.setColumns(u);var d=0;o.dataView.beginUpdate();for(var p=0;p<s.length;p++){var f=s[p],m="",g="";for(var y in f)"region"==y?m=f[y]:"primary value"==y&&(g=f[y],g=g.replace(",","."));if(m){var v=o.dataView.getItemById(m);v&&(v[l]=Number(g),o.dataView.updateItem(v.id,v)),d++}}for(var b=o.dataView.getItems(),p=b.length-1;p>=0;p--){var v=b[p];null==v[l]&&(v[l]=null)}for(var _=[],p=0;p<u.length;p++){var w=u[p].id;_.push(new Slick.Data.Aggregators.Avg(w)),_.push(new Slick.Data.Aggregators.Std(w)),_.push(new Slick.Data.Aggregators.Mdn(w)),_.push(new Slick.Data.Aggregators.Mde(w)),_.push(new Slick.Data.Aggregators.Sum(w)),_.push(new Slick.Data.Aggregators.Max(w)),_.push(new Slick.Data.Aggregators.Min(w))}o.dataView.setAggregators(_,!0),o.dataView.setTotalsCallback(function(e){o._updateTotals(e)}),o.dataView.endUpdate(),o.dataView.refresh(),o.grid.invalidateAllRows(),o.grid.render(),1!=r&&o.sendStatsData(u[u.length-1]),o.updateDemographicsButtons(t,i,n),o.grid.setSortColumn(o._state.currentColumn,!0)},removeIndicatorDataFromGrid:function(e,t,i){var n=this._getIndicatorColumnId(e,t,i),s=this.grid.getColumns(),a=[],r=!1,o=0,l=0,u=0;for(o=0,l=s.length,u=0;l>o;o++)n===s[o].id?r=!0:(a[u]=s[o],u++);if(r&&(this.grid.setColumns(a),this.grid.render(),this.dataView.refresh()),this._state.indicators)for(o=0,l=this._state.indicators.length;l>o;o++){var c=this._state.indicators[o];if(e===c.indicator&&i===c.year&&t===c.gender){this._state.indicators.splice(o,1);break}}this.updateDemographicsButtons(e,t,i),n===this._state.currentColumn&&(this._setLayerVisibility(!1),this._state.currentColumn=null)},getYearSelectorHTML:function(e,t){for(var i=this,n=jQuery('<div class="yearsel selector-cont"><label for="year">'+this._locale.year+'</label><select name="year" class="year"></select></div>'),s=n.find("select"),a=e;t>=a;a++){var r=jQuery('<option value="'+a+'">'+a+"</option>");s.append(r)}return s.val(t),s.change(function(e){i.updateDemographicsButtons(null,null,e.target.value)}),n},getGenderSelectorHTML:function(e){for(var t=this,i=jQuery('<div class="gendersel selector-cont"><label for="gender">'+this._locale.gender+'</label><select name="gender" class="gender"></select></div>'),n=i.find("select"),s=0;s<e.length;s++){var a=jQuery('<option value="'+e[s]+'">'+this._locale.genders[e[s]]+"</option>");n.append(a)}return n.val(e[e.length-1]),n.change(function(e){t.updateDemographicsButtons(null,e.target.value,null)}),i},sendStatsData:function(e){if(!(null==e||e.field.indexOf("indicator")<0)){var t,i=this,n=[],s=[],a=i._state.municipalities=[];i._state.currentColumn=e.id;var r=this.dataView.getItems();for(t=0;t<r.length;t++){var o=r[t];"checked"==o.sel&&(a.push(o.id),null!=o[e.field]&&(n.push(o[e.field]),s.push(o.code)))}i.statsService.sendStatsData(i._layer,{CHECKED_COUNT:this.getItemsByGroupingKey("checked").length,CUR_COL:e,VIS_NAME:i._layer.getWmsName(),VIS_ATTR:i._layer.getFilterPropertyName(),VIS_CODES:s,COL_VALUES:n}),this._setLayerVisibility(!0)}},_setLayerVisibility:function(e){if(this._layer._visible!==e){var t=this._sandbox,i=t.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest");if(i){var n=i(this._layer.getId(),e);t.request(this,n)}}},getSotkaIndicatorsMeta:function(e,t,i){var n=this,s=0;n.indicators=[];for(var a=0;a<t.length;a++){var r=t[a],o=r.indicator;n.statsService.fetchStatsData(n._sandbox.getAjaxUrl()+"action_route=GetSotkaData&action=indicator_metadata&indicator="+o+"&version=1.1",function(e){if(s++,e){for(var a=0;a<t.length;a++)t[a].indicator==e.id&&(n.indicators[a]=e);s>=t.length&&i()}else n.showMessage(n._locale.sotka.errorTitle,n._locale.sotka.indicatorDataError)},function(){n.showMessage(n._locale.sotka.errorTitle,n._locale.sotka.indicatorDataXHRError),s++})}},getSotkaIndicatorsData:function(e,t,i){for(var n=this,s=0,a={},r=0;r<t.length;r++){var o=t[r],l=o.indicator,u=o.year,c=null!=o.gender?o.gender:"total";n.statsService.fetchStatsData(n._sandbox.getAjaxUrl()+"action_route=GetSotkaData&action=data&version=1.0&indicator="+l+"&years="+u+"&genders="+c,function(r){if(s++,r){for(var o=0;o<t.length;o++){var l=t[o];if(l.indicator==r[0].indicator&&l.year==r[0].year&&l.gender==r[0].gender){var u=n._getIndicatorColumnId(l.indicator,l.gender,l.year);a[u]=r}}if(s>=t.length){for(var o=0;o<t.length;o++){var l=t[o];if(l){var u=n._getIndicatorColumnId(l.indicator,l.gender,l.year),c=a[u];n.addIndicatorDataToGrid(e,l.indicator,l.gender,l.year,c,n.indicators[o],!0)}}i()}}else n.showMessage(n._locale.sotka.errorTitle,n._locale.sotka.indicatorDataError)},function(){n.showMessage(n._locale.sotka.errorTitle,n._locale.sotka.indicatorDataXHRError),s++})}},clearDataFromGrid:function(){if(this.grid){for(var e=this.grid.getColumns(),t=[],i=0,n=0;n<e.length;n++){var s=e[n].id;("id"==s||"municipality"==s||"code"==s||"_checkbox_selector"==s)&&(t[i]=e[n],i++)}this.grid.setColumns(t),this.grid.render(),this.dataView.refresh()}},showMessage:function(e,t,i){if(!this._published){var n=this._locale,s=Oskari.clazz.create("Oskari.userinterface.component.Popup");if(i)s.show(e,t,i);else{var a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(n.buttons.ok),a.addClass("primary"),a.setHandler(function(){s.close(!0)}),s.show(e,t,[a])}}},loadStateIndicators:function(e,t){var i=this,n=this._sandbox.findRegisteredModuleInstance("MainMapModuleManageClassificationPlugin");i.clearDataFromGrid(),e.indicators&&e.indicators.length>0&&i.getSotkaIndicatorsMeta(t,e.indicators,function(){i.getSotkaIndicatorsData(t,e.indicators,function(){if(null!=e.currentColumn){if(n){if(e.colors&&(n.currentColorSet=e.colors.set,n.colorsetIndex=e.colors.index,n.colorsFlipped=e.colors.flipped),null!=e.methodId&&e.methodId>0){var t=n.element.find(".classificationMethod").find(".method");if(t.val(e.methodId),4==e.methodId&&e.manualBreaksInput){var s=n.element.find(".manualBreaks").find("input[name=breaksInput]");s.val(e.manualBreaksInput),n.element.find(".classCount").hide(),n.element.find(".manualBreaks").show()}}if(null!=e.numberOfClasses&&e.numberOfClasses>0){var a=n.rangeSlider;null!=a&&(a.slider("value",e.numberOfClasses),a.parent().find("input#amount_class").val(e.numberOfClasses))}}e.municipalities&&i._showSelectedAreas(e.municipalities);var r=i._getColumnById(e.currentColumn);i.sendStatsData(r),i.grid.setSortColumn(e.currentColumn,!0)}})})},_updateTotals:function(e){if(e)for(var t=this.grid.getColumns(),i=0;i<t.length;i++){var n=t[i],s=e[0];for(var a in e)g=e[a],"checked"==g.groupingKey&&(s=g);for(var r=s.totals,o=jQuery(this.templates.subHeader),l=0,u=0;u<this.conf.statistics.length;u++){var c=this.conf.statistics[u];c.visible&&(o.append(this._getStatistic(r,n.id,c.id)),l++)}var h=jQuery(this.grid.getHeaderRowColumn(n.id)).empty(),d=this.grid.getOptions(),p=h.css("line-height");p=p?p.split("px")[0]:12,d.headerRowHeight=l*p+7,this.grid.setOptions(d),o.appendTo(h)}},_getStatistic:function(e,t,i){var n={},s=null,a=e[i];for(indicatorId in a){if(n[indicatorId]||(n[indicatorId]={}),indicatorId.indexOf("indicator")>=0&&indicatorId==t){n[indicatorId][i]=a[indicatorId];var s=jQuery(this.templates.statsgridTotalsVar),r=n[t][i];this._isInt(r)||(r=r.toFixed(2)),s.addClass("statsgrid-"+i).text(r);break}if("municipality"==t){var s=jQuery(this.templates.statsgridTotalsVar);s.addClass("statsgrid-totals-label").text(this._locale.statistic[i]);break}}return s},_isInt:function(e){return 0===e%1},_initHeaderPlugin:function(e,t){for(var i=this,n=0;n<e.length;n++){var s=e[n];"municipality"==s.id&&(s.header={menu:{items:[]}})}var a=new Slick.Plugins.HeaderMenu2({});a.onBeforeMenuShow.subscribe(function(e,t){var n=t.menu;if("municipality"==t.column.id){n.items=[];for(var s=0;s<i.conf.statistics.length;s++){var a=i.conf.statistics[s],r=jQuery(i.templates.gridHeaderMenu).addClass("statsgrid-show-total-selects"),o=r.find("input").attr({id:"statistics_"+a.id});a.visible&&o.attr({checked:"checked"}),r.find("label").attr("for","statistics_"+a.id).text(i._locale.statistic[a.id]),n.items.push({element:r,command:a.id})}for(var l=t.grid.getColumns(),u=!1,s=0;s<l.length;s++){var c=l[s];"sel"==c.field&&(u=!0)}var h=jQuery(i.templates.gridHeaderMenu).addClass("statsgrid-show-row-selects"),o=h.find("input").attr({id:"statsgrid-show-row-selects"});u&&o.attr("checked","checked"),h.find("label").attr("for","statsgrid-show-row-selects").text(i._locale.selectRows),n.items.push({element:h,command:"selectRows"})}}),a.onCommand.subscribe(function(e,t){if("selectRows"==t.command){for(var n=t.grid.getColumns(),s=[],a=!0,r=0;r<n.length;r++){var o=n[r];"sel"!=o.field&&s.push(o),"sel"!=o.field||jQuery(e.target).is(":checked")||(a=!1)}a&&s.unshift(i.checkboxSelector.getColumnDefinition()),t.grid.setColumns(s)}else if("filter"==t.command)i._createFilterPopup(t.column,this);else{for(var r=0;r<i.conf.statistics.length;r++){var l=i.conf.statistics[r];if(l.id==t.command){l.visible=!l.visible;break}}i.dataView.refresh(),i.grid.setColumns(i.grid.getColumns()),i.dataView.refresh()}}),t.registerPlugin(a)},_createFilterPopup:function(e,t){var i=this,n=jQuery(i.templates.filterPopup);n.find(".filter-desc").text(i._locale.indicatorFilterDesc);var s=jQuery(i.templates.filterRow);s.find(".filter-label").text(i._locale.filterIndicator),s.find(".filter-value").text(e.name),n.find(".filter-container").append(s);var a=jQuery(i.templates.filterRow);a.find(".filter-label").text(i._locale.filterCondition);var r=jQuery(i.templates.filterSelect),o=r.find(".filter-select");o.append(jQuery(i.templates.filterOption).val("").text(i._locale.filterSelectCondition)),o.append(jQuery(i.templates.filterOption).val(">").text(i._locale.filterGT)),o.append(jQuery(i.templates.filterOption).val(">=").text(i._locale.filterGTOE)),o.append(jQuery(i.templates.filterOption).val("=").text(i._locale.filterE)),o.append(jQuery(i.templates.filterOption).val("<=").text(i._locale.filterLTOE)),o.append(jQuery(i.templates.filterOption).val("<").text(i._locale.filterLT)),o.append(jQuery(i.templates.filterOption).val("...").text(i._locale.filterBetween)),a.find(".filter-value").append(r),o.change(function(e){var t=jQuery(e.target),i=t.val(),n=t.parents(".filter-value");"..."==i?(n.find(".filter-between").css("display","block"),n.find(".filter-input2").css("display","block")):(n.find(".filter-input2").css("display","none"),n.find(".filter-between").css("display","none"))}),n.find(".filter-container").append(a);var l=jQuery(i.templates.filterInputs);n.find(".filter-inputs-container").append(l);var u=Oskari.clazz.create("Oskari.userinterface.component.Popup"),c=Oskari.clazz.create("Oskari.userinterface.component.Button");c.setTitle(i._locale.buttons.cancel),c.setHandler(function(){n.off(),t.hide(),u.close(!0)});var h=Oskari.clazz.create("Oskari.userinterface.component.Button");h.setTitle(i._locale.buttons.filter),h.addClass("primary"),h.setHandler(function(s){var a=[],r=jQuery(s.target).parents(".divmanazerpopup"),l=r.find(".filter-input1");if(a.push(l.val()),"..."==o.val()){var c=r.find(".filter-input2");a.push(c.val())}i.filterColumn(e,o.val(),a),n.off(),t.hide(),u.close(!0)}),u.show(i._locale.filterTitle,n,[c,h]),n.on("keydown",function(e){e.stopPropagation()})},filterColumn:function(e,t,i){for(var n=this.grid.getData(),s=n.getItems(),a=0;a<s.length;a++){var r=s[a];if("checked"==r.sel){if(null==r[e.id])r.sel="empty";else switch(t){case">":r[e.id]>i[0]||(r.sel="empty");break;case">=":r[e.id]>=i[0]||(r.sel="empty");break;case"=":r[e.id]!=i[0]&&(r.sel="empty");break;case"<=":r[e.id]<=i[0]||(r.sel="empty");break;case"<":r[e.id]<i[0]||(r.sel="empty");break;case"...":i[0]<r[e.id]&&r[e.id]<i[1]||(r.sel="empty")}n.updateItem(r.id,r)}}this.dataView.refresh(),n.collapseGroup("empty"),this.sendStatsData(e)},downloadJSON2CSV:function(e){for(var t="object"!=typeof e?JSON.parse(e):e,i="",n=0;n<t.length;n++){var s="";for(var a in t[n])s+=t[n][a]+",";s.slice(0,s.Length-1),i+=s+"\r\n"}window.open("data:text/csv;charset=utf-8,"+escape(i))},_featureHighlightedEvent:function(e){var t=e.getFeature().attributes,i=e.isHighlighted(),n=this.getIdxByCode(t.kuntakoodi),s="highlight-row-"+t.kuntakoodi,a={};this.grid&&n&&this.getItemsByGroupingKey("checked").length>0&&(this.selectedMunicipalities[t.kuntakoodi]=i,i?-1!=n&&(this.grid.scrollRowToTop(n),a[n]={municipality:"statsgrid-highlight-row"},this.grid.addCellCssStyles(s,a),this.dataView.syncGridCellCssStyles(this.grid,s)):(this.grid.removeCellCssStyles(s),this.dataView.syncGridCellCssStyles(this.grid,s)))},_featureSelectedEvent:function(e){var t=e.getFeature().attributes,i=e.isHighlighted(),n=this.getItemByCode(t.kuntakoodi);if(this.grid&&n){this.selectedMunicipalities[t.kuntakoodi]=i,n.sel=i?"checked":"empty";var s=this.grid.getData();s.updateItem(n.id,n);var a=this._getColumnById(this._state.currentColumn);this.sendStatsData(a)}},getItemsByGroupingKey:function(e){for(var t=this.grid.getData().getItems(),i=[],n=0;n<t.length;n++){var s=t[n];s.sel===e&&i.push(e)}return i},_showSelectedAreas:function(e){for(var t=this.grid.getData(),i=t.getItems(),n=0;n<i.length;n++){var s=i[n];s.sel="empty";for(var a=0;a<e.length;a++){var r=e[a];s.id==r&&(s.sel="checked")}t.updateItem(s.id,s)}t.collapseGroup("empty"),t.refresh()},unselectAllAreas:function(e){for(var t=this.grid,i=t.getData(),n=t.getData().getItems(),s=0;s<n.length;s++){var a=n[s];a.sel=e&&this.selectedMunicipalities[a.code]?"checked":"empty"}i.collapseGroup("empty");var r=this._getColumnById(this._state.currentColumn);this.sendStatsData(r),i.setItems(n),i.refresh(),t.invalidateAllRows(),t.render()},_getColumnById:function(e){for(var t=this.grid.getColumns(),i=0;i<t.length;i++){var n=t[i];if(n.id===e)return n}return null},sendTooltipData:function(e){var t=e.attributes,i=this._sandbox.getEventBuilder("MapStats.HoverTooltipContentEvent"),n=this._state.currentColumn,s=this.getItemByCode(t.kuntakoodi),a="<p>"+s.municipality;if(a+=n&&null!=s[n]?"<br />"+s[n]:"",a+="</p>",i){var r=i(a);this._sandbox.notifyAll(r)}},toggleSelectMunicipalitiesMode:function(){return this.selectMunicipalitiesMode=!this.selectMunicipalitiesMode,this.selectMunicipalitiesMode}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.event.SotkadataChangedEvent",function(e,t){this._layer=e,this._params=t},{getName:function(){return"StatsGrid.SotkadataChangedEvent"},getLayer:function(){return this._layer},getParams:function(){return this._params}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.event.ModeChangedEvent",function(e){this._modeVisible=e},{getName:function(){return"StatsGrid.ModeChangedEvent"},isModeVisible:function(){return this._modeVisible}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.event.ClearHilightsEvent",function(){},{getName:function(){return"StatsGrid.ClearHilightsEvent"}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.event.SelectHilightsModeEvent",function(e){this._codes=e},{getName:function(){return"StatsGrid.SelectHilightsModeEvent"},getCodes:function(){return this._codes}},{protocol:["Oskari.mapframework.event.Event"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.request.StatsGridRequest",function(e,t){this._enable=e===!0,this._layer=t},{__name:"StatsGrid.StatsGridRequest",getName:function(){return this.__name},getLayer:function(){return this._layer},isEnabled:function(){return this._enable}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.request.StatsGridRequestHandler",function(e){this.view=e},{handleRequest:function(e,t){"StatsGrid.StatsGridRequest"==t.getName()&&this.view.prepareMode(t.isEnabled(),t.getLayer())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.request.TooltipContentRequest",function(e){this._feature=e},{__name:"StatsGrid.TooltipContentRequest",getName:function(){return this.__name},getFeature:function(){return this._feature}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.request.TooltipContentRequestHandler",function(e){this.instance=e},{handleRequest:function(e,t){"StatsGrid.TooltipContentRequest"==t.getName()&&this.instance.gridPlugin.sendTooltipData(t.getFeature())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.statistics.bundle.statsgrid.StatisticsService",function(e){this.instance=e,this.sandbox=e.sandbox},{__name:"StatsGrid.StatisticsService",__qname:"Oskari.statistics.bundle.statsgrid.StatisticsService",getQName:function(){return this.__qname},getName:function(){return this.__name},init:function(){},sendStatsData:function(e,t){var i=this,n=i.sandbox.getEventBuilder("StatsGrid.SotkadataChangedEvent");if(n){var s=n(e,t);i.sandbox.notifyAll(s)}},sendVisualizationData:function(e,t){var i=this,n=i.sandbox.getEventBuilder("MapStats.StatsVisualizationChangeEvent");if(n){var s=n(e,t);i.sandbox.notifyAll(s)}},fetchStatsData:function(e,t,i){jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:e,success:function(e){t&&t(e)},error:function(e,t){i&&0!=e.status&&i(e,t)}})}},{protocol:["Oskari.mapframework.service.Service"]}),function(e){e.fn.drag=function(t,i,n){var s="string"==typeof t?t:"",a=e.isFunction(t)?t:e.isFunction(i)?i:null;return 0!==s.indexOf("drag")&&(s="drag"+s),n=(t==a?i:n)||{},a?this.bind(s,n,a):this.trigger(s)};var t=e.event,i=t.special,n=i.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",livekey:"livedrag",add:function(i){var s=e.data(this,n.datakey),a=i.data||{};
s.related+=1,!s.live&&i.selector&&(s.live=!0,t.add(this,"draginit."+n.livekey,n.delegate)),e.each(n.defaults,function(e){void 0!==a[e]&&(s[e]=a[e])})},remove:function(){e.data(this,n.datakey).related-=1},setup:function(){if(!e.data(this,n.datakey)){var i=e.extend({related:0},n.defaults);e.data(this,n.datakey,i),t.add(this,"mousedown",n.init,i),this.attachEvent&&this.attachEvent("ondragstart",n.dontstart)}},teardown:function(){e.data(this,n.datakey).related||(e.removeData(this,n.datakey),t.remove(this,"mousedown",n.init),t.remove(this,"draginit",n.delegate),n.textselect(!0),this.detachEvent&&this.detachEvent("ondragstart",n.dontstart))},init:function(s){var a,r=s.data;return r.which>0&&s.which!=r.which||e(s.target).is(r.not)||r.handle&&!e(s.target).closest(r.handle,s.currentTarget).length||(r.propagates=1,r.interactions=[n.interaction(this,r)],r.target=s.target,r.pageX=s.pageX,r.pageY=s.pageY,r.dragging=null,a=n.hijack(s,"draginit",r),!r.propagates)?void 0:((a=n.flatten(a))&&a.length&&(r.interactions=[],e.each(a,function(){r.interactions.push(n.interaction(this,r))})),r.propagates=r.interactions.length,r.drop!==!1&&i.drop&&i.drop.handler(s,r),n.textselect(!1),t.add(document,"mousemove mouseup",n.handler,r),!1)},interaction:function(t,i){return{drag:t,callback:new n.callback,droppable:[],offset:e(t)[i.relative?"position":"offset"]()||{top:0,left:0}}},handler:function(e){var s=e.data;switch(e.type){case!s.dragging&&"mousemove":if(Math.pow(e.pageX-s.pageX,2)+Math.pow(e.pageY-s.pageY,2)<Math.pow(s.distance,2))break;e.target=s.target,n.hijack(e,"dragstart",s),s.propagates&&(s.dragging=!0);case"mousemove":if(s.dragging){if(n.hijack(e,"drag",s),s.propagates){s.drop!==!1&&i.drop&&i.drop.handler(e,s);break}e.type="mouseup"}case"mouseup":t.remove(document,"mousemove mouseup",n.handler),s.dragging&&(s.drop!==!1&&i.drop&&i.drop.handler(e,s),n.hijack(e,"dragend",s)),n.textselect(!0),s.click===!1&&s.dragging&&(jQuery.event.triggered=!0,setTimeout(function(){jQuery.event.triggered=!1},20),s.dragging=!1)}},delegate:function(i){var s,a=[],r=e.data(this,"events")||{};return e.each(r.live||[],function(r,o){0===o.preType.indexOf("drag")&&(s=e(i.target).closest(o.selector,i.currentTarget)[0])&&(t.add(s,o.origType+"."+n.livekey,o.origHandler,o.data),e.inArray(s,a)<0&&a.push(s))}),a.length?e(a).bind("dragend."+n.livekey,function(){t.remove(this,"."+n.livekey)}):!1},hijack:function(i,s,a,r,o){if(a){var l,u,c,h={event:i.originalEvent,type:i.type},d=s.indexOf("drop")?"drag":"drop",p=r||0;r=isNaN(r)?a.interactions.length:r,i.type=s,i.originalEvent=null,a.results=[];do(u=a.interactions[p])&&("dragend"!==s&&u.cancelled||(c=n.properties(i,a,u),u.results=[],e(o||u[d]||a.droppable).each(function(r,o){return l=(c.target=o)?t.handle.call(o,i,c):null,l===!1?("drag"==d&&(u.cancelled=!0,a.propagates-=1),"drop"==s&&(u[d][r]=null)):"dropinit"==s&&u.droppable.push(n.element(l)||o),"dragstart"==s&&(u.proxy=e(n.element(l)||u.drag)[0]),u.results.push(l),delete i.result,"dropinit"!==s?l:void 0}),a.results[p]=n.flatten(u.results),"dropinit"==s&&(u.droppable=n.flatten(u.droppable)),"dragstart"==s&&!u.cancelled&&c.update()));while(++p<r);return i.type=h.type,i.originalEvent=h.event,n.flatten(a.results)}},properties:function(e,t,i){var s=i.callback;return s.drag=i.drag,s.proxy=i.proxy||i.drag,s.startX=t.pageX,s.startY=t.pageY,s.deltaX=e.pageX-t.pageX,s.deltaY=e.pageY-t.pageY,s.originalX=i.offset.left,s.originalY=i.offset.top,s.offsetX=e.pageX-(t.pageX-s.originalX),s.offsetY=e.pageY-(t.pageY-s.originalY),s.drop=n.flatten((i.drop||[]).slice()),s.available=n.flatten((i.droppable||[]).slice()),s},element:function(e){return e&&(e.jquery||1==e.nodeType)?e:void 0},flatten:function(t){return e.map(t,function(t){return t&&t.jquery?e.makeArray(t):t&&t.length?n.flatten(t):t})},textselect:function(t){e(document)[t?"unbind":"bind"]("selectstart",n.dontstart).attr("unselectable",t?"off":"on").css("MozUserSelect",t?"":"none")},dontstart:function(){return!1},callback:function(){}};n.callback.prototype={update:function(){i.drop&&this.available.length&&e.each(this.available,function(e){i.drop.locate(this,e)})}},i.draginit=i.dragstart=i.dragend=n}(jQuery),function(e){function t(){var e=!1,t=!1;this.stopPropagation=function(){e=!0},this.isPropagationStopped=function(){return e},this.stopImmediatePropagation=function(){t=!0},this.isImmediatePropagationStopped=function(){return t}}function i(){var e=[];this.subscribe=function(t){e.push(t)},this.unsubscribe=function(t){for(var i=e.length-1;i>=0;i--)e[i]===t&&e.splice(i,1)},this.notify=function(i,n,s){n=n||new t,s=s||this;for(var a,r=0;r<e.length&&!n.isPropagationStopped()&&!n.isImmediatePropagationStopped();r++)a=e[r].call(s,n,i);return a}}function n(){var e=[];this.subscribe=function(t,i){return e.push({event:t,handler:i}),t.subscribe(i),this},this.unsubscribe=function(t,i){for(var n=e.length;n--;)if(e[n].event===t&&e[n].handler===i)return e.splice(n,1),t.unsubscribe(i),void 0;return this},this.unsubscribeAll=function(){for(var t=e.length;t--;)e[t].event.unsubscribe(e[t].handler);return e=[],this}}function s(e,t,i,n){void 0===i&&void 0===n&&(i=e,n=t),this.fromRow=Math.min(e,i),this.fromCell=Math.min(t,n),this.toRow=Math.max(e,i),this.toCell=Math.max(t,n),this.isSingleRow=function(){return this.fromRow==this.toRow},this.isSingleCell=function(){return this.fromRow==this.toRow&&this.fromCell==this.toCell},this.contains=function(e,t){return e>=this.fromRow&&e<=this.toRow&&t>=this.fromCell&&t<=this.toCell},this.toString=function(){return this.isSingleCell()?"("+this.fromRow+":"+this.fromCell+")":"("+this.fromRow+":"+this.fromCell+" - "+this.toRow+":"+this.toCell+")"}}function a(){this.__nonDataRow=!0}function r(){this.__group=!0,this.level=0,this.count=0,this.value=null,this.title=null,this.collapsed=!1,this.totals=null,this.rows=[],this.groups=null,this.groupingKey=null}function o(){this.__groupTotals=!0,this.group=null}function l(){var e=null;this.isActive=function(t){return t?e===t:null!==e},this.activate=function(t){if(t!==e){if(null!==e)throw"SlickGrid.EditorLock.activate: an editController is still active, can't activate another editController";if(!t.commitCurrentEdit)throw"SlickGrid.EditorLock.activate: editController must implement .commitCurrentEdit()";if(!t.cancelCurrentEdit)throw"SlickGrid.EditorLock.activate: editController must implement .cancelCurrentEdit()";e=t}},this.deactivate=function(t){if(e!==t)throw"SlickGrid.EditorLock.deactivate: specified editController is not the currently active one";e=null},this.commitCurrentEdit=function(){return e?e.commitCurrentEdit():!0},this.cancelCurrentEdit=function(){return e?e.cancelCurrentEdit():!0}}e.extend(!0,window,{Slick:{Event:i,EventData:t,EventHandler:n,Range:s,NonDataRow:a,Group:r,GroupTotals:o,EditorLock:l,GlobalEditorLock:new l}}),r.prototype=new a,r.prototype.equals=function(e){return this.value===e.value&&this.count===e.count&&this.collapsed===e.collapsed},o.prototype=new a}(jQuery),function(e){function t(e,t,i){return null==i||""===i?"-":50>i?"<span style='color:red;font-weight:bold;'>"+i+"%</span>":"<span style='color:green'>"+i+"%</span>"}function i(e,t,i){if(null==i||""===i)return"";var n;return n=30>i?"red":70>i?"silver":"green","<span class='percent-complete-bar' style='background:"+n+";width:"+i+"%'></span>"}function n(e,t,i){return i?"Yes":"No"}function s(e,t,i){return i?"<img src='../images/tick.png'>":""}e.extend(!0,window,{Slick:{Formatters:{PercentComplete:t,PercentCompleteBar:i,YesNo:n,Checkmark:s}}})}(jQuery),function(e){function t(t){var i,n;this.init=function(){i=e("<INPUT type=text class='editor-text' />").appendTo(t.container).bind("keydown.nav",function(t){(t.keyCode===e.ui.keyCode.LEFT||t.keyCode===e.ui.keyCode.RIGHT)&&t.stopImmediatePropagation()}).focus().select()},this.destroy=function(){i.remove()},this.focus=function(){i.focus()},this.getValue=function(){return i.val()},this.setValue=function(e){i.val(e)},this.loadValue=function(e){n=e[t.column.field]||"",i.val(n),i[0].defaultValue=n,i.select()},this.serializeValue=function(){return i.val()},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==n)&&i.val()!=n},this.validate=function(){if(t.column.validator){var e=t.column.validator(i.val());if(!e.valid)return e}return{valid:!0,msg:null}},this.init()}function i(t){var i,n;this.init=function(){i=e("<INPUT type=text class='editor-text' />"),i.bind("keydown.nav",function(t){(t.keyCode===e.ui.keyCode.LEFT||t.keyCode===e.ui.keyCode.RIGHT)&&t.stopImmediatePropagation()}),i.appendTo(t.container),i.focus().select()},this.destroy=function(){i.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){n=e[t.column.field],i.val(n),i[0].defaultValue=n,i.select()},this.serializeValue=function(){return parseInt(i.val(),10)||0},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==n)&&i.val()!=n},this.validate=function(){return isNaN(i.val())?{valid:!1,msg:"Please enter a valid integer"}:{valid:!0,msg:null}},this.init()}function n(t){var i,n,s=!1;this.init=function(){i=e("<INPUT type=text class='editor-text' />"),i.appendTo(t.container),i.focus().select(),i.datepicker({showOn:"button",buttonImageOnly:!0,buttonImage:"../images/calendar.gif",beforeShow:function(){s=!0},onClose:function(){s=!1}}),i.width(i.width()-18)},this.destroy=function(){e.datepicker.dpDiv.stop(!0,!0),i.datepicker("hide"),i.datepicker("destroy"),i.remove()},this.show=function(){s&&e.datepicker.dpDiv.stop(!0,!0).show()},this.hide=function(){s&&e.datepicker.dpDiv.stop(!0,!0).hide()},this.position=function(t){s&&e.datepicker.dpDiv.css("top",t.top+30).css("left",t.left)},this.focus=function(){i.focus()},this.loadValue=function(e){n=e[t.column.field],i.val(n),i[0].defaultValue=n,i.select()},this.serializeValue=function(){return i.val()},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==n)&&i.val()!=n},this.validate=function(){return{valid:!0,msg:null}},this.init()}function s(t){var i,n;this.init=function(){i=e("<SELECT tabIndex='0' class='editor-yesno'><OPTION value='yes'>Yes</OPTION><OPTION value='no'>No</OPTION></SELECT>"),i.appendTo(t.container),i.focus()},this.destroy=function(){i.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){i.val((n=e[t.column.field])?"yes":"no"),i.select()},this.serializeValue=function(){return"yes"==i.val()},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return i.val()!=n},this.validate=function(){return{valid:!0,msg:null}},this.init()}function a(t){var i,n;this.init=function(){i=e("<INPUT type=checkbox value='true' class='editor-checkbox' hideFocus>"),i.appendTo(t.container),i.focus()},this.destroy=function(){i.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){n=!!e[t.column.field],n?i.attr("checked","checked"):i.removeAttr("checked")},this.serializeValue=function(){return!!i.attr("checked")},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return this.serializeValue()!==n},this.validate=function(){return{valid:!0,msg:null}},this.init()}function r(t){var i,n,s;this.init=function(){i=e("<INPUT type=text class='editor-percentcomplete' />"),i.width(e(t.container).innerWidth()-25),i.appendTo(t.container),n=e("<div class='editor-percentcomplete-picker' />").appendTo(t.container),n.append("<div class='editor-percentcomplete-helper'><div class='editor-percentcomplete-wrapper'><div class='editor-percentcomplete-slider' /><div class='editor-percentcomplete-buttons' /></div></div>"),n.find(".editor-percentcomplete-buttons").append("<button val=0>Not started</button><br/><button val=50>In Progress</button><br/><button val=100>Complete</button>"),i.focus().select(),n.find(".editor-percentcomplete-slider").slider({orientation:"vertical",range:"min",value:s,slide:function(e,t){i.val(t.value)}}),n.find(".editor-percentcomplete-buttons button").bind("click",function(){i.val(e(this).attr("val")),n.find(".editor-percentcomplete-slider").slider("value",e(this).attr("val"))})},this.destroy=function(){i.remove(),n.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){i.val(s=e[t.column.field]),i.select()},this.serializeValue=function(){return parseInt(i.val(),10)||0},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==s)&&(parseInt(i.val(),10)||0)!=s},this.validate=function(){return isNaN(parseInt(i.val(),10))?{valid:!1,msg:"Please enter a valid positive number"}:{valid:!0,msg:null}},this.init()}function o(t){var i,n,s,a=this;this.init=function(){var s=e("body");n=e("<DIV style='z-index:10000;position:absolute;background:white;padding:5px;border:3px solid gray; -moz-border-radius:10px; border-radius:10px;'/>").appendTo(s),i=e("<TEXTAREA hidefocus rows=5 style='backround:white;width:250px;height:80px;border:0;outline:0'>").appendTo(n),e("<DIV style='text-align:right'><BUTTON>Save</BUTTON><BUTTON>Cancel</BUTTON></DIV>").appendTo(n),n.find("button:first").bind("click",this.save),n.find("button:last").bind("click",this.cancel),i.bind("keydown",this.handleKeyDown),a.position(t.position),i.focus().select()},this.handleKeyDown=function(i){i.which==e.ui.keyCode.ENTER&&i.ctrlKey?a.save():i.which==e.ui.keyCode.ESCAPE?(i.preventDefault(),a.cancel()):i.which==e.ui.keyCode.TAB&&i.shiftKey?(i.preventDefault(),t.grid.navigatePrev()):i.which==e.ui.keyCode.TAB&&(i.preventDefault(),t.grid.navigateNext())},this.save=function(){t.commitChanges()},this.cancel=function(){i.val(s),t.cancelChanges()},this.hide=function(){n.hide()},this.show=function(){n.show()},this.position=function(e){n.css("top",e.top-5).css("left",e.left-5)},this.destroy=function(){n.remove()},this.focus=function(){i.focus()},this.loadValue=function(e){i.val(s=e[t.column.field]),i.select()},this.serializeValue=function(){return i.val()},this.applyValue=function(e,i){e[t.column.field]=i},this.isValueChanged=function(){return!(""==i.val()&&null==s)&&i.val()!=s},this.validate=function(){return{valid:!0,msg:null}},this.init()}e.extend(!0,window,{Slick:{Editors:{Text:t,Integer:i,Date:n,YesNoSelect:s,Checkbox:a,PercentComplete:r,LongText:o}}})}(jQuery),function(e){function t(t,i){function n(n){a||(a=e("<div></div>",{css:i.selectionCss}).css("position","absolute").appendTo(t.getCanvasNode()));var s=t.getCellNodeBox(n.fromRow,n.fromCell),r=t.getCellNodeBox(n.toRow,n.toCell);return a.css({top:s.top-1,left:s.left-1,height:r.bottom-s.top-2,width:r.right-s.left-2}),a}function s(){a&&(a.remove(),a=null)}var a,r={selectionCss:{zIndex:"9999",border:"2px dashed red"}};i=e.extend(!0,{},r,i),e.extend(this,{show:n,hide:s})}e.extend(!0,window,{Slick:{CellRangeDecorator:t}})}(jQuery),function(e){function t(t){function i(i){t=e.extend(!0,{},f,t),h=new Slick.CellRangeDecorator(i,t),l=i,u=l.getCanvasNode(),p.subscribe(l.onDragInit,s).subscribe(l.onDragStart,a).subscribe(l.onDrag,r).subscribe(l.onDragEnd,o)}function n(){p.unsubscribeAll()}function s(e){e.stopImmediatePropagation()}function a(t,i){var n=l.getCellFromEvent(t);if(d.onBeforeCellRangeSelected.notify(n)!==!1&&l.canCellBeSelected(n.row,n.cell)&&(c=!0,t.stopImmediatePropagation()),c){var s=l.getCellFromPoint(i.startX-e(u).offset().left,i.startY-e(u).offset().top);return i.range={start:s,end:{}},h.show(new Slick.Range(s.row,s.cell))}}function r(t,i){if(c){t.stopImmediatePropagation();var n=l.getCellFromPoint(t.pageX-e(u).offset().left,t.pageY-e(u).offset().top);l.canCellBeSelected(n.row,n.cell)&&(i.range.end=n,h.show(new Slick.Range(i.range.start.row,i.range.start.cell,n.row,n.cell)))}}function o(e,t){c&&(c=!1,e.stopImmediatePropagation(),h.hide(),d.onCellRangeSelected.notify({range:new Slick.Range(t.range.start.row,t.range.start.cell,t.range.end.row,t.range.end.cell)}))}var l,u,c,h,d=this,p=new Slick.EventHandler,f={selectionCss:{border:"2px dashed blue"}};e.extend(this,{init:i,destroy:n,onBeforeCellRangeSelected:new Slick.Event,onCellRangeSelected:new Slick.Event})}e.extend(!0,window,{Slick:{CellRangeSelector:t}})}(jQuery),function(e){function t(t){function i(i){p=e.extend(!0,{},y,t),h=i,d=h.getCanvasNode(),h.onActiveCellChanged.subscribe(u),h.onKeyDown.subscribe(c),i.registerPlugin(g),g.onCellRangeSelected.subscribe(l),g.onBeforeCellRangeSelected.subscribe(o)}function n(){h.onActiveCellChanged.unsubscribe(u),h.onKeyDown.unsubscribe(c),g.onCellRangeSelected.unsubscribe(l),g.onBeforeCellRangeSelected.unsubscribe(o),h.unregisterPlugin(g)}function s(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];h.canCellBeSelected(n.fromRow,n.fromCell)&&h.canCellBeSelected(n.toRow,n.toCell)&&t.push(n)}return t}function a(e){f=s(e),m.onSelectedRangesChanged.notify(f)}function r(){return f}function o(e){return h.getEditorLock().isActive()?(e.stopPropagation(),!1):void 0}function l(e,t){a([t.range])}function u(e,t){p.selectActiveCell&&null!=t.row&&null!=t.cell&&a([new Slick.Range(t.row,t.cell)])}function c(e){var t,i,n=h.getActiveCell();if(n&&e.shiftKey&&!e.ctrlKey&&!e.altKey&&(37==e.which||39==e.which||38==e.which||40==e.which)){t=r(),t.length||t.push(new Slick.Range(n.row,n.cell)),i=t.pop(),i.contains(n.row,n.cell)||(i=new Slick.Range(n.row,n.cell));var o=i.toRow-i.fromRow,l=i.toCell-i.fromCell,u=n.row==i.fromRow?1:-1,c=n.cell==i.fromCell?1:-1;37==e.which?l-=c:39==e.which?l+=c:38==e.which?o-=u:40==e.which&&(o+=u);var d=new Slick.Range(n.row,n.cell,n.row+u*o,n.cell+c*l);s([d]).length?(t.push(d),h.scrollRowIntoView(u>0?d.toRow:d.fromRow),h.scrollCellIntoView(d.fromRow,c>0?d.toCell:d.fromCell)):t.push(i),a(t),e.preventDefault(),e.stopPropagation()}}var h,d,p,f=[],m=this,g=new Slick.CellRangeSelector({selectionCss:{border:"2px solid black"}}),y={selectActiveCell:!0};e.extend(this,{getSelectedRanges:r,setSelectedRanges:a,init:i,destroy:n,onSelectedRangesChanged:new Slick.Event})}e.extend(!0,window,{Slick:{CellSelectionModel:t}})}(jQuery),function(e){function t(t){function i(i){t=e.extend(!0,{},m,t),c=i,f.subscribe(c.onHeaderCellRendered,r).subscribe(c.onBeforeHeaderCellDestroy,o),c.setColumns(c.getColumns())}function n(){f.unsubscribeAll(),e(document.body).unbind("mousedown",s)}function s(t){h&&h[0]!=t.target&&!e.contains(h[0],t.target)&&a()}function a(){h&&(h.remove(),h=null,d.removeClass("slick-header-column-active"))}function r(i,n){var s=n.column,a=s.header&&s.header.menu;if(a){var r=e("<div></div>").addClass("slick-header-menubutton").data("column",s).data("menu",a);t.buttonCssClass&&r.addClass(t.buttonCssClass),s.header.icon?r.append(e("<div></div>").addClass(s.header.icon)):t.buttonImage&&r.append(e("<div></div>").css({"background-image":"url("+t.buttonImage+")",width:"16px",height:"16px","background-position":"center"})),a.tooltip&&r.attr("title",a.tooltip),r.bind("click",l).appendTo(n.node)}}function o(t,i){var n=i.column;n.header&&n.header.menu&&e(i.node).find(".slick-header-menubutton").remove()}function l(t){var i=e(this),n=i.data("menu"),s=i.data("column");if(null!=d&&d.hasClass("slick-header-column-active"))return a(),void 0;if(0!=p.onBeforeMenuShow.notify({grid:c,column:s,menu:n},t,p)){h||(h=e("<div class='slick-header-menu'></div>").appendTo(document.body)),h.empty();for(var r=0;r<n.items.length;r++){var o=n.items[r],l=e("<div class='slick-header-menuitem'></div>").data("command",o.command||"").data("column",s).appendTo(h);o.actionType&&"link"==o.actionType?l.bind("click",u):l.bind("change",u),o.tooltip&&l.attr("title",o.tooltip),e(o.element).appendTo(l)}h.css("top",e(this).offset().top+e(this).height()+7).css("left",e(this).offset().left),d=i.closest(".slick-header-column"),d.addClass("slick-header-column-active")}}function u(t){var i=e(this).data("command"),n=e(this).data("column");null!=i&&""!=i&&p.onCommand.notify({grid:c,column:n,command:i},t,p),t.preventDefault(),t.stopPropagation()}var c,h,d,p=this,f=new Slick.EventHandler,m={buttonCssClass:null,buttonImage:"/Oskari/libraries/slickgrid/images/down.gif"};e.extend(this,{init:i,destroy:n,hide:a,onBeforeMenuShow:new Slick.Event,onCommand:new Slick.Event})}e.extend(!0,window,{Slick:{Plugins:{HeaderMenu2:t}}})}(jQuery),function(e){function t(t){function i(i){y=e.extend(!0,{},w,t),m=i,_.subscribe(m.onActiveCellChanged,s(d)),_.subscribe(m.onKeyDown,s(p)),_.subscribe(m.onClick,s(f))}function n(){_.unsubscribeAll()}function s(e){return function(){g||(g=!0,e.apply(this,arguments),g=!1)}}function a(e){for(var t=[],i=0;i<e.length;i++)for(var n=e[i].fromRow;n<=e[i].toRow;n++)t.push(n);return t}function r(e){for(var t=[],i=m.getColumns().length-1,n=0;n<e.length;n++)t.push(new Slick.Range(e[n],0,e[n],i));return t}function o(e,t){var i,n=[];for(i=e;t>=i;i++)n.push(i);for(i=t;e>i;i++)n.push(i);return n}function l(){return a(v)}function u(e){c(r(e))}function c(e){v=e,b.onSelectedRangesChanged.notify(v)}function h(){return v}function d(e,t){y.selectActiveRow&&null!=t.row&&c([new Slick.Range(t.row,0,t.row,m.getColumns().length-1)])}function p(e){var t=m.getActiveCell();if(t&&e.shiftKey&&!e.ctrlKey&&!e.altKey&&!e.metaKey&&(38==e.which||40==e.which)){var i=l();i.sort(function(e,t){return e-t}),i.length||(i=[t.row]);var n,s=i[0],a=i[i.length-1];n=40==e.which?t.row<a||s==a?++a:++s:t.row<a?--a:--s,n>=0&&n<m.getDataLength()&&(m.scrollRowIntoView(n),v=r(o(s,a)),c(v)),e.preventDefault(),e.stopPropagation()}}function f(t){var i=m.getCellFromEvent(t);if(!i||!m.canCellBeActive(i.row,i.cell))return!1;var n=a(v),s=e.inArray(i.row,n);if(!(t.ctrlKey||t.shiftKey||t.metaKey))return!1;if(m.getOptions().multiSelect)if(-1===s&&(t.ctrlKey||t.metaKey))n.push(i.row),m.setActiveCell(i.row,i.cell);else if(-1!==s&&(t.ctrlKey||t.metaKey))n=e.grep(n,function(e){return e!==i.row}),m.setActiveCell(i.row,i.cell);else if(n.length&&t.shiftKey){var o=n.pop(),l=Math.min(i.row,o),u=Math.max(i.row,o);n=[];for(var h=l;u>=h;h++)h!==o&&n.push(h);n.push(o),m.setActiveCell(i.row,i.cell)}return v=r(n),c(v),t.stopImmediatePropagation(),!0}var m,g,y,v=[],b=this,_=new Slick.EventHandler,w={selectActiveRow:!0};e.extend(this,{getSelectedRows:l,setSelectedRows:u,getSelectedRanges:h,setSelectedRanges:c,init:i,destroy:n,onSelectedRangesChanged:new Slick.Event})}e.extend(!0,window,{Slick:{RowSelectionModel:t}})}(jQuery),function(e){function t(t){function i(e){u=e,h.subscribe(u.onClick,a).subscribe(u.onHeaderClick,r).subscribe(u.onKeyDown,s)}function n(){h.unsubscribeAll()}function s(e,t){32==e.which&&u.getColumns()[t.cell].id===p.columnId&&((!u.getEditorLock().isActive()||u.getEditorLock().commitCurrentEdit())&&toggleRowSelection(t.row),e.preventDefault(),e.stopImmediatePropagation())}function a(t,i){if(u.getColumns()[i.cell].id===p.columnId&&e(t.target).is(":checkbox")){if(u.getEditorLock().isActive()&&!u.getEditorLock().commitCurrentEdit())return t.preventDefault(),t.stopImmediatePropagation(),void 0;c.onSelectRowClicked.notify(i,t,c);var n=u.getData(),s=n.getGroups(),a=n.getItems().length,r=!1;for(var o in s){var l=s[o];if(l.count==a&&e(t.target).is(":checked")){u.updateColumnHeader(p.columnId,"<input type='checkbox' checked='checked'>",p.toolTip),r=!0;break}}r||u.updateColumnHeader(p.columnId,"<input type='checkbox'>",p.toolTip),u.getData().refresh(),u.invalidateAllRows(),u.render(),t.stopPropagation(),t.stopImmediatePropagation()}}function r(t,i){if(i.column.id==p.columnId&&e(t.target).is(":checkbox")){if(u.getEditorLock().isActive()&&!u.getEditorLock().commitCurrentEdit())return t.preventDefault(),t.stopImmediatePropagation(),void 0;var n=u.getData().getItems();if(e(t.target).is(":checked"))for(var s=0;s<n.length;s++){var a=n[s];a.sel="checked"}else for(var s=0;s<n.length;s++){var a=n[s];a.sel="empty"}c.onSelectHeaderRowClicked.notify(i,t,c),u.getData().setItems(n),u.getData().refresh(),u.invalidateAllRows(),u.render(),t.stopPropagation(),t.stopImmediatePropagation()}}function o(){return{id:p.columnId,name:"<input type='checkbox'>",toolTip:p.toolTip,field:"sel",width:p.width,resizable:!1,sortable:!1,cssClass:p.cssClass,formatter:l}}function l(e,t,i,n,s){return s?"checked"==s.sel?"<input type='checkbox' checked='checked'>":"<input type='checkbox'>":null}var u,c=this,h=new Slick.EventHandler,d={columnId:"_checkbox_selector",cssClass:null,toolTip:"Select/Deselect All",width:30},p=e.extend(!0,{},d,t);e.extend(this,{init:i,destroy:n,onSelectRowClicked:new Slick.Event,onSelectHeaderRowClicked:new Slick.Event,getColumnDefinition:o})}e.extend(!0,window,{Slick:{CheckboxSelectColumn2:t}})}(jQuery),"undefined"==typeof jQuery)throw"SlickGrid requires jquery module to be loaded";if(!jQuery.fn.drag)throw"SlickGrid requires jquery.event.drag module to be loaded";if("undefined"==typeof Slick)throw"slick.core.js not loaded";!function($){function SlickGrid(container,data,columns,options){function init(){if($container=$(container),$container.length<1)throw new Error("SlickGrid requires a valid container, "+container+" does not exist in the DOM.");maxSupportedCssHeight=maxSupportedCssHeight||getMaxSupportedCssHeight(),scrollbarDimensions=scrollbarDimensions||measureScrollbar(),options=$.extend({},defaults,options),validateAndEnforceOptions(),columnDefaults.width=options.defaultColumnWidth,columnsById={};for(var e=0;e<columns.length;e++){var t=columns[e]=$.extend({},columnDefaults,columns[e]);columnsById[t.id]=e,t.minWidth&&t.width<t.minWidth&&(t.width=t.minWidth),t.maxWidth&&t.width>t.maxWidth&&(t.width=t.maxWidth)}if(options.enableColumnReorder&&!$.fn.sortable)throw new Error("SlickGrid's 'enableColumnReorder = true' option requires jquery-ui.sortable module to be loaded");editController={commitCurrentEdit:commitCurrentEdit,cancelCurrentEdit:cancelCurrentEdit},$container.empty().css("overflow","hidden").css("outline",0).addClass(uid).addClass("ui-widget"),/relative|absolute|fixed/.test($container.css("position"))||$container.css("position","relative"),$focusSink=$("<div tabIndex='0' hideFocus style='position:fixed;width:0;height:0;top:0;left:0;outline:0;'></div>").appendTo($container),$headerScroller=$("<div class='slick-header ui-state-default' style='overflow:hidden;position:relative;' />").appendTo($container),$headers=$("<div class='slick-header-columns' style='left:-1000px' />").appendTo($headerScroller),$headers.width(getHeadersWidth()),$headerRowScroller=$("<div class='slick-headerrow ui-state-default' style='overflow:hidden;position:relative;' />").appendTo($container),$headerRow=$("<div class='slick-headerrow-columns' />").appendTo($headerRowScroller),$headerRowSpacer=$("<div style='display:block;height:1px;position:absolute;top:0;left:0;'></div>").css("width",getCanvasWidth()+scrollbarDimensions.width+"px").appendTo($headerRowScroller),$topPanelScroller=$("<div class='slick-top-panel-scroller ui-state-default' style='overflow:hidden;position:relative;' />").appendTo($container),$topPanel=$("<div class='slick-top-panel' style='width:10000px' />").appendTo($topPanelScroller),options.showTopPanel||$topPanelScroller.hide(),options.showHeaderRow||$headerRowScroller.hide(),$viewport=$("<div class='slick-viewport' style='width:100%;overflow:auto;outline:0;position:relative;;'>").appendTo($container),$viewport.css("overflow-y",options.autoHeight?"hidden":"auto"),$canvas=$("<div class='grid-canvas' />").appendTo($viewport),$focusSink2=$focusSink.clone().appendTo($container),options.explicitInitialization||finishInitialization()}function finishInitialization(){initialized||(initialized=!0,viewportW=parseFloat($.css($container[0],"width",!0)),measureCellPaddingAndBorder(),disableSelection($headers),options.enableTextSelectionOnCells||$viewport.bind("selectstart.ui",function(e){return $(e.target).is("input,textarea")}),updateColumnCaches(),createColumnHeaders(),setupColumnSort(),createCssRules(),resizeCanvas(),bindAncestorScrollEvents(),$container.bind("resize.slickgrid",resizeCanvas),$viewport.bind("scroll",handleScroll),$headerScroller.bind("contextmenu",handleHeaderContextMenu).bind("click",handleHeaderClick).delegate(".slick-header-column","mouseenter",handleHeaderMouseEnter).delegate(".slick-header-column","mouseleave",handleHeaderMouseLeave),$headerRowScroller.bind("scroll",handleHeaderRowScroll),$focusSink.add($focusSink2).bind("keydown",handleKeyDown),$canvas.bind("keydown",handleKeyDown).bind("click",handleClick).bind("dblclick",handleDblClick).bind("contextmenu",handleContextMenu).bind("draginit",handleDragInit).bind("dragstart",{distance:3},handleDragStart).bind("drag",handleDrag).bind("dragend",handleDragEnd).delegate(".slick-cell","mouseenter",handleMouseEnter).delegate(".slick-cell","mouseleave",handleMouseLeave))}function registerPlugin(e){plugins.unshift(e),e.init(self)}function unregisterPlugin(e){for(var t=plugins.length;t>=0;t--)if(plugins[t]===e){plugins[t].destroy&&plugins[t].destroy(),plugins.splice(t,1);break}}function setSelectionModel(e){selectionModel&&(selectionModel.onSelectedRangesChanged.unsubscribe(handleSelectedRangesChanged),selectionModel.destroy&&selectionModel.destroy()),selectionModel=e,selectionModel&&(selectionModel.init(self),selectionModel.onSelectedRangesChanged.subscribe(handleSelectedRangesChanged))}function getSelectionModel(){return selectionModel}function getCanvasNode(){return $canvas[0]}function measureScrollbar(){var e=$("<div style='position:absolute; top:-10000px; left:-10000px; width:100px; height:100px; overflow:scroll;'></div>").appendTo("body"),t={width:e.width()-e[0].clientWidth,height:e.height()-e[0].clientHeight};return e.remove(),t}function getHeadersWidth(){for(var e=0,t=0,i=columns.length;i>t;t++){var n=columns[t].width;e+=n}return e+=scrollbarDimensions.width,Math.max(e,viewportW)+1e3}function getCanvasWidth(){for(var e=viewportHasVScroll?viewportW-scrollbarDimensions.width:viewportW,t=0,i=columns.length;i--;)t+=columns[i].width;return options.fullWidthRows?Math.max(t,e):t}function updateCanvasWidth(e){var t=canvasWidth;canvasWidth=getCanvasWidth(),canvasWidth!=t&&($canvas.width(canvasWidth),$headerRow.width(canvasWidth),$headers.width(getHeadersWidth()),viewportHasHScroll=canvasWidth>viewportW-scrollbarDimensions.width),$headerRowSpacer.width(canvasWidth+(viewportHasVScroll?scrollbarDimensions.width:0)),(canvasWidth!=t||e)&&applyColumnWidths()}function disableSelection(e){e&&e.jquery&&e.attr("unselectable","on").css("MozUserSelect","none").bind("selectstart.ui",function(){return!1})}function getMaxSupportedCssHeight(){for(var e=1e6,t=navigator.userAgent.toLowerCase().match(/firefox/)?6e6:1e9,i=$("<div style='display:none' />").appendTo(document.body);;){var n=2*e;if(i.css("height",n),n>t||i.height()!==n)break;e=n}return i.remove(),e}function bindAncestorScrollEvents(){for(var e=$canvas[0];(e=e.parentNode)!=document.body&&null!=e;)if(e==$viewport[0]||e.scrollWidth!=e.clientWidth||e.scrollHeight!=e.clientHeight){var t=$(e);$boundAncestors=$boundAncestors?$boundAncestors.add(t):t,t.bind("scroll."+uid,handleActiveCellPositionChange)}}function unbindAncestorScrollEvents(){$boundAncestors&&($boundAncestors.unbind("scroll."+uid),$boundAncestors=null)}function updateColumnHeader(e,t,i){if(initialized){var n=getColumnIndex(e);if(null!=n){var s=columns[n],a=$headers.children().eq(n);a&&(void 0!==t&&(columns[n].name=t),void 0!==i&&(columns[n].toolTip=i),trigger(self.onBeforeHeaderCellDestroy,{node:a[0],column:s}),a.attr("title",i||"").children().eq(0).html(t),trigger(self.onHeaderCellRendered,{node:a[0],column:s}))}}}function getHeaderRow(){return $headerRow[0]}function getHeaderRowColumn(e){var t=getColumnIndex(e),i=$headerRow.children().eq(t);return i&&i[0]}function createColumnHeaders(){function e(){$(this).addClass("ui-state-hover")}function t(){$(this).removeClass("ui-state-hover")}$headers.find(".slick-header-column").each(function(){var e=$(this).data("column");e&&trigger(self.onBeforeHeaderCellDestroy,{node:this,column:e})}),$headers.empty(),$headers.width(getHeadersWidth()),$headerRow.find(".slick-headerrow-column").each(function(){var e=$(this).data("column");e&&trigger(self.onBeforeHeaderRowCellDestroy,{node:this,column:e})}),$headerRow.empty();for(var i=0;i<columns.length;i++){var n=columns[i],s=$("<div class='ui-state-default slick-header-column' id='"+uid+n.id+"' />").html("<span class='slick-column-name'>"+n.name+"</span>").width(n.width-headerColumnWidthDiff).attr("title",n.toolTip||"").data("column",n).addClass(n.headerCssClass||"").appendTo($headers);
if((options.enableColumnReorder||n.sortable)&&s.on("mouseenter",e).on("mouseleave",t),n.sortable&&(s.addClass("slick-header-sortable"),s.append("<span class='slick-sort-indicator' />")),trigger(self.onHeaderCellRendered,{node:s[0],column:n}),options.showHeaderRow){var a=$("<div class='ui-state-default slick-headerrow-column l"+i+" r"+i+"'></div>").data("column",n).appendTo($headerRow);trigger(self.onHeaderRowCellRendered,{node:a[0],column:n})}}setSortColumns(sortColumns),setupColumnResize(),options.enableColumnReorder&&setupColumnReorder()}function setupColumnSort(){$headers.click(function(e){if(e.metaKey=e.metaKey||e.ctrlKey,!$(e.target).hasClass("slick-resizable-handle")){var t=$(e.target).closest(".slick-header-column");if(t.length){var i=t.data("column");if(i.sortable){if(!getEditorLock().commitCurrentEdit())return;for(var n=null,s=0;s<sortColumns.length;s++)if(sortColumns[s].columnId==i.id){n=sortColumns[s],n.sortAsc=!n.sortAsc;break}e.metaKey&&options.multiColumnSort?n&&sortColumns.splice(s,1):((e.shiftKey||e.metaKey)&&options.multiColumnSort||(sortColumns=[]),n?0==sortColumns.length&&sortColumns.push(n):(n={columnId:i.id,sortAsc:i.defaultSortAsc},sortColumns.push(n))),setSortColumns(sortColumns),options.multiColumnSort?trigger(self.onSort,{multiColumnSort:!0,sortCols:$.map(sortColumns,function(e){return{sortCol:columns[getColumnIndex(e.columnId)],sortAsc:e.sortAsc}})},e):trigger(self.onSort,{multiColumnSort:!1,sortCol:i,sortAsc:n.sortAsc},e)}}}})}function setupColumnReorder(){$headers.filter(":ui-sortable").sortable("destroy"),$headers.sortable({containment:"parent",distance:3,axis:"x",cursor:"default",tolerance:"intersection",helper:"clone",placeholder:"slick-sortable-placeholder ui-state-default slick-header-column",forcePlaceholderSize:!0,start:function(e,t){$(t.helper).addClass("slick-header-column-active")},beforeStop:function(e,t){$(t.helper).removeClass("slick-header-column-active")},stop:function(e){if(!getEditorLock().commitCurrentEdit())return $(this).sortable("cancel"),void 0;for(var t=$headers.sortable("toArray"),i=[],n=0;n<t.length;n++)i.push(columns[getColumnIndex(t[n].replace(uid,""))]);setColumns(i),trigger(self.onColumnsReordered,{}),e.stopPropagation(),setupColumnResize()}})}function setupColumnResize(){var e,t,i,n,s,a,r,o,l;s=$headers.children(),s.find(".slick-resizable-handle").remove(),s.each(function(e){columns[e].resizable&&(void 0===o&&(o=e),l=e)}),void 0!==o&&s.each(function(u,c){o>u||options.forceFitColumns&&u>=l||(e=$(c),$("<div class='slick-resizable-handle' />").appendTo(c).bind("dragstart",function(e){if(!getEditorLock().commitCurrentEdit())return!1;n=e.pageX,$(this).parent().addClass("slick-header-column-active");var o=null,l=null;if(s.each(function(e,t){columns[e].previousWidth=$(t).outerWidth()}),options.forceFitColumns)for(o=0,l=0,t=u+1;t<s.length;t++)i=columns[t],i.resizable&&(null!==l&&(i.maxWidth?l+=i.maxWidth-i.previousWidth:l=null),o+=i.previousWidth-Math.max(i.minWidth||0,absoluteColumnMinWidth));var c=0,h=0;for(t=0;u>=t;t++)i=columns[t],i.resizable&&(null!==h&&(i.maxWidth?h+=i.maxWidth-i.previousWidth:h=null),c+=i.previousWidth-Math.max(i.minWidth||0,absoluteColumnMinWidth));null===o&&(o=1e5),null===c&&(c=1e5),null===l&&(l=1e5),null===h&&(h=1e5),r=n+Math.min(o,h),a=n-Math.min(c,l)}).bind("drag",function(e){var o,l,c=Math.min(r,Math.max(a,e.pageX))-n;if(0>c){for(l=c,t=u;t>=0;t--)i=columns[t],i.resizable&&(o=Math.max(i.minWidth||0,absoluteColumnMinWidth),l&&i.previousWidth+l<o?(l+=i.previousWidth-o,i.width=o):(i.width=i.previousWidth+l,l=0));if(options.forceFitColumns)for(l=-c,t=u+1;t<s.length;t++)i=columns[t],i.resizable&&(l&&i.maxWidth&&i.maxWidth-i.previousWidth<l?(l-=i.maxWidth-i.previousWidth,i.width=i.maxWidth):(i.width=i.previousWidth+l,l=0))}else{for(l=c,t=u;t>=0;t--)i=columns[t],i.resizable&&(l&&i.maxWidth&&i.maxWidth-i.previousWidth<l?(l-=i.maxWidth-i.previousWidth,i.width=i.maxWidth):(i.width=i.previousWidth+l,l=0));if(options.forceFitColumns)for(l=-c,t=u+1;t<s.length;t++)i=columns[t],i.resizable&&(o=Math.max(i.minWidth||0,absoluteColumnMinWidth),l&&i.previousWidth+l<o?(l+=i.previousWidth-o,i.width=o):(i.width=i.previousWidth+l,l=0))}applyColumnHeaderWidths(),options.syncColumnCellResize&&applyColumnWidths()}).bind("dragend",function(){var e;for($(this).parent().removeClass("slick-header-column-active"),t=0;t<s.length;t++)i=columns[t],e=$(s[t]).outerWidth(),i.previousWidth!==e&&i.rerenderOnResize&&invalidateAllRows();updateCanvasWidth(!0),render(),trigger(self.onColumnsResized,{})}))})}function getVBoxDelta(e){var t=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],i=0;return $.each(t,function(t,n){i+=parseFloat(e.css(n))||0}),i}function measureCellPaddingAndBorder(){var e,t=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],i=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"];e=$("<div class='ui-state-default slick-header-column' style='visibility:hidden'>-</div>").appendTo($headers),headerColumnWidthDiff=headerColumnHeightDiff=0,$.each(t,function(t,i){headerColumnWidthDiff+=parseFloat(e.css(i))||0}),$.each(i,function(t,i){headerColumnHeightDiff+=parseFloat(e.css(i))||0}),e.remove();var n=$("<div class='slick-row' />").appendTo($canvas);e=$("<div class='slick-cell' id='' style='visibility:hidden'>-</div>").appendTo(n),cellWidthDiff=cellHeightDiff=0,$.each(t,function(t,i){cellWidthDiff+=parseFloat(e.css(i))||0}),$.each(i,function(t,i){cellHeightDiff+=parseFloat(e.css(i))||0}),n.remove(),absoluteColumnMinWidth=Math.max(headerColumnWidthDiff,cellWidthDiff)}function createCssRules(){$style=$("<style type='text/css' rel='stylesheet' />").appendTo($("head"));for(var e=options.rowHeight-cellHeightDiff,t=["."+uid+" .slick-header-column { left: 1000px; }","."+uid+" .slick-top-panel { height:"+options.topPanelHeight+"px; }","."+uid+" .slick-headerrow-columns { height:"+options.headerRowHeight+"px; }","."+uid+" .slick-cell { height:"+e+"px; }","."+uid+" .slick-row { height:"+options.rowHeight+"px; }"],i=0;i<columns.length;i++)t.push("."+uid+" .l"+i+" { }"),t.push("."+uid+" .r"+i+" { }");$style[0].styleSheet?$style[0].styleSheet.cssText=t.join(" "):$style[0].appendChild(document.createTextNode(t.join(" ")))}function getColumnCssRules(e){if(!stylesheet){for(var t=document.styleSheets,i=0;i<t.length;i++)if((t[i].ownerNode||t[i].owningElement)==$style[0]){stylesheet=t[i];break}if(!stylesheet)throw new Error("Cannot find stylesheet.");columnCssRulesL=[],columnCssRulesR=[];for(var n,s,a=stylesheet.cssRules||stylesheet.rules,i=0;i<a.length;i++){var r=a[i].selectorText;(n=/\.l\d+/.exec(r))?(s=parseInt(n[0].substr(2,n[0].length-2),10),columnCssRulesL[s]=a[i]):(n=/\.r\d+/.exec(r))&&(s=parseInt(n[0].substr(2,n[0].length-2),10),columnCssRulesR[s]=a[i])}}return{left:columnCssRulesL[e],right:columnCssRulesR[e]}}function removeCssRules(){$style.remove(),stylesheet=null}function destroy(){getEditorLock().cancelCurrentEdit(),trigger(self.onBeforeDestroy,{});for(var e=plugins.length;e--;)unregisterPlugin(plugins[e]);options.enableColumnReorder&&$headers.filter(":ui-sortable").sortable("destroy"),unbindAncestorScrollEvents(),$container.unbind(".slickgrid"),removeCssRules(),$canvas.unbind("draginit dragstart dragend drag"),$container.empty().removeClass(uid)}function trigger(e,t,i){return i=i||new Slick.EventData,t=t||{},t.grid=self,e.notify(t,i,self)}function getEditorLock(){return options.editorLock}function getEditController(){return editController}function getColumnIndex(e){return columnsById[e]}function autosizeColumns(){var e,t,i,n=[],s=0,a=0,r=viewportHasVScroll?viewportW-scrollbarDimensions.width:viewportW;for(e=0;e<columns.length;e++)t=columns[e],n.push(t.width),a+=t.width,t.resizable&&(s+=t.width-Math.max(t.minWidth,absoluteColumnMinWidth));for(i=a;a>r&&s;){var o=(a-r)/s;for(e=0;e<columns.length&&a>r;e++){t=columns[e];var l=n[e];if(!(!t.resizable||l<=t.minWidth||absoluteColumnMinWidth>=l)){var u=Math.max(t.minWidth,absoluteColumnMinWidth),c=Math.floor(o*(l-u))||1;c=Math.min(c,l-u),a-=c,s-=c,n[e]-=c}}if(i==a)break;i=a}for(i=a;r>a;){var h=r/a;for(e=0;e<columns.length&&r>a;e++)if(t=columns[e],t.resizable&&!(t.maxWidth<=t.width)){var d=Math.min(Math.floor(h*t.width)-t.width,t.maxWidth-t.width||1e6)||1;a+=d,n[e]+=d}if(i==a)break;i=a}var p=!1;for(e=0;e<columns.length;e++)columns[e].rerenderOnResize&&columns[e].width!=n[e]&&(p=!0),columns[e].width=n[e];applyColumnHeaderWidths(),updateCanvasWidth(!0),p&&(invalidateAllRows(),render())}function applyColumnHeaderWidths(){if(initialized){for(var e,t=0,i=$headers.children(),n=i.length;n>t;t++)e=$(i[t]),e.width()!==columns[t].width-headerColumnWidthDiff&&e.width(columns[t].width-headerColumnWidthDiff);updateColumnCaches()}}function applyColumnWidths(){for(var e,t,i=0,n=0;n<columns.length;n++)e=columns[n].width,t=getColumnCssRules(n),t.left.style.left=i+"px",t.right.style.right=canvasWidth-i-e+"px",i+=columns[n].width}function setSortColumn(e,t){setSortColumns([{columnId:e,sortAsc:t}])}function setSortColumns(e){sortColumns=e;var t=$headers.children();t.removeClass("slick-header-column-sorted").find(".slick-sort-indicator").removeClass("slick-sort-indicator-asc slick-sort-indicator-desc"),$.each(sortColumns,function(e,i){null==i.sortAsc&&(i.sortAsc=!0);var n=getColumnIndex(i.columnId);null!=n&&t.eq(n).addClass("slick-header-column-sorted").find(".slick-sort-indicator").addClass(i.sortAsc?"slick-sort-indicator-asc":"slick-sort-indicator-desc")})}function getSortColumns(){return sortColumns}function handleSelectedRangesChanged(e,t){selectedRows=[];for(var i={},n=0;n<t.length;n++)for(var s=t[n].fromRow;s<=t[n].toRow;s++){i[s]||(selectedRows.push(s),i[s]={});for(var a=t[n].fromCell;a<=t[n].toCell;a++)canCellBeSelected(s,a)&&(i[s][columns[a].id]=options.selectedCellCssClass)}setCellCssStyles(options.selectedCellCssClass,i),trigger(self.onSelectedRowsChanged,{rows:getSelectedRows()},e)}function getColumns(){return columns}function updateColumnCaches(){columnPosLeft=[],columnPosRight=[];for(var e=0,t=0,i=columns.length;i>t;t++)columnPosLeft[t]=e,columnPosRight[t]=e+columns[t].width,e+=columns[t].width}function setColumns(e){columns=e,columnsById={};for(var t=0;t<columns.length;t++){var i=columns[t]=$.extend({},columnDefaults,columns[t]);columnsById[i.id]=t,i.minWidth&&i.width<i.minWidth&&(i.width=i.minWidth),i.maxWidth&&i.width>i.maxWidth&&(i.width=i.maxWidth)}updateColumnCaches(),initialized&&(invalidateAllRows(),createColumnHeaders(),removeCssRules(),createCssRules(),resizeCanvas(),applyColumnWidths(),handleScroll())}function getOptions(){return options}function setOptions(e){getEditorLock().commitCurrentEdit()&&(makeActiveCellNormal(),options.enableAddRow!==e.enableAddRow&&invalidateRow(getDataLength()),options=$.extend(options,e),validateAndEnforceOptions(),$viewport.css("overflow-y",options.autoHeight?"hidden":"auto"),render())}function validateAndEnforceOptions(){options.autoHeight&&(options.leaveSpaceForNewRows=!1)}function setData(e,t){data=e,invalidateAllRows(),updateRowCount(),t&&scrollTo(0)}function getData(){return data}function getDataLength(){return data.getLength?data.getLength():data.length}function getDataItem(e){return data.getItem?data.getItem(e):data[e]}function getTopPanel(){return $topPanel[0]}function setTopPanelVisibility(e){options.showTopPanel!=e&&(options.showTopPanel=e,e?$topPanelScroller.slideDown("fast",resizeCanvas):$topPanelScroller.slideUp("fast",resizeCanvas))}function setHeaderRowVisibility(e){options.showHeaderRow!=e&&(options.showHeaderRow=e,e?$headerRowScroller.slideDown("fast",resizeCanvas):$headerRowScroller.slideUp("fast",resizeCanvas))}function getRowTop(e){return options.rowHeight*e-offset}function getRowFromPosition(e){return Math.floor((e+offset)/options.rowHeight)}function scrollTo(e){e=Math.max(e,0),e=Math.min(e,th-viewportH+(viewportHasHScroll?scrollbarDimensions.height:0));var t=offset;page=Math.min(n-1,Math.floor(e/ph)),offset=Math.round(page*cj);var i=e-offset;if(offset!=t){var s=getVisibleRange(i);cleanupRows(s),updateRowPositions()}prevScrollTop!=i&&(vScrollDir=i+offset>prevScrollTop+t?1:-1,$viewport[0].scrollTop=lastRenderedScrollTop=scrollTop=prevScrollTop=i,trigger(self.onViewportChanged,{}))}function defaultFormatter(e,t,i){return null==i?"":(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function getFormatter(e,t){var i=data.getItemMetadata&&data.getItemMetadata(e),n=i&&i.columns&&(i.columns[t.id]||i.columns[getColumnIndex(t.id)]);return n&&n.formatter||i&&i.formatter||t.formatter||options.formatterFactory&&options.formatterFactory.getFormatter(t)||options.defaultFormatter}function getEditor(e,t){var i=columns[t],n=data.getItemMetadata&&data.getItemMetadata(e),s=n&&n.columns;return s&&s[i.id]&&void 0!==s[i.id].editor?s[i.id].editor:s&&s[t]&&void 0!==s[t].editor?s[t].editor:i.editor||options.editorFactory&&options.editorFactory.getEditor(i)}function getDataItemValueForColumn(e,t){return options.dataItemColumnValueExtractor?options.dataItemColumnValueExtractor(e,t):e[t.field]}function appendRowHtml(e,t,i){var n=getDataItem(t),s=t<getDataLength()&&!n,a="slick-row"+(s?" loading":"")+(t===activeRow?" active":"")+(1==t%2?" odd":" even"),r=data.getItemMetadata&&data.getItemMetadata(t);r&&r.cssClasses&&(a+=" "+r.cssClasses),e.push("<div class='ui-widget-content "+a+"' style='top:"+getRowTop(t)+"px'>");for(var o,l,u=0,c=columns.length;c>u;u++){if(l=columns[u],o=1,r&&r.columns){var h=r.columns[l.id]||r.columns[u];o=h&&h.colspan||1,"*"===o&&(o=c-u)}if(columnPosRight[Math.min(c-1,u+o-1)]>i.leftPx){if(columnPosLeft[u]>i.rightPx)break;appendCellHtml(e,t,u,o)}o>1&&(u+=o-1)}e.push("</div>")}function appendCellHtml(e,t,i,n){var s=columns[i],a=getDataItem(t),r="slick-cell l"+i+" r"+Math.min(columns.length-1,i+n-1)+(s.cssClass?" "+s.cssClass:"");t===activeRow&&i===activeCell&&(r+=" active");for(var o in cellCssClasses)cellCssClasses[o][t]&&cellCssClasses[o][t][s.id]&&(r+=" "+cellCssClasses[o][t][s.id]);if(e.push("<div class='"+r+"'>"),a){var l=getDataItemValueForColumn(a,s);e.push(getFormatter(t,s)(t,i,l,s,a))}e.push("</div>"),rowsCache[t].cellRenderQueue.push(i),rowsCache[t].cellColSpans[i]=n}function cleanupRows(e){for(var t in rowsCache)(t=parseInt(t,10))!==activeRow&&(t<e.top||t>e.bottom)&&removeRowFromCache(t)}function invalidate(){updateRowCount(),invalidateAllRows(),render()}function invalidateAllRows(){currentEditor&&makeActiveCellNormal();for(var e in rowsCache)removeRowFromCache(e)}function removeRowFromCache(e){var t=rowsCache[e];t&&($canvas[0].removeChild(t.rowNode),delete rowsCache[e],delete postProcessedRows[e],renderedRows--,counter_rows_removed++)}function invalidateRows(e){var t,i;if(e&&e.length)for(vScrollDir=0,t=0,i=e.length;i>t;t++)currentEditor&&activeRow===e[t]&&makeActiveCellNormal(),rowsCache[e[t]]&&removeRowFromCache(e[t])}function invalidateRow(e){invalidateRows([e])}function updateCell(e,t){var i=getCellNode(e,t);if(i){var n=columns[t],s=getDataItem(e);currentEditor&&activeRow===e&&activeCell===t?currentEditor.loadValue(s):(i.innerHTML=s?getFormatter(e,n)(e,t,getDataItemValueForColumn(s,n),n,s):"",invalidatePostProcessingResults(e))}}function updateRow(e){var t=rowsCache[e];if(t){ensureCellNodesInRowsCache(e);for(var i in t.cellNodesByColumnIdx)if(t.cellNodesByColumnIdx.hasOwnProperty(i)){i=0|i;var n=columns[i],s=getDataItem(e),a=t.cellNodesByColumnIdx[i];e===activeRow&&i===activeCell&&currentEditor?currentEditor.loadValue(s):a.innerHTML=s?getFormatter(e,n)(e,i,getDataItemValueForColumn(s,n),n,s):""}invalidatePostProcessingResults(e)}}function getViewportHeight(){return parseFloat($.css($container[0],"height",!0))-parseFloat($.css($container[0],"paddingTop",!0))-parseFloat($.css($container[0],"paddingBottom",!0))-parseFloat($.css($headerScroller[0],"height"))-getVBoxDelta($headerScroller)-(options.showTopPanel?options.topPanelHeight+getVBoxDelta($topPanelScroller):0)-(options.showHeaderRow?options.headerRowHeight+getVBoxDelta($headerRowScroller):0)}function resizeCanvas(){initialized&&(viewportH=options.autoHeight?options.rowHeight*(getDataLength()+(options.enableAddRow?1:0)):getViewportHeight(),numVisibleRows=Math.ceil(viewportH/options.rowHeight),viewportW=parseFloat($.css($container[0],"width",!0)),options.autoHeight||$viewport.height(viewportH),options.forceFitColumns&&autosizeColumns(),updateRowCount(),handleScroll(),render())}function updateRowCount(){if(initialized){numberOfRows=getDataLength()+(options.enableAddRow?1:0)+(options.leaveSpaceForNewRows?numVisibleRows-1:0);var e=viewportHasVScroll;viewportHasVScroll=!options.autoHeight&&numberOfRows*options.rowHeight>viewportH;var t=options.enableAddRow?getDataLength():getDataLength()-1;for(var i in rowsCache)i>=t&&removeRowFromCache(i);activeCellNode&&activeRow>t&&resetActiveCell();var s=h;th=Math.max(options.rowHeight*numberOfRows,viewportH-scrollbarDimensions.height),maxSupportedCssHeight>th?(h=ph=th,n=1,cj=0):(h=maxSupportedCssHeight,ph=h/100,n=Math.floor(th/ph),cj=(th-h)/(n-1)),h!==s&&($canvas.css("height",h),scrollTop=$viewport[0].scrollTop);var a=th-viewportH>=scrollTop+offset;0==th||0==scrollTop?page=offset=0:a?scrollTo(scrollTop+offset):scrollTo(th-viewportH),h!=s&&options.autoHeight&&resizeCanvas(),options.forceFitColumns&&e!=viewportHasVScroll&&autosizeColumns(),updateCanvasWidth(!1)}}function getVisibleRange(e,t){return null==e&&(e=scrollTop),null==t&&(t=scrollLeft),{top:getRowFromPosition(e),bottom:getRowFromPosition(e+viewportH)+1,leftPx:t,rightPx:t+viewportW}}function getRenderedRange(e,t){var i=getVisibleRange(e,t),n=Math.round(viewportH/options.rowHeight),s=3;return-1==vScrollDir?(i.top-=n,i.bottom+=s):1==vScrollDir?(i.top-=s,i.bottom+=n):(i.top-=s,i.bottom+=s),i.top=Math.max(0,i.top),i.bottom=Math.min(options.enableAddRow?getDataLength():getDataLength()-1,i.bottom),i.leftPx-=viewportW,i.rightPx+=viewportW,i.leftPx=Math.max(0,i.leftPx),i.rightPx=Math.min(canvasWidth,i.rightPx),i}function ensureCellNodesInRowsCache(e){var t=rowsCache[e];if(t&&t.cellRenderQueue.length)for(var i=t.rowNode.lastChild;t.cellRenderQueue.length;){var n=t.cellRenderQueue.pop();t.cellNodesByColumnIdx[n]=i,i=i.previousSibling}}function cleanUpCells(e,t){var i=0,n=rowsCache[t],s=[];for(var a in n.cellNodesByColumnIdx)if(n.cellNodesByColumnIdx.hasOwnProperty(a)){a=0|a;var r=n.cellColSpans[a];(columnPosLeft[a]>e.rightPx||columnPosRight[Math.min(columns.length-1,a+r-1)]<e.leftPx)&&(t!=activeRow||a!=activeCell)&&s.push(a)}for(var o;null!=(o=s.pop());)n.rowNode.removeChild(n.cellNodesByColumnIdx[o]),delete n.cellColSpans[o],delete n.cellNodesByColumnIdx[o],postProcessedRows[t]&&delete postProcessedRows[t][o],i++}function cleanUpAndRenderCells(e){for(var t,i,n,s=[],a=[],r=0,o=e.top;o<=e.bottom;o++)if(t=rowsCache[o]){ensureCellNodesInRowsCache(o),cleanUpCells(e,o),i=0;var l=data.getItemMetadata&&data.getItemMetadata(o);l=l&&l.columns;for(var u=0,c=columns.length;c>u&&!(columnPosLeft[u]>e.rightPx);u++)if(null==(n=t.cellColSpans[u])){if(n=1,l){var h=l[columns[u].id]||l[u];n=h&&h.colspan||1,"*"===n&&(n=c-u)}columnPosRight[Math.min(c-1,u+n-1)]>e.leftPx&&(appendCellHtml(s,o,u,n),i++),u+=n>1?n-1:0}else u+=n>1?n-1:0;i&&(r+=i,a.push(o))}if(s.length){var d=document.createElement("div");d.innerHTML=s.join("");for(var p,f;null!=(p=a.pop());){t=rowsCache[p];for(var m;null!=(m=t.cellRenderQueue.pop());)f=d.lastChild,t.rowNode.appendChild(f),t.cellNodesByColumnIdx[m]=f}}}function renderRows(e){for(var t=$canvas[0],i=[],n=[],s=!1,a=e.top;a<=e.bottom;a++)rowsCache[a]||(renderedRows++,n.push(a),rowsCache[a]={rowNode:null,cellColSpans:[],cellNodesByColumnIdx:[],cellRenderQueue:[]},appendRowHtml(i,a,e),activeCellNode&&activeRow===a&&(s=!0),counter_rows_rendered++);if(n.length){var r=document.createElement("div");r.innerHTML=i.join("");for(var a=0,o=n.length;o>a;a++)rowsCache[n[a]].rowNode=t.appendChild(r.firstChild);s&&(activeCellNode=getCellNode(activeRow,activeCell))}}function startPostProcessing(){options.enableAsyncPostRender&&(clearTimeout(h_postrender),h_postrender=setTimeout(asyncPostProcessRows,options.asyncPostRenderDelay))}function invalidatePostProcessingResults(e){delete postProcessedRows[e],postProcessFromRow=Math.min(postProcessFromRow,e),postProcessToRow=Math.max(postProcessToRow,e),startPostProcessing()}function updateRowPositions(){for(var e in rowsCache)rowsCache[e].rowNode.style.top=getRowTop(e)+"px"}function render(){if(initialized){var e=getVisibleRange(),t=getRenderedRange();cleanupRows(t),lastRenderedScrollLeft!=scrollLeft&&cleanUpAndRenderCells(t),renderRows(t),postProcessFromRow=e.top,postProcessToRow=Math.min(options.enableAddRow?getDataLength():getDataLength()-1,e.bottom),startPostProcessing(),lastRenderedScrollTop=scrollTop,lastRenderedScrollLeft=scrollLeft,h_render=null}}function handleHeaderRowScroll(){var e=$headerRowScroller[0].scrollLeft;e!=$viewport[0].scrollLeft&&($viewport[0].scrollLeft=e)}function handleScroll(){scrollTop=$viewport[0].scrollTop,scrollLeft=$viewport[0].scrollLeft;var e=Math.abs(scrollTop-prevScrollTop),t=Math.abs(scrollLeft-prevScrollLeft);if(t&&(prevScrollLeft=scrollLeft,$headerScroller[0].scrollLeft=scrollLeft,$topPanelScroller[0].scrollLeft=scrollLeft,$headerRowScroller[0].scrollLeft=scrollLeft),e)if(vScrollDir=scrollTop>prevScrollTop?1:-1,prevScrollTop=scrollTop,viewportH>e)scrollTo(scrollTop+offset);else{var i=offset;page=h==viewportH?0:Math.min(n-1,Math.floor(scrollTop*((th-viewportH)/(h-viewportH))*(1/ph))),offset=Math.round(page*cj),i!=offset&&invalidateAllRows()}(t||e)&&(h_render&&clearTimeout(h_render),(Math.abs(lastRenderedScrollTop-scrollTop)>20||Math.abs(lastRenderedScrollLeft-scrollLeft)>20)&&(options.forceSyncScrolling||Math.abs(lastRenderedScrollTop-scrollTop)<viewportH&&Math.abs(lastRenderedScrollLeft-scrollLeft)<viewportW?render():h_render=setTimeout(render,50),trigger(self.onViewportChanged,{}))),trigger(self.onScroll,{scrollLeft:scrollLeft,scrollTop:scrollTop})}function asyncPostProcessRows(){for(;postProcessToRow>=postProcessFromRow;){var e=vScrollDir>=0?postProcessFromRow++:postProcessToRow--,t=rowsCache[e];if(t&&!(e>=getDataLength())){postProcessedRows[e]||(postProcessedRows[e]={}),ensureCellNodesInRowsCache(e);for(var i in t.cellNodesByColumnIdx)if(t.cellNodesByColumnIdx.hasOwnProperty(i)){i=0|i;var n=columns[i];if(n.asyncPostRender&&!postProcessedRows[e][i]){var s=t.cellNodesByColumnIdx[i];s&&n.asyncPostRender(s,e,getDataItem(e),n),postProcessedRows[e][i]=!0}}return h_postrender=setTimeout(asyncPostProcessRows,options.asyncPostRenderDelay),void 0}}}function updateCellCssStylesOnRenderedRows(e,t){var i,n,s,a;for(var r in rowsCache){if(a=t&&t[r],s=e&&e[r],a)for(n in a)s&&a[n]==s[n]||(i=getCellNode(r,getColumnIndex(n)),i&&$(i).removeClass(a[n]));if(s)for(n in s)a&&a[n]==s[n]||(i=getCellNode(r,getColumnIndex(n)),i&&$(i).addClass(s[n]))}}function addCellCssStyles(e,t){if(cellCssClasses[e])throw"addCellCssStyles: cell CSS hash with key '"+e+"' already exists.";cellCssClasses[e]=t,updateCellCssStylesOnRenderedRows(t,null),trigger(self.onCellCssStylesChanged,{key:e,hash:t})}function removeCellCssStyles(e){cellCssClasses[e]&&(updateCellCssStylesOnRenderedRows(null,cellCssClasses[e]),delete cellCssClasses[e],trigger(self.onCellCssStylesChanged,{key:e,hash:null}))}function setCellCssStyles(e,t){var i=cellCssClasses[e];cellCssClasses[e]=t,updateCellCssStylesOnRenderedRows(t,i),trigger(self.onCellCssStylesChanged,{key:e,hash:t})}function getCellCssStyles(e){return cellCssClasses[e]}function flashCell(e,t,i){function n(e){e&&setTimeout(function(){s.queue(function(){s.toggleClass(options.cellFlashingCssClass).dequeue(),n(e-1)})},i)}if(i=i||100,rowsCache[e]){var s=$(getCellNode(e,t));n(4)}}function handleDragInit(e,t){var i=getCellFromEvent(e);if(!i||!cellExists(i.row,i.cell))return!1;var n=trigger(self.onDragInit,t,e);return e.isImmediatePropagationStopped()?n:!1}function handleDragStart(e,t){var i=getCellFromEvent(e);if(!i||!cellExists(i.row,i.cell))return!1;var n=trigger(self.onDragStart,t,e);return e.isImmediatePropagationStopped()?n:!1}function handleDrag(e,t){return trigger(self.onDrag,t,e)}function handleDragEnd(e,t){trigger(self.onDragEnd,t,e)}function handleKeyDown(e){trigger(self.onKeyDown,{row:activeRow,cell:activeCell},e);var t=e.isImmediatePropagationStopped();if(!t)if(e.shiftKey||e.altKey||e.ctrlKey)9!=e.which||!e.shiftKey||e.ctrlKey||e.altKey||(t=navigatePrev());else if(27==e.which){if(!getEditorLock().isActive())return;cancelEditAndSetFocus()}else 37==e.which?t=navigateLeft():39==e.which?t=navigateRight():38==e.which?t=navigateUp():40==e.which?t=navigateDown():9==e.which?t=navigateNext():13==e.which&&(options.editable&&(currentEditor?activeRow===getDataLength()?navigateDown():commitEditAndSetFocus():getEditorLock().commitCurrentEdit()&&makeActiveCellEditable()),t=!0);if(t){e.stopPropagation(),e.preventDefault();try{e.originalEvent.keyCode=0}catch(i){}}}function handleClick(e){currentEditor||e.target!=document.activeElement&&setFocus();var t=getCellFromEvent(e);!t||null!==currentEditor&&activeRow==t.row&&activeCell==t.cell||(trigger(self.onClick,{row:t.row,cell:t.cell},e),e.isImmediatePropagationStopped()||activeCell==t.cell&&activeRow==t.row||!canCellBeActive(t.row,t.cell)||(!getEditorLock().isActive()||getEditorLock().commitCurrentEdit())&&(scrollRowIntoView(t.row,!1),setActiveCellInternal(getCellNode(t.row,t.cell),t.row===getDataLength()||options.autoEdit)))}function handleContextMenu(e){var t=$(e.target).closest(".slick-cell",$canvas);0!==t.length&&(activeCellNode!==t[0]||null===currentEditor)&&trigger(self.onContextMenu,{},e)}function handleDblClick(e){var t=getCellFromEvent(e);!t||null!==currentEditor&&activeRow==t.row&&activeCell==t.cell||(trigger(self.onDblClick,{row:t.row,cell:t.cell},e),e.isImmediatePropagationStopped()||options.editable&&gotoCell(t.row,t.cell,!0))}function handleHeaderMouseEnter(e){trigger(self.onHeaderMouseEnter,{column:$(this).data("column")},e)}function handleHeaderMouseLeave(e){trigger(self.onHeaderMouseLeave,{column:$(this).data("column")},e)}function handleHeaderContextMenu(e){var t=$(e.target).closest(".slick-header-column",".slick-header-columns"),i=t&&t.data("column");trigger(self.onHeaderContextMenu,{column:i},e)}function handleHeaderClick(e){var t=$(e.target).closest(".slick-header-column",".slick-header-columns"),i=t&&t.data("column");i&&trigger(self.onHeaderClick,{column:i},e)}function handleMouseEnter(e){trigger(self.onMouseEnter,{},e)}function handleMouseLeave(e){trigger(self.onMouseLeave,{},e)}function cellExists(e,t){return!(0>e||e>=getDataLength()||0>t||t>=columns.length)}function getCellFromPoint(e,t){for(var i=getRowFromPosition(t),n=0,s=0,a=0;a<columns.length&&e>s;a++)s+=columns[a].width,n++;return 0>n&&(n=0),{row:i,cell:n-1}}function getCellFromNode(e){var t=/l\d+/.exec(e.className);if(!t)throw"getCellFromNode: cannot get cell - "+e.className;return parseInt(t[0].substr(1,t[0].length-1),10)}function getRowFromNode(e){for(var t in rowsCache)if(rowsCache[t].rowNode===e)return 0|t;return null}function getCellFromEvent(e){var t=$(e.target).closest(".slick-cell",$canvas);if(!t.length)return null;var i=getRowFromNode(t[0].parentNode),n=getCellFromNode(t[0]);return null==i||null==n?null:{row:i,cell:n}}function getCellNodeBox(e,t){if(!cellExists(e,t))return null;for(var i=getRowTop(e),n=i+options.rowHeight-1,s=0,a=0;t>a;a++)s+=columns[a].width;var r=s+columns[t].width;return{top:i,left:s,bottom:n,right:r}}function resetActiveCell(){setActiveCellInternal(null,!1)}function setFocus(){-1==tabbingDirection?$focusSink[0].focus():$focusSink2[0].focus()}function scrollCellIntoView(e,t,i){scrollRowIntoView(e,i);var n=getColspan(e,t),s=columnPosLeft[t],a=columnPosRight[t+(n>1?n-1:0)],r=scrollLeft+viewportW;scrollLeft>s?($viewport.scrollLeft(s),handleScroll(),render()):a>r&&($viewport.scrollLeft(Math.min(s,a-$viewport[0].clientWidth)),handleScroll(),render())}function setActiveCellInternal(e,t){null!==activeCellNode&&(makeActiveCellNormal(),$(activeCellNode).removeClass("active"),rowsCache[activeRow]&&$(rowsCache[activeRow].rowNode).removeClass("active"));var i=activeCellNode!==e;activeCellNode=e,null!=activeCellNode?(activeRow=getRowFromNode(activeCellNode.parentNode),activeCell=activePosX=getCellFromNode(activeCellNode),$(activeCellNode).addClass("active"),$(rowsCache[activeRow].rowNode).addClass("active"),options.editable&&t&&isCellPotentiallyEditable(activeRow,activeCell)&&(clearTimeout(h_editorLoader),options.asyncEditorLoading?h_editorLoader=setTimeout(function(){makeActiveCellEditable()},options.asyncEditorLoadDelay):makeActiveCellEditable())):activeRow=activeCell=null,i&&trigger(self.onActiveCellChanged,getActiveCell())}function clearTextSelection(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var e=window.getSelection();e&&e.removeAllRanges&&e.removeAllRanges()}}function isCellPotentiallyEditable(e,t){return e<getDataLength()&&!getDataItem(e)?!1:columns[t].cannotTriggerInsert&&e>=getDataLength()?!1:getEditor(e,t)?!0:!1}function makeActiveCellNormal(){if(currentEditor){if(trigger(self.onBeforeCellEditorDestroy,{editor:currentEditor}),currentEditor.destroy(),currentEditor=null,activeCellNode){var e=getDataItem(activeRow);if($(activeCellNode).removeClass("editable invalid"),e){var t=columns[activeCell],i=getFormatter(activeRow,t);activeCellNode.innerHTML=i(activeRow,activeCell,getDataItemValueForColumn(e,t),t,getDataItem(activeRow)),invalidatePostProcessingResults(activeRow)}}navigator.userAgent.toLowerCase().match(/msie/)&&clearTextSelection(),getEditorLock().deactivate(editController)}}function makeActiveCellEditable(e){if(activeCellNode){if(!options.editable)throw"Grid : makeActiveCellEditable : should never get called when options.editable is false";if(clearTimeout(h_editorLoader),isCellPotentiallyEditable(activeRow,activeCell)){var t=columns[activeCell],i=getDataItem(activeRow);if(trigger(self.onBeforeEditCell,{row:activeRow,cell:activeCell,item:i,column:t})===!1)return setFocus(),void 0;getEditorLock().activate(editController),$(activeCellNode).addClass("editable"),e||(activeCellNode.innerHTML=""),currentEditor=new(e||getEditor(activeRow,activeCell))({grid:self,gridPosition:absBox($container[0]),position:absBox(activeCellNode),container:activeCellNode,column:t,item:i||{},commitChanges:commitEditAndSetFocus,cancelChanges:cancelEditAndSetFocus}),i&&currentEditor.loadValue(i),serializedEditorValue=currentEditor.serializeValue(),currentEditor.position&&handleActiveCellPositionChange()}}}function commitEditAndSetFocus(){getEditorLock().commitCurrentEdit()&&(setFocus(),options.autoEdit&&navigateDown())}function cancelEditAndSetFocus(){getEditorLock().cancelCurrentEdit()&&setFocus()}function absBox(e){var t={top:e.offsetTop,left:e.offsetLeft,bottom:0,right:0,width:$(e).outerWidth(),height:$(e).outerHeight(),visible:!0};t.bottom=t.top+t.height,t.right=t.left+t.width;for(var i=e.offsetParent;(e=e.parentNode)!=document.body;)t.visible&&e.scrollHeight!=e.offsetHeight&&"visible"!=$(e).css("overflowY")&&(t.visible=t.bottom>e.scrollTop&&t.top<e.scrollTop+e.clientHeight),t.visible&&e.scrollWidth!=e.offsetWidth&&"visible"!=$(e).css("overflowX")&&(t.visible=t.right>e.scrollLeft&&t.left<e.scrollLeft+e.clientWidth),t.left-=e.scrollLeft,t.top-=e.scrollTop,e===i&&(t.left+=e.offsetLeft,t.top+=e.offsetTop,i=e.offsetParent),t.bottom=t.top+t.height,t.right=t.left+t.width;return t}function getActiveCellPosition(){return absBox(activeCellNode)}function getGridPosition(){return absBox($container[0])}function handleActiveCellPositionChange(){if(activeCellNode&&(trigger(self.onActiveCellPositionChanged,{}),currentEditor)){var e=getActiveCellPosition();currentEditor.show&&currentEditor.hide&&(e.visible?currentEditor.show():currentEditor.hide()),currentEditor.position&&currentEditor.position(e)}}function getCellEditor(){return currentEditor}function getActiveCell(){return activeCellNode?{row:activeRow,cell:activeCell}:null}function getActiveCellNode(){return activeCellNode}function scrollRowIntoView(e,t){var i=e*options.rowHeight,n=(e+1)*options.rowHeight-viewportH+(viewportHasHScroll?scrollbarDimensions.height:0);
(e+1)*options.rowHeight>scrollTop+viewportH+offset?(scrollTo(t?i:n),render()):e*options.rowHeight<scrollTop+offset&&(scrollTo(t?n:i),render())}function scrollRowToTop(e){scrollTo(e*options.rowHeight),render()}function getColspan(e,t){var i=data.getItemMetadata&&data.getItemMetadata(e);if(!i||!i.columns)return 1;var n=i.columns[columns[t].id]||i.columns[t],s=n&&n.colspan;return s="*"===s?columns.length-t:s||1}function findFirstFocusableCell(e){for(var t=0;t<columns.length;){if(canCellBeActive(e,t))return t;t+=getColspan(e,t)}return null}function findLastFocusableCell(e){for(var t=0,i=null;t<columns.length;)canCellBeActive(e,t)&&(i=t),t+=getColspan(e,t);return i}function gotoRight(e,t){if(t>=columns.length)return null;do t+=getColspan(e,t);while(t<columns.length&&!canCellBeActive(e,t));return t<columns.length?{row:e,cell:t,posX:t}:null}function gotoLeft(e,t){if(0>=t)return null;var i=findFirstFocusableCell(e);if(null===i||i>=t)return null;for(var n,s={row:e,cell:i,posX:i};;){if(n=gotoRight(s.row,s.cell,s.posX),!n)return null;if(n.cell>=t)return s;s=n}}function gotoDown(e,t,i){for(var n;;){if(++e>=getDataLength()+(options.enableAddRow?1:0))return null;for(n=t=0;i>=t;)n=t,t+=getColspan(e,t);if(canCellBeActive(e,n))return{row:e,cell:n,posX:i}}}function gotoUp(e,t,i){for(var n;;){if(--e<0)return null;for(n=t=0;i>=t;)n=t,t+=getColspan(e,t);if(canCellBeActive(e,n))return{row:e,cell:n,posX:i}}}function gotoNext(e,t,i){if(null==e&&null==t&&(e=t=i=0,canCellBeActive(e,t)))return{row:e,cell:t,posX:t};var n=gotoRight(e,t,i);if(n)return n;for(var s=null;++e<getDataLength()+(options.enableAddRow?1:0);)if(s=findFirstFocusableCell(e),null!==s)return{row:e,cell:s,posX:s};return null}function gotoPrev(e,t,i){if(null==e&&null==t&&(e=getDataLength()+(options.enableAddRow?1:0)-1,t=i=columns.length-1,canCellBeActive(e,t)))return{row:e,cell:t,posX:t};for(var n,s;!n&&!(n=gotoLeft(e,t,i));){if(--e<0)return null;t=0,s=findLastFocusableCell(e),null!==s&&(n={row:e,cell:s,posX:s})}return n}function navigateRight(){return navigate("right")}function navigateLeft(){return navigate("left")}function navigateDown(){return navigate("down")}function navigateUp(){return navigate("up")}function navigateNext(){return navigate("next")}function navigatePrev(){return navigate("prev")}function navigate(e){if(!options.enableCellNavigation)return!1;if(!activeCellNode&&"prev"!=e&&"next"!=e)return!1;if(!getEditorLock().commitCurrentEdit())return!0;setFocus();var t={up:-1,down:1,left:-1,right:1,prev:-1,next:1};tabbingDirection=t[e];var i={up:gotoUp,down:gotoDown,left:gotoLeft,right:gotoRight,prev:gotoPrev,next:gotoNext},n=i[e],s=n(activeRow,activeCell,activePosX);if(s){var a=s.row==getDataLength();return scrollCellIntoView(s.row,s.cell,!a),setActiveCellInternal(getCellNode(s.row,s.cell),a||options.autoEdit),activePosX=s.posX,!0}return setActiveCellInternal(getCellNode(activeRow,activeCell),activeRow==getDataLength()||options.autoEdit),!1}function getCellNode(e,t){return rowsCache[e]?(ensureCellNodesInRowsCache(e),rowsCache[e].cellNodesByColumnIdx[t]):null}function setActiveCell(e,t){initialized&&(e>getDataLength()||0>e||t>=columns.length||0>t||options.enableCellNavigation&&(scrollCellIntoView(e,t,!1),setActiveCellInternal(getCellNode(e,t),!1)))}function canCellBeActive(e,t){if(!options.enableCellNavigation||e>=getDataLength()+(options.enableAddRow?1:0)||0>e||t>=columns.length||0>t)return!1;var i=data.getItemMetadata&&data.getItemMetadata(e);if(i&&"boolean"==typeof i.focusable)return i.focusable;var n=i&&i.columns;return n&&n[columns[t].id]&&"boolean"==typeof n[columns[t].id].focusable?n[columns[t].id].focusable:n&&n[t]&&"boolean"==typeof n[t].focusable?n[t].focusable:columns[t].focusable}function canCellBeSelected(e,t){if(e>=getDataLength()||0>e||t>=columns.length||0>t)return!1;var i=data.getItemMetadata&&data.getItemMetadata(e);if(i&&"boolean"==typeof i.selectable)return i.selectable;var n=i&&i.columns&&(i.columns[columns[t].id]||i.columns[t]);return n&&"boolean"==typeof n.selectable?n.selectable:columns[t].selectable}function gotoCell(e,t,i){if(initialized&&canCellBeActive(e,t)&&getEditorLock().commitCurrentEdit()){scrollCellIntoView(e,t,!1);var n=getCellNode(e,t);setActiveCellInternal(n,i||e===getDataLength()||options.autoEdit),currentEditor||setFocus()}}function commitCurrentEdit(){var e=getDataItem(activeRow),t=columns[activeCell];if(currentEditor){if(currentEditor.isValueChanged()){var i=currentEditor.validate();if(i.valid){if(activeRow<getDataLength()){var n={row:activeRow,cell:activeCell,editor:currentEditor,serializedValue:currentEditor.serializeValue(),prevSerializedValue:serializedEditorValue,execute:function(){this.editor.applyValue(e,this.serializedValue),updateRow(this.row)},undo:function(){this.editor.applyValue(e,this.prevSerializedValue),updateRow(this.row)}};options.editCommandHandler?(makeActiveCellNormal(),options.editCommandHandler(e,t,n)):(n.execute(),makeActiveCellNormal()),trigger(self.onCellChange,{row:activeRow,cell:activeCell,item:e})}else{var s={};currentEditor.applyValue(s,currentEditor.serializeValue()),makeActiveCellNormal(),trigger(self.onAddNewRow,{item:s,column:t})}return!getEditorLock().isActive()}return $(activeCellNode).addClass("invalid"),$(activeCellNode).stop(!0,!0).effect("highlight",{color:"red"},300),trigger(self.onValidationError,{editor:currentEditor,cellNode:activeCellNode,validationResults:i,row:activeRow,cell:activeCell,column:t}),currentEditor.focus(),!1}makeActiveCellNormal()}return!0}function cancelCurrentEdit(){return makeActiveCellNormal(),!0}function rowsToRanges(e){for(var t=[],i=columns.length-1,n=0;n<e.length;n++)t.push(new Slick.Range(e[n],0,e[n],i));return t}function getSelectedRows(){if(!selectionModel)throw"Selection model is not set";return selectedRows}function setSelectedRows(e){if(!selectionModel)throw"Selection model is not set";selectionModel.setSelectedRanges(rowsToRanges(e))}var defaults={explicitInitialization:!1,rowHeight:25,defaultColumnWidth:80,enableAddRow:!1,leaveSpaceForNewRows:!1,editable:!1,autoEdit:!0,enableCellNavigation:!0,enableColumnReorder:!0,asyncEditorLoading:!1,asyncEditorLoadDelay:100,forceFitColumns:!1,enableAsyncPostRender:!1,asyncPostRenderDelay:50,autoHeight:!1,editorLock:Slick.GlobalEditorLock,showHeaderRow:!1,headerRowHeight:25,showTopPanel:!1,topPanelHeight:25,formatterFactory:null,editorFactory:null,cellFlashingCssClass:"flashing",selectedCellCssClass:"selected",multiSelect:!0,enableTextSelectionOnCells:!1,dataItemColumnValueExtractor:null,fullWidthRows:!1,multiColumnSort:!1,defaultFormatter:defaultFormatter,forceSyncScrolling:!1},columnDefaults={name:"",resizable:!0,sortable:!1,minWidth:30,rerenderOnResize:!1,headerCssClass:null,defaultSortAsc:!0,focusable:!0,selectable:!0},th,h,ph,n,cj,page=0,offset=0,vScrollDir=1,initialized=!1,$container,uid="slickgrid_"+Math.round(1e6*Math.random()),self=this,$focusSink,$focusSink2,$headerScroller,$headers,$headerRow,$headerRowScroller,$headerRowSpacer,$topPanelScroller,$topPanel,$viewport,$canvas,$style,$boundAncestors,stylesheet,columnCssRulesL,columnCssRulesR,viewportH,viewportW,canvasWidth,viewportHasHScroll,viewportHasVScroll,headerColumnWidthDiff=0,headerColumnHeightDiff=0,cellWidthDiff=0,cellHeightDiff=0,absoluteColumnMinWidth,numberOfRows=0,tabbingDirection=1,activePosX,activeRow,activeCell,activeCellNode=null,currentEditor=null,serializedEditorValue,editController,rowsCache={},renderedRows=0,numVisibleRows,prevScrollTop=0,scrollTop=0,lastRenderedScrollTop=0,lastRenderedScrollLeft=0,prevScrollLeft=0,scrollLeft=0,selectionModel,selectedRows=[],plugins=[],cellCssClasses={},columnsById={},sortColumns=[],columnPosLeft=[],columnPosRight=[],h_editorLoader=null,h_render=null,h_postrender=null,postProcessedRows={},postProcessToRow=null,postProcessFromRow=null,counter_rows_rendered=0,counter_rows_removed=0;this.debug=function(){var e="";e+="\ncounter_rows_rendered:  "+counter_rows_rendered,e+="\ncounter_rows_removed:  "+counter_rows_removed,e+="\nrenderedRows:  "+renderedRows,e+="\nnumVisibleRows:  "+numVisibleRows,e+="\nmaxSupportedCssHeight:  "+maxSupportedCssHeight,e+="\nn(umber of pages):  "+n,e+="\n(current) page:  "+page,e+="\npage height (ph):  "+ph,e+="\nvScrollDir:  "+vScrollDir,alert(e)},this.eval=function(expr){return eval(expr)},$.extend(this,{slickGridVersion:"2.1",onScroll:new Slick.Event,onSort:new Slick.Event,onHeaderMouseEnter:new Slick.Event,onHeaderMouseLeave:new Slick.Event,onHeaderContextMenu:new Slick.Event,onHeaderClick:new Slick.Event,onHeaderCellRendered:new Slick.Event,onBeforeHeaderCellDestroy:new Slick.Event,onHeaderRowCellRendered:new Slick.Event,onBeforeHeaderRowCellDestroy:new Slick.Event,onMouseEnter:new Slick.Event,onMouseLeave:new Slick.Event,onClick:new Slick.Event,onDblClick:new Slick.Event,onContextMenu:new Slick.Event,onKeyDown:new Slick.Event,onAddNewRow:new Slick.Event,onValidationError:new Slick.Event,onViewportChanged:new Slick.Event,onColumnsReordered:new Slick.Event,onColumnsResized:new Slick.Event,onCellChange:new Slick.Event,onBeforeEditCell:new Slick.Event,onBeforeCellEditorDestroy:new Slick.Event,onBeforeDestroy:new Slick.Event,onActiveCellChanged:new Slick.Event,onActiveCellPositionChanged:new Slick.Event,onDragInit:new Slick.Event,onDragStart:new Slick.Event,onDrag:new Slick.Event,onDragEnd:new Slick.Event,onSelectedRowsChanged:new Slick.Event,onCellCssStylesChanged:new Slick.Event,registerPlugin:registerPlugin,unregisterPlugin:unregisterPlugin,getColumns:getColumns,setColumns:setColumns,getColumnIndex:getColumnIndex,updateColumnHeader:updateColumnHeader,setSortColumn:setSortColumn,setSortColumns:setSortColumns,getSortColumns:getSortColumns,autosizeColumns:autosizeColumns,getOptions:getOptions,setOptions:setOptions,getData:getData,getDataLength:getDataLength,getDataItem:getDataItem,setData:setData,getSelectionModel:getSelectionModel,setSelectionModel:setSelectionModel,getSelectedRows:getSelectedRows,setSelectedRows:setSelectedRows,render:render,invalidate:invalidate,invalidateRow:invalidateRow,invalidateRows:invalidateRows,invalidateAllRows:invalidateAllRows,updateCell:updateCell,updateRow:updateRow,getViewport:getVisibleRange,getRenderedRange:getRenderedRange,resizeCanvas:resizeCanvas,updateRowCount:updateRowCount,scrollRowIntoView:scrollRowIntoView,scrollRowToTop:scrollRowToTop,scrollCellIntoView:scrollCellIntoView,getCanvasNode:getCanvasNode,focus:setFocus,getCellFromPoint:getCellFromPoint,getCellFromEvent:getCellFromEvent,getActiveCell:getActiveCell,setActiveCell:setActiveCell,getActiveCellNode:getActiveCellNode,getActiveCellPosition:getActiveCellPosition,resetActiveCell:resetActiveCell,editActiveCell:makeActiveCellEditable,getCellEditor:getCellEditor,getCellNode:getCellNode,getCellNodeBox:getCellNodeBox,canCellBeSelected:canCellBeSelected,canCellBeActive:canCellBeActive,navigatePrev:navigatePrev,navigateNext:navigateNext,navigateUp:navigateUp,navigateDown:navigateDown,navigateLeft:navigateLeft,navigateRight:navigateRight,gotoCell:gotoCell,getTopPanel:getTopPanel,setTopPanelVisibility:setTopPanelVisibility,setHeaderRowVisibility:setHeaderRowVisibility,getHeaderRow:getHeaderRow,getHeaderRowColumn:getHeaderRowColumn,getGridPosition:getGridPosition,flashCell:flashCell,addCellCssStyles:addCellCssStyles,setCellCssStyles:setCellCssStyles,removeCellCssStyles:removeCellCssStyles,getCellCssStyles:getCellCssStyles,init:finishInitialization,destroy:destroy,getEditorLock:getEditorLock,getEditController:getEditController}),init()}$.extend(!0,window,{Slick:{Grid:SlickGrid}});var scrollbarDimensions,maxSupportedCssHeight}(jQuery),function(e){function t(t){function i(e,i,n,s,a){if(!t.enableExpandCollapse)return a.title;var r=15*a.level+"px";return"<span class='"+t.toggleCssClass+" "+(a.collapsed?t.toggleCollapsedCssClass:t.toggleExpandedCssClass)+"' style='margin-left:"+r+"'>"+"</span>"+"<span class='"+t.groupTitleCssClass+"' level='"+a.level+"'>"+a.title+"</span>"}function n(e,t,i,n,s){return n.groupTotalsFormatter&&n.groupTotalsFormatter(s,n)||""}function s(e){c=e,c.onClick.subscribe(r),c.onKeyDown.subscribe(o)}function a(){c&&(c.onClick.unsubscribe(r),c.onKeyDown.unsubscribe(o))}function r(i,n){var s=this.getDataItem(n.row);s&&s instanceof Slick.Group&&e(i.target).hasClass(t.toggleCssClass)&&(s.collapsed?this.getData().expandGroup(s.groupingKey):this.getData().collapseGroup(s.groupingKey),i.stopImmediatePropagation(),i.preventDefault())}function o(i){if(t.enableExpandCollapse&&i.which==e.ui.keyCode.SPACE){var n=this.getActiveCell();if(n){var s=this.getDataItem(n.row);s&&s instanceof Slick.Group&&(s.collapsed?this.getData().expandGroup(s.groupingKey):this.getData().collapseGroup(s.groupingKey),i.stopImmediatePropagation(),i.preventDefault())}}}function l(){return{selectable:!1,focusable:t.groupFocusable,cssClasses:t.groupCssClass,columns:{0:{colspan:"*",formatter:i,editor:null}}}}function u(){return{selectable:!1,focusable:t.totalsFocusable,cssClasses:t.totalsCssClass,formatter:n,editor:null}}var c,h={groupCssClass:"slick-group",groupTitleCssClass:"slick-group-title",totalsCssClass:"slick-group-totals",groupFocusable:!0,totalsFocusable:!1,toggleCssClass:"slick-group-toggle",toggleExpandedCssClass:"expanded",toggleCollapsedCssClass:"collapsed",enableExpandCollapse:!0};return t=e.extend(!0,{},h,t),{init:s,destroy:a,getGroupRowMetadata:l,getTotalsRowMetadata:u}}e.extend(!0,window,{Slick:{Data:{GroupItemMetadataProvider:t}}})}(jQuery),function(e){function t(t){function i(){bt=!0}function n(){bt=!1,tt()}function s(e){wt=e}function a(e){ot=e}function r(e){e=e||0;for(var t,i=e,n=pt.length;n>i;i++){if(t=pt[i][dt],void 0===t)throw"Each data element must implement a unique 'id' property";mt[t]=i}}function o(){for(var e,t=0,i=pt.length;i>t;t++)if(e=pt[t][dt],void 0===e||mt[e]!==t)throw"Each data element must implement a unique 'id' property"}function l(){return pt}function u(e,t){void 0!==t&&(dt=t),pt=kt=e,mt={},r(),o(),tt()}function c(e){void 0!=e.pageSize&&(Et=e.pageSize,jt=Et?Math.min(jt,Math.max(0,Math.ceil(Nt/Et)-1)):0),void 0!=e.pageNum&&(jt=Math.min(e.pageNum,Math.max(0,Math.ceil(Nt/Et)-1))),It.notify(h(),null,ct),tt()}function h(){var e=Et?Math.max(1,Math.ceil(Nt/Et)):1;return{pageSize:Et,pageNum:jt,totalRows:Nt,totalPages:e}}function d(e,t){_t=t,rt=e,at=null,t===!1&&pt.reverse(),pt.sort(e),t===!1&&pt.reverse(),mt={},r(),tt()}function p(e,t){_t=t,at=e,rt=null;var i=Object.prototype.toString;Object.prototype.toString="function"==typeof e?e:function(){return this[e]},t===!1&&pt.reverse(),pt.sort(),Object.prototype.toString=i,t===!1&&pt.reverse(),mt={},r(),tt()}function f(){rt?d(rt,_t):at&&p(at,_t)}function m(e){yt=e,t.inlineFilters&&(lt=$(),ut=X()),tt()}function g(){return St}function y(i){t.groupItemMetadataProvider||(t.groupItemMetadataProvider=new Slick.Data.GroupItemMetadataProvider),Ct=[],Mt=[],i=i||[],St=i instanceof Array?i:[i];for(var n=0;n<St.length;n++){var s=St[n]=e.extend(!0,{},xt,St[n]);s.getterIsAFn="function"==typeof s.getter,s.compiledAccumulators=[];for(var a=s.aggregators.length;a--;)s.compiledAccumulators[a]=Q(s.aggregators[a]);Mt[n]={}}tt()}function v(e,t,i){return null==e?(y([]),void 0):(y({getter:e,formatter:t,comparer:i}),void 0)}function b(e,t){if(!St.length)throw new Error("At least one grouping must be specified before calling setAggregators().");St[0].aggregators=e,St[0].aggregateCollapsed=t,y(St)}function _(e){return pt[e]}function w(e){return mt[e]}function L(){if(!gt){gt={};for(var e=0,t=ft.length;t>e;e++)gt[ft[e][dt]]=e}}function k(e){return L(),gt[e]}function O(e){return pt[mt[e]]}function x(e){var t=[];L();for(var i=0;i<e.length;i++){var n=gt[e[i]];null!=n&&(t[t.length]=n)}return t}function S(e){for(var t=[],i=0;i<e.length;i++)e[i]<ft.length&&(t[t.length]=ft[e[i]][dt]);return t}function C(e,t){if(void 0===mt[e]||e!==t[dt])throw"Invalid or non-matching id";pt[mt[e]]=t,vt||(vt={}),vt[e]=!0,tt()}function M(e,t){pt.splice(e,0,t),r(e),tt()}function P(e){pt.push(e),r(pt.length-1),tt()}function E(e){var t=mt[e];if(void 0===t)throw"Invalid id";delete mt[e],pt.splice(t,1),r(t),tt()}function j(){return ft.length}function N(e){return ft[e]}function z(e){var i=ft[e];return void 0===i?null:i.__group?t.groupItemMetadataProvider.getGroupRowMetadata(i):i.__groupTotals?t.groupItemMetadataProvider.getTotalsRowMetadata(i):null}function T(e,t){if(null==e)for(var i=0;i<St.length;i++)Mt[i]={},St[i].collapsed=t;else Mt[e]={},St[e].collapsed=t;tt()}function I(e){T(e,!0)}function R(e){T(e,!1)}function F(e,t,i){Mt[e][t]=St[e].collapsed^i,tt()}function B(){var e=Array.prototype.slice.call(arguments),t=e[0];1==e.length&&-1!=t.indexOf(Pt)?F(t.split(Pt).length-1,t,!0):F(e.length-1,e.join(Pt),!0)}function A(){var e=Array.prototype.slice.call(arguments),t=e[0];1==e.length&&-1!=t.indexOf(Pt)?F(t.split(Pt).length-1,t,!1):F(e.length-1,e.join(Pt),!1)}function D(){return Ct}function q(e,t){for(var i,n,s,a=[],r=[],o=t?t.level+1:0,l=St[o],u=0,c=l.predefinedValues.length;c>u;u++)n=l.predefinedValues[u],i=r[n],i||(i=new Slick.Group,i.value=n,i.level=o,i.groupingKey=(t?t.groupingKey+Pt:"")+n,a[a.length]=i,r[n]=i);for(var u=0,c=e.length;c>u;u++)s=e[u],n=l.getterIsAFn?l.getter(s):s[l.getter],i=r[n],i||(i=new Slick.Group,i.value=n,i.level=o,i.groupingKey=(t?t.groupingKey+Pt:"")+n,a[a.length]=i,r[n]=i),i.rows[i.count++]=s;if(o<St.length-1)for(var u=0;u<a.length;u++)i=a[u],i.groups=q(i.rows,i);return a.sort(St[o].comparer),a}function H(e){for(var t,i=St[e.level],n=e.level==St.length,s=new Slick.GroupTotals,a=i.aggregators.length;a--;)t=i.aggregators[a],t.init(),i.compiledAccumulators[a].call(t,!n&&i.aggregateChildGroups?e.groups:e.rows),t.storeResult(s);s.group=e,e.totals=s}function U(e,t){t=t||0;for(var i,n=St[t],s=e.length;s--;)i=e[s],(!i.collapsed||n.aggregateCollapsed)&&(i.groups&&U(i.groups,t+1),n.aggregators.length&&(n.aggregateEmpty||i.rows.length||i.groups&&i.groups.length)&&H(i))}function G(e,t){t=t||0;for(var i,n=St[t],s=n.collapsed,a=Mt[t],r=e.length;r--;)i=e[r],i.collapsed=s^a[i.groupingKey],i.title=n.formatter?n.formatter(i):i.value,i.groups&&(G(i.groups,t+1),i.rows=[])}function V(e,t){t=t||0;for(var i,n,s=St[t],a=[],r=0,o=0,l=e.length;l>o;o++){if(n=e[o],a[r++]=n,!n.collapsed){i=n.groups?V(n.groups,t+1):n.rows;for(var u=0,c=i.length;c>u;u++)a[r++]=i[u]}n.totals&&s.displayTotalsRow&&(!n.collapsed||s.aggregateCollapsed)&&(a[r++]=n.totals)}return a}function W(e){var t=/^function[^(]*\(([^)]*)\)\s*{([\s\S]*)}$/,i=e.toString().match(t);return{params:i[1].split(","),body:i[2]}}function Q(e){var t=W(e.accumulate),i=new Function("_items","for (var "+t.params[0]+", _i=0, _il=_items.length; _i<_il; _i++) {"+t.params[0]+" = _items[_i]; "+t.body+"}");return i.displayName=i.name="compiledAccumulatorLoop",i}function $(){var e=W(yt),t=e.body.replace(/return false[;}]/gi,"{ continue _coreloop; }").replace(/return true[;}]/gi,"{ _retval[_idx++] = $item$; continue _coreloop; }").replace(/return ([^;}]+?);/gi,"{ if ($1) { _retval[_idx++] = $item$; }; continue _coreloop; }"),i=["var _retval = [], _idx = 0; ","var $item$, $args$ = _args; ","_coreloop: ","for (var _i = 0, _il = _items.length; _i < _il; _i++) { ","$item$ = _items[_i]; ","$filter$; ","} ","return _retval; "].join("");i=i.replace(/\$filter\$/gi,t),i=i.replace(/\$item\$/gi,e.params[0]),i=i.replace(/\$args\$/gi,e.params[1]);var n=new Function("_items,_args",i);return n.displayName=n.name="compiledFilter",n}function X(){var e=W(yt),t=e.body.replace(/return false[;}]/gi,"{ continue _coreloop; }").replace(/return true[;}]/gi,"{ _cache[_i] = true;_retval[_idx++] = $item$; continue _coreloop; }").replace(/return ([^;}]+?);/gi,"{ if ((_cache[_i] = $1)) { _retval[_idx++] = $item$; }; continue _coreloop; }"),i=["var _retval = [], _idx = 0; ","var $item$, $args$ = _args; ","_coreloop: ","for (var _i = 0, _il = _items.length; _i < _il; _i++) { ","$item$ = _items[_i]; ","if (_cache[_i]) { ","_retval[_idx++] = $item$; ","continue _coreloop; ","} ","$filter$; ","} ","return _retval; "].join("");i=i.replace(/\$filter\$/gi,t),i=i.replace(/\$item\$/gi,e.params[0]),i=i.replace(/\$args\$/gi,e.params[1]);var n=new Function("_items,_args,_cache",i);return n.displayName=n.name="compiledFilterWithCaching",n}function K(e,t){for(var i=[],n=0,s=0,a=e.length;a>s;s++)yt(e[s],t)&&(i[n++]=e[s]);return i}function Y(e,t,i){for(var n,s=[],a=0,r=0,o=e.length;o>r;r++)n=e[r],i[r]?s[a++]=n:yt(n,t)&&(s[a++]=n,i[r]=!0);return s}function Z(e){if(yt){var i=t.inlineFilters?lt:K,n=t.inlineFilters?ut:Y;wt.isFilterNarrowing?kt=i(kt,ot):wt.isFilterExpanding?kt=n(e,ot,Ot):wt.isFilterUnchanged||(kt=i(e,ot))}else kt=Et?e:e.concat();var s;return Et?(kt.length<jt*Et&&(jt=Math.floor(kt.length/Et)),s=kt.slice(Et*jt,Et*jt+Et)):s=kt,{totalRows:kt.length,rows:s}}function J(e,t){var i,n,s,a=[],r=0,o=t.length;wt&&wt.ignoreDiffsBefore&&(r=Math.max(0,Math.min(t.length,wt.ignoreDiffsBefore))),wt&&wt.ignoreDiffsAfter&&(o=Math.min(t.length,Math.max(0,wt.ignoreDiffsAfter)));for(var l=r,u=e.length;o>l;l++)l>=u?a[a.length]=l:(i=t[l],n=e[l],(St.length&&(s=i.__nonDataRow||n.__nonDataRow)&&i.__group!==n.__group||i.__group&&!i.equals(n)||s&&(i.__groupTotals||n.__groupTotals)||i[dt]!=n[dt]||vt&&vt[i[dt]])&&(a[a.length]=l));return a}function et(e){gt=null,(wt.isFilterNarrowing!=Lt.isFilterNarrowing||wt.isFilterExpanding!=Lt.isFilterExpanding)&&(Ot=[]);var t=Z(e);Nt=t.totalRows;var i=t.rows;Ct=[],St.length&&(Ct=q(i),Ct.length&&(U(Ct),G(Ct),i=V(Ct)));var n=J(ft,i);return ft=i,n}function tt(){if(!bt){var t=ft.length,i=Nt,n=et(pt,yt);if(Et&&jt*Et>Nt&&(jt=Math.max(0,Math.ceil(Nt/Et)-1),n=et(pt,yt)),vt=null,Lt=wt,wt={},i!=Nt&&It.notify(h(),null,ct),t!=ft.length&&zt.notify({previous:t,current:ft.length},null,ct),n.length>0&&Tt.notify({rows:n},null,ct),ct.totalsCallback){var s=e.extend(!0,{},Ct);ct.totalsCallback(s)}}}function it(e){ct.totalsCallback=e}function nt(e,t){function i(){if(a.length>0){n=!0;var i=s.mapIdsToRows(a);t||(a=s.mapRowsToIds(i)),e.setSelectedRows(i),n=!1}}var n,s=this,a=s.mapRowsToIds(e.getSelectedRows());e.onSelectedRowsChanged.subscribe(function(){n||(a=s.mapRowsToIds(e.getSelectedRows()))}),this.onRowsChanged.subscribe(i),this.onRowCountChanged.subscribe(i)}function st(e,t){function i(e){s={};for(var t in e){var i=ft[t][dt];s[i]=e[t]}}function n(){if(s){a=!0,L();var i={};for(var n in s){var r=gt[n];void 0!=r&&(i[r]=s[n])}e.setCellCssStyles(t,i),a=!1}}var s,a;i(e.getCellCssStyles(t)),e.onCellCssStylesChanged.subscribe(function(e,n){a||t==n.key&&i(n.hash)}),this.onRowsChanged.subscribe(n),this.onRowCountChanged.subscribe(n)}var at,rt,ot,lt,ut,ct=this,ht={groupItemMetadataProvider:null,inlineFilters:!1},dt="id",pt=[],ft=[],mt={},gt=null,yt=null,vt=null,bt=!1,_t=!0,wt={},Lt={},kt=[],Ot=[],xt={getter:null,formatter:null,comparer:function(e,t){return e.value-t.value},predefinedValues:[],aggregators:[],aggregateEmpty:!1,aggregateCollapsed:!1,aggregateChildGroups:!1,collapsed:!1,displayTotalsRow:!0},St=[],Ct=[],Mt=[],Pt=":|:",Et=0,jt=0,Nt=0,zt=new Slick.Event,Tt=new Slick.Event,It=new Slick.Event;return t=e.extend(!0,{},ht,t),{beginUpdate:i,endUpdate:n,setPagingOptions:c,getPagingInfo:h,getItems:l,setItems:u,setFilter:m,sort:d,fastSort:p,reSort:f,setGrouping:y,getGrouping:g,groupBy:v,setAggregators:b,collapseAllGroups:I,expandAllGroups:R,collapseGroup:B,expandGroup:A,getGroups:D,getIdxById:w,getRowById:k,getItemById:O,getItemByIdx:_,mapRowsToIds:S,mapIdsToRows:x,setRefreshHints:s,setFilterArgs:a,refresh:tt,updateItem:C,insertItem:M,addItem:P,deleteItem:E,syncGridSelection:nt,syncGridCellCssStyles:st,setTotalsCallback:it,getLength:j,getItem:N,getItemMetadata:z,onRowCountChanged:zt,onRowsChanged:Tt,onPagingInfoChanged:It}}function i(e){this.field_=e,this.init=function(){this.count_=0,this.nonNullCount_=0,this.sum_=0},this.accumulate=function(e){var t=e[this.field_];this.count_++,null!=t&&""!==t&&0/0!==t&&(this.nonNullCount_++,this.sum_+=parseFloat(t))},this.storeResult=function(e){e.avg||(e.avg={}),0!=this.nonNullCount_&&(e.avg[this.field_]=this.sum_/this.nonNullCount_)}}function n(e){this.field_=e,this.init=function(){this.min_=null},this.accumulate=function(e){var t=e[this.field_];null!=t&&""!==t&&0/0!==t&&(null==this.min_||t<this.min_)&&(this.min_=t)},this.storeResult=function(e){e.min||(e.min={}),e.min[this.field_]=this.min_}}function s(e){this.field_=e,this.init=function(){this.max_=null},this.accumulate=function(e){var t=e[this.field_];null!=t&&""!==t&&0/0!==t&&(null==this.max_||t>this.max_)&&(this.max_=t)},this.storeResult=function(e){e.max||(e.max={}),e.max[this.field_]=this.max_}}function a(e){this.field_=e,this.init=function(){this.sum_=null},this.accumulate=function(e){var t=e[this.field_];null!=t&&""!==t&&0/0!==t&&(this.sum_+=parseFloat(t))},this.storeResult=function(e){e.sum||(e.sum={}),e.sum[this.field_]=this.sum_}}function r(e){this.field_=e,this.init=function(){this.pairs_=[]},this.accumulate=function(e){var t=e[this.field_],i=!1;if(null!=t&&""!==t&&0/0!==t){for(var n=0;n<this.pairs_.length;n++)if(this.pairs_[n].value==t){this.pairs_[n].count++,i=!0;break}i||this.pairs_.push({value:t,count:1})}},this.storeResult=function(e){e.mde||(e.mde={});for(var t=0,i=0;i<this.pairs_.length;i++)(this.pairs_[i].count>this.pairs_[t].count||this.pairs_[i].count===this.pairs_[t].count&&this.pairs_[i].value<this.pairs_[t].value)&&(t=i);"undefined"!=typeof this.pairs_[t]&&(e.mde[this.field_]=this.pairs_[t].value)}}function o(e){this.field_=e,this.init=function(){this.sorted_=[]},this.accumulate=function(e){var t=e[this.field_],i=!1;if(null!=t&&""!==t&&0/0!==t){for(var n=0;n<this.sorted_.length;n++)if(t<this.sorted_[n]){this.sorted_.splice(n,0,t),i=!0;break}i||this.sorted_.push(t)}},this.storeResult=function(e){e.mdn||(e.mdn={});var t=this.sorted_.length;if(1==t%2)e.mdn[this.field_]=this.sorted_[(t-1)/2];else{var i=t/2;e.mdn[this.field_]=.5*(this.sorted_[i]+this.sorted_[i-1])}}}function l(e){this.field_=e,this.init=function(){this.nonNullCount_=0,this.Mk_=null,this.Qk_=0},this.accumulate=function(e){var t=e[this.field_];null!=t&&""!==t&&0/0!==t&&(this.nonNullCount_++,null!=this.Mk_?(this.Qk_=this.Qk_+(this.nonNullCount_-1)*Math.pow(t-this.Mk_,2)/this.nonNullCount_,this.Mk_=this.Mk_+(t-this.Mk_)/this.nonNullCount_):this.Mk_=t)},this.storeResult=function(e){e.std||(e.std={}),0!=this.nonNullCount_&&(e.std[this.field_]=Math.sqrt(this.Qk_/this.nonNullCount_))}}e.extend(!0,window,{Slick:{Data:{DataView:t,Aggregators:{Avg:i,Mde:r,Mdn:o,Min:n,Max:s,Sum:a,Std:l}}}})}(jQuery),function(e){function t(t,i,n){function s(){t.onPagingInfoChanged.subscribe(function(e,t){d(t)}),h(),d(t.getPagingInfo())}function a(){var e=!Slick.GlobalEditorLock.commitCurrentEdit(),i=t.getPagingInfo(),n=i.totalPages-1;return{canGotoFirst:!e&&0!=i.pageSize&&i.pageNum>0,canGotoLast:!e&&0!=i.pageSize&&i.pageNum!=n,canGotoPrev:!e&&0!=i.pageSize&&i.pageNum>0,canGotoNext:!e&&0!=i.pageSize&&i.pageNum<n,pagingInfo:i}}function r(e){t.setRefreshHints({isFilterUnchanged:!0}),t.setPagingOptions({pageSize:e})}function o(){a().canGotoFirst&&t.setPagingOptions({pageNum:0})}function l(){var e=a();e.canGotoLast&&t.setPagingOptions({pageNum:e.pagingInfo.totalPages-1})}function u(){var e=a();e.canGotoPrev&&t.setPagingOptions({pageNum:e.pagingInfo.pageNum-1})}function c(){var e=a();e.canGotoNext&&t.setPagingOptions({pageNum:e.pagingInfo.pageNum+1})}function h(){n.empty();var t=e("<span class='slick-pager-nav' />").appendTo(n),s=e("<span class='slick-pager-settings' />").appendTo(n);p=e("<span class='slick-pager-status' />").appendTo(n),s.append("<span class='slick-pager-settings-expanded' style='display:none'>Show: <a data=0>All</a><a data='-1'>Auto</a><a data=25>25</a><a data=50>50</a><a data=100>100</a></span>"),s.find("a[data]").click(function(t){var n=e(t.target).attr("data");if(void 0!=n)if(-1==n){var s=i.getViewport();r(s.bottom-s.top)}else r(parseInt(n))});var a="<span class='ui-state-default ui-corner-all ui-icon-container'><span class='ui-icon ",h="' /></span>";e(a+"ui-icon-lightbulb"+h).click(function(){e(".slick-pager-settings-expanded").toggle()}).appendTo(s),e(a+"ui-icon-seek-first"+h).click(o).appendTo(t),e(a+"ui-icon-seek-prev"+h).click(u).appendTo(t),e(a+"ui-icon-seek-next"+h).click(c).appendTo(t),e(a+"ui-icon-seek-end"+h).click(l).appendTo(t),n.find(".ui-icon-container").hover(function(){e(this).toggleClass("ui-state-hover")}),n.children().wrapAll("<div class='slick-pager' />")}function d(e){var t=a();n.find(".slick-pager-nav span").removeClass("ui-state-disabled"),t.canGotoFirst||n.find(".ui-icon-seek-first").addClass("ui-state-disabled"),t.canGotoLast||n.find(".ui-icon-seek-end").addClass("ui-state-disabled"),t.canGotoNext||n.find(".ui-icon-seek-next").addClass("ui-state-disabled"),t.canGotoPrev||n.find(".ui-icon-seek-prev").addClass("ui-state-disabled"),0==e.pageSize?p.text("Showing all "+e.totalRows+" rows"):p.text("Showing page "+(e.pageNum+1)+" of "+e.totalPages)}var p;s()}e.extend(!0,window,{Slick:{Controls:{Pager:t}}})}(jQuery),function(e){function t(t,i,n){function s(){i.onHeaderContextMenu.subscribe(a),i.onColumnsReordered.subscribe(r),n=e.extend({},h,n),u=e("<span class='slick-columnpicker' style='display:none;position:absolute;z-index:20;' />").appendTo(document.body),u.bind("mouseleave",function(){e(this).fadeOut(n.fadeSpeed)}),u.bind("click",o)}function a(s){s.preventDefault(),u.empty(),r(),c=[];for(var a,o,l=0;l<t.length;l++)a=e("<li />").appendTo(u),o=e("<input type='checkbox' />").data("column-id",t[l].id),c.push(o),null!=i.getColumnIndex(t[l].id)&&o.attr("checked","checked"),e("<label />").text(t[l].name).prepend(o).appendTo(a);e("<hr/>").appendTo(u),a=e("<li />").appendTo(u),o=e("<input type='checkbox' />").data("option","autoresize"),e("<label />").text("Force fit columns").prepend(o).appendTo(a),i.getOptions().forceFitColumns&&o.attr("checked","checked"),a=e("<li />").appendTo(u),o=e("<input type='checkbox' />").data("option","syncresize"),e("<label />").text("Synchronous resize").prepend(o).appendTo(a),i.getOptions().syncColumnCellResize&&o.attr("checked","checked"),u.css("top",s.pageY-10).css("left",s.pageX-10).fadeIn(n.fadeSpeed)}function r(){for(var e=i.getColumns().slice(0),n=new Array(t.length),s=0;s<n.length;s++)n[s]=void 0===i.getColumnIndex(t[s].id)?t[s]:e.shift();t=n}function o(n){if("autoresize"==e(n.target).data("option"))return n.target.checked?(i.setOptions({forceFitColumns:!0}),i.autosizeColumns()):i.setOptions({forceFitColumns:!1}),void 0;if("syncresize"==e(n.target).data("option"))return n.target.checked?i.setOptions({syncColumnCellResize:!0}):i.setOptions({syncColumnCellResize:!1}),void 0;if(e(n.target).is(":checkbox")){var s=[];if(e.each(c,function(i){e(this).is(":checked")&&s.push(t[i])}),!s.length)return e(n.target).attr("checked","checked"),void 0;i.setColumns(s)}}function l(){return t}var u,c,h={fadeSpeed:250};return s(),{getAllColumns:l}}e.extend(!0,window,{Slick:{Controls:{ColumnPicker:t}}})}(jQuery),function(){var e;e=function(){function e(){this.options_index=0,this.parsed=[]}return e.prototype.add_node=function(e){return"OPTGROUP"===e.nodeName.toUpperCase()?this.add_group(e):this.add_option(e)},e.prototype.add_group=function(e){var t,i,n,s,a,r;for(t=this.parsed.length,this.parsed.push({array_index:t,group:!0,label:e.label,children:0,disabled:e.disabled}),a=e.childNodes,r=[],n=0,s=a.length;s>n;n++)i=a[n],r.push(this.add_option(i,t,e.disabled));return r},e.prototype.add_option=function(e,t,i){return"OPTION"===e.nodeName.toUpperCase()?(""!==e.text?(null!=t&&(this.parsed[t].children+=1),this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:e.value,text:e.text,html:e.innerHTML,selected:e.selected,disabled:i===!0?i:e.disabled,group_array_index:t,classes:e.className,style:e.style.cssText})):this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:!0}),this.options_index+=1):void 0},e}(),e.select_to_array=function(t){var i,n,s,a,r;for(n=new e,r=t.childNodes,s=0,a=r.length;a>s;s++)i=r[s],n.add_node(i);return n.parsed},this.SelectParser=e}.call(this),function(){var e,t;t=this,e=function(){function e(e,t){this.form_field=e,this.options=null!=t?t:{},this.is_multiple=this.form_field.multiple,this.set_default_text(),this.set_default_values(),this.setup(),this.set_up_html(),this.register_observers(),this.finish_setup()
}return e.prototype.set_default_values=function(){var e=this;return this.click_test_action=function(t){return e.test_active_click(t)},this.activate_action=function(t){return e.activate_field(t)},this.active_field=!1,this.mouse_on_container=!1,this.results_showing=!1,this.result_highlighted=null,this.result_single_selected=null,this.allow_single_deselect=null!=this.options.allow_single_deselect&&null!=this.form_field.options[0]&&""===this.form_field.options[0].text?this.options.allow_single_deselect:!1,this.disable_search_threshold=this.options.disable_search_threshold||0,this.disable_search=this.options.disable_search||!1,this.enable_split_word_search=null!=this.options.enable_split_word_search?this.options.enable_split_word_search:!0,this.search_contains=this.options.search_contains||!1,this.choices=0,this.single_backstroke_delete=this.options.single_backstroke_delete||!1,this.max_selected_options=this.options.max_selected_options||1/0,this.inherit_select_classes=this.options.inherit_select_classes||!1},e.prototype.set_default_text=function(){return this.default_text=this.form_field.getAttribute("data-placeholder")?this.form_field.getAttribute("data-placeholder"):this.is_multiple?this.options.placeholder_text_multiple||this.options.placeholder_text||"Select Some Options":this.options.placeholder_text_single||this.options.placeholder_text||"Select an Option",this.results_none_found=this.form_field.getAttribute("data-no_results_text")||this.options.no_results_text||"No results match"},e.prototype.mouse_enter=function(){return this.mouse_on_container=!0},e.prototype.mouse_leave=function(){return this.mouse_on_container=!1},e.prototype.input_focus=function(){var e=this;if(this.is_multiple){if(!this.active_field)return setTimeout(function(){return e.container_mousedown()},50)}else if(!this.active_field)return this.activate_field()},e.prototype.input_blur=function(){var e=this;return this.mouse_on_container?void 0:(this.active_field=!1,setTimeout(function(){return e.blur_test()},100))},e.prototype.result_add_option=function(e){var t,i;return e.disabled?"":(e.dom_id=this.container_id+"_o_"+e.array_index,t=e.selected&&this.is_multiple?[]:["active-result"],e.selected&&t.push("result-selected"),null!=e.group_array_index&&t.push("group-option"),""!==e.classes&&t.push(e.classes),i=""!==e.style.cssText?' style="'+e.style+'"':"",'<li id="'+e.dom_id+'" class="'+t.join(" ")+'"'+i+">"+e.html+"</li>")},e.prototype.results_update_field=function(){return this.set_default_text(),this.is_multiple||this.results_reset_cleanup(),this.result_clear_highlight(),this.result_single_selected=null,this.results_build()},e.prototype.results_toggle=function(){return this.results_showing?this.results_hide():this.results_show()},e.prototype.results_search=function(){return this.results_showing?this.winnow_results():this.results_show()},e.prototype.keyup_checker=function(e){var t,i;switch(t=null!=(i=e.which)?i:e.keyCode,this.search_field_scale(),t){case 8:if(this.is_multiple&&this.backstroke_length<1&&this.choices>0)return this.keydown_backstroke();if(!this.pending_backstroke)return this.result_clear_highlight(),this.results_search();break;case 13:if(e.preventDefault(),this.results_showing)return this.result_select(e);break;case 27:return this.results_showing&&this.results_hide(),!0;case 9:case 38:case 40:case 16:case 91:case 17:break;default:return this.results_search()}},e.prototype.generate_field_id=function(){var e;return e=this.generate_random_id(),this.form_field.id=e,e},e.prototype.generate_random_char=function(){var e,t,i;return e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=Math.floor(Math.random()*e.length),t=e.substring(i,i+1)},e}(),t.AbstractChosen=e}.call(this),function(){var e,t,i,n,s={}.hasOwnProperty,a=function(e,t){function i(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};n=this,e=jQuery,e.fn.extend({chosen:function(i){var n,s,a;return a=navigator.userAgent.toLowerCase(),s=/(msie) ([\w.]+)/.exec(a)||[],n={name:s[1]||"",version:s[2]||"0"},"msie"===n.name&&("6.0"===n.version||"7.0"===n.version&&7===document.documentMode)?this:this.each(function(){var n;return n=e(this),n.hasClass("chzn-done")?void 0:n.data("chosen",new t(this,i))})}}),t=function(t){function s(){return s.__super__.constructor.apply(this,arguments)}return a(s,t),s.prototype.setup=function(){return this.form_field_jq=e(this.form_field),this.current_value=this.form_field_jq.val(),this.is_rtl=this.form_field_jq.hasClass("chzn-rtl")},s.prototype.finish_setup=function(){return this.form_field_jq.addClass("chzn-done")},s.prototype.set_up_html=function(){var t,n,s,a,r,o;return this.container_id=this.form_field.id.length?this.form_field.id.replace(/[^\w]/g,"_"):this.generate_field_id(),this.container_id+="_chzn",t=["chzn-container"],t.push("chzn-container-"+(this.is_multiple?"multi":"single")),this.inherit_select_classes&&this.form_field.className&&t.push(this.form_field.className),this.is_rtl&&t.push("chzn-rtl"),this.f_width=this.form_field_jq.outerWidth(),s={id:this.container_id,"class":t.join(" "),style:"width: "+this.f_width+"px;",title:this.form_field.title},n=e("<div />",s),this.is_multiple?n.html('<ul class="chzn-choices"><li class="search-field"><input type="text" value="'+this.default_text+'" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chzn-drop" style="left:-9000px;"><ul class="chzn-results"></ul></div>'):n.html('<a href="javascript:void(0)" class="chzn-single chzn-default" tabindex="-1"><span>'+this.default_text+'</span><div><b></b></div></a><div class="chzn-drop" style="left:-9000px;"><div class="chzn-search"><input type="text" autocomplete="off" /></div><ul class="chzn-results"></ul></div>'),this.form_field_jq.hide().after(n),this.container=n,this.dropdown=this.container.find("div.chzn-drop").first(),a=this.container.height(),r=this.f_width-i(this.dropdown),this.dropdown.css({width:r+"px",top:a+"px"}),this.search_field=this.container.find("input").first(),this.search_results=this.container.find("ul.chzn-results").first(),this.search_field_scale(),this.search_no_results=this.container.find("li.no-results").first(),this.is_multiple?(this.search_choices=this.container.find("ul.chzn-choices").first(),this.search_container=this.container.find("li.search-field").first()):(this.search_container=this.container.find("div.chzn-search").first(),this.selected_item=this.container.find(".chzn-single").first(),o=r-i(this.search_container)-i(this.search_field),this.search_field.css({width:o+"px"})),this.results_build(),this.set_tab_index(),this.form_field_jq.trigger("liszt:ready",{chosen:this})},s.prototype.register_observers=function(){var e=this;return this.container.mousedown(function(t){e.container_mousedown(t)}),this.container.mouseup(function(t){e.container_mouseup(t)}),this.container.mouseenter(function(t){e.mouse_enter(t)}),this.container.mouseleave(function(t){e.mouse_leave(t)}),this.search_results.mouseup(function(t){e.search_results_mouseup(t)}),this.search_results.mouseover(function(t){e.search_results_mouseover(t)}),this.search_results.mouseout(function(t){e.search_results_mouseout(t)}),this.form_field_jq.bind("liszt:updated",function(t){e.results_update_field(t)}),this.form_field_jq.bind("liszt:activate",function(t){e.activate_field(t)}),this.form_field_jq.bind("liszt:open",function(t){e.container_mousedown(t)}),this.search_field.blur(function(t){e.input_blur(t)}),this.search_field.keyup(function(t){e.keyup_checker(t)}),this.search_field.keydown(function(t){e.keydown_checker(t)}),this.search_field.focus(function(t){e.input_focus(t)}),this.is_multiple?this.search_choices.click(function(t){e.choices_click(t)}):this.container.click(function(e){e.preventDefault()})},s.prototype.search_field_disabled=function(){return this.is_disabled=this.form_field_jq[0].disabled,this.is_disabled?(this.container.addClass("chzn-disabled"),this.search_field[0].disabled=!0,this.is_multiple||this.selected_item.unbind("focus",this.activate_action),this.close_field()):(this.container.removeClass("chzn-disabled"),this.search_field[0].disabled=!1,this.is_multiple?void 0:this.selected_item.bind("focus",this.activate_action))},s.prototype.container_mousedown=function(t){var i;return this.is_disabled?void 0:(i=null!=t?e(t.target).hasClass("search-choice-close"):!1,t&&"mousedown"===t.type&&!this.results_showing&&t.preventDefault(),this.pending_destroy_click||i?this.pending_destroy_click=!1:(this.active_field?this.is_multiple||!t||e(t.target)[0]!==this.selected_item[0]&&!e(t.target).parents("a.chzn-single").length||(t.preventDefault(),this.results_toggle()):(this.is_multiple&&this.search_field.val(""),e(document).click(this.click_test_action),this.results_show()),this.activate_field()))},s.prototype.container_mouseup=function(e){return"ABBR"!==e.target.nodeName||this.is_disabled?void 0:this.results_reset(e)},s.prototype.blur_test=function(){return!this.active_field&&this.container.hasClass("chzn-container-active")?this.close_field():void 0},s.prototype.close_field=function(){return e(document).unbind("click",this.click_test_action),this.active_field=!1,this.results_hide(),this.container.removeClass("chzn-container-active"),this.winnow_results_clear(),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()},s.prototype.activate_field=function(){return this.container.addClass("chzn-container-active"),this.active_field=!0,this.search_field.val(this.search_field.val()),this.search_field.focus()},s.prototype.test_active_click=function(t){return e(t.target).parents("#"+this.container_id).length?this.active_field=!0:this.close_field()},s.prototype.results_build=function(){var e,t,i,s,a;for(this.parsing=!0,this.results_data=n.SelectParser.select_to_array(this.form_field),this.is_multiple&&this.choices>0?(this.search_choices.find("li.search-choice").remove(),this.choices=0):this.is_multiple||(this.selected_item.addClass("chzn-default").find("span").text(this.default_text),this.disable_search||this.form_field.options.length<=this.disable_search_threshold?this.container.addClass("chzn-container-single-nosearch"):this.container.removeClass("chzn-container-single-nosearch")),e="",a=this.results_data,i=0,s=a.length;s>i;i++)t=a[i],t.group?e+=this.result_add_group(t):t.empty||(e+=this.result_add_option(t),t.selected&&this.is_multiple?this.choice_build(t):t.selected&&!this.is_multiple&&(this.selected_item.removeClass("chzn-default").find("span").text(t.text),this.allow_single_deselect&&this.single_deselect_control_build()));return this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.search_results.html(e),this.parsing=!1},s.prototype.result_add_group=function(t){return t.disabled?"":(t.dom_id=this.container_id+"_g_"+t.array_index,'<li id="'+t.dom_id+'" class="group-result">'+e("<div />").text(t.label).html()+"</li>")},s.prototype.result_do_highlight=function(e){var t,i,n,s,a;if(e.length){if(this.result_clear_highlight(),this.result_highlight=e,this.result_highlight.addClass("highlighted"),n=parseInt(this.search_results.css("maxHeight"),10),a=this.search_results.scrollTop(),s=n+a,i=this.result_highlight.position().top+this.search_results.scrollTop(),t=i+this.result_highlight.outerHeight(),t>=s)return this.search_results.scrollTop(t-n>0?t-n:0);if(a>i)return this.search_results.scrollTop(i)}},s.prototype.result_clear_highlight=function(){return this.result_highlight&&this.result_highlight.removeClass("highlighted"),this.result_highlight=null},s.prototype.results_show=function(){var e;if(this.is_multiple){if(this.max_selected_options<=this.choices)return this.form_field_jq.trigger("liszt:maxselected",{chosen:this}),!1}else this.selected_item.addClass("chzn-single-with-drop"),this.result_single_selected&&this.result_do_highlight(this.result_single_selected);return e=this.is_multiple?this.container.height():this.container.height()-1,this.form_field_jq.trigger("liszt:showing_dropdown",{chosen:this}),this.dropdown.css({top:e+"px",left:0}),this.results_showing=!0,this.search_field.focus(),this.search_field.val(this.search_field.val()),this.winnow_results()},s.prototype.results_hide=function(){return this.is_multiple||this.selected_item.removeClass("chzn-single-with-drop"),this.result_clear_highlight(),this.form_field_jq.trigger("liszt:hiding_dropdown",{chosen:this}),this.dropdown.css({left:"-9000px"}),this.results_showing=!1},s.prototype.set_tab_index=function(){var e;return this.form_field_jq.attr("tabindex")?(e=this.form_field_jq.attr("tabindex"),this.form_field_jq.attr("tabindex",-1),this.search_field.attr("tabindex",e)):void 0},s.prototype.show_search_field_default=function(){return this.is_multiple&&this.choices<1&&!this.active_field?(this.search_field.val(this.default_text),this.search_field.addClass("default")):(this.search_field.val(""),this.search_field.removeClass("default"))},s.prototype.search_results_mouseup=function(t){var i;return i=e(t.target).hasClass("active-result")?e(t.target):e(t.target).parents(".active-result").first(),i.length?(this.result_highlight=i,this.result_select(t),this.search_field.focus()):void 0},s.prototype.search_results_mouseover=function(t){var i;return i=e(t.target).hasClass("active-result")?e(t.target):e(t.target).parents(".active-result").first(),i?this.result_do_highlight(i):void 0},s.prototype.search_results_mouseout=function(t){return e(t.target).hasClass("active-result")?this.result_clear_highlight():void 0},s.prototype.choices_click=function(t){return t.preventDefault(),!this.active_field||e(t.target).hasClass("search-choice")||this.results_showing?void 0:this.results_show()},s.prototype.choice_build=function(t){var i,n,s,a=this;return this.is_multiple&&this.max_selected_options<=this.choices?(this.form_field_jq.trigger("liszt:maxselected",{chosen:this}),!1):(i=this.container_id+"_c_"+t.array_index,this.choices+=1,n=t.disabled?'<li class="search-choice search-choice-disabled" id="'+i+'"><span>'+t.html+"</span></li>":'<li class="search-choice" id="'+i+'"><span>'+t.html+'</span><a href="javascript:void(0)" class="search-choice-close" rel="'+t.array_index+'"></a></li>',this.search_container.before(n),s=e("#"+i).find("a").first(),s.click(function(e){return a.choice_destroy_link_click(e)}))},s.prototype.choice_destroy_link_click=function(t){return t.preventDefault(),this.is_disabled?t.stopPropagation:(this.pending_destroy_click=!0,this.choice_destroy(e(t.target)))},s.prototype.choice_destroy=function(e){return this.result_deselect(e.attr("rel"))?(this.choices-=1,this.show_search_field_default(),this.is_multiple&&this.choices>0&&this.search_field.val().length<1&&this.results_hide(),e.parents("li").first().remove(),this.search_field_scale()):void 0},s.prototype.results_reset=function(){return this.form_field.options[0].selected=!0,this.selected_item.find("span").text(this.default_text),this.is_multiple||this.selected_item.addClass("chzn-default"),this.show_search_field_default(),this.results_reset_cleanup(),this.form_field_jq.trigger("change"),this.active_field?this.results_hide():void 0},s.prototype.results_reset_cleanup=function(){return this.current_value=this.form_field_jq.val(),this.selected_item.find("abbr").remove()},s.prototype.result_select=function(e){var t,i,n,s;return this.result_highlight?(t=this.result_highlight,i=t.attr("id"),this.result_clear_highlight(),this.is_multiple?this.result_deactivate(t):(this.search_results.find(".result-selected").removeClass("result-selected"),this.result_single_selected=t,this.selected_item.removeClass("chzn-default")),t.addClass("result-selected"),s=i.substr(i.lastIndexOf("_")+1),n=this.results_data[s],n.selected=!0,this.form_field.options[n.options_index].selected=!0,this.is_multiple?this.choice_build(n):(this.selected_item.find("span").first().text(n.text),this.allow_single_deselect&&this.single_deselect_control_build()),(e.metaKey||e.ctrlKey)&&this.is_multiple||this.results_hide(),this.search_field.val(""),(this.is_multiple||this.form_field_jq.val()!==this.current_value)&&this.form_field_jq.trigger("change",{selected:this.form_field.options[n.options_index].value}),this.current_value=this.form_field_jq.val(),this.search_field_scale()):void 0},s.prototype.result_activate=function(e){return e.addClass("active-result")},s.prototype.result_deactivate=function(e){return e.removeClass("active-result")},s.prototype.result_deselect=function(t){var i,n;return n=this.results_data[t],this.form_field.options[n.options_index].disabled?!1:(n.selected=!1,this.form_field.options[n.options_index].selected=!1,i=e("#"+this.container_id+"_o_"+t),i.removeClass("result-selected").addClass("active-result").show(),this.result_clear_highlight(),this.winnow_results(),this.form_field_jq.trigger("change",{deselected:this.form_field.options[n.options_index].value}),this.search_field_scale(),!0)},s.prototype.single_deselect_control_build=function(){return this.allow_single_deselect&&this.selected_item.find("abbr").length<1?this.selected_item.find("span").first().after('<abbr class="search-choice-close"></abbr>'):void 0},s.prototype.winnow_results=function(){var t,i,n,s,a,r,o,l,u,c,h,d,p,f,m,g,y,v;for(this.no_results_clear(),u=0,c=this.search_field.val()===this.default_text?"":e("<div/>").text(e.trim(this.search_field.val())).html(),r=this.search_contains?"":"^",a=new RegExp(r+c.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),p=new RegExp(c.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),v=this.results_data,f=0,g=v.length;g>f;f++)if(i=v[f],!i.disabled&&!i.empty)if(i.group)e("#"+i.dom_id).css("display","none");else if(!this.is_multiple||!i.selected){if(t=!1,l=i.dom_id,o=e("#"+l),a.test(i.html))t=!0,u+=1;else if(this.enable_split_word_search&&(i.html.indexOf(" ")>=0||0===i.html.indexOf("["))&&(s=i.html.replace(/\[|\]/g,"").split(" "),s.length))for(m=0,y=s.length;y>m;m++)n=s[m],a.test(n)&&(t=!0,u+=1);t?(c.length?(h=i.html.search(p),d=i.html.substr(0,h+c.length)+"</em>"+i.html.substr(h+c.length),d=d.substr(0,h)+"<em>"+d.substr(h)):d=i.html,o.html(d),this.result_activate(o),null!=i.group_array_index&&e("#"+this.results_data[i.group_array_index].dom_id).css("display","list-item")):(this.result_highlight&&l===this.result_highlight.attr("id")&&this.result_clear_highlight(),this.result_deactivate(o))}return 1>u&&c.length?this.no_results(c):this.winnow_results_set_highlight()},s.prototype.winnow_results_clear=function(){var t,i,n,s,a;for(this.search_field.val(""),i=this.search_results.find("li"),a=[],n=0,s=i.length;s>n;n++)t=i[n],t=e(t),t.hasClass("group-result")?a.push(t.css("display","auto")):this.is_multiple&&t.hasClass("result-selected")?a.push(void 0):a.push(this.result_activate(t));return a},s.prototype.winnow_results_set_highlight=function(){var e,t;return this.result_highlight||(t=this.is_multiple?[]:this.search_results.find(".result-selected.active-result"),e=t.length?t.first():this.search_results.find(".active-result").first(),null==e)?void 0:this.result_do_highlight(e)},s.prototype.no_results=function(t){var i;return i=e('<li class="no-results">'+this.results_none_found+' "<span></span>"</li>'),i.find("span").first().html(t),this.search_results.append(i)},s.prototype.no_results_clear=function(){return this.search_results.find(".no-results").remove()},s.prototype.keydown_arrow=function(){var t,i;return this.result_highlight?this.results_showing&&(i=this.result_highlight.nextAll("li.active-result").first(),i&&this.result_do_highlight(i)):(t=this.search_results.find("li.active-result").first(),t&&this.result_do_highlight(e(t))),this.results_showing?void 0:this.results_show()},s.prototype.keyup_arrow=function(){var e;return this.results_showing||this.is_multiple?this.result_highlight?(e=this.result_highlight.prevAll("li.active-result"),e.length?this.result_do_highlight(e.first()):(this.choices>0&&this.results_hide(),this.result_clear_highlight())):void 0:this.results_show()},s.prototype.keydown_backstroke=function(){var e;return this.pending_backstroke?(this.choice_destroy(this.pending_backstroke.find("a").first()),this.clear_backstroke()):(e=this.search_container.siblings("li.search-choice").last(),e.length&&!e.hasClass("search-choice-disabled")?(this.pending_backstroke=e,this.single_backstroke_delete?this.keydown_backstroke():this.pending_backstroke.addClass("search-choice-focus")):void 0)},s.prototype.clear_backstroke=function(){return this.pending_backstroke&&this.pending_backstroke.removeClass("search-choice-focus"),this.pending_backstroke=null},s.prototype.keydown_checker=function(e){var t,i;switch(t=null!=(i=e.which)?i:e.keyCode,this.search_field_scale(),8!==t&&this.pending_backstroke&&this.clear_backstroke(),t){case 8:this.backstroke_length=this.search_field.val().length;break;case 9:this.results_showing&&!this.is_multiple&&this.result_select(e),this.mouse_on_container=!1;break;case 13:e.preventDefault();break;case 38:e.preventDefault(),this.keyup_arrow();break;case 40:this.keydown_arrow()}},s.prototype.search_field_scale=function(){var t,i,n,s,a,r,o,l,u;if(this.is_multiple){for(n=0,o=0,a="position:absolute; left: -1000px; top: -1000px; display:none;",r=["font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"],l=0,u=r.length;u>l;l++)s=r[l],a+=s+":"+this.search_field.css(s)+";";return i=e("<div />",{style:a}),i.text(this.search_field.val()),e("body").append(i),o=i.width()+25,i.remove(),o>this.f_width-10&&(o=this.f_width-10),this.search_field.css({width:o+"px"}),t=this.container.height(),this.dropdown.css({top:t+"px"})}},s.prototype.generate_random_id=function(){var t;for(t="sel"+this.generate_random_char()+this.generate_random_char()+this.generate_random_char();e("#"+t).length>0;)t+=this.generate_random_char();return t},s}(AbstractChosen),n.Chosen=t,i=function(e){var t;return t=e.outerWidth()-e.width()},n.get_side_border_padding=i}.call(this),function(){Oskari.clazz.define("Oskari.libraries.bundle.geostats.GeostatsBundle",function(){},{create:function(){return this},update:function(){},start:function(){},stop:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance"],source:{scripts:[{type:"text/javascript",src:"../../../../libraries/geostats/geostats-0.6.min.js"},{type:"text/javascript",src:"../../../../libraries/geostats/jenks.util.js"}]}}),Oskari.bundle_manager.installBundleClass("geostats","Oskari.libraries.bundle.geostats.GeostatsBundle")}();var _t=function(e){return e},inArray=function(e,t){for(var i=0;i<t.length;i++)if(t[i]==e)return!0;return!1},geostats=function(e){this.legendSeparator=this.separator=" - ",this.method="",this.roundlength=2,this.is_uniqueValues=!1,this.bounds=[],this.ranges=[],this.colors=[],this.counter=[],this.stat_cov=this.stat_stddev=this.stat_variance=this.stat_pop=this.stat_min=this.stat_max=this.stat_sum=this.stat_median=this.stat_mean=this.stat_sorted=null,this.serie="undefined"!=typeof e&&0<e.length?e:[],this.setSerie=function(e){this.serie=[],this.serie=e},this.setColors=function(e){this.colors=e},this.doCount=function(){if(!this._nodata()){var e=this.sorted();for(i=0;i<this.bounds.length;i++)this.counter[i]=0;for(j=0;j<e.length;j++){var t=this.getClass(e[j]);this.counter[t]++}}},this.setRanges=function(){for(this.ranges=[],i=0;i<this.bounds.length-1;i++)this.ranges[i]=this.bounds[i]+this.separator+this.bounds[i+1]},this.min=function(){if(!this._nodata()){if(null==this.stat_min)for(this.stat_min=this.serie[0],i=0;i<this.pop();i++)this.serie[i]<this.stat_min&&(this.stat_min=this.serie[i]);return this.stat_min}},this.max=function(){if(!this._nodata()){if(null==this.stat_max)for(this.stat_max=this.serie[0],i=0;i<this.pop();i++)this.serie[i]>this.stat_max&&(this.stat_max=this.serie[i]);return this.stat_max}},this.sum=function(){if(!this._nodata()){if(null==this.stat_sum)for(i=this.stat_sum=0;i<this.pop();i++)this.stat_sum+=this.serie[i];return this.stat_sum}},this.pop=function(){return this._nodata()?void 0:(null==this.stat_pop&&(this.stat_pop=this.serie.length),this.stat_pop)},this.mean=function(){return this._nodata()?void 0:(null==this.stat_mean&&(this.stat_mean=this.sum()/this.pop()),this.stat_mean)},this.median=function(){if(!this._nodata()){if(null==this.stat_median){this.stat_median=0;var e=this.sorted();this.stat_median=e.length%2?e[Math.ceil(e.length/2)-1]:(e[e.length/2-1]+e[e.length/2])/2}return this.stat_median}},this.variance=function(){if(round="undefined"==typeof round?!0:!1,!this._nodata()){if(null==this.stat_variance){for(var e=0,t=0;t<this.pop();t++)e+=Math.pow(this.serie[t]-this.mean(),2);this.stat_variance=e/this.pop(),1==round&&(this.stat_variance=Math.round(this.stat_variance*Math.pow(10,this.roundlength))/Math.pow(10,this.roundlength))}return this.stat_variance}},this.stddev=function(e){return e="undefined"==typeof e?!0:!1,this._nodata()?void 0:(null==this.stat_stddev&&(this.stat_stddev=Math.sqrt(this.variance()),1==e&&(this.stat_stddev=Math.round(this.stat_stddev*Math.pow(10,this.roundlength))/Math.pow(10,this.roundlength))),this.stat_stddev)},this.cov=function(e){return e="undefined"==typeof e?!0:!1,this._nodata()?void 0:(null==this.stat_cov&&(this.stat_cov=this.stddev()/this.mean(),1==e&&(this.stat_cov=Math.round(this.stat_cov*Math.pow(10,this.roundlength))/Math.pow(10,this.roundlength))),this.stat_cov)},this._nodata=function(){return 0==this.serie.length?(alert("Error. You should first enter a serie!"),1):0},this.sorted=function(){return null==this.stat_sorted&&(this.stat_sorted=0==this.is_uniqueValues?this.serie.sort(function(e,t){return e-t}):this.serie.sort(function(e,t){var i=e.toLowerCase(),n=t.toLowerCase();return n>i?-1:i>n?1:0})),this.stat_sorted},this.info=function(){if(!this._nodata()){var e;return e=""+(_t("Population")+" : "+this.pop()+" - ["+_t("Min")+" : "+this.min()+" | "+_t("Max")+" : "+this.max()+"]\n"),e+=_t("Mean")+" : "+this.mean()+" - "+_t("Median")+" : "+this.median()+"\n",e+=_t("Variance")+" : "+this.variance()+" - "+_t("Standard deviation")+" : "+this.stddev()+" - "+_t("Coefficient of variation")+" : "+this.cov()+"\n"}},this.getEqInterval=function(e){if(!this._nodata()){this.method=_t("eq. intervals")+" ("+e+" "+_t("classes")+")";var t=[],n=this.min(),s=(this.max()-this.min())/e;for(i=0;e>=i;i++)t[i]=n,n+=s;return this.bounds=t,this.setRanges(),t}},this.getQuantile=function(e){if(!this._nodata()){this.method=_t("quantile")+" ("+e+" "+_t("classes")+")";var t=[],i=this.sorted(),n=Math.round(this.pop()/e),s=n,a=0;for(t[0]=i[0],a=1;e>a;a++)t[a]=i[s],s+=n;return t.push(i[i.length-1]),this.bounds=t,this.setRanges(),t}},this.getJenks=function(e){if(!this._nodata()){this.method=_t("Jenks")+" ("+e+" "+_t("classes")+")",dataList=this.sorted();for(var t=[],i=0,n=dataList.length+1;n>i;i++){for(var s=[],a=0,r=e+1;r>a;a++)s.push(0);t.push(s)}for(i=[],n=0,s=dataList.length+1;s>n;n++){for(var a=[],r=0,o=e+1;o>r;r++)a.push(0);i.push(a)}for(n=1,s=e+1;s>n;n++){t[0][n]=1,i[0][n]=0;for(var l=1,a=dataList.length+1;a>l;l++)i[l][n]=1/0;l=0}for(n=2,s=dataList.length+1;s>n;n++){for(var o=r=a=0,u=1,c=n+1;c>u;u++){var h=n-u+1,l=parseFloat(dataList[h-1]),r=r+l*l,a=a+l,o=o+1,l=r-a*a/o,d=h-1;if(0!=d)for(var p=2,f=e+1;f>p;p++)i[n][p]>=l+i[d][p-1]&&(t[n][p]=h,i[n][p]=l+i[d][p-1])}t[n][1]=1,i[n][1]=l}for(l=dataList.length,i=[],n=0,s=e+1;s>n;n++)i.push(0);for(i[e]=parseFloat(dataList[dataList.length-1]),i[0]=parseFloat(dataList[0]);e>=2;)n=parseInt(t[l][e]-2),i[e-1]=dataList[n],l=parseInt(t[l][e]-1),e-=1;return i[0]==i[1]&&(i[0]=0),this.bounds=i,this.setRanges(),i}},this.getUniqueValues=function(){if(!this._nodata()){this.method=_t("unique values"),this.is_uniqueValues=!0;var e=this.sorted(),t=[];for(i=0;i<this.pop();i++)inArray(e[i],t)||t.push(e[i]);return this.bounds=t}},this.getClass=function(e){for(i=0;i<this.bounds.length;i++)if(1==this.is_uniqueValues){if(e==this.bounds[i])return i}else if(e<=this.bounds[i+1])return i;return _t("Unable to get value's class.")},this.getRanges=function(){return this.ranges},this.getRangeNum=function(e){var t,i;for(i=0;i<this.ranges.length;i++)if(t=this.ranges[i].split(/ - /),e<=parseFloat(t[1]))return i},this.getHtmlLegend=function(e,t,n,s){var a="";if(ccolors=null!=e?e:this.colors,lg=null!=t?t:"Legend",null!=n?(this.doCount(),getcounter=!0):getcounter=!1,fn=null!=s?s:function(e){return e},!(ccolors.length<this.ranges.length)){if(e='<div class="geostats-legend"><div class="geostats-legend-title">'+_t(lg)+"</div>",0==this.is_uniqueValues)for(i=0;i<this.ranges.length;i++)!0===getcounter&&(a=' <span class="geostats-legend-counter">('+this.counter[i]+")</span>"),-1!=this.ranges[i].indexOf(this.separator)?(t=this.ranges[i].split(this.separator),t=fn(t[0])+this.legendSeparator+fn(t[1])):t=fn(this.ranges[i]),e+='<div><div class="geostats-legend-block" style="background-color:'+ccolors[i]+'"></div> '+t+a+"</div>";else for(i=0;i<this.bounds.length;i++)!0===getcounter&&(a=' <span class="geostats-legend-counter">('+this.counter[i]+")</span>"),t=fn(this.bounds[i]),e+='<div><div class="geostats-legend-block" style="background-color:'+ccolors[i]+'"></div> '+t+a+"</div>";return e+"</div>"}alert(_t("The number of colors should fit the number of ranges. Exit!"))},this.getSortedlist=function(){return this.sorted().join(", ")}};Oskari.clazz.define("Oskari.integration.bundle.admin-layerselector.AdminLayerSelectorBundle",function(){},{create:function(){return Oskari.clazz.create("Oskari.integration.bundle.bb.AdapterBundleInstance","admin-layerselector","Oskari.integration.bundle.admin-layerselector.View")},start:function(){},stop:function(){},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/integration/bundle/admin-layerselector/View.js"},{type:"text/css",src:"../../../../resources/integration/bundle/admin-layerselector/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/integration/bundle/admin-layerselector/locale/fi.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/integration/bundle/admin-layerselector/locale/en.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/integration/bundle/admin-layerselector/locale/sv.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"admin-layerselector","Bundle-Name":"integration.bundle.admin-layerselector","Bundle-Author":[{Name:"val",Organisation:"nls.fi",Temporal:{Start:"2013",End:"2013"},Copyleft:{License:{"License-Scope":"implementation","License-Name":"MIT","License-Online-Resource":"https://github.com/documentcloud/backbone/blob/master/LICENSE"},License:{"License-Scope":"package","License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("admin-layerselector","Oskari.integration.bundle.admin-layerselector.AdminLayerSelectorBundle"),Oskari.clazz.define("Oskari.integration.bundle.admin-layerselector.View",function(){},{eventHandlers:{MapLayerVisibilityChangedEvent:function(){},AfterMapMoveEvent:function(){},MapLayerEvent:function(){var e=500,t=this;t._previousLayerUpdateTimer&&(clearTimeout(t._previousLayerUpdateTimer),t._previousLayerUpdateTimer=null),t._previousLayerUpdateTimer=setTimeout(function(){t._layerUpdateHandler()},e),jQuery("body").css({cursor:"auto"})}},_layerUpdateHandler:function(){var e=this.getSandbox(),t=e.getService("Oskari.mapframework.service.MapLayerService"),i=t.getAllLayers();null!=this.view?this.view.addToCollection(i):this.layers=i},requirementsConfig:{waitSeconds:15,paths:{_bundle:"../../../Oskari/bundles/integration/bundle/admin-layerselector"}},init:function(){},render:function(){var e=this,t=e.getEl();t.addClass("admin-layerselector"),t.on("adminAction",{me:e},e.handleAction);var i=(e.getLocalization(),(this.getConfiguration()||{}).requirementsConfig),n=i||this.requirementsConfig;require.config(n),require(["_bundle/views/layerSelectorView"],function(i){e.view=new i({el:t,instance:e.instance,locale:e.locale}),e._layerUpdateHandler()
})},handleAction:function(e){e.stopPropagation();var t=e.data.me,i=t.getSandbox(),n=i.getService("Oskari.mapframework.service.MapLayerService");if("removeLayer"==e.command)if(e.baseLayerId){var s="base_"+e.baseLayerId;n.removeSubLayer(s,e.modelId)}else n.removeLayer(e.modelId);else if("addLayer"==e.command){e.layerData.name=e.layerData.admin.name[Oskari.getDefaultLanguage()];var a=n.createMapLayer(e.layerData);if(a.admin=e.layerData.admin,e.baseLayerId){var s="base_"+e.baseLayerId;n.addSubLayer(s,a)}else n._reservedLayerIds[a.getId()]!==!0&&n.addLayer(a)}else"editLayer"==e.command?(e.layerData.name=e.layerData.admin.name[Oskari.getDefaultLanguage()],n.updateLayer(e.layerData.id,e.layerData)):"addGroup"==e.command?n.loadAllLayersAjax():"editGroup"==e.command?(n.removeLayer(e.id,!0),n.loadAllLayersAjax()):"deleteGroup"==e.command&&n.removeLayer(e.id)}},{extend:["Oskari.integration.bundle.bb.View"]}),Oskari.clazz.define("Oskari.integration.bundle.bb.BackBoneBundle",function(){this.conf=null},{create:function(){return this},start:function(){},stop:function(){},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.bundle.BundleInstance","Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/integration/bundle/bb/comp.js"},{type:"text/javascript",src:"../../../../bundles/integration/bundle/bb/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/integration/bundle/bb/Tile.js"},{type:"text/javascript",src:"../../../../bundles/integration/bundle/bb/View.js"},{type:"text/javascript",src:"../../../../bundles/integration/bundle/bb/Adapter.js"}],resources:[]},bundle:{manifest:{"Bundle-Identifier":"bb","Bundle-Name":"integration.bundle.bb","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2013",End:"2013"},Copyleft:{License:{"License-Scope":"implementation","License-Name":"MIT","License-Online-Resource":"https://github.com/documentcloud/backbone/blob/master/LICENSE"},License:{"License-Scope":"package","License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}}}),Oskari.bundle_manager.installBundleClass("bb","Oskari.integration.bundle.bb.BackBoneBundle");var requirejs,require,define;!function(Y){function H(e){return"[object Function]"===L.call(e)}function I(e){return"[object Array]"===L.call(e)}function x(e,t){if(e){var i;for(i=0;i<e.length&&(!e[i]||!t(e[i],i,e));i+=1);}}function M(e,t){if(e){var i;for(i=e.length-1;i>-1&&(!e[i]||!t(e[i],i,e));i-=1);}}function r(e,t){return da.call(e,t)}function i(e,t){return r(e,t)&&e[t]}function E(e,t){for(var i in e)if(r(e,i)&&t(e[i],i))break}function Q(e,t,i,n){return t&&E(t,function(t,s){(i||!r(e,s))&&(n&&"string"!=typeof t?(e[s]||(e[s]={}),Q(e[s],t,i,n)):e[s]=t)}),e}function t(e,t){return function(){return t.apply(e,arguments)}}function Z(e){if(!e)return e;var t=Y;return x(e.split("."),function(e){t=t[e]}),t}function J(e,t,i,n){return t=Error(t+"\nhttp://requirejs.org/docs/errors.html#"+e),t.requireType=e,t.requireModules=n,i&&(t.originalError=i),t}function ea(e){function n(e,t,n){var s,a,r,o,l,u,c,h=t&&t.split("/");s=h;var d=S.map,p=d&&d["*"];if(e&&"."===e.charAt(0))if(t){for(s=i(S.pkgs,t)?h=[t]:h.slice(0,h.length-1),t=e=s.concat(e.split("/")),s=0;t[s];s+=1)if(a=t[s],"."===a)t.splice(s,1),s-=1;else if(".."===a){if(1===s&&(".."===t[2]||".."===t[0]))break;s>0&&(t.splice(s-1,2),s-=2)}s=i(S.pkgs,t=e[0]),e=e.join("/"),s&&e===t+"/"+s.main&&(e=t)}else 0===e.indexOf("./")&&(e=e.substring(2));if(n&&(h||p)&&d){for(t=e.split("/"),s=t.length;s>0;s-=1){if(r=t.slice(0,s).join("/"),h)for(a=h.length;a>0;a-=1)if((n=i(d,h.slice(0,a).join("/")))&&(n=i(n,r))){o=n,l=s;break}if(o)break;!u&&p&&i(p,r)&&(u=i(p,r),c=s)}!o&&u&&(o=u,l=c),o&&(t.splice(0,l,o),e=t.join("/"))}return e}function s(e){z&&x(document.getElementsByTagName("script"),function(t){return t.getAttribute("data-requiremodule")===e&&t.getAttribute("data-requirecontext")===w.contextName?(t.parentNode.removeChild(t),!0):void 0})}function a(e){var t=i(S.paths,e);return t&&I(t)&&1<t.length?(s(e),t.shift(),w.require.undef(e),w.require([e]),!0):void 0}function o(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function u(e,t,s,a){var r,l,u=null,c=t?t.name:null,h=e,d=!0,p="";return e||(d=!1,e="_@r"+(F+=1)),e=o(e),u=e[0],e=e[1],u&&(u=n(u,c,a),l=i(N,u)),e&&(u?p=l&&l.normalize?l.normalize(e,function(e){return n(e,c,a)}):n(e,c,a):(p=n(e,c,a),e=o(p),u=e[0],p=e[1],s=!0,r=w.nameToUrl(p))),s=!u||l||s?"":"_unnormalized"+(B+=1),{prefix:u,name:p,parentMap:t,unnormalized:!!s,url:r,originalName:h,isDefine:d,id:(u?u+"!"+p:p)+s}}function c(e){var t=e.id,n=i(C,t);return n||(n=C[t]=new w.Module(e)),n}function h(e,t,n){var s=e.id,a=i(C,s);!r(N,s)||a&&!a.defineEmitComplete?c(e).on(t,n):"defined"===t&&n(N[s])}function d(e,t){var n=e.requireModules,s=!1;t?t(e):(x(n,function(t){(t=i(C,t))&&(t.error=e,t.events.error&&(s=!0,t.emit("error",e)))}),s||l.onError(e))}function p(){R.length&&(fa.apply(j,[j.length-1,0].concat(R)),R=[])}function f(e,t,n){var s=e.map.id;e.error?e.emit("error",e.error):(t[s]=!0,x(e.depMaps,function(s,a){var r=s.id,o=i(C,r);o&&!e.depMatched[a]&&!n[r]&&(i(t,r)?(e.defineDep(a,N[r]),e.check()):f(o,t,n))}),n[s]=!0)}function m(){var e,t,i,n,r=(i=1e3*S.waitSeconds)&&w.startTime+i<(new Date).getTime(),o=[],l=[],u=!1,c=!0;if(!b){if(b=!0,E(C,function(i){if(e=i.map,t=e.id,i.enabled&&(e.isDefine||l.push(i),!i.error))if(!i.inited&&r)a(t)?u=n=!0:(o.push(t),s(t));else if(!i.inited&&i.fetched&&e.isDefine&&(u=!0,!e.prefix))return c=!1}),r&&o.length)return i=J("timeout","Load timeout for modules: "+o,null,o),i.contextName=w.contextName,d(i);c&&x(l,function(e){f(e,{},{})}),r&&!n||!u||!z&&!$||k||(k=setTimeout(function(){k=0,m()},50)),b=!1}}function g(e){r(N,e[0])||c(u(e[0],null,!0)).init(e[1],e[2])}function y(e){var e=e.currentTarget||e.srcElement,t=w.onScriptLoad;return e.detachEvent&&!V?e.detachEvent("onreadystatechange",t):e.removeEventListener("load",t,!1),t=w.onScriptError,(!e.detachEvent||V)&&e.removeEventListener("error",t,!1),{node:e,id:e&&e.getAttribute("data-requiremodule")}}function v(){var e;for(p();j.length;){if(e=j.shift(),null===e[0])return d(J("mismatch","Mismatched anonymous define() module: "+e[e.length-1]));g(e)}}var b,_,w,L,k,S={waitSeconds:7,baseUrl:"./",paths:{},pkgs:{},shim:{},map:{},config:{}},C={},M={},j=[],N={},T={},F=1,B=1;return L={require:function(e){return e.require?e.require:e.require=w.makeRequire(e.map)},exports:function(e){return e.usingExports=!0,e.map.isDefine?e.exports?e.exports:e.exports=N[e.map.id]={}:void 0},module:function(e){return e.module?e.module:e.module={id:e.map.id,uri:e.map.url,config:function(){return S.config&&i(S.config,e.map.id)||{}},exports:N[e.map.id]}}},_=function(e){this.events=i(M,e.id)||{},this.map=e,this.shim=i(S.shim,e.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0},_.prototype={init:function(e,i,n,s){s=s||{},this.inited||(this.factory=i,n?this.on("error",n):this.events.error&&(n=t(this,function(e){this.emit("error",e)})),this.depMaps=e&&e.slice(0),this.errback=n,this.inited=!0,this.ignore=s.ignore,s.enabled||this.enabled?this.enable():this.check())},defineDep:function(e,t){this.depMatched[e]||(this.depMatched[e]=!0,this.depCount-=1,this.depExports[e]=t)},fetch:function(){if(!this.fetched){this.fetched=!0,w.startTime=(new Date).getTime();var e=this.map;if(!this.shim)return e.prefix?this.callPlugin():this.load();w.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],t(this,function(){return e.prefix?this.callPlugin():this.load()}))}},load:function(){var e=this.map.url;T[e]||(T[e]=!0,w.load(this.map.id,e))},check:function(){if(this.enabled&&!this.enabling){var e,t,i=this.map.id;t=this.depExports;var n=this.exports,s=this.factory;if(this.inited){if(this.error)this.emit("error",this.error);else if(!this.defining){if(this.defining=!0,1>this.depCount&&!this.defined){if(H(s)){if(this.events.error)try{n=w.execCb(i,s,t,n)}catch(a){e=a}else n=w.execCb(i,s,t,n);if(this.map.isDefine&&((t=this.module)&&void 0!==t.exports&&t.exports!==this.exports?n=t.exports:void 0===n&&this.usingExports&&(n=this.exports)),e)return e.requireMap=this.map,e.requireModules=[this.map.id],e.requireType="define",d(this.error=e)}else n=s;this.exports=n,this.map.isDefine&&!this.ignore&&(N[i]=n,l.onResourceLoad)&&l.onResourceLoad(w,this.map,this.depMaps),delete C[i],this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}}else this.fetch()}},callPlugin:function(){var e=this.map,s=e.id,a=u(e.prefix);this.depMaps.push(a),h(a,"defined",t(this,function(a){var o,p;p=this.map.name;var f=this.map.parentMap?this.map.parentMap.name:null,m=w.makeRequire(e.parentMap,{enableBuildCallback:!0,skipMap:!0});this.map.unnormalized?(a.normalize&&(p=a.normalize(p,function(e){return n(e,f,!0)})||""),a=u(e.prefix+"!"+p,this.map.parentMap),h(a,"defined",t(this,function(e){this.init([],function(){return e},null,{enabled:!0,ignore:!0})})),(p=i(C,a.id))&&(this.depMaps.push(a),this.events.error&&p.on("error",t(this,function(e){this.emit("error",e)})),p.enable())):(o=t(this,function(e){this.init([],function(){return e},null,{enabled:!0})}),o.error=t(this,function(e){this.inited=!0,this.error=e,e.requireModules=[s],E(C,function(e){0===e.map.id.indexOf(s+"_unnormalized")&&delete C[e.map.id]}),d(e)}),o.fromText=t(this,function(t,i){var n=e.name,a=u(n),h=O;i&&(t=i),h&&(O=!1),c(a),r(S.config,s)&&(S.config[n]=S.config[s]);try{l.exec(t)}catch(d){throw Error("fromText eval for "+n+" failed: "+d)}h&&(O=!0),this.depMaps.push(a),w.completeLoad(n),m([n],o)}),a.load(e.name,m,o,S))})),w.enable(a,this),this.pluginMaps[a.id]=a},enable:function(){this.enabling=this.enabled=!0,x(this.depMaps,t(this,function(e,n){var s,a;if("string"==typeof e){if(e=u(e,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[n]=e,s=i(L,e.id))return this.depExports[n]=s(this),void 0;this.depCount+=1,h(e,"defined",t(this,function(e){this.defineDep(n,e),this.check()})),this.errback&&h(e,"error",this.errback)}s=e.id,a=C[s],!r(L,s)&&a&&!a.enabled&&w.enable(e,this)})),E(this.pluginMaps,t(this,function(e){var t=i(C,e.id);t&&!t.enabled&&w.enable(e,this)})),this.enabling=!1,this.check()},on:function(e,t){var i=this.events[e];i||(i=this.events[e]=[]),i.push(t)},emit:function(e,t){x(this.events[e],function(e){e(t)}),"error"===e&&delete this.events[e]}},w={config:S,contextName:e,registry:C,defined:N,urlFetched:T,defQueue:j,Module:_,makeModuleMap:u,nextTick:l.nextTick,configure:function(e){e.baseUrl&&"/"!==e.baseUrl.charAt(e.baseUrl.length-1)&&(e.baseUrl+="/");var t=S.pkgs,i=S.shim,n={paths:!0,config:!0,map:!0};E(e,function(e,t){n[t]?"map"===t?Q(S[t],e,!0,!0):Q(S[t],e,!0):S[t]=e}),e.shim&&(E(e.shim,function(e,t){I(e)&&(e={deps:e}),!e.exports&&!e.init||e.exportsFn||(e.exportsFn=w.makeShimExports(e)),i[t]=e}),S.shim=i),e.packages&&(x(e.packages,function(e){e="string"==typeof e?{name:e}:e,t[e.name]={name:e.name,location:e.location||e.name,main:(e.main||"main").replace(ga,"").replace(aa,"")}}),S.pkgs=t),E(C,function(e,t){!e.inited&&!e.map.unnormalized&&(e.map=u(t))}),(e.deps||e.callback)&&w.require(e.deps||[],e.callback)},makeShimExports:function(e){return function(){var t;return e.init&&(t=e.init.apply(Y,arguments)),t||e.exports&&Z(e.exports)}},makeRequire:function(t,s){function a(i,n,o){var h,p;return s.enableBuildCallback&&n&&H(n)&&(n.__requireJsBuild=!0),"string"==typeof i?H(n)?d(J("requireargs","Invalid require call"),o):t&&r(L,i)?L[i](C[t.id]):l.get?l.get(w,i,t):(h=u(i,t,!1,!0),h=h.id,r(N,h)?N[h]:d(J("notloaded",'Module name "'+h+'" has not been loaded yet for context: '+e+(t?"":". Use require([])")))):(v(),w.nextTick(function(){v(),p=c(u(null,t)),p.skipMap=s.skipMap,p.init(i,n,o,{enabled:!0}),m()}),a)}return s=s||{},Q(a,{isBrowser:z,toUrl:function(e){var i=e.lastIndexOf("."),s=null;return-1!==i&&(s=e.substring(i,e.length),e=e.substring(0,i)),w.nameToUrl(n(e,t&&t.id,!0),s)},defined:function(e){return r(N,u(e,t,!1,!0).id)},specified:function(e){return e=u(e,t,!1,!0).id,r(N,e)||r(C,e)}}),t||(a.undef=function(e){p();var n=u(e,t,!0),s=i(C,e);delete N[e],delete T[n.url],delete M[e],s&&(s.events.defined&&(M[e]=s.events),delete C[e])}),a},enable:function(e){i(C,e.id)&&c(e).enable()},completeLoad:function(e){var t,n,s=i(S.shim,e)||{},o=s.exports;for(p();j.length;){if(n=j.shift(),null===n[0]){if(n[0]=e,t)break;t=!0}else n[0]===e&&(t=!0);g(n)}if(n=i(C,e),!t&&!r(N,e)&&n&&!n.inited){if(S.enforceDefine&&(!o||!Z(o)))return a(e)?void 0:d(J("nodefine","No define call for "+e,null,[e]));g([e,s.deps||[],s.exportsFn])}m()},nameToUrl:function(e,t){var n,s,a,r,o,u;if(l.jsExtRegExp.test(e))r=e+(t||"");else{for(n=S.paths,s=S.pkgs,r=e.split("/"),o=r.length;o>0;o-=1){if(u=r.slice(0,o).join("/"),a=i(s,u),u=i(n,u)){I(u)&&(u=u[0]),r.splice(0,o,u);break}if(a){n=e===a.name?a.location+"/"+a.main:a.location,r.splice(0,o,n);break}}r=r.join("/"),r+=t||(/\?/.test(r)?"":".js"),r=("/"===r.charAt(0)||r.match(/^[\w\+\.\-]+:/)?"":S.baseUrl)+r}return S.urlArgs?r+((-1===r.indexOf("?")?"?":"&")+S.urlArgs):r},load:function(e,t){l.load(w,e,t)},execCb:function(e,t,i,n){return t.apply(n,i)},onScriptLoad:function(e){("load"===e.type||ha.test((e.currentTarget||e.srcElement).readyState))&&(P=null,e=y(e),w.completeLoad(e.id))},onScriptError:function(e){var t=y(e);return a(t.id)?void 0:d(J("scripterror","Script error",e,[t.id]))}},w.require=w.makeRequire(),w}var l,w,A,D,s,G,P,K,ba,ca,ia=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,ja=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,aa=/\.js$/,ga=/^\.\//;w=Object.prototype;var L=w.toString,da=w.hasOwnProperty,fa=Array.prototype.splice,z=!("undefined"==typeof window||!navigator||!document),$=!z&&"undefined"!=typeof importScripts,ha=z&&"PLAYSTATION 3"===navigator.platform?/^complete$/:/^(complete|loaded)$/,V="undefined"!=typeof opera&&"[object Opera]"===opera.toString(),B={},q={},R=[],O=!1;if("undefined"==typeof define){if("undefined"!=typeof requirejs){if(H(requirejs))return;q=requirejs,requirejs=void 0}"undefined"!=typeof require&&!H(require)&&(q=require,require=void 0),l=requirejs=function(e,t,n,s){var a,r="_";return!I(e)&&"string"!=typeof e&&(a=e,I(t)?(e=t,t=n,n=s):e=[]),a&&a.context&&(r=a.context),(s=i(B,r))||(s=B[r]=l.s.newContext(r)),a&&s.configure(a),s.require(e,t,n)},l.config=function(e){return l(e)},l.nextTick="undefined"!=typeof setTimeout?function(e){setTimeout(e,4)}:function(e){e()},require||(require=l),l.version="2.1.2",l.jsExtRegExp=/^\/|:|\?|\.js$/,l.isBrowser=z,w=l.s={contexts:B,newContext:ea},l({}),x(["toUrl","undef","defined","specified"],function(e){l[e]=function(){var t=B._;return t.require[e].apply(t,arguments)}}),z&&(A=w.head=document.getElementsByTagName("head")[0],D=document.getElementsByTagName("base")[0])&&(A=w.head=D.parentNode),l.onError=function(e){throw e},l.load=function(e,t,i){var n,s=e&&e.config||{};return z?(n=s.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script"),n.type=s.scriptType||"text/javascript",n.charset="utf-8",n.async=!0,n.setAttribute("data-requirecontext",e.contextName),n.setAttribute("data-requiremodule",t),!n.attachEvent||n.attachEvent.toString&&0>n.attachEvent.toString().indexOf("[native code")||V?(n.addEventListener("load",e.onScriptLoad,!1),n.addEventListener("error",e.onScriptError,!1)):(O=!0,n.attachEvent("onreadystatechange",e.onScriptLoad)),n.src=i,K=n,D?A.insertBefore(n,D):A.appendChild(n),K=null,n):($&&(importScripts(i),e.completeLoad(t)),void 0)},z&&M(document.getElementsByTagName("script"),function(e){return A||(A=e.parentNode),(s=e.getAttribute("data-main"))?(q.baseUrl||(G=s.split("/"),ba=G.pop(),ca=G.length?G.join("/")+"/":"./",q.baseUrl=ca,s=ba),s=s.replace(aa,""),q.deps=q.deps?q.deps.concat(s):[s],!0):void 0}),define=function(e,t,i){var n,s;"string"!=typeof e&&(i=t,t=e,e=null),I(t)||(i=t,t=[]),!t.length&&H(i)&&i.length&&(i.toString().replace(ia,"").replace(ja,function(e,i){t.push(i)}),t=(1===i.length?["require"]:["require","exports","module"]).concat(t)),O&&((n=K)||(P&&"interactive"===P.readyState||M(document.getElementsByTagName("script"),function(e){return"interactive"===e.readyState?P=e:void 0}),n=P),n&&(e||(e=n.getAttribute("data-requiremodule")),s=B[n.getAttribute("data-requirecontext")])),(s?s.defQueue:R).push([e,t,i])},define.amd={jQuery:!0},l.exec=function(b){return eval(b)},l(q)}}(this),define("text",["module"],function(e){"use strict";var t,i,n=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],s=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,r="undefined"!=typeof location&&location.href,o=r&&location.protocol&&location.protocol.replace(/\:/,""),l=r&&location.hostname,u=r&&(location.port||void 0),c=[],h=e.config&&e.config()||{};return t={version:"2.0.3",strip:function(e){if(e){e=e.replace(s,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:h.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){i=n[t];try{e=new ActiveXObject(i)}catch(s){}if(e){n=[i];break}}return e},parseName:function(e){var t=!1,i=e.indexOf("."),n=e.substring(0,i),s=e.substring(i+1,e.length);return i=s.indexOf("!"),-1!==i&&(t=s.substring(i+1,s.length),t="strip"===t,s=s.substring(0,i)),{moduleName:n,ext:s,strip:t}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,i,n,s){var a,r,o,l=t.xdRegExp.exec(e);return l?(a=l[2],r=l[3],r=r.split(":"),o=r[1],r=r[0],!(a&&a!==i||r&&r.toLowerCase()!==n.toLowerCase()||(o||r)&&o!==s)):!0},finishLoad:function(e,i,n,s){n=i?t.strip(n):n,h.isBuild&&(c[e]=n),s(n)},load:function(e,i,n,s){if(s.isBuild&&!s.inlineText)return n(),void 0;h.isBuild=s.isBuild;var a=t.parseName(e),c=a.moduleName+"."+a.ext,d=i.toUrl(c),p=h.useXhr||t.useXhr;!r||p(d,o,l,u)?t.get(d,function(i){t.finishLoad(e,a.strip,i,n)},function(e){n.error&&n.error(e)}):i([c],function(e){t.finishLoad(a.moduleName+"."+a.ext,a.strip,e,n)})},write:function(e,i,n){if(c.hasOwnProperty(i)){var s=t.jsEscape(c[i]);n.asModule(e+"!"+i,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,i,n,s,a){var r=t.parseName(i),o=r.moduleName+"."+r.ext,l=n.toUrl(r.moduleName+"."+r.ext)+".js";t.load(o,n,function(){var i=function(e){return s(l,e)};i.asModule=function(e,t){return s.asModule(e,l,t)},t.write(e,o,i,a)},a)}},"node"===h.env||!h.env&&"undefined"!=typeof process&&process.versions&&process.versions.node?(i=require.nodeRequire("fs"),t.get=function(e,t){var n=i.readFileSync(e,"utf8");0===n.indexOf("﻿")&&(n=n.substring(1)),t(n)}):"xhr"===h.env||!h.env&&t.createXhr()?t.get=function(e,i,n){var s=t.createXhr();s.open("GET",e,!0),h.onXhr&&h.onXhr(s,e),s.onreadystatechange=function(){var t,a;4===s.readyState&&(t=s.status,t>399&&600>t?(a=new Error(e+" HTTP status: "+t),a.xhr=s,n(a)):i(s.responseText))},s.send(null)}:("rhino"===h.env||!h.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java)&&(t.get=function(e,t){var i,n,s="utf-8",a=new java.io.File(e),r=java.lang.System.getProperty("line.separator"),o=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(a),s)),l="";try{for(i=new java.lang.StringBuffer,n=o.readLine(),n&&n.length()&&65279===n.charAt(0)&&(n=n.substring(1)),i.append(n);null!==(n=o.readLine());)i.append(r),i.append(n);l=String(i.toString())}finally{o.close()}t(l)}),t}),function(){var e=this,t=e._,i={},n=Array.prototype,s=Object.prototype,a=Function.prototype,r=n.push,o=n.slice,l=n.concat,u=s.toString,c=s.hasOwnProperty,h=n.forEach,d=n.map,p=n.reduce,f=n.reduceRight,m=n.filter,g=n.every,y=n.some,v=n.indexOf,b=n.lastIndexOf,_=Array.isArray,w=Object.keys,L=a.bind,k=function(e){return e instanceof k?e:this instanceof k?(this._wrapped=e,void 0):new k(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=k),exports._=k):e._=k,k.VERSION="1.4.3";var O=k.each=k.forEach=function(e,t,n){if(null!=e)if(h&&e.forEach===h)e.forEach(t,n);else if(e.length===+e.length){for(var s=0,a=e.length;a>s;s++)if(t.call(n,e[s],s,e)===i)return}else for(var r in e)if(k.has(e,r)&&t.call(n,e[r],r,e)===i)return};k.map=k.collect=function(e,t,i){var n=[];return null==e?n:d&&e.map===d?e.map(t,i):(O(e,function(e,s,a){n[n.length]=t.call(i,e,s,a)}),n)};var x="Reduce of empty array with no initial value";k.reduce=k.foldl=k.inject=function(e,t,i,n){var s=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return n&&(t=k.bind(t,n)),s?e.reduce(t,i):e.reduce(t);if(O(e,function(e,a,r){s?i=t.call(n,i,e,a,r):(i=e,s=!0)}),!s)throw new TypeError(x);return i},k.reduceRight=k.foldr=function(e,t,i,n){var s=arguments.length>2;if(null==e&&(e=[]),f&&e.reduceRight===f)return n&&(t=k.bind(t,n)),s?e.reduceRight(t,i):e.reduceRight(t);var a=e.length;if(a!==+a){var r=k.keys(e);a=r.length}if(O(e,function(o,l,u){l=r?r[--a]:--a,s?i=t.call(n,i,e[l],l,u):(i=e[l],s=!0)}),!s)throw new TypeError(x);return i},k.find=k.detect=function(e,t,i){var n;return S(e,function(e,s,a){return t.call(i,e,s,a)?(n=e,!0):void 0}),n},k.filter=k.select=function(e,t,i){var n=[];return null==e?n:m&&e.filter===m?e.filter(t,i):(O(e,function(e,s,a){t.call(i,e,s,a)&&(n[n.length]=e)}),n)},k.reject=function(e,t,i){return k.filter(e,function(e,n,s){return!t.call(i,e,n,s)},i)},k.every=k.all=function(e,t,n){t||(t=k.identity);var s=!0;return null==e?s:g&&e.every===g?e.every(t,n):(O(e,function(e,a,r){return(s=s&&t.call(n,e,a,r))?void 0:i}),!!s)};var S=k.some=k.any=function(e,t,n){t||(t=k.identity);var s=!1;return null==e?s:y&&e.some===y?e.some(t,n):(O(e,function(e,a,r){return s||(s=t.call(n,e,a,r))?i:void 0}),!!s)};k.contains=k.include=function(e,t){return null==e?!1:v&&e.indexOf===v?-1!=e.indexOf(t):S(e,function(e){return e===t})},k.invoke=function(e,t){var i=o.call(arguments,2);return k.map(e,function(e){return(k.isFunction(t)?t:e[t]).apply(e,i)})},k.pluck=function(e,t){return k.map(e,function(e){return e[t]})},k.where=function(e,t){return k.isEmpty(t)?[]:k.filter(e,function(e){for(var i in t)if(t[i]!==e[i])return!1;return!0})},k.max=function(e,t,i){if(!t&&k.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);if(!t&&k.isEmpty(e))return-1/0;var n={computed:-1/0,value:-1/0};return O(e,function(e,s,a){var r=t?t.call(i,e,s,a):e;r>=n.computed&&(n={value:e,computed:r})}),n.value},k.min=function(e,t,i){if(!t&&k.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);if(!t&&k.isEmpty(e))return 1/0;var n={computed:1/0,value:1/0};return O(e,function(e,s,a){var r=t?t.call(i,e,s,a):e;r<n.computed&&(n={value:e,computed:r})}),n.value},k.shuffle=function(e){var t,i=0,n=[];return O(e,function(e){t=k.random(i++),n[i-1]=n[t],n[t]=e}),n};var C=function(e){return k.isFunction(e)?e:function(t){return t[e]}};k.sortBy=function(e,t,i){var n=C(t);return k.pluck(k.map(e,function(e,t,s){return{value:e,index:t,criteria:n.call(i,e,t,s)}}).sort(function(e,t){var i=e.criteria,n=t.criteria;if(i!==n){if(i>n||void 0===i)return 1;if(n>i||void 0===n)return-1}return e.index<t.index?-1:1}),"value")};var M=function(e,t,i,n){var s={},a=C(t||k.identity);return O(e,function(t,r){var o=a.call(i,t,r,e);n(s,o,t)}),s};k.groupBy=function(e,t,i){return M(e,t,i,function(e,t,i){(k.has(e,t)?e[t]:e[t]=[]).push(i)})},k.countBy=function(e,t,i){return M(e,t,i,function(e,t){k.has(e,t)||(e[t]=0),e[t]++})},k.sortedIndex=function(e,t,i,n){i=null==i?k.identity:C(i);for(var s=i.call(n,t),a=0,r=e.length;r>a;){var o=a+r>>>1;i.call(n,e[o])<s?a=o+1:r=o}return a},k.toArray=function(e){return e?k.isArray(e)?o.call(e):e.length===+e.length?k.map(e,k.identity):k.values(e):[]},k.size=function(e){return null==e?0:e.length===+e.length?e.length:k.keys(e).length},k.first=k.head=k.take=function(e,t,i){return null==e?void 0:null==t||i?e[0]:o.call(e,0,t)},k.initial=function(e,t,i){return o.call(e,0,e.length-(null==t||i?1:t))},k.last=function(e,t,i){return null==e?void 0:null==t||i?e[e.length-1]:o.call(e,Math.max(e.length-t,0))},k.rest=k.tail=k.drop=function(e,t,i){return o.call(e,null==t||i?1:t)},k.compact=function(e){return k.filter(e,k.identity)};var P=function(e,t,i){return O(e,function(e){k.isArray(e)?t?r.apply(i,e):P(e,t,i):i.push(e)}),i};k.flatten=function(e,t){return P(e,t,[])},k.without=function(e){return k.difference(e,o.call(arguments,1))},k.uniq=k.unique=function(e,t,i,n){k.isFunction(t)&&(n=i,i=t,t=!1);var s=i?k.map(e,i,n):e,a=[],r=[];return O(s,function(i,n){(t?n&&r[r.length-1]===i:k.contains(r,i))||(r.push(i),a.push(e[n]))}),a},k.union=function(){return k.uniq(l.apply(n,arguments))},k.intersection=function(e){var t=o.call(arguments,1);return k.filter(k.uniq(e),function(e){return k.every(t,function(t){return k.indexOf(t,e)>=0})})},k.difference=function(e){var t=l.apply(n,o.call(arguments,1));return k.filter(e,function(e){return!k.contains(t,e)})},k.zip=function(){for(var e=o.call(arguments),t=k.max(k.pluck(e,"length")),i=new Array(t),n=0;t>n;n++)i[n]=k.pluck(e,""+n);return i},k.object=function(e,t){if(null==e)return{};for(var i={},n=0,s=e.length;s>n;n++)t?i[e[n]]=t[n]:i[e[n][0]]=e[n][1];return i},k.indexOf=function(e,t,i){if(null==e)return-1;var n=0,s=e.length;if(i){if("number"!=typeof i)return n=k.sortedIndex(e,t),e[n]===t?n:-1;n=0>i?Math.max(0,s+i):i}if(v&&e.indexOf===v)return e.indexOf(t,i);for(;s>n;n++)if(e[n]===t)return n;return-1},k.lastIndexOf=function(e,t,i){if(null==e)return-1;var n=null!=i;if(b&&e.lastIndexOf===b)return n?e.lastIndexOf(t,i):e.lastIndexOf(t);for(var s=n?i:e.length;s--;)if(e[s]===t)return s;return-1},k.range=function(e,t,i){arguments.length<=1&&(t=e||0,e=0),i=arguments[2]||1;for(var n=Math.max(Math.ceil((t-e)/i),0),s=0,a=new Array(n);n>s;)a[s++]=e,e+=i;return a};var E=function(){};k.bind=function(e,t){var i,n;if(e.bind===L&&L)return L.apply(e,o.call(arguments,1));if(!k.isFunction(e))throw new TypeError;return i=o.call(arguments,2),n=function(){if(!(this instanceof n))return e.apply(t,i.concat(o.call(arguments)));E.prototype=e.prototype;var s=new E;E.prototype=null;var a=e.apply(s,i.concat(o.call(arguments)));return Object(a)===a?a:s}},k.bindAll=function(e){var t=o.call(arguments,1);return 0==t.length&&(t=k.functions(e)),O(t,function(t){e[t]=k.bind(e[t],e)}),e},k.memoize=function(e,t){var i={};return t||(t=k.identity),function(){var n=t.apply(this,arguments);return k.has(i,n)?i[n]:i[n]=e.apply(this,arguments)}},k.delay=function(e,t){var i=o.call(arguments,2);return setTimeout(function(){return e.apply(null,i)},t)},k.defer=function(e){return k.delay.apply(k,[e,1].concat(o.call(arguments,1)))},k.throttle=function(e,t){var i,n,s,a,r=0,o=function(){r=new Date,s=null,a=e.apply(i,n)};return function(){var l=new Date,u=t-(l-r);return i=this,n=arguments,0>=u?(clearTimeout(s),s=null,r=l,a=e.apply(i,n)):s||(s=setTimeout(o,u)),a}},k.debounce=function(e,t,i){var n,s;return function(){var a=this,r=arguments,o=function(){n=null,i||(s=e.apply(a,r))},l=i&&!n;return clearTimeout(n),n=setTimeout(o,t),l&&(s=e.apply(a,r)),s}},k.once=function(e){var t,i=!1;return function(){return i?t:(i=!0,t=e.apply(this,arguments),e=null,t)}},k.wrap=function(e,t){return function(){var i=[e];return r.apply(i,arguments),t.apply(this,i)}},k.compose=function(){var e=arguments;return function(){for(var t=arguments,i=e.length-1;i>=0;i--)t=[e[i].apply(this,t)];return t[0]}},k.after=function(e,t){return 0>=e?t():function(){return--e<1?t.apply(this,arguments):void 0}},k.keys=w||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var i in e)k.has(e,i)&&(t[t.length]=i);return t},k.values=function(e){var t=[];for(var i in e)k.has(e,i)&&t.push(e[i]);return t},k.pairs=function(e){var t=[];for(var i in e)k.has(e,i)&&t.push([i,e[i]]);return t},k.invert=function(e){var t={};for(var i in e)k.has(e,i)&&(t[e[i]]=i);return t},k.functions=k.methods=function(e){var t=[];for(var i in e)k.isFunction(e[i])&&t.push(i);return t.sort()},k.extend=function(e){return O(o.call(arguments,1),function(t){if(t)for(var i in t)e[i]=t[i]}),e},k.pick=function(e){var t={},i=l.apply(n,o.call(arguments,1));return O(i,function(i){i in e&&(t[i]=e[i])}),t},k.omit=function(e){var t={},i=l.apply(n,o.call(arguments,1));for(var s in e)k.contains(i,s)||(t[s]=e[s]);return t},k.defaults=function(e){return O(o.call(arguments,1),function(t){if(t)for(var i in t)null==e[i]&&(e[i]=t[i])}),e},k.clone=function(e){return k.isObject(e)?k.isArray(e)?e.slice():k.extend({},e):e},k.tap=function(e,t){return t(e),e};var j=function(e,t,i,n){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof k&&(e=e._wrapped),t instanceof k&&(t=t._wrapped);var s=u.call(e);if(s!=u.call(t))return!1;switch(s){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var a=i.length;a--;)if(i[a]==e)return n[a]==t;i.push(e),n.push(t);var r=0,o=!0;if("[object Array]"==s){if(r=e.length,o=r==t.length)for(;r--&&(o=j(e[r],t[r],i,n)););}else{var l=e.constructor,c=t.constructor;if(l!==c&&!(k.isFunction(l)&&l instanceof l&&k.isFunction(c)&&c instanceof c))return!1;for(var h in e)if(k.has(e,h)&&(r++,!(o=k.has(t,h)&&j(e[h],t[h],i,n))))break;if(o){for(h in t)if(k.has(t,h)&&!r--)break;o=!r}}return i.pop(),n.pop(),o};k.isEqual=function(e,t){return j(e,t,[],[])},k.isEmpty=function(e){if(null==e)return!0;if(k.isArray(e)||k.isString(e))return 0===e.length;for(var t in e)if(k.has(e,t))return!1;return!0},k.isElement=function(e){return!(!e||1!==e.nodeType)},k.isArray=_||function(e){return"[object Array]"==u.call(e)},k.isObject=function(e){return e===Object(e)},O(["Arguments","Function","String","Number","Date","RegExp"],function(e){k["is"+e]=function(t){return u.call(t)=="[object "+e+"]"}}),k.isArguments(arguments)||(k.isArguments=function(e){return!(!e||!k.has(e,"callee"))}),"function"!=typeof/./&&(k.isFunction=function(e){return"function"==typeof e}),k.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},k.isNaN=function(e){return k.isNumber(e)&&e!=+e},k.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==u.call(e)},k.isNull=function(e){return null===e},k.isUndefined=function(e){return void 0===e},k.has=function(e,t){return c.call(e,t)},k.noConflict=function(){return e._=t,this},k.identity=function(e){return e},k.times=function(e,t,i){for(var n=Array(e),s=0;e>s;s++)n[s]=t.call(i,s);return n},k.random=function(e,t){return null==t&&(t=e,e=0),e+(0|Math.random()*(t-e+1))};var N={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};N.unescape=k.invert(N.escape);var z={escape:new RegExp("["+k.keys(N.escape).join("")+"]","g"),unescape:new RegExp("("+k.keys(N.unescape).join("|")+")","g")};k.each(["escape","unescape"],function(e){k[e]=function(t){return null==t?"":(""+t).replace(z[e],function(t){return N[e][t]})}}),k.result=function(e,t){if(null==e)return null;var i=e[t];return k.isFunction(i)?i.call(e):i},k.mixin=function(e){O(k.functions(e),function(t){var i=k[t]=e[t];k.prototype[t]=function(){var e=[this._wrapped];return r.apply(e,arguments),B.call(this,i.apply(k,e))}})};var T=0;k.uniqueId=function(e){var t=""+ ++T;return e?e+t:t},k.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var I=/(.)^/,R={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},F=/\\|'|\r|\n|\t|\u2028|\u2029/g;k.template=function(e,t,i){i=k.defaults({},i,k.templateSettings);var n=new RegExp([(i.escape||I).source,(i.interpolate||I).source,(i.evaluate||I).source].join("|")+"|$","g"),s=0,a="__p+='";
e.replace(n,function(t,i,n,r,o){return a+=e.slice(s,o).replace(F,function(e){return"\\"+R[e]}),i&&(a+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"),n&&(a+="'+\n((__t=("+n+"))==null?'':__t)+\n'"),r&&(a+="';\n"+r+"\n__p+='"),s=o+t.length,t}),a+="';\n",i.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{var r=new Function(i.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return r(t,k);var l=function(e){return r.call(this,e,k)};return l.source="function("+(i.variable||"obj")+"){\n"+a+"}",l},k.chain=function(e){return k(e).chain()};var B=function(e){return this._chain?k(e).chain():e};k.mixin(k),O(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=n[e];k.prototype[e]=function(){var i=this._wrapped;return t.apply(i,arguments),"shift"!=e&&"splice"!=e||0!==i.length||delete i[0],B.call(this,i)}}),O(["concat","join","slice"],function(e){var t=n[e];k.prototype[e]=function(){return B.call(this,t.apply(this._wrapped,arguments))}}),k.extend(k.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this),function(){var e,t=this,i=t.Backbone,n=[],s=n.push,a=n.slice,r=n.splice;e="undefined"!=typeof exports?exports:t.Backbone={},e.VERSION="0.9.9";var o=t._;o||"undefined"==typeof require||(o=require("underscore")),e.$=t.jQuery||t.Zepto||t.ender,e.noConflict=function(){return t.Backbone=i,this},e.emulateHTTP=!1,e.emulateJSON=!1;var l=/\s+/,u=function(e,t,i,n){if(!i)return!0;if("object"==typeof i)for(var s in i)e[t].apply(e,[s,i[s]].concat(n));else{if(!l.test(i))return!0;for(var a=i.split(l),r=0,o=a.length;o>r;r++)e[t].apply(e,[a[r]].concat(n))}},c=function(e,t,i){var n,s=-1,a=t.length;switch(i.length){case 0:for(;++s<a;)(n=t[s]).callback.call(n.ctx);return;case 1:for(;++s<a;)(n=t[s]).callback.call(n.ctx,i[0]);return;case 2:for(;++s<a;)(n=t[s]).callback.call(n.ctx,i[0],i[1]);return;case 3:for(;++s<a;)(n=t[s]).callback.call(n.ctx,i[0],i[1],i[2]);return;default:for(;++s<a;)(n=t[s]).callback.apply(n.ctx,i)}},h=e.Events={on:function(e,t,i){if(!u(this,"on",e,[t,i])||!t)return this;this._events||(this._events={});var n=this._events[e]||(this._events[e]=[]);return n.push({callback:t,context:i,ctx:i||this}),this},once:function(e,t,i){if(!u(this,"once",e,[t,i])||!t)return this;var n=this,s=o.once(function(){n.off(e,s),t.apply(this,arguments)});return s._callback=t,this.on(e,s,i),this},off:function(e,t,i){var n,s,a,r,l,c,h,d;if(!this._events||!u(this,"off",e,[t,i]))return this;if(!e&&!t&&!i)return this._events={},this;for(r=e?[e]:o.keys(this._events),l=0,c=r.length;c>l;l++)if(e=r[l],n=this._events[e]){if(a=[],t||i)for(h=0,d=n.length;d>h;h++)s=n[h],(t&&t!==(s.callback._callback||s.callback)||i&&i!==s.context)&&a.push(s);this._events[e]=a}return this},trigger:function(e){if(!this._events)return this;var t=a.call(arguments,1);if(!u(this,"trigger",e,t))return this;var i=this._events[e],n=this._events.all;return i&&c(this,i,t),n&&c(this,n,arguments),this},listenTo:function(e,t,i){var n=this._listeners||(this._listeners={}),s=e._listenerId||(e._listenerId=o.uniqueId("l"));return n[s]=e,e.on(t,i||this,this),this},stopListening:function(e,t,i){var n=this._listeners;if(n){if(e)e.off(t,i,this),t||i||delete n[e._listenerId];else{for(var s in n)n[s].off(null,null,this);this._listeners={}}return this}}};h.bind=h.on,h.unbind=h.off,o.extend(e,h);var d=e.Model=function(e,t){var i,n=e||{};this.cid=o.uniqueId("c"),this.changed={},this.attributes={},this._changes=[],t&&t.collection&&(this.collection=t.collection),t&&t.parse&&(n=this.parse(n)),(i=o.result(this,"defaults"))&&o.defaults(n,i),this.set(n,{silent:!0}),this._currentAttributes=o.clone(this.attributes),this._previousAttributes=o.clone(this.attributes),this.initialize.apply(this,arguments)};o.extend(d.prototype,h,{changed:null,idAttribute:"id",initialize:function(){},toJSON:function(){return o.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return o.escape(this.get(e))},has:function(e){return null!=this.get(e)},set:function(e,t,i){var n,s;if(null==e)return this;o.isObject(e)?(s=e,i=t):(s={})[e]=t;var a=i&&i.silent,r=i&&i.unset;if(!this._validate(s,i))return!1;this.idAttribute in s&&(this.id=s[this.idAttribute]);var l=this.attributes;for(n in s)t=s[n],r?delete l[n]:l[n]=t,this._changes.push(n,t);return this._hasComputed=!1,a||this.change(i),this},unset:function(e,t){return this.set(e,void 0,o.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var i in this.attributes)t[i]=void 0;return this.set(t,o.extend({},e,{unset:!0}))},fetch:function(e){e=e?o.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=this,i=e.success;return e.success=function(n){return t.set(t.parse(n),e)?(i&&i(t,n,e),void 0):!1},this.sync("read",this,e)},save:function(e,t,i){var n,s,a;if(null==e||o.isObject(e)?(n=e,i=t):null!=e&&((n={})[e]=t),i=i?o.clone(i):{},i.wait){if(n&&!this._validate(n,i))return!1;s=o.clone(this.attributes)}var r=o.extend({},i,{silent:!0});if(n&&!this.set(n,i.wait?r:i))return!1;if(!n&&!this._validate(null,i))return!1;var l=this,u=i.success;i.success=function(e){a=!0;var t=l.parse(e);return i.wait&&(t=o.extend(n||{},t)),l.set(t,i)?(u&&u(l,e,i),void 0):!1};var c=this.isNew()?"create":i.patch?"patch":"update";"patch"==c&&(i.attrs=n);var h=this.sync(c,this,i);return!a&&i.wait&&(this.clear(r),this.set(s,r)),h},destroy:function(e){e=e?o.clone(e):{};var t=this,i=e.success,n=function(){t.trigger("destroy",t,t.collection,e)};if(e.success=function(s){(e.wait||t.isNew())&&n(),i&&i(t,s,e)},this.isNew())return e.success(),!1;var s=this.sync("delete",this,e);return e.wait||n(),s},url:function(){var e=o.result(this,"urlRoot")||o.result(this.collection,"url")||j();return this.isNew()?e:e+("/"===e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(e){var t=this._changing;this._changing=!0;var i=this._computeChanges(!0);this._pending=!!i.length;for(var n=i.length-2;n>=0;n-=2)this.trigger("change:"+i[n],this,i[n+1],e);if(t)return this;for(;this._pending;)this._pending=!1,this.trigger("change",this,e),this._previousAttributes=o.clone(this.attributes);return this._changing=!1,this},hasChanged:function(e){return this._hasComputed||this._computeChanges(),null==e?!o.isEmpty(this.changed):o.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?o.clone(this.changed):!1;var t,i=!1,n=this._previousAttributes;for(var s in e)o.isEqual(n[s],t=e[s])||((i||(i={}))[s]=t);return i},_computeChanges:function(e){this.changed={};for(var t={},i=[],n=this._currentAttributes,s=this._changes,a=s.length-2;a>=0;a-=2){var r=s[a],o=s[a+1];if(!t[r]&&(t[r]=!0,n[r]!==o)){if(this.changed[r]=o,!e)continue;i.push(r,o),n[r]=o}}return e&&(this._changes=[]),this._hasComputed=!0,i},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return o.clone(this._previousAttributes)},_validate:function(e,t){if(!this.validate)return!0;e=o.extend({},this.attributes,e);var i=this.validate(e,t);return i?(t&&t.error&&t.error(this,i,t),this.trigger("error",this,i,t),!1):!0}});var p=e.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,o.extend({silent:!0},t))};o.extend(p.prototype,h,{model:d,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return e.sync.apply(this,arguments)},add:function(e,t){var i,n,a,l,u,c=t&&t.at,h=null==(t&&t.sort)?!0:t.sort;for(e=o.isArray(e)?e.slice():[e],i=e.length-1;i>=0;i--)(a=this._prepareModel(e[i],t))?(e[i]=a,l=null!=a.id&&this._byId[a.id],l||this._byCid[a.cid]?(t&&t.merge&&l&&(l.set(a.attributes,t),u=h),e.splice(i,1)):(a.on("all",this._onModelEvent,this),this._byCid[a.cid]=a,null!=a.id&&(this._byId[a.id]=a))):(this.trigger("error",this,e[i],t),e.splice(i,1));if(e.length&&(u=h),this.length+=e.length,n=[null!=c?c:this.models.length,0],s.apply(n,e),r.apply(this.models,n),u&&this.comparator&&null==c&&this.sort({silent:!0}),t&&t.silent)return this;for(;a=e.shift();)a.trigger("add",a,this,t);return this},remove:function(e,t){var i,n,s,a;for(t||(t={}),e=o.isArray(e)?e.slice():[e],i=0,n=e.length;n>i;i++)a=this.get(e[i]),a&&(delete this._byId[a.id],delete this._byCid[a.cid],s=this.indexOf(a),this.models.splice(s,1),this.length--,t.silent||(t.index=s,a.trigger("remove",a,this,t)),this._removeReference(a));return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,o.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,o.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return null==e?void 0:this._byId[null!=e.id?e.id:e]||this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return o.isEmpty(e)?[]:this.filter(function(t){for(var i in e)if(e[i]!==t.get(i))return!1;return!0})},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return o.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(o.bind(this.comparator,this)),e&&e.silent||this.trigger("sort",this,e),this},pluck:function(e){return o.invoke(this.models,"get",e)},update:function(e,t){var i,n,s,a,r=[],l=[],u={},c=this.model.prototype.idAttribute;if(t=o.extend({add:!0,merge:!0,remove:!0},t),t.parse&&(e=this.parse(e)),o.isArray(e)||(e=e?[e]:[]),t.add&&!t.remove)return this.add(e,t);for(n=0,s=e.length;s>n;n++)i=e[n],a=this.get(i.id||i.cid||i[c]),t.remove&&a&&(u[a.cid]=!0),(t.add&&!a||t.merge&&a)&&r.push(i);if(t.remove)for(n=0,s=this.models.length;s>n;n++)i=this.models[n],u[i.cid]||l.push(i);return l.length&&this.remove(l,t),r.length&&this.add(r,t),this},reset:function(e,t){t||(t={}),t.parse&&(e=this.parse(e));for(var i=0,n=this.models.length;n>i;i++)this._removeReference(this.models[i]);return t.previousModels=this.models,this._reset(),e&&this.add(e,o.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},fetch:function(e){e=e?o.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=this,i=e.success;return e.success=function(n){var s=e.update?"update":"reset";t[s](n,e),i&&i(t,n,e)},this.sync("read",this,e)},create:function(e,t){var i=this;if(t=t?o.clone(t):{},e=this._prepareModel(e,t),!e)return!1;t.wait||i.add(e,t);var n=t.success;return t.success=function(e,t,s){s.wait&&i.add(e,s),n&&n(e,t,s)},e.save(null,t),e},parse:function(e){return e},clone:function(){return new this.constructor(this.models)},chain:function(){return o(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){if(e instanceof d)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var i=new this.model(e,t);return i._validate(e,t)?i:!1},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,i,n){("add"!==e&&"remove"!==e||i===this)&&("destroy"===e&&this.remove(t,n),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],null!=t.id&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments))}});var f=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortedIndex","toArray","size","first","head","take","initial","rest","tail","last","without","indexOf","shuffle","lastIndexOf","isEmpty"];o.each(f,function(e){p.prototype[e]=function(){var t=a.call(arguments);return t.unshift(this.models),o[e].apply(o,t)}});var m=["groupBy","countBy","sortBy"];o.each(m,function(e){p.prototype[e]=function(t,i){var n=o.isFunction(t)?t:function(e){return e.get(t)};return o[e](this.models,n,i)}});var g=e.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},y=/\((.*?)\)/g,v=/:\w+/g,b=/\*\w+/g,_=/[\-{}\[\]+?.,\\\^$|#\s]/g;o.extend(g.prototype,h,{initialize:function(){},route:function(t,i,n){return o.isRegExp(t)||(t=this._routeToRegExp(t)),n||(n=this[i]),e.history.route(t,o.bind(function(s){var a=this._extractParameters(t,s);n&&n.apply(this,a),this.trigger.apply(this,["route:"+i].concat(a)),e.history.trigger("route",this,i,a)},this)),this},navigate:function(t,i){return e.history.navigate(t,i),this},_bindRoutes:function(){if(this.routes)for(var e,t=o.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])},_routeToRegExp:function(e){return e=e.replace(_,"\\$&").replace(y,"(?:$1)?").replace(v,"([^/]+)").replace(b,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var w=e.History=function(){this.handlers=[],o.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},L=/^[#\/]|\s+$/g,k=/^\/+|\/+$/g,O=/msie [\w.]+/,x=/\/$/;w.started=!1,o.extend(w.prototype,h,{interval:50,getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(null==e)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var i=this.root.replace(x,"");e.indexOf(i)||(e=e.substr(i.length))}else e=this.getHash();return e.replace(L,"")},start:function(t){if(w.started)throw new Error("Backbone.history has already been started");w.started=!0,this.options=o.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var i=this.getFragment(),n=document.documentMode,s=O.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(k,"/"),s&&this._wantsHashChange&&(this.iframe=e.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(i)),this._hasPushState?e.$(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!s?e.$(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=i;var a=this.location,r=a.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!r?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&r&&a.hash&&(this.fragment=this.getHash().replace(L,""),this.history.replaceState({},document.title,this.root+this.fragment+a.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){e.$(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),w.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();return e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e===this.fragment?!1:(this.iframe&&this.navigate(e),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(e){var t=this.fragment=this.getFragment(e),i=o.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0});return i},navigate:function(e,t){if(!w.started)return!1;if(t&&t!==!0||(t={trigger:t}),e=this.getFragment(e||""),this.fragment!==e){this.fragment=e;var i=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)}},_updateHash:function(e,t,i){if(i){var n=e.href.replace(/(javascript:|#).*$/,"");e.replace(n+"#"+t)}else e.hash="#"+t}}),e.history=new w;var S=e.View=function(e){this.cid=o.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},C=/^(\S+)\s*(.*)$/,M=["model","collection","el","id","attributes","className","tagName","events"];o.extend(S.prototype,h,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},make:function(t,i,n){var s=document.createElement(t);return i&&e.$(s).attr(i),null!=n&&e.$(s).html(n),s},setElement:function(t,i){return this.$el&&this.undelegateEvents(),this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0],i!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(e||(e=o.result(this,"events"))){this.undelegateEvents();for(var t in e){var i=e[t];if(o.isFunction(i)||(i=this[e[t]]),!i)throw new Error('Method "'+e[t]+'" does not exist');var n=t.match(C),s=n[1],a=n[2];i=o.bind(i,this),s+=".delegateEvents"+this.cid,""===a?this.$el.bind(s,i):this.$el.delegate(a,s,i)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=o.extend({},o.result(this,"options"),e)),o.extend(this,o.pick(e,M)),this.options=e},_ensureElement:function(){if(this.el)this.setElement(o.result(this,"el"),!1);else{var e=o.extend({},o.result(this,"attributes"));this.id&&(e.id=o.result(this,"id")),this.className&&(e["class"]=o.result(this,"className")),this.setElement(this.make(o.result(this,"tagName"),e),!1)}}});var P={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.sync=function(t,i,n){var s=P[t];o.defaults(n||(n={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var a={type:s,dataType:"json"};if(n.url||(a.url=o.result(i,"url")||j()),null!=n.data||!i||"create"!==t&&"update"!==t&&"patch"!==t||(a.contentType="application/json",a.data=JSON.stringify(n.attrs||i.toJSON(n))),n.emulateJSON&&(a.contentType="application/x-www-form-urlencoded",a.data=a.data?{model:a.data}:{}),n.emulateHTTP&&("PUT"===s||"DELETE"===s||"PATCH"===s)){a.type="POST",n.emulateJSON&&(a.data._method=s);var r=n.beforeSend;n.beforeSend=function(e){return e.setRequestHeader("X-HTTP-Method-Override",s),r?r.apply(this,arguments):void 0}}"GET"===a.type||n.emulateJSON||(a.processData=!1);var l=n.success;n.success=function(e,t,s){l&&l(e,t,s),i.trigger("sync",i,e,n)};var u=n.error;n.error=function(e){u&&u(i,e,n),i.trigger("error",i,e,n)};var c=e.ajax(o.extend(a,n));return i.trigger("request",i,c,n),c},e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var E=function(e,t){var i,n=this;i=e&&o.has(e,"constructor")?e.constructor:function(){n.apply(this,arguments)},o.extend(i,n,t);var s=function(){this.constructor=i};return s.prototype=n.prototype,i.prototype=new s,e&&o.extend(i.prototype,e),i.__super__=n.prototype,i};d.extend=p.extend=g.extend=S.extend=w.extend=E;var j=function(){throw new Error('A "url" property or function must be specified')}}.call(this),function(){function e(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function t(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var i=this._,n=this.Backbone;n.LocalStorage=window.Store=function(e){this.name=e;var t=this.localStorage().getItem(this.name);this.records=t&&t.split(",")||[]},i.extend(n.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return e.id||(e.id=t(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),this.records.push(e.id.toString()),this.save(),e.toJSON()},update:function(e){return this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),i.include(this.records,e.id.toString())||this.records.push(e.id.toString()),this.save(),e.toJSON()},find:function(e){return JSON.parse(this.localStorage().getItem(this.name+"-"+e.id))},findAll:function(){return i(this.records).chain().map(function(e){return JSON.parse(this.localStorage().getItem(this.name+"-"+e))},this).compact().value()},destroy:function(e){return this.localStorage().removeItem(this.name+"-"+e.id),this.records=i.reject(this.records,function(t){return t==e.id.toString()}),this.save(),e},localStorage:function(){return localStorage}}),n.LocalStorage.sync=window.Store.sync=n.localSync=function(e,t,i,n){var s=t.localStorage||t.collection.localStorage;"function"==typeof i&&(i={success:i,error:n});var a;switch(e){case"read":a=void 0!=t.id?s.find(t):s.findAll();break;case"create":a=s.create(t);break;case"update":a=s.update(t);break;case"delete":a=s.destroy(t)}a?i.success(a):i.error("Record not found")},n.ajaxSync=n.sync,n.getSyncMethod=function(e){return e.localStorage||e.collection&&e.collection.localStorage?n.localSync:n.ajaxSync},n.sync=function(e,t,i,s){return n.getSyncMethod(t).apply(this,[e,t,i,s])}}(),Oskari.clazz.define("Oskari.integration.bundle.bb.Flyout",function(e,t,i){this.instance=e,this.locale=t,this.container=null,this.ui=i,this.state=null},{getName:function(){return"Oskari.integration.bundle.bb.Flyout"},setEl:function(e){this.container=jQuery(e)},getEl:function(){return this.container},startPlugin:function(){var e=this;e.locale;var t=e.ui;t.setEl(e.container),t.render()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){return this.locale.description},setState:function(e){this.state=e},getState:function(){return this.state},render:function(){this.ui.render()}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.integration.bundle.bb.Tile",function(e,t){this.instance=e,this.locale=t,this.container=null,this.template=null},{getName:function(){return"Oskari.integration.bundle.bb.Tile"},setEl:function(e){this.container=$(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.locale.title},getDescription:function(){},getOptions:function(){},setState:function(e){this.state=e},refresh:function(){var e=this,t=e.instance;this.container,this.template,t.getSandbox()}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.integration.bundle.bb.View",function(e,t,i){this.locale=e,this.view=null,this.instance=t,this.conf=i},{setEl:function(e){this.container=e},getEl:function(){return this.container},requirements:[],render:function(){throw"Abstract"},getLocalization:function(){return this.locale},getConfiguration:function(){return this.conf},getSandbox:function(){return this.instance.getSandbox()},getLang:function(){return Oskari.getLang()},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},slicer:Array.prototype.slice,request:function(){return this.getSandbox().requestByName(this.instance,arguments[0],this.slicer.apply(arguments,1))},getName:function(){return this.instance.getName()}}),Oskari.clazz.define("Oskari.integration.bundle.bb.AdapterBundleInstance",function(e,t){this.sandbox=null,this.plugins={},this._localization=null,this._viewClazz=t,this._name=e,this._view=null},{getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},getSandbox:function(){return this.sandbox},update:function(){},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this,t=e.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,n.register(this);var s=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,s)},stop:function(){var e=this.sandbox,t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),e.unregister(this),this.sandbox=null,this.started=!1},startExtension:function(){var e=this,t=e.sandbox,i=e.getLocalization("flyout"),n=this._viewClazz,s=Oskari.clazz.create(n,this.getLocalization("view"),this,this.getConfiguration());this.view=s;for(p in s.eventHandlers)t.registerForEventByName(s,p);e.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.integration.bundle.bb.Flyout",e,i,s),null!=s.init&&this.view.init();var a=e.getLocalization("tile");e.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.integration.bundle.bb.Tile",e,a)},stopExtension:function(){var e=this,t=e.sandbox,i=e.view;for(p in i.eventHandlers)t.unregisterFromEventByName(i,p);for(var n in e.plugins)n&&(e.plugins[n]=null)},getPlugins:function(){return this.plugins},init:function(){return null},getName:function(){return this._name},getConfiguration:function(){return this.conf},setState:function(){},getState:function(){}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.AnalyseBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.analysis.bundle.analyse.AnalyseBundleInstance");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/instance.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/Tile.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/view/StartView.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/view/StartAnalyse.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/view/AnalyseValidations.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/view/AnalyseFilterMethods.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/view/Categoryform.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/view/PersonalDataTab.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/request/AnalyseRequest.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/request/AnalyseRequestHandler.js"},{type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/service/AnalyseService.js"},{type:"text/css",src:"../../../../resources/analysis/bundle/analyse/css/style.css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/analysis/bundle/analyse/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"analyse","Bundle-Name":"analyse","Bundle-Author":[{Name:"jjk",Organisation:"nls.fi",Temporal:{Start:"2009",End:"2011"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Name-Locale":{fi:{Name:" Analyse",Title:" Analyse"},en:{}},"Bundle-Version":"1.0.0","Import-Namespace":["Oskari","jquery"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("analyse","Oskari.analysis.bundle.analyse.AnalyseBundle"),Oskari.clazz.define("Oskari.analysis.bundle.analyse.AnalyseBundleInstance",function(){this.sandbox=void 0,this.started=!1,this.plugins={},this.localization=void 0,this.analyse=void 0,this.buttonGroup="viewtools",this.ignoreEvents=!1,this.dialog=void 0,this.analyseHandler=void 0,this.analyseService=void 0,this.isMapStateChanged=!0,this.state=void 0,this.conf={},this.personalDataTab=void 0},{__name:"Analyse",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(!e.started){e.started=!0;var t=this.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i);e.sandbox=n,this.localization=Oskari.getLocalization(this.getName()),n.register(e);for(p in e.eventHandlers)n.registerForEventByName(e,p);this.analyseHandler=Oskari.clazz.create("Oskari.analysis.bundle.analyse.request.AnalyseRequestHandler",e),n.addRequestHandler("analyse.AnalyseRequest",this.analyseHandler),this.analyseService=Oskari.clazz.create("Oskari.analysis.bundle.analyse.service.AnalyseService",e),n.registerService(this.analyseService),this.mapLayerService=n.getService("Oskari.mapframework.service.MapLayerService");var s=n.getRequestBuilder("userinterface.AddExtensionRequest")(this);n.request(this,s),e._createUi(),this.analyseService.loadAnalyseLayers(),t&&t.stateful===!0&&n.registerAsStateful(this.mediator.bundleId,this);var a=Oskari.clazz.create("Oskari.mapframework.bundle.analyse.view.PersonalDataTab",this,this.localization.personalDataTab),r=n.getRequestBuilder("PersonalData.AddTabRequest");r&&n.request(this,r(this.localization.personalDataTab.title,a.getContent())),this.personalDataTab=a}},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{MapLayerVisibilityChangedEvent:function(){this.analyse&&this.analyse.isEnabled&&this.isMapStateChanged&&(this.isMapStateChanged=!1,this.getSandbox().printDebug("ANALYSE REFRESH"),this.analyse.refreshAnalyseData(!0))},AfterMapMoveEvent:function(){this.isMapStateChanged=!0,this.analyse&&this.analyse.isEnabled&&this.analyse.refreshAnalyseData(!1),this.isMapStateChanged=!0},AfterMapLayerAddEvent:function(){this.isMapStateChanged=!0,this.analyse&&this.analyse.isEnabled&&this.analyse.refreshAnalyseData(!1)},AfterMapLayerRemoveEvent:function(e){if(this.isMapStateChanged=!0,this.analyse&&this.analyse.isEnabled){this.analyse.refreshAnalyseData(!1);var t=e.getMapLayer();this.analyse.removeFilterJson(t.getId())}},AfterChangeMapLayerStyleEvent:function(){this.isMapStateChanged=!0,this.analyse&&this.analyse.isEnabled&&this.analyse.refreshAnalyseData(!1)},MapLayerEvent:function(e){this._afterMapLayerEvent(e)},"userinterface.ExtensionUpdatedEvent":function(e){var t=this;if(e.getExtension().getName()==t.getName()){var i="close"!=e.getViewState();t.displayContent(i)}}},stop:function(){this.analyse&&(this.analyse.destroy(),this.analyse=void 0);var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.removeRequestHandler("analyse.AnalyseRequest",this.analyseHandler),this.analyseHandler=null;var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.analysis.bundle.analyse.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.analysis.bundle.analyse.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},_createUi:function(){this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()},setAnalyseMode:function(e){var t=this,i=jQuery("#contentMap");if(jQuery("#maptools"),1==e){var n=t.sandbox.getRequestBuilder("userinterface.UpdateExtensionRequest")(t,"close",t.getName());t.sandbox.request(t.getName(),n),this.analyse?(this.analyse.refreshAnalyseData(),this.analyse.refreshExtraParameters()):(this.analyse=Oskari.clazz.create("Oskari.analysis.bundle.analyse.view.StartAnalyse",this,this.getLocalization("AnalyseView")),this.analyse.render(i)),this.state&&this.analyse.setState(this.state),this.analyse.show(),this.analyse.setEnabled(!0)
}else this.analyse&&(this.analyse.setEnabled(!1),this.analyse.hide())},displayContent:function(e){e&&this.plugins["Oskari.userinterface.Flyout"].refresh()},setState:function(e){this.state=e},getState:function(){var e=this.state||{};return this.analyse&&(e=this.analyse.getState()),e},showMessage:function(e,t){var i=Oskari.clazz.create("Oskari.userinterface.component.Popup");i.show(e,t),i.fadeout(5e3)},_afterMapLayerEvent:function(e){var t=e.getLayerId();if(this.getLocalization("AnalyseView"),"add"===e.getOperation()){var i=this.mapLayerService.findMapLayer(t);i&&i.isLayerOfType("ANALYSIS")}this.personalDataTab.update()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension","Oskari.userinterface.Stateful"]}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.view=null},{getName:function(){return"Oskari.analysis.bundle.analyse.Flyout"},setEl:function(e){this.container=e[0],jQuery(this.container).hasClass("analyse")||jQuery(this.container).addClass("analyse")},startPlugin:function(){this.template=jQuery("<div></div>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("flyouttitle")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},createUi:function(){jQuery(this.container),this.view=Oskari.clazz.create("Oskari.analysis.bundle.analyse.view.StartView",this.instance,this.instance.getLocalization("StartView"))},refresh:function(){var e=jQuery(this.container);e.empty(),"1"!=jQuery.cookie("analyse_info_seen")?this.view.render(e):this.instance.setAnalyseMode(!0)}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.analysis.bundle.analyse.Tile"},setEl:function(e){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.view.StartView",function(e,t){this.instance=e,this.template=jQuery("<div class='startview'><div class='content'></div><div class='buttons'></div></div>"),this.templateError=jQuery('<div class="error"><ul></ul></div>'),this.templateInfo=jQuery("<div class='icon-info'></div>"),this.checkboxTemplate=jQuery('<input type="checkbox" name="analyse_info_seen" id="analyse_info_seen" value="1">'),this.labelTemplate=jQuery('<label for="analyse_info_seen"></label>'),this.loc=t,this.appendAlwaysCheckbox=!0,this.content=void 0,this.buttons={},this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert")},{render:function(e){var t=this,i=this.template.clone();this.content=i,e.append(i),this.alert.insertTo(e),this.alert.setContent(this.loc.text,"default",!0);var n=Oskari.clazz.create("Oskari.userinterface.component.Button");if(n.addClass("primary"),n.setTitle(this.loc.buttons["continue"]),n.setHandler(function(){t.instance.setAnalyseMode(!0)}),this.buttons["continue"]=n,n.insertTo(i.find("div.buttons")),t.appendAlwaysCheckbox){i.append("<br><br>");var s=this.checkboxTemplate.clone(),a=this.labelTemplate.clone();a.append(t.loc.infoseen.label),s.bind("change",function(){jQuery(this).attr("checked")?jQuery.cookie("analyse_info_seen","1",{expires:365}):jQuery.cookie("analyse_info_seen","0",{expires:1})}),i.append(s),i.append("&nbsp;"),i.append(a)}var r=Oskari.clazz.create("Oskari.userinterface.component.Button");r.setTitle(this.loc.buttons.cancel),r.setHandler(function(){t.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[t.instance,"close"])}),this.buttons.cancel=r,r.insertTo(i.find("div.buttons"))}}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.view.StartAnalyse",function(e,t){this.isEnabled=!1,this.instance=e,this.loc=t,this.id_prefix="oskari_analyse_",this.layer_prefix="analysis_",this.template={};for(p in this.__templates)this.template[p]=jQuery(this.__templates[p]);this.methodOptions=this.loc.method.options,this.methodOptionsMap={};for(var i=0;i<this.methodOptions.length;i++)this.methodOptionsMap[this.methodOptions[i].id]=this.methodOptions[i];this.paramsOptions=this.loc.params.options,this.paramsOptionsMap={};for(var n=0;n<this.paramsOptions.length;n++)this.paramsOptionsMap[this.paramsOptions[n].id]=this.paramsOptions[n];this.aggreOptions=this.loc.aggregate.options,this.aggreOptionsMap={};for(var n=0;n<this.aggreOptions.length;n++)this.aggreOptionsMap[this.aggreOptions[n].id]=this.aggreOptions[n];this.spatialOptions=this.loc.spatial.options,this.spatialOptionsMap={};for(var n=0;n<this.spatialOptions.length;n++)this.spatialOptionsMap[this.spatialOptions[n].id]=this.spatialOptions[n];this.contentOptionsMap={},this.intersectOptionsMap={},this.unionOptionsMap={},this.contentOptions={},this.intersectOptions={},this.unionOptions={},this.accordion=null,this.mainPanel=null,this.progressSpinner=Oskari.clazz.create("Oskari.userinterface.component.ProgressSpinner"),this.alert=Oskari.clazz.create("Oskari.userinterface.component.Alert"),this.previewContent=null,this.previewImgDiv=null,this.contentOptionDivs={},this.paramsOptionDivs={},this.aggreOptionDivs={},this._filterJsons={},this._filterPopups={}},{__templates:{content:'<div class="layer_data"></div>',icons_layer:'<table class=layer-icons> <tr> <td><div class="layer-icon layer-wfs" title="Tietotuote"></div></td><td><div class="layer-info icon-info"></div></td><td><div class="filter icon-funnel"></div></td></tr></table>',tool:'<div class="tool "><input type="checkbox"/><label></label></div>',buttons:'<div class="buttons"></div>',help:'<div class="help icon-info"></div>',main:'<div class="basic_analyse"><div class="header"><div class="icon-close"></div><h3></h3></div><div class="content"></div></div>',columnsContainer:'<div class="analyse-columns-container"></div>',columnsDropdown:'<select class="analyse-columns-dropdown"></select>',paramsOptionExtra:'<div class="extra_params"></div>',paramsOptionTool:'<div class="tool "><input type="radio" name="params" /><label></label></div>',aggreOptionTool:'<div class="tool "><input type="checkbox" name="aggre" /><label></label></div>',spatialOptionTool:'<div class="tool "><input type="radio" name="spatial" /><label></label></div>',intersectOptionTool:'<div class="tool "><input type="radio" name="intersect" /><label></label></div>',unionOptionTool:'<div class="tool "><input type="radio" name="union" /><label></label></div>',title:'<div class="analyse_title_cont analyse_settings_cont"><div class="settings_buffer_label"></div><input class="settings_buffer_field" type="text"></div>',title_name:'<div class="analyse_title_name analyse_settings_cont"><div class="settings_name_label"></div><input class="settings_name_field" type="text"></div>',title_color:'<div class="analyse_title_colcont analyse_output_cont"><div class="output_color_label"></div></div>',title_columns:'<div class="analyse_title_columns analyse_output_cont"><div class="columns_title_label"></div></div>',title_extra:'<div class="analyse_title_extra analyse_output_cont"><div class="extra_title_label"></div></div>',icon_colors:'<div class="icon-menu"></div>',option:'<div class="analyse_option_cont analyse_settings_cont"><input type="radio" name="selectedlayer" /><label></label></div>',methodOptionTool:'<div class="tool "><input type="radio" name="method" /><label></label></div>',featureListSelect:'<div class="analyse-select-featurelist"><a href="#">...</a></div>',featureList:'<div class="analyse-featurelist"><ul></ul></div>',featureListElement:'<li><input type="checkbox"></input><label></label></li>'},render:function(e){var t=this,i=this.template.main.clone();this.mainPanel=i,i.find("div.header h3").append(this.loc.title),e.append(i);var n=i.find("div.content");this.alert.insertTo(n);var s=Oskari.clazz.create("Oskari.userinterface.component.Accordion");this.accordion=s;var a=this._createContentPanel();a.open(),s.addPanel(a);var r=this._createMethodPanel();r.open(),s.addPanel(r);var o=this._createSettingsPanel();o.open(),s.addPanel(o);var l=this._createOutputPanel();s.addPanel(l),s.insertTo(n),e.find("div.header div.icon-close").bind("click",function(){t.instance.setAnalyseMode(!1)}),n.append(this._getButtons());var u=this.mainPanel.find("input[type=text]");u.focus(function(){t.instance.sandbox.postRequestByName("DisableMapKeyboardMovementRequest")}),u.blur(function(){t.instance.sandbox.postRequestByName("EnableMapKeyboardMovementRequest")});var c=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",this.instance.sandbox);c.processHelpLinks(this.loc.help,i,this.loc.error.title,this.loc.error.nohelp)},_createContentPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.content.label),e.contentPanel=t.getContainer();var i=this.template.help.clone();i.attr("title",this.loc.content.tooltip),e.contentPanel.append(i),e._addAnalyseData(e.contentPanel);var n=Oskari.clazz.create("Oskari.userinterface.component.Button");return n.setTitle(this.loc.buttons.data),n.addClass("primary"),n.setHandler(function(){e._modifyAnalyseData(e.contentPanel)}),n.insertTo(e.contentPanel),t},_createMethodPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.method.label);for(var i=t.getContainer(),n=function(t){return function(){i.find("input[name=method]:checked").val();for(var n=0;n<e.methodOptions.length;++n)e.methodOptions[n].selected=!1;t.selected=!0}},s=function(t){return function(){e._modifyExtraParameters(t.id)}},a=0;a<this.methodOptions.length;++a){var r=this.methodOptions[a];e.option_id=r.id;var o=this.template.methodOptionTool.clone(),l=r.label;r.width&&r.height&&(l=l+" ("+r.width+" x "+r.height+"px)"),o.find("label").append(l).attr({"for":r.id,"class":"method_radiolabel"}),r.selected&&o.find("input").attr("checked","checked");var u=this.template.help.clone();u.attr("title",r.tooltip),o.append(u),i.append(o),o.find("input").attr({value:r.id,name:"method",id:r.id}),o.find("input").change(n(r)),o.find("input").click(s(r))}return t},_createSettingsPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.settings.label);var i=t.getContainer(),n=this.template.help.clone();n.attr("title",this.loc.settings.tooltip),i.append(n);var s=this.template.paramsOptionExtra.clone();i.append(s),e._addExtraParameters(i,e.id_prefix+"buffer");var a=this.template.columnsContainer.clone();this._createColumnsSelector(a),i.append(a);var r=e._selectedLayers(),o="Analyysi_";r[0]&&(o+=r[0].name.substring(0,10));var l=e.template.title_name.clone();return l.find(".settings_name_label").html(e.loc.analyse_name.label),l.find(".settings_name_field").attr({value:o,placeholder:e.loc.analyse_name.tooltip}),i.append(l),t},_createColumnsSelector:function(e){var t=this,i=this.template.title_columns.clone();i.find(".columns_title_label").html(this.loc.params.label),e.append(i);for(var n=function(i){return function(){e.find("input[name=params]:checked").val();for(var n=0;n<t.paramsOptions.length;++n)t.paramsOptions[n].selected=!1;i.selected=!0}},s=0;s<this.paramsOptions.length;++s){var a=this.paramsOptions[s],r=this.template.paramsOptionTool.clone(),o=a.label;a.width&&a.height&&(o=o+" ("+a.width+" x "+a.height+"px)"),r.find("label").append(o).attr({"for":a.id,"class":"params_radiolabel"}),a.selected&&r.find("input[name=params]").attr("checked","checked"),"oskari_analyse_select"===a.id&&this._appendFeatureList(r),e.append(r),r.find("input[name=params]").attr({value:a.id,name:"params",id:a.id}),r.find("input[name=params]").change(n(a))}},_appendFeatureList:function(e){var t=this.template.featureListSelect.clone(),i=this.template.featureList.clone();t.append(i),e.append(t),i.hide(),i.find("ul").empty(),this._appendFields(i),t.find("a").on("click",function(e){e.preventDefault(),i.toggle()})},_appendFields:function(e){var t=this._getSelectedMapLayer();if(t){var i,n,s,a=t.getFields&&t.getFields()?t.getFields().slice():[],r=t.getLocales&&t.getLocales()?t.getLocales().slice():[];for(i=0;i<a.length;++i)a[i].match(/^__/)||(s=r[i]||a[i],n=this.template.featureListElement.clone(),n.find("input").val(a[i]),n.find("label").append(s).attr({"for":a[i]}),e.find("ul").append(n))}},_refreshFields:function(){var e=jQuery("div.analyse-featurelist");e.find("ul").empty(),this._appendFields(e)},_createOutputPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.output.label);var i=t.getContainer(),n=this.template.help.clone();n.attr("title",this.loc.output.tooltip),i.append(n);var s=this.template.title_color.clone();return s.find(".output_color_label").html(this.loc.output.color_label),i.append(s),e._colorSelector(i),t},_selectedLayers:function(){var e=this,t=[];if(e.contentOptionDivs)for(var i in e.contentOptionsMap)if(void 0!=e.contentOptionDivs[i]&&e.contentOptionDivs[i].find("input").prop("checked")){var n={id:e.contentOptionsMap[i].id,name:e.contentOptionsMap[i].label};t.push(n)}return t},_columnSelector:function(e){alert("TODO: add columns selector - use grid component - layers: "+JSON.stringify(e))},_colorSelector:function(e){var t=this;t.categoryForm=Oskari.clazz.create("Oskari.analysis.bundle.analyse.view.CategoryForm",t.instance);var i=t.categoryForm.getForm();i.find("div.field:first").hide(),e.append(i)},getStyleValues:function(){var e=this,t={},i=e.mainPanel;if(i.length>0){var n=i.find("input[name=dotSize]").val(),s=i.find("input[name=dotColor]").val();t.dot={size:n,color:s};var a=i.find("input[name=lineSize]").val(),r=i.find("input[name=lineColor]").val();t.line={size:a,color:r};var o=i.find("input[name=areaLineSize]").val(),l=i.find("input[name=areaLineColor]").val(),u=i.find("input[name=areaFillColor]").val();t.area={size:o,lineColor:l,fillColor:u}}return t},_getButtons:function(){var e=this,t=this.template.buttons.clone(),i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.setTitle(this.loc.buttons.cancel),i.setHandler(function(){e.instance.setAnalyseMode(!1)}),i.insertTo(t);var n=Oskari.clazz.create("Oskari.userinterface.component.Button");n.setTitle(this.loc.buttons.save),n.setHandler(function(){var t=e._gatherSelections();t&&e._saveAnalyse(t)}),n.insertTo(t);var s=Oskari.clazz.create("Oskari.userinterface.component.Button");return s.setTitle(this.loc.buttons.analyse),s.addClass("primary"),s.setHandler(function(){e._analyseMap()}),s.insertTo(t),t},_addAnalyseData:function(e){var t=this,i=e.find(".help:first"),n=this.instance.getSandbox().findAllSelectedMapLayers();this._addPropertyTypes(n);for(var s=[],a=0,r=0;r<n.length;r++)if(n[r].isLayerOfType("WFS")||n[r].isLayerOfType("ANALYSIS")){var o={id:t.id_prefix+"layer_"+n[r].getId(),label:n[r].getName()};a++,1==a&&(o.checked="checked"),s.push(o)}t.contentOptions=s,t.contentOptionsMap={};for(var l=0;l<t.contentOptions.length;l++)t.contentOptionsMap[t.contentOptions[l].id]=t.contentOptions[l];t.contentOptionDivs={};for(var l=0;l<t.contentOptions.length;l++){var u=t.contentOptions[l],c=t.template.option.clone();c.find("input").attr({id:u.id,checked:u.checked}).change(function(){t._refreshFields()}),c.find("label").html(u.label).attr({"for":u.id,"class":"params_checklabel"}),t.contentOptionDivs[u.id]=c;var h=t.template.icons_layer.clone();t._infoRequest(h,u.id),t._filterRequest(h,u.id),c.append(h),i.after(c)}t._refreshFields()},_addExtraParameters:function(e,t){var i=this,n=e.find(".extra_params");if(t==this.id_prefix+"buffer"){var s=i.template.title.clone();s.find(".settings_buffer_label").html(i.loc.buffer_size.label),s.find(".settings_buffer_field").attr({value:"",placeholder:i.loc.buffer_size.tooltip}),n.append(s)}else t==this.id_prefix+"aggregate"?i._aggregateExtra(n):t==this.id_prefix+"intersect"?i._intersectExtra(n):t==this.id_prefix+"union"},_aggregateExtra:function(e){var t=this,i=this.template.title_extra.clone();i.find(".extra_title_label").html(this.loc.aggregate.label),e.append(i);for(var n=function(i){return function(){e.find("input[name=aggre]:checked").val();for(var n=0;n<t.aggreOptions.length;++n)t.aggreOptions[n].selected=!1;i.selected=!0}},s=0;s<this.aggreOptions.length;++s){var a=this.aggreOptions[s],r=this.template.aggreOptionTool.clone(),o=a.label;a.width&&a.height&&(o=o+" ("+a.width+" x "+a.height+"px)"),r.find("label").append(o).attr({"for":a.id,"class":"params_radiolabel"}),a.selected&&r.find("input").attr("checked","checked"),e.append(r),r.find("input").attr({value:a.id,name:"aggre",id:a.id}),r.find("input").change(n(a))}},_intersectExtra:function(e){var t=this,i=[];if(t.contentOptionDivs)for(var n in t.contentOptionsMap)if(void 0!=t.contentOptionDivs[n]){var s={id:t.contentOptionsMap[n].id,label:t.contentOptionsMap[n].label};i.push(s)}t.intersectOptions=i,t.intersectOptionsMap={};for(var a=0;a<t.intersectOptions.length;a++)t.intersectOptionsMap[t.intersectOptions[a].id]=t.intersectOptions[a];var r=t.template.title_extra.clone();r.find(".extra_title_label").html(t.loc.intersect.label),e.append(r);for(var o=function(i){return function(){e.find("input[name=aggre]:checked").val();for(var n=0;n<t.intersectOptions.length;++n)t.intersectOptions[n].selected=!1;i.selected=!0}},l=0;l<t.intersectOptions.length;++l){var s=t.intersectOptions[l],u=t.template.intersectOptionTool.clone(),c=s.label;s.width&&s.height&&(c=c+" ("+s.width+" x "+s.height+"px)"),u.find("label").append(c).attr({"for":s.id,"class":"params_radiolabel"}),s.selected&&u.find("input").attr("checked","checked"),e.append(u),u.find("input").attr({value:s.id,name:"intersect",id:s.id}),u.find("input").change(o(s))}var h=this.template.title_extra.clone();h.find(".extra_title_label").html(this.loc.spatial.label),e.append(h);for(var o=function(i){return function(){e.find("input[name=spatial]:checked").val();for(var n=0;n<t.spatialOptions.length;++n)t.spatialOptions[n].selected=!1;i.selected=!0}},l=0;l<this.spatialOptions.length;++l){var s=this.spatialOptions[l],u=this.template.spatialOptionTool.clone(),c=s.label;s.width&&s.height&&(c=c+" ("+s.width+" x "+s.height+"px)"),u.find("label").append(c).attr({"for":s.id,"class":"params_radiolabel"}),s.selected&&u.find("input").attr("checked","checked"),e.append(u),u.find("input").attr({value:s.id,name:"spatial",id:s.id}),u.find("input").change(o(s))}},_unionExtra:function(e){var t=this,i=[];if(t.contentOptionDivs)for(var n in t.contentOptionsMap)if(void 0!=t.contentOptionDivs[n]){var s={id:t.contentOptionsMap[n].id,label:t.contentOptionsMap[n].label};i.push(s)}t.unionOptions=i,t.unionOptionsMap={};for(var a=0;a<t.unionOptions.length;a++)t.unionOptionsMap[t.unionOptions[a].id]=t.unionOptions[a];var r=t.template.title_extra.clone();r.find(".extra_title_label").html(t.loc.union.label),e.append(r);for(var o=function(i){return function(){e.find("input[name=aggre]:checked").val();for(var n=0;n<t.unionOptions.length;++n)t.unionOptions[n].selected=!1;i.selected=!0}},l=0;l<t.unionOptions.length;++l){var s=t.unionOptions[l],u=t.template.unionOptionTool.clone(),c=s.label;s.width&&s.height&&(c=c+" ("+s.width+" x "+s.height+"px)"),u.find("label").append(c).attr({"for":s.id,"class":"params_radiolabel"}),s.selected&&u.find("input").attr("checked","checked"),e.append(u),u.find("input").attr({value:s.id,name:"union",id:s.id}),u.find("input").change(o(s))}var h=this.template.title_extra.clone();h.find(".extra_title_label").html(this.loc.spatial.label),e.append(h);for(var o=function(i){return function(){e.find("input[name=spatial]:checked").val();for(var n=0;n<t.spatialOptions.length;++n)t.spatialOptions[n].selected=!1;i.selected=!0}},l=0;l<this.spatialOptions.length;++l){var s=this.spatialOptions[l],u=this.template.spatialOptionTool.clone(),c=s.label;s.width&&s.height&&(c=c+" ("+s.width+" x "+s.height+"px)"),u.find("label").append(c).attr({"for":s.id,"class":"params_radiolabel"}),s.selected&&u.find("input").attr("checked","checked"),e.append(u),u.find("input").attr({value:s.id,name:"spatial",id:s.id}),u.find("input").change(o(s))}},_modifyExtraParameters:function(e){var t=this,i=t.mainPanel.find("div.extra_params");i.empty();var n=t.mainPanel.find("div.analyse-columns-container");n.empty(),t.id_prefix+"aggregate"===e?t._createColumnsDropdown(n):t._createColumnsSelector(n),t._addExtraParameters(i.parent(),e)},_createColumnsDropdown:function(e){var t,i,n,s=this._getSelectedMapLayer(),a=s&&s.getFields&&s.getFields()?s.getFields().slice():[],r=s&&s.getLocales&&s.getLocales()?s.getLocales().slice():[],o=this.template.columnsDropdown.clone();for(o.append(jQuery('<option value="null">'+this.loc.aggregate.attribute+"</option>")),t=0;t<a.length;++t)a[t].match(/^__/)||(i=r[t]||a[t],n=jQuery('<option value="'+a[t]+'">'+i+"</option>"),o.append(n));e.append(o)},_modifyAnalyseData:function(){var e=this,t="LayerSelector",i=e._getFakeExtension(t),n="userinterface.UpdateExtensionRequest";e.instance.getSandbox().postRequestByName(n,[i,"attach"])},_getFakeExtension:function(e){return{getName:function(){return e}}},refreshAnalyseData:function(){var e=this,t=e.mainPanel;t.find(".analyse_option_cont").remove(),e._addAnalyseData(t)},refreshExtraParameters:function(){var e=this,t=e.mainPanel,i=t.find("input[name=method]:checked").val();e._modifyExtraParameters(i)},_gatherSelections:function(){var e=this.mainPanel;this.instance.getSandbox();var t=e.find("input[name=method]:checked").val(),i=t&&t.replace(this.id_prefix,""),n=this._getSelectedMapLayer(),s=e.find("input[name=params]:checked").val(),a=s&&s.replace(this.id_prefix,"");if("all"==a)a=n&&n.getFields&&n.getFields()?n.getFields().slice():[0];else if("select"==a){var r=jQuery("div.analyse-featurelist").find("ul li input:checked");a=jQuery.map(r,function(e){return e.value})}else a=[];var o=e.find(".settings_name_field").val(),l=this._getMethodSelections(n,{name:o,method:i,fields:a,layerId:n.getId(),layerType:n.getLayerType()});return l.style=this.getStyleValues(),l.bbox=this.instance.getSandbox().getMap().getBbox(),l},_getMethodSelections:function(e,t){var i=this,n=this.mainPanel,s=t.method,a=n.find(".settings_buffer_field").val(),r=n.find("input[name=aggre]:checked");r=jQuery.map(r,function(e){return e.value.replace(i.id_prefix,"")});var o=n.find("select.analyse-columns-dropdown option").filter(":selected").val(),l=n.find("input[name=union]:checked").val();l=l&&l.replace(this.id_prefix+"layer_","");var u=n.find("input[name=intersect]:checked").val();u=u&&u.replace(this.id_prefix+"layer_","");var c=n.find("input[name=spatial]:checked").val();c=c&&c.replace(this.id_prefix,"");var h={buffer:{methodParams:{distance:a},opacity:e.getOpacity()},aggregate:{methodParams:{functions:r,attribute:o}},union:{methodParams:{layerId:l}},intersect:{methodParams:{layerId:u,operator:c}}};for(var d in h[s])t[d]=h[s][d];return t},_analyseMap:function(){var e=this,t=this.instance.getSandbox();t.getAjaxUrl();var i=e._gatherSelections(),n={};n.analyse=JSON.stringify(i);var s=i.layerId,a=t.findMapLayerFromSelectedMapLayers(s);if(this.getFilterJson(s)){var r=this.getFilterJson(s);r.featureIds&&this._getSelectedFeatureIds(a,r),n.filter=JSON.stringify(r)}e._checkSelections(i)&&e.instance.analyseService.sendAnalyseData(n,function(t){t&&e._handleAnalyseMapResponse(t)},function(){e.instance.showMessage(e.loc.error.title,e.loc.error.saveFailed)})},_handleAnalyseMapResponse:function(e){var t,i,n,s;"-1"==e.wpsLayerId?this.instance.showMessage("Tulokset",e.result):(t=this.instance.mapLayerService,e.id=this.layer_prefix+e.id+"_"+e.wpsLayerId,i=t.createMapLayer(e),i.setWpsUrl(e.wpsUrl),i.setWpsName(e.wpsName),t.addLayer(i),n=this.instance.sandbox.getRequestBuilder("AddMapLayerRequest"),n&&(s=n(i.getId()),this.instance.sandbox.request(this.instance,s)))},_saveAnalyse:function(){var e=this.instance.getSandbox();e.getAjaxUrl(),alert("TODO: save analyse data operations")},_infoRequest:function(e,t){t=t.replace(this.id_prefix+"layer_","");var i=this.instance.getSandbox().findMapLayerFromSelectedMapLayers(t),n=this;e.find("div.layer-info").bind("click",function(){var e="catalogue.ShowMetadataRequest",t=i.getMetadataIdentifier(),s=[],a={};a[t]=!0;var r=i.getSubLayers();if(r&&r.length>0)for(var o=0;o<r.length;o++){var l=r[o].getMetadataIdentifier();l&&""!=l&&!a[l]&&(a[l]=!0,s.push({uuid:l}))}n.instance.getSandbox().postRequestByName(e,[{uuid:t},s])})},_getSelectedMapLayer:function(){var e=this._selectedLayers();return e=e&&e[0],e=e&&e.id,e=e&&e.replace(this.id_prefix+"layer_",""),this.instance.getSandbox().findMapLayerFromSelectedMapLayers(e)},_getSelectedFeatureIds:function(e,t){e&&t&&(t.featureIds=e.getClickedFeatureListIds?e.getClickedFeatureListIds().slice():[])},_addPropertyTypes:function(e){for(var t=this,i=0;i<e.length;i++)e[i].isLayerOfType("WFS")&&jQuery.isEmptyObject(e[i].getPropertyTypes())&&t.instance.analyseService.loadWFSLayerPropertiesAndTypes(e[i].getId())},destroy:function(){this.mainPanel.remove()},hide:function(){this.mainPanel.hide()},show:function(){this.mainPanel.show()},setEnabled:function(e){this.isEnabled=e},getEnabled:function(){return this.isEnabled},getState:function(){return{}},setState:function(){}}),Oskari.clazz.category("Oskari.analysis.bundle.analyse.view.StartAnalyse","validation-methods",{_checkSelections:function(e){var t=this.loc.error.invalidSetup,i=!0;e||(this._notifyValidationError(this.loc.error.noParameters),i=!1),e.layerId||(this._notifyValidationError(this.loc.error.noLayer),i=!1);var n=e.method,s=this["_validate_method_"+n];return s?i=s.call(this,e,t):(this._notifyValidationError(this.loc.error.invalidMethod+n),i=!1),i},_validate_method_buffer:function(e,t){var i=e.methodParams.distance,n=!0;return""==i?(this._notifyValidationError(this.loc.error.bufferSize,t),n=!1):isNaN(i)?(this._notifyValidationError(this.loc.error.illegalCharacters,t),n=!1):Number(i)>-1&&Number(i)<1&&(this._notifyValidationError(this.loc.error.bufferSize,t),n=!1),n},_validate_method_aggregate:function(e,t){var i=!0;return e.methodParams.functions&&0!==e.methodParams.functions.length||(this._notifyValidationError("Aggregate functions not selected",t),i=!1),e.methodParams.attribute||(this._notifyValidationError("Aggregate attribute not selected",t),i=!1),i},_validate_method_union:function(){var e=!0;return e},_validate_method_intersect:function(e,t){var i=!0;return e.methodParams.layerId?e.layerId==e.methodParams.layerId&&(this._notifyValidationError("No intersections to itself",t),i=!1):(this._notifyValidationError("Intersecting layer is not selected",t),i=!1),i},_notifyValidationError:function(e,t){t||(t=this.loc.error.title),this.instance.showMessage(t,e)}}),Oskari.clazz.category("Oskari.analysis.bundle.analyse.view.StartAnalyse","filter-methods",{__filterTemplates:{filterContent:'<div class="analyse-filter-popup-content"></div>',filterContentBBOX:'<div class="analyse-filter analyse-filter-popup-bbox"><div class="bbox-title"></div><div class="bbox-radio"><div class="bbox-on"><input id="analyse-filter-bbox-on" type="radio" name="filter-bbox" value="true" /><label for="analyse-filter-bbox-on"></label></div><div class="bbox-off"><input id="analyse-filter-bbox-off" type="radio" name="filter-bbox" value="false" checked="checked" /><label for="analyse-filter-bbox-off"></label></div></div></div>',filterClickedFeatures:'<div class="analyse-filter analyse-filter-clicked-features"><div class="clicked-features-title"></div><input type="checkbox" name="analyse-clicked-features" id="analyse-clicked-features" /><label for="analyse-clicked-features"></label></div>',filterContentValues:'<div class="analyse-filter analyse-filter-popup-values"><div class="values-title"></div></div>',filterContentOption:'<div class="filter-option"><input name="case-sensitive" type="checkbox"></input><select class="attribute"></select><select class="operator"></select><input name="attribute-value" type="text"></input></div>',manageFilterOption:'<div class="manage-filter-option"><div class="add-filter-option">+</div><div class="remove-filter-option">-</div></div>',filterBooleanOption:'<select class="boolean"></select>',option:"<option></option>"},setFilterJson:function(e,t){this._filterJsons[e]=t},removeFilterJson:function(e){this._filterJsons[e]=null,delete this._filterJsons[e]},getFilterJson:function(e){return this._filterJsons[e]},_filterRequest:function(e,t){var i=this,n=t.replace(this.id_prefix+"layer_",""),s=this.instance.mapLayerService.findMapLayer(n);e.find("div.filter").css({height:"16px",width:"16px",background:'url("/Oskari/resources/analysis/bundle/analyse/icons/icon-funnel.png")'}),e.find("div.filter").bind("click",function(){i._filterPopups[s.getId()]||i._createFilterDialog(s)})},_createFilterDialog:function(e){var t,i,n,s=this,a=Oskari.clazz.create("Oskari.userinterface.component.Popup"),r=Oskari.clazz.create("Oskari.userinterface.component.Button"),o=Oskari.clazz.create("Oskari.userinterface.component.Button"),l=Oskari.clazz.create("Oskari.userinterface.component.Button"),u=this._getFilterDialogContent(e),c=this.loc.filter.description+e.getName();s._filterPopups[e.getId()]=!0,r.setTitle(this.loc.buttons.cancel),r.addClass("analyse-close-filter"),r.setHandler(function(){s._closePopup(a,e.getId())}),o.setTitle(this.loc.filter.clearButton),o.addClass("analyse-clear-filter"),o.setHandler(function(){a.setContent(s._getFilterDialogContent(e)),s.removeFilterJson(e.getId())}),l.setTitle(this.loc.filter.refreshButton),l.addClass("primary"),l.addClass("analyse-update-filter"),l.setHandler(function(){t=s._getFilterValues(a.getJqueryContent()),i=s._validateFilterValues(t),i?s._displayValidationErrors(i):(s.setFilterJson(e.getId(),t),s._closePopup(a,e.getId()))}),n=this.getFilterJson(e.getId()),n&&!jQuery.isEmptyObject(n)&&this._fillDialogContent(u,n,e),a.show(c,u,[r,o,l]),a.makeDraggable()},_closePopup:function(e,t){this._filterPopups[t]=null,e.close(!0)},_getFilterDialogContent:function(e){var t,i=jQuery(this.__filterTemplates.filterContent),n=jQuery(this.__filterTemplates.filterContentBBOX),s=jQuery(this.__filterTemplates.filterClickedFeatures),a=jQuery(this.__filterTemplates.filterContentValues);return n.find("div.bbox-title").html("<h4>"+this.loc.filter.bbox.title+"</h4>"),n.find("div.bbox-on").find("label").html(this.loc.filter.bbox.on),n.find("div.bbox-off").find("label").html(this.loc.filter.bbox.off),i.append(n),s.find("div.clicked-features-title").html("<h4>"+this.loc.filter.clickedFeatures.title+"</h4>"),s.find("label").html(this.loc.filter.clickedFeatures.label),i.append(s),a.find("div.values-title").html("<h4>"+this.loc.filter.values.title+"</h4>"),t=this._addAttributeFilter(e),a.append(t),i.append(a),i},_fillDialogContent:function(e,t,i){var n,s,a=e.find("div.bbox-radio"),r=e.find("div.analyse-filter-clicked-features"),o=e.find("div.filter-option");if(t.bbox&&!jQuery.isEmptyObject(t.bbox)?(a.find("div.bbox-off").find("input[name=filter-bbox]").removeAttr("checked"),a.find("div.bbox-on").find("input[name=filter-bbox]").attr("checked","checked")):(a.find("div.bbox-off").find("input[name=filter-bbox]").attr("checked","checked"),a.find("div.bbox-on").find("input[name=filter-bbox]").removeAttr("checked")),t.featureIds&&r.find("input[name=analyse-clicked-features]").attr("checked","checked"),t.filters&&t.filters.length)for(n=t.filters[0],this._fillFilterOptionsDiv(o,n),s=1;t.filters&&s<t.filters.length;++s)if(n=t.filters[s],n.boolean){var l=e.find("div.filter-option").last(),u=this._createBooleanSelect();jQuery(u.find("option")).filter(function(){return jQuery(this).val()==n.boolean}).prop("selected","selected"),l.find("div.manage-filter-option").replaceWith(u)}else{var c=this._addAttributeFilter(i);this._fillFilterOptionsDiv(c,n),e.find("div.analyse-filter-popup-values").append(c)
}},_fillFilterOptionsDiv:function(e,t){jQuery(e.find("select.attribute option")).filter(function(){return jQuery(this).val()==t.attribute}).prop("selected","selected"),jQuery(e.find("select.operator option")).filter(function(){return jQuery(this).val()==t.operator}).prop("selected","selected"),e.find("input[name=case-sensitive]").attr("checked",t.caseSensitive),e.find("input[name=attribute-value]").val(t.value)},_addAttributeFilter:function(e){var t=this,i=jQuery(this.__filterTemplates.filterContentOption),n=i.find("select.attribute"),s=this.loc.filter.values.placeholders.attribute,a=i.find("select.operator"),r=(this.loc.filter.values.placeholders.operator,t._getLayerAttributes(e));return this._appendOptionValues(n,s,r),this._appendOptionValues(a,null,["=","~=","≠","~≠",">","<","≥","≤"]),i.find("input[name=attribute-value]").attr("placeholder",this.loc.filter.values.placeholders["attribute-value"]),i.find("input[name=case-sensitive]").attr("title",this.loc.filter.values.placeholders["case-sensitive"]),i.append(this._addManageFilterOption(e)),i},_addManageFilterOption:function(e){var t=jQuery(this.__filterTemplates.manageFilterOption),i=this.loc.filter.addFilter,n=this.loc.filter.removeFilter;return t.find("div.add-filter-option").attr("title",i),t.find("div.remove-filter-option").attr("title",n),this._bindAddNewFilter(t.find("div.add-filter-option"),e),this._bindRemoveFilter(t.find("div.remove-filter-option"),e),t},_bindAddNewFilter:function(e,t){var i=this;e.on("click",function(){i._changeAttributeFilter(jQuery(this),t)})},_bindRemoveFilter:function(e,t){var i=this;e.on("click",function(){i._removeFilter(jQuery(this),t)})},_changeAttributeFilter:function(e,t){var i=e.parents("div.filter-option"),n=e.parents("div.analyse-filter-popup-values"),s=this._addAttributeFilter(t),a=this._createBooleanSelect();i.find("div.manage-filter-option").remove(),i.append(a),n.append(s)},_removeFilter:function(e,t){var i=e.parents("div.filter-option"),n=i.prev("div.filter-option"),s=this._addManageFilterOption(t);n.find("select.boolean").replaceWith(s),n&&n.length&&i.remove()},_createBooleanSelect:function(){var e=jQuery(this.__filterTemplates.filterBooleanOption);return this.loc.filter.values.placeholders.boolean,this._appendOptionValues(e,null,["AND","OR"]),e},_appendOptionValues:function(e,t,i){var n,s=jQuery(this.__filterTemplates.option);for(t&&(s.attr("value",""),s.html(t),e.append(s)),n=0;i&&n<i.length;++n)s=jQuery(this.__filterTemplates.option),"string"==typeof i[n]?(s.attr("value",i[n]),s.html(i[n])):(s.attr("value",i[n].id),s.html(i[n].name)),e.append(s)},_getFilterValues:function(e){var t,i,n,s,a,r,o,l,u={};if(t=jQuery(e).find("input[name=filter-bbox]:checked").val(),"true"===t&&(u.bbox=this.instance.getSandbox().getMap().getBbox()),i=jQuery(e).find("input[name=analyse-clicked-features]").is(":checked"),i&&(u.featureIds=!0),n=jQuery(e).find("div.filter-option"),n&&n.length)for(u.filters=[],l=0;l<n.length;++l)s=jQuery(n[l]),a={},a.caseSensitive=s.find('input[name="case-sensitive"]').is(":checked"),a.attribute=s.find("select.attribute").val(),a.operator=s.find("select.operator").val(),a.value=s.find("input[name=attribute-value]").val(),u.filters.push(a),r=s.find("select.boolean").val(),r&&u.filters.push({"boolean":r});return o=u.filters[0],1!==n.length||o.attribute||o.value||delete u.filters,u},_getLayerAttributes:function(e){var t,i=e.getFields&&e.getFields()?e.getFields().slice(0):[],n=e.getLocales&&e.getLocales()?e.getLocales().slice(0):[],s=[];for(t=0;t<i.length;++t)i[t].match(/^__/)||s.push({id:i[t],name:n[t]||i[t]});return s},_validateFilterValues:function(e){var t,i,n=[],s=e?e.filters:null;for(i=0;s&&i<s.length;++i)t=s[i],0===i%2?(t.boolean&&n.push("boolean_operator_missing"),t.attribute||n.push("attribute_missing"),t.operator||n.push("operator_missing"),t.value||n.push("value_missing")):t.boolean||n.push("boolean_operator_missing");return n.length||(n=!1),n},_displayValidationErrors:function(e){var t,i=this.loc.filter.validation,n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),s=n.createCloseButton(this.loc.buttons.ok),a=this.loc.error.title,r="<h4>"+i.title+"</h4>";for(t=0;t<e.length;++t)r+="<p>"+i[e[t]]+"</p>";n.show(a,r,[s])}}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.view.CategoryForm",function(e){this.instance=e,jscolor.dir="/Oskari/libraries/jscolor/";var t=e.getLocalization("categoryform");this.template=jQuery('<div class="mapanalysiscategoryform"><div class="field"><label for="categoryname">'+t.name.label+'</label><br clear="all" />'+'<input type="text" name="categoryname" placeholder="'+t.name.placeholder+'"/>'+"</div>"+'<div class="field drawing">'+"<label>"+t.drawing.label+'</label><br clear="all" />'+"<table></table>"+"</div>"+"</div>"),this.templateTableRow=jQuery("<tr></tr>"),this.templateTableCell=jQuery("<td></td>"),this.templateTextInput=jQuery('<input type="text"/>'),this.defaults={dotSize:4,dotColor:"cc9900",lineSize:2,lineColor:"cc9900",areaLineSize:2,areaLineColor:"cc9900",areaFillColor:"ffdc00"},this.categoryId=void 0,this._isDefault=void 0,this.initialValues=void 0},{getForm:function(){var e=this.template.clone(),t=e.find("div.drawing table");if(this._populatePointTool(t),this._populateLineTool(t),this._populateAreaTool(t),this.initialValues){e.find("input[name=categoryname]").attr("value",this.initialValues.name),e.find("input[name=dotSize]").attr("value",this.initialValues.dot.size);var i=e.find("input[name=dotColor]");i.attr("value",this.initialValues.dot.color),new jscolor.color(i[0]),e.find("input[name=lineSize]").attr("value",this.initialValues.line.size);var n=e.find("input[name=lineColor]");n.attr("value",this.initialValues.line.color),new jscolor.color(n[0]),e.find("input[name=areaLineSize]").attr("value",this.initialValues.area.size);var s=e.find("input[name=areaLineColor]");s.attr("value",this.initialValues.area.lineColor),new jscolor.color(s[0]);var a=e.find("input[name=areaFillColor]");a.attr("value",this.initialValues.area.fillColor),new jscolor.color(a[0])}return e},getValues:function(){var e={},t=this._getOnScreenForm();if(t.length>0){var i=t.find("input[name=categoryname]").val();e.name=i,this.categoryId&&(e.id=this.categoryId),e._isDefault=this._isDefault||!1;var n=t.find("input[name=dotSize]").val(),s=t.find("input[name=dotColor]").val();e.dot={size:n,color:s};var a=t.find("input[name=lineSize]").val(),r=t.find("input[name=lineColor]").val();e.line={size:a,color:r};var o=t.find("input[name=areaLineSize]").val(),l=t.find("input[name=areaLineColor]").val(),u=t.find("input[name=areaFillColor]").val();e.area={size:o,lineColor:l,fillColor:u}}return e},setValues:function(e){this.categoryId=e.id,this._isDefault=e._isDefault;var t=this._getOnScreenForm();t.length>0&&(t.find("input[name=categoryname]").val(e.name),t.find("input[name=dotSize]").val(e.dot.size),t.find("input[name=dotColor]").val(e.dot.color),t.find("input[name=lineSize]").val(e.line.size),t.find("input[name=lineColor]").val(e.line.color),t.find("input[name=areaLineSize]").val(e.area.size),t.find("input[name=areaLineColor]").val(e.area.lineColor),t.find("input[name=areaFillColor]").val(e.area.fillColor)),this.initialValues=e},_createInput:function(e,t,i){var n=this.templateTextInput.clone();return n.attr("name",e),n.attr("value",t),i&&n.attr("class",i),"oskaricolor"==i&&(n.picker=new jscolor.color(n[0])),n},_populatePointTool:function(e){var t=this.instance.getLocalization("categoryform").drawing.point,i=this.templateTableRow.clone();for(var n in t){var s=this.templateTableCell.clone();s.append(t[n]),i.append(s)}i.append(this.templateTableCell.clone());var a=this.templateTableRow.clone();a.append(this.templateTableCell.clone());var r=this.templateTableCell.clone();r.append(this._createInput("dotColor",this.defaults.dotColor,"oskaricolor")),a.append(r);var o=this.templateTableCell.clone();o.append(this._createInput("dotSize",this.defaults.dotSize)),a.append(o),a.append(this.templateTableCell.clone()),e.append(i),e.append(a)},_populateLineTool:function(e){var t=this.instance.getLocalization("categoryform").drawing.line,i=this.templateTableRow.clone();for(var n in t){var s=this.templateTableCell.clone();s.append(t[n]),i.append(s)}i.append(this.templateTableCell.clone());var a=this.templateTableRow.clone();a.append(this.templateTableCell.clone());var r=this.templateTableCell.clone();r.append(this._createInput("lineColor",this.defaults.lineColor,"oskaricolor")),a.append(r);var o=this.templateTableCell.clone();o.append(this._createInput("lineSize",this.defaults.lineSize)),a.append(o),a.append(this.templateTableCell.clone()),e.append(i),e.append(a)},_populateAreaTool:function(e){var t=this.instance.getLocalization("categoryform").drawing.area,i=this.templateTableRow.clone();for(var n in t){var s=this.templateTableCell.clone();s.append(t[n]),i.append(s)}var a=this.templateTableRow.clone();a.append(this.templateTableCell.clone());var r=this.templateTableCell.clone();r.append(this._createInput("areaFillColor",this.defaults.areaFillColor,"oskaricolor")),a.append(r);var o=this.templateTableCell.clone();o.append(this._createInput("areaLineColor",this.defaults.areaLineColor,"oskaricolor")),a.append(o);var l=this.templateTableCell.clone();l.append(this._createInput("areaLineSize",this.defaults.areaLineSize)),a.append(l),e.append(i),e.append(a)},_getOnScreenForm:function(){return jQuery("div.mapanalysiscategoryform")},destroy:function(){var e=this._getOnScreenForm();e.remove()}}),Oskari.clazz.define("Oskari.mapframework.bundle.analyse.view.PersonalDataTab",function(e,t){this.instance=e,this.loc=t,this.grid=void 0,this.container=void 0,this.template={};for(var i in this.__templates)this.template[i]=jQuery(this.__templates[i])},{__templates:{main:'<div class="oskari-analysis-listing-tab"></div>',link:'<a href="JavaScript:void(0);"></a>'},getContent:function(){if(this.container)return this.container;var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.Grid");this.grid=t;var i=e.instance.sandbox,n=i.getRequestBuilder("AddMapLayerRequest"),s=["name","delete"];t.setVisibleFields(s);var a=function(t,s){var a=e.template.link.clone(),r=s.layer;return a.append(t),a.bind("click",function(){var t=n(r.getId(),!1,r.isBaseLayer());return i.request(e.instance,t),!1}),a};t.setColumnValueRenderer("name",a);var r=function(t,i){var n=e.template.link.clone();return i.layer,n.append(t),n.bind("click",function(){return e._confirmDeleteAnalysis(i),!1}),n};t.setColumnValueRenderer("delete",r);for(var o=0;o<s.length;++o){var l=s[o];t.setColumnUIName(l,this.loc.grid[l])}return this.container=this.template.main.clone(),this.update(),this.container},update:function(){var e=this.instance.sandbox.getService("Oskari.mapframework.service.MapLayerService"),t=e.getAllLayersByMetaType("ANALYSIS"),i=Oskari.clazz.create("Oskari.userinterface.component.GridModel");i.setIdField("id");for(var n=0;n<t.length;++n)i.addData({id:t[n].getId(),name:t[n].getName(),layer:t[n],"delete":this.loc.buttons["delete"]});this.grid.setDataModel(i),this.container.empty(),this.grid.renderTo(this.container)},_confirmDeleteAnalysis:function(e){var t=this,i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=Oskari.clazz.create("Oskari.userinterface.component.Button");n.setTitle(this.loc.buttons["delete"]),n.addClass("primary"),n.setHandler(function(){t._deleteAnalysis(e.layer),i.close()});var s=i.createCloseButton(this.loc.buttons.cancel),a=this.loc.confirmDeleteMsg+'"'+e.name+'"'+"?";i.show(this.loc.title,a,[s,n]),i.makeModal()},_deleteAnalysis:function(e){var t=this,i=this.instance.sandbox,n=e.getId().lastIndexOf("_")+1,s=e.getId().substring(n);jQuery.ajax({url:i.getAjaxUrl(),data:{action_route:"DeleteAnalysisData",id:s},type:"POST",success:function(i){i&&"success"===i.result?t._deleteSuccess(e):t._deleteFailure()},error:function(){t._deleteFailure()}})},_deleteSuccess:function(e){var t=this.instance.sandbox,i=t.getService("Oskari.mapframework.service.MapLayerService"),n=t.getRequestBuilder("RemoveMapLayerRequest"),s=n(e.getId());t.request(this.instance,s),i.removeLayer(e.getId());var a=Oskari.clazz.create("Oskari.userinterface.component.Popup");a.show(this.loc.notification.deletedTitle,this.loc.notification.deletedMsg)},_deleteFailure:function(){var e=Oskari.clazz.create("Oskari.userinterface.component.Popup"),t=e.createCloseButton(this.loc.buttons.ok);e.show(this.loc.error.title,this.loc.error.generic,[t])}}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.request.AnalyseRequest",function(e){this._creator=null,this._selections=e},{__name:"analyse.AnalyseRequest",getName:function(){return this.__name},getSelections:function(){return this._selections}},{protocol:["Oskari.mapframework.request.Request"]}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.request.AnalyseRequestHandler",function(e,t){this.sandbox=e,this.cb=t},{handleRequest:function(e,t){var i=t.getSelections();this.sandbox.printDebug("[Oskari.analysis.bundle.analyse.request.AnalyseRequestHandler] analyse requested"),this.cb(i)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),Oskari.clazz.define("Oskari.analysis.bundle.analyse.service.AnalyseService",function(e){this.instance=e,this.sandbox=e.sandbox,this.loc=e.getLocalization("AnalyseView")},{__name:"Analyse.AnalyseService",__qname:"Oskari.analysis.bundle.analyse.service.AnalyseService",getQName:function(){return this.__qname},getName:function(){return this.__name},init:function(){},sendAnalyseData:function(e,t,i){var n=this.sandbox.getAjaxUrl()+"action_route=CreateAnalysisLayer";jQuery.ajax({type:"POST",dataType:"json",url:n,beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},data:e,success:t,error:i})},_getAnalysisLayers:function(e,t){var i=this.sandbox.getAjaxUrl()+"action_route=GetAnalysisLayers";jQuery.ajax({type:"GET",dataType:"json",url:i,beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:e,error:t})},loadAnalyseLayers:function(){var e=this,t=e.instance.getSandbox();t.getAjaxUrl(),Oskari.getLocalization(e.instance.getName()),e._getAnalysisLayers(function(t){t&&e._handleAnalysisLayersResponse(t)},function(){e.instance.showMessage(e.loc.error.title,e.loc.error.loadLayersFailed)})},_handleAnalysisLayersResponse:function(e){var t,i,n=e.analysislayers;for(var s in n){var a=n[s];"-1"==a.wpsLayerId?this.instance.showMessage("Tulokset",a.result):(t=this.instance.mapLayerService,i=t.createMapLayer(a),i.setWpsUrl(a.wpsUrl),i.setWpsName(a.wpsName),t.addLayer(i))}},_getWFSLayerPropertiesAndTypes:function(e,t,i){var n=this.sandbox.getAjaxUrl()+"action_route=GetWFSDescribeFeature&layer_id="+e;jQuery.ajax({type:"GET",dataType:"json",url:n,beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:t,error:i})},loadWFSLayerPropertiesAndTypes:function(e){var t=this,i=t.instance.getSandbox();i.getAjaxUrl(),Oskari.getLocalization(t.instance.getName()),t._getWFSLayerPropertiesAndTypes(e,function(e){e&&t._handleWFSLayerPropertiesAndTypesResponse(e)},function(){t.instance.showMessage(t.loc.error.title,t.loc.error.loadLayersFailed)})},_handleWFSLayerPropertiesAndTypesResponse:function(e){var t=this,i=null;e.layer_id&&(i=t.instance.getSandbox().findMapLayerFromSelectedMapLayers(e.layer_id)),i&&i.setPropertyTypes(e.propertyTypes)}},{protocol:["Oskari.mapframework.service.Service"]}),Oskari.clazz.define("Oskari.framework.bundle.admin-layerrights.AdminLayerRightsBundle",function(){},{create:function(){var e=Oskari.clazz.create("Oskari.framework.bundle.admin-layerrights.AdminLayerRightsBundleInstance","admin-layerrights","Oskari.framework.bundle.admin-layerrights.AdminLayerRightsFlyout");return e},update:function(){}},{protocol:["Oskari.bundle.Bundle","Oskari.mapframework.bundle.extension.ExtensionBundle"],source:{scripts:[{type:"text/javascript",src:"../../../../bundles/framework/bundle/admin-layerrights/instance.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/admin-layerrights/Flyout.js"},{type:"text/javascript",src:"../../../../bundles/framework/bundle/admin-layerrights/Tile.js"},{type:"text/css",src:"../../../../resources/framework/bundle/admin-layerrights/css/style.css"},{src:"../../../../libraries/chosen/chosen.jquery.js",type:"text/javascript"},{src:"../../../../libraries/chosen/chosen.css",type:"text/css"}],locales:[{lang:"fi",type:"text/javascript",src:"../../../../bundles/framework/bundle/admin-layerrights/locale/fi.js"},{lang:"sv",type:"text/javascript",src:"../../../../bundles/framework/bundle/admin-layerrights/locale/sv.js"},{lang:"en",type:"text/javascript",src:"../../../../bundles/framework/bundle/admin-layerrights/locale/en.js"}]},bundle:{manifest:{"Bundle-Identifier":"admin-layerrights","Bundle-Name":"admin-layerrights","Bundle-Author":[{Name:"ev",Organisation:"nls.fi",Temporal:{Start:"2013",End:"2013"},Copyleft:{License:{"License-Name":"EUPL","License-Online-Resource":"http://www.paikkatietoikkuna.fi/license"}}}],"Bundle-Version":"1.0.0","Import-Namespace":["Oskari"],"Import-Bundle":{}}},dependencies:["jquery"]}),Oskari.bundle_manager.installBundleClass("admin-layerrights","Oskari.framework.bundle.admin-layerrights.AdminLayerRightsBundle"),Oskari.clazz.define("Oskari.framework.bundle.admin-layerrights.AdminLayerRightsBundleInstance",function(){"use strict";this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.service=null},{__name:"admin-layerrights",getName:function(){"use strict";return this.__name},setSandbox:function(e){"use strict";this.sandbox=e},getSandbox:function(){"use strict";return this.sandbox},getLocalization:function(e){"use strict";return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){"use strict";var e=this,t=e.conf,i=(t?t.sandbox:null)||"sandbox",n=Oskari.getSandbox(i),s=null;if(!e.started){e.started=!0,e.sandbox=n,e.localization=Oskari.getLocalization(e.getName()),s=t&&t.url?this.conf.url:n.getAjaxUrl()+"action_route=GetAllRoles",n.register(e);for(var a in e.eventHandlers)n.registerForEventByName(e,a);var r="userinterface.AddExtensionRequest",o=n.getRequestBuilder(r),l=o(this);n.request(this,l),n.registerAsStateful(e.mediator.bundleId,this),e.createUi()}},init:function(){"use strict";return null},update:function(){"use strict"},onEvent:function(e){"use strict";var t=this.eventHandlers[e.getName()];if(t)return t.apply(this,[e])},eventHandlers:{},stop:function(){"use strict";var e=this,t=e.sandbox(),i="userinterface.RemoveExtensionRequest",n=t.getRequestBuilder(i);for(var s in e.eventHandlers)t.unregisterFromEventByName(e,s);t.request(e,n(e)),e.sandbox.unregisterStateful(e.mediator.bundleId),e.sandbox.unregister(e),e.started=!1},startExtension:function(){"use strict";this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.framework.bundle.admin-layerrights.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.framework.bundle.admin-layerrights.Tile",this)},stopExtension:function(){"use strict";this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){"use strict";return this.plugins},getTitle:function(){"use strict";return this.getLocalization("title")},getDescription:function(){"use strict";return this.getLocalization("desc")},createUi:function(){"use strict";var e=this;e.plugins["Oskari.userinterface.Flyout"].setContent(),e.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(e){"use strict";this.plugins["Oskari.userinterface.Flyout"].setState(e)},getState:function(){"use strict";return this.plugins["Oskari.userinterface.Flyout"].getState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),Oskari.clazz.define("Oskari.framework.bundle.admin-layerrights.Flyout",function(e){"use strict";var t=this;t.instance=e,t.container=null,t.state=null,t.template=null,t.columns=null,t.cleanData=null,t.activeRole=null},{getName:function(){"use strict";return"Oskari.framework.bundle.admin-layerrights.Flyout"},setEl:function(e){"use strict";this.container=e[0],jQuery(this.container).hasClass("admin-layerrights")||jQuery(this.container).addClass("admin-layerrights")},startPlugin:function(){"use strict";this.template=jQuery('<div class="admin-layerrights">\n   <form method="post" id="admin-layerrights-form">       <label><span></span>          <select class="admin-layerrights-role"></select>\n       </label>       <div class="admin-layerrights-layers">       </div>       <div class="controls"></div>   </form></div>\n');var e=this.instance._localization.rights;this.columns=[{id:"name",name:e.name},{id:"isSelected",name:e.rightToPublish},{id:"isViewSelected",name:e.rightToView},{id:"isDownloadSelected",name:e.rightToDownload},{id:"isViewPublishedSelected",name:e.rightToPublishView}]},stopPlugin:function(){"use strict"},getTitle:function(){"use strict";return this.instance.getLocalization("title")},getDescription:function(){"use strict";return this.instance.getLocalization("desc")},getOptions:function(){"use strict"},setState:function(e){"use strict";this.state=e},getState:function(){"use strict";return this.state?this.state:{}},doSave:function(){"use strict";var e=this,t={resource:JSON.stringify(e.extractSelections())};jQuery.ajax({type:"POST",url:ajaxUrl+"action_route=SaveLayerPermission",lang:Oskari.getLang(),timestamp:(new Date).getTime(),data:t,success:function(){e.updatePermissionsTable(e.activeRole,"ROLE")},error:function(){}})},setContent:function(e){"use strict";var t=this,i=jQuery(this.container),n=this.template.clone(),s=Oskari.clazz.create("Oskari.userinterface.component.Button"),a=n.find("div.controls"),r=n.find("label > span"),o=n.find("select.admin-layerrights-role");i.empty(),s.setTitle(t.instance.getLocalization("save")),s.setHandler(function(){t.doSave()}),a.append(s.getButton()),r.html(this.instance.getLocalization("selectRole")),n.append(e),o.change(function(e){t.activeRole=jQuery(e.currentTarget).val(),t.updatePermissionsTable(t.activeRole,"ROLE")}),i.append(n),t.getExternalIdsAjaxRequest("ROLE",0)},createLayerRightGrid:function(e,t){"use strict";var i='<table class="layer-rights-table">',n=0,s=0,a=null,r=null,o=null;for(i+="<thead><tr>",n=0;n<e.length;n+=1)i+="<th>"+e[n].name+"</th>";for(i+="</tr></thead>",i+="<tbody>",n=0;s<t.length;s+=1){for(a=t[s],i+="<tr>",n=0;n<e.length;n+=1)r=e[n],o=a[r.id],i+="name"===r.id?'<td><span class="layer-name" data-resource="'+a.resourceName+'" data-namespace="'+a.namespace+'">'+o+"</span></td>":o?'<td><input type="checkbox" checked="checked" data-right="'+r.id+'" /></td>':'<td><input type="checkbox" data-right="'+r.id+'" /></td>';i+="</tr>"}return i+="</tbody>"},extractSelections:function(){"use strict";var e=this,t=[],i=jQuery(e.container),n=i.find("tbody tr"),s=0,a=0,r=null,o=null,l=null,u=null,c=null,h=null,d=null,p=null,f=!1;for(s=0;s<n.length;s+=1){for(f=!1,o=e.cleanData[s],r={},l=jQuery(n[s]),u=l.find("td span"),c=l.find("td input"),r.name=u.text(),r.resourceName=u.attr("data-resource"),r.namespace=u.attr("data-namespace"),r.roleId=e.activeRole,a=0;a<c.length;a+=1)h=jQuery(c[a]),d=h.attr("data-right"),p=h.prop("checked"),o[d]!==p&&(f=!0),r[d]=p;o.resourceName!==r.resourceName&&(f=!1),o.namespace!==r.namespace&&(f=!1),f&&t.push(r)}return t},updatePermissionsTable:function(e,t){"use strict";var i=this;jQuery.getJSON(ajaxUrl,{action_route:"GetPermissionsLayerHandlers",lang:Oskari.getLang(),timestamp:(new Date).getTime(),externalId:e,externalType:t},function(e){i.cleanData=e.resource;var t=i.createLayerRightGrid(i.columns,e.resource);jQuery(i.container).find(".admin-layerrights-layers").empty().append(t)})},getExternalIdsAjaxRequest:function(e,t){"use strict";var i=this;jQuery.getJSON(ajaxUrl,{action_route:"GetAllRoles",lang:Oskari.getLang(),timestamp:(new Date).getTime(),getExternalIds:e},function(n){i.makeExternalIdsSelect(n,e,t)})},makeExternalIdsSelect:function(e,t,i){"use strict";var n,s,a=jQuery(this.container).find("select.admin-layerrights-role");if(a.html(""),"0"!==t){for(n="0"!==i?'<option value="0" >-- Valitse tunniste --</option>':'<option value="0" selected="selected">-- Valitse tunniste --</option>',s=0;s<e.external.length;s+=1)n+=e.external[s].id===i?'<option selected="selected" value="'+e.external[s].id+'">'+e.external[s].name+"</option>":'<option value="'+e.external[s].id+'">'+e.external[s].name+"</option>";a.html(n)}else a.html("")}},{protocol:["Oskari.userinterface.Flyout"]}),Oskari.clazz.define("Oskari.framework.bundle.admin-layerrights.Tile",function(e){"use strict";var t=this;t.instance=e,t.container=null,t.template=null},{getName:function(){"use strict";return"Oskari.framework.bundle.admin-layerrights.Tile"},setEl:function(e){"use strict";this.container=jQuery(e)},startPlugin:function(){"use strict";this.refresh()},stopPlugin:function(){"use strict";this.container.empty()},getTitle:function(){"use strict";return this.instance.getLocalization("title")},getDescription:function(){"use strict";return this.instance.getLocalization("desc")},getOptions:function(){"use strict"},setState:function(){"use strict"},refresh:function(){"use strict"}},{protocol:["Oskari.userinterface.Tile"]});