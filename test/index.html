<html>
    <head>
        <title>Test RPC</title>
        <script src="../../libraries/JSChannel/jschannel.js"></script>
        <script src="../../libraries/OskariRPC/OskariRPC.js"></script>
        <style>
            iframe {
                background-clip: padding-box;
                border: none;
                border-radius: 12px;
                box-shadow: 4px 4px 4px rgba(0, 0, 0, 0.15);
                clear: both;
                display: block;
                margin-bottom: 12px;
            }
        </style>
    </head>

    <body>
        <!--<iframe id="Oskari" src="http://dev.paikkatietoikkuna.fi/published/fi/6044" style="width: 700px; height: 525px;"></iframe>-->
        <iframe id="Oskari" src="http://hk-pc-112w764.mmlnet.nls.fi:8080/web/fi/kartta?p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=0&p_p_state=exclusive&published=true&viewId=6494" style="width: 700px; height: 525px;"></iframe>
        <button id="helsinki">Helsinkiin</button>
        <button id="lehka">M&ouml;kille</button>
        <output id="coords"></output>
        <script>
        var channel = OskariRPC.connect(
                document.getElementById("Oskari"),
                'http://hk-pc-112w764.mmlnet.nls.fi:8080'
                //'http://dev.paikkatietoikkuna.fi'
            ),
            coords = document.getElementById('coords'),
            setCoords = function(x, y) {
                coords.textContent = x + ", " + y;
            },
            moveMap = function(centerX, centerY) {
                channel.postRequest(
                    "MapMoveRequest",
                    [centerX, centerY, 8],
                    function(data) {
                        console.log("MapMoveRequest posted");
                    },
                    function(error, message) {
                        console.log("error", error, message);
                    }
                );
            };

        channel.getZoomRange(
            function (data) {
                console.log("SUCCESS!!!");
                var zoombar = document.createElement('input');
                zoombar.type = 'range';
                zoombar.min = data.min;
                zoombar.max = data.max;
                zoombar.value = data.zoom
                //zoombar.value = data.current;
                zoombar.onchange = function (event) {
                    channel.zoomTo(this.value);
                };
                document.body.appendChild(zoombar);
            },
            function(error, message) {
                console.log("zoomy error", error, message);
            }
        );

        // Get current map position
        channel.getMapPosition(
            function(data) {
                console.log("getMapPosition", JSON.stringify(data));
                setCoords(data.centerX, data.centerY);
            },
            function(error, message) {
                console.log("error", error, message);
            }
        );

        channel.getAllLayers(
            function(data) {
                console.log("getAllLayers", JSON.stringify(data));
                // Layer names aren't available through RPC as it might contain sensitive data
                var localization = {
                    "base_2": "Maastokartta",
                    "base_35": "Taustakarttasarja"
                };
                data.forEach(function (layer) {
                    var layerButton = document.createElement('button');
                    layerButton.id = layer.id;
                    layerButton.textContent = localization[layer.id];
                    layerButton.onclick = function () {
                        var lid = this.id;
                        console.log("Showing layer " + localization[lid]);
                        data.forEach(function (l) {
                            channel.postRequest(
                                "MapModulePlugin.MapLayerVisibilityRequest",
                                [l.id, l.id === '' + lid]
                            );
                        });
                    };
                    document.body.appendChild(layerButton);
                });
            },
            function(error, message) {
                console.log("error", error, message);
            }
        );

        channel.handleEvent(
            'AfterMapMoveEvent',
            function(data) {
                console.log("AfterMapMoveEvent", JSON.stringify(data));
                setCoords(data.centerX, data.centerY);
            },
            function(error, message) {
                console.log("error", error, message);
            }
        );

        channel.handleEvent(
            'MapClickedEvent',
            function(data) {
                console.log("MapClickedEvent", JSON.stringify(data));
                channel.postRequest(
                    'MapModulePlugin.AddMarkerRequest',
                    [
                        {
                            x: data.lon,
                            y: data.lat
                        },
                        'RPCMarker'
                    ], 
                    function(error, message) {
                        console.log("error", error, message);
                    }
                );
            },
            function(error, message) {
                console.log("error", error, message);
            }
        );

        document.getElementById('lehka').onclick = function() {
            console.log("Mökille");
            moveMap(354490.70442968, 6770658.0402485);
        };

        document.getElementById('helsinki').onclick = function() {
            console.log("Helsinkiin");
            moveMap(385540.20442968, 6675294.2902485);
        };
        </script>
    </body>
</html>
